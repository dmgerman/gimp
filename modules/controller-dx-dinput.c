begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995-1997 Spencer Kimball and Peter Mattis  *  * controller_dx_dinput.c  * Copyright (C) 2004-2007 Sven Neumann<sven@gimp.org>  *                         Michael Natterer<mitch@gimp.org>  *                         Tor Lillqvist<tml@iki.fi>  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_comment
comment|/* When using gcc with the February 2007 version of the DirectX SDK,  * at least, you need to fix a couple of duplicate typedefs in the  * DirectX<dinput.h>. Unfortunately I can't include the diff here,  * both for copyright reasons, and because that would confuse the C  * lexer even if inside #if 0.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_define
DECL|macro|_WIN32_WINNT
define|#
directive|define
name|_WIN32_WINNT
value|0x0501
end_define

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_define
DECL|macro|DIRECTINPUT_VERSION
define|#
directive|define
name|DIRECTINPUT_VERSION
value|0x0800
end_define

begin_include
include|#
directive|include
file|<dinput.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|"libgimpconfig/gimpconfig.h"
end_include

begin_include
include|#
directive|include
file|"libgimpmodule/gimpmodule.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_define
DECL|macro|GIMP_ENABLE_CONTROLLER_UNDER_CONSTRUCTION
define|#
directive|define
name|GIMP_ENABLE_CONTROLLER_UNDER_CONSTRUCTION
end_define

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpcontroller.h"
end_include

begin_include
include|#
directive|include
file|"gimpinputdevicestore.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/libgimp-intl.h"
end_include

begin_enum
enum|enum
DECL|enum|__anon2a2dac370103
block|{
DECL|enumerator|PROP_0
name|PROP_0
block|,
DECL|enumerator|PROP_DEVICE
name|PROP_DEVICE
block|,
DECL|enumerator|PROP_DEVICE_STORE
name|PROP_DEVICE_STORE
block|}
enum|;
end_enum

begin_define
DECL|macro|NUM_EVENTS_PER_BUTTON
define|#
directive|define
name|NUM_EVENTS_PER_BUTTON
value|3
end_define

begin_comment
DECL|macro|NUM_EVENTS_PER_BUTTON
comment|/* Button click, press and release */
end_comment

begin_define
DECL|macro|NUM_EVENTS_PER_AXIS
define|#
directive|define
name|NUM_EVENTS_PER_AXIS
value|2
end_define

begin_comment
DECL|macro|NUM_EVENTS_PER_AXIS
comment|/* Axis decrease and increase */
end_comment

begin_define
DECL|macro|NUM_EVENTS_PER_SLIDER
define|#
directive|define
name|NUM_EVENTS_PER_SLIDER
value|2
end_define

begin_comment
DECL|macro|NUM_EVENTS_PER_SLIDER
comment|/* Slider decrease and increase */
end_comment

begin_define
DECL|macro|NUM_EVENTS_PER_POV
define|#
directive|define
name|NUM_EVENTS_PER_POV
value|3
end_define

begin_comment
DECL|macro|NUM_EVENTS_PER_POV
comment|/* POV view vector X and Y view and return */
end_comment

begin_define
DECL|macro|CONTROLLER_TYPE_DX_DINPUT
define|#
directive|define
name|CONTROLLER_TYPE_DX_DINPUT
value|(controller_dx_dinput_get_type ())
end_define

begin_define
DECL|macro|CONTROLLER_DX_DINPUT (obj)
define|#
directive|define
name|CONTROLLER_DX_DINPUT
parameter_list|(
name|obj
parameter_list|)
value|(G_TYPE_CHECK_INSTANCE_CAST ((obj), CONTROLLER_TYPE_DX_DINPUT, ControllerDXDInput))
end_define

begin_define
DECL|macro|CONTROLLER_DX_DINPUT_CLASS (klass)
define|#
directive|define
name|CONTROLLER_DX_DINPUT_CLASS
parameter_list|(
name|klass
parameter_list|)
value|(G_TYPE_CHECK_CLASS_CAST ((klass), CONTROLLER_TYPE_DX_DINPUT, ControllerDXDInputClass))
end_define

begin_define
DECL|macro|CONTROLLER_IS_DX_DINPUT (obj)
define|#
directive|define
name|CONTROLLER_IS_DX_DINPUT
parameter_list|(
name|obj
parameter_list|)
value|(G_TYPE_CHECK_INSTANCE_TYPE ((obj), CONTROLLER_TYPE_DX_DINPUT))
end_define

begin_define
DECL|macro|CONTROLLER_IS_DX_DINPUT_CLASS (klass)
define|#
directive|define
name|CONTROLLER_IS_DX_DINPUT_CLASS
parameter_list|(
name|klass
parameter_list|)
value|(G_TYPE_CHECK_CLASS_TYPE ((klass), CONTROLLER_TYPE_DX_DINPUT))
end_define

begin_typedef
DECL|typedef|DXDInputSource
typedef|typedef
name|struct
name|_DXDInputSource
name|DXDInputSource
typedef|;
end_typedef

begin_typedef
DECL|typedef|ControllerDXDInput
typedef|typedef
name|struct
name|_ControllerDXDInput
name|ControllerDXDInput
typedef|;
end_typedef

begin_typedef
DECL|typedef|ControllerDXDInputClass
typedef|typedef
name|struct
name|_ControllerDXDInputClass
name|ControllerDXDInputClass
typedef|;
end_typedef

begin_struct
DECL|struct|_DXDInputSource
struct|struct
name|_DXDInputSource
block|{
DECL|member|source
name|GSource
name|source
decl_stmt|;
DECL|member|controller
name|ControllerDXDInput
modifier|*
name|controller
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
DECL|struct|_ControllerDXDInput
struct|struct
name|_ControllerDXDInput
block|{
DECL|member|parent_instance
name|GimpController
name|parent_instance
decl_stmt|;
DECL|member|store
name|GimpInputDeviceStore
modifier|*
name|store
decl_stmt|;
DECL|member|didevice8
name|LPDIRECTINPUTDEVICE8W
name|didevice8
decl_stmt|;
DECL|member|event
name|HANDLE
name|event
decl_stmt|;
DECL|member|pollfd
name|GPollFD
modifier|*
name|pollfd
decl_stmt|;
DECL|member|num_buttons
name|gint
name|num_buttons
decl_stmt|;
DECL|member|num_button_events
name|gint
name|num_button_events
decl_stmt|;
DECL|member|num_axes
name|gint
name|num_axes
decl_stmt|;
DECL|member|num_axis_events
name|gint
name|num_axis_events
decl_stmt|;
DECL|member|num_sliders
name|gint
name|num_sliders
decl_stmt|;
DECL|member|num_slider_events
name|gint
name|num_slider_events
decl_stmt|;
DECL|member|num_povs
name|gint
name|num_povs
decl_stmt|;
DECL|member|num_pov_events
name|gint
name|num_pov_events
decl_stmt|;
DECL|member|num_events
name|gint
name|num_events
decl_stmt|;
DECL|member|event_names
name|gchar
modifier|*
modifier|*
name|event_names
decl_stmt|;
DECL|member|event_blurbs
name|gchar
modifier|*
modifier|*
name|event_blurbs
decl_stmt|;
DECL|member|format
name|DIDATAFORMAT
modifier|*
name|format
decl_stmt|;
DECL|member|prevdata
name|guchar
modifier|*
name|prevdata
decl_stmt|;
DECL|member|guid
name|gchar
modifier|*
name|guid
decl_stmt|;
DECL|member|source
name|GSource
modifier|*
name|source
decl_stmt|;
comment|/* Variables used by enumeration callbacks only*/
DECL|member|bei
DECL|member|bi
DECL|member|aei
DECL|member|ai
DECL|member|sei
DECL|member|si
DECL|member|pei
DECL|member|pi
name|gint
name|bei
decl_stmt|,
name|bi
decl_stmt|,
name|aei
decl_stmt|,
name|ai
decl_stmt|,
name|sei
decl_stmt|,
name|si
decl_stmt|,
name|pei
decl_stmt|,
name|pi
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
DECL|struct|_ControllerDXDInputClass
struct|struct
name|_ControllerDXDInputClass
block|{
DECL|member|parent_class
name|GimpControllerClass
name|parent_class
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
name|GType
name|controller_dx_dinput_get_type
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dx_dinput_dispose
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dx_dinput_finalize
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dx_dinput_set_property
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|,
name|guint
name|property_id
parameter_list|,
specifier|const
name|GValue
modifier|*
name|value
parameter_list|,
name|GParamSpec
modifier|*
name|pspec
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dx_dinput_get_property
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|,
name|guint
name|property_id
parameter_list|,
name|GValue
modifier|*
name|value
parameter_list|,
name|GParamSpec
modifier|*
name|pspec
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|dx_dinput_get_n_events
parameter_list|(
name|GimpController
modifier|*
name|controller
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|gchar
modifier|*
name|dx_dinput_get_event_name
parameter_list|(
name|GimpController
modifier|*
name|controller
parameter_list|,
name|gint
name|event_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|gchar
modifier|*
name|dx_dinput_get_event_blurb
parameter_list|(
name|GimpController
modifier|*
name|controller
parameter_list|,
name|gint
name|event_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dx_dinput_device_changed
parameter_list|(
name|ControllerDXDInput
modifier|*
name|controller
parameter_list|,
specifier|const
name|gchar
modifier|*
name|guid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|dx_dinput_set_device
parameter_list|(
name|ControllerDXDInput
modifier|*
name|controller
parameter_list|,
specifier|const
name|gchar
modifier|*
name|guid
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|dx_dinput_info
specifier|static
specifier|const
name|GimpModuleInfo
name|dx_dinput_info
init|=
block|{
name|GIMP_MODULE_ABI_VERSION
block|,
name|N_
argument_list|(
literal|"DirectX DirectInput event controller"
argument_list|)
block|,
literal|"Tor Lillqvist<tml@iki.fi>"
block|,
literal|"v0.1"
block|,
literal|"(c) 2004-2007, released under the GPL"
block|,
literal|"2004-2007"
block|}
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|G_DEFINE_DYNAMIC_TYPE (ControllerDXDInput,controller_dx_dinput,GIMP_TYPE_CONTROLLER)
name|G_DEFINE_DYNAMIC_TYPE
argument_list|(
argument|ControllerDXDInput
argument_list|,
argument|controller_dx_dinput
argument_list|,
argument|GIMP_TYPE_CONTROLLER
argument_list|)
end_macro

begin_function
name|G_MODULE_EXPORT
specifier|const
name|GimpModuleInfo
modifier|*
name|gimp_module_query
parameter_list|(
name|GTypeModule
modifier|*
name|module
parameter_list|)
block|{
return|return
operator|&
name|dx_dinput_info
return|;
block|}
end_function

begin_function
name|G_MODULE_EXPORT
name|gboolean
DECL|function|gimp_module_register (GTypeModule * module)
name|gimp_module_register
parameter_list|(
name|GTypeModule
modifier|*
name|module
parameter_list|)
block|{
name|gimp_input_device_store_register_types
argument_list|(
name|module
argument_list|)
expr_stmt|;
name|controller_dx_dinput_register_type
argument_list|(
name|module
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|controller_dx_dinput_class_init (ControllerDXDInputClass * klass)
name|controller_dx_dinput_class_init
parameter_list|(
name|ControllerDXDInputClass
modifier|*
name|klass
parameter_list|)
block|{
name|GimpControllerClass
modifier|*
name|controller_class
init|=
name|GIMP_CONTROLLER_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|GObjectClass
modifier|*
name|object_class
init|=
name|G_OBJECT_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|object_class
operator|->
name|dispose
operator|=
name|dx_dinput_dispose
expr_stmt|;
name|object_class
operator|->
name|finalize
operator|=
name|dx_dinput_finalize
expr_stmt|;
name|object_class
operator|->
name|get_property
operator|=
name|dx_dinput_get_property
expr_stmt|;
name|object_class
operator|->
name|set_property
operator|=
name|dx_dinput_set_property
expr_stmt|;
name|g_object_class_install_property
argument_list|(
name|object_class
argument_list|,
name|PROP_DEVICE
argument_list|,
name|g_param_spec_string
argument_list|(
literal|"device"
argument_list|,
name|_
argument_list|(
literal|"Device:"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The device to read DirectInput events from."
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|GIMP_CONFIG_PARAM_FLAGS
argument_list|)
argument_list|)
expr_stmt|;
name|g_object_class_install_property
argument_list|(
name|object_class
argument_list|,
name|PROP_DEVICE_STORE
argument_list|,
name|g_param_spec_object
argument_list|(
literal|"device-values"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|GIMP_TYPE_INPUT_DEVICE_STORE
argument_list|,
name|G_PARAM_READABLE
argument_list|)
argument_list|)
expr_stmt|;
name|controller_class
operator|->
name|name
operator|=
name|_
argument_list|(
literal|"DirectX DirectInput"
argument_list|)
expr_stmt|;
name|controller_class
operator|->
name|help_id
operator|=
literal|"gimp-controller-directx-directinput"
expr_stmt|;
name|controller_class
operator|->
name|stock_id
operator|=
name|GIMP_STOCK_CONTROLLER_LINUX_INPUT
expr_stmt|;
name|controller_class
operator|->
name|get_n_events
operator|=
name|dx_dinput_get_n_events
expr_stmt|;
name|controller_class
operator|->
name|get_event_name
operator|=
name|dx_dinput_get_event_name
expr_stmt|;
name|controller_class
operator|->
name|get_event_blurb
operator|=
name|dx_dinput_get_event_blurb
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|controller_dx_dinput_class_finalize (ControllerDXDInputClass * klass)
name|controller_dx_dinput_class_finalize
parameter_list|(
name|ControllerDXDInputClass
modifier|*
name|klass
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
DECL|function|controller_dx_dinput_init (ControllerDXDInput * controller)
name|controller_dx_dinput_init
parameter_list|(
name|ControllerDXDInput
modifier|*
name|controller
parameter_list|)
block|{
name|controller
operator|->
name|store
operator|=
name|gimp_input_device_store_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|controller
operator|->
name|store
condition|)
block|{
name|g_signal_connect_swapped
argument_list|(
name|controller
operator|->
name|store
argument_list|,
literal|"device-added"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dx_dinput_device_changed
argument_list|)
argument_list|,
name|controller
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|controller
operator|->
name|store
argument_list|,
literal|"device-removed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dx_dinput_device_changed
argument_list|)
argument_list|,
name|controller
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dx_dinput_dispose (GObject * object)
name|dx_dinput_dispose
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|controller
init|=
name|CONTROLLER_DX_DINPUT
argument_list|(
name|object
argument_list|)
decl_stmt|;
name|dx_dinput_set_device
argument_list|(
name|controller
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|G_OBJECT_CLASS
argument_list|(
name|controller_dx_dinput_parent_class
argument_list|)
operator|->
name|dispose
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dx_dinput_finalize (GObject * object)
name|dx_dinput_finalize
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|controller
init|=
name|CONTROLLER_DX_DINPUT
argument_list|(
name|object
argument_list|)
decl_stmt|;
if|if
condition|(
name|controller
operator|->
name|source
operator|!=
name|NULL
condition|)
block|{
name|g_source_remove_poll
argument_list|(
name|controller
operator|->
name|source
argument_list|,
name|controller
operator|->
name|pollfd
argument_list|)
expr_stmt|;
name|g_source_remove
argument_list|(
name|g_source_get_id
argument_list|(
name|controller
operator|->
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|g_source_unref
argument_list|(
name|controller
operator|->
name|source
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|controller
operator|->
name|didevice8
condition|)
name|IDirectInputDevice8_SetEventNotification
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|controller
operator|->
name|format
operator|!=
name|NULL
condition|)
block|{
name|g_free
argument_list|(
name|controller
operator|->
name|format
operator|->
name|rgodf
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|controller
operator|->
name|format
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|=
name|NULL
expr_stmt|;
block|}
name|g_free
argument_list|(
name|controller
operator|->
name|prevdata
argument_list|)
expr_stmt|;
name|controller
operator|->
name|prevdata
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|controller
operator|->
name|event
operator|!=
name|NULL
condition|)
block|{
name|CloseHandle
argument_list|(
name|controller
operator|->
name|event
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|controller
operator|->
name|store
condition|)
block|{
name|g_object_unref
argument_list|(
name|controller
operator|->
name|store
argument_list|)
expr_stmt|;
name|controller
operator|->
name|store
operator|=
name|NULL
expr_stmt|;
block|}
name|G_OBJECT_CLASS
argument_list|(
name|controller_dx_dinput_parent_class
argument_list|)
operator|->
name|finalize
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dx_dinput_set_property (GObject * object,guint property_id,const GValue * value,GParamSpec * pspec)
name|dx_dinput_set_property
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|,
name|guint
name|property_id
parameter_list|,
specifier|const
name|GValue
modifier|*
name|value
parameter_list|,
name|GParamSpec
modifier|*
name|pspec
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|controller
init|=
name|CONTROLLER_DX_DINPUT
argument_list|(
name|object
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|property_id
condition|)
block|{
case|case
name|PROP_DEVICE
case|:
name|dx_dinput_set_device
argument_list|(
name|controller
argument_list|,
name|g_value_get_string
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|G_OBJECT_WARN_INVALID_PROPERTY_ID
argument_list|(
name|object
argument_list|,
name|property_id
argument_list|,
name|pspec
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dx_dinput_get_property (GObject * object,guint property_id,GValue * value,GParamSpec * pspec)
name|dx_dinput_get_property
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|,
name|guint
name|property_id
parameter_list|,
name|GValue
modifier|*
name|value
parameter_list|,
name|GParamSpec
modifier|*
name|pspec
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|controller
init|=
name|CONTROLLER_DX_DINPUT
argument_list|(
name|object
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|property_id
condition|)
block|{
case|case
name|PROP_DEVICE
case|:
name|g_value_set_string
argument_list|(
name|value
argument_list|,
name|controller
operator|->
name|guid
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROP_DEVICE_STORE
case|:
name|g_value_set_object
argument_list|(
name|value
argument_list|,
name|controller
operator|->
name|store
argument_list|)
expr_stmt|;
break|break;
default|default:
name|G_OBJECT_WARN_INVALID_PROPERTY_ID
argument_list|(
name|object
argument_list|,
name|property_id
argument_list|,
name|pspec
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|dx_dinput_get_n_events (GimpController * controller)
name|dx_dinput_get_n_events
parameter_list|(
name|GimpController
modifier|*
name|controller
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|cdxdi
init|=
operator|(
name|ControllerDXDInput
operator|*
operator|)
name|controller
decl_stmt|;
return|return
name|cdxdi
operator|->
name|num_events
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|gchar
modifier|*
DECL|function|dx_dinput_get_event_name (GimpController * controller,gint event_id)
name|dx_dinput_get_event_name
parameter_list|(
name|GimpController
modifier|*
name|controller
parameter_list|,
name|gint
name|event_id
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|cdxdi
init|=
operator|(
name|ControllerDXDInput
operator|*
operator|)
name|controller
decl_stmt|;
if|if
condition|(
name|event_id
operator|<
literal|0
operator|||
name|event_id
operator|>=
name|cdxdi
operator|->
name|num_events
condition|)
return|return
name|NULL
return|;
return|return
name|cdxdi
operator|->
name|event_names
index|[
name|event_id
index|]
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|gchar
modifier|*
DECL|function|dx_dinput_get_event_blurb (GimpController * controller,gint event_id)
name|dx_dinput_get_event_blurb
parameter_list|(
name|GimpController
modifier|*
name|controller
parameter_list|,
name|gint
name|event_id
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|cdxdi
init|=
operator|(
name|ControllerDXDInput
operator|*
operator|)
name|controller
decl_stmt|;
if|if
condition|(
name|event_id
operator|<
literal|0
operator|||
name|event_id
operator|>=
name|cdxdi
operator|->
name|num_events
condition|)
return|return
name|NULL
return|;
return|return
name|cdxdi
operator|->
name|event_blurbs
index|[
name|event_id
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|BOOL
name|CALLBACK
DECL|function|count_objects (const DIDEVICEOBJECTINSTANCEW * doi,void * user_data)
name|count_objects
parameter_list|(
specifier|const
name|DIDEVICEOBJECTINSTANCEW
modifier|*
name|doi
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|controller
init|=
operator|(
name|ControllerDXDInput
operator|*
operator|)
name|user_data
decl_stmt|;
name|HRESULT
name|hresult
decl_stmt|;
name|DIPROPRANGE
name|range
decl_stmt|;
if|if
condition|(
name|doi
operator|->
name|dwType
operator|&
name|DIDFT_AXIS
condition|)
block|{
comment|/* Set reported range to  physical range, not to give upper        * level software any false impression of higher accuracy.        */
name|range
operator|.
name|diph
operator|.
name|dwSize
operator|=
sizeof|sizeof
argument_list|(
name|DIPROPRANGE
argument_list|)
expr_stmt|;
name|range
operator|.
name|diph
operator|.
name|dwHeaderSize
operator|=
sizeof|sizeof
argument_list|(
name|DIPROPHEADER
argument_list|)
expr_stmt|;
name|range
operator|.
name|diph
operator|.
name|dwObj
operator|=
name|doi
operator|->
name|dwType
expr_stmt|;
name|range
operator|.
name|diph
operator|.
name|dwHow
operator|=
name|DIPH_BYID
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_GetProperty
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|DIPROP_PHYSICALRANGE
argument_list|,
operator|&
name|range
operator|.
name|diph
argument_list|)
operator|)
argument_list|)
condition|)
name|g_warning
argument_list|(
literal|"IDirectInputDevice8::GetProperty failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_SetProperty
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|DIPROP_RANGE
argument_list|,
operator|&
name|range
operator|.
name|diph
argument_list|)
operator|)
argument_list|)
condition|)
name|g_warning
argument_list|(
literal|"IDirectInputDevice8::SetProperty failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_Button
argument_list|)
condition|)
name|controller
operator|->
name|num_buttons
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_XAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_YAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_ZAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RxAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RyAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RzAxis
argument_list|)
condition|)
name|controller
operator|->
name|num_axes
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_Slider
argument_list|)
condition|)
name|controller
operator|->
name|num_sliders
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_POV
argument_list|)
condition|)
name|controller
operator|->
name|num_povs
operator|++
expr_stmt|;
return|return
name|DIENUM_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|BOOL
name|CALLBACK
DECL|function|name_objects (const DIDEVICEOBJECTINSTANCEW * doi,void * user_data)
name|name_objects
parameter_list|(
specifier|const
name|DIDEVICEOBJECTINSTANCEW
modifier|*
name|doi
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
name|controller
init|=
operator|(
name|ControllerDXDInput
operator|*
operator|)
name|user_data
decl_stmt|;
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_Button
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|bei
index|]
operator|=
name|g_strdup_printf
argument_list|(
literal|"button-%d"
argument_list|,
name|controller
operator|->
name|bi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|bei
index|]
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Button %d"
argument_list|)
argument_list|,
name|controller
operator|->
name|bi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|bei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|bei
index|]
operator|=
name|g_strdup_printf
argument_list|(
literal|"button-%d-press"
argument_list|,
name|controller
operator|->
name|bi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|bei
index|]
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Button %d Press"
argument_list|)
argument_list|,
name|controller
operator|->
name|bi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|bei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|bei
index|]
operator|=
name|g_strdup_printf
argument_list|(
literal|"button-%d-release"
argument_list|,
name|controller
operator|->
name|bi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|bei
index|]
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Button %d Release"
argument_list|)
argument_list|,
name|controller
operator|->
name|bi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|bei
operator|++
expr_stmt|;
name|g_assert
argument_list|(
name|controller
operator|->
name|bi
operator|<
name|controller
operator|->
name|num_buttons
argument_list|)
expr_stmt|;
name|controller
operator|->
name|bi
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_XAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_YAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_ZAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RxAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RyAxis
argument_list|)
operator|||
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RzAxis
argument_list|)
condition|)
block|{
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_XAxis
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"x-move-left"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"X Move Left"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"x-move-right"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"X Move Right"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_YAxis
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"y-move-away"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"Y Move Away"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"y-move-near"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"Y Move Near"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_ZAxis
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"z-move-up"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"Z Move Up"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"z-move-down"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"Z Move Down"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RxAxis
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"x-axis-tilt-away"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"X Axis Tilt Away"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"x-axis-tilt-near"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"X Axis Tilt Near"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RyAxis
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"y-axis-tilt-right"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"Y Axis Tilt Right"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"y-axis-tilt-left"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"Y Axis Tilt Left"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_RzAxis
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"z-axis-turn-left"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"Z Axis Turn Left"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
literal|"z-axis-turn-right"
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|aei
index|]
operator|=
name|g_strdup
argument_list|(
name|_
argument_list|(
literal|"Z Axis Turn Right"
argument_list|)
argument_list|)
expr_stmt|;
name|controller
operator|->
name|aei
operator|++
expr_stmt|;
block|}
name|g_assert
argument_list|(
name|controller
operator|->
name|ai
operator|<
name|controller
operator|->
name|num_axes
argument_list|)
expr_stmt|;
name|controller
operator|->
name|ai
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_Slider
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|sei
index|]
operator|=
name|g_strdup_printf
argument_list|(
literal|"slider-%d-increase"
argument_list|,
name|controller
operator|->
name|si
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|sei
index|]
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Slider %d Increase"
argument_list|)
argument_list|,
name|controller
operator|->
name|si
argument_list|)
expr_stmt|;
name|controller
operator|->
name|sei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|sei
index|]
operator|=
name|g_strdup_printf
argument_list|(
literal|"slider-%d-decrease"
argument_list|,
name|controller
operator|->
name|si
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|sei
index|]
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Slider %d Decrease"
argument_list|)
argument_list|,
name|controller
operator|->
name|si
argument_list|)
expr_stmt|;
name|controller
operator|->
name|sei
operator|++
expr_stmt|;
name|g_assert
argument_list|(
name|controller
operator|->
name|si
operator|<
name|controller
operator|->
name|num_sliders
argument_list|)
expr_stmt|;
name|controller
operator|->
name|si
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IsEqualGUID
argument_list|(
operator|&
name|doi
operator|->
name|guidType
argument_list|,
operator|&
name|GUID_POV
argument_list|)
condition|)
block|{
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|pei
index|]
operator|=
name|g_strdup_printf
argument_list|(
literal|"pov-%d-x-view"
argument_list|,
name|controller
operator|->
name|pi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|pei
index|]
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"POV %d X View"
argument_list|)
argument_list|,
name|controller
operator|->
name|pi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|pei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|pei
index|]
operator|=
name|g_strdup_printf
argument_list|(
literal|"pov-%d-y-view"
argument_list|,
name|controller
operator|->
name|pi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|pei
index|]
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"POV %d Y View"
argument_list|)
argument_list|,
name|controller
operator|->
name|pi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|pei
operator|++
expr_stmt|;
name|controller
operator|->
name|event_names
index|[
name|controller
operator|->
name|pei
index|]
operator|=
name|g_strdup_printf
argument_list|(
literal|"pov-%d-x-return"
argument_list|,
name|controller
operator|->
name|pi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
index|[
name|controller
operator|->
name|pei
index|]
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"POV %d Return"
argument_list|)
argument_list|,
name|controller
operator|->
name|pi
argument_list|)
expr_stmt|;
name|controller
operator|->
name|pei
operator|++
expr_stmt|;
name|g_assert
argument_list|(
name|controller
operator|->
name|pi
operator|<
name|controller
operator|->
name|num_povs
argument_list|)
expr_stmt|;
name|controller
operator|->
name|pi
operator|++
expr_stmt|;
block|}
return|return
name|DIENUM_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|dx_dinput_get_device_info (ControllerDXDInput * controller,GError ** error)
name|dx_dinput_get_device_info
parameter_list|(
name|ControllerDXDInput
modifier|*
name|controller
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|HRESULT
name|hresult
decl_stmt|;
name|controller
operator|->
name|num_buttons
operator|=
name|controller
operator|->
name|num_axes
operator|=
name|controller
operator|->
name|num_sliders
operator|=
name|controller
operator|->
name|num_povs
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_EnumObjects
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|count_objects
argument_list|,
name|controller
argument_list|,
name|DIDFT_AXIS
operator||
name|DIDFT_BUTTON
operator||
name|DIDFT_POV
operator||
name|DIDFT_PSHBUTTON
operator||
name|DIDFT_RELAXIS
operator||
name|DIDFT_TGLBUTTON
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|GIMP_MODULE_ERROR
argument_list|,
name|GIMP_MODULE_FAILED
argument_list|,
literal|"IDirectInputDevice8::EnumObjects failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|controller
operator|->
name|num_button_events
operator|=
name|controller
operator|->
name|num_buttons
operator|*
name|NUM_EVENTS_PER_BUTTON
expr_stmt|;
name|controller
operator|->
name|num_axis_events
operator|=
name|controller
operator|->
name|num_axes
operator|*
name|NUM_EVENTS_PER_AXIS
expr_stmt|;
name|controller
operator|->
name|num_slider_events
operator|=
name|controller
operator|->
name|num_sliders
operator|*
name|NUM_EVENTS_PER_SLIDER
expr_stmt|;
name|controller
operator|->
name|num_pov_events
operator|=
name|controller
operator|->
name|num_povs
operator|*
name|NUM_EVENTS_PER_POV
expr_stmt|;
name|controller
operator|->
name|num_events
operator|=
name|controller
operator|->
name|num_button_events
operator|+
name|controller
operator|->
name|num_axis_events
operator|+
name|controller
operator|->
name|num_slider_events
operator|+
name|controller
operator|->
name|num_pov_events
expr_stmt|;
name|controller
operator|->
name|event_names
operator|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
name|controller
operator|->
name|num_events
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event_blurbs
operator|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
name|controller
operator|->
name|num_events
argument_list|)
expr_stmt|;
name|controller
operator|->
name|bi
operator|=
name|controller
operator|->
name|ai
operator|=
name|controller
operator|->
name|si
operator|=
name|controller
operator|->
name|pi
operator|=
literal|0
expr_stmt|;
name|controller
operator|->
name|bei
operator|=
literal|0
expr_stmt|;
name|controller
operator|->
name|aei
operator|=
name|controller
operator|->
name|bei
operator|+
name|controller
operator|->
name|num_button_events
expr_stmt|;
name|controller
operator|->
name|sei
operator|=
name|controller
operator|->
name|aei
operator|+
name|controller
operator|->
name|num_axis_events
expr_stmt|;
name|controller
operator|->
name|pei
operator|=
name|controller
operator|->
name|sei
operator|+
name|controller
operator|->
name|num_slider_events
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_EnumObjects
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|name_objects
argument_list|,
name|controller
argument_list|,
name|DIDFT_AXIS
operator||
name|DIDFT_BUTTON
operator||
name|DIDFT_POV
operator||
name|DIDFT_PSHBUTTON
operator||
name|DIDFT_RELAXIS
operator||
name|DIDFT_TGLBUTTON
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|g_free
argument_list|(
name|controller
operator|->
name|event_names
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|controller
operator|->
name|event_blurbs
argument_list|)
expr_stmt|;
name|g_set_error
argument_list|(
name|error
argument_list|,
name|GIMP_MODULE_ERROR
argument_list|,
name|GIMP_MODULE_FAILED
argument_list|,
literal|"IDirectInputDevice8::EnumObjects failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|g_assert
argument_list|(
name|controller
operator|->
name|bei
operator|==
name|controller
operator|->
name|num_button_events
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|controller
operator|->
name|aei
operator|==
name|controller
operator|->
name|bei
operator|+
name|controller
operator|->
name|num_axis_events
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|controller
operator|->
name|sei
operator|==
name|controller
operator|->
name|aei
operator|+
name|controller
operator|->
name|num_slider_events
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|controller
operator|->
name|pei
operator|==
name|controller
operator|->
name|sei
operator|+
name|controller
operator|->
name|num_pov_events
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dx_dinput_device_changed (ControllerDXDInput * controller,const gchar * guid)
name|dx_dinput_device_changed
parameter_list|(
name|ControllerDXDInput
modifier|*
name|controller
parameter_list|,
specifier|const
name|gchar
modifier|*
name|guid
parameter_list|)
block|{
if|if
condition|(
name|controller
operator|->
name|guid
operator|&&
name|strcmp
argument_list|(
name|guid
argument_list|,
name|controller
operator|->
name|guid
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dx_dinput_set_device
argument_list|(
name|controller
argument_list|,
name|guid
argument_list|)
expr_stmt|;
name|g_object_notify
argument_list|(
name|G_OBJECT
argument_list|(
name|controller
argument_list|)
argument_list|,
literal|"device"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|dx_dinput_event_prepare (GSource * source,gint * timeout)
name|dx_dinput_event_prepare
parameter_list|(
name|GSource
modifier|*
name|source
parameter_list|,
name|gint
modifier|*
name|timeout
parameter_list|)
block|{
operator|*
name|timeout
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|dx_dinput_event_check (GSource * source)
name|dx_dinput_event_check
parameter_list|(
name|GSource
modifier|*
name|source
parameter_list|)
block|{
name|DXDInputSource
modifier|*
name|input
init|=
operator|(
name|DXDInputSource
operator|*
operator|)
name|source
decl_stmt|;
if|if
condition|(
name|WaitForSingleObject
argument_list|(
name|input
operator|->
name|controller
operator|->
name|event
argument_list|,
literal|0
argument_list|)
operator|==
name|WAIT_OBJECT_0
condition|)
block|{
name|ResetEvent
argument_list|(
name|input
operator|->
name|controller
operator|->
name|event
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|dx_dinput_event_dispatch (GSource * source,GSourceFunc callback,gpointer user_data)
name|dx_dinput_event_dispatch
parameter_list|(
name|GSource
modifier|*
name|source
parameter_list|,
name|GSourceFunc
name|callback
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|ControllerDXDInput
modifier|*
specifier|const
name|input
init|=
operator|(
operator|(
name|DXDInputSource
operator|*
operator|)
name|source
operator|)
operator|->
name|controller
decl_stmt|;
name|GimpController
modifier|*
name|controller
init|=
operator|&
name|input
operator|->
name|parent_instance
decl_stmt|;
specifier|const
name|DIDATAFORMAT
modifier|*
specifier|const
name|format
init|=
name|input
operator|->
name|format
decl_stmt|;
specifier|const
name|DIOBJECTDATAFORMAT
modifier|*
name|rgodf
init|=
name|format
operator|->
name|rgodf
decl_stmt|;
name|HRESULT
name|hresult
decl_stmt|;
name|guchar
modifier|*
name|data
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|GimpControllerEvent
name|cevent
init|=
block|{
literal|0
block|, }
decl_stmt|;
name|data
operator|=
name|g_alloca
argument_list|(
name|format
operator|->
name|dwDataSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_GetDeviceState
argument_list|(
name|input
operator|->
name|didevice8
argument_list|,
name|format
operator|->
name|dwDataSize
argument_list|,
name|data
argument_list|)
operator|)
argument_list|)
condition|)
block|{
return|return
name|TRUE
return|;
block|}
name|g_object_ref
argument_list|(
name|controller
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|input
operator|->
name|num_buttons
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|input
operator|->
name|prevdata
index|[
name|rgodf
operator|->
name|dwOfs
index|]
operator|!=
name|data
index|[
name|rgodf
operator|->
name|dwOfs
index|]
condition|)
block|{
if|if
condition|(
name|data
index|[
name|rgodf
operator|->
name|dwOfs
index|]
operator|&
literal|0x80
condition|)
block|{
comment|/* Click event, compatibility with Linux Input */
name|cevent
operator|.
name|any
operator|.
name|type
operator|=
name|GIMP_CONTROLLER_EVENT_TRIGGER
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|source
operator|=
name|controller
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|=
name|i
operator|*
name|NUM_EVENTS_PER_BUTTON
expr_stmt|;
name|gimp_controller_event
argument_list|(
name|controller
argument_list|,
operator|&
name|cevent
argument_list|)
expr_stmt|;
comment|/* Press event */
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|=
name|i
operator|*
name|NUM_EVENTS_PER_BUTTON
operator|+
literal|1
expr_stmt|;
name|gimp_controller_event
argument_list|(
name|controller
argument_list|,
operator|&
name|cevent
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Release event */
name|cevent
operator|.
name|any
operator|.
name|type
operator|=
name|GIMP_CONTROLLER_EVENT_TRIGGER
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|source
operator|=
name|controller
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|=
name|i
operator|*
name|NUM_EVENTS_PER_BUTTON
operator|+
literal|2
expr_stmt|;
name|gimp_controller_event
argument_list|(
name|controller
argument_list|,
operator|&
name|cevent
argument_list|)
expr_stmt|;
block|}
block|}
name|rgodf
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|input
operator|->
name|num_axes
condition|;
name|i
operator|++
control|)
block|{
name|LONG
modifier|*
name|prev
init|=
operator|(
name|LONG
operator|*
operator|)
operator|(
name|input
operator|->
name|prevdata
operator|+
name|rgodf
operator|->
name|dwOfs
operator|)
decl_stmt|;
name|LONG
modifier|*
name|curr
init|=
operator|(
name|LONG
operator|*
operator|)
operator|(
name|data
operator|+
name|rgodf
operator|->
name|dwOfs
operator|)
decl_stmt|;
if|if
condition|(
name|ABS
argument_list|(
operator|*
name|prev
operator|-
operator|*
name|curr
argument_list|)
operator|>
literal|1
condition|)
block|{
name|cevent
operator|.
name|any
operator|.
name|type
operator|=
name|GIMP_CONTROLLER_EVENT_VALUE
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|source
operator|=
name|controller
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|=
name|input
operator|->
name|num_button_events
operator|+
name|i
operator|*
name|NUM_EVENTS_PER_AXIS
expr_stmt|;
name|g_value_init
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
name|G_TYPE_DOUBLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|curr
operator|-
operator|*
name|prev
operator|<
literal|0
condition|)
block|{
name|g_value_set_double
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
operator|*
name|prev
operator|-
operator|*
name|curr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|++
expr_stmt|;
name|g_value_set_double
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
operator|*
name|curr
operator|-
operator|*
name|prev
argument_list|)
expr_stmt|;
block|}
name|gimp_controller_event
argument_list|(
name|controller
argument_list|,
operator|&
name|cevent
argument_list|)
expr_stmt|;
name|g_value_unset
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|curr
operator|=
operator|*
name|prev
expr_stmt|;
name|rgodf
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|input
operator|->
name|num_sliders
condition|;
name|i
operator|++
control|)
block|{
name|LONG
modifier|*
name|prev
init|=
operator|(
name|LONG
operator|*
operator|)
operator|(
name|input
operator|->
name|prevdata
operator|+
name|rgodf
operator|->
name|dwOfs
operator|)
decl_stmt|;
name|LONG
modifier|*
name|curr
init|=
operator|(
name|LONG
operator|*
operator|)
operator|(
name|data
operator|+
name|rgodf
operator|->
name|dwOfs
operator|)
decl_stmt|;
if|if
condition|(
name|ABS
argument_list|(
operator|*
name|prev
operator|-
operator|*
name|curr
argument_list|)
operator|>
literal|1
condition|)
block|{
name|cevent
operator|.
name|any
operator|.
name|type
operator|=
name|GIMP_CONTROLLER_EVENT_VALUE
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|source
operator|=
name|controller
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|=
name|input
operator|->
name|num_button_events
operator|+
name|input
operator|->
name|num_axis_events
operator|+
name|i
operator|*
name|NUM_EVENTS_PER_SLIDER
expr_stmt|;
name|g_value_init
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
name|G_TYPE_DOUBLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|curr
operator|-
operator|*
name|prev
operator|<
literal|0
condition|)
block|{
name|g_value_set_double
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
operator|*
name|prev
operator|-
operator|*
name|curr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|++
expr_stmt|;
name|g_value_set_double
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
operator|*
name|curr
operator|-
operator|*
name|prev
argument_list|)
expr_stmt|;
block|}
name|gimp_controller_event
argument_list|(
name|controller
argument_list|,
operator|&
name|cevent
argument_list|)
expr_stmt|;
name|g_value_unset
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|curr
operator|=
operator|*
name|prev
expr_stmt|;
name|rgodf
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|input
operator|->
name|num_povs
condition|;
name|i
operator|++
control|)
block|{
name|LONG
name|prev
init|=
operator|*
operator|(
operator|(
name|LONG
operator|*
operator|)
operator|(
name|input
operator|->
name|prevdata
operator|+
name|rgodf
operator|->
name|dwOfs
operator|)
operator|)
decl_stmt|;
name|LONG
name|curr
init|=
operator|*
operator|(
operator|(
name|LONG
operator|*
operator|)
operator|(
name|data
operator|+
name|rgodf
operator|->
name|dwOfs
operator|)
operator|)
decl_stmt|;
name|double
name|prevx
decl_stmt|,
name|prevy
decl_stmt|;
name|double
name|currx
decl_stmt|,
name|curry
decl_stmt|;
if|if
condition|(
name|prev
operator|!=
name|curr
condition|)
block|{
if|if
condition|(
name|prev
operator|==
operator|-
literal|1
condition|)
block|{
name|prevx
operator|=
literal|0.
expr_stmt|;
name|prevy
operator|=
literal|0.
expr_stmt|;
block|}
else|else
block|{
name|prevx
operator|=
name|sin
argument_list|(
name|prev
operator|/
literal|36000.
operator|*
literal|2.
operator|*
name|G_PI
argument_list|)
expr_stmt|;
name|prevy
operator|=
name|cos
argument_list|(
name|prev
operator|/
literal|36000.
operator|*
literal|2.
operator|*
name|G_PI
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|curr
operator|==
operator|-
literal|1
condition|)
block|{
name|currx
operator|=
literal|0.
expr_stmt|;
name|curry
operator|=
literal|0.
expr_stmt|;
block|}
else|else
block|{
name|currx
operator|=
name|sin
argument_list|(
name|curr
operator|/
literal|36000.
operator|*
literal|2.
operator|*
name|G_PI
argument_list|)
expr_stmt|;
name|curry
operator|=
name|cos
argument_list|(
name|curr
operator|/
literal|36000.
operator|*
literal|2.
operator|*
name|G_PI
argument_list|)
expr_stmt|;
block|}
name|cevent
operator|.
name|any
operator|.
name|type
operator|=
name|GIMP_CONTROLLER_EVENT_VALUE
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|source
operator|=
name|controller
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|=
name|input
operator|->
name|num_button_events
operator|+
name|input
operator|->
name|num_axis_events
operator|+
name|input
operator|->
name|num_slider_events
operator|+
name|i
operator|*
name|NUM_EVENTS_PER_POV
expr_stmt|;
name|g_value_init
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
name|G_TYPE_DOUBLE
argument_list|)
expr_stmt|;
name|g_value_set_double
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
name|currx
operator|-
name|prevx
argument_list|)
expr_stmt|;
name|gimp_controller_event
argument_list|(
name|controller
argument_list|,
operator|&
name|cevent
argument_list|)
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|++
expr_stmt|;
name|g_value_set_double
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|,
name|curry
operator|-
name|prevy
argument_list|)
expr_stmt|;
name|gimp_controller_event
argument_list|(
name|controller
argument_list|,
operator|&
name|cevent
argument_list|)
expr_stmt|;
name|g_value_unset
argument_list|(
operator|&
name|cevent
operator|.
name|value
operator|.
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|==
operator|-
literal|1
condition|)
block|{
name|cevent
operator|.
name|any
operator|.
name|type
operator|=
name|GIMP_CONTROLLER_EVENT_TRIGGER
expr_stmt|;
name|cevent
operator|.
name|any
operator|.
name|event_id
operator|++
expr_stmt|;
name|gimp_controller_event
argument_list|(
name|controller
argument_list|,
operator|&
name|cevent
argument_list|)
expr_stmt|;
block|}
block|}
name|rgodf
operator|++
expr_stmt|;
block|}
name|g_assert
argument_list|(
name|rgodf
operator|==
name|format
operator|->
name|rgodf
operator|+
name|format
operator|->
name|dwNumObjs
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|input
operator|->
name|prevdata
argument_list|,
name|data
argument_list|,
name|format
operator|->
name|dwDataSize
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|controller
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_decl_stmt
DECL|variable|dx_dinput_event_funcs
specifier|static
name|GSourceFuncs
name|dx_dinput_event_funcs
init|=
block|{
name|dx_dinput_event_prepare
block|,
name|dx_dinput_event_check
block|,
name|dx_dinput_event_dispatch
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|dump_data_format (const DIDATAFORMAT * format)
name|dump_data_format
parameter_list|(
specifier|const
name|DIDATAFORMAT
modifier|*
name|format
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|GIMP_UNSTABLE
name|gint
name|i
decl_stmt|;
name|g_print
argument_list|(
literal|"dwSize: %ld\n"
argument_list|,
name|format
operator|->
name|dwSize
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"dwObjSize: %ld\n"
argument_list|,
name|format
operator|->
name|dwObjSize
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"dwFlags: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|format
operator|->
name|dwFlags
operator|==
name|DIDF_ABSAXIS
condition|)
name|g_print
argument_list|(
literal|"DIDF_ABSAXIS"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|format
operator|->
name|dwFlags
operator|==
name|DIDF_RELAXIS
condition|)
name|g_print
argument_list|(
literal|"DIDF_RELAXIS"
argument_list|)
expr_stmt|;
else|else
name|g_print
argument_list|(
literal|"%#lx"
argument_list|,
name|format
operator|->
name|dwFlags
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"dwDataSize: %ld\n"
argument_list|,
name|format
operator|->
name|dwDataSize
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"dwNumObjs: %ld\n"
argument_list|,
name|format
operator|->
name|dwNumObjs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|format
operator|->
name|dwNumObjs
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|DIOBJECTDATAFORMAT
modifier|*
name|oformat
init|=
operator|(
name|DIOBJECTDATAFORMAT
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|format
operator|->
name|rgodf
operator|)
operator|+
name|i
operator|*
name|format
operator|->
name|dwObjSize
operator|)
decl_stmt|;
name|unsigned
name|char
modifier|*
name|guid
decl_stmt|;
name|g_print
argument_list|(
literal|"Object %d:\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|oformat
operator|->
name|pguid
operator|==
name|NULL
condition|)
name|g_print
argument_list|(
literal|"  pguid: NULL\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|UuidToString
argument_list|(
name|oformat
operator|->
name|pguid
argument_list|,
operator|&
name|guid
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"  pguid: %s\n"
argument_list|,
name|guid
argument_list|)
expr_stmt|;
name|RpcStringFree
argument_list|(
operator|&
name|guid
argument_list|)
expr_stmt|;
block|}
name|g_print
argument_list|(
literal|"  dwOfs: %ld\n"
argument_list|,
name|oformat
operator|->
name|dwOfs
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"  dwType: "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|DIDFT_GETTYPE
argument_list|(
name|oformat
operator|->
name|dwType
argument_list|)
condition|)
block|{
DECL|macro|CASE (x)
define|#
directive|define
name|CASE
parameter_list|(
name|x
parameter_list|)
value|case DIDFT_##x: g_print ("DIDFT_"#x); break
name|CASE
argument_list|(
name|RELAXIS
argument_list|)
expr_stmt|;
name|CASE
argument_list|(
name|ABSAXIS
argument_list|)
expr_stmt|;
name|CASE
argument_list|(
name|AXIS
argument_list|)
expr_stmt|;
name|CASE
argument_list|(
name|PSHBUTTON
argument_list|)
expr_stmt|;
name|CASE
argument_list|(
name|TGLBUTTON
argument_list|)
expr_stmt|;
name|CASE
argument_list|(
name|BUTTON
argument_list|)
expr_stmt|;
name|CASE
argument_list|(
name|POV
argument_list|)
expr_stmt|;
name|CASE
argument_list|(
name|COLLECTION
argument_list|)
expr_stmt|;
name|CASE
argument_list|(
name|NODATA
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|CASE
default|default:
name|g_print
argument_list|(
literal|"%#x"
argument_list|,
name|DIDFT_GETTYPE
argument_list|(
name|oformat
operator|->
name|dwType
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|g_print
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|DIDFT_GETINSTANCE
argument_list|(
name|oformat
operator|->
name|dwType
argument_list|)
operator|==
name|DIDFT_GETINSTANCE
argument_list|(
name|DIDFT_ANYINSTANCE
argument_list|)
condition|)
name|g_print
argument_list|(
literal|"ANYINSTANCE"
argument_list|)
expr_stmt|;
else|else
name|g_print
argument_list|(
literal|"#%d"
argument_list|,
name|DIDFT_GETINSTANCE
argument_list|(
name|oformat
operator|->
name|dwType
argument_list|)
argument_list|)
expr_stmt|;
DECL|macro|BIT (x)
define|#
directive|define
name|BIT
parameter_list|(
name|x
parameter_list|)
value|if (oformat->dwType& DIDFT_##x) g_print (" "#x)
name|BIT
argument_list|(
name|FFACTUATOR
argument_list|)
expr_stmt|;
name|BIT
argument_list|(
name|FFEFFECTTRIGGER
argument_list|)
expr_stmt|;
name|BIT
argument_list|(
name|OUTPUT
argument_list|)
expr_stmt|;
name|BIT
argument_list|(
name|VENDORDEFINED
argument_list|)
expr_stmt|;
name|BIT
argument_list|(
name|ALIAS
argument_list|)
expr_stmt|;
name|BIT
argument_list|(
name|OPTIONAL
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|BIT
name|g_print
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"  dwFlags:"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|oformat
operator|->
name|dwFlags
operator|&
name|DIDOI_ASPECTACCEL
condition|)
block|{
case|case
name|DIDOI_ASPECTPOSITION
case|:
name|g_print
argument_list|(
literal|" DIDOI_ASPECTPOSITION"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIDOI_ASPECTVELOCITY
case|:
name|g_print
argument_list|(
literal|" DIDOI_ASPECTVELOCITY"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIDOI_ASPECTACCEL
case|:
name|g_print
argument_list|(
literal|" DIDOI_ASPECTACCEL"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|oformat
operator|->
name|dwFlags
operator|&
name|DIDOI_ASPECTFORCE
condition|)
name|g_print
argument_list|(
literal|" DIDOI_ASPECTFORCE"
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|dx_dinput_setup_events (ControllerDXDInput * controller,GError ** error)
name|dx_dinput_setup_events
parameter_list|(
name|ControllerDXDInput
modifier|*
name|controller
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|HRESULT
name|hresult
decl_stmt|;
name|DIPROPDWORD
name|dword
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|k
decl_stmt|;
name|DXDInputSource
modifier|*
name|source
decl_stmt|;
if|if
condition|(
operator|(
name|controller
operator|->
name|event
operator|=
name|CreateEvent
argument_list|(
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|GIMP_MODULE_ERROR
argument_list|,
name|GIMP_MODULE_FAILED
argument_list|,
literal|"CreateEvent failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|GetLastError
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|controller
operator|->
name|format
operator|=
name|g_new
argument_list|(
name|DIDATAFORMAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwSize
operator|=
sizeof|sizeof
argument_list|(
name|DIDATAFORMAT
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwObjSize
operator|=
sizeof|sizeof
argument_list|(
name|DIOBJECTDATAFORMAT
argument_list|)
expr_stmt|;
name|dword
operator|.
name|diph
operator|.
name|dwSize
operator|=
sizeof|sizeof
argument_list|(
name|DIPROPDWORD
argument_list|)
expr_stmt|;
name|dword
operator|.
name|diph
operator|.
name|dwHeaderSize
operator|=
sizeof|sizeof
argument_list|(
name|DIPROPHEADER
argument_list|)
expr_stmt|;
name|dword
operator|.
name|diph
operator|.
name|dwObj
operator|=
literal|0
expr_stmt|;
name|dword
operator|.
name|diph
operator|.
name|dwHow
operator|=
name|DIPH_DEVICE
expr_stmt|;
comment|/* Get the axis mode so we can use the same in the format */
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_GetProperty
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|DIPROP_AXISMODE
argument_list|,
operator|&
name|dword
operator|.
name|diph
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|GIMP_MODULE_ERROR
argument_list|,
name|GIMP_MODULE_FAILED
argument_list|,
literal|"IDirectInputDevice8::GetParameters failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail0
goto|;
block|}
name|controller
operator|->
name|format
operator|->
name|dwFlags
operator|=
name|dword
operator|.
name|dwData
operator|+
literal|1
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwNumObjs
operator|=
name|controller
operator|->
name|num_buttons
operator|+
name|controller
operator|->
name|num_axes
operator|+
name|controller
operator|->
name|num_sliders
operator|+
name|controller
operator|->
name|num_povs
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
operator|=
name|g_new
argument_list|(
name|DIOBJECTDATAFORMAT
argument_list|,
name|controller
operator|->
name|format
operator|->
name|dwNumObjs
argument_list|)
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|controller
operator|->
name|num_buttons
condition|;
name|i
operator|++
control|)
block|{
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|pguid
operator|=
name|NULL
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwOfs
operator|=
name|controller
operator|->
name|format
operator|->
name|dwDataSize
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwType
operator|=
name|DIDFT_BUTTON
operator||
name|DIDFT_MAKEINSTANCE
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwFlags
operator|=
literal|0
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|+=
literal|1
expr_stmt|;
name|k
operator|++
expr_stmt|;
block|}
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|=
literal|4
operator|*
operator|(
operator|(
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|+
literal|3
operator|)
operator|/
literal|4
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|controller
operator|->
name|num_axes
condition|;
name|i
operator|++
control|)
block|{
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|pguid
operator|=
name|NULL
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwOfs
operator|=
name|controller
operator|->
name|format
operator|->
name|dwDataSize
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwType
operator|=
name|DIDFT_AXIS
operator||
name|DIDFT_MAKEINSTANCE
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwFlags
operator|=
name|DIDOI_ASPECTPOSITION
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|+=
literal|4
expr_stmt|;
name|k
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|controller
operator|->
name|num_sliders
condition|;
name|i
operator|++
control|)
block|{
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|pguid
operator|=
name|NULL
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwOfs
operator|=
name|controller
operator|->
name|format
operator|->
name|dwDataSize
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwType
operator|=
name|DIDFT_AXIS
operator||
name|DIDFT_MAKEINSTANCE
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwFlags
operator|=
name|DIDOI_ASPECTPOSITION
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|+=
literal|4
expr_stmt|;
name|k
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|controller
operator|->
name|num_povs
condition|;
name|i
operator|++
control|)
block|{
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|pguid
operator|=
name|NULL
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwOfs
operator|=
name|controller
operator|->
name|format
operator|->
name|dwDataSize
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwType
operator|=
name|DIDFT_POV
operator||
name|DIDFT_MAKEINSTANCE
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|rgodf
index|[
name|k
index|]
operator|.
name|dwFlags
operator|=
literal|0
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|+=
literal|4
expr_stmt|;
name|k
operator|++
expr_stmt|;
block|}
name|g_assert
argument_list|(
name|k
operator|==
name|controller
operator|->
name|format
operator|->
name|dwNumObjs
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|=
literal|4
operator|*
operator|(
operator|(
name|controller
operator|->
name|format
operator|->
name|dwDataSize
operator|+
literal|3
operator|)
operator|/
literal|4
operator|)
expr_stmt|;
name|controller
operator|->
name|prevdata
operator|=
name|g_malloc
argument_list|(
name|controller
operator|->
name|format
operator|->
name|dwDataSize
argument_list|)
expr_stmt|;
name|dump_data_format
argument_list|(
name|controller
operator|->
name|format
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_SetDataFormat
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|controller
operator|->
name|format
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|GIMP_MODULE_ERROR
argument_list|,
name|GIMP_MODULE_FAILED
argument_list|,
literal|"IDirectInputDevice8::SetDataFormat failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_SetEventNotification
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|controller
operator|->
name|event
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|GIMP_MODULE_ERROR
argument_list|,
name|GIMP_MODULE_FAILED
argument_list|,
literal|"IDirectInputDevice8::SetEventNotification failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_Acquire
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|GIMP_MODULE_ERROR
argument_list|,
name|GIMP_MODULE_FAILED
argument_list|,
literal|"IDirectInputDevice8::Acquire failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
name|FAILED
argument_list|(
operator|(
name|hresult
operator|=
name|IDirectInputDevice8_GetDeviceState
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|controller
operator|->
name|format
operator|->
name|dwDataSize
argument_list|,
name|controller
operator|->
name|prevdata
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|GIMP_MODULE_ERROR
argument_list|,
name|GIMP_MODULE_FAILED
argument_list|,
literal|"IDirectInputDevice8::GetDeviceState failed: %s"
argument_list|,
name|g_win32_error_message
argument_list|(
name|hresult
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|source
operator|=
operator|(
name|DXDInputSource
operator|*
operator|)
name|g_source_new
argument_list|(
operator|&
name|dx_dinput_event_funcs
argument_list|,
sizeof|sizeof
argument_list|(
name|DXDInputSource
argument_list|)
argument_list|)
expr_stmt|;
name|source
operator|->
name|controller
operator|=
name|controller
expr_stmt|;
name|controller
operator|->
name|source
operator|=
operator|(
name|GSource
operator|*
operator|)
name|source
expr_stmt|;
name|controller
operator|->
name|pollfd
operator|=
name|g_new
argument_list|(
name|GPollFD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|controller
operator|->
name|pollfd
operator|->
name|fd
operator|=
operator|(
name|int
operator|)
name|controller
operator|->
name|event
expr_stmt|;
name|controller
operator|->
name|pollfd
operator|->
name|events
operator|=
name|G_IO_IN
expr_stmt|;
name|g_source_add_poll
argument_list|(
operator|&
name|source
operator|->
name|source
argument_list|,
name|controller
operator|->
name|pollfd
argument_list|)
expr_stmt|;
name|g_source_attach
argument_list|(
operator|&
name|source
operator|->
name|source
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
name|fail2
label|:
name|IDirectInputDevice8_SetEventNotification
argument_list|(
name|controller
operator|->
name|didevice8
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fail1
label|:
name|g_free
argument_list|(
name|controller
operator|->
name|format
operator|->
name|rgodf
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|controller
operator|->
name|format
argument_list|)
expr_stmt|;
name|controller
operator|->
name|format
operator|=
name|NULL
expr_stmt|;
name|g_free
argument_list|(
name|controller
operator|->
name|prevdata
argument_list|)
expr_stmt|;
name|controller
operator|->
name|prevdata
operator|=
name|NULL
expr_stmt|;
name|fail0
label|:
name|CloseHandle
argument_list|(
name|controller
operator|->
name|event
argument_list|)
expr_stmt|;
name|controller
operator|->
name|event
operator|=
literal|0
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|dx_dinput_set_device (ControllerDXDInput * controller,const gchar * guid)
name|dx_dinput_set_device
parameter_list|(
name|ControllerDXDInput
modifier|*
name|controller
parameter_list|,
specifier|const
name|gchar
modifier|*
name|guid
parameter_list|)
block|{
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|controller
operator|->
name|guid
condition|)
name|g_free
argument_list|(
name|controller
operator|->
name|guid
argument_list|)
expr_stmt|;
name|controller
operator|->
name|guid
operator|=
name|g_strdup
argument_list|(
name|guid
argument_list|)
expr_stmt|;
name|g_object_set
argument_list|(
name|controller
argument_list|,
literal|"name"
argument_list|,
name|_
argument_list|(
literal|"DirectInput Events"
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|controller
operator|->
name|guid
operator|&&
name|strlen
argument_list|(
name|controller
operator|->
name|guid
argument_list|)
condition|)
block|{
if|if
condition|(
name|controller
operator|->
name|store
condition|)
name|controller
operator|->
name|didevice8
operator|=
operator|(
name|LPDIRECTINPUTDEVICE8W
operator|)
name|gimp_input_device_store_get_device_file
argument_list|(
name|controller
operator|->
name|store
argument_list|,
name|controller
operator|->
name|guid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|g_object_set
argument_list|(
name|controller
argument_list|,
literal|"state"
argument_list|,
name|_
argument_list|(
literal|"No device configured"
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|controller
operator|->
name|didevice8
condition|)
block|{
if|if
condition|(
operator|!
name|dx_dinput_get_device_info
argument_list|(
name|controller
argument_list|,
operator|&
name|error
argument_list|)
operator|||
operator|!
name|dx_dinput_setup_events
argument_list|(
name|controller
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|g_object_set
argument_list|(
name|controller
argument_list|,
literal|"state"
argument_list|,
name|error
operator|->
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_error_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|controller
operator|->
name|store
condition|)
block|{
name|error
operator|=
name|gimp_input_device_store_get_error
argument_list|(
name|controller
operator|->
name|store
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|g_object_set
argument_list|(
name|controller
argument_list|,
literal|"state"
argument_list|,
name|error
operator|->
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_error_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|g_object_set
argument_list|(
name|controller
argument_list|,
literal|"state"
argument_list|,
name|_
argument_list|(
literal|"Device not available"
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

end_unit

