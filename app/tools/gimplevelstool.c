begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"actionarea.h"
end_include

begin_include
include|#
directive|include
file|"buildmenu.h"
end_include

begin_include
include|#
directive|include
file|"colormaps.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"general.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"histogram.h"
end_include

begin_include
include|#
directive|include
file|"image_map.h"
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"levels.h"
end_include

begin_define
DECL|macro|LOW_INPUT
define|#
directive|define
name|LOW_INPUT
value|0x1
end_define

begin_define
DECL|macro|GAMMA
define|#
directive|define
name|GAMMA
value|0x2
end_define

begin_define
DECL|macro|HIGH_INPUT
define|#
directive|define
name|HIGH_INPUT
value|0x4
end_define

begin_define
DECL|macro|LOW_OUTPUT
define|#
directive|define
name|LOW_OUTPUT
value|0x8
end_define

begin_define
DECL|macro|HIGH_OUTPUT
define|#
directive|define
name|HIGH_OUTPUT
value|0x10
end_define

begin_define
DECL|macro|INPUT_LEVELS
define|#
directive|define
name|INPUT_LEVELS
value|0x20
end_define

begin_define
DECL|macro|OUTPUT_LEVELS
define|#
directive|define
name|OUTPUT_LEVELS
value|0x40
end_define

begin_define
DECL|macro|INPUT_SLIDERS
define|#
directive|define
name|INPUT_SLIDERS
value|0x80
end_define

begin_define
DECL|macro|OUTPUT_SLIDERS
define|#
directive|define
name|OUTPUT_SLIDERS
value|0x100
end_define

begin_define
DECL|macro|DRAW
define|#
directive|define
name|DRAW
value|0x200
end_define

begin_define
DECL|macro|ALL
define|#
directive|define
name|ALL
value|0xFFF
end_define

begin_define
DECL|macro|TEXT_WIDTH
define|#
directive|define
name|TEXT_WIDTH
value|45
end_define

begin_define
DECL|macro|DA_WIDTH
define|#
directive|define
name|DA_WIDTH
value|256
end_define

begin_define
DECL|macro|DA_HEIGHT
define|#
directive|define
name|DA_HEIGHT
value|25
end_define

begin_define
DECL|macro|GRADIENT_HEIGHT
define|#
directive|define
name|GRADIENT_HEIGHT
value|15
end_define

begin_define
DECL|macro|CONTROL_HEIGHT
define|#
directive|define
name|CONTROL_HEIGHT
value|DA_HEIGHT - GRADIENT_HEIGHT
end_define

begin_define
DECL|macro|HISTOGRAM_WIDTH
define|#
directive|define
name|HISTOGRAM_WIDTH
value|256
end_define

begin_define
DECL|macro|HISTOGRAM_HEIGHT
define|#
directive|define
name|HISTOGRAM_HEIGHT
value|150
end_define

begin_define
DECL|macro|LEVELS_DA_MASK
define|#
directive|define
name|LEVELS_DA_MASK
value|GDK_EXPOSURE_MASK | \                         GDK_ENTER_NOTIFY_MASK | \ 			GDK_BUTTON_PRESS_MASK | \ 			GDK_BUTTON_RELEASE_MASK | \ 			GDK_BUTTON1_MOTION_MASK | \ 			GDK_POINTER_MOTION_HINT_MASK
end_define

begin_typedef
DECL|typedef|Levels
typedef|typedef
name|struct
name|_Levels
name|Levels
typedef|;
end_typedef

begin_struct
DECL|struct|_Levels
struct|struct
name|_Levels
block|{
DECL|member|x
DECL|member|y
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
comment|/*  coords for last mouse click  */
block|}
struct|;
end_struct

begin_typedef
DECL|typedef|LevelsDialog
typedef|typedef
name|struct
name|_LevelsDialog
name|LevelsDialog
typedef|;
end_typedef

begin_struct
DECL|struct|_LevelsDialog
struct|struct
name|_LevelsDialog
block|{
DECL|member|shell
name|GtkWidget
modifier|*
name|shell
decl_stmt|;
DECL|member|low_input_text
name|GtkWidget
modifier|*
name|low_input_text
decl_stmt|;
DECL|member|gamma_text
name|GtkWidget
modifier|*
name|gamma_text
decl_stmt|;
DECL|member|high_input_text
name|GtkWidget
modifier|*
name|high_input_text
decl_stmt|;
DECL|member|low_output_text
name|GtkWidget
modifier|*
name|low_output_text
decl_stmt|;
DECL|member|high_output_text
name|GtkWidget
modifier|*
name|high_output_text
decl_stmt|;
DECL|member|input_levels_da
name|GtkWidget
modifier|*
name|input_levels_da
index|[
literal|2
index|]
decl_stmt|;
DECL|member|output_levels_da
name|GtkWidget
modifier|*
name|output_levels_da
index|[
literal|2
index|]
decl_stmt|;
DECL|member|channel_menu
name|GtkWidget
modifier|*
name|channel_menu
decl_stmt|;
DECL|member|histogram
name|Histogram
modifier|*
name|histogram
decl_stmt|;
DECL|member|drawable
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
DECL|member|image_map
name|ImageMap
name|image_map
decl_stmt|;
DECL|member|color
name|int
name|color
decl_stmt|;
DECL|member|channel
name|int
name|channel
decl_stmt|;
DECL|member|low_input
name|int
name|low_input
index|[
literal|5
index|]
decl_stmt|;
DECL|member|gamma
name|double
name|gamma
index|[
literal|5
index|]
decl_stmt|;
DECL|member|high_input
name|int
name|high_input
index|[
literal|5
index|]
decl_stmt|;
DECL|member|low_output
name|int
name|low_output
index|[
literal|5
index|]
decl_stmt|;
DECL|member|high_output
name|int
name|high_output
index|[
literal|5
index|]
decl_stmt|;
DECL|member|preview
name|gint
name|preview
decl_stmt|;
DECL|member|active_slider
name|int
name|active_slider
decl_stmt|;
DECL|member|slider_pos
name|int
name|slider_pos
index|[
literal|5
index|]
decl_stmt|;
comment|/*  positions for the five sliders  */
DECL|member|input
name|unsigned
name|char
name|input
index|[
literal|5
index|]
index|[
literal|256
index|]
decl_stmt|;
DECL|member|output
name|unsigned
name|char
name|output
index|[
literal|5
index|]
index|[
literal|256
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  levels action functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|levels_button_press
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_button_release
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_motion
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_cursor_update
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_control
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|int
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|LevelsDialog
modifier|*
name|levels_new_dialog
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_calculate_transfers
parameter_list|(
name|LevelsDialog
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_update
parameter_list|(
name|LevelsDialog
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_preview
parameter_list|(
name|LevelsDialog
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_value_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_red_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_green_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_blue_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_alpha_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_auto_levels_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|levels_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_preview_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_low_input_text_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_gamma_text_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_high_input_text_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_low_output_text_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_high_output_text_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|levels_input_da_events
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|,
name|LevelsDialog
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|levels_output_da_events
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|,
name|LevelsDialog
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|levels_options
specifier|static
name|void
modifier|*
name|levels_options
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|levels_dialog
specifier|static
name|LevelsDialog
modifier|*
name|levels_dialog
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|levels
parameter_list|(
name|PixelRegion
modifier|*
parameter_list|,
name|PixelRegion
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_histogram_info
parameter_list|(
name|PixelRegion
modifier|*
parameter_list|,
name|PixelRegion
modifier|*
parameter_list|,
name|HistogramValues
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|levels_histogram_range
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|HistogramValues
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|levels_invoker
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  levels machinery  */
end_comment

begin_function
specifier|static
name|void
DECL|function|levels (PixelRegion * srcPR,PixelRegion * destPR,void * user_data)
name|levels
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|destPR
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|unsigned
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|unsigned
name|char
modifier|*
name|dest
decl_stmt|,
modifier|*
name|d
decl_stmt|;
name|int
name|has_alpha
decl_stmt|,
name|alpha
decl_stmt|;
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|user_data
expr_stmt|;
name|h
operator|=
name|srcPR
operator|->
name|h
expr_stmt|;
name|src
operator|=
name|srcPR
operator|->
name|data
expr_stmt|;
name|dest
operator|=
name|destPR
operator|->
name|data
expr_stmt|;
name|has_alpha
operator|=
operator|(
name|srcPR
operator|->
name|bytes
operator|==
literal|2
operator|||
name|srcPR
operator|->
name|bytes
operator|==
literal|4
operator|)
expr_stmt|;
name|alpha
operator|=
name|has_alpha
condition|?
name|srcPR
operator|->
name|bytes
operator|-
literal|1
else|:
name|srcPR
operator|->
name|bytes
expr_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|w
operator|=
name|srcPR
operator|->
name|w
expr_stmt|;
name|s
operator|=
name|src
expr_stmt|;
name|d
operator|=
name|dest
expr_stmt|;
while|while
condition|(
name|w
operator|--
condition|)
block|{
if|if
condition|(
name|ld
operator|->
name|color
condition|)
block|{
comment|/*  The contributions from the individual channel level settings  */
name|d
index|[
name|RED_PIX
index|]
operator|=
name|ld
operator|->
name|output
index|[
name|HISTOGRAM_RED
index|]
index|[
name|ld
operator|->
name|input
index|[
name|HISTOGRAM_RED
index|]
index|[
name|s
index|[
name|RED_PIX
index|]
index|]
index|]
expr_stmt|;
name|d
index|[
name|GREEN_PIX
index|]
operator|=
name|ld
operator|->
name|output
index|[
name|HISTOGRAM_GREEN
index|]
index|[
name|ld
operator|->
name|input
index|[
name|HISTOGRAM_GREEN
index|]
index|[
name|s
index|[
name|GREEN_PIX
index|]
index|]
index|]
expr_stmt|;
name|d
index|[
name|BLUE_PIX
index|]
operator|=
name|ld
operator|->
name|output
index|[
name|HISTOGRAM_BLUE
index|]
index|[
name|ld
operator|->
name|input
index|[
name|HISTOGRAM_BLUE
index|]
index|[
name|s
index|[
name|BLUE_PIX
index|]
index|]
index|]
expr_stmt|;
comment|/*  The overall changes  */
name|d
index|[
name|RED_PIX
index|]
operator|=
name|ld
operator|->
name|output
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|ld
operator|->
name|input
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|d
index|[
name|RED_PIX
index|]
index|]
index|]
expr_stmt|;
name|d
index|[
name|GREEN_PIX
index|]
operator|=
name|ld
operator|->
name|output
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|ld
operator|->
name|input
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|d
index|[
name|GREEN_PIX
index|]
index|]
index|]
expr_stmt|;
name|d
index|[
name|BLUE_PIX
index|]
operator|=
name|ld
operator|->
name|output
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|ld
operator|->
name|input
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|d
index|[
name|BLUE_PIX
index|]
index|]
index|]
expr_stmt|;
block|}
else|else
name|d
index|[
name|GRAY_PIX
index|]
operator|=
name|ld
operator|->
name|output
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|ld
operator|->
name|input
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|s
index|[
name|GRAY_PIX
index|]
index|]
index|]
expr_stmt|;
empty_stmt|;
if|if
condition|(
name|has_alpha
condition|)
name|d
index|[
name|alpha
index|]
operator|=
name|ld
operator|->
name|output
index|[
name|HISTOGRAM_ALPHA
index|]
index|[
name|ld
operator|->
name|input
index|[
name|HISTOGRAM_ALPHA
index|]
index|[
name|s
index|[
name|alpha
index|]
index|]
index|]
expr_stmt|;
comment|/*d[alpha] = s[alpha];*/
name|s
operator|+=
name|srcPR
operator|->
name|bytes
expr_stmt|;
name|d
operator|+=
name|destPR
operator|->
name|bytes
expr_stmt|;
block|}
name|src
operator|+=
name|srcPR
operator|->
name|rowstride
expr_stmt|;
name|dest
operator|+=
name|destPR
operator|->
name|rowstride
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_histogram_info (PixelRegion * srcPR,PixelRegion * maskPR,HistogramValues values,void * user_data)
name|levels_histogram_info
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|maskPR
parameter_list|,
name|HistogramValues
name|values
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|unsigned
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mask
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|value
decl_stmt|,
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|int
name|has_alpha
decl_stmt|,
name|alpha
decl_stmt|;
name|mask
operator|=
name|NULL
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|user_data
expr_stmt|;
name|h
operator|=
name|srcPR
operator|->
name|h
expr_stmt|;
name|src
operator|=
name|srcPR
operator|->
name|data
expr_stmt|;
name|has_alpha
operator|=
operator|(
name|srcPR
operator|->
name|bytes
operator|==
literal|2
operator|||
name|srcPR
operator|->
name|bytes
operator|==
literal|4
operator|)
expr_stmt|;
name|alpha
operator|=
name|has_alpha
condition|?
name|srcPR
operator|->
name|bytes
operator|-
literal|1
else|:
name|srcPR
operator|->
name|bytes
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|mask
operator|=
name|maskPR
operator|->
name|data
expr_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|w
operator|=
name|srcPR
operator|->
name|w
expr_stmt|;
name|s
operator|=
name|src
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|m
operator|=
name|mask
expr_stmt|;
while|while
condition|(
name|w
operator|--
condition|)
block|{
if|if
condition|(
name|ld
operator|->
name|color
condition|)
block|{
name|value
operator|=
name|MAX
argument_list|(
name|s
index|[
name|RED_PIX
index|]
argument_list|,
name|s
index|[
name|GREEN_PIX
index|]
argument_list|)
expr_stmt|;
name|value
operator|=
name|MAX
argument_list|(
name|value
argument_list|,
name|s
index|[
name|BLUE_PIX
index|]
argument_list|)
expr_stmt|;
name|red
operator|=
name|s
index|[
name|RED_PIX
index|]
expr_stmt|;
name|green
operator|=
name|s
index|[
name|GREEN_PIX
index|]
expr_stmt|;
name|blue
operator|=
name|s
index|[
name|BLUE_PIX
index|]
expr_stmt|;
name|alpha
operator|=
name|s
index|[
name|ALPHA_PIX
index|]
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
block|{
name|values
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|value
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_RED
index|]
index|[
name|red
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_GREEN
index|]
index|[
name|green
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_BLUE
index|]
index|[
name|blue
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
block|}
else|else
block|{
name|values
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|value
index|]
operator|+=
literal|1.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_RED
index|]
index|[
name|red
index|]
operator|+=
literal|1.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_GREEN
index|]
index|[
name|green
index|]
operator|+=
literal|1.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_BLUE
index|]
index|[
name|blue
index|]
operator|+=
literal|1.0
expr_stmt|;
block|}
block|}
else|else
block|{
name|value
operator|=
name|s
index|[
name|GRAY_PIX
index|]
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|values
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|value
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
else|else
name|values
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|value
index|]
operator|+=
literal|1.0
expr_stmt|;
block|}
if|if
condition|(
name|has_alpha
condition|)
block|{
if|if
condition|(
name|maskPR
condition|)
name|values
index|[
name|HISTOGRAM_ALPHA
index|]
index|[
name|s
index|[
name|alpha
index|]
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
else|else
name|values
index|[
name|HISTOGRAM_ALPHA
index|]
index|[
name|s
index|[
name|alpha
index|]
index|]
operator|+=
literal|1.0
expr_stmt|;
block|}
name|s
operator|+=
name|srcPR
operator|->
name|bytes
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|m
operator|+=
name|maskPR
operator|->
name|bytes
expr_stmt|;
block|}
name|src
operator|+=
name|srcPR
operator|->
name|rowstride
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|mask
operator|+=
name|maskPR
operator|->
name|rowstride
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_histogram_range (int start,int end,HistogramValues values,void * user_data)
name|levels_histogram_range
parameter_list|(
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|,
name|HistogramValues
name|values
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|user_data
expr_stmt|;
name|histogram_range
argument_list|(
name|ld
operator|->
name|histogram
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  levels action functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|levels_button_press (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|levels_button_press
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gdisp
operator|=
name|gdisp_ptr
expr_stmt|;
name|tool
operator|->
name|drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_button_release (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|levels_button_release
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
DECL|function|levels_motion (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|levels_motion
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
DECL|function|levels_cursor_update (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|levels_cursor_update
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|gdisplay_install_tool_cursor
argument_list|(
name|gdisp
argument_list|,
name|GDK_TOP_LEFT_ARROW
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_control (Tool * tool,int action,gpointer gdisp_ptr)
name|levels_control
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|int
name|action
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|Levels
modifier|*
name|_levels
decl_stmt|;
name|_levels
operator|=
operator|(
name|Levels
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|PAUSE
case|:
break|break;
case|case
name|RESUME
case|:
break|break;
case|case
name|HALT
case|:
if|if
condition|(
name|levels_dialog
condition|)
block|{
name|active_tool
operator|->
name|preserve
operator|=
name|TRUE
expr_stmt|;
name|image_map_abort
argument_list|(
name|levels_dialog
operator|->
name|image_map
argument_list|)
expr_stmt|;
name|active_tool
operator|->
name|preserve
operator|=
name|FALSE
expr_stmt|;
name|levels_dialog
operator|->
name|image_map
operator|=
name|NULL
expr_stmt|;
name|levels_cancel_callback
argument_list|(
name|NULL
argument_list|,
operator|(
name|gpointer
operator|)
name|levels_dialog
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
name|Tool
modifier|*
DECL|function|tools_new_levels ()
name|tools_new_levels
parameter_list|()
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|Levels
modifier|*
name|private
decl_stmt|;
comment|/*  The tool options  */
if|if
condition|(
operator|!
name|levels_options
condition|)
name|levels_options
operator|=
name|tools_register_no_options
argument_list|(
name|LEVELS
argument_list|,
literal|"Levels Options"
argument_list|)
expr_stmt|;
name|tool
operator|=
operator|(
name|Tool
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Tool
argument_list|)
argument_list|)
expr_stmt|;
name|private
operator|=
operator|(
name|Levels
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Levels
argument_list|)
argument_list|)
expr_stmt|;
name|tool
operator|->
name|type
operator|=
name|LEVELS
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
name|tool
operator|->
name|scroll_lock
operator|=
literal|1
expr_stmt|;
comment|/*  Disallow scrolling  */
name|tool
operator|->
name|auto_snap_to
operator|=
name|TRUE
expr_stmt|;
name|tool
operator|->
name|private
operator|=
operator|(
name|void
operator|*
operator|)
name|private
expr_stmt|;
name|tool
operator|->
name|button_press_func
operator|=
name|levels_button_press
expr_stmt|;
name|tool
operator|->
name|button_release_func
operator|=
name|levels_button_release
expr_stmt|;
name|tool
operator|->
name|motion_func
operator|=
name|levels_motion
expr_stmt|;
name|tool
operator|->
name|arrow_keys_func
operator|=
name|standard_arrow_keys_func
expr_stmt|;
name|tool
operator|->
name|cursor_update_func
operator|=
name|levels_cursor_update
expr_stmt|;
name|tool
operator|->
name|control_func
operator|=
name|levels_control
expr_stmt|;
name|tool
operator|->
name|preserve
operator|=
name|FALSE
expr_stmt|;
name|tool
operator|->
name|gdisp_ptr
operator|=
name|NULL
expr_stmt|;
name|tool
operator|->
name|drawable
operator|=
name|NULL
expr_stmt|;
return|return
name|tool
return|;
block|}
end_function

begin_function
name|void
DECL|function|tools_free_levels (Tool * tool)
name|tools_free_levels
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|)
block|{
name|Levels
modifier|*
name|_levels
decl_stmt|;
name|_levels
operator|=
operator|(
name|Levels
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
comment|/*  Close the color select dialog  */
if|if
condition|(
name|levels_dialog
condition|)
name|levels_cancel_callback
argument_list|(
name|NULL
argument_list|,
operator|(
name|gpointer
operator|)
name|levels_dialog
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|_levels
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
DECL|variable|color_option_items
specifier|static
name|MenuItem
name|color_option_items
index|[]
init|=
block|{
block|{
literal|"Value"
block|,
literal|0
block|,
literal|0
block|,
name|levels_value_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"Red"
block|,
literal|0
block|,
literal|0
block|,
name|levels_red_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"Green"
block|,
literal|0
block|,
literal|0
block|,
name|levels_green_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"Blue"
block|,
literal|0
block|,
literal|0
block|,
name|levels_blue_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"Alpha"
block|,
literal|0
block|,
literal|0
block|,
name|levels_alpha_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|levels_initialize (void * gdisp_ptr)
name|levels_initialize
parameter_list|(
name|void
modifier|*
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
if|if
condition|(
name|drawable_indexed
argument_list|(
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Levels for indexed drawables cannot be adjusted."
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*  The levels dialog  */
if|if
condition|(
operator|!
name|levels_dialog
condition|)
name|levels_dialog
operator|=
name|levels_new_dialog
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|GTK_WIDGET_VISIBLE
argument_list|(
name|levels_dialog
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_show
argument_list|(
name|levels_dialog
operator|->
name|shell
argument_list|)
expr_stmt|;
comment|/*  Initialize the values  */
name|levels_dialog
operator|->
name|channel
operator|=
name|HISTOGRAM_VALUE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|levels_dialog
operator|->
name|low_input
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|levels_dialog
operator|->
name|gamma
index|[
name|i
index|]
operator|=
literal|1.0
expr_stmt|;
name|levels_dialog
operator|->
name|high_input
index|[
name|i
index|]
operator|=
literal|255
expr_stmt|;
name|levels_dialog
operator|->
name|low_output
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|levels_dialog
operator|->
name|high_output
index|[
name|i
index|]
operator|=
literal|255
expr_stmt|;
block|}
name|levels_dialog
operator|->
name|drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|levels_dialog
operator|->
name|color
operator|=
name|drawable_color
argument_list|(
name|levels_dialog
operator|->
name|drawable
argument_list|)
expr_stmt|;
name|levels_dialog
operator|->
name|image_map
operator|=
name|image_map_create
argument_list|(
name|gdisp_ptr
argument_list|,
name|levels_dialog
operator|->
name|drawable
argument_list|)
expr_stmt|;
comment|/* check for alpha channel */
if|if
condition|(
name|drawable_has_alpha
argument_list|(
name|levels_dialog
operator|->
name|drawable
argument_list|)
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|color_option_items
index|[
literal|4
index|]
operator|.
name|widget
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
name|gtk_widget_set_sensitive
argument_list|(
name|color_option_items
index|[
literal|4
index|]
operator|.
name|widget
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  hide or show the channel menu based on image type  */
if|if
condition|(
name|levels_dialog
operator|->
name|color
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|gtk_widget_set_sensitive
argument_list|(
name|color_option_items
index|[
name|i
index|]
operator|.
name|widget
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|gtk_widget_set_sensitive
argument_list|(
name|color_option_items
index|[
name|i
index|]
operator|.
name|widget
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* set the current selection */
name|gtk_option_menu_set_history
argument_list|(
name|GTK_OPTION_MENU
argument_list|(
name|levels_dialog
operator|->
name|channel_menu
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|levels_update
argument_list|(
name|levels_dialog
argument_list|,
name|LOW_INPUT
operator||
name|GAMMA
operator||
name|HIGH_INPUT
operator||
name|LOW_OUTPUT
operator||
name|HIGH_OUTPUT
operator||
name|DRAW
argument_list|)
expr_stmt|;
name|levels_update
argument_list|(
name|levels_dialog
argument_list|,
name|INPUT_LEVELS
operator||
name|OUTPUT_LEVELS
argument_list|)
expr_stmt|;
name|histogram_update
argument_list|(
name|levels_dialog
operator|->
name|histogram
argument_list|,
name|levels_dialog
operator|->
name|drawable
argument_list|,
name|levels_histogram_info
argument_list|,
operator|(
name|void
operator|*
operator|)
name|levels_dialog
argument_list|)
expr_stmt|;
name|histogram_range
argument_list|(
name|levels_dialog
operator|->
name|histogram
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|levels_free ()
name|levels_free
parameter_list|()
block|{
if|if
condition|(
name|levels_dialog
condition|)
block|{
if|if
condition|(
name|levels_dialog
operator|->
name|image_map
condition|)
block|{
name|active_tool
operator|->
name|preserve
operator|=
name|TRUE
expr_stmt|;
name|image_map_abort
argument_list|(
name|levels_dialog
operator|->
name|image_map
argument_list|)
expr_stmt|;
name|active_tool
operator|->
name|preserve
operator|=
name|FALSE
expr_stmt|;
name|levels_dialog
operator|->
name|image_map
operator|=
name|NULL
expr_stmt|;
block|}
name|gtk_widget_destroy
argument_list|(
name|levels_dialog
operator|->
name|shell
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  Select by Color dialog  */
end_comment

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  the action area structure  */
end_comment

begin_decl_stmt
DECL|variable|action_items
specifier|static
name|ActionAreaItem
name|action_items
index|[]
init|=
block|{
block|{
literal|"Auto Levels"
block|,
name|levels_auto_levels_callback
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"OK"
block|,
name|levels_ok_callback
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"Cancel"
block|,
name|levels_cancel_callback
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|LevelsDialog
modifier|*
DECL|function|levels_new_dialog ()
name|levels_new_dialog
parameter_list|()
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox2
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle
decl_stmt|;
name|GtkWidget
modifier|*
name|channel_hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|menu
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ld
operator|=
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|LevelsDialog
argument_list|)
argument_list|)
expr_stmt|;
name|ld
operator|->
name|preview
operator|=
name|TRUE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|color_option_items
index|[
name|i
index|]
operator|.
name|user_data
operator|=
operator|(
name|gpointer
operator|)
name|ld
expr_stmt|;
comment|/*  The shell and main vbox  */
name|ld
operator|->
name|shell
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_wmclass
argument_list|(
name|GTK_WINDOW
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
argument_list|,
literal|"levels"
argument_list|,
literal|"Gimp"
argument_list|)
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
argument_list|,
literal|"Levels"
argument_list|)
expr_stmt|;
comment|/* handle the wm close signal */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
argument_list|,
literal|"delete_event"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|levels_delete_callback
argument_list|)
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  The option menu for selecting channels  */
name|channel_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|channel_hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Modify Levels for Channel: "
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|channel_hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|menu
operator|=
name|build_menu
argument_list|(
name|color_option_items
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ld
operator|->
name|channel_menu
operator|=
name|gtk_option_menu_new
argument_list|()
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|channel_hbox
argument_list|)
argument_list|,
name|ld
operator|->
name|channel_menu
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|channel_menu
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|channel_hbox
argument_list|)
expr_stmt|;
name|gtk_option_menu_set_menu
argument_list|(
name|GTK_OPTION_MENU
argument_list|(
name|ld
operator|->
name|channel_menu
argument_list|)
argument_list|,
name|menu
argument_list|)
expr_stmt|;
comment|/*  Horizontal box for levels text widget  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Input Levels: "
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/*  low input text  */
name|ld
operator|->
name|low_input_text
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|low_input_text
argument_list|)
argument_list|,
literal|"0"
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|ld
operator|->
name|low_input_text
argument_list|,
name|TEXT_WIDTH
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|ld
operator|->
name|low_input_text
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|low_input_text
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_low_input_text_update
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|low_input_text
argument_list|)
expr_stmt|;
comment|/* input gamma text  */
name|ld
operator|->
name|gamma_text
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|gamma_text
argument_list|)
argument_list|,
literal|"1.0"
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|ld
operator|->
name|gamma_text
argument_list|,
name|TEXT_WIDTH
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|ld
operator|->
name|gamma_text
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|gamma_text
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_gamma_text_update
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|gamma_text
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/* high input text  */
name|ld
operator|->
name|high_input_text
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|high_input_text
argument_list|)
argument_list|,
literal|"255"
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|ld
operator|->
name|high_input_text
argument_list|,
name|TEXT_WIDTH
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|ld
operator|->
name|high_input_text
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|high_input_text
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_high_input_text_update
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|high_input_text
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*  The levels histogram  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ld
operator|->
name|histogram
operator|=
name|histogram_create
argument_list|(
name|HISTOGRAM_WIDTH
argument_list|,
name|HISTOGRAM_HEIGHT
argument_list|,
name|levels_histogram_range
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ld
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|ld
operator|->
name|histogram
operator|->
name|histogram_widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|histogram
operator|->
name|histogram_widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*  The input levels drawing area  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vbox2
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox2
argument_list|)
expr_stmt|;
name|ld
operator|->
name|input_levels_da
index|[
literal|0
index|]
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_GRAYSCALE
argument_list|)
expr_stmt|;
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|DA_WIDTH
argument_list|,
name|GRADIENT_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|0
index|]
argument_list|,
name|LEVELS_DA_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|0
index|]
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_input_da_events
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|ld
operator|->
name|input_levels_da
index|[
literal|0
index|]
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|DA_WIDTH
argument_list|,
name|CONTROL_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
argument_list|,
name|LEVELS_DA_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_input_da_events
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*  Horizontal box for levels text widget  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Output Levels: "
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/*  low output text  */
name|ld
operator|->
name|low_output_text
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|low_output_text
argument_list|)
argument_list|,
literal|"0"
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|ld
operator|->
name|low_output_text
argument_list|,
name|TEXT_WIDTH
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|ld
operator|->
name|low_output_text
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|low_output_text
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_low_output_text_update
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|low_output_text
argument_list|)
expr_stmt|;
comment|/*  high output text  */
name|ld
operator|->
name|high_output_text
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|high_output_text
argument_list|)
argument_list|,
literal|"255"
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|ld
operator|->
name|high_output_text
argument_list|,
name|TEXT_WIDTH
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|ld
operator|->
name|high_output_text
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|high_output_text
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_high_output_text_update
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|high_output_text
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*  The output levels drawing area  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vbox2
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox2
argument_list|)
expr_stmt|;
name|ld
operator|->
name|output_levels_da
index|[
literal|0
index|]
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_GRAYSCALE
argument_list|)
expr_stmt|;
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|DA_WIDTH
argument_list|,
name|GRADIENT_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|0
index|]
argument_list|,
name|LEVELS_DA_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|0
index|]
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_output_da_events
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|ld
operator|->
name|output_levels_da
index|[
literal|0
index|]
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_GRAYSCALE
argument_list|)
expr_stmt|;
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|DA_WIDTH
argument_list|,
name|CONTROL_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
argument_list|,
name|LEVELS_DA_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_output_da_events
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*  Horizontal box for preview  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  The preview toggle  */
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
literal|"Preview"
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_state
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|ld
operator|->
name|preview
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|levels_preview_update
argument_list|,
name|ld
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*  The action area  */
name|action_items
index|[
literal|0
index|]
operator|.
name|user_data
operator|=
name|ld
expr_stmt|;
name|action_items
index|[
literal|1
index|]
operator|.
name|user_data
operator|=
name|ld
expr_stmt|;
name|action_items
index|[
literal|2
index|]
operator|.
name|user_data
operator|=
name|ld
expr_stmt|;
name|build_action_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
argument_list|,
name|action_items
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
expr_stmt|;
return|return
name|ld
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_draw_slider (GdkWindow * window,GdkGC * border_gc,GdkGC * fill_gc,int xpos)
name|levels_draw_slider
parameter_list|(
name|GdkWindow
modifier|*
name|window
parameter_list|,
name|GdkGC
modifier|*
name|border_gc
parameter_list|,
name|GdkGC
modifier|*
name|fill_gc
parameter_list|,
name|int
name|xpos
parameter_list|)
block|{
name|int
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|CONTROL_HEIGHT
condition|;
name|y
operator|++
control|)
name|gdk_draw_line
argument_list|(
name|window
argument_list|,
name|fill_gc
argument_list|,
name|xpos
operator|-
name|y
operator|/
literal|2
argument_list|,
name|y
argument_list|,
name|xpos
operator|+
name|y
operator|/
literal|2
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|window
argument_list|,
name|border_gc
argument_list|,
name|xpos
argument_list|,
literal|0
argument_list|,
name|xpos
operator|-
operator|(
name|CONTROL_HEIGHT
operator|-
literal|1
operator|)
operator|/
literal|2
argument_list|,
name|CONTROL_HEIGHT
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|window
argument_list|,
name|border_gc
argument_list|,
name|xpos
argument_list|,
literal|0
argument_list|,
name|xpos
operator|+
operator|(
name|CONTROL_HEIGHT
operator|-
literal|1
operator|)
operator|/
literal|2
argument_list|,
name|CONTROL_HEIGHT
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|window
argument_list|,
name|border_gc
argument_list|,
name|xpos
operator|-
operator|(
name|CONTROL_HEIGHT
operator|-
literal|1
operator|)
operator|/
literal|2
argument_list|,
name|CONTROL_HEIGHT
operator|-
literal|1
argument_list|,
name|xpos
operator|+
operator|(
name|CONTROL_HEIGHT
operator|-
literal|1
operator|)
operator|/
literal|2
argument_list|,
name|CONTROL_HEIGHT
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_erase_slider (GdkWindow * window,int xpos)
name|levels_erase_slider
parameter_list|(
name|GdkWindow
modifier|*
name|window
parameter_list|,
name|int
name|xpos
parameter_list|)
block|{
name|gdk_window_clear_area
argument_list|(
name|window
argument_list|,
name|xpos
operator|-
operator|(
name|CONTROL_HEIGHT
operator|-
literal|1
operator|)
operator|/
literal|2
argument_list|,
literal|0
argument_list|,
name|CONTROL_HEIGHT
operator|-
literal|1
argument_list|,
name|CONTROL_HEIGHT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_calculate_transfers (LevelsDialog * ld)
name|levels_calculate_transfers
parameter_list|(
name|LevelsDialog
modifier|*
name|ld
parameter_list|)
block|{
name|double
name|inten
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/*  Recalculate the levels arrays  */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|5
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
comment|/*  determine input intensity  */
if|if
condition|(
name|ld
operator|->
name|high_input
index|[
name|j
index|]
operator|!=
name|ld
operator|->
name|low_input
index|[
name|j
index|]
condition|)
name|inten
operator|=
call|(
name|double
call|)
argument_list|(
name|i
operator|-
name|ld
operator|->
name|low_input
index|[
name|j
index|]
argument_list|)
operator|/
call|(
name|double
call|)
argument_list|(
name|ld
operator|->
name|high_input
index|[
name|j
index|]
operator|-
name|ld
operator|->
name|low_input
index|[
name|j
index|]
argument_list|)
expr_stmt|;
else|else
name|inten
operator|=
call|(
name|double
call|)
argument_list|(
name|i
operator|-
name|ld
operator|->
name|low_input
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|inten
operator|=
name|BOUNDS
argument_list|(
name|inten
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|gamma
index|[
name|j
index|]
operator|!=
literal|0.0
condition|)
name|inten
operator|=
name|pow
argument_list|(
name|inten
argument_list|,
operator|(
literal|1.0
operator|/
name|ld
operator|->
name|gamma
index|[
name|j
index|]
operator|)
argument_list|)
expr_stmt|;
name|ld
operator|->
name|input
index|[
name|j
index|]
index|[
name|i
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|inten
operator|*
literal|255.0
operator|+
literal|0.5
argument_list|)
expr_stmt|;
comment|/*  determine the output intensity  */
name|inten
operator|=
operator|(
name|double
operator|)
name|i
operator|/
literal|255.0
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|high_output
index|[
name|j
index|]
operator|>=
name|ld
operator|->
name|low_output
index|[
name|j
index|]
condition|)
name|inten
operator|=
call|(
name|double
call|)
argument_list|(
name|inten
operator|*
operator|(
name|ld
operator|->
name|high_output
index|[
name|j
index|]
operator|-
name|ld
operator|->
name|low_output
index|[
name|j
index|]
operator|)
operator|+
name|ld
operator|->
name|low_output
index|[
name|j
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ld
operator|->
name|high_output
index|[
name|j
index|]
operator|<
name|ld
operator|->
name|low_output
index|[
name|j
index|]
condition|)
name|inten
operator|=
call|(
name|double
call|)
argument_list|(
name|ld
operator|->
name|low_output
index|[
name|j
index|]
operator|-
name|inten
operator|*
operator|(
name|ld
operator|->
name|low_output
index|[
name|j
index|]
operator|-
name|ld
operator|->
name|high_output
index|[
name|j
index|]
operator|)
argument_list|)
expr_stmt|;
name|inten
operator|=
name|BOUNDS
argument_list|(
name|inten
argument_list|,
literal|0.0
argument_list|,
literal|255.0
argument_list|)
expr_stmt|;
name|ld
operator|->
name|output
index|[
name|j
index|]
index|[
name|i
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|inten
operator|+
literal|0.5
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_update (LevelsDialog * ld,int update)
name|levels_update
parameter_list|(
name|LevelsDialog
modifier|*
name|ld
parameter_list|,
name|int
name|update
parameter_list|)
block|{
name|char
name|text
index|[
literal|12
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/*  Recalculate the transfer arrays  */
name|levels_calculate_transfers
argument_list|(
name|ld
argument_list|)
expr_stmt|;
if|if
condition|(
name|update
operator|&
name|LOW_INPUT
condition|)
block|{
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%d"
argument_list|,
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|low_input_text
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&
name|GAMMA
condition|)
block|{
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%2.2f"
argument_list|,
name|ld
operator|->
name|gamma
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|gamma_text
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&
name|HIGH_INPUT
condition|)
block|{
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%d"
argument_list|,
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|high_input_text
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&
name|LOW_OUTPUT
condition|)
block|{
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%d"
argument_list|,
name|ld
operator|->
name|low_output
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|low_output_text
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&
name|HIGH_OUTPUT
condition|)
block|{
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%d"
argument_list|,
name|ld
operator|->
name|high_output
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|ld
operator|->
name|high_output_text
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&
name|INPUT_LEVELS
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GRADIENT_HEIGHT
condition|;
name|i
operator|++
control|)
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|ld
operator|->
name|input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|DA_WIDTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|update
operator|&
name|DRAW
condition|)
name|gtk_widget_draw
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&
name|OUTPUT_LEVELS
condition|)
block|{
name|unsigned
name|char
name|buf
index|[
name|DA_WIDTH
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DA_WIDTH
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GRADIENT_HEIGHT
condition|;
name|i
operator|++
control|)
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|DA_WIDTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|update
operator|&
name|DRAW
condition|)
name|gtk_widget_draw
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&
name|INPUT_SLIDERS
condition|)
block|{
name|double
name|width
decl_stmt|,
name|mid
decl_stmt|,
name|tmp
decl_stmt|;
name|levels_erase_slider
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|levels_erase_slider
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|levels_erase_slider
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ld
operator|->
name|slider_pos
index|[
literal|0
index|]
operator|=
name|DA_WIDTH
operator|*
operator|(
operator|(
name|double
operator|)
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
operator|/
literal|255.0
operator|)
expr_stmt|;
name|ld
operator|->
name|slider_pos
index|[
literal|2
index|]
operator|=
name|DA_WIDTH
operator|*
operator|(
operator|(
name|double
operator|)
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
operator|/
literal|255.0
operator|)
expr_stmt|;
name|width
operator|=
call|(
name|double
call|)
argument_list|(
name|ld
operator|->
name|slider_pos
index|[
literal|2
index|]
operator|-
name|ld
operator|->
name|slider_pos
index|[
literal|0
index|]
argument_list|)
operator|/
literal|2.0
expr_stmt|;
name|mid
operator|=
name|ld
operator|->
name|slider_pos
index|[
literal|0
index|]
operator|+
name|width
expr_stmt|;
name|tmp
operator|=
name|log10
argument_list|(
literal|1.0
operator|/
name|ld
operator|->
name|gamma
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
name|ld
operator|->
name|slider_pos
index|[
literal|1
index|]
operator|=
call|(
name|int
call|)
argument_list|(
name|mid
operator|+
name|width
operator|*
name|tmp
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|levels_draw_slider
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|dark_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|levels_draw_slider
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|levels_draw_slider
argument_list|(
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|white_gc
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|update
operator|&
name|OUTPUT_SLIDERS
condition|)
block|{
name|levels_erase_slider
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|levels_erase_slider
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|ld
operator|->
name|slider_pos
index|[
literal|3
index|]
operator|=
name|DA_WIDTH
operator|*
operator|(
operator|(
name|double
operator|)
name|ld
operator|->
name|low_output
index|[
name|ld
operator|->
name|channel
index|]
operator|/
literal|255.0
operator|)
expr_stmt|;
name|ld
operator|->
name|slider_pos
index|[
literal|4
index|]
operator|=
name|DA_WIDTH
operator|*
operator|(
operator|(
name|double
operator|)
name|ld
operator|->
name|high_output
index|[
name|ld
operator|->
name|channel
index|]
operator|/
literal|255.0
operator|)
expr_stmt|;
name|levels_draw_slider
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|levels_draw_slider
argument_list|(
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|->
name|window
argument_list|,
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
operator|->
name|style
operator|->
name|white_gc
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_preview (LevelsDialog * ld)
name|levels_preview
parameter_list|(
name|LevelsDialog
modifier|*
name|ld
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ld
operator|->
name|image_map
condition|)
name|g_warning
argument_list|(
literal|"No image map"
argument_list|)
expr_stmt|;
name|active_tool
operator|->
name|preserve
operator|=
name|TRUE
expr_stmt|;
name|image_map_apply
argument_list|(
name|ld
operator|->
name|image_map
argument_list|,
name|levels
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ld
argument_list|)
expr_stmt|;
name|active_tool
operator|->
name|preserve
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_value_callback (GtkWidget * w,gpointer client_data)
name|levels_value_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|channel
operator|!=
name|HISTOGRAM_VALUE
condition|)
block|{
name|ld
operator|->
name|channel
operator|=
name|HISTOGRAM_VALUE
expr_stmt|;
name|histogram_channel
argument_list|(
name|ld
operator|->
name|histogram
argument_list|,
name|ld
operator|->
name|channel
argument_list|)
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|ALL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_red_callback (GtkWidget * w,gpointer client_data)
name|levels_red_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|channel
operator|!=
name|HISTOGRAM_RED
condition|)
block|{
name|ld
operator|->
name|channel
operator|=
name|HISTOGRAM_RED
expr_stmt|;
name|histogram_channel
argument_list|(
name|ld
operator|->
name|histogram
argument_list|,
name|ld
operator|->
name|channel
argument_list|)
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|ALL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_green_callback (GtkWidget * w,gpointer client_data)
name|levels_green_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|channel
operator|!=
name|HISTOGRAM_GREEN
condition|)
block|{
name|ld
operator|->
name|channel
operator|=
name|HISTOGRAM_GREEN
expr_stmt|;
name|histogram_channel
argument_list|(
name|ld
operator|->
name|histogram
argument_list|,
name|ld
operator|->
name|channel
argument_list|)
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|ALL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_blue_callback (GtkWidget * w,gpointer client_data)
name|levels_blue_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|channel
operator|!=
name|HISTOGRAM_BLUE
condition|)
block|{
name|ld
operator|->
name|channel
operator|=
name|HISTOGRAM_BLUE
expr_stmt|;
name|histogram_channel
argument_list|(
name|ld
operator|->
name|histogram
argument_list|,
name|ld
operator|->
name|channel
argument_list|)
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|ALL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_alpha_callback (GtkWidget * w,gpointer client_data)
name|levels_alpha_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|channel
operator|!=
name|HISTOGRAM_ALPHA
condition|)
block|{
name|ld
operator|->
name|channel
operator|=
name|HISTOGRAM_ALPHA
expr_stmt|;
name|histogram_channel
argument_list|(
name|ld
operator|->
name|histogram
argument_list|,
name|ld
operator|->
name|channel
argument_list|)
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|ALL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_adjust_channel (LevelsDialog * ld,HistogramValues * values,int channel)
name|levels_adjust_channel
parameter_list|(
name|LevelsDialog
modifier|*
name|ld
parameter_list|,
name|HistogramValues
modifier|*
name|values
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|double
name|count
decl_stmt|,
name|new_count
decl_stmt|,
name|percentage
decl_stmt|,
name|next_percentage
decl_stmt|;
name|ld
operator|->
name|gamma
index|[
name|channel
index|]
operator|=
literal|1.0
expr_stmt|;
name|ld
operator|->
name|low_output
index|[
name|channel
index|]
operator|=
literal|0
expr_stmt|;
name|ld
operator|->
name|high_output
index|[
name|channel
index|]
operator|=
literal|255
expr_stmt|;
name|count
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|count
operator|+=
operator|(
operator|*
name|values
operator|)
index|[
name|channel
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0.0
condition|)
block|{
name|ld
operator|->
name|low_input
index|[
name|channel
index|]
operator|=
literal|0
expr_stmt|;
name|ld
operator|->
name|high_input
index|[
name|channel
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/*  Set the low input  */
name|new_count
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|255
condition|;
name|i
operator|++
control|)
block|{
name|new_count
operator|+=
operator|(
operator|*
name|values
operator|)
index|[
name|channel
index|]
index|[
name|i
index|]
expr_stmt|;
name|percentage
operator|=
name|new_count
operator|/
name|count
expr_stmt|;
name|next_percentage
operator|=
operator|(
name|new_count
operator|+
operator|(
operator|*
name|values
operator|)
index|[
name|channel
index|]
index|[
name|i
operator|+
literal|1
index|]
operator|)
operator|/
name|count
expr_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|percentage
operator|-
literal|0.006
argument_list|)
operator|<
name|fabs
argument_list|(
name|next_percentage
operator|-
literal|0.006
argument_list|)
condition|)
block|{
name|ld
operator|->
name|low_input
index|[
name|channel
index|]
operator|=
name|i
operator|+
literal|1
expr_stmt|;
break|break;
block|}
block|}
comment|/*  Set the high input  */
name|new_count
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|255
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|new_count
operator|+=
operator|(
operator|*
name|values
operator|)
index|[
name|channel
index|]
index|[
name|i
index|]
expr_stmt|;
name|percentage
operator|=
name|new_count
operator|/
name|count
expr_stmt|;
name|next_percentage
operator|=
operator|(
name|new_count
operator|+
operator|(
operator|*
name|values
operator|)
index|[
name|channel
index|]
index|[
name|i
operator|-
literal|1
index|]
operator|)
operator|/
name|count
expr_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|percentage
operator|-
literal|0.006
argument_list|)
operator|<
name|fabs
argument_list|(
name|next_percentage
operator|-
literal|0.006
argument_list|)
condition|)
block|{
name|ld
operator|->
name|high_input
index|[
name|channel
index|]
operator|=
name|i
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_auto_levels_callback (GtkWidget * widget,gpointer client_data)
name|levels_auto_levels_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|HistogramValues
modifier|*
name|values
decl_stmt|;
name|int
name|channel
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|client_data
expr_stmt|;
name|values
operator|=
name|histogram_values
argument_list|(
name|ld
operator|->
name|histogram
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|color
condition|)
block|{
comment|/*  Set the overall value to defaults  */
name|ld
operator|->
name|low_input
index|[
name|HISTOGRAM_VALUE
index|]
operator|=
literal|0
expr_stmt|;
name|ld
operator|->
name|gamma
index|[
name|HISTOGRAM_VALUE
index|]
operator|=
literal|1.0
expr_stmt|;
name|ld
operator|->
name|high_input
index|[
name|HISTOGRAM_VALUE
index|]
operator|=
literal|255
expr_stmt|;
name|ld
operator|->
name|low_output
index|[
name|HISTOGRAM_VALUE
index|]
operator|=
literal|0
expr_stmt|;
name|ld
operator|->
name|high_output
index|[
name|HISTOGRAM_VALUE
index|]
operator|=
literal|255
expr_stmt|;
for|for
control|(
name|channel
operator|=
literal|0
init|;
name|channel
operator|<
literal|3
condition|;
name|channel
operator|++
control|)
name|levels_adjust_channel
argument_list|(
name|ld
argument_list|,
name|values
argument_list|,
name|channel
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|levels_adjust_channel
argument_list|(
name|ld
argument_list|,
name|values
argument_list|,
name|HISTOGRAM_VALUE
argument_list|)
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|ALL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|preview
condition|)
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_ok_callback (GtkWidget * widget,gpointer client_data)
name|levels_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_hide
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
expr_stmt|;
name|active_tool
operator|->
name|preserve
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|ld
operator|->
name|preview
condition|)
name|image_map_apply
argument_list|(
name|ld
operator|->
name|image_map
argument_list|,
name|levels
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ld
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|image_map
condition|)
name|image_map_commit
argument_list|(
name|ld
operator|->
name|image_map
argument_list|)
expr_stmt|;
name|active_tool
operator|->
name|preserve
operator|=
name|FALSE
expr_stmt|;
name|ld
operator|->
name|image_map
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|levels_delete_callback (GtkWidget * w,GdkEvent * e,gpointer client_data)
name|levels_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|GdkEvent
modifier|*
name|e
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|levels_cancel_callback
argument_list|(
name|w
argument_list|,
name|client_data
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_cancel_callback (GtkWidget * widget,gpointer client_data)
name|levels_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_hide
argument_list|(
name|ld
operator|->
name|shell
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|image_map
condition|)
block|{
name|active_tool
operator|->
name|preserve
operator|=
name|TRUE
expr_stmt|;
name|image_map_abort
argument_list|(
name|ld
operator|->
name|image_map
argument_list|)
expr_stmt|;
name|active_tool
operator|->
name|preserve
operator|=
name|TRUE
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
name|ld
operator|->
name|image_map
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_preview_update (GtkWidget * w,gpointer data)
name|levels_preview_update
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|w
argument_list|)
operator|->
name|active
condition|)
block|{
name|ld
operator|->
name|preview
operator|=
name|TRUE
expr_stmt|;
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
block|}
else|else
name|ld
operator|->
name|preview
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_low_input_text_update (GtkWidget * w,gpointer data)
name|levels_low_input_text_update
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|value
decl_stmt|;
name|str
operator|=
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|)
expr_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|data
expr_stmt|;
name|value
operator|=
name|BOUNDS
argument_list|(
operator|(
operator|(
name|int
operator|)
name|atof
argument_list|(
name|str
argument_list|)
operator|)
argument_list|,
literal|0
argument_list|,
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
condition|)
block|{
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|value
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|INPUT_LEVELS
operator||
name|INPUT_SLIDERS
operator||
name|DRAW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|preview
condition|)
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_gamma_text_update (GtkWidget * w,gpointer data)
name|levels_gamma_text_update
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|double
name|value
decl_stmt|;
name|str
operator|=
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|)
expr_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|data
expr_stmt|;
name|value
operator|=
name|BOUNDS
argument_list|(
operator|(
name|atof
argument_list|(
name|str
argument_list|)
operator|)
argument_list|,
literal|0.1
argument_list|,
literal|10.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|ld
operator|->
name|gamma
index|[
name|ld
operator|->
name|channel
index|]
condition|)
block|{
name|ld
operator|->
name|gamma
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|value
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|INPUT_LEVELS
operator||
name|INPUT_SLIDERS
operator||
name|DRAW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|preview
condition|)
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_high_input_text_update (GtkWidget * w,gpointer data)
name|levels_high_input_text_update
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|value
decl_stmt|;
name|str
operator|=
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|)
expr_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|data
expr_stmt|;
name|value
operator|=
name|BOUNDS
argument_list|(
operator|(
operator|(
name|int
operator|)
name|atof
argument_list|(
name|str
argument_list|)
operator|)
argument_list|,
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|,
literal|255
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
condition|)
block|{
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|value
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|INPUT_LEVELS
operator||
name|INPUT_SLIDERS
operator||
name|DRAW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|preview
condition|)
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_low_output_text_update (GtkWidget * w,gpointer data)
name|levels_low_output_text_update
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|value
decl_stmt|;
name|str
operator|=
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|)
expr_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|data
expr_stmt|;
name|value
operator|=
name|BOUNDS
argument_list|(
operator|(
operator|(
name|int
operator|)
name|atof
argument_list|(
name|str
argument_list|)
operator|)
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|ld
operator|->
name|low_output
index|[
name|ld
operator|->
name|channel
index|]
condition|)
block|{
name|ld
operator|->
name|low_output
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|value
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|OUTPUT_LEVELS
operator||
name|OUTPUT_SLIDERS
operator||
name|DRAW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|preview
condition|)
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|levels_high_output_text_update (GtkWidget * w,gpointer data)
name|levels_high_output_text_update
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LevelsDialog
modifier|*
name|ld
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|value
decl_stmt|;
name|str
operator|=
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|)
expr_stmt|;
name|ld
operator|=
operator|(
name|LevelsDialog
operator|*
operator|)
name|data
expr_stmt|;
name|value
operator|=
name|BOUNDS
argument_list|(
operator|(
operator|(
name|int
operator|)
name|atof
argument_list|(
name|str
argument_list|)
operator|)
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|ld
operator|->
name|high_output
index|[
name|ld
operator|->
name|channel
index|]
condition|)
block|{
name|ld
operator|->
name|high_output
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|value
expr_stmt|;
name|levels_update
argument_list|(
name|ld
argument_list|,
name|OUTPUT_LEVELS
operator||
name|OUTPUT_SLIDERS
operator||
name|DRAW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ld
operator|->
name|preview
condition|)
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|levels_input_da_events (GtkWidget * widget,GdkEvent * event,LevelsDialog * ld)
name|levels_input_da_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|LevelsDialog
modifier|*
name|ld
parameter_list|)
block|{
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
name|GdkEventMotion
modifier|*
name|mevent
decl_stmt|;
name|char
name|text
index|[
literal|12
index|]
decl_stmt|;
name|double
name|width
decl_stmt|,
name|mid
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|distance
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|update
init|=
name|FALSE
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_EXPOSE
case|:
if|if
condition|(
name|widget
operator|==
name|ld
operator|->
name|input_levels_da
index|[
literal|1
index|]
condition|)
name|levels_update
argument_list|(
name|ld
argument_list|,
name|INPUT_SLIDERS
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_BUTTON_PRESS
case|:
name|gtk_grab_add
argument_list|(
name|widget
argument_list|)
expr_stmt|;
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
name|distance
operator|=
name|G_MAXINT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|fabs
argument_list|(
name|bevent
operator|->
name|x
operator|-
name|ld
operator|->
name|slider_pos
index|[
name|i
index|]
argument_list|)
operator|<
name|distance
condition|)
block|{
name|ld
operator|->
name|active_slider
operator|=
name|i
expr_stmt|;
name|distance
operator|=
name|fabs
argument_list|(
name|bevent
operator|->
name|x
operator|-
name|ld
operator|->
name|slider_pos
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|x
operator|=
name|bevent
operator|->
name|x
expr_stmt|;
name|update
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|GDK_BUTTON_RELEASE
case|:
name|gtk_grab_remove
argument_list|(
name|widget
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ld
operator|->
name|active_slider
condition|)
block|{
case|case
literal|0
case|:
comment|/*  low input  */
name|levels_update
argument_list|(
name|ld
argument_list|,
name|LOW_INPUT
operator||
name|GAMMA
operator||
name|DRAW
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/*  gamma  */
name|levels_update
argument_list|(
name|ld
argument_list|,
name|GAMMA
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/*  high input  */
name|levels_update
argument_list|(
name|ld
argument_list|,
name|HIGH_INPUT
operator||
name|GAMMA
operator||
name|DRAW
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ld
operator|->
name|preview
condition|)
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_MOTION_NOTIFY
case|:
name|mevent
operator|=
operator|(
name|GdkEventMotion
operator|*
operator|)
name|event
expr_stmt|;
name|gdk_window_get_pointer
argument_list|(
name|widget
operator|->
name|window
argument_list|,
operator|&
name|x
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|update
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|update
condition|)
block|{
switch|switch
condition|(
name|ld
operator|->
name|active_slider
condition|)
block|{
case|case
literal|0
case|:
comment|/*  low input  */
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
operator|=
operator|(
operator|(
name|double
operator|)
name|x
operator|/
operator|(
name|double
operator|)
name|DA_WIDTH
operator|)
operator|*
literal|255.0
expr_stmt|;
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|BOUNDS
argument_list|(
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|,
literal|0
argument_list|,
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/*  gamma  */
name|width
operator|=
call|(
name|double
call|)
argument_list|(
name|ld
operator|->
name|slider_pos
index|[
literal|2
index|]
operator|-
name|ld
operator|->
name|slider_pos
index|[
literal|0
index|]
argument_list|)
operator|/
literal|2.0
expr_stmt|;
name|mid
operator|=
name|ld
operator|->
name|slider_pos
index|[
literal|0
index|]
operator|+
name|width
expr_stmt|;
name|x
operator|=
name|BOUNDS
argument_list|(
name|x
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|0
index|]
argument_list|,
name|ld
operator|->
name|slider_pos
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|tmp
operator|=
call|(
name|double
call|)
argument_list|(
name|x
operator|-
name|mid
argument_list|)
operator|/
name|width
expr_stmt|;
name|ld
operator|->
name|gamma
index|[
name|ld
operator|->
name|channel
index|]
operator|=
literal|1.0
operator|/
name|pow
argument_list|(
literal|10
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/*  round the gamma value to the nearest 1/100th  */
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%2.2f"
argument_list|,
name|ld
operator|->
name|gamma
index|[
name|ld
operator|->
name|channel
index|]
argument_list|)
expr_stmt|;
name|ld
operator|->
name|gamma
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|atof
argument_list|(
name|text
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/*  high input  */
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
operator|=
operator|(
operator|(
name|double
operator|)
name|x
operator|/
operator|(
name|double
operator|)
name|DA_WIDTH
operator|)
operator|*
literal|255.0
expr_stmt|;
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|BOUNDS
argument_list|(
name|ld
operator|->
name|high_input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|,
name|ld
operator|->
name|low_input
index|[
name|ld
operator|->
name|channel
index|]
argument_list|,
literal|255
argument_list|)
expr_stmt|;
break|break;
block|}
name|levels_update
argument_list|(
name|ld
argument_list|,
name|INPUT_SLIDERS
operator||
name|INPUT_LEVELS
operator||
name|DRAW
argument_list|)
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|levels_output_da_events (GtkWidget * widget,GdkEvent * event,LevelsDialog * ld)
name|levels_output_da_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|LevelsDialog
modifier|*
name|ld
parameter_list|)
block|{
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
name|GdkEventMotion
modifier|*
name|mevent
decl_stmt|;
name|int
name|x
decl_stmt|,
name|distance
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|update
init|=
name|FALSE
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_EXPOSE
case|:
if|if
condition|(
name|widget
operator|==
name|ld
operator|->
name|output_levels_da
index|[
literal|1
index|]
condition|)
name|levels_update
argument_list|(
name|ld
argument_list|,
name|OUTPUT_SLIDERS
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_BUTTON_PRESS
case|:
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
name|distance
operator|=
name|G_MAXINT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|fabs
argument_list|(
name|bevent
operator|->
name|x
operator|-
name|ld
operator|->
name|slider_pos
index|[
name|i
index|]
argument_list|)
operator|<
name|distance
condition|)
block|{
name|ld
operator|->
name|active_slider
operator|=
name|i
expr_stmt|;
name|distance
operator|=
name|fabs
argument_list|(
name|bevent
operator|->
name|x
operator|-
name|ld
operator|->
name|slider_pos
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|x
operator|=
name|bevent
operator|->
name|x
expr_stmt|;
name|update
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|GDK_BUTTON_RELEASE
case|:
switch|switch
condition|(
name|ld
operator|->
name|active_slider
condition|)
block|{
case|case
literal|3
case|:
comment|/*  low output  */
name|levels_update
argument_list|(
name|ld
argument_list|,
name|LOW_OUTPUT
operator||
name|DRAW
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/*  high output  */
name|levels_update
argument_list|(
name|ld
argument_list|,
name|HIGH_OUTPUT
operator||
name|DRAW
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ld
operator|->
name|preview
condition|)
name|levels_preview
argument_list|(
name|ld
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_MOTION_NOTIFY
case|:
name|mevent
operator|=
operator|(
name|GdkEventMotion
operator|*
operator|)
name|event
expr_stmt|;
name|gdk_window_get_pointer
argument_list|(
name|widget
operator|->
name|window
argument_list|,
operator|&
name|x
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|update
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|update
condition|)
block|{
switch|switch
condition|(
name|ld
operator|->
name|active_slider
condition|)
block|{
case|case
literal|3
case|:
comment|/*  low output  */
name|ld
operator|->
name|low_output
index|[
name|ld
operator|->
name|channel
index|]
operator|=
operator|(
operator|(
name|double
operator|)
name|x
operator|/
operator|(
name|double
operator|)
name|DA_WIDTH
operator|)
operator|*
literal|255.0
expr_stmt|;
name|ld
operator|->
name|low_output
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|BOUNDS
argument_list|(
name|ld
operator|->
name|low_output
index|[
name|ld
operator|->
name|channel
index|]
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/*  high output  */
name|ld
operator|->
name|high_output
index|[
name|ld
operator|->
name|channel
index|]
operator|=
operator|(
operator|(
name|double
operator|)
name|x
operator|/
operator|(
name|double
operator|)
name|DA_WIDTH
operator|)
operator|*
literal|255.0
expr_stmt|;
name|ld
operator|->
name|high_output
index|[
name|ld
operator|->
name|channel
index|]
operator|=
name|BOUNDS
argument_list|(
name|ld
operator|->
name|high_output
index|[
name|ld
operator|->
name|channel
index|]
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
break|break;
block|}
name|levels_update
argument_list|(
name|ld
argument_list|,
name|OUTPUT_SLIDERS
operator||
name|DRAW
argument_list|)
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/*  The levels procedure definition  */
end_comment

begin_decl_stmt
DECL|variable|levels_args
name|ProcArg
name|levels_args
index|[]
init|=
block|{
block|{
name|PDB_IMAGE
block|,
literal|"image"
block|,
literal|"the image"
block|}
block|,
block|{
name|PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"the drawable"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"channel"
block|,
literal|"the channel to modify: { VALUE (0), RED (1), GREEN (2), BLUE (3), GRAY (0) }"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"low_input"
block|,
literal|"intensity of lowest input: (0<= low_input<= 255)"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"high_input"
block|,
literal|"intensity of highest input: (0<= high_input<= 255)"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"gamma"
block|,
literal|"gamma correction factor: (0.1<= gamma<= 10)"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"low_output"
block|,
literal|"intensity of lowest output: (0<= low_input<= 255)"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"high_output"
block|,
literal|"intensity of highest output: (0<= high_input<= 255)"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|levels_proc
name|ProcRecord
name|levels_proc
init|=
block|{
literal|"gimp_levels"
block|,
literal|"Modifies intensity levels in the specified drawable"
block|,
literal|"This tool allows intensity levels in the specified drawable to be remapped according to a set of parameters.  The low/high input levels specify an initial mapping from the source intensities.  The gamma value determines how intensities between the low and high input intensities are interpolated.  A gamma value of 1.0 results in a linear interpolation.  Higher gamma values result in more high-level intensities.  Lower gamma values result in more low-level intensities.  The low/high output levels constrain the final intensity mapping--that is, no final intensity will be lower than the low output level and no final intensity will be higher than the high output level.  This tool is only valid on RGB color and grayscale images.  It will not operate on indexed drawables."
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1995-1996"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|8
block|,
name|levels_args
block|,
comment|/*  Output arguments  */
literal|0
block|,
name|NULL
block|,
comment|/*  Exec method  */
block|{
block|{
name|levels_invoker
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|levels_invoker (Argument * args)
name|levels_invoker
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|PixelRegion
name|srcPR
decl_stmt|,
name|destPR
decl_stmt|;
name|int
name|success
init|=
name|TRUE
decl_stmt|;
name|LevelsDialog
name|ld
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|int
name|channel
decl_stmt|;
name|int
name|low_input
decl_stmt|;
name|int
name|high_input
decl_stmt|;
name|double
name|gamma
decl_stmt|;
name|int
name|low_output
decl_stmt|;
name|int
name|high_output
decl_stmt|;
name|int
name|int_value
decl_stmt|;
name|double
name|fp_value
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|int
name|i
decl_stmt|;
name|void
modifier|*
name|pr
decl_stmt|;
name|drawable
operator|=
name|NULL
expr_stmt|;
name|low_input
operator|=
literal|0
expr_stmt|;
name|high_input
operator|=
literal|0
expr_stmt|;
name|gamma
operator|=
literal|1.0
expr_stmt|;
name|low_output
operator|=
literal|0
expr_stmt|;
name|high_output
operator|=
literal|0
expr_stmt|;
comment|/*  the gimage  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|gimage_get_ID
argument_list|(
name|int_value
argument_list|)
operator|)
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  the drawable  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|drawable
operator|=
name|drawable_get_ID
argument_list|(
name|int_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|drawable
operator|==
name|NULL
operator|||
name|gimage
operator|!=
name|drawable_gimage
argument_list|(
name|drawable
argument_list|)
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  make sure the drawable is not indexed color  */
if|if
condition|(
name|success
condition|)
name|success
operator|=
operator|!
name|drawable_indexed
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
comment|/*  channel  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|success
condition|)
block|{
if|if
condition|(
name|drawable_gray
argument_list|(
name|drawable
argument_list|)
condition|)
block|{
if|if
condition|(
name|int_value
operator|!=
literal|0
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drawable_color
argument_list|(
name|drawable
argument_list|)
condition|)
block|{
if|if
condition|(
name|int_value
operator|<
literal|0
operator|||
name|int_value
operator|>
literal|3
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
name|channel
operator|=
name|int_value
expr_stmt|;
block|}
comment|/*  low input  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|int_value
operator|>=
literal|0
operator|&&
name|int_value
operator|<
literal|256
condition|)
name|low_input
operator|=
name|int_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  high input  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|4
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|int_value
operator|>=
literal|0
operator|&&
name|int_value
operator|<
literal|256
condition|)
name|high_input
operator|=
name|int_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  gamma  */
if|if
condition|(
name|success
condition|)
block|{
name|fp_value
operator|=
name|args
index|[
literal|5
index|]
operator|.
name|value
operator|.
name|pdb_float
expr_stmt|;
if|if
condition|(
name|fp_value
operator|>=
literal|0.1
operator|&&
name|fp_value
operator|<=
literal|10.0
condition|)
name|gamma
operator|=
name|fp_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  low output  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|6
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|int_value
operator|>=
literal|0
operator|&&
name|int_value
operator|<
literal|256
condition|)
name|low_output
operator|=
name|int_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  high output  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|7
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|int_value
operator|>=
literal|0
operator|&&
name|int_value
operator|<
literal|256
condition|)
name|high_output
operator|=
name|int_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  arrange to modify the levels  */
if|if
condition|(
name|success
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|ld
operator|.
name|low_input
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|ld
operator|.
name|gamma
index|[
name|i
index|]
operator|=
literal|1.0
expr_stmt|;
name|ld
operator|.
name|high_input
index|[
name|i
index|]
operator|=
literal|255
expr_stmt|;
name|ld
operator|.
name|low_output
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|ld
operator|.
name|high_output
index|[
name|i
index|]
operator|=
literal|255
expr_stmt|;
block|}
name|ld
operator|.
name|channel
operator|=
name|channel
expr_stmt|;
name|ld
operator|.
name|color
operator|=
name|drawable_color
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|ld
operator|.
name|low_input
index|[
name|channel
index|]
operator|=
name|low_input
expr_stmt|;
name|ld
operator|.
name|high_input
index|[
name|channel
index|]
operator|=
name|high_input
expr_stmt|;
name|ld
operator|.
name|gamma
index|[
name|channel
index|]
operator|=
name|gamma
expr_stmt|;
name|ld
operator|.
name|low_output
index|[
name|channel
index|]
operator|=
name|low_output
expr_stmt|;
name|ld
operator|.
name|high_output
index|[
name|channel
index|]
operator|=
name|high_output
expr_stmt|;
comment|/*  calculate the transfer arrays  */
name|levels_calculate_transfers
argument_list|(
operator|&
name|ld
argument_list|)
expr_stmt|;
comment|/*  The application should occur only within selection bounds  */
name|drawable_mask_bounds
argument_list|(
name|drawable
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|drawable_shadow
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|2
argument_list|,
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
name|levels
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|ld
argument_list|)
expr_stmt|;
name|drawable_merge_shadow
argument_list|(
name|drawable
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|drawable_update
argument_list|(
name|drawable
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|procedural_db_return_args
argument_list|(
operator|&
name|levels_proc
argument_list|,
name|success
argument_list|)
return|;
block|}
end_function

end_unit

