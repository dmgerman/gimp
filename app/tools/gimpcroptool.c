begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<gdk/gdkkeysyms.h>
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"tools-types.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpchannel.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpdrawable.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage-mask.h"
end_include

begin_include
include|#
directive|include
file|"core/gimplayer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimplist.h"
end_include

begin_include
include|#
directive|include
file|"gui/info-dialog.h"
end_include

begin_include
include|#
directive|include
file|"cursorutil.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"gimpcroptool.h"
end_include

begin_include
include|#
directive|include
file|"gimpdrawtool.h"
end_include

begin_include
include|#
directive|include
file|"gimptool.h"
end_include

begin_include
include|#
directive|include
file|"tool_options.h"
end_include

begin_include
include|#
directive|include
file|"tool_manager.h"
end_include

begin_include
include|#
directive|include
file|"floating_sel.h"
end_include

begin_include
include|#
directive|include
file|"pixel_region.h"
end_include

begin_include
include|#
directive|include
file|"undo.h"
end_include

begin_include
include|#
directive|include
file|"pixmaps2.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_define
DECL|macro|STATUSBAR_SIZE
define|#
directive|define
name|STATUSBAR_SIZE
value|128
end_define

begin_comment
comment|/*  possible crop functions  */
end_comment

begin_define
DECL|macro|CREATING
define|#
directive|define
name|CREATING
value|0
end_define

begin_define
DECL|macro|MOVING
define|#
directive|define
name|MOVING
value|1
end_define

begin_define
DECL|macro|RESIZING_LEFT
define|#
directive|define
name|RESIZING_LEFT
value|2
end_define

begin_define
DECL|macro|RESIZING_RIGHT
define|#
directive|define
name|RESIZING_RIGHT
value|3
end_define

begin_define
DECL|macro|CROPPING
define|#
directive|define
name|CROPPING
value|4
end_define

begin_comment
comment|/*  speed of key movement  */
end_comment

begin_define
DECL|macro|ARROW_VELOCITY
define|#
directive|define
name|ARROW_VELOCITY
value|25
end_define

begin_comment
comment|/*  the crop structures  */
end_comment

begin_typedef
DECL|typedef|CropOptions
typedef|typedef
name|struct
name|_CropOptions
name|CropOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_CropOptions
struct|struct
name|_CropOptions
block|{
DECL|member|tool_options
name|ToolOptions
name|tool_options
decl_stmt|;
DECL|member|layer_only
name|gboolean
name|layer_only
decl_stmt|;
DECL|member|layer_only_d
name|gboolean
name|layer_only_d
decl_stmt|;
DECL|member|layer_only_w
name|GtkWidget
modifier|*
name|layer_only_w
decl_stmt|;
DECL|member|allow_enlarge
name|gboolean
name|allow_enlarge
decl_stmt|;
DECL|member|allow_enlarge_d
name|gboolean
name|allow_enlarge_d
decl_stmt|;
DECL|member|allow_enlarge_w
name|GtkWidget
modifier|*
name|allow_enlarge_w
decl_stmt|;
DECL|member|type
name|CropType
name|type
decl_stmt|;
DECL|member|type_d
name|CropType
name|type_d
decl_stmt|;
DECL|member|type_w
name|GtkWidget
modifier|*
name|type_w
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  the crop tool options  */
end_comment

begin_decl_stmt
DECL|variable|crop_options
specifier|static
name|CropOptions
modifier|*
name|crop_options
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  the crop tool info dialog  */
end_comment

begin_decl_stmt
DECL|variable|crop_info
specifier|static
name|InfoDialog
modifier|*
name|crop_info
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|orig_vals
specifier|static
name|gdouble
name|orig_vals
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|size_vals
specifier|static
name|gdouble
name|size_vals
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|origin_sizeentry
specifier|static
name|GtkWidget
modifier|*
name|origin_sizeentry
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|size_sizeentry
specifier|static
name|GtkWidget
modifier|*
name|size_sizeentry
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  Crop type functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_tool_button_press
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_tool_button_release
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_tool_motion
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_tool_cursor_update
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_tool_control
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|ToolAction
name|action
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_tool_arrow_key
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventKey
modifier|*
name|kevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_tool_modifier_key
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventKey
modifier|*
name|kevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Crop helper functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_recalc
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCropTool
modifier|*
name|crop
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_start
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCropTool
modifier|*
name|crop
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_adjust_guides
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|x1
parameter_list|,
name|gint
name|y1
parameter_list|,
name|gint
name|x2
parameter_list|,
name|gint
name|y2
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Crop dialog functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_info_update
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_info_create
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_crop_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_resize_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Crop OO functions */
end_comment

begin_function_decl
name|GtkType
name|gimp_crop_tool_get_type
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_crop_tool_class_init
parameter_list|(
name|GimpCropToolClass
modifier|*
name|klass
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_crop_tool_init
parameter_list|(
name|GimpCropTool
modifier|*
name|crop_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_crop_tool_destroy
parameter_list|(
name|GtkObject
modifier|*
name|object
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|parent_class
specifier|static
name|GimpDrawToolClass
modifier|*
name|parent_class
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Crop area-select functions */
end_comment

begin_typedef
typedef|typedef
enum|enum
DECL|enum|__anon29aec55d0103
block|{
DECL|enumerator|AUTO_CROP_NOTHING
name|AUTO_CROP_NOTHING
init|=
literal|0
block|,
DECL|enumerator|AUTO_CROP_ALPHA
name|AUTO_CROP_ALPHA
init|=
literal|1
block|,
DECL|enumerator|AUTO_CROP_COLOR
name|AUTO_CROP_COLOR
init|=
literal|2
DECL|typedef|AutoCropType
block|}
name|AutoCropType
typedef|;
end_typedef

begin_typedef
DECL|typedef|GetColorFunc
typedef|typedef
name|guchar
modifier|*
function_decl|(
modifier|*
name|GetColorFunc
function_decl|)
parameter_list|(
name|GtkObject
modifier|*
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|)
function_decl|;
end_typedef

begin_typedef
DECL|typedef|ColorsEqualFunc
typedef|typedef
name|AutoCropType
function_decl|(
modifier|*
name|ColorsEqualFunc
function_decl|)
parameter_list|(
name|guchar
modifier|*
parameter_list|,
name|guchar
modifier|*
parameter_list|,
name|gint
parameter_list|)
function_decl|;
end_typedef

begin_function_decl
specifier|static
name|void
name|crop_selection_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_automatic_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|AutoCropType
name|crop_guess_bgcolor
parameter_list|(
name|GtkObject
modifier|*
parameter_list|,
name|GetColorFunc
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|,
name|guchar
modifier|*
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|crop_colors_equal
parameter_list|(
name|guchar
modifier|*
parameter_list|,
name|guchar
modifier|*
parameter_list|,
name|gint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|crop_colors_alpha
parameter_list|(
name|guchar
modifier|*
parameter_list|,
name|guchar
modifier|*
parameter_list|,
name|gint
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Crop dialog callback funtions  */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_orig_changed
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_size_changed
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|crop_options_reset (ToolOptions * tool_options)
name|crop_options_reset
parameter_list|(
name|ToolOptions
modifier|*
name|tool_options
parameter_list|)
block|{
name|CropOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|CropOptions
operator|*
operator|)
name|tool_options
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|options
operator|->
name|layer_only_w
argument_list|)
argument_list|,
name|options
operator|->
name|layer_only_d
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|options
operator|->
name|allow_enlarge_w
argument_list|)
argument_list|,
name|options
operator|->
name|allow_enlarge_d
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|options
operator|->
name|type_w
index|[
name|options
operator|->
name|type_d
index|]
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|CropOptions
modifier|*
DECL|function|crop_options_new (void)
name|crop_options_new
parameter_list|(
name|void
parameter_list|)
block|{
name|CropOptions
modifier|*
name|options
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|options
operator|=
name|g_new0
argument_list|(
name|CropOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tool_options_init
argument_list|(
operator|(
name|ToolOptions
operator|*
operator|)
name|options
argument_list|,
name|crop_options_reset
argument_list|)
expr_stmt|;
name|options
operator|->
name|layer_only
operator|=
name|options
operator|->
name|layer_only_d
operator|=
name|FALSE
expr_stmt|;
name|options
operator|->
name|allow_enlarge
operator|=
name|options
operator|->
name|allow_enlarge_d
operator|=
name|FALSE
expr_stmt|;
name|options
operator|->
name|type
operator|=
name|options
operator|->
name|type_d
operator|=
name|CROP_CROP
expr_stmt|;
comment|/*  the main vbox  */
name|vbox
operator|=
name|options
operator|->
name|tool_options
operator|.
name|main_vbox
expr_stmt|;
comment|/*  layer toggle  */
name|options
operator|->
name|layer_only_w
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Current Layer only"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|options
operator|->
name|layer_only_w
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|options
operator|->
name|layer_only_w
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|options
operator|->
name|layer_only
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|options
operator|->
name|layer_only_w
argument_list|)
argument_list|,
name|options
operator|->
name|layer_only_d
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|layer_only_w
argument_list|)
expr_stmt|;
comment|/*  enlarge toggle  */
name|options
operator|->
name|allow_enlarge_w
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Allow Enlarging"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|options
operator|->
name|allow_enlarge_w
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|options
operator|->
name|allow_enlarge_w
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|options
operator|->
name|allow_enlarge
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|options
operator|->
name|allow_enlarge_w
argument_list|)
argument_list|,
name|options
operator|->
name|allow_enlarge_d
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|allow_enlarge_w
argument_list|)
expr_stmt|;
comment|/*  tool toggle  */
name|frame
operator|=
name|gimp_radio_group_new2
argument_list|(
name|TRUE
argument_list|,
name|_
argument_list|(
literal|"Tool Toggle"
argument_list|)
argument_list|,
name|gimp_radio_button_update
argument_list|,
operator|&
name|options
operator|->
name|type
argument_list|,
operator|(
name|gpointer
operator|)
name|options
operator|->
name|type
argument_list|,
name|_
argument_list|(
literal|"Crop"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|CROP_CROP
argument_list|,
operator|&
name|options
operator|->
name|type_w
index|[
literal|0
index|]
argument_list|,
name|_
argument_list|(
literal|"Resize"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|RESIZE_CROP
argument_list|,
operator|&
name|options
operator|->
name|type_w
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
return|return
name|options
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_tool_button_press (GimpTool * tool,GdkEventButton * bevent,GDisplay * gdisp)
name|crop_tool_button_press
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|INACTIVE
operator|||
name|gdisp
operator|!=
name|tool
operator|->
name|gdisp
condition|)
block|{
name|crop
operator|->
name|function
operator|=
name|CREATING
expr_stmt|;
block|}
else|else
block|{
comment|/*  If the cursor is in either the upper left or lower right boxes, 	  The new function will be to resize the current crop area        */
if|if
condition|(
name|bevent
operator|->
name|x
operator|==
name|CLAMP
argument_list|(
name|bevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|x1
operator|+
name|crop
operator|->
name|srw
argument_list|)
operator|&&
name|bevent
operator|->
name|y
operator|==
name|CLAMP
argument_list|(
name|bevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|y1
operator|+
name|crop
operator|->
name|srh
argument_list|)
condition|)
name|crop
operator|->
name|function
operator|=
name|RESIZING_LEFT
expr_stmt|;
elseif|else
if|if
condition|(
name|bevent
operator|->
name|x
operator|==
name|CLAMP
argument_list|(
name|bevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|x2
argument_list|)
operator|&&
name|bevent
operator|->
name|y
operator|==
name|CLAMP
argument_list|(
name|bevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
condition|)
name|crop
operator|->
name|function
operator|=
name|RESIZING_RIGHT
expr_stmt|;
comment|/*  If the cursor is in either the upper right or lower left boxes, 	  The new function will be to translate the current crop area     */
elseif|else
if|if
condition|(
operator|(
name|bevent
operator|->
name|x
operator|==
name|CLAMP
argument_list|(
name|bevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|x1
operator|+
name|crop
operator|->
name|srw
argument_list|)
operator|&&
name|bevent
operator|->
name|y
operator|==
name|CLAMP
argument_list|(
name|bevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
operator|)
operator|||
operator|(
name|bevent
operator|->
name|x
operator|==
name|CLAMP
argument_list|(
name|bevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|x2
argument_list|)
operator|&&
name|bevent
operator|->
name|y
operator|==
name|CLAMP
argument_list|(
name|bevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|y1
operator|+
name|crop
operator|->
name|srh
argument_list|)
operator|)
condition|)
name|crop
operator|->
name|function
operator|=
name|MOVING
expr_stmt|;
comment|/*  If the pointer is in the rectangular region, crop or resize it!  */
elseif|else
if|if
condition|(
name|bevent
operator|->
name|x
operator|>
name|crop
operator|->
name|x1
operator|&&
name|bevent
operator|->
name|x
operator|<
name|crop
operator|->
name|x2
operator|&&
name|bevent
operator|->
name|y
operator|>
name|crop
operator|->
name|y1
operator|&&
name|bevent
operator|->
name|y
operator|<
name|crop
operator|->
name|y2
condition|)
name|crop
operator|->
name|function
operator|=
name|CROPPING
expr_stmt|;
comment|/*  otherwise, the new function will be creating, since we want to start anew  */
else|else
name|crop
operator|->
name|function
operator|=
name|CREATING
expr_stmt|;
block|}
if|if
condition|(
name|crop
operator|->
name|function
operator|==
name|CREATING
condition|)
block|{
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
condition|)
name|gimp_draw_tool_stop
argument_list|(
name|draw
argument_list|)
expr_stmt|;
name|tool
operator|->
name|gdisp
operator|=
name|gdisp
expr_stmt|;
name|tool
operator|->
name|drawable
operator|=
name|gimp_image_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
operator|&
name|crop
operator|->
name|tx1
argument_list|,
operator|&
name|crop
operator|->
name|ty1
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|crop
operator|->
name|tx1
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|crop
operator|->
name|ty1
expr_stmt|;
name|crop_start
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
block|}
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
operator|&
name|crop
operator|->
name|startx
argument_list|,
operator|&
name|crop
operator|->
name|starty
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|crop
operator|->
name|lastx
operator|=
name|crop
operator|->
name|startx
expr_stmt|;
name|crop
operator|->
name|lasty
operator|=
name|crop
operator|->
name|starty
expr_stmt|;
name|gdk_pointer_grab
argument_list|(
name|gdisp
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|FALSE
argument_list|,
name|GDK_POINTER_MOTION_HINT_MASK
operator||
name|GDK_BUTTON1_MOTION_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|ACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_tool_button_release (GimpTool * tool,GdkEventButton * bevent,GDisplay * gdisp)
name|crop_tool_button_release
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|gdk_pointer_ungrab
argument_list|(
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
name|gtk_statusbar_pop
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
name|crop
operator|->
name|context_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_BUTTON3_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|crop
operator|->
name|function
operator|==
name|CROPPING
condition|)
block|{
if|if
condition|(
name|crop_options
operator|->
name|type
operator|==
name|CROP_CROP
condition|)
name|crop_image
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
name|crop_options
operator|->
name|layer_only
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
name|crop_image
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
name|crop_options
operator|->
name|layer_only
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  Finish the tool  */
name|crop_close_callback
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|crop_info_update
argument_list|(
name|tool
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_adjust_guides (GimpImage * gimage,gint x1,gint y1,gint x2,gint y2)
name|crop_adjust_guides
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|x1
parameter_list|,
name|gint
name|y1
parameter_list|,
name|gint
name|x2
parameter_list|,
name|gint
name|y2
parameter_list|)
block|{
name|GList
modifier|*
name|glist
decl_stmt|;
name|Guide
modifier|*
name|guide
decl_stmt|;
name|gboolean
name|remove_guide
decl_stmt|;
for|for
control|(
name|glist
operator|=
name|gimage
operator|->
name|guides
init|;
name|glist
condition|;
name|glist
operator|=
name|g_list_next
argument_list|(
name|glist
argument_list|)
control|)
block|{
name|guide
operator|=
operator|(
name|Guide
operator|*
operator|)
name|glist
operator|->
name|data
expr_stmt|;
name|remove_guide
operator|=
name|FALSE
expr_stmt|;
switch|switch
condition|(
name|guide
operator|->
name|orientation
condition|)
block|{
case|case
name|ORIENTATION_HORIZONTAL
case|:
if|if
condition|(
operator|(
name|guide
operator|->
name|position
operator|<
name|y1
operator|)
operator|||
operator|(
name|guide
operator|->
name|position
operator|>
name|y2
operator|)
condition|)
name|remove_guide
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|ORIENTATION_VERTICAL
case|:
if|if
condition|(
operator|(
name|guide
operator|->
name|position
operator|<
name|x1
operator|)
operator|||
operator|(
name|guide
operator|->
name|position
operator|>
name|x2
operator|)
condition|)
name|remove_guide
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* edit the guide */
name|gdisplays_expose_guide
argument_list|(
name|gimage
argument_list|,
name|guide
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
if|if
condition|(
name|remove_guide
condition|)
block|{
name|guide
operator|->
name|position
operator|=
operator|-
literal|1
expr_stmt|;
name|guide
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|guide
operator|->
name|orientation
operator|==
name|ORIENTATION_HORIZONTAL
condition|)
block|{
name|guide
operator|->
name|position
operator|-=
name|y1
expr_stmt|;
block|}
else|else
block|{
name|guide
operator|->
name|position
operator|-=
name|x1
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_tool_motion (GimpTool * tool,GdkEventMotion * mevent,GDisplay * gdisp)
name|crop_tool_motion
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|GimpLayer
modifier|*
name|layer
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gint
name|curx
decl_stmt|,
name|cury
decl_stmt|;
name|gint
name|inc_x
decl_stmt|,
name|inc_y
decl_stmt|;
name|gchar
name|size
index|[
name|STATUSBAR_SIZE
index|]
decl_stmt|;
name|gint
name|min_x
decl_stmt|,
name|min_y
decl_stmt|,
name|max_x
decl_stmt|,
name|max_y
decl_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
comment|/*  This is the only case when the motion events should be ignored--       we're just waiting for the button release event to crop the image  */
if|if
condition|(
name|crop
operator|->
name|function
operator|==
name|CROPPING
condition|)
return|return;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|mevent
operator|->
name|x
argument_list|,
name|mevent
operator|->
name|y
argument_list|,
operator|&
name|curx
argument_list|,
operator|&
name|cury
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|x1
operator|=
name|crop
operator|->
name|startx
expr_stmt|;
name|y1
operator|=
name|crop
operator|->
name|starty
expr_stmt|;
name|x2
operator|=
name|curx
expr_stmt|;
name|y2
operator|=
name|cury
expr_stmt|;
name|inc_x
operator|=
operator|(
name|x2
operator|-
name|x1
operator|)
expr_stmt|;
name|inc_y
operator|=
operator|(
name|y2
operator|-
name|y1
operator|)
expr_stmt|;
comment|/*  If there have been no changes... return  */
if|if
condition|(
name|crop
operator|->
name|lastx
operator|==
name|curx
operator|&&
name|crop
operator|->
name|lasty
operator|==
name|cury
condition|)
return|return;
name|gimp_draw_tool_pause
argument_list|(
name|draw
argument_list|)
expr_stmt|;
if|if
condition|(
name|crop_options
operator|->
name|layer_only
condition|)
block|{
name|layer
operator|=
name|gimp_image_get_active_layer
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|min_x
argument_list|,
operator|&
name|min_y
argument_list|)
expr_stmt|;
name|max_x
operator|=
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|min_x
expr_stmt|;
name|max_y
operator|=
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|min_y
expr_stmt|;
block|}
else|else
block|{
name|min_x
operator|=
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|width
expr_stmt|;
name|max_y
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|height
expr_stmt|;
block|}
switch|switch
condition|(
name|crop
operator|->
name|function
condition|)
block|{
case|case
name|CREATING
case|:
if|if
condition|(
operator|!
name|crop_options
operator|->
name|allow_enlarge
condition|)
block|{
name|x1
operator|=
name|CLAMP
argument_list|(
name|x1
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|y1
operator|=
name|CLAMP
argument_list|(
name|y1
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
name|x2
operator|=
name|CLAMP
argument_list|(
name|x2
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|y2
operator|=
name|CLAMP
argument_list|(
name|y2
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RESIZING_LEFT
case|:
name|x1
operator|=
name|crop
operator|->
name|tx1
operator|+
name|inc_x
expr_stmt|;
name|y1
operator|=
name|crop
operator|->
name|ty1
operator|+
name|inc_y
expr_stmt|;
if|if
condition|(
operator|!
name|crop_options
operator|->
name|allow_enlarge
condition|)
block|{
name|x1
operator|=
name|CLAMP
argument_list|(
name|x1
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|y1
operator|=
name|CLAMP
argument_list|(
name|y1
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
block|}
name|x2
operator|=
name|MAX
argument_list|(
name|x1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|)
expr_stmt|;
name|y2
operator|=
name|MAX
argument_list|(
name|y1
argument_list|,
name|crop
operator|->
name|ty2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|startx
operator|=
name|curx
expr_stmt|;
name|crop
operator|->
name|starty
operator|=
name|cury
expr_stmt|;
break|break;
case|case
name|RESIZING_RIGHT
case|:
name|x2
operator|=
name|crop
operator|->
name|tx2
operator|+
name|inc_x
expr_stmt|;
name|y2
operator|=
name|crop
operator|->
name|ty2
operator|+
name|inc_y
expr_stmt|;
if|if
condition|(
operator|!
name|crop_options
operator|->
name|allow_enlarge
condition|)
block|{
name|x2
operator|=
name|CLAMP
argument_list|(
name|x2
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|y2
operator|=
name|CLAMP
argument_list|(
name|y2
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
block|}
name|x1
operator|=
name|MIN
argument_list|(
name|crop
operator|->
name|tx1
argument_list|,
name|x2
argument_list|)
expr_stmt|;
name|y1
operator|=
name|MIN
argument_list|(
name|crop
operator|->
name|ty1
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|startx
operator|=
name|curx
expr_stmt|;
name|crop
operator|->
name|starty
operator|=
name|cury
expr_stmt|;
break|break;
case|case
name|MOVING
case|:
if|if
condition|(
operator|!
name|crop_options
operator|->
name|allow_enlarge
condition|)
block|{
name|inc_x
operator|=
name|CLAMP
argument_list|(
name|inc_x
argument_list|,
name|min_x
operator|-
name|crop
operator|->
name|tx1
argument_list|,
name|max_x
operator|-
name|crop
operator|->
name|tx2
argument_list|)
expr_stmt|;
name|inc_y
operator|=
name|CLAMP
argument_list|(
name|inc_y
argument_list|,
name|min_y
operator|-
name|crop
operator|->
name|ty1
argument_list|,
name|max_y
operator|-
name|crop
operator|->
name|ty2
argument_list|)
expr_stmt|;
block|}
name|x1
operator|=
name|crop
operator|->
name|tx1
operator|+
name|inc_x
expr_stmt|;
name|x2
operator|=
name|crop
operator|->
name|tx2
operator|+
name|inc_x
expr_stmt|;
name|y1
operator|=
name|crop
operator|->
name|ty1
operator|+
name|inc_y
expr_stmt|;
name|y2
operator|=
name|crop
operator|->
name|ty2
operator|+
name|inc_y
expr_stmt|;
name|crop
operator|->
name|startx
operator|=
name|curx
expr_stmt|;
name|crop
operator|->
name|starty
operator|=
name|cury
expr_stmt|;
break|break;
block|}
comment|/*  make sure that the coords are in bounds  */
name|crop
operator|->
name|tx1
operator|=
name|MIN
argument_list|(
name|x1
argument_list|,
name|x2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|ty1
operator|=
name|MIN
argument_list|(
name|y1
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|MAX
argument_list|(
name|x1
argument_list|,
name|x2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|MAX
argument_list|(
name|y1
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|lastx
operator|=
name|curx
expr_stmt|;
name|crop
operator|->
name|lasty
operator|=
name|cury
expr_stmt|;
comment|/*  recalculate the coordinates for crop_draw based on the new values  */
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
if|if
condition|(
name|crop
operator|->
name|function
operator|==
name|CREATING
operator|||
name|crop
operator|->
name|function
operator|==
name|RESIZING_LEFT
operator|||
name|crop
operator|->
name|function
operator|==
name|RESIZING_RIGHT
condition|)
block|{
name|gtk_statusbar_pop
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
name|crop
operator|->
name|context_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|gdisp
operator|->
name|dot_for_dot
condition|)
block|{
name|g_snprintf
argument_list|(
name|size
argument_list|,
name|STATUSBAR_SIZE
argument_list|,
name|gdisp
operator|->
name|cursor_format_str
argument_list|,
name|_
argument_list|(
literal|"Crop: "
argument_list|)
argument_list|,
operator|(
name|crop
operator|->
name|tx2
operator|-
name|crop
operator|->
name|tx1
operator|)
argument_list|,
literal|" x "
argument_list|,
operator|(
name|crop
operator|->
name|ty2
operator|-
name|crop
operator|->
name|ty1
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* show real world units */
block|{
name|gdouble
name|unit_factor
init|=
name|gimp_unit_get_factor
argument_list|(
name|gdisp
operator|->
name|gimage
operator|->
name|unit
argument_list|)
decl_stmt|;
name|g_snprintf
argument_list|(
name|size
argument_list|,
name|STATUSBAR_SIZE
argument_list|,
name|gdisp
operator|->
name|cursor_format_str
argument_list|,
name|_
argument_list|(
literal|"Crop: "
argument_list|)
argument_list|,
call|(
name|gdouble
call|)
argument_list|(
name|crop
operator|->
name|tx2
operator|-
name|crop
operator|->
name|tx1
argument_list|)
operator|*
name|unit_factor
operator|/
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
argument_list|,
literal|" x "
argument_list|,
call|(
name|gdouble
call|)
argument_list|(
name|crop
operator|->
name|ty2
operator|-
name|crop
operator|->
name|ty1
argument_list|)
operator|*
name|unit_factor
operator|/
name|gdisp
operator|->
name|gimage
operator|->
name|yresolution
argument_list|)
expr_stmt|;
block|}
name|gtk_statusbar_push
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
name|crop
operator|->
name|context_id
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
name|gimp_draw_tool_resume
argument_list|(
name|draw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_tool_cursor_update (GimpTool * tool,GdkEventMotion * mevent,GDisplay * gdisp)
name|crop_tool_cursor_update
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GdkCursorType
name|ctype
init|=
name|GIMP_MOUSE_CURSOR
decl_stmt|;
name|GimpCursorModifier
name|cmodifier
init|=
name|GIMP_CURSOR_MODIFIER_NONE
decl_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|INACTIVE
operator|||
operator|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
operator|&&
name|tool
operator|->
name|gdisp
operator|!=
name|gdisp
operator|)
condition|)
block|{
name|ctype
operator|=
name|GIMP_CROSSHAIR_SMALL_CURSOR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|==
name|CLAMP
argument_list|(
name|mevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|x1
operator|+
name|crop
operator|->
name|srw
argument_list|)
operator|&&
name|mevent
operator|->
name|y
operator|==
name|CLAMP
argument_list|(
name|mevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|y1
operator|+
name|crop
operator|->
name|srh
argument_list|)
condition|)
block|{
name|cmodifier
operator|=
name|GIMP_CURSOR_MODIFIER_RESIZE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|==
name|CLAMP
argument_list|(
name|mevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|x2
argument_list|)
operator|&&
name|mevent
operator|->
name|y
operator|==
name|CLAMP
argument_list|(
name|mevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
condition|)
block|{
name|cmodifier
operator|=
name|GIMP_CURSOR_MODIFIER_RESIZE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|==
name|CLAMP
argument_list|(
name|mevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|x1
operator|+
name|crop
operator|->
name|srw
argument_list|)
operator|&&
name|mevent
operator|->
name|y
operator|==
name|CLAMP
argument_list|(
name|mevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
condition|)
block|{
name|cmodifier
operator|=
name|GIMP_CURSOR_MODIFIER_MOVE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|==
name|CLAMP
argument_list|(
name|mevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|x2
argument_list|)
operator|&&
name|mevent
operator|->
name|y
operator|==
name|CLAMP
argument_list|(
name|mevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|y1
operator|+
name|crop
operator|->
name|srh
argument_list|)
condition|)
block|{
name|cmodifier
operator|=
name|GIMP_CURSOR_MODIFIER_MOVE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|mevent
operator|->
name|x
operator|>
name|crop
operator|->
name|x1
operator|&&
name|mevent
operator|->
name|x
operator|<
name|crop
operator|->
name|x2
operator|&&
name|mevent
operator|->
name|y
operator|>
name|crop
operator|->
name|y1
operator|&&
name|mevent
operator|->
name|y
operator|<
name|crop
operator|->
name|y2
operator|)
condition|)
block|{
name|ctype
operator|=
name|GIMP_CROSSHAIR_SMALL_CURSOR
expr_stmt|;
block|}
name|gdisplay_install_tool_cursor
argument_list|(
name|gdisp
argument_list|,
name|ctype
argument_list|,
name|crop_options
operator|->
name|type
operator|==
name|CROP_CROP
condition|?
name|GIMP_CROP_TOOL_CURSOR
else|:
name|GIMP_RESIZE_TOOL_CURSOR
argument_list|,
name|cmodifier
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_tool_arrow_key (GimpTool * tool,GdkEventKey * kevent,GDisplay * gdisp)
name|crop_tool_arrow_key
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventKey
modifier|*
name|kevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpLayer
modifier|*
name|layer
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|gint
name|inc_x
decl_stmt|,
name|inc_y
decl_stmt|;
name|gint
name|min_x
decl_stmt|,
name|min_y
decl_stmt|;
name|gint
name|max_x
decl_stmt|,
name|max_y
decl_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
condition|)
block|{
name|inc_x
operator|=
name|inc_y
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|kevent
operator|->
name|keyval
condition|)
block|{
case|case
name|GDK_Up
case|:
name|inc_y
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|GDK_Left
case|:
name|inc_x
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|GDK_Right
case|:
name|inc_x
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|GDK_Down
case|:
name|inc_y
operator|=
literal|1
expr_stmt|;
break|break;
block|}
comment|/*  If the shift key is down, move by an accelerated increment  */
if|if
condition|(
name|kevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
name|inc_y
operator|*=
name|ARROW_VELOCITY
expr_stmt|;
name|inc_x
operator|*=
name|ARROW_VELOCITY
expr_stmt|;
block|}
name|gimp_draw_tool_pause
argument_list|(
name|draw
argument_list|)
expr_stmt|;
if|if
condition|(
name|crop_options
operator|->
name|layer_only
condition|)
block|{
name|layer
operator|=
name|gimp_image_get_active_layer
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|min_x
argument_list|,
operator|&
name|min_y
argument_list|)
expr_stmt|;
name|max_x
operator|=
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|min_x
expr_stmt|;
name|max_y
operator|=
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|min_y
expr_stmt|;
block|}
else|else
block|{
name|min_x
operator|=
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|width
expr_stmt|;
name|max_y
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|height
expr_stmt|;
block|}
if|if
condition|(
name|kevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
condition|)
comment|/* RESIZING */
block|{
name|crop
operator|->
name|tx2
operator|=
name|crop
operator|->
name|tx2
operator|+
name|inc_x
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|crop
operator|->
name|ty2
operator|+
name|inc_y
expr_stmt|;
if|if
condition|(
operator|!
name|crop_options
operator|->
name|allow_enlarge
condition|)
block|{
name|crop
operator|->
name|tx2
operator|=
name|CLAMP
argument_list|(
name|crop
operator|->
name|tx2
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|CLAMP
argument_list|(
name|crop
operator|->
name|ty2
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
block|}
name|crop
operator|->
name|tx1
operator|=
name|MIN
argument_list|(
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|ty1
operator|=
name|MIN
argument_list|(
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|ty2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|crop_options
operator|->
name|allow_enlarge
condition|)
block|{
name|inc_x
operator|=
name|CLAMP
argument_list|(
name|inc_x
argument_list|,
operator|-
name|crop
operator|->
name|tx1
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|width
operator|-
name|crop
operator|->
name|tx2
argument_list|)
expr_stmt|;
name|inc_y
operator|=
name|CLAMP
argument_list|(
name|inc_y
argument_list|,
operator|-
name|crop
operator|->
name|ty1
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|height
operator|-
name|crop
operator|->
name|ty2
argument_list|)
expr_stmt|;
block|}
name|crop
operator|->
name|tx1
operator|+=
name|inc_x
expr_stmt|;
name|crop
operator|->
name|tx2
operator|+=
name|inc_x
expr_stmt|;
name|crop
operator|->
name|ty1
operator|+=
name|inc_y
expr_stmt|;
name|crop
operator|->
name|ty2
operator|+=
name|inc_y
expr_stmt|;
block|}
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|gimp_draw_tool_resume
argument_list|(
name|draw
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_tool_modifier_key (GimpTool * tool,GdkEventKey * kevent,GDisplay * gdisp)
name|crop_tool_modifier_key
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventKey
modifier|*
name|kevent
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
switch|switch
condition|(
name|kevent
operator|->
name|keyval
condition|)
block|{
case|case
name|GDK_Alt_L
case|:
case|case
name|GDK_Alt_R
case|:
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|crop_options
operator|->
name|allow_enlarge_w
argument_list|)
argument_list|,
operator|!
name|crop_options
operator|->
name|allow_enlarge
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_Shift_L
case|:
case|case
name|GDK_Shift_R
case|:
break|break;
case|case
name|GDK_Control_L
case|:
case|case
name|GDK_Control_R
case|:
if|if
condition|(
name|crop_options
operator|->
name|type
operator|==
name|CROP_CROP
condition|)
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|crop_options
operator|->
name|type_w
index|[
name|RESIZE_CROP
index|]
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|crop_options
operator|->
name|type_w
index|[
name|CROP_CROP
index|]
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_tool_control (GimpTool * tool,ToolAction action,GDisplay * gdisp)
name|crop_tool_control
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|ToolAction
name|action
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|PAUSE
case|:
break|break;
case|case
name|RESUME
case|:
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
break|break;
case|case
name|HALT
case|:
name|crop_close_callback
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|GIMP_TOOL_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|control
condition|)
name|GIMP_TOOL_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|control
argument_list|(
name|tool
argument_list|,
name|action
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|crop_tool_draw (GimpDrawTool * draw)
name|crop_tool_draw
parameter_list|(
name|GimpDrawTool
modifier|*
name|draw
parameter_list|)
block|{
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|draw
argument_list|)
expr_stmt|;
name|tool
operator|=
name|GIMP_TOOL
argument_list|(
name|draw
argument_list|)
expr_stmt|;
DECL|macro|SRW
define|#
directive|define
name|SRW
value|10
DECL|macro|SRH
define|#
directive|define
name|SRH
value|10
name|gdk_draw_line
argument_list|(
name|draw
operator|->
name|win
argument_list|,
name|draw
operator|->
name|gc
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|disp_width
argument_list|,
name|crop
operator|->
name|y1
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|draw
operator|->
name|win
argument_list|,
name|draw
operator|->
name|gc
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|disp_height
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|draw
operator|->
name|win
argument_list|,
name|draw
operator|->
name|gc
argument_list|,
name|crop
operator|->
name|x2
argument_list|,
name|crop
operator|->
name|y2
argument_list|,
literal|0
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|draw
operator|->
name|win
argument_list|,
name|draw
operator|->
name|gc
argument_list|,
name|crop
operator|->
name|x2
argument_list|,
name|crop
operator|->
name|y2
argument_list|,
name|crop
operator|->
name|x2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crop
operator|->
name|srw
operator|=
operator|(
operator|(
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|x1
operator|)
operator|<
name|SRW
operator|)
condition|?
operator|(
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|x1
operator|)
else|:
name|SRW
expr_stmt|;
name|crop
operator|->
name|srh
operator|=
operator|(
operator|(
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|y1
operator|)
operator|<
name|SRH
operator|)
condition|?
operator|(
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|y1
operator|)
else|:
name|SRH
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|draw
operator|->
name|win
argument_list|,
name|draw
operator|->
name|gc
argument_list|,
literal|1
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|srh
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|draw
operator|->
name|win
argument_list|,
name|draw
operator|->
name|gc
argument_list|,
literal|1
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|srh
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|draw
operator|->
name|win
argument_list|,
name|draw
operator|->
name|gc
argument_list|,
literal|1
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|srh
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|draw
operator|->
name|win
argument_list|,
name|draw
operator|->
name|gc
argument_list|,
literal|1
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|srh
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SRW
undef|#
directive|undef
name|SRH
name|crop_info_update
argument_list|(
name|tool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|crop_image (GimpImage * gimage,gint x1,gint y1,gint x2,gint y2,gboolean layer_only,gboolean crop_layers)
name|crop_image
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|x1
parameter_list|,
name|gint
name|y1
parameter_list|,
name|gint
name|x2
parameter_list|,
name|gint
name|y2
parameter_list|,
name|gboolean
name|layer_only
parameter_list|,
name|gboolean
name|crop_layers
parameter_list|)
block|{
name|GimpLayer
modifier|*
name|layer
decl_stmt|;
name|GimpLayer
modifier|*
name|floating_layer
decl_stmt|;
name|GimpChannel
modifier|*
name|channel
decl_stmt|;
name|GList
modifier|*
name|guide_list_ptr
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gint
name|lx1
decl_stmt|,
name|ly1
decl_stmt|,
name|lx2
decl_stmt|,
name|ly2
decl_stmt|;
name|gint
name|off_x
decl_stmt|,
name|off_y
decl_stmt|;
name|gint
name|doff_x
decl_stmt|,
name|doff_y
decl_stmt|;
name|width
operator|=
name|x2
operator|-
name|x1
expr_stmt|;
name|height
operator|=
name|y2
operator|-
name|y1
expr_stmt|;
comment|/*  Make sure new width and height are non-zero  */
if|if
condition|(
name|width
operator|&&
name|height
condition|)
block|{
name|gimp_add_busy_cursors
argument_list|()
expr_stmt|;
if|if
condition|(
name|layer_only
condition|)
block|{
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|LAYER_RESIZE_UNDO
argument_list|)
expr_stmt|;
name|layer
operator|=
name|gimp_image_get_active_layer
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_relax
argument_list|(
name|layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|doff_x
argument_list|,
operator|&
name|doff_y
argument_list|)
expr_stmt|;
name|off_x
operator|=
operator|(
name|doff_x
operator|-
name|x1
operator|)
expr_stmt|;
name|off_y
operator|=
operator|(
name|doff_y
operator|-
name|y1
operator|)
expr_stmt|;
name|gimp_layer_resize
argument_list|(
name|layer
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|off_x
argument_list|,
name|off_y
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_rigor
argument_list|(
name|layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|floating_layer
operator|=
name|gimp_image_floating_sel
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|CROP_UNDO
argument_list|)
expr_stmt|;
comment|/*  relax the floating layer  */
if|if
condition|(
name|floating_layer
condition|)
name|floating_sel_relax
argument_list|(
name|floating_layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/*  Push the image size to the stack  */
name|undo_push_gimage_mod
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/*  Set the new width and height  */
name|gimage
operator|->
name|width
operator|=
name|width
expr_stmt|;
name|gimage
operator|->
name|height
operator|=
name|height
expr_stmt|;
comment|/*  Resize all channels  */
for|for
control|(
name|list
operator|=
name|GIMP_LIST
argument_list|(
name|gimage
operator|->
name|channels
argument_list|)
operator|->
name|list
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|channel
operator|=
operator|(
name|GimpChannel
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|gimp_channel_resize
argument_list|(
name|channel
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
name|x1
argument_list|,
operator|-
name|y1
argument_list|)
expr_stmt|;
block|}
comment|/*  Don't forget the selection mask!  */
name|gimp_channel_resize
argument_list|(
name|gimage
operator|->
name|selection_mask
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
name|x1
argument_list|,
operator|-
name|y1
argument_list|)
expr_stmt|;
name|gimage_mask_invalidate
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/*  crop all layers  */
name|list
operator|=
name|GIMP_LIST
argument_list|(
name|gimage
operator|->
name|layers
argument_list|)
operator|->
name|list
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|GList
modifier|*
name|next
decl_stmt|;
name|layer
operator|=
operator|(
name|GimpLayer
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|next
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|gimp_layer_translate
argument_list|(
name|layer
argument_list|,
operator|-
name|x1
argument_list|,
operator|-
name|y1
argument_list|)
expr_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
if|if
condition|(
name|crop_layers
condition|)
block|{
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
name|lx1
operator|=
name|CLAMP
argument_list|(
name|off_x
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|ly1
operator|=
name|CLAMP
argument_list|(
name|off_y
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|lx2
operator|=
name|CLAMP
argument_list|(
operator|(
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|off_x
operator|)
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|ly2
operator|=
name|CLAMP
argument_list|(
operator|(
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|off_y
operator|)
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|width
operator|=
name|lx2
operator|-
name|lx1
expr_stmt|;
name|height
operator|=
name|ly2
operator|-
name|ly1
expr_stmt|;
if|if
condition|(
name|width
operator|&&
name|height
condition|)
name|gimp_layer_resize
argument_list|(
name|layer
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
operator|(
name|lx1
operator|-
name|off_x
operator|)
argument_list|,
operator|-
operator|(
name|ly1
operator|-
name|off_y
operator|)
argument_list|)
expr_stmt|;
else|else
name|gimp_image_remove_layer
argument_list|(
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
block|}
name|list
operator|=
name|next
expr_stmt|;
block|}
comment|/*  Make sure the projection matches the gimage size  */
name|gimp_image_projection_realloc
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/*  rigor the floating layer  */
if|if
condition|(
name|floating_layer
condition|)
name|floating_sel_rigor
argument_list|(
name|floating_layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|guide_list_ptr
operator|=
name|gimage
operator|->
name|guides
expr_stmt|;
while|while
condition|(
name|guide_list_ptr
operator|!=
name|NULL
condition|)
block|{
name|undo_push_guide
argument_list|(
name|gimage
argument_list|,
operator|(
name|Guide
operator|*
operator|)
name|guide_list_ptr
operator|->
name|data
argument_list|)
expr_stmt|;
name|guide_list_ptr
operator|=
name|guide_list_ptr
operator|->
name|next
expr_stmt|;
block|}
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/* Adjust any guides we might have laying about */
name|crop_adjust_guides
argument_list|(
name|gimage
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
expr_stmt|;
comment|/*  shrink wrap and update all views  */
name|gimp_image_invalidate_layer_previews
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gimp_image_invalidate_channel_previews
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gimp_viewable_invalidate_preview
argument_list|(
name|GIMP_VIEWABLE
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
name|gdisplays_update_full
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_shrink_wrap
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
name|gimp_remove_busy_cursors
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_recalc (GimpTool * tool,GimpCropTool * crop)
name|crop_recalc
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCropTool
modifier|*
name|crop
parameter_list|)
block|{
name|gdisplay_transform_coords
argument_list|(
name|tool
operator|->
name|gdisp
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
operator|&
name|crop
operator|->
name|x1
argument_list|,
operator|&
name|crop
operator|->
name|y1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gdisplay_transform_coords
argument_list|(
name|tool
operator|->
name|gdisp
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
operator|&
name|crop
operator|->
name|x2
argument_list|,
operator|&
name|crop
operator|->
name|y2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_start (GimpTool * tool,GimpCropTool * crop)
name|crop_start
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCropTool
modifier|*
name|crop
parameter_list|)
block|{
specifier|static
name|GDisplay
modifier|*
name|old_gdisp
init|=
name|NULL
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|crop_info
condition|)
name|crop_info_create
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|gtk_signal_handler_block_by_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
name|crop_info
argument_list|)
expr_stmt|;
name|gtk_signal_handler_block_by_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
name|crop_info
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|yresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|yresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_gdisp
operator|!=
name|tool
operator|->
name|gdisp
condition|)
block|{
name|gimp_size_entry_set_unit
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|unit
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_unit
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|gdisp
operator|->
name|dot_for_dot
condition|)
block|{
name|gimp_size_entry_set_unit
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
name|GIMP_UNIT_PIXEL
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_unit
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
name|GIMP_UNIT_PIXEL
argument_list|)
expr_stmt|;
block|}
block|}
name|gtk_signal_handler_unblock_by_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
name|crop_info
argument_list|)
expr_stmt|;
name|gtk_signal_handler_unblock_by_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
name|crop_info
argument_list|)
expr_stmt|;
name|old_gdisp
operator|=
name|tool
operator|->
name|gdisp
expr_stmt|;
comment|/* initialize the statusbar display */
name|crop
operator|->
name|context_id
operator|=
name|gtk_statusbar_get_context_id
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|tool
operator|->
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
literal|"crop"
argument_list|)
expr_stmt|;
name|gtk_statusbar_push
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|tool
operator|->
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
name|crop
operator|->
name|context_id
argument_list|,
name|_
argument_list|(
literal|"Crop: 0 x 0"
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_draw_tool_start
argument_list|(
name|draw
argument_list|,
name|tool
operator|->
name|gdisp
operator|->
name|canvas
operator|->
name|window
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************/
end_comment

begin_comment
comment|/*  Crop dialog functions  */
end_comment

begin_comment
comment|/***************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|crop_info_create (GimpTool * tool)
name|crop_info_create
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|GtkWidget
modifier|*
name|spinbutton
decl_stmt|;
name|GtkWidget
modifier|*
name|bbox
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp
expr_stmt|;
comment|/*  create the info dialog  */
name|crop_info
operator|=
name|info_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Crop& Resize Information"
argument_list|)
argument_list|,
name|tool_manager_help_func
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  create the action area  */
name|gimp_dialog_create_action_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|crop_info
operator|->
name|shell
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Crop"
argument_list|)
argument_list|,
name|crop_crop_callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Resize"
argument_list|)
argument_list|,
name|crop_resize_callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Close"
argument_list|)
argument_list|,
name|crop_close_callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  add the information fields  */
name|spinbutton
operator|=
name|info_dialog_add_spinbutton
argument_list|(
name|crop_info
argument_list|,
name|_
argument_list|(
literal|"Origin X:"
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|origin_sizeentry
operator|=
name|info_dialog_add_sizeentry
argument_list|(
name|crop_info
argument_list|,
name|_
argument_list|(
literal|"Y:"
argument_list|)
argument_list|,
name|orig_vals
argument_list|,
literal|1
argument_list|,
name|gdisp
operator|->
name|dot_for_dot
condition|?
name|GIMP_UNIT_PIXEL
else|:
name|gdisp
operator|->
name|gimage
operator|->
name|unit
argument_list|,
literal|"%a"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|GIMP_SIZE_ENTRY_UPDATE_SIZE
argument_list|,
name|crop_orig_changed
argument_list|,
name|crop_info
argument_list|)
expr_stmt|;
name|gimp_size_entry_add_field
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|65536
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|-
literal|65536
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
name|spinbutton
operator|=
name|info_dialog_add_spinbutton
argument_list|(
name|crop_info
argument_list|,
name|_
argument_list|(
literal|"Width:"
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|size_sizeentry
operator|=
name|info_dialog_add_sizeentry
argument_list|(
name|crop_info
argument_list|,
name|_
argument_list|(
literal|"Height:"
argument_list|)
argument_list|,
name|size_vals
argument_list|,
literal|1
argument_list|,
name|gdisp
operator|->
name|dot_for_dot
condition|?
name|GIMP_UNIT_PIXEL
else|:
name|gdisp
operator|->
name|gimage
operator|->
name|unit
argument_list|,
literal|"%a"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|GIMP_SIZE_ENTRY_UPDATE_SIZE
argument_list|,
name|crop_size_changed
argument_list|,
name|crop_info
argument_list|)
expr_stmt|;
name|gimp_size_entry_add_field
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|65536
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|-
literal|65536
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|crop_info
operator|->
name|info_table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|crop_info
operator|->
name|info_table
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|crop_info
operator|->
name|info_table
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Create the area selection buttons */
name|bbox
operator|=
name|gtk_hbutton_box_new
argument_list|()
expr_stmt|;
name|gtk_button_box_set_layout
argument_list|(
name|GTK_BUTTON_BOX
argument_list|(
name|bbox
argument_list|)
argument_list|,
name|GTK_BUTTONBOX_SPREAD
argument_list|)
expr_stmt|;
name|gtk_button_box_set_spacing
argument_list|(
name|GTK_BUTTON_BOX
argument_list|(
name|bbox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"From Selection"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|bbox
argument_list|)
argument_list|,
name|button
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|crop_selection_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Auto Shrink"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|bbox
argument_list|)
argument_list|,
name|button
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|crop_automatic_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|crop_info
operator|->
name|vbox
argument_list|)
argument_list|,
name|bbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|bbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_info_update (GimpTool * tool)
name|crop_info_update
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|)
block|{
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|orig_vals
index|[
literal|0
index|]
operator|=
name|crop
operator|->
name|tx1
expr_stmt|;
name|orig_vals
index|[
literal|1
index|]
operator|=
name|crop
operator|->
name|ty1
expr_stmt|;
name|size_vals
index|[
literal|0
index|]
operator|=
name|crop
operator|->
name|tx2
operator|-
name|crop
operator|->
name|tx1
expr_stmt|;
name|size_vals
index|[
literal|1
index|]
operator|=
name|crop
operator|->
name|ty2
operator|-
name|crop
operator|->
name|ty1
expr_stmt|;
name|info_dialog_update
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|info_dialog_popup
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_crop_callback (GtkWidget * widget,gpointer data)
name|crop_crop_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
comment|/* XXX active_tool is bad */
name|tool
operator|=
name|active_tool
expr_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|crop_image
argument_list|(
name|tool
operator|->
name|gdisp
operator|->
name|gimage
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
name|crop_options
operator|->
name|layer_only
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/*  Finish the tool  */
name|crop_close_callback
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_resize_callback (GtkWidget * widget,gpointer data)
name|crop_resize_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
comment|/* XXX active_tool is bad */
name|tool
operator|=
name|active_tool
expr_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|crop_image
argument_list|(
name|tool
operator|->
name|gdisp
operator|->
name|gimage
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
name|crop_options
operator|->
name|layer_only
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  Finish the tool  */
name|crop_close_callback
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_close_callback (GtkWidget * widget,gpointer data)
name|crop_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
comment|/* XXX active_tool is bad */
name|tool
operator|=
name|active_tool
expr_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
condition|)
name|gimp_draw_tool_stop
argument_list|(
name|draw
argument_list|)
expr_stmt|;
name|info_dialog_popdown
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|tool
operator|->
name|gdisp
operator|=
name|NULL
expr_stmt|;
name|tool
operator|->
name|drawable
operator|=
name|NULL
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_selection_callback (GtkWidget * widget,gpointer data)
name|crop_selection_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|GimpLayer
modifier|*
name|layer
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
comment|/* XXX active_tool is bad */
name|tool
operator|=
name|active_tool
expr_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|gdisp
operator|=
name|tool
operator|->
name|gdisp
expr_stmt|;
name|gimp_draw_tool_pause
argument_list|(
name|draw
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gimage_mask_bounds
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
operator|&
name|crop
operator|->
name|tx1
argument_list|,
operator|&
name|crop
operator|->
name|ty1
argument_list|,
operator|&
name|crop
operator|->
name|tx2
argument_list|,
operator|&
name|crop
operator|->
name|ty2
argument_list|)
condition|)
block|{
if|if
condition|(
name|crop_options
operator|->
name|layer_only
condition|)
block|{
name|layer
operator|=
name|gimp_image_get_active_layer
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|crop
operator|->
name|tx1
argument_list|,
operator|&
name|crop
operator|->
name|ty1
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|crop
operator|->
name|tx1
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|crop
operator|->
name|ty1
expr_stmt|;
block|}
else|else
block|{
name|crop
operator|->
name|tx1
operator|=
name|crop
operator|->
name|ty1
operator|=
literal|0
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|width
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|height
expr_stmt|;
block|}
block|}
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|gimp_draw_tool_resume
argument_list|(
name|draw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_automatic_callback (GtkWidget * widget,gpointer data)
name|crop_automatic_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|GimpDrawable
modifier|*
name|active_drawable
init|=
name|NULL
decl_stmt|;
name|GetColorFunc
name|get_color_func
decl_stmt|;
name|ColorsEqualFunc
name|colors_equal_func
decl_stmt|;
name|GtkObject
modifier|*
name|get_color_obj
decl_stmt|;
name|guchar
name|bgcolor
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|gboolean
name|has_alpha
init|=
name|FALSE
decl_stmt|;
name|PixelRegion
name|PR
decl_stmt|;
name|guchar
modifier|*
name|buffer
init|=
name|NULL
decl_stmt|;
name|gint
name|offset_x
decl_stmt|,
name|offset_y
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|,
name|bytes
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|abort
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
comment|/* XXX active_tool is bad */
name|tool
operator|=
name|active_tool
expr_stmt|;
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|gdisp
operator|=
name|tool
operator|->
name|gdisp
expr_stmt|;
name|gimp_draw_tool_pause
argument_list|(
name|draw
argument_list|)
expr_stmt|;
name|gimp_add_busy_cursors
argument_list|()
expr_stmt|;
comment|/* You should always keep in mind that crop->tx2 and crop->ty2 are the NOT the      coordinates of the bottomright corner of the area to be cropped. They point       at the pixel located one to the right and one to the bottom.      */
if|if
condition|(
name|crop_options
operator|->
name|layer_only
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|active_drawable
operator|=
name|gimp_image_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
operator|)
condition|)
return|return;
name|width
operator|=
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|active_drawable
argument_list|)
argument_list|)
expr_stmt|;
name|height
operator|=
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|active_drawable
argument_list|)
argument_list|)
expr_stmt|;
name|bytes
operator|=
name|gimp_drawable_bytes
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|active_drawable
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_drawable_has_alpha
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|active_drawable
argument_list|)
argument_list|)
condition|)
name|has_alpha
operator|=
name|TRUE
expr_stmt|;
name|get_color_obj
operator|=
name|GTK_OBJECT
argument_list|(
name|active_drawable
argument_list|)
expr_stmt|;
name|get_color_func
operator|=
operator|(
name|GetColorFunc
operator|)
name|gimp_drawable_get_color_at
expr_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|active_drawable
argument_list|)
argument_list|,
operator|&
name|offset_x
argument_list|,
operator|&
name|offset_y
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|width
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|width
expr_stmt|;
name|height
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|height
expr_stmt|;
name|has_alpha
operator|=
name|TRUE
expr_stmt|;
name|bytes
operator|=
name|gimp_image_composite_bytes
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|get_color_obj
operator|=
name|GTK_OBJECT
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|get_color_func
operator|=
operator|(
name|GetColorFunc
operator|)
name|gimp_image_get_color_at
expr_stmt|;
name|offset_x
operator|=
name|offset_y
operator|=
literal|0
expr_stmt|;
block|}
name|x1
operator|=
name|crop
operator|->
name|tx1
operator|-
name|offset_x
operator|>
literal|0
condition|?
name|crop
operator|->
name|tx1
operator|-
name|offset_x
else|:
literal|0
expr_stmt|;
name|x2
operator|=
name|crop
operator|->
name|tx2
operator|-
name|offset_x
operator|<
name|width
condition|?
name|crop
operator|->
name|tx2
operator|-
name|offset_x
else|:
name|width
expr_stmt|;
name|y1
operator|=
name|crop
operator|->
name|ty1
operator|-
name|offset_y
operator|>
literal|0
condition|?
name|crop
operator|->
name|ty1
operator|-
name|offset_y
else|:
literal|0
expr_stmt|;
name|y2
operator|=
name|crop
operator|->
name|ty2
operator|-
name|offset_y
operator|<
name|height
condition|?
name|crop
operator|->
name|ty2
operator|-
name|offset_y
else|:
name|height
expr_stmt|;
switch|switch
condition|(
name|crop_guess_bgcolor
argument_list|(
name|get_color_obj
argument_list|,
name|get_color_func
argument_list|,
name|bytes
argument_list|,
name|has_alpha
argument_list|,
name|bgcolor
argument_list|,
name|x1
argument_list|,
name|x2
operator|-
literal|1
argument_list|,
name|y1
argument_list|,
name|y2
operator|-
literal|1
argument_list|)
condition|)
block|{
case|case
name|AUTO_CROP_ALPHA
case|:
name|colors_equal_func
operator|=
operator|(
name|ColorsEqualFunc
operator|)
name|crop_colors_alpha
expr_stmt|;
break|break;
case|case
name|AUTO_CROP_COLOR
case|:
name|colors_equal_func
operator|=
operator|(
name|ColorsEqualFunc
operator|)
name|crop_colors_equal
expr_stmt|;
break|break;
default|default:
goto|goto
name|FINISH
goto|;
block|}
name|width
operator|=
name|x2
operator|-
name|x1
expr_stmt|;
name|height
operator|=
name|y2
operator|-
name|y1
expr_stmt|;
if|if
condition|(
name|crop_options
operator|->
name|layer_only
condition|)
name|pixel_region_init
argument_list|(
operator|&
name|PR
argument_list|,
name|gimp_drawable_data
argument_list|(
name|active_drawable
argument_list|)
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
else|else
name|pixel_region_init
argument_list|(
operator|&
name|PR
argument_list|,
name|gimp_image_composite
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* The following could be optimized further by processing the smaller side first      instead of defaulting to width    --Sven                                          */
name|buffer
operator|=
name|g_malloc
argument_list|(
operator|(
name|width
operator|>
name|height
condition|?
name|width
else|:
name|height
operator|)
operator|*
name|bytes
argument_list|)
expr_stmt|;
comment|/* Check how many of the top lines are uniform/transparent. */
name|abort
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|y
operator|=
name|y1
init|;
name|y
operator|<
name|y2
operator|&&
operator|!
name|abort
condition|;
name|y
operator|++
control|)
block|{
name|pixel_region_get_row
argument_list|(
operator|&
name|PR
argument_list|,
name|x1
argument_list|,
name|y
argument_list|,
name|width
argument_list|,
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
operator|&&
operator|!
name|abort
condition|;
name|x
operator|++
control|)
name|abort
operator|=
operator|!
call|(
name|colors_equal_func
call|)
argument_list|(
name|bgcolor
argument_list|,
name|buffer
operator|+
name|x
operator|*
name|bytes
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|y
operator|==
name|y2
operator|&&
operator|!
name|abort
condition|)
goto|goto
name|FINISH
goto|;
name|y1
operator|=
name|y
operator|-
literal|1
expr_stmt|;
comment|/* Check how many of the bottom lines are uniform/transparent. */
name|abort
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|y
operator|=
name|y2
init|;
name|y
operator|>
name|y1
operator|&&
operator|!
name|abort
condition|;
name|y
operator|--
control|)
block|{
name|pixel_region_get_row
argument_list|(
operator|&
name|PR
argument_list|,
name|x1
argument_list|,
name|y
operator|-
literal|1
argument_list|,
name|width
argument_list|,
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
operator|&&
operator|!
name|abort
condition|;
name|x
operator|++
control|)
name|abort
operator|=
operator|!
call|(
name|colors_equal_func
call|)
argument_list|(
name|bgcolor
argument_list|,
name|buffer
operator|+
name|x
operator|*
name|bytes
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
name|y2
operator|=
name|y
operator|+
literal|1
expr_stmt|;
comment|/* compute a new height for the next operations */
name|height
operator|=
name|y2
operator|-
name|y1
expr_stmt|;
comment|/* Check how many of the left lines are uniform/transparent. */
name|abort
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|x
operator|=
name|x1
init|;
name|x
operator|<
name|x2
operator|&&
operator|!
name|abort
condition|;
name|x
operator|++
control|)
block|{
name|pixel_region_get_col
argument_list|(
operator|&
name|PR
argument_list|,
name|x
argument_list|,
name|y1
argument_list|,
name|height
argument_list|,
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
operator|&&
operator|!
name|abort
condition|;
name|y
operator|++
control|)
name|abort
operator|=
operator|!
call|(
name|colors_equal_func
call|)
argument_list|(
name|bgcolor
argument_list|,
name|buffer
operator|+
name|y
operator|*
name|bytes
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
name|x1
operator|=
name|x
operator|-
literal|1
expr_stmt|;
comment|/* Check how many of the right lines are uniform/transparent. */
name|abort
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|x
operator|=
name|x2
init|;
name|x
operator|>
name|x1
operator|&&
operator|!
name|abort
condition|;
name|x
operator|--
control|)
block|{
name|pixel_region_get_col
argument_list|(
operator|&
name|PR
argument_list|,
name|x
operator|-
literal|1
argument_list|,
name|y1
argument_list|,
name|height
argument_list|,
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
operator|&&
operator|!
name|abort
condition|;
name|y
operator|++
control|)
name|abort
operator|=
operator|!
call|(
name|colors_equal_func
call|)
argument_list|(
name|bgcolor
argument_list|,
name|buffer
operator|+
name|y
operator|*
name|bytes
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
name|x2
operator|=
name|x
operator|+
literal|1
expr_stmt|;
name|crop
operator|->
name|tx1
operator|=
name|offset_x
operator|+
name|x1
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|offset_x
operator|+
name|x2
expr_stmt|;
name|crop
operator|->
name|ty1
operator|=
name|offset_y
operator|+
name|y1
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|offset_y
operator|+
name|y2
expr_stmt|;
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|FINISH
label|:
name|g_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|gimp_remove_busy_cursors
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gimp_draw_tool_resume
argument_list|(
name|draw
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|AutoCropType
DECL|function|crop_guess_bgcolor (GtkObject * get_color_obj,GetColorFunc get_color_func,gint bytes,gboolean has_alpha,guchar * color,gint x1,gint x2,gint y1,gint y2)
name|crop_guess_bgcolor
parameter_list|(
name|GtkObject
modifier|*
name|get_color_obj
parameter_list|,
name|GetColorFunc
name|get_color_func
parameter_list|,
name|gint
name|bytes
parameter_list|,
name|gboolean
name|has_alpha
parameter_list|,
name|guchar
modifier|*
name|color
parameter_list|,
name|gint
name|x1
parameter_list|,
name|gint
name|x2
parameter_list|,
name|gint
name|y1
parameter_list|,
name|gint
name|y2
parameter_list|)
block|{
name|guchar
modifier|*
name|tl
init|=
name|NULL
decl_stmt|;
name|guchar
modifier|*
name|tr
init|=
name|NULL
decl_stmt|;
name|guchar
modifier|*
name|bl
init|=
name|NULL
decl_stmt|;
name|guchar
modifier|*
name|br
init|=
name|NULL
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|alpha
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bytes
condition|;
name|i
operator|++
control|)
name|color
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
comment|/* First check if there's transparency to crop. If not, guess the     * background-color to see if at least 2 corners are equal.    */
if|if
condition|(
operator|!
operator|(
name|tl
operator|=
call|(
modifier|*
name|get_color_func
call|)
argument_list|(
name|get_color_obj
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|)
operator|)
condition|)
goto|goto
name|ERROR
goto|;
if|if
condition|(
operator|!
operator|(
name|tr
operator|=
call|(
modifier|*
name|get_color_func
call|)
argument_list|(
name|get_color_obj
argument_list|,
name|x1
argument_list|,
name|y2
argument_list|)
operator|)
condition|)
goto|goto
name|ERROR
goto|;
if|if
condition|(
operator|!
operator|(
name|bl
operator|=
call|(
modifier|*
name|get_color_func
call|)
argument_list|(
name|get_color_obj
argument_list|,
name|x2
argument_list|,
name|y1
argument_list|)
operator|)
condition|)
goto|goto
name|ERROR
goto|;
if|if
condition|(
operator|!
operator|(
name|br
operator|=
call|(
modifier|*
name|get_color_func
call|)
argument_list|(
name|get_color_obj
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
operator|)
condition|)
goto|goto
name|ERROR
goto|;
if|if
condition|(
name|has_alpha
condition|)
block|{
name|alpha
operator|=
name|bytes
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|tl
index|[
name|alpha
index|]
operator|==
literal|0
operator|&&
name|tr
index|[
name|alpha
index|]
operator|==
literal|0
operator|)
operator|||
operator|(
name|tl
index|[
name|alpha
index|]
operator|==
literal|0
operator|&&
name|bl
index|[
name|alpha
index|]
operator|==
literal|0
operator|)
operator|||
operator|(
name|tr
index|[
name|alpha
index|]
operator|==
literal|0
operator|&&
name|br
index|[
name|alpha
index|]
operator|==
literal|0
operator|)
operator|||
operator|(
name|bl
index|[
name|alpha
index|]
operator|==
literal|0
operator|&&
name|br
index|[
name|alpha
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|g_free
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tr
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|bl
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|br
argument_list|)
expr_stmt|;
return|return
name|AUTO_CROP_ALPHA
return|;
block|}
block|}
if|if
condition|(
name|crop_colors_equal
argument_list|(
name|tl
argument_list|,
name|tr
argument_list|,
name|bytes
argument_list|)
operator|||
name|crop_colors_equal
argument_list|(
name|tl
argument_list|,
name|bl
argument_list|,
name|bytes
argument_list|)
condition|)
name|memcpy
argument_list|(
name|color
argument_list|,
name|tl
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|crop_colors_equal
argument_list|(
name|br
argument_list|,
name|bl
argument_list|,
name|bytes
argument_list|)
operator|||
name|crop_colors_equal
argument_list|(
name|br
argument_list|,
name|tr
argument_list|,
name|bytes
argument_list|)
condition|)
name|memcpy
argument_list|(
name|color
argument_list|,
name|br
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
else|else
goto|goto
name|ERROR
goto|;
name|g_free
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tr
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|bl
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|br
argument_list|)
expr_stmt|;
return|return
name|AUTO_CROP_COLOR
return|;
name|ERROR
label|:
name|g_free
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tr
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|bl
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|br
argument_list|)
expr_stmt|;
return|return
name|AUTO_CROP_NOTHING
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|crop_colors_equal (guchar * col1,guchar * col2,gint bytes)
name|crop_colors_equal
parameter_list|(
name|guchar
modifier|*
name|col1
parameter_list|,
name|guchar
modifier|*
name|col2
parameter_list|,
name|gint
name|bytes
parameter_list|)
block|{
name|gboolean
name|equal
init|=
name|TRUE
decl_stmt|;
name|gint
name|b
decl_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bytes
condition|;
name|b
operator|++
control|)
block|{
if|if
condition|(
name|col1
index|[
name|b
index|]
operator|!=
name|col2
index|[
name|b
index|]
condition|)
block|{
name|equal
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
block|}
return|return
name|equal
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|crop_colors_alpha (guchar * dummy,guchar * col,gint bytes)
name|crop_colors_alpha
parameter_list|(
name|guchar
modifier|*
name|dummy
parameter_list|,
name|guchar
modifier|*
name|col
parameter_list|,
name|gint
name|bytes
parameter_list|)
block|{
if|if
condition|(
name|col
index|[
name|bytes
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_orig_changed (GtkWidget * widget,gpointer data)
name|crop_orig_changed
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|gint
name|ox
decl_stmt|;
name|gint
name|oy
decl_stmt|;
comment|/* XXX active_tool is bad */
name|tool
operator|=
name|active_tool
expr_stmt|;
if|if
condition|(
name|tool
operator|&&
name|GIMP_IS_CROP_TOOL
argument_list|(
name|tool
argument_list|)
condition|)
block|{
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|ox
operator|=
name|RINT
argument_list|(
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|oy
operator|=
name|RINT
argument_list|(
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ox
operator|!=
name|crop
operator|->
name|tx1
operator|)
operator|||
operator|(
name|oy
operator|!=
name|crop
operator|->
name|ty1
operator|)
condition|)
block|{
name|gimp_draw_tool_pause
argument_list|(
name|draw
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|crop
operator|->
name|tx2
operator|+
operator|(
name|ox
operator|-
name|crop
operator|->
name|tx1
operator|)
expr_stmt|;
name|crop
operator|->
name|tx1
operator|=
name|ox
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|crop
operator|->
name|ty2
operator|+
operator|(
name|oy
operator|-
name|crop
operator|->
name|ty1
operator|)
expr_stmt|;
name|crop
operator|->
name|ty1
operator|=
name|oy
expr_stmt|;
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|gimp_draw_tool_resume
argument_list|(
name|draw
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_size_changed (GtkWidget * widget,gpointer data)
name|crop_size_changed
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|gint
name|sx
decl_stmt|;
name|gint
name|sy
decl_stmt|;
comment|/* XXX active_tool is bad */
name|tool
operator|=
name|active_tool
expr_stmt|;
if|if
condition|(
name|tool
operator|&&
name|GIMP_IS_CROP_TOOL
argument_list|(
name|tool
argument_list|)
condition|)
block|{
name|crop
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|sx
operator|=
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sy
operator|=
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sx
operator|!=
operator|(
name|crop
operator|->
name|tx2
operator|-
name|crop
operator|->
name|tx1
operator|)
operator|)
operator|||
operator|(
name|sy
operator|!=
operator|(
name|crop
operator|->
name|ty2
operator|-
name|crop
operator|->
name|ty1
operator|)
operator|)
condition|)
block|{
name|gimp_draw_tool_pause
argument_list|(
name|draw
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|sx
operator|+
name|crop
operator|->
name|tx1
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|sy
operator|+
name|crop
operator|->
name|ty1
expr_stmt|;
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|gimp_draw_tool_resume
argument_list|(
name|draw
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|GtkType
DECL|function|gimp_crop_tool_get_type (void)
name|gimp_crop_tool_get_type
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|GtkType
name|tool_type
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|tool_type
condition|)
block|{
name|GtkTypeInfo
name|tool_info
init|=
block|{
literal|"GimpCropTool"
block|,
sizeof|sizeof
argument_list|(
name|GimpCropTool
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|GimpCropToolClass
argument_list|)
block|,
operator|(
name|GtkClassInitFunc
operator|)
name|gimp_crop_tool_class_init
block|,
operator|(
name|GtkObjectInitFunc
operator|)
name|gimp_crop_tool_init
block|,
comment|/* reserved_1 */
name|NULL
block|,
comment|/* reserved_2 */
name|NULL
block|,
operator|(
name|GtkClassInitFunc
operator|)
name|NULL
block|,         }
decl_stmt|;
name|tool_type
operator|=
name|gtk_type_unique
argument_list|(
name|GIMP_TYPE_DRAW_TOOL
argument_list|,
operator|&
name|tool_info
argument_list|)
expr_stmt|;
block|}
return|return
name|tool_type
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_crop_tool_class_init (GimpCropToolClass * klass)
name|gimp_crop_tool_class_init
parameter_list|(
name|GimpCropToolClass
modifier|*
name|klass
parameter_list|)
block|{
name|GtkObjectClass
modifier|*
name|object_class
decl_stmt|;
name|GimpToolClass
modifier|*
name|tool_class
decl_stmt|;
name|GimpDrawToolClass
modifier|*
name|draw_tool_class
decl_stmt|;
name|object_class
operator|=
operator|(
name|GtkObjectClass
operator|*
operator|)
name|klass
expr_stmt|;
name|tool_class
operator|=
operator|(
name|GimpToolClass
operator|*
operator|)
name|klass
expr_stmt|;
name|draw_tool_class
operator|=
operator|(
name|GimpDrawToolClass
operator|*
operator|)
name|klass
expr_stmt|;
name|parent_class
operator|=
name|gtk_type_class
argument_list|(
name|GIMP_TYPE_DRAW_TOOL
argument_list|)
expr_stmt|;
name|object_class
operator|->
name|destroy
operator|=
name|gimp_crop_tool_destroy
expr_stmt|;
name|tool_class
operator|->
name|control
operator|=
name|crop_tool_control
expr_stmt|;
name|tool_class
operator|->
name|button_press
operator|=
name|crop_tool_button_press
expr_stmt|;
name|tool_class
operator|->
name|button_release
operator|=
name|crop_tool_button_release
expr_stmt|;
name|tool_class
operator|->
name|motion
operator|=
name|crop_tool_motion
expr_stmt|;
name|tool_class
operator|->
name|cursor_update
operator|=
name|crop_tool_cursor_update
expr_stmt|;
name|tool_class
operator|->
name|arrow_key
operator|=
name|crop_tool_arrow_key
expr_stmt|;
name|tool_class
operator|->
name|modifier_key
operator|=
name|crop_tool_modifier_key
expr_stmt|;
name|draw_tool_class
operator|->
name|draw
operator|=
name|crop_tool_draw
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_crop_tool_init (GimpCropTool * crop_tool)
name|gimp_crop_tool_init
parameter_list|(
name|GimpCropTool
modifier|*
name|crop_tool
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|tool
operator|=
name|GIMP_TOOL
argument_list|(
name|crop_tool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|crop_options
condition|)
block|{
name|crop_options
operator|=
name|crop_options_new
argument_list|()
expr_stmt|;
name|tool_manager_register_tool_options
argument_list|(
name|GIMP_TYPE_CROP_TOOL
argument_list|,
operator|(
name|ToolOptions
operator|*
operator|)
name|crop_options
argument_list|)
expr_stmt|;
block|}
name|tool
operator|->
name|preserve
operator|=
name|FALSE
expr_stmt|;
comment|/*  Don't preserve on drawable change  */
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_crop_tool_destroy (GtkObject * object)
name|gimp_crop_tool_destroy
parameter_list|(
name|GtkObject
modifier|*
name|object
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpCropTool
modifier|*
name|crop_tool
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw
decl_stmt|;
name|tool
operator|=
name|GIMP_TOOL
argument_list|(
name|object
argument_list|)
expr_stmt|;
name|crop_tool
operator|=
name|GIMP_CROP_TOOL
argument_list|(
name|object
argument_list|)
expr_stmt|;
name|draw
operator|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
condition|)
name|gimp_draw_tool_stop
argument_list|(
name|draw
argument_list|)
expr_stmt|;
if|if
condition|(
name|crop_info
condition|)
block|{
name|info_dialog_free
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|crop_info
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|GTK_OBJECT_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|destroy
condition|)
name|GTK_OBJECT_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|destroy
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_crop_tool_register (void)
name|gimp_crop_tool_register
parameter_list|(
name|void
parameter_list|)
block|{
name|tool_manager_register_tool
argument_list|(
name|GIMP_TYPE_CROP_TOOL
argument_list|,
name|FALSE
argument_list|,
literal|"gimp:crop_tool"
argument_list|,
name|_
argument_list|(
literal|"Crop Tool"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Crop or Resize an image"
argument_list|)
argument_list|,
name|N_
argument_list|(
literal|"/Tools/Crop Tool"
argument_list|)
argument_list|,
literal|"<shift>C"
argument_list|,
name|NULL
argument_list|,
literal|"tools/crop_tool.html"
argument_list|,
operator|(
specifier|const
name|gchar
operator|*
operator|*
operator|)
name|crop_bits
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

