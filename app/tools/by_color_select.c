begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"boundary.h"
end_include

begin_include
include|#
directive|include
file|"by_color_select.h"
end_include

begin_include
include|#
directive|include
file|"colormaps.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"draw_core.h"
end_include

begin_include
include|#
directive|include
file|"general.h"
end_include

begin_include
include|#
directive|include
file|"gimage_mask.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"rect_select.h"
end_include

begin_define
DECL|macro|DEFAULT_FUZZINESS
define|#
directive|define
name|DEFAULT_FUZZINESS
value|15
end_define

begin_define
DECL|macro|PREVIEW_WIDTH
define|#
directive|define
name|PREVIEW_WIDTH
value|256
end_define

begin_define
DECL|macro|PREVIEW_HEIGHT
define|#
directive|define
name|PREVIEW_HEIGHT
value|256
end_define

begin_define
DECL|macro|PREVIEW_EVENT_MASK
define|#
directive|define
name|PREVIEW_EVENT_MASK
value|GDK_EXPOSURE_MASK | \                             GDK_BUTTON_PRESS_MASK | \                             GDK_ENTER_NOTIFY_MASK
end_define

begin_typedef
DECL|typedef|ByColorSelect
typedef|typedef
name|struct
name|_ByColorSelect
name|ByColorSelect
typedef|;
end_typedef

begin_struct
DECL|struct|_ByColorSelect
struct|struct
name|_ByColorSelect
block|{
DECL|member|x
DECL|member|y
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
comment|/*  Point from which to execute seed fill  */
DECL|member|operation
name|int
name|operation
decl_stmt|;
comment|/*  add, subtract, normal color selection  */
block|}
struct|;
end_struct

begin_typedef
DECL|typedef|ByColorDialog
typedef|typedef
name|struct
name|_ByColorDialog
name|ByColorDialog
typedef|;
end_typedef

begin_struct
DECL|struct|_ByColorDialog
struct|struct
name|_ByColorDialog
block|{
DECL|member|shell
name|GtkWidget
modifier|*
name|shell
decl_stmt|;
DECL|member|preview
name|GtkWidget
modifier|*
name|preview
decl_stmt|;
DECL|member|gimage_name
name|GtkWidget
modifier|*
name|gimage_name
decl_stmt|;
DECL|member|threshold
name|int
name|threshold
decl_stmt|;
comment|/*  threshold value for color select  */
DECL|member|operation
name|int
name|operation
decl_stmt|;
comment|/*  Add, Subtract, Replace  */
DECL|member|gimage
name|GImage
modifier|*
name|gimage
decl_stmt|;
comment|/*  gimage which is currently under examination  */
block|}
struct|;
end_struct

begin_comment
comment|/*  by_color select action functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|by_color_select_button_press
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_button_release
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_motion
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_cursor_update
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_control
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|int
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ByColorDialog
modifier|*
name|by_color_select_new_dialog
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_render
parameter_list|(
name|ByColorDialog
modifier|*
parameter_list|,
name|GImage
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_draw
parameter_list|(
name|ByColorDialog
modifier|*
parameter_list|,
name|GImage
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|by_color_select_preview_events
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|ByColorDialog
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_type_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_reset_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_close_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|by_color_select_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_fuzzy_update
parameter_list|(
name|GtkAdjustment
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select_preview_button_press
parameter_list|(
name|ByColorDialog
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|by_color_options
specifier|static
name|SelectionOptions
modifier|*
name|by_color_options
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|by_color_dialog
specifier|static
name|ByColorDialog
modifier|*
name|by_color_dialog
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|is_pixel_sufficiently_different
parameter_list|(
name|unsigned
name|char
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Channel
modifier|*
name|by_color_select_color
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|GimpDrawable
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|by_color_select
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|GimpDrawable
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|double
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|by_color_select_invoker
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  by_color selection machinery  */
end_comment

begin_function
specifier|static
name|int
DECL|function|is_pixel_sufficiently_different (unsigned char * col1,unsigned char * col2,int antialias,int threshold,int bytes,int has_alpha)
name|is_pixel_sufficiently_different
parameter_list|(
name|unsigned
name|char
modifier|*
name|col1
parameter_list|,
name|unsigned
name|char
modifier|*
name|col2
parameter_list|,
name|int
name|antialias
parameter_list|,
name|int
name|threshold
parameter_list|,
name|int
name|bytes
parameter_list|,
name|int
name|has_alpha
parameter_list|)
block|{
name|int
name|diff
decl_stmt|;
name|int
name|max
decl_stmt|;
name|int
name|b
decl_stmt|;
name|int
name|alpha
decl_stmt|;
name|max
operator|=
literal|0
expr_stmt|;
name|alpha
operator|=
operator|(
name|has_alpha
operator|)
condition|?
name|bytes
operator|-
literal|1
else|:
name|bytes
expr_stmt|;
comment|/*  if there is an alpha channel, never select transparent regions  */
if|if
condition|(
name|has_alpha
operator|&&
name|col2
index|[
name|alpha
index|]
operator|==
literal|0
condition|)
return|return
literal|0
return|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|alpha
condition|;
name|b
operator|++
control|)
block|{
name|diff
operator|=
name|col1
index|[
name|b
index|]
operator|-
name|col2
index|[
name|b
index|]
expr_stmt|;
name|diff
operator|=
name|abs
argument_list|(
name|diff
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff
operator|>
name|max
condition|)
name|max
operator|=
name|diff
expr_stmt|;
block|}
if|if
condition|(
name|antialias
operator|&&
name|threshold
operator|>
literal|0
condition|)
block|{
name|float
name|aa
decl_stmt|;
name|aa
operator|=
literal|1.5
operator|-
operator|(
operator|(
name|float
operator|)
name|max
operator|/
name|threshold
operator|)
expr_stmt|;
if|if
condition|(
name|aa
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|aa
operator|<
literal|0.5
condition|)
return|return
call|(
name|unsigned
name|char
call|)
argument_list|(
name|aa
operator|*
literal|512
argument_list|)
return|;
else|else
return|return
literal|255
return|;
block|}
else|else
block|{
if|if
condition|(
name|max
operator|>
name|threshold
condition|)
return|return
literal|0
return|;
else|else
return|return
literal|255
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|Channel
modifier|*
DECL|function|by_color_select_color (GImage * gimage,GimpDrawable * drawable,unsigned char * color,int antialias,int threshold,int sample_merged)
name|by_color_select_color
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|unsigned
name|char
modifier|*
name|color
parameter_list|,
name|int
name|antialias
parameter_list|,
name|int
name|threshold
parameter_list|,
name|int
name|sample_merged
parameter_list|)
block|{
comment|/*  Scan over the gimage's active layer, finding pixels within the specified    *  threshold from the given R, G,& B values.  If antialiasing is on,    *  use the same antialiasing scheme as in fuzzy_select.  Modify the gimage's    *  mask to reflect the additional selection    */
name|Channel
modifier|*
name|mask
decl_stmt|;
name|PixelRegion
name|imagePR
decl_stmt|,
name|maskPR
decl_stmt|;
name|unsigned
name|char
modifier|*
name|image_data
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mask_data
decl_stmt|;
name|unsigned
name|char
modifier|*
name|idata
decl_stmt|,
modifier|*
name|mdata
decl_stmt|;
name|unsigned
name|char
name|rgb
index|[
name|MAX_CHANNELS
index|]
decl_stmt|;
name|int
name|has_alpha
decl_stmt|,
name|indexed
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|bytes
decl_stmt|,
name|color_bytes
decl_stmt|,
name|alpha
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|void
modifier|*
name|pr
decl_stmt|;
name|int
name|d_type
decl_stmt|;
comment|/*  Get the image information  */
if|if
condition|(
name|sample_merged
condition|)
block|{
name|bytes
operator|=
name|gimage_composite_bytes
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|d_type
operator|=
name|gimage_composite_type
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|has_alpha
operator|=
operator|(
name|d_type
operator|==
name|RGBA_GIMAGE
operator|||
name|d_type
operator|==
name|GRAYA_GIMAGE
operator|||
name|d_type
operator|==
name|INDEXEDA_GIMAGE
operator|)
expr_stmt|;
name|indexed
operator|=
name|d_type
operator|==
name|INDEXEDA_GIMAGE
operator|||
name|d_type
operator|==
name|INDEXED_GIMAGE
expr_stmt|;
name|width
operator|=
name|gimage
operator|->
name|width
expr_stmt|;
name|height
operator|=
name|gimage
operator|->
name|height
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|imagePR
argument_list|,
name|gimage_composite
argument_list|(
name|gimage
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bytes
operator|=
name|drawable_bytes
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|d_type
operator|=
name|drawable_type
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|has_alpha
operator|=
name|drawable_has_alpha
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|indexed
operator|=
name|drawable_indexed
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|width
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|height
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|imagePR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|indexed
condition|)
block|{
comment|/* indexed colors are always RGB or RGBA */
name|color_bytes
operator|=
name|has_alpha
condition|?
literal|4
else|:
literal|3
expr_stmt|;
block|}
else|else
block|{
comment|/* RGB, RGBA, GRAY and GRAYA colors are shaped just like the image */
name|color_bytes
operator|=
name|bytes
expr_stmt|;
block|}
name|alpha
operator|=
name|bytes
operator|-
literal|1
expr_stmt|;
name|mask
operator|=
name|channel_new_mask
argument_list|(
name|gimage
operator|->
name|ID
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|maskPR
argument_list|,
name|drawable_data
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/*  iterate over the entire image  */
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|2
argument_list|,
operator|&
name|imagePR
argument_list|,
operator|&
name|maskPR
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
name|image_data
operator|=
name|imagePR
operator|.
name|data
expr_stmt|;
name|mask_data
operator|=
name|maskPR
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|imagePR
operator|.
name|h
condition|;
name|i
operator|++
control|)
block|{
name|idata
operator|=
name|image_data
expr_stmt|;
name|mdata
operator|=
name|mask_data
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|imagePR
operator|.
name|w
condition|;
name|j
operator|++
control|)
block|{
comment|/*  Get the rgb values for the color  */
name|gimage_get_color
argument_list|(
name|gimage
argument_list|,
name|d_type
argument_list|,
name|rgb
argument_list|,
name|idata
argument_list|)
expr_stmt|;
comment|/*  Plug the alpha channel in there  */
if|if
condition|(
name|has_alpha
condition|)
name|rgb
index|[
name|color_bytes
operator|-
literal|1
index|]
operator|=
name|idata
index|[
name|alpha
index|]
expr_stmt|;
comment|/*  Find how closely the colors match  */
operator|*
name|mdata
operator|++
operator|=
name|is_pixel_sufficiently_different
argument_list|(
name|color
argument_list|,
name|rgb
argument_list|,
name|antialias
argument_list|,
name|threshold
argument_list|,
name|color_bytes
argument_list|,
name|has_alpha
argument_list|)
expr_stmt|;
name|idata
operator|+=
name|bytes
expr_stmt|;
block|}
name|image_data
operator|+=
name|imagePR
operator|.
name|rowstride
expr_stmt|;
name|mask_data
operator|+=
name|maskPR
operator|.
name|rowstride
expr_stmt|;
block|}
block|}
return|return
name|mask
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select (GImage * gimage,GimpDrawable * drawable,unsigned char * color,int threshold,int op,int antialias,int feather,double feather_radius,int sample_merged)
name|by_color_select
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|unsigned
name|char
modifier|*
name|color
parameter_list|,
name|int
name|threshold
parameter_list|,
name|int
name|op
parameter_list|,
name|int
name|antialias
parameter_list|,
name|int
name|feather
parameter_list|,
name|double
name|feather_radius
parameter_list|,
name|int
name|sample_merged
parameter_list|)
block|{
name|Channel
modifier|*
name|new_mask
decl_stmt|;
name|int
name|off_x
decl_stmt|,
name|off_y
decl_stmt|;
if|if
condition|(
operator|!
name|drawable
condition|)
return|return;
name|new_mask
operator|=
name|by_color_select_color
argument_list|(
name|gimage
argument_list|,
name|drawable
argument_list|,
name|color
argument_list|,
name|antialias
argument_list|,
name|threshold
argument_list|,
name|sample_merged
argument_list|)
expr_stmt|;
comment|/*  if applicable, replace the current selection  */
if|if
condition|(
name|op
operator|==
name|REPLACE
condition|)
name|gimage_mask_clear
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
else|else
name|gimage_mask_undo
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample_merged
condition|)
block|{
name|off_x
operator|=
literal|0
expr_stmt|;
name|off_y
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|drawable_offsets
argument_list|(
name|drawable
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
if|if
condition|(
name|feather
condition|)
name|channel_feather
argument_list|(
name|new_mask
argument_list|,
name|gimage_get_mask
argument_list|(
name|gimage
argument_list|)
argument_list|,
name|feather_radius
argument_list|,
name|op
argument_list|,
name|off_x
argument_list|,
name|off_y
argument_list|)
expr_stmt|;
else|else
name|channel_combine_mask
argument_list|(
name|gimage_get_mask
argument_list|(
name|gimage
argument_list|)
argument_list|,
name|new_mask
argument_list|,
name|op
argument_list|,
name|off_x
argument_list|,
name|off_y
argument_list|)
expr_stmt|;
name|channel_delete
argument_list|(
name|new_mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  by_color select action functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|by_color_select_button_press (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|by_color_select_button_press
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|ByColorSelect
modifier|*
name|by_color_sel
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|by_color_sel
operator|=
operator|(
name|ByColorSelect
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
if|if
condition|(
operator|!
name|by_color_dialog
condition|)
return|return;
name|by_color_sel
operator|->
name|x
operator|=
name|bevent
operator|->
name|x
expr_stmt|;
name|by_color_sel
operator|->
name|y
operator|=
name|bevent
operator|->
name|y
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|ACTIVE
expr_stmt|;
name|tool
operator|->
name|gdisp_ptr
operator|=
name|gdisp_ptr
expr_stmt|;
comment|/*  Defaults  */
name|by_color_sel
operator|->
name|operation
operator|=
name|REPLACE
expr_stmt|;
comment|/*  Based on modifiers, and the "by color" dialog's selection mode  */
if|if
condition|(
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
operator|&&
operator|!
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
operator|)
condition|)
name|by_color_sel
operator|->
name|operation
operator|=
name|ADD
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
operator|)
operator|&&
operator|!
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
condition|)
name|by_color_sel
operator|->
name|operation
operator|=
name|SUB
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
operator|)
operator|&&
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
condition|)
name|by_color_sel
operator|->
name|operation
operator|=
name|INTERSECT
expr_stmt|;
else|else
name|by_color_sel
operator|->
name|operation
operator|=
name|by_color_dialog
operator|->
name|operation
expr_stmt|;
comment|/*  Make sure the "by color" select dialog is visible  */
if|if
condition|(
operator|!
name|GTK_WIDGET_VISIBLE
argument_list|(
name|by_color_dialog
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_show
argument_list|(
name|by_color_dialog
operator|->
name|shell
argument_list|)
expr_stmt|;
comment|/*  Update the by_color_dialog's active gdisp pointer  */
if|if
condition|(
name|by_color_dialog
operator|->
name|gimage
condition|)
name|by_color_dialog
operator|->
name|gimage
operator|->
name|by_color_select
operator|=
name|FALSE
expr_stmt|;
name|by_color_dialog
operator|->
name|gimage
operator|=
name|gdisp
operator|->
name|gimage
expr_stmt|;
name|gdisp
operator|->
name|gimage
operator|->
name|by_color_select
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_button_release (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|by_color_select_button_release
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|ByColorSelect
modifier|*
name|by_color_sel
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|Tile
modifier|*
name|tile
decl_stmt|;
name|unsigned
name|char
name|col
index|[
name|MAX_CHANNELS
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|use_offsets
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|by_color_sel
operator|=
operator|(
name|ByColorSelect
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
comment|/*  First take care of the case where the user "cancels" the action  */
if|if
condition|(
operator|!
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_BUTTON3_MASK
operator|)
condition|)
block|{
name|use_offsets
operator|=
operator|(
name|by_color_options
operator|->
name|sample_merged
operator|)
condition|?
name|FALSE
else|:
name|TRUE
expr_stmt|;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|by_color_sel
operator|->
name|x
argument_list|,
name|by_color_sel
operator|->
name|y
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|,
name|use_offsets
argument_list|)
expr_stmt|;
comment|/*  Get the start color  */
if|if
condition|(
name|by_color_options
operator|->
name|sample_merged
condition|)
block|{
if|if
condition|(
name|x
operator|<
literal|0
operator|||
name|y
operator|<
literal|0
operator|||
name|x
operator|>=
name|gdisp
operator|->
name|gimage
operator|->
name|width
operator|||
name|y
operator|>=
name|gdisp
operator|->
name|gimage
operator|->
name|height
condition|)
return|return;
name|tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|gimage_composite
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tile_ref
argument_list|(
name|tile
argument_list|)
expr_stmt|;
name|data
operator|=
name|tile
operator|->
name|data
operator|+
name|tile
operator|->
name|bpp
operator|*
operator|(
name|tile
operator|->
name|ewidth
operator|*
operator|(
name|y
operator|%
name|TILE_HEIGHT
operator|)
operator|+
operator|(
name|x
operator|%
name|TILE_WIDTH
operator|)
operator|)
expr_stmt|;
name|gimage_get_color
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|gimage_composite_type
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|,
name|col
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|tile_unref
argument_list|(
name|tile
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|x
operator|<
literal|0
operator|||
name|y
operator|<
literal|0
operator|||
name|x
operator|>=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|||
name|y
operator|>=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
condition|)
return|return;
name|tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tile_ref
argument_list|(
name|tile
argument_list|)
expr_stmt|;
name|data
operator|=
name|tile
operator|->
name|data
operator|+
name|tile
operator|->
name|bpp
operator|*
operator|(
name|tile
operator|->
name|ewidth
operator|*
operator|(
name|y
operator|%
name|TILE_HEIGHT
operator|)
operator|+
operator|(
name|x
operator|%
name|TILE_WIDTH
operator|)
operator|)
expr_stmt|;
name|gimage_get_color
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|drawable_type
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|col
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|tile_unref
argument_list|(
name|tile
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
comment|/*  select the area  */
name|by_color_select
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|drawable
argument_list|,
name|col
argument_list|,
name|by_color_dialog
operator|->
name|threshold
argument_list|,
name|by_color_sel
operator|->
name|operation
argument_list|,
name|by_color_options
operator|->
name|antialias
argument_list|,
name|by_color_options
operator|->
name|feather
argument_list|,
name|by_color_options
operator|->
name|feather_radius
argument_list|,
name|by_color_options
operator|->
name|sample_merged
argument_list|)
expr_stmt|;
comment|/*  show selection on all views  */
name|gdisplays_flush
argument_list|()
expr_stmt|;
comment|/*  update the preview window  */
name|by_color_select_render
argument_list|(
name|by_color_dialog
argument_list|,
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|by_color_select_draw
argument_list|(
name|by_color_dialog
argument_list|,
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_motion (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|by_color_select_motion
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_cursor_update (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|by_color_select_cursor_update
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|mevent
operator|->
name|x
argument_list|,
name|mevent
operator|->
name|y
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|layer
operator|=
name|gimage_pick_correlate_layer
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
operator|)
condition|)
if|if
condition|(
name|layer
operator|==
name|gdisp
operator|->
name|gimage
operator|->
name|active_layer
condition|)
block|{
name|gdisplay_install_tool_cursor
argument_list|(
name|gdisp
argument_list|,
name|GDK_TCROSS
argument_list|)
expr_stmt|;
return|return;
block|}
name|gdisplay_install_tool_cursor
argument_list|(
name|gdisp
argument_list|,
name|GDK_TOP_LEFT_ARROW
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_control (Tool * tool,int action,gpointer gdisp_ptr)
name|by_color_select_control
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|int
name|action
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|ByColorSelect
modifier|*
name|by_color_sel
decl_stmt|;
name|by_color_sel
operator|=
operator|(
name|ByColorSelect
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|PAUSE
case|:
break|break;
case|case
name|RESUME
case|:
break|break;
case|case
name|HALT
case|:
if|if
condition|(
name|by_color_dialog
condition|)
block|{
if|if
condition|(
name|by_color_dialog
operator|->
name|gimage
condition|)
name|by_color_dialog
operator|->
name|gimage
operator|->
name|by_color_select
operator|=
name|FALSE
expr_stmt|;
name|by_color_dialog
operator|->
name|gimage
operator|=
name|NULL
expr_stmt|;
name|by_color_select_close_callback
argument_list|(
name|NULL
argument_list|,
operator|(
name|gpointer
operator|)
name|by_color_dialog
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
name|Tool
modifier|*
DECL|function|tools_new_by_color_select ()
name|tools_new_by_color_select
parameter_list|()
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|ByColorSelect
modifier|*
name|private
decl_stmt|;
comment|/*  The tool options  */
if|if
condition|(
operator|!
name|by_color_options
condition|)
name|by_color_options
operator|=
name|create_selection_options
argument_list|(
name|BY_COLOR_SELECT
argument_list|)
expr_stmt|;
comment|/*  The "by color" dialog  */
if|if
condition|(
operator|!
name|by_color_dialog
condition|)
name|by_color_dialog
operator|=
name|by_color_select_new_dialog
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|GTK_WIDGET_VISIBLE
argument_list|(
name|by_color_dialog
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_show
argument_list|(
name|by_color_dialog
operator|->
name|shell
argument_list|)
expr_stmt|;
name|tool
operator|=
operator|(
name|Tool
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Tool
argument_list|)
argument_list|)
expr_stmt|;
name|private
operator|=
operator|(
name|ByColorSelect
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ByColorSelect
argument_list|)
argument_list|)
expr_stmt|;
name|tool
operator|->
name|type
operator|=
name|BY_COLOR_SELECT
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
name|tool
operator|->
name|scroll_lock
operator|=
literal|1
expr_stmt|;
comment|/*  Disallow scrolling  */
name|tool
operator|->
name|auto_snap_to
operator|=
name|TRUE
expr_stmt|;
name|tool
operator|->
name|private
operator|=
operator|(
name|void
operator|*
operator|)
name|private
expr_stmt|;
name|tool
operator|->
name|button_press_func
operator|=
name|by_color_select_button_press
expr_stmt|;
name|tool
operator|->
name|button_release_func
operator|=
name|by_color_select_button_release
expr_stmt|;
name|tool
operator|->
name|motion_func
operator|=
name|by_color_select_motion
expr_stmt|;
name|tool
operator|->
name|arrow_keys_func
operator|=
name|standard_arrow_keys_func
expr_stmt|;
name|tool
operator|->
name|cursor_update_func
operator|=
name|by_color_select_cursor_update
expr_stmt|;
name|tool
operator|->
name|control_func
operator|=
name|by_color_select_control
expr_stmt|;
return|return
name|tool
return|;
block|}
end_function

begin_function
name|void
DECL|function|tools_free_by_color_select (Tool * tool)
name|tools_free_by_color_select
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|)
block|{
name|ByColorSelect
modifier|*
name|by_color_sel
decl_stmt|;
name|by_color_sel
operator|=
operator|(
name|ByColorSelect
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
comment|/*  Close the color select dialog  */
if|if
condition|(
name|by_color_dialog
condition|)
block|{
if|if
condition|(
name|by_color_dialog
operator|->
name|gimage
condition|)
name|by_color_dialog
operator|->
name|gimage
operator|->
name|by_color_select
operator|=
name|FALSE
expr_stmt|;
name|by_color_select_close_callback
argument_list|(
name|NULL
argument_list|,
operator|(
name|gpointer
operator|)
name|by_color_dialog
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|by_color_sel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|by_color_select_initialize (void * gimage_ptr)
name|by_color_select_initialize
parameter_list|(
name|void
modifier|*
name|gimage_ptr
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|gimage
operator|=
operator|(
name|GImage
operator|*
operator|)
name|gimage_ptr
expr_stmt|;
comment|/*  update the preview window  */
if|if
condition|(
name|by_color_dialog
condition|)
block|{
name|by_color_dialog
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
name|gimage
operator|->
name|by_color_select
operator|=
name|TRUE
expr_stmt|;
name|by_color_select_render
argument_list|(
name|by_color_dialog
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|by_color_select_draw
argument_list|(
name|by_color_dialog
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  Select by Color dialog  */
end_comment

begin_comment
comment|/****************************/
end_comment

begin_function
name|ByColorDialog
modifier|*
DECL|function|by_color_select_new_dialog ()
name|by_color_select_new_dialog
parameter_list|()
block|{
name|ByColorDialog
modifier|*
name|bcd
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|options_box
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|util_box
decl_stmt|;
name|GtkWidget
modifier|*
name|push_button
decl_stmt|;
name|GtkWidget
modifier|*
name|slider
decl_stmt|;
name|GtkWidget
modifier|*
name|radio_box
decl_stmt|;
name|GtkWidget
modifier|*
name|radio_button
decl_stmt|;
name|GtkObject
modifier|*
name|data
decl_stmt|;
name|GSList
modifier|*
name|group
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|button_names
index|[
literal|4
index|]
init|=
block|{
literal|"Replace"
block|,
literal|"Add"
block|,
literal|"Subtract"
block|,
literal|"Intersect"
block|}
decl_stmt|;
name|int
name|button_values
index|[
literal|4
index|]
init|=
block|{
name|REPLACE
block|,
name|ADD
block|,
name|SUB
block|,
name|INTERSECT
block|}
decl_stmt|;
name|bcd
operator|=
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ByColorDialog
argument_list|)
argument_list|)
expr_stmt|;
name|bcd
operator|->
name|gimage
operator|=
name|NULL
expr_stmt|;
name|bcd
operator|->
name|operation
operator|=
name|REPLACE
expr_stmt|;
name|bcd
operator|->
name|threshold
operator|=
name|DEFAULT_FUZZINESS
expr_stmt|;
comment|/*  The shell and main vbox  */
name|bcd
operator|->
name|shell
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_wmclass
argument_list|(
name|GTK_WINDOW
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
argument_list|,
literal|"by_color_selection"
argument_list|,
literal|"Gimp"
argument_list|)
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
argument_list|,
literal|"By Color Selection"
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/*  handle the wm close signal */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
argument_list|,
literal|"delete_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|by_color_select_delete_callback
argument_list|,
name|bcd
argument_list|)
expr_stmt|;
comment|/*  The vbox */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  The horizontal box containing preview& options box */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  The preview  */
name|util_box
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|util_box
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bcd
operator|->
name|preview
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_GRAYSCALE
argument_list|)
expr_stmt|;
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|bcd
operator|->
name|preview
argument_list|)
argument_list|,
name|PREVIEW_WIDTH
argument_list|,
name|PREVIEW_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|bcd
operator|->
name|preview
argument_list|,
name|PREVIEW_EVENT_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|bcd
operator|->
name|preview
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|by_color_select_preview_events
argument_list|,
name|bcd
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|bcd
operator|->
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|bcd
operator|->
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|util_box
argument_list|)
expr_stmt|;
comment|/*  options box  */
name|options_box
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|options_box
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|options_box
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  Create the active brush label  */
name|util_box
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|options_box
argument_list|)
argument_list|,
name|util_box
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bcd
operator|->
name|gimage_name
operator|=
name|gtk_label_new
argument_list|(
literal|"Inactive"
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|bcd
operator|->
name|gimage_name
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|bcd
operator|->
name|gimage_name
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|util_box
argument_list|)
expr_stmt|;
comment|/*  Create the selection mode radio box  */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
literal|"Selection Mode"
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|options_box
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radio_box
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|radio_box
argument_list|)
expr_stmt|;
comment|/*  the radio buttons  */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|button_names
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|button_names
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|radio_button
operator|=
name|gtk_radio_button_new_with_label
argument_list|(
name|group
argument_list|,
name|button_names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|group
operator|=
name|gtk_radio_button_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|radio_button
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|radio_box
argument_list|)
argument_list|,
name|radio_button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|radio_button
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|by_color_select_type_callback
argument_list|,
call|(
name|gpointer
call|)
argument_list|(
operator|(
name|long
operator|)
name|button_values
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|radio_button
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_show
argument_list|(
name|radio_box
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
comment|/*  Create the opacity scale widget  */
name|util_box
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|options_box
argument_list|)
argument_list|,
name|util_box
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Fuzziness Threshold"
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator|=
name|gtk_adjustment_new
argument_list|(
name|bcd
operator|->
name|threshold
argument_list|,
literal|0.0
argument_list|,
literal|255.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|slider
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|slider
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_UPDATE_DELAYED
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|data
argument_list|)
argument_list|,
literal|"value_changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|by_color_select_fuzzy_update
argument_list|,
name|bcd
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|slider
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|util_box
argument_list|)
expr_stmt|;
comment|/*  The reset push button  */
name|push_button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Reset"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|push_button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|push_button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|push_button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|by_color_select_reset_callback
argument_list|,
name|bcd
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|push_button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|push_button
argument_list|)
expr_stmt|;
comment|/*  The close push button  */
name|push_button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Close"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|push_button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|push_button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|push_button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|by_color_select_close_callback
argument_list|,
name|bcd
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|push_button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options_box
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
expr_stmt|;
return|return
name|bcd
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_render (ByColorDialog * bcd,GImage * gimage)
name|by_color_select_render
parameter_list|(
name|ByColorDialog
modifier|*
name|bcd
parameter_list|,
name|GImage
modifier|*
name|gimage
parameter_list|)
block|{
name|Channel
modifier|*
name|mask
decl_stmt|;
name|MaskBuf
modifier|*
name|scaled_buf
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|PixelRegion
name|srcPR
decl_stmt|,
name|destPR
decl_stmt|;
name|unsigned
name|char
modifier|*
name|src
decl_stmt|;
name|int
name|subsample
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|srcwidth
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|scale
decl_stmt|;
name|mask
operator|=
name|gimage_get_mask
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|>
name|PREVIEW_WIDTH
operator|)
operator|||
operator|(
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|>
name|PREVIEW_HEIGHT
operator|)
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|float
operator|)
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|/
operator|(
name|float
operator|)
name|PREVIEW_WIDTH
operator|)
operator|>
operator|(
operator|(
name|float
operator|)
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|/
operator|(
name|float
operator|)
name|PREVIEW_HEIGHT
operator|)
condition|)
block|{
name|width
operator|=
name|PREVIEW_WIDTH
expr_stmt|;
name|height
operator|=
operator|(
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|*
name|PREVIEW_WIDTH
operator|)
operator|/
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|width
operator|=
operator|(
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|*
name|PREVIEW_HEIGHT
operator|)
operator|/
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|height
operator|=
name|PREVIEW_HEIGHT
expr_stmt|;
block|}
name|scale
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|width
operator|=
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|height
operator|=
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|scale
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|width
operator|!=
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|width
operator|)
operator|||
operator|(
name|height
operator|!=
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|height
operator|)
condition|)
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|bcd
operator|->
name|preview
argument_list|)
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
comment|/*  clear the image buf  */
name|buf
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|g_malloc
argument_list|(
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|width
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|width
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|height
condition|;
name|i
operator|++
control|)
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|bcd
operator|->
name|preview
argument_list|)
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|width
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/*  if the mask is empty, no need to scale and update again  */
if|if
condition|(
name|gimage_mask_is_empty
argument_list|(
name|gimage
argument_list|)
condition|)
return|return;
if|if
condition|(
name|scale
condition|)
block|{
comment|/*  calculate 'acceptable' subsample  */
name|subsample
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|width
operator|*
operator|(
name|subsample
operator|+
literal|1
operator|)
operator|*
literal|2
operator|<
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|)
operator|&&
operator|(
name|height
operator|*
operator|(
name|subsample
operator|+
literal|1
operator|)
operator|*
literal|2
operator|<
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|)
condition|)
name|subsample
operator|=
name|subsample
operator|+
literal|1
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|scaled_buf
operator|=
name|mask_buf_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|destPR
operator|.
name|bytes
operator|=
literal|1
expr_stmt|;
name|destPR
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|destPR
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|destPR
operator|.
name|w
operator|=
name|width
expr_stmt|;
name|destPR
operator|.
name|h
operator|=
name|height
expr_stmt|;
name|destPR
operator|.
name|rowstride
operator|=
name|srcPR
operator|.
name|bytes
operator|*
name|width
expr_stmt|;
name|destPR
operator|.
name|data
operator|=
name|mask_buf_data
argument_list|(
name|scaled_buf
argument_list|)
expr_stmt|;
name|destPR
operator|.
name|tiles
operator|=
name|NULL
expr_stmt|;
name|subsample_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|,
name|subsample
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|scaled_buf
operator|=
name|mask_buf_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|destPR
operator|.
name|bytes
operator|=
literal|1
expr_stmt|;
name|destPR
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|destPR
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|destPR
operator|.
name|w
operator|=
name|width
expr_stmt|;
name|destPR
operator|.
name|h
operator|=
name|height
expr_stmt|;
name|destPR
operator|.
name|rowstride
operator|=
name|srcPR
operator|.
name|bytes
operator|*
name|width
expr_stmt|;
name|destPR
operator|.
name|data
operator|=
name|mask_buf_data
argument_list|(
name|scaled_buf
argument_list|)
expr_stmt|;
name|destPR
operator|.
name|tiles
operator|=
name|NULL
expr_stmt|;
name|copy_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
block|}
name|src
operator|=
name|mask_buf_data
argument_list|(
name|scaled_buf
argument_list|)
expr_stmt|;
name|srcwidth
operator|=
name|scaled_buf
operator|->
name|width
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|height
condition|;
name|i
operator|++
control|)
block|{
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|bcd
operator|->
name|preview
argument_list|)
argument_list|,
name|src
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|src
operator|+=
name|srcwidth
expr_stmt|;
block|}
name|mask_buf_free
argument_list|(
name|scaled_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_draw (ByColorDialog * bcd,GImage * gimage)
name|by_color_select_draw
parameter_list|(
name|ByColorDialog
modifier|*
name|bcd
parameter_list|,
name|GImage
modifier|*
name|gimage
parameter_list|)
block|{
comment|/*  Draw the image buf to the preview window  */
name|gtk_widget_draw
argument_list|(
name|bcd
operator|->
name|preview
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  Update the gimage label to reflect the displayed gimage name  */
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|bcd
operator|->
name|gimage_name
argument_list|)
argument_list|,
name|prune_filename
argument_list|(
name|gimage_filename
argument_list|(
name|gimage
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|by_color_select_preview_events (GtkWidget * widget,GdkEventButton * bevent,ByColorDialog * bcd)
name|by_color_select_preview_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|ByColorDialog
modifier|*
name|bcd
parameter_list|)
block|{
switch|switch
condition|(
name|bevent
operator|->
name|type
condition|)
block|{
case|case
name|GDK_BUTTON_PRESS
case|:
name|by_color_select_preview_button_press
argument_list|(
name|bcd
argument_list|,
name|bevent
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_type_callback (GtkWidget * widget,gpointer client_data)
name|by_color_select_type_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
if|if
condition|(
name|by_color_dialog
condition|)
name|by_color_dialog
operator|->
name|operation
operator|=
operator|(
name|long
operator|)
name|client_data
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_reset_callback (GtkWidget * widget,gpointer client_data)
name|by_color_select_reset_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|ByColorDialog
modifier|*
name|bcd
decl_stmt|;
name|bcd
operator|=
operator|(
name|ByColorDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
operator|!
name|bcd
operator|->
name|gimage
condition|)
return|return;
comment|/*  reset the mask  */
name|gimage_mask_clear
argument_list|(
name|bcd
operator|->
name|gimage
argument_list|)
expr_stmt|;
comment|/*  show selection on all views  */
name|gdisplays_flush
argument_list|()
expr_stmt|;
comment|/*  update the preview window  */
name|by_color_select_render
argument_list|(
name|bcd
argument_list|,
name|bcd
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|by_color_select_draw
argument_list|(
name|bcd
argument_list|,
name|bcd
operator|->
name|gimage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|by_color_select_delete_callback (GtkWidget * w,GdkEvent * e,gpointer client_data)
name|by_color_select_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|GdkEvent
modifier|*
name|e
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|by_color_select_close_callback
argument_list|(
name|w
argument_list|,
name|client_data
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_close_callback (GtkWidget * widget,gpointer client_data)
name|by_color_select_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|ByColorDialog
modifier|*
name|bcd
decl_stmt|;
name|bcd
operator|=
operator|(
name|ByColorDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_hide
argument_list|(
name|bcd
operator|->
name|shell
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_fuzzy_update (GtkAdjustment * adjustment,gpointer data)
name|by_color_select_fuzzy_update
parameter_list|(
name|GtkAdjustment
modifier|*
name|adjustment
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ByColorDialog
modifier|*
name|bcd
decl_stmt|;
name|bcd
operator|=
operator|(
name|ByColorDialog
operator|*
operator|)
name|data
expr_stmt|;
name|bcd
operator|->
name|threshold
operator|=
operator|(
name|int
operator|)
name|adjustment
operator|->
name|value
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|by_color_select_preview_button_press (ByColorDialog * bcd,GdkEventButton * bevent)
name|by_color_select_preview_button_press
parameter_list|(
name|ByColorDialog
modifier|*
name|bcd
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|replace
decl_stmt|,
name|operation
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|Tile
modifier|*
name|tile
decl_stmt|;
name|unsigned
name|char
modifier|*
name|col
decl_stmt|;
if|if
condition|(
operator|!
name|bcd
operator|->
name|gimage
condition|)
return|return;
name|drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|bcd
operator|->
name|gimage
argument_list|)
expr_stmt|;
comment|/*  Defaults  */
name|replace
operator|=
name|FALSE
expr_stmt|;
name|operation
operator|=
name|REPLACE
expr_stmt|;
comment|/*  Based on modifiers, and the "by color" dialog's selection mode  */
if|if
condition|(
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
operator|&&
operator|!
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
operator|)
condition|)
name|operation
operator|=
name|ADD
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
operator|)
operator|&&
operator|!
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
condition|)
name|operation
operator|=
name|SUB
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
operator|)
operator|&&
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
condition|)
name|operation
operator|=
name|INTERSECT
expr_stmt|;
else|else
name|operation
operator|=
name|by_color_dialog
operator|->
name|operation
expr_stmt|;
comment|/*  Find x, y and modify selection  */
comment|/*  Get the start color  */
if|if
condition|(
name|by_color_options
operator|->
name|sample_merged
condition|)
block|{
name|x
operator|=
name|bcd
operator|->
name|gimage
operator|->
name|width
operator|*
name|bevent
operator|->
name|x
operator|/
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|width
expr_stmt|;
name|y
operator|=
name|bcd
operator|->
name|gimage
operator|->
name|height
operator|*
name|bevent
operator|->
name|y
operator|/
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|height
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
operator|||
name|y
operator|<
literal|0
operator|||
name|x
operator|>=
name|bcd
operator|->
name|gimage
operator|->
name|width
operator|||
name|y
operator|>=
name|bcd
operator|->
name|gimage
operator|->
name|height
condition|)
return|return;
name|tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|gimage_composite
argument_list|(
name|bcd
operator|->
name|gimage
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tile_ref
argument_list|(
name|tile
argument_list|)
expr_stmt|;
name|col
operator|=
name|tile
operator|->
name|data
operator|+
name|tile
operator|->
name|bpp
operator|*
operator|(
name|tile
operator|->
name|ewidth
operator|*
operator|(
name|y
operator|%
name|TILE_HEIGHT
operator|)
operator|+
operator|(
name|x
operator|%
name|TILE_WIDTH
operator|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|offx
decl_stmt|,
name|offy
decl_stmt|;
name|drawable_offsets
argument_list|(
name|drawable
argument_list|,
operator|&
name|offx
argument_list|,
operator|&
name|offy
argument_list|)
expr_stmt|;
name|x
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|*
name|bevent
operator|->
name|x
operator|/
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|width
operator|-
name|offx
expr_stmt|;
name|y
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|*
name|bevent
operator|->
name|y
operator|/
name|bcd
operator|->
name|preview
operator|->
name|requisition
operator|.
name|height
operator|-
name|offy
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
operator|||
name|y
operator|<
literal|0
operator|||
name|x
operator|>=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|||
name|y
operator|>=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
condition|)
return|return;
name|tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tile_ref
argument_list|(
name|tile
argument_list|)
expr_stmt|;
name|col
operator|=
name|tile
operator|->
name|data
operator|+
name|tile
operator|->
name|bpp
operator|*
operator|(
name|tile
operator|->
name|ewidth
operator|*
operator|(
name|y
operator|%
name|TILE_HEIGHT
operator|)
operator|+
operator|(
name|x
operator|%
name|TILE_WIDTH
operator|)
operator|)
expr_stmt|;
block|}
name|by_color_select
argument_list|(
name|bcd
operator|->
name|gimage
argument_list|,
name|drawable
argument_list|,
name|col
argument_list|,
name|bcd
operator|->
name|threshold
argument_list|,
name|operation
argument_list|,
name|by_color_options
operator|->
name|antialias
argument_list|,
name|by_color_options
operator|->
name|feather
argument_list|,
name|by_color_options
operator|->
name|feather_radius
argument_list|,
name|by_color_options
operator|->
name|sample_merged
argument_list|)
expr_stmt|;
name|tile_unref
argument_list|(
name|tile
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  show selection on all views  */
name|gdisplays_flush
argument_list|()
expr_stmt|;
comment|/*  update the preview window  */
name|by_color_select_render
argument_list|(
name|bcd
argument_list|,
name|bcd
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|by_color_select_draw
argument_list|(
name|bcd
argument_list|,
name|bcd
operator|->
name|gimage
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  The by_color_select procedure definition  */
end_comment

begin_decl_stmt
DECL|variable|by_color_select_args
name|ProcArg
name|by_color_select_args
index|[]
init|=
block|{
block|{
name|PDB_IMAGE
block|,
literal|"image"
block|,
literal|"the image"
block|}
block|,
block|{
name|PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"the drawable"
block|}
block|,
block|{
name|PDB_COLOR
block|,
literal|"color"
block|,
literal|"the color to select"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"threshold"
block|,
literal|"threshold in intensity levels: 0<= threshold<= 255"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"operation"
block|,
literal|"the selection operation: { ADD (0), SUB (1), REPLACE (2), INTERSECT (3) }"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"antialias"
block|,
literal|"antialiasing On/Off"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"feather"
block|,
literal|"feather option for selections"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"feather_radius"
block|,
literal|"radius for feather operation"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"sample_merged"
block|,
literal|"use the composite image, not the drawable"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|by_color_select_proc
name|ProcRecord
name|by_color_select_proc
init|=
block|{
literal|"gimp_by_color_select"
block|,
literal|"Create a selection by selecting all pixels (in the specified drawable) with the same (or similar) color to that specified."
block|,
literal|"This tool creates a selection over the specified image.  A by-color selection is determined by the supplied color under the constraints of the specified threshold.  Essentially, all pixels (in the drawable) that have color sufficiently close to the specified color (as determined by the threshold value) are included in the selection.  The antialiasing parameter allows the final selection mask to contain intermediate values based on close misses to the threshold bar.  Feathering can be enabled optionally and is controlled with the \"feather_radius\" paramter.  If the sample_merged parameter is non-zero, the data of the composite image will be used instead of that for the specified drawable.  This is equivalent to sampling for colors after merging all visible layers.  In the case of a merged sampling, the supplied drawable is ignored."
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1995-1996"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|9
block|,
name|by_color_select_args
block|,
comment|/*  Output arguments  */
literal|0
block|,
name|NULL
block|,
comment|/*  Exec method  */
block|{
block|{
name|by_color_select_invoker
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|by_color_select_invoker (Argument * args)
name|by_color_select_invoker
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|int
name|success
init|=
name|TRUE
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|int
name|op
decl_stmt|;
name|int
name|threshold
decl_stmt|;
name|int
name|antialias
decl_stmt|;
name|int
name|feather
decl_stmt|;
name|int
name|sample_merged
decl_stmt|;
name|unsigned
name|char
name|color
index|[
literal|3
index|]
decl_stmt|;
name|double
name|feather_radius
decl_stmt|;
name|int
name|int_value
decl_stmt|;
name|drawable
operator|=
name|NULL
expr_stmt|;
name|op
operator|=
name|REPLACE
expr_stmt|;
name|threshold
operator|=
literal|0
expr_stmt|;
comment|/*  the gimage  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|gimage_get_ID
argument_list|(
name|int_value
argument_list|)
operator|)
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  the drawable  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|drawable
operator|=
name|drawable_get_ID
argument_list|(
name|int_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|drawable
operator|==
name|NULL
operator|||
name|gimage
operator|!=
name|drawable_gimage
argument_list|(
name|drawable
argument_list|)
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  color  */
if|if
condition|(
name|success
condition|)
block|{
name|int
name|i
decl_stmt|;
name|unsigned
name|char
modifier|*
name|color_array
decl_stmt|;
name|color_array
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|color
index|[
name|i
index|]
operator|=
name|color_array
index|[
name|i
index|]
expr_stmt|;
block|}
comment|/*  threshold  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|int_value
operator|>=
literal|0
operator|&&
name|int_value
operator|<=
literal|255
condition|)
name|threshold
operator|=
name|int_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  operation  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|4
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
switch|switch
condition|(
name|int_value
condition|)
block|{
case|case
literal|0
case|:
name|op
operator|=
name|ADD
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|op
operator|=
name|SUB
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|op
operator|=
name|REPLACE
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|op
operator|=
name|INTERSECT
expr_stmt|;
break|break;
default|default:
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
comment|/*  antialiasing?  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|5
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|antialias
operator|=
operator|(
name|int_value
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
block|}
comment|/*  feathering  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|6
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|feather
operator|=
operator|(
name|int_value
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
block|}
comment|/*  feather radius  */
if|if
condition|(
name|success
condition|)
block|{
name|feather_radius
operator|=
name|args
index|[
literal|7
index|]
operator|.
name|value
operator|.
name|pdb_float
expr_stmt|;
block|}
comment|/*  sample merged  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|8
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|sample_merged
operator|=
operator|(
name|int_value
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
block|}
comment|/*  call the ellipse_select procedure  */
if|if
condition|(
name|success
condition|)
name|by_color_select
argument_list|(
name|gimage
argument_list|,
name|drawable
argument_list|,
name|color
argument_list|,
name|threshold
argument_list|,
name|op
argument_list|,
name|antialias
argument_list|,
name|feather
argument_list|,
name|feather_radius
argument_list|,
name|sample_merged
argument_list|)
expr_stmt|;
return|return
name|procedural_db_return_args
argument_list|(
operator|&
name|by_color_select_proc
argument_list|,
name|success
argument_list|)
return|;
block|}
end_function

end_unit

