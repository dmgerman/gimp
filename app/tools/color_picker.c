begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"actionarea.h"
end_include

begin_include
include|#
directive|include
file|"color_picker.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"info_dialog.h"
end_include

begin_include
include|#
directive|include
file|"palette.h"
end_include

begin_include
include|#
directive|include
file|"tools.h"
end_include

begin_include
include|#
directive|include
file|"tile.h"
end_include

begin_comment
comment|/* ick. */
end_comment

begin_comment
comment|/* maximum information buffer size */
end_comment

begin_define
DECL|macro|MAX_INFO_BUF
define|#
directive|define
name|MAX_INFO_BUF
value|8
end_define

begin_comment
comment|/*  local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|void
name|color_picker_button_press
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|color_picker_button_release
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|color_picker_motion
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|color_picker_cursor_update
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|color_picker_control
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|color_picker_info_window_close_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|get_color
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|GimpDrawable
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|color_picker_info_update
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|color_picker_invoker
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  local variables  */
end_comment

begin_decl_stmt
DECL|variable|col_value
specifier|static
name|int
name|col_value
index|[
literal|5
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|active_drawable
specifier|static
name|GimpDrawable
modifier|*
name|active_drawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|update_type
specifier|static
name|int
name|update_type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|sample_type
specifier|static
name|int
name|sample_type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|color_picker_info
specifier|static
name|InfoDialog
modifier|*
name|color_picker_info
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|red_buf
specifier|static
name|char
name|red_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|green_buf
specifier|static
name|char
name|green_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|blue_buf
specifier|static
name|char
name|blue_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|alpha_buf
specifier|static
name|char
name|alpha_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|index_buf
specifier|static
name|char
name|index_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gray_buf
specifier|static
name|char
name|gray_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|hex_buf
specifier|static
name|char
name|hex_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_typedef
DECL|typedef|ColorPickerOptions
typedef|typedef
name|struct
name|_ColorPickerOptions
name|ColorPickerOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_ColorPickerOptions
struct|struct
name|_ColorPickerOptions
block|{
DECL|member|sample_merged
name|int
name|sample_merged
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
DECL|variable|color_picker_options
specifier|static
name|ColorPickerOptions
modifier|*
name|color_picker_options
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|color_picker_toggle_update (GtkWidget * w,gpointer data)
name|color_picker_toggle_update
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
modifier|*
name|toggle_val
decl_stmt|;
name|toggle_val
operator|=
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|w
argument_list|)
operator|->
name|active
condition|)
operator|*
name|toggle_val
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|toggle_val
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ColorPickerOptions
modifier|*
DECL|function|create_color_picker_options (void)
name|create_color_picker_options
parameter_list|(
name|void
parameter_list|)
block|{
name|ColorPickerOptions
modifier|*
name|options
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|sample_merged_toggle
decl_stmt|;
comment|/*  the new options structure  */
name|options
operator|=
operator|(
name|ColorPickerOptions
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ColorPickerOptions
argument_list|)
argument_list|)
expr_stmt|;
name|options
operator|->
name|sample_merged
operator|=
literal|0
expr_stmt|;
comment|/*  the main vbox  */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/*  the main label  */
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Color Picker Options"
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/*  the sample merged toggle button  */
name|sample_merged_toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
literal|"Sample Merged"
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_state
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|sample_merged_toggle
argument_list|)
argument_list|,
name|options
operator|->
name|sample_merged
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|sample_merged_toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|sample_merged_toggle
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|color_picker_toggle_update
argument_list|,
operator|&
name|options
operator|->
name|sample_merged
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|sample_merged_toggle
argument_list|)
expr_stmt|;
comment|/*  Register this selection options widget with the main tools options dialog  */
name|tools_register_options
argument_list|(
name|COLOR_PICKER
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
return|return
name|options
return|;
block|}
end_function

begin_decl_stmt
DECL|variable|action_items
specifier|static
name|ActionAreaItem
name|action_items
index|[]
init|=
block|{
block|{
literal|"Close"
block|,
name|color_picker_info_window_close_callback
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|color_picker_button_press (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|color_picker_button_press
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
comment|/*  If this is the first invocation of the tool, or a different gdisplay,    *  create (or recreate) the info dialog...    */
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|INACTIVE
operator|||
name|gdisp_ptr
operator|!=
name|tool
operator|->
name|gdisp_ptr
operator|||
name|active_drawable
operator|!=
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
condition|)
block|{
comment|/*  if the dialog exists, free it  */
if|if
condition|(
name|color_picker_info
condition|)
name|info_dialog_free
argument_list|(
name|color_picker_info
argument_list|)
expr_stmt|;
name|color_picker_info
operator|=
name|info_dialog_new
argument_list|(
literal|"Color Picker"
argument_list|)
expr_stmt|;
name|active_drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
comment|/*  if the gdisplay is for a color image, the dialog must have RGB  */
switch|switch
condition|(
name|drawable_type
argument_list|(
name|active_drawable
argument_list|)
condition|)
block|{
case|case
name|RGB_GIMAGE
case|:
case|case
name|RGBA_GIMAGE
case|:
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Red"
argument_list|,
name|red_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Green"
argument_list|,
name|green_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Blue"
argument_list|,
name|blue_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Alpha"
argument_list|,
name|alpha_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Hex Triplet"
argument_list|,
name|hex_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|INDEXED_GIMAGE
case|:
case|case
name|INDEXEDA_GIMAGE
case|:
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Index"
argument_list|,
name|index_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Alpha"
argument_list|,
name|alpha_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Red"
argument_list|,
name|red_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Green"
argument_list|,
name|green_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Blue"
argument_list|,
name|blue_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Hex Triplet"
argument_list|,
name|hex_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|GRAY_GIMAGE
case|:
case|case
name|GRAYA_GIMAGE
case|:
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Intensity"
argument_list|,
name|gray_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Alpha"
argument_list|,
name|alpha_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|color_picker_info
argument_list|,
literal|"Hex Triplet"
argument_list|,
name|hex_buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
default|default :
break|break;
block|}
comment|/* Create the action area  */
name|action_items
index|[
literal|0
index|]
operator|.
name|user_data
operator|=
name|color_picker_info
expr_stmt|;
name|build_action_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|color_picker_info
operator|->
name|shell
argument_list|)
argument_list|,
name|action_items
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|gdk_pointer_grab
argument_list|(
name|gdisp
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|FALSE
argument_list|,
operator|(
name|GDK_POINTER_MOTION_HINT_MASK
operator||
name|GDK_BUTTON1_MOTION_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
operator|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
comment|/*  Make the tool active and set the gdisplay which owns it  */
name|tool
operator|->
name|gdisp_ptr
operator|=
name|gdisp_ptr
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|ACTIVE
expr_stmt|;
comment|/*  First, transform the coordinates to gimp image space  */
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  if the shift key is down, create a new color.    *  otherwise, modify the current color.    */
if|if
condition|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
name|color_picker_info_update
argument_list|(
name|tool
argument_list|,
name|get_color
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|active_drawable
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|color_picker_options
operator|->
name|sample_merged
argument_list|,
name|COLOR_NEW
argument_list|)
argument_list|)
expr_stmt|;
name|update_type
operator|=
name|COLOR_UPDATE_NEW
expr_stmt|;
block|}
else|else
block|{
name|color_picker_info_update
argument_list|(
name|tool
argument_list|,
name|get_color
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|active_drawable
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|color_picker_options
operator|->
name|sample_merged
argument_list|,
name|COLOR_UPDATE
argument_list|)
argument_list|)
expr_stmt|;
name|update_type
operator|=
name|COLOR_UPDATE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|color_picker_button_release (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|color_picker_button_release
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gdk_pointer_ungrab
argument_list|(
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
comment|/*  First, transform the coordinates to gimp image space  */
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|color_picker_info_update
argument_list|(
name|tool
argument_list|,
name|get_color
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|active_drawable
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|color_picker_options
operator|->
name|sample_merged
argument_list|,
name|update_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|color_picker_motion (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|color_picker_motion
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
comment|/*  First, transform the coordinates to gimp image space  */
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|mevent
operator|->
name|x
argument_list|,
name|mevent
operator|->
name|y
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|color_picker_info_update
argument_list|(
name|tool
argument_list|,
name|get_color
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|active_drawable
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|color_picker_options
operator|->
name|sample_merged
argument_list|,
name|update_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|color_picker_cursor_update (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|color_picker_cursor_update
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|mevent
operator|->
name|x
argument_list|,
name|mevent
operator|->
name|y
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimage_pick_correlate_layer
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
condition|)
name|gdisplay_install_tool_cursor
argument_list|(
name|gdisp
argument_list|,
name|GDK_TCROSS
argument_list|)
expr_stmt|;
else|else
name|gdisplay_install_tool_cursor
argument_list|(
name|gdisp
argument_list|,
name|GDK_TOP_LEFT_ARROW
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|color_picker_control (Tool * tool,int action,gpointer gdisp_ptr)
name|color_picker_control
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|int
name|action
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|int
DECL|function|get_color (GImage * gimage,GimpDrawable * drawable,int x,int y,int sample_merged,int final)
name|get_color
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|sample_merged
parameter_list|,
name|int
name|final
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|cmap
decl_stmt|,
name|alpha
decl_stmt|;
name|TileManager
modifier|*
name|tiles
decl_stmt|;
name|Tile
modifier|*
name|tile
decl_stmt|;
name|int
name|offx
decl_stmt|,
name|offy
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|bytes
decl_stmt|;
name|int
name|index
decl_stmt|;
name|int
name|has_alpha
decl_stmt|;
if|if
condition|(
operator|!
name|drawable
operator|&&
operator|!
name|sample_merged
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|sample_merged
condition|)
block|{
name|drawable_offsets
argument_list|(
name|drawable
argument_list|,
operator|&
name|offx
argument_list|,
operator|&
name|offy
argument_list|)
expr_stmt|;
name|x
operator|-=
name|offx
expr_stmt|;
name|y
operator|-=
name|offy
expr_stmt|;
name|width
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|height
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|tiles
operator|=
name|drawable_data
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|bytes
operator|=
name|drawable_bytes
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|has_alpha
operator|=
name|drawable_has_alpha
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|sample_type
operator|=
name|drawable_type
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|cmap
operator|=
name|drawable_cmap
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|width
operator|=
name|gimage
operator|->
name|width
expr_stmt|;
name|height
operator|=
name|gimage
operator|->
name|height
expr_stmt|;
name|tiles
operator|=
name|gimage_composite
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|bytes
operator|=
name|gimage_composite_bytes
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|sample_type
operator|=
name|gimage_composite_type
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|has_alpha
operator|=
operator|(
name|sample_type
operator|==
name|RGBA_GIMAGE
operator|||
name|sample_type
operator|==
name|GRAYA_GIMAGE
operator|||
name|sample_type
operator|==
name|INDEXEDA_GIMAGE
operator|)
expr_stmt|;
name|cmap
operator|=
name|gimage_cmap
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|>=
literal|0
operator|&&
name|y
operator|>=
literal|0
operator|&&
name|x
operator|<
name|width
operator|&&
name|y
operator|<
name|height
condition|)
block|{
name|tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|tiles
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|src
operator|=
name|tile_data_pointer
argument_list|(
name|tile
argument_list|,
name|x
operator|%
name|TILE_WIDTH
argument_list|,
name|y
operator|%
name|TILE_HEIGHT
argument_list|)
expr_stmt|;
block|}
else|else
return|return
name|FALSE
return|;
comment|/*  if the alpha channel (if one exists) is 0, out of bounds  */
if|if
condition|(
name|has_alpha
condition|)
block|{
name|alpha
operator|=
name|src
index|[
name|bytes
operator|-
literal|1
index|]
expr_stmt|;
name|col_value
index|[
name|ALPHA_PIX
index|]
operator|=
name|alpha
expr_stmt|;
block|}
comment|/*  If the image is color, get RGB  */
switch|switch
condition|(
name|sample_type
condition|)
block|{
case|case
name|RGB_GIMAGE
case|:
case|case
name|RGBA_GIMAGE
case|:
name|col_value
index|[
name|RED_PIX
index|]
operator|=
name|src
index|[
name|RED_PIX
index|]
expr_stmt|;
name|col_value
index|[
name|GREEN_PIX
index|]
operator|=
name|src
index|[
name|GREEN_PIX
index|]
expr_stmt|;
name|col_value
index|[
name|BLUE_PIX
index|]
operator|=
name|src
index|[
name|BLUE_PIX
index|]
expr_stmt|;
break|break;
case|case
name|INDEXED_GIMAGE
case|:
case|case
name|INDEXEDA_GIMAGE
case|:
name|col_value
index|[
literal|4
index|]
operator|=
name|src
index|[
literal|0
index|]
expr_stmt|;
name|index
operator|=
name|src
index|[
literal|0
index|]
operator|*
literal|3
expr_stmt|;
name|col_value
index|[
name|RED_PIX
index|]
operator|=
name|cmap
index|[
name|index
operator|+
literal|0
index|]
expr_stmt|;
name|col_value
index|[
name|GREEN_PIX
index|]
operator|=
name|cmap
index|[
name|index
operator|+
literal|1
index|]
expr_stmt|;
name|col_value
index|[
name|BLUE_PIX
index|]
operator|=
name|cmap
index|[
name|index
operator|+
literal|2
index|]
expr_stmt|;
break|break;
case|case
name|GRAY_GIMAGE
case|:
case|case
name|GRAYA_GIMAGE
case|:
name|col_value
index|[
name|RED_PIX
index|]
operator|=
name|src
index|[
name|GRAY_PIX
index|]
expr_stmt|;
name|col_value
index|[
name|GREEN_PIX
index|]
operator|=
name|src
index|[
name|GRAY_PIX
index|]
expr_stmt|;
name|col_value
index|[
name|BLUE_PIX
index|]
operator|=
name|src
index|[
name|GRAY_PIX
index|]
expr_stmt|;
break|break;
default|default :
break|break;
block|}
name|tile_release
argument_list|(
name|tile
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|palette_set_active_color
argument_list|(
name|col_value
index|[
name|RED_PIX
index|]
argument_list|,
name|col_value
index|[
name|GREEN_PIX
index|]
argument_list|,
name|col_value
index|[
name|BLUE_PIX
index|]
argument_list|,
name|final
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|color_picker_info_update (Tool * tool,int valid)
name|color_picker_info_update
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|int
name|valid
parameter_list|)
block|{
if|if
condition|(
operator|!
name|valid
condition|)
block|{
name|sprintf
argument_list|(
name|red_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|green_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|blue_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|alpha_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|index_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|gray_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|hex_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|sample_type
condition|)
block|{
case|case
name|RGB_GIMAGE
case|:
case|case
name|RGBA_GIMAGE
case|:
name|sprintf
argument_list|(
name|red_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|RED_PIX
index|]
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|green_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|GREEN_PIX
index|]
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|blue_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|BLUE_PIX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample_type
operator|==
name|RGBA_GIMAGE
condition|)
name|sprintf
argument_list|(
name|alpha_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|ALPHA_PIX
index|]
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|alpha_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|hex_buf
argument_list|,
literal|"#%.2x%.2x%.2x"
argument_list|,
name|col_value
index|[
name|RED_PIX
index|]
argument_list|,
name|col_value
index|[
name|GREEN_PIX
index|]
argument_list|,
name|col_value
index|[
name|BLUE_PIX
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|INDEXED_GIMAGE
case|:
case|case
name|INDEXEDA_GIMAGE
case|:
name|sprintf
argument_list|(
name|index_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample_type
operator|==
name|INDEXEDA_GIMAGE
condition|)
name|sprintf
argument_list|(
name|alpha_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|ALPHA_PIX
index|]
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|alpha_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|red_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|RED_PIX
index|]
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|green_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|GREEN_PIX
index|]
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|blue_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|BLUE_PIX
index|]
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|hex_buf
argument_list|,
literal|"#%.2x%.2x%.2x"
argument_list|,
name|col_value
index|[
name|RED_PIX
index|]
argument_list|,
name|col_value
index|[
name|GREEN_PIX
index|]
argument_list|,
name|col_value
index|[
name|BLUE_PIX
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|GRAY_GIMAGE
case|:
case|case
name|GRAYA_GIMAGE
case|:
name|sprintf
argument_list|(
name|gray_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|GRAY_PIX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample_type
operator|==
name|GRAYA_GIMAGE
condition|)
name|sprintf
argument_list|(
name|alpha_buf
argument_list|,
literal|"%d"
argument_list|,
name|col_value
index|[
name|ALPHA_PIX
index|]
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|alpha_buf
argument_list|,
literal|"N/A"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|hex_buf
argument_list|,
literal|"#%.2x%.2x%.2x"
argument_list|,
name|col_value
index|[
name|GRAY_PIX
index|]
argument_list|,
name|col_value
index|[
name|GRAY_PIX
index|]
argument_list|,
name|col_value
index|[
name|GRAY_PIX
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|info_dialog_update
argument_list|(
name|color_picker_info
argument_list|)
expr_stmt|;
name|info_dialog_popup
argument_list|(
name|color_picker_info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Tool
modifier|*
DECL|function|tools_new_color_picker ()
name|tools_new_color_picker
parameter_list|()
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
if|if
condition|(
operator|!
name|color_picker_options
condition|)
name|color_picker_options
operator|=
name|create_color_picker_options
argument_list|()
expr_stmt|;
name|tool
operator|=
operator|(
name|Tool
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Tool
argument_list|)
argument_list|)
expr_stmt|;
name|tool
operator|->
name|type
operator|=
name|COLOR_PICKER
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
name|tool
operator|->
name|scroll_lock
operator|=
literal|0
expr_stmt|;
comment|/*  Allow scrolling  */
name|tool
operator|->
name|auto_snap_to
operator|=
name|TRUE
expr_stmt|;
name|tool
operator|->
name|private
operator|=
name|NULL
expr_stmt|;
name|tool
operator|->
name|button_press_func
operator|=
name|color_picker_button_press
expr_stmt|;
name|tool
operator|->
name|button_release_func
operator|=
name|color_picker_button_release
expr_stmt|;
name|tool
operator|->
name|motion_func
operator|=
name|color_picker_motion
expr_stmt|;
name|tool
operator|->
name|arrow_keys_func
operator|=
name|standard_arrow_keys_func
expr_stmt|;
name|tool
operator|->
name|cursor_update_func
operator|=
name|color_picker_cursor_update
expr_stmt|;
name|tool
operator|->
name|control_func
operator|=
name|color_picker_control
expr_stmt|;
name|tool
operator|->
name|preserve
operator|=
name|TRUE
expr_stmt|;
return|return
name|tool
return|;
block|}
end_function

begin_function
name|void
DECL|function|tools_free_color_picker (Tool * tool)
name|tools_free_color_picker
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|)
block|{
if|if
condition|(
name|color_picker_info
condition|)
block|{
name|info_dialog_free
argument_list|(
name|color_picker_info
argument_list|)
expr_stmt|;
name|color_picker_info
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  The color_picker procedure definition  */
end_comment

begin_decl_stmt
DECL|variable|color_picker_args
name|ProcArg
name|color_picker_args
index|[]
init|=
block|{
block|{
name|PDB_IMAGE
block|,
literal|"image"
block|,
literal|"the image"
block|}
block|,
block|{
name|PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"the drawable"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"x"
block|,
literal|"x coordinate of upper-left corner of rectangle"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"y"
block|,
literal|"y coordinate of upper-left corner of rectangle"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"sample_merged"
block|,
literal|"use the composite image, not the drawable"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"save_color"
block|,
literal|"save the color to the active palette"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|color_picker_out_args
name|ProcArg
name|color_picker_out_args
index|[]
init|=
block|{
block|{
name|PDB_COLOR
block|,
literal|"color"
block|,
literal|"the return color"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|color_picker_proc
name|ProcRecord
name|color_picker_proc
init|=
block|{
literal|"gimp_color_picker"
block|,
literal|"Determine the color at the given drawable coordinates"
block|,
literal|"This tool determines the color at the specified coordinates.  The returned color is an RGB triplet even for grayscale and indexed drawables.  If the coordinates lie outside of the extents of the specified drawable, then an error is returned.  If the drawable has an alpha channel, the algorithm examines the alpha value of the drawable at the coordinates.  If the alpha value is completely transparent (0), then an error is returned.  If the sample_merged parameter is non-zero, the data of the composite image will be used instead of that for the specified drawable.  This is equivalent to sampling for colors after merging all visible layers.  In the case of a merged sampling, the supplied drawable is ignored."
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1995-1996"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|6
block|,
name|color_picker_args
block|,
comment|/*  Output arguments  */
literal|1
block|,
name|color_picker_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|color_picker_invoker
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|color_picker_invoker (Argument * args)
name|color_picker_invoker
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|int
name|success
init|=
name|TRUE
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|double
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|sample_merged
decl_stmt|;
name|int
name|save_color
decl_stmt|;
name|int
name|int_value
decl_stmt|;
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|unsigned
name|char
modifier|*
name|color
decl_stmt|;
name|drawable
operator|=
name|NULL
expr_stmt|;
name|x
operator|=
literal|0
expr_stmt|;
name|y
operator|=
literal|0
expr_stmt|;
name|sample_merged
operator|=
name|FALSE
expr_stmt|;
name|save_color
operator|=
name|COLOR_UPDATE
expr_stmt|;
comment|/*  the gimage  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
operator|(
name|gimage
operator|=
name|gimage_get_ID
argument_list|(
name|int_value
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  the drawable  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|drawable
operator|=
name|drawable_get_ID
argument_list|(
name|int_value
argument_list|)
expr_stmt|;
block|}
comment|/*  x, y  */
if|if
condition|(
name|success
condition|)
block|{
name|x
operator|=
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_float
expr_stmt|;
name|y
operator|=
name|args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_float
expr_stmt|;
block|}
comment|/*  sample_merged  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|4
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|sample_merged
operator|=
operator|(
name|int_value
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
block|}
comment|/*  save_color  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|5
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|save_color
operator|=
operator|(
name|int_value
operator|)
condition|?
name|COLOR_NEW
else|:
name|COLOR_UPDATE
expr_stmt|;
block|}
comment|/*  Make sure that if we're not using the composite, the specified drawable is valid  */
if|if
condition|(
name|success
operator|&&
operator|!
name|sample_merged
condition|)
if|if
condition|(
operator|!
name|drawable
operator|||
operator|(
name|drawable_gimage
argument_list|(
name|drawable
argument_list|)
operator|)
operator|!=
name|gimage
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
comment|/*  call the color_picker procedure  */
if|if
condition|(
name|success
condition|)
name|success
operator|=
name|get_color
argument_list|(
name|gimage
argument_list|,
name|drawable
argument_list|,
operator|(
name|int
operator|)
name|x
argument_list|,
operator|(
name|int
operator|)
name|y
argument_list|,
name|sample_merged
argument_list|,
name|save_color
argument_list|)
expr_stmt|;
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|color_picker_proc
argument_list|,
name|success
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
condition|)
block|{
name|color
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|g_malloc
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|color
index|[
name|RED_PIX
index|]
operator|=
name|col_value
index|[
name|RED_PIX
index|]
expr_stmt|;
name|color
index|[
name|GREEN_PIX
index|]
operator|=
name|col_value
index|[
name|GREEN_PIX
index|]
expr_stmt|;
name|color
index|[
name|BLUE_PIX
index|]
operator|=
name|col_value
index|[
name|BLUE_PIX
index|]
expr_stmt|;
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|color
expr_stmt|;
block|}
return|return
name|return_args
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|color_picker_info_window_close_callback (GtkWidget * w,gpointer client_data)
name|color_picker_info_window_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|info_dialog_popdown
argument_list|(
operator|(
name|InfoDialog
operator|*
operator|)
name|client_data
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

