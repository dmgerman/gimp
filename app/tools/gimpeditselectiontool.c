begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<gegl.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<gdk/gdkkeysyms.h>
end_include

begin_include
include|#
directive|include
file|"libgimpbase/gimpbase.h"
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"tools-types.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp-utils.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpboundary.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpgrouplayer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage-guides.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage-item-list.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage-undo.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpitem-linked.h"
end_include

begin_include
include|#
directive|include
file|"core/gimplayer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimplayermask.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpprojection.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpselection.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpundostack.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpwidgets-utils.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplay.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell-appearance.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell-selection.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell-transform.h"
end_include

begin_include
include|#
directive|include
file|"gimpdrawtool.h"
end_include

begin_include
include|#
directive|include
file|"gimpeditselectiontool.h"
end_include

begin_include
include|#
directive|include
file|"gimptoolcontrol.h"
end_include

begin_include
include|#
directive|include
file|"tool_manager.h"
end_include

begin_include
include|#
directive|include
file|"gimp-intl.h"
end_include

begin_define
DECL|macro|ARROW_VELOCITY
define|#
directive|define
name|ARROW_VELOCITY
value|25
end_define

begin_typedef
DECL|typedef|GimpEditSelectionTool
typedef|typedef
name|struct
name|_GimpEditSelectionTool
name|GimpEditSelectionTool
typedef|;
end_typedef

begin_typedef
DECL|typedef|GimpEditSelectionToolClass
typedef|typedef
name|struct
name|_GimpEditSelectionToolClass
name|GimpEditSelectionToolClass
typedef|;
end_typedef

begin_struct
DECL|struct|_GimpEditSelectionTool
struct|struct
name|_GimpEditSelectionTool
block|{
DECL|member|parent_instance
name|GimpDrawTool
name|parent_instance
decl_stmt|;
DECL|member|start_x
name|gdouble
name|start_x
decl_stmt|;
comment|/*  Coords where button was pressed   */
DECL|member|start_y
name|gdouble
name|start_y
decl_stmt|;
DECL|member|last_x
name|gint
name|last_x
decl_stmt|;
comment|/*  Last x and y coords               */
DECL|member|last_y
name|gint
name|last_y
decl_stmt|;
DECL|member|current_x
name|gint
name|current_x
decl_stmt|;
comment|/*  Current x and y coords            */
DECL|member|current_y
name|gint
name|current_y
decl_stmt|;
DECL|member|cuml_x
name|gint
name|cuml_x
decl_stmt|;
comment|/*  Cumulative changes to x and y     */
DECL|member|cuml_y
name|gint
name|cuml_y
decl_stmt|;
DECL|member|sel_x
name|gint
name|sel_x
decl_stmt|;
comment|/*  Bounding box of selection mask    */
DECL|member|sel_y
name|gint
name|sel_y
decl_stmt|;
comment|/*  Bounding box of selection mask    */
DECL|member|sel_width
name|gint
name|sel_width
decl_stmt|;
DECL|member|sel_height
name|gint
name|sel_height
decl_stmt|;
DECL|member|num_segs_in
name|gint
name|num_segs_in
decl_stmt|;
comment|/*  Num seg in selection boundary     */
DECL|member|num_segs_out
name|gint
name|num_segs_out
decl_stmt|;
comment|/*  Num seg in selection boundary     */
DECL|member|segs_in
name|GimpBoundSeg
modifier|*
name|segs_in
decl_stmt|;
comment|/*  Pointer to the channel sel. segs  */
DECL|member|segs_out
name|GimpBoundSeg
modifier|*
name|segs_out
decl_stmt|;
comment|/*  Pointer to the channel sel. segs  */
DECL|member|center_x
name|gdouble
name|center_x
decl_stmt|;
comment|/*  Where to draw the mark of center  */
DECL|member|center_y
name|gdouble
name|center_y
decl_stmt|;
DECL|member|edit_mode
name|GimpTranslateMode
name|edit_mode
decl_stmt|;
comment|/*  Translate the mask or layer?      */
DECL|member|live_items
name|GList
modifier|*
name|live_items
decl_stmt|;
comment|/*  Items that are transformed live   */
DECL|member|delayed_items
name|GList
modifier|*
name|delayed_items
decl_stmt|;
comment|/*  Items that are transformed later  */
DECL|member|first_move
name|gboolean
name|first_move
decl_stmt|;
comment|/*  Don't push undos after the first  */
DECL|member|propagate_release
name|gboolean
name|propagate_release
decl_stmt|;
DECL|member|constrain
name|gboolean
name|constrain
decl_stmt|;
comment|/*  Constrain the movement            */
DECL|member|last_motion_x
name|gdouble
name|last_motion_x
decl_stmt|;
comment|/*  Previous coords sent to _motion   */
DECL|member|last_motion_y
name|gdouble
name|last_motion_y
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
DECL|struct|_GimpEditSelectionToolClass
struct|struct
name|_GimpEditSelectionToolClass
block|{
DECL|member|parent_class
name|GimpDrawToolClass
name|parent_class
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|gimp_edit_selection_tool_finalize
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_edit_selection_tool_button_release
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
specifier|const
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpButtonReleaseType
name|release_type
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_edit_selection_tool_motion
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
specifier|const
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_edit_selection_tool_active_modifier_key
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkModifierType
name|key
parameter_list|,
name|gboolean
name|press
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_edit_selection_tool_draw
parameter_list|(
name|GimpDrawTool
modifier|*
name|tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GimpItem
modifier|*
name|gimp_edit_selection_tool_get_active_item
parameter_list|(
name|GimpEditSelectionTool
modifier|*
name|edit_select
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_edit_selection_tool_calc_coords
parameter_list|(
name|GimpEditSelectionTool
modifier|*
name|edit_select
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_edit_selection_tool_start_undo_group
parameter_list|(
name|GimpEditSelectionTool
modifier|*
name|edit_select
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|)
function_decl|;
end_function_decl

begin_macro
DECL|function|G_DEFINE_TYPE (GimpEditSelectionTool,gimp_edit_selection_tool,GIMP_TYPE_DRAW_TOOL)
name|G_DEFINE_TYPE
argument_list|(
argument|GimpEditSelectionTool
argument_list|,
argument|gimp_edit_selection_tool
argument_list|,
argument|GIMP_TYPE_DRAW_TOOL
argument_list|)
end_macro

begin_define
DECL|macro|parent_class
define|#
directive|define
name|parent_class
value|gimp_edit_selection_tool_parent_class
end_define

begin_function
specifier|static
name|void
name|gimp_edit_selection_tool_class_init
parameter_list|(
name|GimpEditSelectionToolClass
modifier|*
name|klass
parameter_list|)
block|{
name|GObjectClass
modifier|*
name|object_class
init|=
name|G_OBJECT_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|GimpToolClass
modifier|*
name|tool_class
init|=
name|GIMP_TOOL_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|GimpDrawToolClass
modifier|*
name|draw_class
init|=
name|GIMP_DRAW_TOOL_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|object_class
operator|->
name|finalize
operator|=
name|gimp_edit_selection_tool_finalize
expr_stmt|;
name|tool_class
operator|->
name|button_release
operator|=
name|gimp_edit_selection_tool_button_release
expr_stmt|;
name|tool_class
operator|->
name|motion
operator|=
name|gimp_edit_selection_tool_motion
expr_stmt|;
name|tool_class
operator|->
name|active_modifier_key
operator|=
name|gimp_edit_selection_tool_active_modifier_key
expr_stmt|;
name|draw_class
operator|->
name|draw
operator|=
name|gimp_edit_selection_tool_draw
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_init (GimpEditSelectionTool * edit_select)
name|gimp_edit_selection_tool_init
parameter_list|(
name|GimpEditSelectionTool
modifier|*
name|edit_select
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
init|=
name|GIMP_TOOL
argument_list|(
name|edit_select
argument_list|)
decl_stmt|;
name|edit_select
operator|->
name|first_move
operator|=
name|TRUE
expr_stmt|;
name|gimp_tool_control_set_active_modifiers
argument_list|(
name|tool
operator|->
name|control
argument_list|,
name|GIMP_TOOL_ACTIVE_MODIFIERS_SEPARATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_finalize (GObject * object)
name|gimp_edit_selection_tool_finalize
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
block|{
name|GimpEditSelectionTool
modifier|*
name|edit_select
init|=
name|GIMP_EDIT_SELECTION_TOOL
argument_list|(
name|object
argument_list|)
decl_stmt|;
if|if
condition|(
name|edit_select
operator|->
name|segs_in
condition|)
block|{
name|g_free
argument_list|(
name|edit_select
operator|->
name|segs_in
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|segs_in
operator|=
name|NULL
expr_stmt|;
name|edit_select
operator|->
name|num_segs_in
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|edit_select
operator|->
name|segs_out
condition|)
block|{
name|g_free
argument_list|(
name|edit_select
operator|->
name|segs_out
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|segs_out
operator|=
name|NULL
expr_stmt|;
name|edit_select
operator|->
name|num_segs_out
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|edit_select
operator|->
name|live_items
condition|)
block|{
name|g_list_free
argument_list|(
name|edit_select
operator|->
name|live_items
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|live_items
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|edit_select
operator|->
name|delayed_items
condition|)
block|{
name|g_list_free
argument_list|(
name|edit_select
operator|->
name|delayed_items
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|delayed_items
operator|=
name|NULL
expr_stmt|;
block|}
name|G_OBJECT_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|finalize
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_edit_selection_tool_start (GimpTool * parent_tool,GimpDisplay * display,const GimpCoords * coords,GimpTranslateMode edit_mode,gboolean propagate_release)
name|gimp_edit_selection_tool_start
parameter_list|(
name|GimpTool
modifier|*
name|parent_tool
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|,
specifier|const
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|GimpTranslateMode
name|edit_mode
parameter_list|,
name|gboolean
name|propagate_release
parameter_list|)
block|{
name|GimpEditSelectionTool
modifier|*
name|edit_select
decl_stmt|;
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|GimpImage
modifier|*
name|image
decl_stmt|;
name|GimpItem
modifier|*
name|active_item
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|off_x
decl_stmt|,
name|off_y
decl_stmt|;
name|edit_select
operator|=
name|g_object_new
argument_list|(
name|GIMP_TYPE_EDIT_SELECTION_TOOL
argument_list|,
literal|"tool-info"
argument_list|,
name|parent_tool
operator|->
name|tool_info
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|propagate_release
operator|=
name|propagate_release
expr_stmt|;
name|tool
operator|=
name|GIMP_TOOL
argument_list|(
name|edit_select
argument_list|)
expr_stmt|;
name|shell
operator|=
name|gimp_display_get_shell
argument_list|(
name|display
argument_list|)
expr_stmt|;
name|image
operator|=
name|gimp_display_get_image
argument_list|(
name|display
argument_list|)
expr_stmt|;
comment|/*  Make a check to see if it should be a floating selection translation  */
if|if
condition|(
operator|(
name|edit_mode
operator|==
name|GIMP_TRANSLATE_MODE_MASK_TO_LAYER
operator|||
name|edit_mode
operator|==
name|GIMP_TRANSLATE_MODE_MASK_COPY_TO_LAYER
operator|)
operator|&&
name|gimp_image_get_floating_selection
argument_list|(
name|image
argument_list|)
condition|)
block|{
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
expr_stmt|;
block|}
if|if
condition|(
name|edit_mode
operator|==
name|GIMP_TRANSLATE_MODE_LAYER
condition|)
block|{
name|GimpLayer
modifier|*
name|layer
init|=
name|gimp_image_get_active_layer
argument_list|(
name|image
argument_list|)
decl_stmt|;
if|if
condition|(
name|gimp_layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
expr_stmt|;
block|}
name|edit_select
operator|->
name|edit_mode
operator|=
name|edit_mode
expr_stmt|;
name|gimp_edit_selection_tool_start_undo_group
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|)
expr_stmt|;
comment|/* Remember starting point for use in constrained movement */
name|edit_select
operator|->
name|start_x
operator|=
name|coords
operator|->
name|x
expr_stmt|;
name|edit_select
operator|->
name|start_y
operator|=
name|coords
operator|->
name|y
expr_stmt|;
name|active_item
operator|=
name|gimp_edit_selection_tool_get_active_item
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gimp_item_get_offset
argument_list|(
name|active_item
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
comment|/* Manually set the last coords to the starting point */
name|edit_select
operator|->
name|last_x
operator|=
name|coords
operator|->
name|x
operator|-
name|off_x
expr_stmt|;
name|edit_select
operator|->
name|last_y
operator|=
name|coords
operator|->
name|y
operator|-
name|off_y
expr_stmt|;
name|edit_select
operator|->
name|constrain
operator|=
name|FALSE
expr_stmt|;
comment|/* Find the active item's selection bounds */
block|{
name|GimpChannel
modifier|*
name|channel
decl_stmt|;
specifier|const
name|GimpBoundSeg
modifier|*
name|segs_in
decl_stmt|;
specifier|const
name|GimpBoundSeg
modifier|*
name|segs_out
decl_stmt|;
if|if
condition|(
name|GIMP_IS_CHANNEL
argument_list|(
name|active_item
argument_list|)
condition|)
name|channel
operator|=
name|GIMP_CHANNEL
argument_list|(
name|active_item
argument_list|)
expr_stmt|;
else|else
name|channel
operator|=
name|gimp_image_get_mask
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|gimp_channel_boundary
argument_list|(
name|channel
argument_list|,
operator|&
name|segs_in
argument_list|,
operator|&
name|segs_out
argument_list|,
operator|&
name|edit_select
operator|->
name|num_segs_in
argument_list|,
operator|&
name|edit_select
operator|->
name|num_segs_out
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|segs_in
operator|=
name|g_memdup
argument_list|(
name|segs_in
argument_list|,
name|edit_select
operator|->
name|num_segs_in
operator|*
sizeof|sizeof
argument_list|(
name|GimpBoundSeg
argument_list|)
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|segs_out
operator|=
name|g_memdup
argument_list|(
name|segs_out
argument_list|,
name|edit_select
operator|->
name|num_segs_out
operator|*
sizeof|sizeof
argument_list|(
name|GimpBoundSeg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|edit_select
operator|->
name|edit_mode
operator|==
name|GIMP_TRANSLATE_MODE_VECTORS
condition|)
block|{
name|edit_select
operator|->
name|sel_x
operator|=
literal|0
expr_stmt|;
name|edit_select
operator|->
name|sel_y
operator|=
literal|0
expr_stmt|;
name|edit_select
operator|->
name|sel_width
operator|=
name|gimp_image_get_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|sel_height
operator|=
name|gimp_image_get_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*  find the bounding box of the selection mask - this is used          *  for the case of a GIMP_TRANSLATE_MODE_MASK_TO_LAYER, where          *  the translation will result in floating the selection mask          *  and translating the resulting layer          */
name|gimp_item_mask_intersect
argument_list|(
name|active_item
argument_list|,
operator|&
name|edit_select
operator|->
name|sel_x
argument_list|,
operator|&
name|edit_select
operator|->
name|sel_y
argument_list|,
operator|&
name|edit_select
operator|->
name|sel_width
argument_list|,
operator|&
name|edit_select
operator|->
name|sel_height
argument_list|)
expr_stmt|;
block|}
block|}
name|gimp_edit_selection_tool_calc_coords
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|,
name|coords
operator|->
name|x
argument_list|,
name|coords
operator|->
name|y
argument_list|)
expr_stmt|;
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
switch|switch
condition|(
name|edit_select
operator|->
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_CHANNEL
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK
case|:
case|case
name|GIMP_TRANSLATE_MODE_LAYER_MASK
case|:
name|gimp_item_bounds
argument_list|(
name|active_item
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
name|x
operator|+=
name|off_x
expr_stmt|;
name|y
operator|+=
name|off_y
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_MASK_TO_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK_COPY_TO_LAYER
case|:
name|x
operator|=
name|edit_select
operator|->
name|sel_x
operator|+
name|off_x
expr_stmt|;
name|y
operator|=
name|edit_select
operator|->
name|sel_y
operator|+
name|off_y
expr_stmt|;
name|w
operator|=
name|edit_select
operator|->
name|sel_width
expr_stmt|;
name|h
operator|=
name|edit_select
operator|->
name|sel_height
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
case|:
case|case
name|GIMP_TRANSLATE_MODE_VECTORS
case|:
if|if
condition|(
name|gimp_item_get_linked
argument_list|(
name|active_item
argument_list|)
condition|)
block|{
name|GList
modifier|*
name|linked
decl_stmt|;
name|linked
operator|=
name|gimp_image_item_list_get_list
argument_list|(
name|image
argument_list|,
name|GIMP_IS_LAYER
argument_list|(
name|active_item
argument_list|)
condition|?
name|GIMP_ITEM_TYPE_LAYERS
else|:
name|GIMP_ITEM_TYPE_VECTORS
argument_list|,
name|GIMP_ITEM_SET_LINKED
argument_list|)
expr_stmt|;
name|linked
operator|=
name|gimp_image_item_list_filter
argument_list|(
name|linked
argument_list|)
expr_stmt|;
name|gimp_image_item_list_bounds
argument_list|(
name|image
argument_list|,
name|linked
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
name|g_list_free
argument_list|(
name|linked
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_item_bounds
argument_list|(
name|active_item
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
name|x
operator|+=
name|off_x
expr_stmt|;
name|y
operator|+=
name|off_y
expr_stmt|;
block|}
break|break;
block|}
name|gimp_tool_control_set_snap_offsets
argument_list|(
name|tool
operator|->
name|control
argument_list|,
name|x
operator|-
name|coords
operator|->
name|x
argument_list|,
name|y
operator|-
name|coords
operator|->
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
comment|/* Save where to draw the mark of the center */
name|edit_select
operator|->
name|center_x
operator|=
name|x
operator|+
name|w
operator|/
literal|2.0
expr_stmt|;
name|edit_select
operator|->
name|center_y
operator|=
name|y
operator|+
name|h
operator|/
literal|2.0
expr_stmt|;
block|}
if|if
condition|(
name|gimp_item_get_linked
argument_list|(
name|active_item
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|edit_select
operator|->
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_CHANNEL
case|:
case|case
name|GIMP_TRANSLATE_MODE_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_VECTORS
case|:
name|edit_select
operator|->
name|live_items
operator|=
name|gimp_image_item_list_get_list
argument_list|(
name|image
argument_list|,
name|GIMP_ITEM_TYPE_LAYERS
operator||
name|GIMP_ITEM_TYPE_VECTORS
argument_list|,
name|GIMP_ITEM_SET_LINKED
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|live_items
operator|=
name|gimp_image_item_list_filter
argument_list|(
name|edit_select
operator|->
name|live_items
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|delayed_items
operator|=
name|gimp_image_item_list_get_list
argument_list|(
name|image
argument_list|,
name|GIMP_ITEM_TYPE_CHANNELS
argument_list|,
name|GIMP_ITEM_SET_LINKED
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|delayed_items
operator|=
name|gimp_image_item_list_filter
argument_list|(
name|edit_select
operator|->
name|delayed_items
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* other stuff can't be linked so don't bother */
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|edit_select
operator|->
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_VECTORS
case|:
case|case
name|GIMP_TRANSLATE_MODE_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
case|:
name|edit_select
operator|->
name|live_items
operator|=
name|g_list_append
argument_list|(
name|NULL
argument_list|,
name|active_item
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_CHANNEL
case|:
case|case
name|GIMP_TRANSLATE_MODE_LAYER_MASK
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK
case|:
name|edit_select
operator|->
name|delayed_items
operator|=
name|g_list_append
argument_list|(
name|NULL
argument_list|,
name|active_item
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* MASK_TO_LAYER and MASK_COPY_TO_LAYER create a live_item later */
break|break;
block|}
block|}
for|for
control|(
name|list
operator|=
name|edit_select
operator|->
name|live_items
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
name|gimp_item_start_move
argument_list|(
name|GIMP_ITEM
argument_list|(
name|list
operator|->
name|data
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|tool_manager_push_tool
argument_list|(
name|display
operator|->
name|gimp
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|gimp_tool_control_activate
argument_list|(
name|tool
operator|->
name|control
argument_list|)
expr_stmt|;
name|tool
operator|->
name|display
operator|=
name|display
expr_stmt|;
comment|/*  pause the current selection  */
name|gimp_display_shell_selection_pause
argument_list|(
name|shell
argument_list|)
expr_stmt|;
comment|/* initialize the statusbar display */
name|gimp_tool_push_status_coords
argument_list|(
name|tool
argument_list|,
name|display
argument_list|,
name|gimp_tool_control_get_precision
argument_list|(
name|tool
operator|->
name|control
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Move: "
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|", "
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_draw_tool_start
argument_list|(
name|GIMP_DRAW_TOOL
argument_list|(
name|edit_select
argument_list|)
argument_list|,
name|display
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_button_release (GimpTool * tool,const GimpCoords * coords,guint32 time,GdkModifierType state,GimpButtonReleaseType release_type,GimpDisplay * display)
name|gimp_edit_selection_tool_button_release
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
specifier|const
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpButtonReleaseType
name|release_type
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
block|{
name|GimpEditSelectionTool
modifier|*
name|edit_select
init|=
name|GIMP_EDIT_SELECTION_TOOL
argument_list|(
name|tool
argument_list|)
decl_stmt|;
name|GimpDisplayShell
modifier|*
name|shell
init|=
name|gimp_display_get_shell
argument_list|(
name|display
argument_list|)
decl_stmt|;
name|GimpImage
modifier|*
name|image
init|=
name|gimp_display_get_image
argument_list|(
name|display
argument_list|)
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
comment|/*  resume the current selection  */
name|gimp_display_shell_selection_resume
argument_list|(
name|shell
argument_list|)
expr_stmt|;
name|gimp_tool_pop_status
argument_list|(
name|tool
argument_list|,
name|display
argument_list|)
expr_stmt|;
name|gimp_tool_control_halt
argument_list|(
name|tool
operator|->
name|control
argument_list|)
expr_stmt|;
comment|/*  Stop and free the selection core  */
name|gimp_draw_tool_stop
argument_list|(
name|GIMP_DRAW_TOOL
argument_list|(
name|edit_select
argument_list|)
argument_list|)
expr_stmt|;
name|tool_manager_pop_tool
argument_list|(
name|display
operator|->
name|gimp
argument_list|)
expr_stmt|;
comment|/* move the items -- whether there has been movement or not!    * (to ensure that there's something on the undo stack)    */
name|gimp_image_item_list_translate
argument_list|(
name|image
argument_list|,
name|edit_select
operator|->
name|delayed_items
argument_list|,
name|edit_select
operator|->
name|cuml_x
argument_list|,
name|edit_select
operator|->
name|cuml_y
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|list
operator|=
name|edit_select
operator|->
name|live_items
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
name|gimp_item_end_move
argument_list|(
name|GIMP_ITEM
argument_list|(
name|list
operator|->
name|data
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_image_undo_group_end
argument_list|(
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
name|release_type
operator|==
name|GIMP_BUTTON_RELEASE_CANCEL
condition|)
block|{
comment|/* Operation cancelled - undo the undo-group! */
name|gimp_image_undo
argument_list|(
name|image
argument_list|)
expr_stmt|;
block|}
name|gimp_image_flush
argument_list|(
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
name|edit_select
operator|->
name|propagate_release
operator|&&
name|tool_manager_get_active
argument_list|(
name|display
operator|->
name|gimp
argument_list|)
condition|)
block|{
name|tool_manager_button_release_active
argument_list|(
name|display
operator|->
name|gimp
argument_list|,
name|coords
argument_list|,
name|time
argument_list|,
name|state
argument_list|,
name|display
argument_list|)
expr_stmt|;
block|}
name|g_object_unref
argument_list|(
name|edit_select
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_update_motion (GimpEditSelectionTool * edit_select,gdouble new_x,gdouble new_y,GimpDisplay * display)
name|gimp_edit_selection_tool_update_motion
parameter_list|(
name|GimpEditSelectionTool
modifier|*
name|edit_select
parameter_list|,
name|gdouble
name|new_x
parameter_list|,
name|gdouble
name|new_y
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
block|{
name|GimpDrawTool
modifier|*
name|draw_tool
init|=
name|GIMP_DRAW_TOOL
argument_list|(
name|edit_select
argument_list|)
decl_stmt|;
name|GimpTool
modifier|*
name|tool
init|=
name|GIMP_TOOL
argument_list|(
name|edit_select
argument_list|)
decl_stmt|;
name|GimpImage
modifier|*
name|image
init|=
name|gimp_display_get_image
argument_list|(
name|display
argument_list|)
decl_stmt|;
name|gint
name|dx
decl_stmt|;
name|gint
name|dy
decl_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
name|gimp_draw_tool_pause
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
if|if
condition|(
name|edit_select
operator|->
name|constrain
condition|)
block|{
name|gimp_constrain_line
argument_list|(
name|edit_select
operator|->
name|start_x
argument_list|,
name|edit_select
operator|->
name|start_y
argument_list|,
operator|&
name|new_x
argument_list|,
operator|&
name|new_y
argument_list|,
name|GIMP_CONSTRAIN_LINE_45_DEGREES
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
block|}
name|gimp_edit_selection_tool_calc_coords
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|,
name|new_x
argument_list|,
name|new_y
argument_list|)
expr_stmt|;
name|dx
operator|=
name|edit_select
operator|->
name|current_x
operator|-
name|edit_select
operator|->
name|last_x
expr_stmt|;
name|dy
operator|=
name|edit_select
operator|->
name|current_y
operator|-
name|edit_select
operator|->
name|last_y
expr_stmt|;
comment|/*  if there has been movement, move  */
if|if
condition|(
name|dx
operator|!=
literal|0
operator|||
name|dy
operator|!=
literal|0
condition|)
block|{
name|GimpItem
modifier|*
name|active_item
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
name|active_item
operator|=
name|gimp_edit_selection_tool_get_active_item
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|cuml_x
operator|+=
name|dx
expr_stmt|;
name|edit_select
operator|->
name|cuml_y
operator|+=
name|dy
expr_stmt|;
switch|switch
condition|(
name|edit_select
operator|->
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_LAYER_MASK
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK
case|:
case|case
name|GIMP_TRANSLATE_MODE_VECTORS
case|:
case|case
name|GIMP_TRANSLATE_MODE_CHANNEL
case|:
name|edit_select
operator|->
name|last_x
operator|=
name|edit_select
operator|->
name|current_x
expr_stmt|;
name|edit_select
operator|->
name|last_y
operator|=
name|edit_select
operator|->
name|current_y
expr_stmt|;
comment|/*  fallthru  */
case|case
name|GIMP_TRANSLATE_MODE_LAYER
case|:
name|gimp_image_item_list_translate
argument_list|(
name|image
argument_list|,
name|edit_select
operator|->
name|live_items
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|edit_select
operator|->
name|first_move
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_MASK_TO_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK_COPY_TO_LAYER
case|:
if|if
condition|(
operator|!
name|gimp_selection_float
argument_list|(
name|GIMP_SELECTION
argument_list|(
name|gimp_image_get_mask
argument_list|(
name|image
argument_list|)
argument_list|)
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|active_item
argument_list|)
argument_list|,
name|gimp_get_user_context
argument_list|(
name|display
operator|->
name|gimp
argument_list|)
argument_list|,
name|edit_select
operator|->
name|edit_mode
operator|==
name|GIMP_TRANSLATE_MODE_MASK_TO_LAYER
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
comment|/* no region to float, abort safely */
name|gimp_message_literal
argument_list|(
name|display
operator|->
name|gimp
argument_list|,
name|G_OBJECT
argument_list|(
name|display
argument_list|)
argument_list|,
name|GIMP_MESSAGE_WARNING
argument_list|,
name|error
operator|->
name|message
argument_list|)
expr_stmt|;
name|g_clear_error
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
name|gimp_draw_tool_resume
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
return|return;
block|}
name|edit_select
operator|->
name|last_x
operator|-=
name|edit_select
operator|->
name|sel_x
expr_stmt|;
name|edit_select
operator|->
name|last_y
operator|-=
name|edit_select
operator|->
name|sel_y
expr_stmt|;
name|edit_select
operator|->
name|sel_x
operator|=
literal|0
expr_stmt|;
name|edit_select
operator|->
name|sel_y
operator|=
literal|0
expr_stmt|;
name|edit_select
operator|->
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
expr_stmt|;
name|active_item
operator|=
name|gimp_edit_selection_tool_get_active_item
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|edit_select
operator|->
name|live_items
operator|=
name|g_list_prepend
argument_list|(
name|NULL
argument_list|,
name|active_item
argument_list|)
expr_stmt|;
name|gimp_item_start_move
argument_list|(
name|active_item
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/*  fallthru  */
case|case
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
case|:
name|gimp_image_item_list_translate
argument_list|(
name|image
argument_list|,
name|edit_select
operator|->
name|live_items
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|edit_select
operator|->
name|first_move
argument_list|)
expr_stmt|;
break|break;
block|}
name|edit_select
operator|->
name|first_move
operator|=
name|FALSE
expr_stmt|;
block|}
name|gimp_projection_flush
argument_list|(
name|gimp_image_get_projection
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_tool_pop_status
argument_list|(
name|tool
argument_list|,
name|display
argument_list|)
expr_stmt|;
name|gimp_tool_push_status_coords
argument_list|(
name|tool
argument_list|,
name|display
argument_list|,
name|gimp_tool_control_get_precision
argument_list|(
name|tool
operator|->
name|control
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Move: "
argument_list|)
argument_list|,
name|edit_select
operator|->
name|cuml_x
argument_list|,
literal|", "
argument_list|,
name|edit_select
operator|->
name|cuml_y
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_draw_tool_resume
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_motion (GimpTool * tool,const GimpCoords * coords,guint32 time,GdkModifierType state,GimpDisplay * display)
name|gimp_edit_selection_tool_motion
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
specifier|const
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
block|{
name|GimpEditSelectionTool
modifier|*
name|edit_select
init|=
name|GIMP_EDIT_SELECTION_TOOL
argument_list|(
name|tool
argument_list|)
decl_stmt|;
name|edit_select
operator|->
name|last_motion_x
operator|=
name|coords
operator|->
name|x
expr_stmt|;
name|edit_select
operator|->
name|last_motion_y
operator|=
name|coords
operator|->
name|y
expr_stmt|;
name|gimp_edit_selection_tool_update_motion
argument_list|(
name|edit_select
argument_list|,
name|coords
operator|->
name|x
argument_list|,
name|coords
operator|->
name|y
argument_list|,
name|display
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_active_modifier_key (GimpTool * tool,GdkModifierType key,gboolean press,GdkModifierType state,GimpDisplay * display)
name|gimp_edit_selection_tool_active_modifier_key
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkModifierType
name|key
parameter_list|,
name|gboolean
name|press
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
block|{
name|GimpEditSelectionTool
modifier|*
name|edit_select
init|=
name|GIMP_EDIT_SELECTION_TOOL
argument_list|(
name|tool
argument_list|)
decl_stmt|;
name|edit_select
operator|->
name|constrain
operator|=
operator|(
name|state
operator|&
name|gimp_get_constrain_behavior_mask
argument_list|()
condition|?
name|TRUE
else|:
name|FALSE
operator|)
expr_stmt|;
comment|/* If we didn't came here due to a mouse release, immediately update    * the position of the thing we move.    */
if|if
condition|(
name|state
operator|&
name|GDK_BUTTON1_MASK
condition|)
block|{
name|gimp_edit_selection_tool_update_motion
argument_list|(
name|edit_select
argument_list|,
name|edit_select
operator|->
name|last_motion_x
argument_list|,
name|edit_select
operator|->
name|last_motion_y
argument_list|,
name|display
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_draw (GimpDrawTool * draw_tool)
name|gimp_edit_selection_tool_draw
parameter_list|(
name|GimpDrawTool
modifier|*
name|draw_tool
parameter_list|)
block|{
name|GimpEditSelectionTool
modifier|*
name|edit_select
init|=
name|GIMP_EDIT_SELECTION_TOOL
argument_list|(
name|draw_tool
argument_list|)
decl_stmt|;
name|GimpDisplay
modifier|*
name|display
init|=
name|GIMP_TOOL
argument_list|(
name|draw_tool
argument_list|)
operator|->
name|display
decl_stmt|;
name|GimpImage
modifier|*
name|image
init|=
name|gimp_display_get_image
argument_list|(
name|display
argument_list|)
decl_stmt|;
name|GimpItem
modifier|*
name|active_item
decl_stmt|;
name|gint
name|off_x
decl_stmt|;
name|gint
name|off_y
decl_stmt|;
name|active_item
operator|=
name|gimp_edit_selection_tool_get_active_item
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gimp_item_get_offset
argument_list|(
name|active_item
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|edit_select
operator|->
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_CHANNEL
case|:
case|case
name|GIMP_TRANSLATE_MODE_LAYER_MASK
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK
case|:
block|{
name|gboolean
name|floating_sel
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|edit_select
operator|->
name|edit_mode
operator|==
name|GIMP_TRANSLATE_MODE_MASK
condition|)
block|{
name|GimpLayer
modifier|*
name|layer
init|=
name|gimp_image_get_active_layer
argument_list|(
name|image
argument_list|)
decl_stmt|;
if|if
condition|(
name|layer
condition|)
name|floating_sel
operator|=
name|gimp_layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|floating_sel
operator|&&
name|edit_select
operator|->
name|segs_in
condition|)
block|{
name|gimp_draw_tool_add_boundary
argument_list|(
name|draw_tool
argument_list|,
name|edit_select
operator|->
name|segs_in
argument_list|,
name|edit_select
operator|->
name|num_segs_in
argument_list|,
name|NULL
argument_list|,
name|edit_select
operator|->
name|cuml_x
operator|+
name|off_x
argument_list|,
name|edit_select
operator|->
name|cuml_y
operator|+
name|off_y
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|edit_select
operator|->
name|segs_out
condition|)
block|{
name|gimp_draw_tool_add_boundary
argument_list|(
name|draw_tool
argument_list|,
name|edit_select
operator|->
name|segs_out
argument_list|,
name|edit_select
operator|->
name|num_segs_out
argument_list|,
name|NULL
argument_list|,
name|edit_select
operator|->
name|cuml_x
operator|+
name|off_x
argument_list|,
name|edit_select
operator|->
name|cuml_y
operator|+
name|off_y
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|edit_select
operator|->
name|edit_mode
operator|!=
name|GIMP_TRANSLATE_MODE_MASK
condition|)
block|{
name|gimp_draw_tool_add_rectangle
argument_list|(
name|draw_tool
argument_list|,
name|FALSE
argument_list|,
name|edit_select
operator|->
name|cuml_x
operator|+
name|off_x
argument_list|,
name|edit_select
operator|->
name|cuml_y
operator|+
name|off_y
argument_list|,
name|gimp_item_get_width
argument_list|(
name|active_item
argument_list|)
argument_list|,
name|gimp_item_get_height
argument_list|(
name|active_item
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|GIMP_TRANSLATE_MODE_MASK_TO_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK_COPY_TO_LAYER
case|:
name|gimp_draw_tool_add_rectangle
argument_list|(
name|draw_tool
argument_list|,
name|FALSE
argument_list|,
name|edit_select
operator|->
name|sel_x
operator|+
name|off_x
argument_list|,
name|edit_select
operator|->
name|sel_y
operator|+
name|off_y
argument_list|,
name|edit_select
operator|->
name|sel_width
argument_list|,
name|edit_select
operator|->
name|sel_height
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_VECTORS
case|:
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
if|if
condition|(
name|gimp_item_get_linked
argument_list|(
name|active_item
argument_list|)
condition|)
block|{
name|GList
modifier|*
name|linked
decl_stmt|;
name|linked
operator|=
name|gimp_image_item_list_get_list
argument_list|(
name|image
argument_list|,
name|GIMP_IS_LAYER
argument_list|(
name|active_item
argument_list|)
condition|?
name|GIMP_ITEM_TYPE_LAYERS
else|:
name|GIMP_ITEM_TYPE_VECTORS
argument_list|,
name|GIMP_ITEM_SET_LINKED
argument_list|)
expr_stmt|;
name|linked
operator|=
name|gimp_image_item_list_filter
argument_list|(
name|linked
argument_list|)
expr_stmt|;
name|gimp_image_item_list_bounds
argument_list|(
name|image
argument_list|,
name|linked
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
name|g_list_free
argument_list|(
name|linked
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_item_bounds
argument_list|(
name|active_item
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
name|x
operator|+=
name|off_x
expr_stmt|;
name|y
operator|+=
name|off_y
expr_stmt|;
block|}
name|gimp_draw_tool_add_rectangle
argument_list|(
name|draw_tool
argument_list|,
name|FALSE
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
case|:
if|if
condition|(
name|edit_select
operator|->
name|segs_in
condition|)
block|{
name|gimp_draw_tool_add_boundary
argument_list|(
name|draw_tool
argument_list|,
name|edit_select
operator|->
name|segs_in
argument_list|,
name|edit_select
operator|->
name|num_segs_in
argument_list|,
name|NULL
argument_list|,
name|edit_select
operator|->
name|cuml_x
argument_list|,
name|edit_select
operator|->
name|cuml_y
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
comment|/* Mark the center because we snap to it */
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_CROSS
argument_list|,
name|edit_select
operator|->
name|center_x
operator|+
name|edit_select
operator|->
name|cuml_x
argument_list|,
name|edit_select
operator|->
name|center_y
operator|+
name|edit_select
operator|->
name|cuml_y
argument_list|,
name|GIMP_TOOL_HANDLE_SIZE_SMALL
argument_list|,
name|GIMP_TOOL_HANDLE_SIZE_SMALL
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|GIMP_DRAW_TOOL_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|draw
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|GimpItem
modifier|*
DECL|function|gimp_edit_selection_tool_get_active_item (GimpEditSelectionTool * edit_select,GimpImage * image)
name|gimp_edit_selection_tool_get_active_item
parameter_list|(
name|GimpEditSelectionTool
modifier|*
name|edit_select
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|)
block|{
name|GimpItem
modifier|*
name|active_item
decl_stmt|;
switch|switch
condition|(
name|edit_select
operator|->
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_VECTORS
case|:
name|active_item
operator|=
name|GIMP_ITEM
argument_list|(
name|gimp_image_get_active_vectors
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_LAYER
case|:
name|active_item
operator|=
name|GIMP_ITEM
argument_list|(
name|gimp_image_get_active_layer
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_MASK
case|:
name|active_item
operator|=
name|GIMP_ITEM
argument_list|(
name|gimp_image_get_mask
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|active_item
operator|=
name|GIMP_ITEM
argument_list|(
name|gimp_image_get_active_drawable
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|active_item
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_calc_coords (GimpEditSelectionTool * edit_select,GimpImage * image,gdouble x,gdouble y)
name|gimp_edit_selection_tool_calc_coords
parameter_list|(
name|GimpEditSelectionTool
modifier|*
name|edit_select
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
block|{
name|GimpItem
modifier|*
name|active_item
decl_stmt|;
name|gint
name|off_x
decl_stmt|,
name|off_y
decl_stmt|;
name|gdouble
name|x1
decl_stmt|,
name|y1
decl_stmt|;
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|active_item
operator|=
name|gimp_edit_selection_tool_get_active_item
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gimp_item_get_offset
argument_list|(
name|active_item
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
name|dx
operator|=
operator|(
name|x
operator|-
name|off_x
operator|)
operator|-
name|edit_select
operator|->
name|last_x
expr_stmt|;
name|dy
operator|=
operator|(
name|y
operator|-
name|off_y
operator|)
operator|-
name|edit_select
operator|->
name|last_y
expr_stmt|;
name|x1
operator|=
name|edit_select
operator|->
name|sel_x
operator|+
name|dx
expr_stmt|;
name|y1
operator|=
name|edit_select
operator|->
name|sel_y
operator|+
name|dy
expr_stmt|;
name|edit_select
operator|->
name|current_x
operator|=
operator|(
operator|(
name|gint
operator|)
name|floor
argument_list|(
name|x1
argument_list|)
operator|-
operator|(
name|edit_select
operator|->
name|sel_x
operator|-
name|edit_select
operator|->
name|last_x
operator|)
operator|)
expr_stmt|;
name|edit_select
operator|->
name|current_y
operator|=
operator|(
operator|(
name|gint
operator|)
name|floor
argument_list|(
name|y1
argument_list|)
operator|-
operator|(
name|edit_select
operator|->
name|sel_y
operator|-
name|edit_select
operator|->
name|last_y
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_edit_selection_tool_start_undo_group (GimpEditSelectionTool * edit_select,GimpImage * image)
name|gimp_edit_selection_tool_start_undo_group
parameter_list|(
name|GimpEditSelectionTool
modifier|*
name|edit_select
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|)
block|{
name|GimpItem
modifier|*
name|active_item
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|undo_desc
init|=
name|NULL
decl_stmt|;
name|active_item
operator|=
name|gimp_edit_selection_tool_get_active_item
argument_list|(
name|edit_select
argument_list|,
name|image
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|edit_select
operator|->
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_VECTORS
case|:
case|case
name|GIMP_TRANSLATE_MODE_CHANNEL
case|:
case|case
name|GIMP_TRANSLATE_MODE_LAYER_MASK
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK
case|:
case|case
name|GIMP_TRANSLATE_MODE_LAYER
case|:
name|undo_desc
operator|=
name|GIMP_ITEM_GET_CLASS
argument_list|(
name|active_item
argument_list|)
operator|->
name|translate_desc
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_MASK_TO_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK_COPY_TO_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
case|:
name|undo_desc
operator|=
name|_
argument_list|(
literal|"Move Floating Selection"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_return_if_reached
argument_list|()
expr_stmt|;
block|}
name|gimp_image_undo_group_start
argument_list|(
name|image
argument_list|,
name|edit_select
operator|->
name|edit_mode
operator|==
name|GIMP_TRANSLATE_MODE_MASK
condition|?
name|GIMP_UNDO_GROUP_MASK
else|:
name|GIMP_UNDO_GROUP_ITEM_DISPLACE
argument_list|,
name|undo_desc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|process_event_queue_keys (GdkEventKey * kevent,...)
name|process_event_queue_keys
parameter_list|(
name|GdkEventKey
modifier|*
name|kevent
parameter_list|,
modifier|...
comment|/* GdkKeyType, GdkModifierType, value ... 0 */
parameter_list|)
block|{
DECL|macro|FILTER_MAX_KEYS
define|#
directive|define
name|FILTER_MAX_KEYS
value|50
name|va_list
name|argp
decl_stmt|;
name|GdkEvent
modifier|*
name|event
decl_stmt|;
name|GList
modifier|*
name|event_list
init|=
name|NULL
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|guint
name|keys
index|[
name|FILTER_MAX_KEYS
index|]
decl_stmt|;
name|GdkModifierType
name|modifiers
index|[
name|FILTER_MAX_KEYS
index|]
decl_stmt|;
name|gint
name|values
index|[
name|FILTER_MAX_KEYS
index|]
decl_stmt|;
name|gint
name|i
init|=
literal|0
decl_stmt|;
name|gint
name|n_keys
init|=
literal|0
decl_stmt|;
name|gint
name|value
init|=
literal|0
decl_stmt|;
name|gboolean
name|done
init|=
name|FALSE
decl_stmt|;
name|GtkWidget
modifier|*
name|orig_widget
decl_stmt|;
name|va_start
argument_list|(
name|argp
argument_list|,
name|kevent
argument_list|)
expr_stmt|;
while|while
condition|(
name|n_keys
operator|<
name|FILTER_MAX_KEYS
operator|&&
operator|(
name|keys
index|[
name|n_keys
index|]
operator|=
name|va_arg
argument_list|(
name|argp
argument_list|,
name|guint
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|modifiers
index|[
name|n_keys
index|]
operator|=
name|va_arg
argument_list|(
name|argp
argument_list|,
name|GdkModifierType
argument_list|)
expr_stmt|;
name|values
index|[
name|n_keys
index|]
operator|=
name|va_arg
argument_list|(
name|argp
argument_list|,
name|gint
argument_list|)
expr_stmt|;
name|n_keys
operator|++
expr_stmt|;
block|}
name|va_end
argument_list|(
name|argp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n_keys
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|kevent
operator|->
name|keyval
operator|==
name|keys
index|[
name|i
index|]
operator|&&
operator|(
name|kevent
operator|->
name|state
operator|&
name|modifiers
index|[
name|i
index|]
operator|)
operator|==
name|modifiers
index|[
name|i
index|]
condition|)
name|value
operator|+=
name|values
index|[
name|i
index|]
expr_stmt|;
name|orig_widget
operator|=
name|gtk_get_event_widget
argument_list|(
operator|(
name|GdkEvent
operator|*
operator|)
name|kevent
argument_list|)
expr_stmt|;
while|while
condition|(
name|gdk_events_pending
argument_list|()
operator|>
literal|0
operator|&&
operator|!
name|done
condition|)
block|{
name|gboolean
name|discard_event
init|=
name|FALSE
decl_stmt|;
name|event
operator|=
name|gdk_event_get
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|event
operator|||
name|orig_widget
operator|!=
name|gtk_get_event_widget
argument_list|(
name|event
argument_list|)
condition|)
block|{
name|done
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|event
operator|->
name|any
operator|.
name|type
operator|==
name|GDK_KEY_PRESS
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n_keys
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|event
operator|->
name|key
operator|.
name|keyval
operator|==
name|keys
index|[
name|i
index|]
operator|&&
operator|(
name|event
operator|->
name|key
operator|.
name|state
operator|&
name|modifiers
index|[
name|i
index|]
operator|)
operator|==
name|modifiers
index|[
name|i
index|]
condition|)
block|{
name|discard_event
operator|=
name|TRUE
expr_stmt|;
name|value
operator|+=
name|values
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|discard_event
condition|)
name|done
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* should there be more types here? */
elseif|else
if|if
condition|(
name|event
operator|->
name|any
operator|.
name|type
operator|!=
name|GDK_KEY_RELEASE
operator|&&
name|event
operator|->
name|any
operator|.
name|type
operator|!=
name|GDK_MOTION_NOTIFY
operator|&&
name|event
operator|->
name|any
operator|.
name|type
operator|!=
name|GDK_EXPOSE
condition|)
name|done
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|event
condition|)
empty_stmt|;
comment|/* Do nothing */
elseif|else
if|if
condition|(
operator|!
name|discard_event
condition|)
name|event_list
operator|=
name|g_list_prepend
argument_list|(
name|event_list
argument_list|,
name|event
argument_list|)
expr_stmt|;
else|else
name|gdk_event_free
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
name|event_list
operator|=
name|g_list_reverse
argument_list|(
name|event_list
argument_list|)
expr_stmt|;
comment|/* unget the unused events and free the list */
for|for
control|(
name|list
operator|=
name|event_list
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|gdk_event_put
argument_list|(
operator|(
name|GdkEvent
operator|*
operator|)
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
name|gdk_event_free
argument_list|(
operator|(
name|GdkEvent
operator|*
operator|)
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
name|g_list_free
argument_list|(
name|event_list
argument_list|)
expr_stmt|;
return|return
name|value
return|;
undef|#
directive|undef
name|FILTER_MAX_KEYS
block|}
end_function

begin_function
name|gboolean
DECL|function|gimp_edit_selection_tool_key_press (GimpTool * tool,GdkEventKey * kevent,GimpDisplay * display)
name|gimp_edit_selection_tool_key_press
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventKey
modifier|*
name|kevent
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
block|{
name|GimpTransformType
name|translate_type
decl_stmt|;
if|if
condition|(
name|kevent
operator|->
name|state
operator|&
name|GDK_MOD1_MASK
condition|)
block|{
name|translate_type
operator|=
name|GIMP_TRANSFORM_TYPE_SELECTION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|kevent
operator|->
name|state
operator|&
name|gimp_get_toggle_behavior_mask
argument_list|()
condition|)
block|{
name|translate_type
operator|=
name|GIMP_TRANSFORM_TYPE_PATH
expr_stmt|;
block|}
else|else
block|{
name|translate_type
operator|=
name|GIMP_TRANSFORM_TYPE_LAYER
expr_stmt|;
block|}
return|return
name|gimp_edit_selection_tool_translate
argument_list|(
name|tool
argument_list|,
name|kevent
argument_list|,
name|translate_type
argument_list|,
name|display
argument_list|)
return|;
block|}
end_function

begin_function
name|gboolean
DECL|function|gimp_edit_selection_tool_translate (GimpTool * tool,GdkEventKey * kevent,GimpTransformType translate_type,GimpDisplay * display)
name|gimp_edit_selection_tool_translate
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GdkEventKey
modifier|*
name|kevent
parameter_list|,
name|GimpTransformType
name|translate_type
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
block|{
name|gint
name|inc_x
init|=
literal|0
decl_stmt|;
name|gint
name|inc_y
init|=
literal|0
decl_stmt|;
name|GimpUndo
modifier|*
name|undo
decl_stmt|;
name|gboolean
name|push_undo
init|=
name|TRUE
decl_stmt|;
name|GimpImage
modifier|*
name|image
init|=
name|gimp_display_get_image
argument_list|(
name|display
argument_list|)
decl_stmt|;
name|GimpItem
modifier|*
name|item
init|=
name|NULL
decl_stmt|;
name|GimpTranslateMode
name|edit_mode
init|=
name|GIMP_TRANSLATE_MODE_MASK
decl_stmt|;
name|GimpUndoType
name|undo_type
init|=
name|GIMP_UNDO_GROUP_MASK
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|undo_desc
init|=
name|NULL
decl_stmt|;
name|GdkModifierType
name|extend_mask
init|=
name|gimp_get_extend_selection_mask
argument_list|()
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|null_message
init|=
name|NULL
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|locked_message
init|=
name|NULL
decl_stmt|;
name|gint
name|velocity
decl_stmt|;
comment|/* bail out early if it is not an arrow key event */
if|if
condition|(
name|kevent
operator|->
name|keyval
operator|!=
name|GDK_KEY_Left
operator|&&
name|kevent
operator|->
name|keyval
operator|!=
name|GDK_KEY_Right
operator|&&
name|kevent
operator|->
name|keyval
operator|!=
name|GDK_KEY_Up
operator|&&
name|kevent
operator|->
name|keyval
operator|!=
name|GDK_KEY_Down
condition|)
return|return
name|FALSE
return|;
comment|/*  adapt arrow velocity to the zoom factor when holding<shift>  */
name|velocity
operator|=
operator|(
name|ARROW_VELOCITY
operator|/
name|gimp_zoom_model_get_factor
argument_list|(
name|gimp_display_get_shell
argument_list|(
name|display
argument_list|)
operator|->
name|zoom
argument_list|)
operator|)
expr_stmt|;
name|velocity
operator|=
name|MAX
argument_list|(
literal|1.0
argument_list|,
name|velocity
argument_list|)
expr_stmt|;
comment|/*  check the event queue for key events with the same modifier mask    *  as the current event, allowing only extend_mask to vary between    *  them.    */
name|inc_x
operator|=
name|process_event_queue_keys
argument_list|(
name|kevent
argument_list|,
name|GDK_KEY_Left
argument_list|,
name|kevent
operator|->
name|state
operator||
name|extend_mask
argument_list|,
operator|-
literal|1
operator|*
name|velocity
argument_list|,
name|GDK_KEY_Left
argument_list|,
name|kevent
operator|->
name|state
operator|&
operator|~
name|extend_mask
argument_list|,
operator|-
literal|1
argument_list|,
name|GDK_KEY_Right
argument_list|,
name|kevent
operator|->
name|state
operator||
name|extend_mask
argument_list|,
literal|1
operator|*
name|velocity
argument_list|,
name|GDK_KEY_Right
argument_list|,
name|kevent
operator|->
name|state
operator|&
operator|~
name|extend_mask
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|inc_y
operator|=
name|process_event_queue_keys
argument_list|(
name|kevent
argument_list|,
name|GDK_KEY_Up
argument_list|,
name|kevent
operator|->
name|state
operator||
name|extend_mask
argument_list|,
operator|-
literal|1
operator|*
name|velocity
argument_list|,
name|GDK_KEY_Up
argument_list|,
name|kevent
operator|->
name|state
operator|&
operator|~
name|extend_mask
argument_list|,
operator|-
literal|1
argument_list|,
name|GDK_KEY_Down
argument_list|,
name|kevent
operator|->
name|state
operator||
name|extend_mask
argument_list|,
literal|1
operator|*
name|velocity
argument_list|,
name|GDK_KEY_Down
argument_list|,
name|kevent
operator|->
name|state
operator|&
operator|~
name|extend_mask
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|inc_x
operator|!=
literal|0
operator|||
name|inc_y
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
name|translate_type
condition|)
block|{
case|case
name|GIMP_TRANSFORM_TYPE_SELECTION
case|:
name|item
operator|=
name|GIMP_ITEM
argument_list|(
name|gimp_image_get_mask
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_MASK
expr_stmt|;
name|undo_type
operator|=
name|GIMP_UNDO_GROUP_MASK
expr_stmt|;
if|if
condition|(
operator|!
name|item
condition|)
block|{
comment|/* cannot happen, don't translate this message */
name|null_message
operator|=
literal|"There is no selection to move."
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|gimp_item_is_position_locked
argument_list|(
name|item
argument_list|)
condition|)
block|{
comment|/* cannot happen, don't translate this message */
name|locked_message
operator|=
literal|"The selection's position is locked."
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|gimp_channel_is_empty
argument_list|(
name|GIMP_CHANNEL
argument_list|(
name|item
argument_list|)
argument_list|)
condition|)
block|{
name|locked_message
operator|=
name|_
argument_list|(
literal|"The selection is empty."
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GIMP_TRANSFORM_TYPE_PATH
case|:
name|item
operator|=
name|GIMP_ITEM
argument_list|(
name|gimp_image_get_active_vectors
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_VECTORS
expr_stmt|;
name|undo_type
operator|=
name|GIMP_UNDO_GROUP_ITEM_DISPLACE
expr_stmt|;
if|if
condition|(
operator|!
name|item
condition|)
block|{
name|null_message
operator|=
name|_
argument_list|(
literal|"There is no path to move."
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|gimp_item_is_position_locked
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|locked_message
operator|=
name|_
argument_list|(
literal|"The active path's position is locked."
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GIMP_TRANSFORM_TYPE_LAYER
case|:
name|item
operator|=
name|GIMP_ITEM
argument_list|(
name|gimp_image_get_active_drawable
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
name|undo_type
operator|=
name|GIMP_UNDO_GROUP_ITEM_DISPLACE
expr_stmt|;
if|if
condition|(
operator|!
name|item
condition|)
block|{
name|null_message
operator|=
name|_
argument_list|(
literal|"There is no layer to move."
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|GIMP_IS_LAYER_MASK
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_LAYER_MASK
expr_stmt|;
if|if
condition|(
name|gimp_item_is_position_locked
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|locked_message
operator|=
name|_
argument_list|(
literal|"The active layer's position is locked."
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|gimp_item_is_content_locked
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|locked_message
operator|=
name|_
argument_list|(
literal|"The active layer's pixels are locked."
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|GIMP_IS_CHANNEL
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_CHANNEL
expr_stmt|;
if|if
condition|(
name|gimp_item_is_position_locked
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|locked_message
operator|=
name|_
argument_list|(
literal|"The active channel's position is locked."
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|gimp_item_is_content_locked
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|locked_message
operator|=
name|_
argument_list|(
literal|"The active channel's pixels are locked."
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|gimp_layer_is_floating_sel
argument_list|(
name|GIMP_LAYER
argument_list|(
name|item
argument_list|)
argument_list|)
condition|)
block|{
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
expr_stmt|;
if|if
condition|(
name|gimp_item_is_position_locked
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|locked_message
operator|=
name|_
argument_list|(
literal|"The active layer's position is locked."
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|edit_mode
operator|=
name|GIMP_TRANSLATE_MODE_LAYER
expr_stmt|;
if|if
condition|(
name|gimp_item_is_position_locked
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|locked_message
operator|=
name|_
argument_list|(
literal|"The active layer's position is locked."
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|item
condition|)
block|{
name|gimp_tool_message_literal
argument_list|(
name|tool
argument_list|,
name|display
argument_list|,
name|null_message
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
elseif|else
if|if
condition|(
name|locked_message
condition|)
block|{
name|gimp_tool_message_literal
argument_list|(
name|tool
argument_list|,
name|display
argument_list|,
name|locked_message
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
switch|switch
condition|(
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
case|:
name|undo_desc
operator|=
name|_
argument_list|(
literal|"Move Floating Selection"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|undo_desc
operator|=
name|GIMP_ITEM_GET_CLASS
argument_list|(
name|item
argument_list|)
operator|->
name|translate_desc
expr_stmt|;
break|break;
block|}
comment|/* compress undo */
name|undo
operator|=
name|gimp_image_undo_can_compress
argument_list|(
name|image
argument_list|,
name|GIMP_TYPE_UNDO_STACK
argument_list|,
name|undo_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|undo
operator|&&
name|g_object_get_data
argument_list|(
name|G_OBJECT
argument_list|(
name|undo
argument_list|)
argument_list|,
literal|"edit-selection-tool"
argument_list|)
operator|==
operator|(
name|gpointer
operator|)
name|tool
operator|&&
name|g_object_get_data
argument_list|(
name|G_OBJECT
argument_list|(
name|undo
argument_list|)
argument_list|,
literal|"edit-selection-item"
argument_list|)
operator|==
operator|(
name|gpointer
operator|)
name|item
operator|&&
name|g_object_get_data
argument_list|(
name|G_OBJECT
argument_list|(
name|undo
argument_list|)
argument_list|,
literal|"edit-selection-type"
argument_list|)
operator|==
name|GINT_TO_POINTER
argument_list|(
name|edit_mode
argument_list|)
condition|)
block|{
name|push_undo
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|push_undo
condition|)
block|{
if|if
condition|(
name|gimp_image_undo_group_start
argument_list|(
name|image
argument_list|,
name|undo_type
argument_list|,
name|undo_desc
argument_list|)
condition|)
block|{
name|undo
operator|=
name|gimp_image_undo_can_compress
argument_list|(
name|image
argument_list|,
name|GIMP_TYPE_UNDO_STACK
argument_list|,
name|undo_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|undo
condition|)
block|{
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|undo
argument_list|)
argument_list|,
literal|"edit-selection-tool"
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|undo
argument_list|)
argument_list|,
literal|"edit-selection-item"
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|undo
argument_list|)
argument_list|,
literal|"edit-selection-type"
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|edit_mode
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
switch|switch
condition|(
name|edit_mode
condition|)
block|{
case|case
name|GIMP_TRANSLATE_MODE_LAYER_MASK
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK
case|:
name|gimp_item_translate
argument_list|(
name|item
argument_list|,
name|inc_x
argument_list|,
name|inc_y
argument_list|,
name|push_undo
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_TRANSLATE_MODE_MASK_TO_LAYER
case|:
case|case
name|GIMP_TRANSLATE_MODE_MASK_COPY_TO_LAYER
case|:
comment|/*  this won't happen  */
break|break;
case|case
name|GIMP_TRANSLATE_MODE_VECTORS
case|:
case|case
name|GIMP_TRANSLATE_MODE_CHANNEL
case|:
case|case
name|GIMP_TRANSLATE_MODE_LAYER
case|:
if|if
condition|(
name|gimp_item_get_linked
argument_list|(
name|item
argument_list|)
condition|)
block|{
name|gimp_item_linked_translate
argument_list|(
name|item
argument_list|,
name|inc_x
argument_list|,
name|inc_y
argument_list|,
name|push_undo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_item_translate
argument_list|(
name|item
argument_list|,
name|inc_x
argument_list|,
name|inc_y
argument_list|,
name|push_undo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GIMP_TRANSLATE_MODE_FLOATING_SEL
case|:
name|gimp_item_translate
argument_list|(
name|item
argument_list|,
name|inc_x
argument_list|,
name|inc_y
argument_list|,
name|push_undo
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|push_undo
condition|)
name|gimp_image_undo_group_end
argument_list|(
name|image
argument_list|)
expr_stmt|;
else|else
name|gimp_undo_refresh_preview
argument_list|(
name|undo
argument_list|,
name|gimp_get_user_context
argument_list|(
name|display
operator|->
name|gimp
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_image_flush
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

end_unit

