begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"tools-types.h"
end_include

begin_include
include|#
directive|include
file|"base/pixel-region.h"
end_include

begin_include
include|#
directive|include
file|"base/temp-buf.h"
end_include

begin_include
include|#
directive|include
file|"base/tile.h"
end_include

begin_include
include|#
directive|include
file|"base/tile-manager.h"
end_include

begin_include
include|#
directive|include
file|"paint-funcs/paint-funcs.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpcontext.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpdrawable.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage-mask.h"
end_include

begin_include
include|#
directive|include
file|"core/gimptoolinfo.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplay.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplay-foreach.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell.h"
end_include

begin_include
include|#
directive|include
file|"gimpinktool.h"
end_include

begin_include
include|#
directive|include
file|"gimpinktool-blob.h"
end_include

begin_include
include|#
directive|include
file|"paint_options.h"
end_include

begin_include
include|#
directive|include
file|"tool_manager.h"
end_include

begin_include
include|#
directive|include
file|"app_procs.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"undo.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_define
DECL|macro|SUBSAMPLE
define|#
directive|define
name|SUBSAMPLE
value|8
end_define

begin_typedef
DECL|typedef|BlobFunc
typedef|typedef
name|Blob
modifier|*
function_decl|(
modifier|*
name|BlobFunc
function_decl|)
parameter_list|(
name|gdouble
parameter_list|,
name|gdouble
parameter_list|,
name|gdouble
parameter_list|,
name|gdouble
parameter_list|,
name|gdouble
parameter_list|,
name|gdouble
parameter_list|)
function_decl|;
end_typedef

begin_typedef
DECL|typedef|BrushWidget
typedef|typedef
name|struct
name|_BrushWidget
name|BrushWidget
typedef|;
end_typedef

begin_typedef
DECL|typedef|InkOptions
typedef|typedef
name|struct
name|_InkOptions
name|InkOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_BrushWidget
struct|struct
name|_BrushWidget
block|{
DECL|member|widget
name|GtkWidget
modifier|*
name|widget
decl_stmt|;
DECL|member|state
name|gboolean
name|state
decl_stmt|;
comment|/* EEK */
DECL|member|ink_options
name|InkOptions
modifier|*
name|ink_options
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
DECL|struct|_InkOptions
struct|struct
name|_InkOptions
block|{
DECL|member|paint_options
name|PaintOptions
name|paint_options
decl_stmt|;
DECL|member|size
name|gdouble
name|size
decl_stmt|;
DECL|member|size_d
name|gdouble
name|size_d
decl_stmt|;
DECL|member|size_w
name|GtkObject
modifier|*
name|size_w
decl_stmt|;
DECL|member|sensitivity
name|gdouble
name|sensitivity
decl_stmt|;
DECL|member|sensitivity_d
name|gdouble
name|sensitivity_d
decl_stmt|;
DECL|member|sensitivity_w
name|GtkObject
modifier|*
name|sensitivity_w
decl_stmt|;
DECL|member|vel_sensitivity
name|gdouble
name|vel_sensitivity
decl_stmt|;
DECL|member|vel_sensitivity_d
name|gdouble
name|vel_sensitivity_d
decl_stmt|;
DECL|member|vel_sensitivity_w
name|GtkObject
modifier|*
name|vel_sensitivity_w
decl_stmt|;
DECL|member|tilt_sensitivity
name|gdouble
name|tilt_sensitivity
decl_stmt|;
DECL|member|tilt_sensitivity_d
name|gdouble
name|tilt_sensitivity_d
decl_stmt|;
DECL|member|tilt_sensitivity_w
name|GtkObject
modifier|*
name|tilt_sensitivity_w
decl_stmt|;
DECL|member|tilt_angle
name|gdouble
name|tilt_angle
decl_stmt|;
DECL|member|tilt_angle_d
name|gdouble
name|tilt_angle_d
decl_stmt|;
DECL|member|tilt_angle_w
name|GtkObject
modifier|*
name|tilt_angle_w
decl_stmt|;
DECL|member|function
name|BlobFunc
name|function
decl_stmt|;
DECL|member|function_d
name|BlobFunc
name|function_d
decl_stmt|;
DECL|member|function_w
name|GtkWidget
modifier|*
name|function_w
index|[
literal|3
index|]
decl_stmt|;
comment|/* 3 radio buttons */
DECL|member|aspect
name|gdouble
name|aspect
decl_stmt|;
DECL|member|aspect_d
name|gdouble
name|aspect_d
decl_stmt|;
DECL|member|angle
name|gdouble
name|angle
decl_stmt|;
DECL|member|angle_d
name|gdouble
name|angle_d
decl_stmt|;
DECL|member|brush_w
name|BrushWidget
modifier|*
name|brush_w
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|void
name|gimp_ink_tool_class_init
parameter_list|(
name|GimpInkToolClass
modifier|*
name|klass
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_ink_tool_init
parameter_list|(
name|GimpInkTool
modifier|*
name|tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_ink_tool_finalize
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_ink_tool_control
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|ToolAction
name|tool_action
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_ink_tool_button_press
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_ink_tool_button_release
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_ink_tool_motion
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_ink_tool_cursor_update
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Blob
modifier|*
name|ink_pen_ellipse
parameter_list|(
name|InkOptions
modifier|*
name|options
parameter_list|,
name|gdouble
name|x_center
parameter_list|,
name|gdouble
name|y_center
parameter_list|,
name|gdouble
name|pressure
parameter_list|,
name|gdouble
name|xtilt
parameter_list|,
name|gdouble
name|ytilt
parameter_list|,
name|gdouble
name|velocity
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|time_smoother_add
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|guint32
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gdouble
name|time_smoother_result
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|time_smoother_init
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|guint32
name|initval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dist_smoother_add
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|gdouble
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gdouble
name|dist_smoother_result
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dist_smoother_init
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|gdouble
name|initval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_init
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_finish
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_cleanup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_type_update
parameter_list|(
name|GtkWidget
modifier|*
name|radio_button
parameter_list|,
name|BlobFunc
name|function
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GdkPixmap
modifier|*
name|blob_pixmap
parameter_list|(
name|GdkColormap
modifier|*
name|colormap
parameter_list|,
name|GdkVisual
modifier|*
name|visual
parameter_list|,
name|BlobFunc
name|function
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paint_blob
parameter_list|(
name|GdkDrawable
modifier|*
name|drawable
parameter_list|,
name|GdkGC
modifier|*
name|gc
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Rendering functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|ink_set_paint_area
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_paste
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_to_canvas_tiles
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|,
name|guchar
modifier|*
name|color
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_set_undo_tiles
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_set_canvas_tiles
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Brush pseudo-widget callbacks  */
end_comment

begin_function_decl
specifier|static
name|void
name|brush_widget_active_rect
parameter_list|(
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|,
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkRectangle
modifier|*
name|rect
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|brush_widget_realize
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|brush_widget_expose
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventExpose
modifier|*
name|event
parameter_list|,
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|brush_widget_button_press
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|brush_widget_button_release
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|brush_widget_motion_notify
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventMotion
modifier|*
name|event
parameter_list|,
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GimpToolOptions
modifier|*
name|ink_options_new
parameter_list|(
name|GimpToolInfo
modifier|*
name|tool_info
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_options_reset
parameter_list|(
name|GimpToolOptions
modifier|*
name|tool_options
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ink_type_update
parameter_list|(
name|GtkWidget
modifier|*
name|radio_button
parameter_list|,
name|BlobFunc
name|function
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* local variables */
end_comment

begin_comment
comment|/*  undo blocks variables  */
end_comment

begin_decl_stmt
DECL|variable|undo_tiles
specifier|static
name|TileManager
modifier|*
name|undo_tiles
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Tiles used to render the stroke at 1 byte/pp */
end_comment

begin_decl_stmt
DECL|variable|canvas_tiles
specifier|static
name|TileManager
modifier|*
name|canvas_tiles
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Flat buffer that is used to used to render the dirty region  * for composition onto the destination drawable  */
end_comment

begin_decl_stmt
DECL|variable|canvas_buf
specifier|static
name|TempBuf
modifier|*
name|canvas_buf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|parent_class
specifier|static
name|GimpToolClass
modifier|*
name|parent_class
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  public functions  */
end_comment

begin_function
name|void
DECL|function|gimp_ink_tool_register (Gimp * gimp,GimpToolRegisterCallback callback)
name|gimp_ink_tool_register
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|,
name|GimpToolRegisterCallback
name|callback
parameter_list|)
block|{
call|(
modifier|*
name|callback
call|)
argument_list|(
name|gimp
argument_list|,
name|GIMP_TYPE_INK_TOOL
argument_list|,
name|ink_options_new
argument_list|,
name|TRUE
argument_list|,
literal|"gimp:ink_tool"
argument_list|,
name|_
argument_list|(
literal|"Ink Tool"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Draw in ink"
argument_list|)
argument_list|,
name|N_
argument_list|(
literal|"/Tools/Paint Tools/Ink"
argument_list|)
argument_list|,
literal|"K"
argument_list|,
name|NULL
argument_list|,
literal|"tools/ink.html"
argument_list|,
name|GIMP_STOCK_TOOL_INK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GType
DECL|function|gimp_ink_tool_get_type (void)
name|gimp_ink_tool_get_type
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|GType
name|tool_type
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|tool_type
condition|)
block|{
specifier|static
specifier|const
name|GTypeInfo
name|tool_info
init|=
block|{
sizeof|sizeof
argument_list|(
name|GimpInkToolClass
argument_list|)
block|,
operator|(
name|GBaseInitFunc
operator|)
name|NULL
block|,
operator|(
name|GBaseFinalizeFunc
operator|)
name|NULL
block|,
operator|(
name|GClassInitFunc
operator|)
name|gimp_ink_tool_class_init
block|,
name|NULL
block|,
comment|/* class_finalize */
name|NULL
block|,
comment|/* class_data     */
sizeof|sizeof
argument_list|(
name|GimpInkTool
argument_list|)
block|,
literal|0
block|,
comment|/* n_preallocs    */
operator|(
name|GInstanceInitFunc
operator|)
name|gimp_ink_tool_init
block|,       }
decl_stmt|;
name|tool_type
operator|=
name|g_type_register_static
argument_list|(
name|GIMP_TYPE_TOOL
argument_list|,
literal|"GimpInkTool"
argument_list|,
operator|&
name|tool_info
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|tool_type
return|;
block|}
end_function

begin_comment
comment|/*  private functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gimp_ink_tool_class_init (GimpInkToolClass * klass)
name|gimp_ink_tool_class_init
parameter_list|(
name|GimpInkToolClass
modifier|*
name|klass
parameter_list|)
block|{
name|GObjectClass
modifier|*
name|object_class
decl_stmt|;
name|GimpToolClass
modifier|*
name|tool_class
decl_stmt|;
name|object_class
operator|=
name|G_OBJECT_CLASS
argument_list|(
name|klass
argument_list|)
expr_stmt|;
name|tool_class
operator|=
name|GIMP_TOOL_CLASS
argument_list|(
name|klass
argument_list|)
expr_stmt|;
name|parent_class
operator|=
name|g_type_class_peek_parent
argument_list|(
name|klass
argument_list|)
expr_stmt|;
name|object_class
operator|->
name|finalize
operator|=
name|gimp_ink_tool_finalize
expr_stmt|;
name|tool_class
operator|->
name|control
operator|=
name|gimp_ink_tool_control
expr_stmt|;
name|tool_class
operator|->
name|button_press
operator|=
name|gimp_ink_tool_button_press
expr_stmt|;
name|tool_class
operator|->
name|button_release
operator|=
name|gimp_ink_tool_button_release
expr_stmt|;
name|tool_class
operator|->
name|motion
operator|=
name|gimp_ink_tool_motion
expr_stmt|;
name|tool_class
operator|->
name|cursor_update
operator|=
name|gimp_ink_tool_cursor_update
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_ink_tool_init (GimpInkTool * ink_tool)
name|gimp_ink_tool_init
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
decl_stmt|;
name|tool
operator|=
name|GIMP_TOOL
argument_list|(
name|ink_tool
argument_list|)
expr_stmt|;
name|tool
operator|->
name|tool_cursor
operator|=
name|GIMP_INK_TOOL_CURSOR
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_ink_tool_finalize (GObject * object)
name|gimp_ink_tool_finalize
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
block|{
name|GimpInkTool
modifier|*
name|ink_tool
decl_stmt|;
name|ink_tool
operator|=
name|GIMP_INK_TOOL
argument_list|(
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|ink_tool
operator|->
name|last_blob
condition|)
block|{
name|g_free
argument_list|(
name|ink_tool
operator|->
name|last_blob
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|last_blob
operator|=
name|NULL
expr_stmt|;
block|}
name|ink_cleanup
argument_list|()
expr_stmt|;
name|G_OBJECT_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|finalize
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_ink_tool_control (GimpTool * tool,ToolAction action,GimpDisplay * gdisp)
name|gimp_ink_tool_control
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|ToolAction
name|action
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpInkTool
modifier|*
name|ink_tool
decl_stmt|;
name|ink_tool
operator|=
name|GIMP_INK_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|PAUSE
case|:
break|break;
case|case
name|RESUME
case|:
break|break;
case|case
name|HALT
case|:
name|ink_cleanup
argument_list|()
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_ink_tool_button_press (GimpTool * tool,GimpCoords * coords,guint32 time,GdkModifierType state,GimpDisplay * gdisp)
name|gimp_ink_tool_button_press
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpInkTool
modifier|*
name|ink_tool
decl_stmt|;
name|InkOptions
modifier|*
name|options
decl_stmt|;
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|Blob
modifier|*
name|b
decl_stmt|;
name|ink_tool
operator|=
name|GIMP_INK_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|options
operator|=
operator|(
name|InkOptions
operator|*
operator|)
name|tool
operator|->
name|tool_info
operator|->
name|tool_options
expr_stmt|;
name|shell
operator|=
name|GIMP_DISPLAY_SHELL
argument_list|(
name|gdisp
operator|->
name|shell
argument_list|)
expr_stmt|;
name|drawable
operator|=
name|gimp_image_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|ink_init
argument_list|(
name|ink_tool
argument_list|,
name|drawable
argument_list|,
name|coords
operator|->
name|x
argument_list|,
name|coords
operator|->
name|y
argument_list|)
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|ACTIVE
expr_stmt|;
name|tool
operator|->
name|gdisp
operator|=
name|gdisp
expr_stmt|;
name|tool
operator|->
name|paused_count
operator|=
literal|0
expr_stmt|;
comment|/*  pause the current selection and grab the pointer  */
name|gimp_image_selection_control
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|GIMP_SELECTION_PAUSE
argument_list|)
expr_stmt|;
comment|/* add motion memory if you press mod1 first ^ perfectmouse */
if|if
condition|(
operator|(
operator|(
name|state
operator|&
name|GDK_MOD1_MASK
operator|)
operator|!=
literal|0
operator|)
operator|!=
operator|(
name|gimprc
operator|.
name|perfectmouse
operator|!=
literal|0
operator|)
condition|)
block|{
name|gdk_pointer_grab
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|FALSE
argument_list|,
name|GDK_BUTTON1_MOTION_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|time
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gdk_pointer_grab
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|FALSE
argument_list|,
name|GDK_POINTER_MOTION_HINT_MASK
operator||
name|GDK_BUTTON1_MOTION_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|time
argument_list|)
expr_stmt|;
block|}
name|b
operator|=
name|ink_pen_ellipse
argument_list|(
name|options
argument_list|,
name|coords
operator|->
name|x
argument_list|,
name|coords
operator|->
name|y
argument_list|,
name|coords
operator|->
name|pressure
argument_list|,
name|coords
operator|->
name|xtilt
argument_list|,
name|coords
operator|->
name|ytilt
argument_list|,
literal|10.0
argument_list|)
expr_stmt|;
name|ink_paste
argument_list|(
name|ink_tool
argument_list|,
name|drawable
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|last_blob
operator|=
name|b
expr_stmt|;
name|time_smoother_init
argument_list|(
name|ink_tool
argument_list|,
name|time
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|last_time
operator|=
name|time
expr_stmt|;
name|dist_smoother_init
argument_list|(
name|ink_tool
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|init_velocity
operator|=
name|TRUE
expr_stmt|;
name|ink_tool
operator|->
name|lastx
operator|=
name|coords
operator|->
name|x
expr_stmt|;
name|ink_tool
operator|->
name|lasty
operator|=
name|coords
operator|->
name|y
expr_stmt|;
name|gimp_display_flush_now
argument_list|(
name|gdisp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_ink_tool_button_release (GimpTool * tool,GimpCoords * coords,guint32 time,GdkModifierType state,GimpDisplay * gdisp)
name|gimp_ink_tool_button_release
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpInkTool
modifier|*
name|ink_tool
decl_stmt|;
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
name|ink_tool
operator|=
name|GIMP_INK_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|gimage
operator|=
name|gdisp
operator|->
name|gimage
expr_stmt|;
comment|/*  resume the current selection and ungrab the pointer  */
name|gimp_image_selection_control
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|GIMP_SELECTION_RESUME
argument_list|)
expr_stmt|;
name|gdk_pointer_ungrab
argument_list|(
name|time
argument_list|)
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
comment|/*  Set tool state to inactive -- no longer painting */
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
comment|/*  free the last blob  */
name|g_free
argument_list|(
name|ink_tool
operator|->
name|last_blob
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|last_blob
operator|=
name|NULL
expr_stmt|;
name|ink_finish
argument_list|(
name|ink_tool
argument_list|,
name|gimp_image_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_ink_tool_motion (GimpTool * tool,GimpCoords * coords,guint32 time,GdkModifierType state,GimpDisplay * gdisp)
name|gimp_ink_tool_motion
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|guint32
name|time
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpInkTool
modifier|*
name|ink_tool
decl_stmt|;
name|InkOptions
modifier|*
name|options
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|Blob
modifier|*
name|b
decl_stmt|,
modifier|*
name|blob_union
decl_stmt|;
name|gdouble
name|velocity
decl_stmt|;
name|gdouble
name|dist
decl_stmt|;
name|gdouble
name|lasttime
decl_stmt|,
name|thistime
decl_stmt|;
name|ink_tool
operator|=
name|GIMP_INK_TOOL
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|options
operator|=
operator|(
name|InkOptions
operator|*
operator|)
name|tool
operator|->
name|tool_info
operator|->
name|tool_options
expr_stmt|;
name|drawable
operator|=
name|gimp_image_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|lasttime
operator|=
name|ink_tool
operator|->
name|last_time
expr_stmt|;
name|time_smoother_add
argument_list|(
name|ink_tool
argument_list|,
name|time
argument_list|)
expr_stmt|;
name|thistime
operator|=
name|ink_tool
operator|->
name|last_time
operator|=
name|time_smoother_result
argument_list|(
name|ink_tool
argument_list|)
expr_stmt|;
comment|/* The time resolution on X-based GDK motion events is      bloody awful, hence the use of the smoothing function.      Sadly this also means that there is always the chance of      having an indeterminite velocity since this event and      the previous several may still appear to issue at the same      instant. -ADM */
if|if
condition|(
name|thistime
operator|==
name|lasttime
condition|)
name|thistime
operator|=
name|lasttime
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|ink_tool
operator|->
name|init_velocity
condition|)
block|{
name|dist_smoother_init
argument_list|(
name|ink_tool
argument_list|,
name|dist
operator|=
name|sqrt
argument_list|(
operator|(
name|ink_tool
operator|->
name|lastx
operator|-
name|coords
operator|->
name|x
operator|)
operator|*
operator|(
name|ink_tool
operator|->
name|lastx
operator|-
name|coords
operator|->
name|x
operator|)
operator|+
operator|(
name|ink_tool
operator|->
name|lasty
operator|-
name|coords
operator|->
name|y
operator|)
operator|*
operator|(
name|ink_tool
operator|->
name|lasty
operator|-
name|coords
operator|->
name|y
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|init_velocity
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
name|dist_smoother_add
argument_list|(
name|ink_tool
argument_list|,
name|sqrt
argument_list|(
operator|(
name|ink_tool
operator|->
name|lastx
operator|-
name|coords
operator|->
name|x
operator|)
operator|*
operator|(
name|ink_tool
operator|->
name|lastx
operator|-
name|coords
operator|->
name|x
operator|)
operator|+
operator|(
name|ink_tool
operator|->
name|lasty
operator|-
name|coords
operator|->
name|y
operator|)
operator|*
operator|(
name|ink_tool
operator|->
name|lasty
operator|-
name|coords
operator|->
name|y
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|dist
operator|=
name|dist_smoother_result
argument_list|(
name|ink_tool
argument_list|)
expr_stmt|;
block|}
name|ink_tool
operator|->
name|lastx
operator|=
name|coords
operator|->
name|x
expr_stmt|;
name|ink_tool
operator|->
name|lasty
operator|=
name|coords
operator|->
name|y
expr_stmt|;
name|velocity
operator|=
literal|10.0
operator|*
name|sqrt
argument_list|(
operator|(
name|dist
operator|)
operator|/
call|(
name|gdouble
call|)
argument_list|(
name|thistime
operator|-
name|lasttime
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|=
name|ink_pen_ellipse
argument_list|(
name|options
argument_list|,
name|coords
operator|->
name|x
argument_list|,
name|coords
operator|->
name|y
argument_list|,
name|coords
operator|->
name|pressure
argument_list|,
name|coords
operator|->
name|xtilt
argument_list|,
name|coords
operator|->
name|ytilt
argument_list|,
name|velocity
argument_list|)
expr_stmt|;
name|blob_union
operator|=
name|blob_convex_union
argument_list|(
name|ink_tool
operator|->
name|last_blob
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|ink_tool
operator|->
name|last_blob
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|last_blob
operator|=
name|b
expr_stmt|;
name|ink_paste
argument_list|(
name|ink_tool
argument_list|,
name|drawable
argument_list|,
name|blob_union
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|blob_union
argument_list|)
expr_stmt|;
name|gimp_display_flush_now
argument_list|(
name|gdisp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_ink_tool_cursor_update (GimpTool * tool,GimpCoords * coords,GdkModifierType state,GimpDisplay * gdisp)
name|gimp_ink_tool_cursor_update
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|GimpLayer
modifier|*
name|layer
decl_stmt|;
name|GdkCursorType
name|ctype
init|=
name|GDK_TOP_LEFT_ARROW
decl_stmt|;
name|shell
operator|=
name|GIMP_DISPLAY_SHELL
argument_list|(
name|gdisp
operator|->
name|shell
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|layer
operator|=
name|gimp_image_get_active_layer
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
operator|)
condition|)
block|{
name|gint
name|off_x
decl_stmt|,
name|off_y
decl_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
if|if
condition|(
name|coords
operator|->
name|x
operator|>=
name|off_x
operator|&&
name|coords
operator|->
name|y
operator|>=
name|off_y
operator|&&
name|coords
operator|->
name|x
operator|<
operator|(
name|off_x
operator|+
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|)
operator|&&
name|coords
operator|->
name|y
operator|<
operator|(
name|off_y
operator|+
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|)
condition|)
block|{
comment|/*  One more test--is there a selected region? 	   *  if so, is cursor inside? 	   */
if|if
condition|(
name|gimage_mask_is_empty
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
condition|)
name|ctype
operator|=
name|GIMP_MOUSE_CURSOR
expr_stmt|;
elseif|else
if|if
condition|(
name|gimage_mask_value
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|coords
operator|->
name|x
argument_list|,
name|coords
operator|->
name|y
argument_list|)
condition|)
name|ctype
operator|=
name|GIMP_MOUSE_CURSOR
expr_stmt|;
block|}
block|}
name|gimp_display_shell_install_tool_cursor
argument_list|(
name|shell
argument_list|,
name|ctype
argument_list|,
name|GIMP_INK_TOOL_CURSOR
argument_list|,
name|GIMP_CURSOR_MODIFIER_NONE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  the brush widget functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|brush_widget_active_rect (BrushWidget * brush_widget,GtkWidget * widget,GdkRectangle * rect)
name|brush_widget_active_rect
parameter_list|(
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|,
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkRectangle
modifier|*
name|rect
parameter_list|)
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gint
name|r
decl_stmt|;
name|r
operator|=
name|MIN
argument_list|(
name|widget
operator|->
name|allocation
operator|.
name|width
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|height
argument_list|)
operator|/
literal|2
expr_stmt|;
name|x
operator|=
name|widget
operator|->
name|allocation
operator|.
name|width
operator|/
literal|2
operator|+
literal|0.85
operator|*
name|r
operator|*
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|/
literal|10.0
operator|*
name|cos
argument_list|(
name|brush_widget
operator|->
name|ink_options
operator|->
name|angle
argument_list|)
expr_stmt|;
name|y
operator|=
name|widget
operator|->
name|allocation
operator|.
name|height
operator|/
literal|2
operator|+
literal|0.85
operator|*
name|r
operator|*
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|/
literal|10.0
operator|*
name|sin
argument_list|(
name|brush_widget
operator|->
name|ink_options
operator|->
name|angle
argument_list|)
expr_stmt|;
name|rect
operator|->
name|x
operator|=
name|x
operator|-
literal|5
expr_stmt|;
name|rect
operator|->
name|y
operator|=
name|y
operator|-
literal|5
expr_stmt|;
name|rect
operator|->
name|width
operator|=
literal|10
expr_stmt|;
name|rect
operator|->
name|height
operator|=
literal|10
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|brush_widget_realize (GtkWidget * widget)
name|brush_widget_realize
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
block|{
name|gtk_style_set_background
argument_list|(
name|widget
operator|->
name|style
argument_list|,
name|widget
operator|->
name|window
argument_list|,
name|GTK_STATE_ACTIVE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|brush_widget_draw_brush (BrushWidget * brush_widget,GtkWidget * widget,gdouble xc,gdouble yc,gdouble radius)
name|brush_widget_draw_brush
parameter_list|(
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|,
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gdouble
name|xc
parameter_list|,
name|gdouble
name|yc
parameter_list|,
name|gdouble
name|radius
parameter_list|)
block|{
name|Blob
modifier|*
name|blob
decl_stmt|;
name|blob
operator|=
name|brush_widget
operator|->
name|ink_options
operator|->
name|function
argument_list|(
name|xc
argument_list|,
name|yc
argument_list|,
name|radius
operator|*
name|cos
argument_list|(
name|brush_widget
operator|->
name|ink_options
operator|->
name|angle
argument_list|)
argument_list|,
name|radius
operator|*
name|sin
argument_list|(
name|brush_widget
operator|->
name|ink_options
operator|->
name|angle
argument_list|)
argument_list|,
operator|(
operator|-
operator|(
name|radius
operator|/
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|)
operator|*
name|sin
argument_list|(
name|brush_widget
operator|->
name|ink_options
operator|->
name|angle
argument_list|)
operator|)
argument_list|,
operator|(
operator|(
name|radius
operator|/
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|)
operator|*
name|cos
argument_list|(
name|brush_widget
operator|->
name|ink_options
operator|->
name|angle
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|paint_blob
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|widget
operator|->
name|style
operator|->
name|fg_gc
index|[
name|widget
operator|->
name|state
index|]
argument_list|,
name|blob
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|blob
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|brush_widget_expose (GtkWidget * widget,GdkEventExpose * event,BrushWidget * brush_widget)
name|brush_widget_expose
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventExpose
modifier|*
name|event
parameter_list|,
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|)
block|{
name|GdkRectangle
name|rect
decl_stmt|;
name|int
name|r0
decl_stmt|;
name|r0
operator|=
name|MIN
argument_list|(
name|widget
operator|->
name|allocation
operator|.
name|width
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|height
argument_list|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|r0
operator|<
literal|2
condition|)
return|return;
name|gdk_window_clear_area
argument_list|(
name|widget
operator|->
name|window
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|width
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|height
argument_list|)
expr_stmt|;
name|brush_widget_draw_brush
argument_list|(
name|brush_widget
argument_list|,
name|widget
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|width
operator|/
literal|2
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|height
operator|/
literal|2
argument_list|,
literal|0.9
operator|*
name|r0
argument_list|)
expr_stmt|;
name|brush_widget_active_rect
argument_list|(
name|brush_widget
argument_list|,
name|widget
argument_list|,
operator|&
name|rect
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|widget
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|TRUE
argument_list|,
comment|/* filled */
name|rect
operator|.
name|x
argument_list|,
name|rect
operator|.
name|y
argument_list|,
name|rect
operator|.
name|width
argument_list|,
name|rect
operator|.
name|height
argument_list|)
expr_stmt|;
name|gtk_draw_shadow
argument_list|(
name|widget
operator|->
name|style
argument_list|,
name|widget
operator|->
name|window
argument_list|,
name|widget
operator|->
name|state
argument_list|,
name|GTK_SHADOW_OUT
argument_list|,
name|rect
operator|.
name|x
argument_list|,
name|rect
operator|.
name|y
argument_list|,
name|rect
operator|.
name|width
argument_list|,
name|rect
operator|.
name|height
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|brush_widget_button_press (GtkWidget * widget,GdkEventButton * event,BrushWidget * brush_widget)
name|brush_widget_button_press
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|)
block|{
name|GdkRectangle
name|rect
decl_stmt|;
name|brush_widget_active_rect
argument_list|(
name|brush_widget
argument_list|,
name|widget
argument_list|,
operator|&
name|rect
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|event
operator|->
name|x
operator|>=
name|rect
operator|.
name|x
operator|)
operator|&&
operator|(
name|event
operator|->
name|x
operator|-
name|rect
operator|.
name|x
operator|<
name|rect
operator|.
name|width
operator|)
operator|&&
operator|(
name|event
operator|->
name|y
operator|>=
name|rect
operator|.
name|y
operator|)
operator|&&
operator|(
name|event
operator|->
name|y
operator|-
name|rect
operator|.
name|y
operator|<
name|rect
operator|.
name|height
operator|)
condition|)
block|{
name|brush_widget
operator|->
name|state
operator|=
name|TRUE
expr_stmt|;
name|gtk_grab_add
argument_list|(
name|brush_widget
operator|->
name|widget
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|brush_widget_button_release (GtkWidget * widget,GdkEventButton * event,BrushWidget * brush_widget)
name|brush_widget_button_release
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|)
block|{
name|brush_widget
operator|->
name|state
operator|=
name|FALSE
expr_stmt|;
name|gtk_grab_remove
argument_list|(
name|brush_widget
operator|->
name|widget
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|brush_widget_motion_notify (GtkWidget * widget,GdkEventMotion * event,BrushWidget * brush_widget)
name|brush_widget_motion_notify
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventMotion
modifier|*
name|event
parameter_list|,
name|BrushWidget
modifier|*
name|brush_widget
parameter_list|)
block|{
name|int
name|x
decl_stmt|;
name|int
name|y
decl_stmt|;
name|int
name|r0
decl_stmt|;
name|int
name|rsquare
decl_stmt|;
if|if
condition|(
name|brush_widget
operator|->
name|state
condition|)
block|{
name|x
operator|=
name|event
operator|->
name|x
operator|-
name|widget
operator|->
name|allocation
operator|.
name|width
operator|/
literal|2
expr_stmt|;
name|y
operator|=
name|event
operator|->
name|y
operator|-
name|widget
operator|->
name|allocation
operator|.
name|height
operator|/
literal|2
expr_stmt|;
name|rsquare
operator|=
name|x
operator|*
name|x
operator|+
name|y
operator|*
name|y
expr_stmt|;
if|if
condition|(
name|rsquare
operator|!=
literal|0
condition|)
block|{
name|brush_widget
operator|->
name|ink_options
operator|->
name|angle
operator|=
name|atan2
argument_list|(
name|y
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|r0
operator|=
name|MIN
argument_list|(
name|widget
operator|->
name|allocation
operator|.
name|width
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|height
argument_list|)
operator|/
literal|2
expr_stmt|;
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|=
literal|10.0
operator|*
name|sqrt
argument_list|(
operator|(
name|gdouble
operator|)
name|rsquare
operator|/
operator|(
name|r0
operator|*
name|r0
operator|)
argument_list|)
operator|/
literal|0.85
expr_stmt|;
if|if
condition|(
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|<
literal|1.0
condition|)
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|>
literal|10.0
condition|)
name|brush_widget
operator|->
name|ink_options
operator|->
name|aspect
operator|=
literal|10.0
expr_stmt|;
name|gtk_widget_draw
argument_list|(
name|widget
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Return a black-on white pixmap in the given colormap and  * visual that represents the BlobFunc 'function'  */
end_comment

begin_function
specifier|static
name|GdkPixmap
modifier|*
DECL|function|blob_pixmap (GdkColormap * colormap,GdkVisual * visual,BlobFunc function)
name|blob_pixmap
parameter_list|(
name|GdkColormap
modifier|*
name|colormap
parameter_list|,
name|GdkVisual
modifier|*
name|visual
parameter_list|,
name|BlobFunc
name|function
parameter_list|)
block|{
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
name|GdkGC
modifier|*
name|black_gc
decl_stmt|,
modifier|*
name|white_gc
decl_stmt|;
name|GdkColor
name|tmp_color
decl_stmt|;
name|gboolean
name|success
decl_stmt|;
name|Blob
modifier|*
name|blob
decl_stmt|;
name|pixmap
operator|=
name|gdk_pixmap_new
argument_list|(
name|NULL
argument_list|,
literal|22
argument_list|,
literal|21
argument_list|,
name|visual
operator|->
name|depth
argument_list|)
expr_stmt|;
name|tmp_color
operator|.
name|red
operator|=
literal|0
expr_stmt|;
name|tmp_color
operator|.
name|green
operator|=
literal|0
expr_stmt|;
name|tmp_color
operator|.
name|blue
operator|=
literal|0
expr_stmt|;
name|gdk_colormap_alloc_colors
argument_list|(
name|colormap
argument_list|,
operator|&
name|tmp_color
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|success
argument_list|)
expr_stmt|;
name|black_gc
operator|=
name|gdk_gc_new
argument_list|(
name|pixmap
argument_list|)
expr_stmt|;
name|gdk_gc_set_foreground
argument_list|(
name|black_gc
argument_list|,
operator|&
name|tmp_color
argument_list|)
expr_stmt|;
name|tmp_color
operator|.
name|red
operator|=
literal|255
expr_stmt|;
name|tmp_color
operator|.
name|green
operator|=
literal|255
expr_stmt|;
name|tmp_color
operator|.
name|blue
operator|=
literal|255
expr_stmt|;
name|gdk_colormap_alloc_colors
argument_list|(
name|colormap
argument_list|,
operator|&
name|tmp_color
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|success
argument_list|)
expr_stmt|;
name|white_gc
operator|=
name|gdk_gc_new
argument_list|(
name|pixmap
argument_list|)
expr_stmt|;
name|gdk_gc_set_foreground
argument_list|(
name|white_gc
argument_list|,
operator|&
name|tmp_color
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pixmap
argument_list|,
name|white_gc
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|21
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pixmap
argument_list|,
name|black_gc
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|21
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|blob
operator|=
call|(
modifier|*
name|function
call|)
argument_list|(
literal|10
argument_list|,
literal|10
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|paint_blob
argument_list|(
name|pixmap
argument_list|,
name|black_gc
argument_list|,
name|blob
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|blob
argument_list|)
expr_stmt|;
name|gdk_gc_unref
argument_list|(
name|white_gc
argument_list|)
expr_stmt|;
name|gdk_gc_unref
argument_list|(
name|black_gc
argument_list|)
expr_stmt|;
return|return
name|pixmap
return|;
block|}
end_function

begin_comment
comment|/*  * Draw a blob onto a drawable with the specified graphics context  */
end_comment

begin_function
specifier|static
name|void
DECL|function|paint_blob (GdkDrawable * drawable,GdkGC * gc,Blob * blob)
name|paint_blob
parameter_list|(
name|GdkDrawable
modifier|*
name|drawable
parameter_list|,
name|GdkGC
modifier|*
name|gc
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|blob
operator|->
name|height
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|blob
operator|->
name|data
index|[
name|i
index|]
operator|.
name|left
operator|<=
name|blob
operator|->
name|data
index|[
name|i
index|]
operator|.
name|right
condition|)
name|gdk_draw_line
argument_list|(
name|drawable
argument_list|,
name|gc
argument_list|,
name|blob
operator|->
name|data
index|[
name|i
index|]
operator|.
name|left
argument_list|,
name|i
operator|+
name|blob
operator|->
name|y
argument_list|,
name|blob
operator|->
name|data
index|[
name|i
index|]
operator|.
name|right
operator|+
literal|1
argument_list|,
name|i
operator|+
name|blob
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|Blob
modifier|*
DECL|function|ink_pen_ellipse (InkOptions * options,gdouble x_center,gdouble y_center,gdouble pressure,gdouble xtilt,gdouble ytilt,gdouble velocity)
name|ink_pen_ellipse
parameter_list|(
name|InkOptions
modifier|*
name|options
parameter_list|,
name|gdouble
name|x_center
parameter_list|,
name|gdouble
name|y_center
parameter_list|,
name|gdouble
name|pressure
parameter_list|,
name|gdouble
name|xtilt
parameter_list|,
name|gdouble
name|ytilt
parameter_list|,
name|gdouble
name|velocity
parameter_list|)
block|{
name|gdouble
name|size
decl_stmt|;
name|gdouble
name|tsin
decl_stmt|,
name|tcos
decl_stmt|;
name|gdouble
name|aspect
decl_stmt|,
name|radmin
decl_stmt|;
name|gdouble
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gdouble
name|tscale
decl_stmt|;
name|gdouble
name|tscale_c
decl_stmt|;
name|gdouble
name|tscale_s
decl_stmt|;
comment|/* Adjust the size depending on pressure. */
name|size
operator|=
name|options
operator|->
name|size
operator|*
operator|(
literal|1.0
operator|+
name|options
operator|->
name|sensitivity
operator|*
operator|(
literal|2.0
operator|*
name|pressure
operator|-
literal|1.0
operator|)
operator|)
expr_stmt|;
comment|/* Adjust the size further depending on pointer velocity      and velocity-sensitivity.  These 'magic constants' are      'feels natural' tigert-approved. --ADM */
if|if
condition|(
name|velocity
operator|<
literal|3.0
condition|)
name|velocity
operator|=
literal|3.0
expr_stmt|;
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"%f (%f) -> "
argument_list|,
operator|(
name|float
operator|)
name|size
argument_list|,
operator|(
name|float
operator|)
name|velocity
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|size
operator|=
name|options
operator|->
name|vel_sensitivity
operator|*
operator|(
operator|(
literal|4.5
operator|*
name|size
operator|)
operator|/
operator|(
literal|1.0
operator|+
name|options
operator|->
name|vel_sensitivity
operator|*
operator|(
literal|2.0
operator|*
operator|(
name|velocity
operator|)
operator|)
operator|)
operator|)
operator|+
operator|(
literal|1.0
operator|-
name|options
operator|->
name|vel_sensitivity
operator|)
operator|*
name|size
expr_stmt|;
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"%f\n"
argument_list|,
operator|(
name|float
operator|)
name|size
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Clamp resulting size to sane limits */
if|if
condition|(
name|size
operator|>
name|options
operator|->
name|size
operator|*
operator|(
literal|1.0
operator|+
name|options
operator|->
name|sensitivity
operator|)
condition|)
name|size
operator|=
name|options
operator|->
name|size
operator|*
operator|(
literal|1.0
operator|+
name|options
operator|->
name|sensitivity
operator|)
expr_stmt|;
if|if
condition|(
name|size
operator|*
name|SUBSAMPLE
operator|<
literal|1.0
condition|)
name|size
operator|=
literal|1.0
operator|/
name|SUBSAMPLE
expr_stmt|;
comment|/* Add brush angle/aspect to tilt vectorially */
comment|/* I'm not happy with the way the brush widget info is combined with      tilt info from the brush. My personal feeling is that representing      both as affine transforms would make the most sense. -RLL */
name|tscale
operator|=
name|options
operator|->
name|tilt_sensitivity
operator|*
literal|10.0
expr_stmt|;
name|tscale_c
operator|=
name|tscale
operator|*
name|cos
argument_list|(
name|gimp_deg_to_rad
argument_list|(
name|options
operator|->
name|tilt_angle
argument_list|)
argument_list|)
expr_stmt|;
name|tscale_s
operator|=
name|tscale
operator|*
name|sin
argument_list|(
name|gimp_deg_to_rad
argument_list|(
name|options
operator|->
name|tilt_angle
argument_list|)
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|options
operator|->
name|aspect
operator|*
name|cos
argument_list|(
name|options
operator|->
name|angle
argument_list|)
operator|+
name|xtilt
operator|*
name|tscale_c
operator|-
name|ytilt
operator|*
name|tscale_s
operator|)
expr_stmt|;
name|y
operator|=
operator|(
name|options
operator|->
name|aspect
operator|*
name|sin
argument_list|(
name|options
operator|->
name|angle
argument_list|)
operator|+
name|ytilt
operator|*
name|tscale_c
operator|+
name|xtilt
operator|*
name|tscale_s
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"angle %g aspect %g; %g %g; %g %g\n"
argument_list|,
name|options
operator|->
name|angle
argument_list|,
name|options
operator|->
name|aspect
argument_list|,
name|tscale_c
argument_list|,
name|tscale_s
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|aspect
operator|=
name|sqrt
argument_list|(
name|x
operator|*
name|x
operator|+
name|y
operator|*
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|aspect
operator|!=
literal|0
condition|)
block|{
name|tcos
operator|=
name|x
operator|/
name|aspect
expr_stmt|;
name|tsin
operator|=
name|y
operator|/
name|aspect
expr_stmt|;
block|}
else|else
block|{
name|tsin
operator|=
name|sin
argument_list|(
name|options
operator|->
name|angle
argument_list|)
expr_stmt|;
name|tcos
operator|=
name|cos
argument_list|(
name|options
operator|->
name|angle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|aspect
operator|<
literal|1.0
condition|)
name|aspect
operator|=
literal|1.0
expr_stmt|;
elseif|else
if|if
condition|(
name|aspect
operator|>
literal|10.0
condition|)
name|aspect
operator|=
literal|10.0
expr_stmt|;
name|radmin
operator|=
name|SUBSAMPLE
operator|*
name|size
operator|/
name|aspect
expr_stmt|;
if|if
condition|(
name|radmin
operator|<
literal|1.0
condition|)
name|radmin
operator|=
literal|1.0
expr_stmt|;
return|return
name|options
operator|->
name|function
argument_list|(
name|x_center
operator|*
name|SUBSAMPLE
argument_list|,
name|y_center
operator|*
name|SUBSAMPLE
argument_list|,
name|radmin
operator|*
name|aspect
operator|*
name|tcos
argument_list|,
name|radmin
operator|*
name|aspect
operator|*
name|tsin
argument_list|,
operator|-
name|radmin
operator|*
name|tsin
argument_list|,
name|radmin
operator|*
name|tcos
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dist_smoother_init (GimpInkTool * ink_tool,gdouble initval)
name|dist_smoother_init
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|gdouble
name|initval
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|ink_tool
operator|->
name|dt_index
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DIST_SMOOTHER_BUFFER
condition|;
name|i
operator|++
control|)
block|{
name|ink_tool
operator|->
name|dt_buffer
index|[
name|i
index|]
operator|=
name|initval
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|dist_smoother_result (GimpInkTool * ink_tool)
name|dist_smoother_result
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|gdouble
name|result
init|=
literal|0.0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DIST_SMOOTHER_BUFFER
condition|;
name|i
operator|++
control|)
block|{
name|result
operator|+=
name|ink_tool
operator|->
name|dt_buffer
index|[
name|i
index|]
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|/
operator|(
name|gdouble
operator|)
name|DIST_SMOOTHER_BUFFER
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dist_smoother_add (GimpInkTool * ink_tool,gdouble value)
name|dist_smoother_add
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|gdouble
name|value
parameter_list|)
block|{
name|ink_tool
operator|->
name|dt_buffer
index|[
name|ink_tool
operator|->
name|dt_index
index|]
operator|=
name|value
expr_stmt|;
if|if
condition|(
operator|(
operator|++
name|ink_tool
operator|->
name|dt_index
operator|)
operator|==
name|DIST_SMOOTHER_BUFFER
condition|)
name|ink_tool
operator|->
name|dt_index
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|time_smoother_init (GimpInkTool * ink_tool,guint32 initval)
name|time_smoother_init
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|guint32
name|initval
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|ink_tool
operator|->
name|ts_index
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TIME_SMOOTHER_BUFFER
condition|;
name|i
operator|++
control|)
block|{
name|ink_tool
operator|->
name|ts_buffer
index|[
name|i
index|]
operator|=
name|initval
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|time_smoother_result (GimpInkTool * ink_tool)
name|time_smoother_result
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|guint64
name|result
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TIME_SMOOTHER_BUFFER
condition|;
name|i
operator|++
control|)
block|{
name|result
operator|+=
name|ink_tool
operator|->
name|ts_buffer
index|[
name|i
index|]
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|_MSC_VER
return|return
call|(
name|gdouble
call|)
argument_list|(
name|gint64
argument_list|)
argument_list|(
name|result
operator|/
name|TIME_SMOOTHER_BUFFER
argument_list|)
return|;
else|#
directive|else
return|return
operator|(
name|result
operator|/
name|TIME_SMOOTHER_BUFFER
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|time_smoother_add (GimpInkTool * ink_tool,guint32 value)
name|time_smoother_add
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|guint32
name|value
parameter_list|)
block|{
name|ink_tool
operator|->
name|ts_buffer
index|[
name|ink_tool
operator|->
name|ts_index
index|]
operator|=
name|value
expr_stmt|;
if|if
condition|(
operator|(
operator|++
name|ink_tool
operator|->
name|ts_index
operator|)
operator|==
name|TIME_SMOOTHER_BUFFER
condition|)
name|ink_tool
operator|->
name|ts_index
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ink_init (GimpInkTool * ink_tool,GimpDrawable * drawable,gdouble x,gdouble y)
name|ink_init
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
block|{
comment|/*  free the block structures  */
if|if
condition|(
name|undo_tiles
condition|)
name|tile_manager_destroy
argument_list|(
name|undo_tiles
argument_list|)
expr_stmt|;
if|if
condition|(
name|canvas_tiles
condition|)
name|tile_manager_destroy
argument_list|(
name|canvas_tiles
argument_list|)
expr_stmt|;
comment|/*  Allocate the undo structure  */
name|undo_tiles
operator|=
name|tile_manager_new
argument_list|(
name|gimp_drawable_width
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|gimp_drawable_height
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|gimp_drawable_bytes
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  Allocate the canvas blocks structure  */
name|canvas_tiles
operator|=
name|tile_manager_new
argument_list|(
name|gimp_drawable_width
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|gimp_drawable_height
argument_list|(
name|drawable
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/*  Get the initial undo extents  */
name|ink_tool
operator|->
name|x1
operator|=
name|ink_tool
operator|->
name|x2
operator|=
name|x
expr_stmt|;
name|ink_tool
operator|->
name|y1
operator|=
name|ink_tool
operator|->
name|y2
operator|=
name|y
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ink_finish (GimpInkTool * ink_tool,GimpDrawable * drawable)
name|ink_finish
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
block|{
comment|/*  push an undo  */
name|gimp_drawable_apply_image
argument_list|(
name|drawable
argument_list|,
name|ink_tool
operator|->
name|x1
argument_list|,
name|ink_tool
operator|->
name|y1
argument_list|,
name|ink_tool
operator|->
name|x2
argument_list|,
name|ink_tool
operator|->
name|y2
argument_list|,
name|undo_tiles
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|undo_tiles
operator|=
name|NULL
expr_stmt|;
comment|/*  invalidate the drawable--have to do it here, because    *  it is not done during the actual painting.    */
name|gimp_viewable_invalidate_preview
argument_list|(
name|GIMP_VIEWABLE
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ink_cleanup (void)
name|ink_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
comment|/*  If the undo tiles exist, nuke them  */
if|if
condition|(
name|undo_tiles
condition|)
block|{
name|tile_manager_destroy
argument_list|(
name|undo_tiles
argument_list|)
expr_stmt|;
name|undo_tiles
operator|=
name|NULL
expr_stmt|;
block|}
comment|/*  If the canvas blocks exist, nuke them  */
if|if
condition|(
name|canvas_tiles
condition|)
block|{
name|tile_manager_destroy
argument_list|(
name|canvas_tiles
argument_list|)
expr_stmt|;
name|canvas_tiles
operator|=
name|NULL
expr_stmt|;
block|}
comment|/*  Free the temporary buffer if it exist  */
if|if
condition|(
name|canvas_buf
condition|)
block|{
name|temp_buf_free
argument_list|(
name|canvas_buf
argument_list|)
expr_stmt|;
name|canvas_buf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*********************************  *  Rendering functions          *  *********************************/
end_comment

begin_comment
comment|/* Some of this stuff should probably be combined with the   * code it was copied from in paint_core.c; but I wanted  * to learn this stuff, so I've kept it simple.  *  * The following only supports CONSTANT mode. Incremental  * would, I think, interact strangely with the way we  * do things. But it wouldn't be hard to implement at all.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|ink_set_paint_area (GimpInkTool * ink_tool,GimpDrawable * drawable,Blob * blob)
name|ink_set_paint_area
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|)
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gint
name|bytes
decl_stmt|;
name|blob_bounds
argument_list|(
name|blob
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|width
argument_list|,
operator|&
name|height
argument_list|)
expr_stmt|;
name|bytes
operator|=
name|gimp_drawable_has_alpha
argument_list|(
name|drawable
argument_list|)
condition|?
name|gimp_drawable_bytes
argument_list|(
name|drawable
argument_list|)
else|:
name|gimp_drawable_bytes
argument_list|(
name|drawable
argument_list|)
operator|+
literal|1
expr_stmt|;
name|x1
operator|=
name|CLAMP
argument_list|(
name|x
operator|/
name|SUBSAMPLE
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|gimp_drawable_width
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
name|y1
operator|=
name|CLAMP
argument_list|(
name|y
operator|/
name|SUBSAMPLE
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|gimp_drawable_height
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
name|x2
operator|=
name|CLAMP
argument_list|(
operator|(
name|x
operator|+
name|width
operator|)
operator|/
name|SUBSAMPLE
operator|+
literal|2
argument_list|,
literal|0
argument_list|,
name|gimp_drawable_width
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
name|y2
operator|=
name|CLAMP
argument_list|(
operator|(
name|y
operator|+
name|height
operator|)
operator|/
name|SUBSAMPLE
operator|+
literal|2
argument_list|,
literal|0
argument_list|,
name|gimp_drawable_height
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  configure the canvas buffer  */
if|if
condition|(
operator|(
name|x2
operator|-
name|x1
operator|)
operator|&&
operator|(
name|y2
operator|-
name|y1
operator|)
condition|)
name|canvas_buf
operator|=
name|temp_buf_resize
argument_list|(
name|canvas_buf
argument_list|,
name|bytes
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_enum
DECL|enum|__anon2c54dacf0103
DECL|enumerator|ROW_START
DECL|enumerator|ROW_STOP
enum|enum
block|{
name|ROW_START
block|,
name|ROW_STOP
block|}
enum|;
end_enum

begin_comment
comment|/* The insertion sort here, for SUBSAMPLE = 8, tends to beat out  * qsort() by 4x with CFLAGS=-O2, 2x with CFLAGS=-g  */
end_comment

begin_function
specifier|static
name|void
DECL|function|insert_sort (gint * data,gint n)
name|insert_sort
parameter_list|(
name|gint
modifier|*
name|data
parameter_list|,
name|gint
name|n
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|gint
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
literal|2
operator|*
name|n
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|tmp1
operator|=
name|data
index|[
name|i
index|]
expr_stmt|;
name|tmp2
operator|=
name|data
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|data
index|[
name|j
index|]
operator|<
name|tmp1
condition|)
name|j
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|k
operator|=
name|i
init|;
name|k
operator|>
name|j
condition|;
name|k
operator|-=
literal|2
control|)
block|{
name|data
index|[
name|k
index|]
operator|=
name|data
index|[
name|k
operator|-
literal|2
index|]
expr_stmt|;
name|data
index|[
name|k
operator|+
literal|1
index|]
operator|=
name|data
index|[
name|k
operator|-
literal|1
index|]
expr_stmt|;
block|}
name|data
index|[
name|j
index|]
operator|=
name|tmp1
expr_stmt|;
name|data
index|[
name|j
operator|+
literal|1
index|]
operator|=
name|tmp2
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|fill_run (guchar * dest,guchar alpha,gint w)
name|fill_run
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
name|alpha
parameter_list|,
name|gint
name|w
parameter_list|)
block|{
if|if
condition|(
name|alpha
operator|==
literal|255
condition|)
block|{
name|memset
argument_list|(
name|dest
argument_list|,
literal|255
argument_list|,
name|w
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|w
operator|--
condition|)
block|{
operator|*
name|dest
operator|=
name|MAX
argument_list|(
operator|*
name|dest
argument_list|,
name|alpha
argument_list|)
expr_stmt|;
name|dest
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|render_blob_line (Blob * blob,guchar * dest,gint x,gint y,gint width)
name|render_blob_line
parameter_list|(
name|Blob
modifier|*
name|blob
parameter_list|,
name|guchar
modifier|*
name|dest
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|width
parameter_list|)
block|{
name|gint
name|buf
index|[
literal|4
operator|*
name|SUBSAMPLE
index|]
decl_stmt|;
name|gint
modifier|*
name|data
init|=
name|buf
decl_stmt|;
name|gint
name|n
init|=
literal|0
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|gint
name|current
init|=
literal|0
decl_stmt|;
comment|/* number of filled rows at this point 		       * in the scan line 		       */
name|gint
name|last_x
decl_stmt|;
comment|/* Sort start and ends for all lines */
name|j
operator|=
name|y
operator|*
name|SUBSAMPLE
operator|-
name|blob
operator|->
name|y
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SUBSAMPLE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|>=
name|blob
operator|->
name|height
condition|)
break|break;
if|if
condition|(
operator|(
name|j
operator|>
literal|0
operator|)
operator|&&
operator|(
name|blob
operator|->
name|data
index|[
name|j
index|]
operator|.
name|left
operator|<=
name|blob
operator|->
name|data
index|[
name|j
index|]
operator|.
name|right
operator|)
condition|)
block|{
name|data
index|[
literal|2
operator|*
name|n
index|]
operator|=
name|blob
operator|->
name|data
index|[
name|j
index|]
operator|.
name|left
expr_stmt|;
name|data
index|[
literal|2
operator|*
name|n
operator|+
literal|1
index|]
operator|=
name|ROW_START
expr_stmt|;
name|data
index|[
literal|2
operator|*
name|SUBSAMPLE
operator|+
literal|2
operator|*
name|n
index|]
operator|=
name|blob
operator|->
name|data
index|[
name|j
index|]
operator|.
name|right
expr_stmt|;
name|data
index|[
literal|2
operator|*
name|SUBSAMPLE
operator|+
literal|2
operator|*
name|n
operator|+
literal|1
index|]
operator|=
name|ROW_STOP
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
name|j
operator|++
expr_stmt|;
block|}
comment|/*   If we have less than SUBSAMPLE rows, compress */
if|if
condition|(
name|n
operator|<
name|SUBSAMPLE
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
operator|*
name|n
condition|;
name|i
operator|++
control|)
name|data
index|[
literal|2
operator|*
name|n
operator|+
name|i
index|]
operator|=
name|data
index|[
literal|2
operator|*
name|SUBSAMPLE
operator|+
name|i
index|]
expr_stmt|;
block|}
comment|/*   Now count start and end separately */
name|n
operator|*=
literal|2
expr_stmt|;
name|insert_sort
argument_list|(
name|data
argument_list|,
name|n
argument_list|)
expr_stmt|;
comment|/* Discard portions outside of tile */
while|while
condition|(
operator|(
name|n
operator|>
literal|0
operator|)
operator|&&
operator|(
name|data
index|[
literal|0
index|]
operator|<
name|SUBSAMPLE
operator|*
name|x
operator|)
condition|)
block|{
if|if
condition|(
name|data
index|[
literal|1
index|]
operator|==
name|ROW_START
condition|)
name|current
operator|++
expr_stmt|;
else|else
name|current
operator|--
expr_stmt|;
name|data
operator|+=
literal|2
expr_stmt|;
name|n
operator|--
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|n
operator|>
literal|0
operator|)
operator|&&
operator|(
name|data
index|[
literal|2
operator|*
operator|(
name|n
operator|-
literal|1
operator|)
index|]
operator|>=
name|SUBSAMPLE
operator|*
operator|(
name|x
operator|+
name|width
operator|)
operator|)
condition|)
name|n
operator|--
expr_stmt|;
comment|/* Render the row */
name|last_x
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
control|)
block|{
name|gint
name|cur_x
init|=
name|data
index|[
literal|2
operator|*
name|i
index|]
operator|/
name|SUBSAMPLE
operator|-
name|x
decl_stmt|;
name|gint
name|pixel
decl_stmt|;
comment|/* Fill in portion leading up to this pixel */
if|if
condition|(
name|current
operator|&&
name|cur_x
operator|!=
name|last_x
condition|)
name|fill_run
argument_list|(
name|dest
operator|+
name|last_x
argument_list|,
operator|(
literal|255
operator|*
name|current
operator|)
operator|/
name|SUBSAMPLE
argument_list|,
name|cur_x
operator|-
name|last_x
argument_list|)
expr_stmt|;
comment|/* Compute the value for this pixel */
name|pixel
operator|=
name|current
operator|*
name|SUBSAMPLE
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|n
condition|)
block|{
name|gint
name|tmp_x
init|=
name|data
index|[
literal|2
operator|*
name|i
index|]
operator|/
name|SUBSAMPLE
decl_stmt|;
if|if
condition|(
name|tmp_x
operator|-
name|x
operator|!=
name|cur_x
condition|)
break|break;
if|if
condition|(
name|data
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
operator|==
name|ROW_START
condition|)
block|{
name|current
operator|++
expr_stmt|;
name|pixel
operator|+=
operator|(
operator|(
name|tmp_x
operator|+
literal|1
operator|)
operator|*
name|SUBSAMPLE
operator|)
operator|-
name|data
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|current
operator|--
expr_stmt|;
name|pixel
operator|-=
operator|(
operator|(
name|tmp_x
operator|+
literal|1
operator|)
operator|*
name|SUBSAMPLE
operator|)
operator|-
name|data
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
block|}
name|i
operator|++
expr_stmt|;
block|}
name|dest
index|[
name|cur_x
index|]
operator|=
name|MAX
argument_list|(
name|dest
index|[
name|cur_x
index|]
argument_list|,
operator|(
name|pixel
operator|*
literal|255
operator|)
operator|/
operator|(
name|SUBSAMPLE
operator|*
name|SUBSAMPLE
operator|)
argument_list|)
expr_stmt|;
name|last_x
operator|=
name|cur_x
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|current
operator|!=
literal|0
condition|)
name|fill_run
argument_list|(
name|dest
operator|+
name|last_x
argument_list|,
operator|(
literal|255
operator|*
name|current
operator|)
operator|/
name|SUBSAMPLE
argument_list|,
name|width
operator|-
name|last_x
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|render_blob (PixelRegion * dest,Blob * blob)
name|render_blob
parameter_list|(
name|PixelRegion
modifier|*
name|dest
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|gint
name|h
decl_stmt|;
name|guchar
modifier|*
name|s
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|1
argument_list|,
name|dest
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
name|h
operator|=
name|dest
operator|->
name|h
expr_stmt|;
name|s
operator|=
name|dest
operator|->
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|h
condition|;
name|i
operator|++
control|)
block|{
name|render_blob_line
argument_list|(
name|blob
argument_list|,
name|s
argument_list|,
name|dest
operator|->
name|x
argument_list|,
name|dest
operator|->
name|y
operator|+
name|i
argument_list|,
name|dest
operator|->
name|w
argument_list|)
expr_stmt|;
name|s
operator|+=
name|dest
operator|->
name|rowstride
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ink_paste (GimpInkTool * ink_tool,GimpDrawable * drawable,Blob * blob)
name|ink_paste
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|)
block|{
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
name|GimpContext
modifier|*
name|context
decl_stmt|;
name|PixelRegion
name|srcPR
decl_stmt|;
name|gint
name|offx
decl_stmt|,
name|offy
decl_stmt|;
name|gchar
name|col
index|[
name|MAX_CHANNELS
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|gimp_drawable_gimage
argument_list|(
name|drawable
argument_list|)
operator|)
condition|)
return|return;
name|context
operator|=
name|gimp_get_current_context
argument_list|(
name|gimage
operator|->
name|gimp
argument_list|)
expr_stmt|;
comment|/* Get the the buffer */
name|ink_set_paint_area
argument_list|(
name|ink_tool
argument_list|,
name|drawable
argument_list|,
name|blob
argument_list|)
expr_stmt|;
comment|/* check to make sure there is actually a canvas to draw on */
if|if
condition|(
operator|!
name|canvas_buf
condition|)
return|return;
name|gimp_image_get_foreground
argument_list|(
name|gimage
argument_list|,
name|drawable
argument_list|,
name|col
argument_list|)
expr_stmt|;
comment|/*  set the alpha channel  */
name|col
index|[
name|canvas_buf
operator|->
name|bytes
operator|-
literal|1
index|]
operator|=
name|OPAQUE_OPACITY
expr_stmt|;
comment|/*  color the pixels  */
name|color_pixels
argument_list|(
name|temp_buf_data
argument_list|(
name|canvas_buf
argument_list|)
argument_list|,
name|col
argument_list|,
name|canvas_buf
operator|->
name|width
operator|*
name|canvas_buf
operator|->
name|height
argument_list|,
name|canvas_buf
operator|->
name|bytes
argument_list|)
expr_stmt|;
comment|/*  set undo blocks  */
name|ink_set_undo_tiles
argument_list|(
name|drawable
argument_list|,
name|canvas_buf
operator|->
name|x
argument_list|,
name|canvas_buf
operator|->
name|y
argument_list|,
name|canvas_buf
operator|->
name|width
argument_list|,
name|canvas_buf
operator|->
name|height
argument_list|)
expr_stmt|;
comment|/*  initialize any invalid canvas tiles  */
name|ink_set_canvas_tiles
argument_list|(
name|canvas_buf
operator|->
name|x
argument_list|,
name|canvas_buf
operator|->
name|y
argument_list|,
name|canvas_buf
operator|->
name|width
argument_list|,
name|canvas_buf
operator|->
name|height
argument_list|)
expr_stmt|;
name|ink_to_canvas_tiles
argument_list|(
name|ink_tool
argument_list|,
name|blob
argument_list|,
name|col
argument_list|)
expr_stmt|;
comment|/*  initialize canvas buf source pixel regions  */
name|srcPR
operator|.
name|bytes
operator|=
name|canvas_buf
operator|->
name|bytes
expr_stmt|;
name|srcPR
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|srcPR
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|srcPR
operator|.
name|w
operator|=
name|canvas_buf
operator|->
name|width
expr_stmt|;
name|srcPR
operator|.
name|h
operator|=
name|canvas_buf
operator|->
name|height
expr_stmt|;
name|srcPR
operator|.
name|rowstride
operator|=
name|canvas_buf
operator|->
name|width
operator|*
name|canvas_buf
operator|->
name|bytes
expr_stmt|;
name|srcPR
operator|.
name|data
operator|=
name|temp_buf_data
argument_list|(
name|canvas_buf
argument_list|)
expr_stmt|;
comment|/*  apply the paint area to the gimage  */
name|gimp_image_apply_image
argument_list|(
name|gimage
argument_list|,
name|drawable
argument_list|,
operator|&
name|srcPR
argument_list|,
name|FALSE
argument_list|,
call|(
name|int
call|)
argument_list|(
name|gimp_context_get_opacity
argument_list|(
name|context
argument_list|)
operator|*
literal|255
argument_list|)
argument_list|,
name|gimp_context_get_paint_mode
argument_list|(
name|context
argument_list|)
argument_list|,
name|undo_tiles
argument_list|,
comment|/*  specify an alternative src1  */
name|canvas_buf
operator|->
name|x
argument_list|,
name|canvas_buf
operator|->
name|y
argument_list|)
expr_stmt|;
comment|/*  Update the undo extents  */
name|ink_tool
operator|->
name|x1
operator|=
name|MIN
argument_list|(
name|ink_tool
operator|->
name|x1
argument_list|,
name|canvas_buf
operator|->
name|x
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|y1
operator|=
name|MIN
argument_list|(
name|ink_tool
operator|->
name|y1
argument_list|,
name|canvas_buf
operator|->
name|y
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|x2
operator|=
name|MAX
argument_list|(
name|ink_tool
operator|->
name|x2
argument_list|,
operator|(
name|canvas_buf
operator|->
name|x
operator|+
name|canvas_buf
operator|->
name|width
operator|)
argument_list|)
expr_stmt|;
name|ink_tool
operator|->
name|y2
operator|=
name|MAX
argument_list|(
name|ink_tool
operator|->
name|y2
argument_list|,
operator|(
name|canvas_buf
operator|->
name|y
operator|+
name|canvas_buf
operator|->
name|height
operator|)
argument_list|)
expr_stmt|;
comment|/*  Update the gimage--it is important to call gimp_image_update    *  instead of drawable_update because we don't want the drawable    *  preview to be constantly invalidated    */
name|gimp_drawable_offsets
argument_list|(
name|drawable
argument_list|,
operator|&
name|offx
argument_list|,
operator|&
name|offy
argument_list|)
expr_stmt|;
name|gimp_image_update
argument_list|(
name|gimage
argument_list|,
name|canvas_buf
operator|->
name|x
operator|+
name|offx
argument_list|,
name|canvas_buf
operator|->
name|y
operator|+
name|offy
argument_list|,
name|canvas_buf
operator|->
name|width
argument_list|,
name|canvas_buf
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This routine a) updates the representation of the stroke  * in the canvas tiles, then renders the dirty bit of it  * into canvas_buf.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|ink_to_canvas_tiles (GimpInkTool * ink_tool,Blob * blob,guchar * color)
name|ink_to_canvas_tiles
parameter_list|(
name|GimpInkTool
modifier|*
name|ink_tool
parameter_list|,
name|Blob
modifier|*
name|blob
parameter_list|,
name|guchar
modifier|*
name|color
parameter_list|)
block|{
name|PixelRegion
name|srcPR
decl_stmt|,
name|maskPR
decl_stmt|;
comment|/*  draw the blob on the canvas tiles  */
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|canvas_tiles
argument_list|,
name|canvas_buf
operator|->
name|x
argument_list|,
name|canvas_buf
operator|->
name|y
argument_list|,
name|canvas_buf
operator|->
name|width
argument_list|,
name|canvas_buf
operator|->
name|height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|render_blob
argument_list|(
operator|&
name|srcPR
argument_list|,
name|blob
argument_list|)
expr_stmt|;
comment|/*  combine the canvas tiles and the canvas buf  */
name|srcPR
operator|.
name|bytes
operator|=
name|canvas_buf
operator|->
name|bytes
expr_stmt|;
name|srcPR
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|srcPR
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|srcPR
operator|.
name|w
operator|=
name|canvas_buf
operator|->
name|width
expr_stmt|;
name|srcPR
operator|.
name|h
operator|=
name|canvas_buf
operator|->
name|height
expr_stmt|;
name|srcPR
operator|.
name|rowstride
operator|=
name|canvas_buf
operator|->
name|width
operator|*
name|canvas_buf
operator|->
name|bytes
expr_stmt|;
name|srcPR
operator|.
name|data
operator|=
name|temp_buf_data
argument_list|(
name|canvas_buf
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|maskPR
argument_list|,
name|canvas_tiles
argument_list|,
name|canvas_buf
operator|->
name|x
argument_list|,
name|canvas_buf
operator|->
name|y
argument_list|,
name|canvas_buf
operator|->
name|width
argument_list|,
name|canvas_buf
operator|->
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  apply the canvas tiles to the canvas buf  */
name|apply_mask_to_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|maskPR
argument_list|,
name|OPAQUE_OPACITY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ink_set_undo_tiles (GimpDrawable * drawable,gint x,gint y,gint w,gint h)
name|ink_set_undo_tiles
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|Tile
modifier|*
name|src_tile
decl_stmt|;
name|Tile
modifier|*
name|dest_tile
decl_stmt|;
for|for
control|(
name|i
operator|=
name|y
init|;
name|i
operator|<
operator|(
name|y
operator|+
name|h
operator|)
condition|;
name|i
operator|+=
operator|(
name|TILE_HEIGHT
operator|-
operator|(
name|i
operator|%
name|TILE_HEIGHT
operator|)
operator|)
control|)
block|{
for|for
control|(
name|j
operator|=
name|x
init|;
name|j
operator|<
operator|(
name|x
operator|+
name|w
operator|)
condition|;
name|j
operator|+=
operator|(
name|TILE_WIDTH
operator|-
operator|(
name|j
operator|%
name|TILE_WIDTH
operator|)
operator|)
control|)
block|{
name|dest_tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|undo_tiles
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tile_is_valid
argument_list|(
name|dest_tile
argument_list|)
operator|==
name|FALSE
condition|)
block|{
name|src_tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|gimp_drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|tile_manager_map_tile
argument_list|(
name|undo_tiles
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|src_tile
argument_list|)
expr_stmt|;
name|tile_release
argument_list|(
name|src_tile
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ink_set_canvas_tiles (gint x,gint y,gint w,gint h)
name|ink_set_canvas_tiles
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|Tile
modifier|*
name|tile
decl_stmt|;
for|for
control|(
name|i
operator|=
name|y
init|;
name|i
operator|<
operator|(
name|y
operator|+
name|h
operator|)
condition|;
name|i
operator|+=
operator|(
name|TILE_HEIGHT
operator|-
operator|(
name|i
operator|%
name|TILE_HEIGHT
operator|)
operator|)
control|)
block|{
for|for
control|(
name|j
operator|=
name|x
init|;
name|j
operator|<
operator|(
name|x
operator|+
name|w
operator|)
condition|;
name|j
operator|+=
operator|(
name|TILE_WIDTH
operator|-
operator|(
name|j
operator|%
name|TILE_WIDTH
operator|)
operator|)
control|)
block|{
name|tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|canvas_tiles
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tile_is_valid
argument_list|(
name|tile
argument_list|)
operator|==
name|FALSE
condition|)
block|{
name|tile
operator|=
name|tile_manager_get_tile
argument_list|(
name|canvas_tiles
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|tile_data_pointer
argument_list|(
name|tile
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
name|tile_size
argument_list|(
name|tile
argument_list|)
argument_list|)
expr_stmt|;
name|tile_release
argument_list|(
name|tile
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*  tool options stuff  */
end_comment

begin_function
specifier|static
name|GimpToolOptions
modifier|*
DECL|function|ink_options_new (GimpToolInfo * tool_info)
name|ink_options_new
parameter_list|(
name|GimpToolInfo
modifier|*
name|tool_info
parameter_list|)
block|{
name|InkOptions
modifier|*
name|options
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox2
decl_stmt|;
name|GtkWidget
modifier|*
name|radio_button
decl_stmt|;
name|GtkWidget
modifier|*
name|pixmap_widget
decl_stmt|;
name|GtkWidget
modifier|*
name|slider
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|darea
decl_stmt|;
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
name|options
operator|=
name|g_new0
argument_list|(
name|InkOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|paint_options_init
argument_list|(
operator|(
name|PaintOptions
operator|*
operator|)
name|options
argument_list|,
name|tool_info
argument_list|)
expr_stmt|;
operator|(
operator|(
name|GimpToolOptions
operator|*
operator|)
name|options
operator|)
operator|->
name|reset_func
operator|=
name|ink_options_reset
expr_stmt|;
name|options
operator|->
name|size
operator|=
name|options
operator|->
name|size_d
operator|=
literal|4.4
expr_stmt|;
name|options
operator|->
name|sensitivity
operator|=
name|options
operator|->
name|sensitivity_d
operator|=
literal|1.0
expr_stmt|;
name|options
operator|->
name|vel_sensitivity
operator|=
name|options
operator|->
name|vel_sensitivity_d
operator|=
literal|0.8
expr_stmt|;
name|options
operator|->
name|tilt_sensitivity
operator|=
name|options
operator|->
name|tilt_sensitivity_d
operator|=
literal|0.4
expr_stmt|;
name|options
operator|->
name|tilt_angle
operator|=
name|options
operator|->
name|tilt_angle_d
operator|=
literal|0.0
expr_stmt|;
name|options
operator|->
name|function
operator|=
name|options
operator|->
name|function_d
operator|=
name|blob_ellipse
expr_stmt|;
name|options
operator|->
name|aspect
operator|=
name|options
operator|->
name|aspect_d
operator|=
literal|1.0
expr_stmt|;
name|options
operator|->
name|angle
operator|=
name|options
operator|->
name|angle_d
operator|=
literal|0.0
expr_stmt|;
comment|/*  the main vbox  */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
operator|(
operator|(
name|GimpToolOptions
operator|*
operator|)
name|options
operator|)
operator|->
name|main_vbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
comment|/* adjust sliders */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Adjustment"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/*  size slider  */
name|options
operator|->
name|size_w
operator|=
name|gtk_adjustment_new
argument_list|(
name|options
operator|->
name|size_d
argument_list|,
literal|0.0
argument_list|,
literal|20.0
argument_list|,
literal|1.0
argument_list|,
literal|2.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|slider
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|size_w
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Size:"
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
name|slider
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_UPDATE_DELAYED
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|options
operator|->
name|size_w
argument_list|)
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|options
operator|->
name|size
argument_list|)
expr_stmt|;
comment|/* angle adjust slider */
name|options
operator|->
name|tilt_angle_w
operator|=
name|gtk_adjustment_new
argument_list|(
name|options
operator|->
name|tilt_angle_d
argument_list|,
operator|-
literal|90.0
argument_list|,
literal|90.0
argument_list|,
literal|1
argument_list|,
literal|10.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|slider
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|tilt_angle_w
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Angle:"
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
name|slider
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_UPDATE_DELAYED
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|options
operator|->
name|tilt_angle_w
argument_list|)
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|options
operator|->
name|tilt_angle
argument_list|)
expr_stmt|;
comment|/* sens sliders */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Sensitivity"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/* size sens slider */
name|options
operator|->
name|sensitivity_w
operator|=
name|gtk_adjustment_new
argument_list|(
name|options
operator|->
name|sensitivity_d
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|slider
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|sensitivity_w
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Size:"
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
name|slider
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_UPDATE_DELAYED
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|options
operator|->
name|sensitivity_w
argument_list|)
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|options
operator|->
name|sensitivity
argument_list|)
expr_stmt|;
comment|/* tilt sens slider */
name|options
operator|->
name|tilt_sensitivity_w
operator|=
name|gtk_adjustment_new
argument_list|(
name|options
operator|->
name|tilt_sensitivity_d
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|slider
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|tilt_sensitivity_w
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|_
argument_list|(
literal|"Tilt:"
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
name|slider
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_UPDATE_DELAYED
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|options
operator|->
name|tilt_sensitivity_w
argument_list|)
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|options
operator|->
name|tilt_sensitivity
argument_list|)
expr_stmt|;
comment|/* velocity sens slider */
name|options
operator|->
name|vel_sensitivity_w
operator|=
name|gtk_adjustment_new
argument_list|(
name|options
operator|->
name|vel_sensitivity_d
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|slider
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|vel_sensitivity_w
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|_
argument_list|(
literal|"Speed:"
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
name|slider
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_UPDATE_DELAYED
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|options
operator|->
name|vel_sensitivity_w
argument_list|)
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|options
operator|->
name|vel_sensitivity
argument_list|)
expr_stmt|;
comment|/*  bottom hbox */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/* Brush type radiobuttons */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Type"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|hbox2
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|hbox2
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox2
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|pixmap
operator|=
name|blob_pixmap
argument_list|(
name|gtk_widget_get_colormap
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|gtk_widget_get_visual
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|blob_ellipse
argument_list|)
expr_stmt|;
name|pixmap_widget
operator|=
name|gtk_pixmap_new
argument_list|(
name|pixmap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gdk_drawable_unref
argument_list|(
name|pixmap
argument_list|)
expr_stmt|;
name|gtk_misc_set_padding
argument_list|(
name|GTK_MISC
argument_list|(
name|pixmap_widget
argument_list|)
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radio_button
operator|=
name|gtk_radio_button_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|radio_button
argument_list|)
argument_list|,
name|pixmap_widget
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|radio_button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|radio_button
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ink_type_update
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|blob_ellipse
argument_list|)
expr_stmt|;
name|options
operator|->
name|function_w
index|[
literal|0
index|]
operator|=
name|radio_button
expr_stmt|;
name|pixmap
operator|=
name|blob_pixmap
argument_list|(
name|gtk_widget_get_colormap
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|gtk_widget_get_visual
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|blob_square
argument_list|)
expr_stmt|;
name|pixmap_widget
operator|=
name|gtk_pixmap_new
argument_list|(
name|pixmap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gdk_drawable_unref
argument_list|(
name|pixmap
argument_list|)
expr_stmt|;
name|gtk_misc_set_padding
argument_list|(
name|GTK_MISC
argument_list|(
name|pixmap_widget
argument_list|)
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radio_button
operator|=
name|gtk_radio_button_new_from_widget
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|radio_button
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|radio_button
argument_list|)
argument_list|,
name|pixmap_widget
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|radio_button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|radio_button
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ink_type_update
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|blob_square
argument_list|)
expr_stmt|;
name|options
operator|->
name|function_w
index|[
literal|1
index|]
operator|=
name|radio_button
expr_stmt|;
name|pixmap
operator|=
name|blob_pixmap
argument_list|(
name|gtk_widget_get_colormap
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|gtk_widget_get_visual
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|blob_diamond
argument_list|)
expr_stmt|;
name|pixmap_widget
operator|=
name|gtk_pixmap_new
argument_list|(
name|pixmap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gdk_drawable_unref
argument_list|(
name|pixmap
argument_list|)
expr_stmt|;
name|gtk_misc_set_padding
argument_list|(
name|GTK_MISC
argument_list|(
name|pixmap_widget
argument_list|)
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radio_button
operator|=
name|gtk_radio_button_new_from_widget
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|radio_button
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|radio_button
argument_list|)
argument_list|,
name|pixmap_widget
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|radio_button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|radio_button
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ink_type_update
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|blob_diamond
argument_list|)
expr_stmt|;
name|options
operator|->
name|function_w
index|[
literal|2
index|]
operator|=
name|radio_button
expr_stmt|;
comment|/* Brush shape widget */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Shape"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_aspect_frame_new
argument_list|(
name|NULL
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
literal|1.0
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|options
operator|->
name|brush_w
operator|=
name|g_new
argument_list|(
name|BrushWidget
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|options
operator|->
name|brush_w
operator|->
name|state
operator|=
name|FALSE
expr_stmt|;
name|options
operator|->
name|brush_w
operator|->
name|ink_options
operator|=
name|options
expr_stmt|;
name|darea
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|options
operator|->
name|brush_w
operator|->
name|widget
operator|=
name|darea
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|darea
argument_list|)
argument_list|,
literal|60
argument_list|,
literal|60
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|darea
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|darea
argument_list|,
name|GDK_BUTTON_PRESS_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
operator||
name|GDK_POINTER_MOTION_MASK
operator||
name|GDK_EXPOSURE_MASK
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|darea
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|brush_widget_button_press
argument_list|)
argument_list|,
name|options
operator|->
name|brush_w
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|darea
argument_list|)
argument_list|,
literal|"button_release_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|brush_widget_button_release
argument_list|)
argument_list|,
name|options
operator|->
name|brush_w
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|darea
argument_list|)
argument_list|,
literal|"motion_notify_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|brush_widget_motion_notify
argument_list|)
argument_list|,
name|options
operator|->
name|brush_w
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|darea
argument_list|)
argument_list|,
literal|"expose_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|brush_widget_expose
argument_list|)
argument_list|,
name|options
operator|->
name|brush_w
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|darea
argument_list|)
argument_list|,
literal|"realize"
argument_list|,
name|G_CALLBACK
argument_list|(
name|brush_widget_realize
argument_list|)
argument_list|,
name|options
operator|->
name|brush_w
argument_list|)
expr_stmt|;
name|gtk_widget_show_all
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|ink_options_reset
argument_list|(
operator|(
name|GimpToolOptions
operator|*
operator|)
name|options
argument_list|)
expr_stmt|;
return|return
operator|(
name|GimpToolOptions
operator|*
operator|)
name|options
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ink_options_reset (GimpToolOptions * tool_options)
name|ink_options_reset
parameter_list|(
name|GimpToolOptions
modifier|*
name|tool_options
parameter_list|)
block|{
name|InkOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|InkOptions
operator|*
operator|)
name|tool_options
expr_stmt|;
name|paint_options_reset
argument_list|(
name|tool_options
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|size_w
argument_list|)
argument_list|,
name|options
operator|->
name|size_d
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|sensitivity_w
argument_list|)
argument_list|,
name|options
operator|->
name|sensitivity_d
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|tilt_sensitivity_w
argument_list|)
argument_list|,
name|options
operator|->
name|tilt_sensitivity_d
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|vel_sensitivity_w
argument_list|)
argument_list|,
name|options
operator|->
name|vel_sensitivity_d
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|options
operator|->
name|tilt_angle_w
argument_list|)
argument_list|,
name|options
operator|->
name|tilt_angle_d
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
operator|(
operator|(
name|options
operator|->
name|function_d
operator|==
name|blob_ellipse
operator|)
condition|?
name|GTK_TOGGLE_BUTTON
argument_list|(
name|options
operator|->
name|function_w
index|[
literal|0
index|]
argument_list|)
else|:
operator|(
operator|(
name|options
operator|->
name|function_d
operator|==
name|blob_square
operator|)
condition|?
name|GTK_TOGGLE_BUTTON
argument_list|(
name|options
operator|->
name|function_w
index|[
literal|1
index|]
argument_list|)
else|:
name|GTK_TOGGLE_BUTTON
argument_list|(
name|options
operator|->
name|function_w
index|[
literal|2
index|]
argument_list|)
operator|)
operator|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|options
operator|->
name|aspect
operator|=
name|options
operator|->
name|aspect_d
expr_stmt|;
name|options
operator|->
name|angle
operator|=
name|options
operator|->
name|angle_d
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|options
operator|->
name|brush_w
operator|->
name|widget
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ink_type_update (GtkWidget * radio_button,BlobFunc function)
name|ink_type_update
parameter_list|(
name|GtkWidget
modifier|*
name|radio_button
parameter_list|,
name|BlobFunc
name|function
parameter_list|)
block|{
name|GimpToolInfo
modifier|*
name|tool_info
decl_stmt|;
name|InkOptions
modifier|*
name|options
decl_stmt|;
name|tool_info
operator|=
name|tool_manager_get_info_by_type
argument_list|(
name|the_gimp
argument_list|,
name|GIMP_TYPE_INK_TOOL
argument_list|)
expr_stmt|;
name|options
operator|=
operator|(
name|InkOptions
operator|*
operator|)
name|tool_info
operator|->
name|tool_options
expr_stmt|;
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|radio_button
argument_list|)
operator|->
name|active
condition|)
name|options
operator|->
name|function
operator|=
name|function
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|options
operator|->
name|brush_w
operator|->
name|widget
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

