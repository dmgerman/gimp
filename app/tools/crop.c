begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"gdk/gdkkeysyms.h"
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"actionarea.h"
end_include

begin_include
include|#
directive|include
file|"cursorutil.h"
end_include

begin_include
include|#
directive|include
file|"draw_core.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"floating_sel.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"gimage_mask.h"
end_include

begin_include
include|#
directive|include
file|"crop.h"
end_include

begin_include
include|#
directive|include
file|"info_dialog.h"
end_include

begin_include
include|#
directive|include
file|"undo.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpsizeentry.h"
end_include

begin_define
DECL|macro|STATUSBAR_SIZE
define|#
directive|define
name|STATUSBAR_SIZE
value|128
end_define

begin_typedef
DECL|typedef|Crop
typedef|typedef
name|struct
name|_crop
name|Crop
typedef|;
end_typedef

begin_struct
DECL|struct|_crop
struct|struct
name|_crop
block|{
DECL|member|core
name|DrawCore
modifier|*
name|core
decl_stmt|;
comment|/*  Core select object          */
DECL|member|startx
name|int
name|startx
decl_stmt|;
comment|/*  starting x coord            */
DECL|member|starty
name|int
name|starty
decl_stmt|;
comment|/*  starting y coord            */
DECL|member|lastx
name|int
name|lastx
decl_stmt|;
comment|/*  previous x coord            */
DECL|member|lasty
name|int
name|lasty
decl_stmt|;
comment|/*  previous y coord            */
DECL|member|x1
DECL|member|y1
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|;
comment|/*  upper left hand coordinate  */
DECL|member|x2
DECL|member|y2
name|int
name|x2
decl_stmt|,
name|y2
decl_stmt|;
comment|/*  lower right hand coords     */
DECL|member|srw
DECL|member|srh
name|int
name|srw
decl_stmt|,
name|srh
decl_stmt|;
comment|/*  width and height of corners */
DECL|member|tx1
DECL|member|ty1
name|int
name|tx1
decl_stmt|,
name|ty1
decl_stmt|;
comment|/*  transformed coords          */
DECL|member|tx2
DECL|member|ty2
name|int
name|tx2
decl_stmt|,
name|ty2
decl_stmt|;
comment|/*                              */
DECL|member|function
name|int
name|function
decl_stmt|;
comment|/*  moving or resizing          */
DECL|member|context_id
name|guint
name|context_id
decl_stmt|;
comment|/*  for the statusbar           */
block|}
struct|;
end_struct

begin_comment
comment|/* possible crop functions */
end_comment

begin_define
DECL|macro|CREATING
define|#
directive|define
name|CREATING
value|0
end_define

begin_define
DECL|macro|MOVING
define|#
directive|define
name|MOVING
value|1
end_define

begin_define
DECL|macro|RESIZING_LEFT
define|#
directive|define
name|RESIZING_LEFT
value|2
end_define

begin_define
DECL|macro|RESIZING_RIGHT
define|#
directive|define
name|RESIZING_RIGHT
value|3
end_define

begin_define
DECL|macro|CROPPING
define|#
directive|define
name|CROPPING
value|4
end_define

begin_define
DECL|macro|REFRAMING
define|#
directive|define
name|REFRAMING
value|5
end_define

begin_comment
comment|/* speed of key movement */
end_comment

begin_define
DECL|macro|ARROW_VELOCITY
define|#
directive|define
name|ARROW_VELOCITY
value|25
end_define

begin_decl_stmt
DECL|variable|crop_info
specifier|static
name|InfoDialog
modifier|*
name|crop_info
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|orig_vals
specifier|static
name|gfloat
name|orig_vals
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|size_vals
specifier|static
name|gfloat
name|size_vals
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|origin_sizeentry
specifier|static
name|GtkWidget
modifier|*
name|origin_sizeentry
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|size_sizeentry
specifier|static
name|GtkWidget
modifier|*
name|size_sizeentry
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  crop action functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_button_press
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_button_release
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_motion
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_cursor_update
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_control
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|int
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_arrow_keys_func
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventKey
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Crop helper functions   */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_image
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_recalc
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|Crop
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_start
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|Crop
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_adjust_guides
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Crop dialog functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_info_update
parameter_list|(
name|Tool
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_info_create
parameter_list|(
name|Tool
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_resize_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_selection_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_close_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Crop dialog callback funtions  */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_orig_changed
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|crop_size_changed
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Options callbacks */
end_comment

begin_function_decl
specifier|static
name|void
name|crop_checkbutton_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|options_widget
specifier|static
name|GtkWidget
modifier|*
name|options_widget
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|options
specifier|static
name|CropToolOptions
name|options
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|Argument
modifier|*
name|crop_invoker
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|init_crop_options ()
name|init_crop_options
parameter_list|()
block|{
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|checkbutton
decl_stmt|;
name|GtkWidget
modifier|*
name|defaults_frame
decl_stmt|;
name|GtkWidget
modifier|*
name|defaults_box
decl_stmt|;
name|options
operator|.
name|layer_only
operator|=
name|FALSE
expr_stmt|;
name|options
operator|.
name|default_to_enlarge
operator|=
name|TRUE
expr_stmt|;
name|options
operator|.
name|default_to_crop
operator|=
name|FALSE
expr_stmt|;
comment|/*  the main vbox  */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/*  the main label  */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Crop Options"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/* layer toggle */
name|checkbutton
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Current layer only"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|checkbutton
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|checkbutton
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|crop_checkbutton_update
argument_list|,
operator|&
name|options
operator|.
name|layer_only
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|checkbutton
argument_list|)
argument_list|,
name|options
operator|.
name|layer_only
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|checkbutton
argument_list|)
expr_stmt|;
comment|/* defaults */
name|defaults_frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Defaults"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|defaults_frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|defaults_box
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|defaults_frame
argument_list|)
argument_list|,
name|defaults_box
argument_list|)
expr_stmt|;
comment|/* enlarge toggle */
name|checkbutton
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Allow Enlarging"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|defaults_box
argument_list|)
argument_list|,
name|checkbutton
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|checkbutton
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|crop_checkbutton_update
argument_list|,
operator|&
name|options
operator|.
name|default_to_enlarge
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|checkbutton
argument_list|)
argument_list|,
name|options
operator|.
name|default_to_enlarge
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|checkbutton
argument_list|)
expr_stmt|;
comment|/* crop toggle */
name|checkbutton
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Crop Layers"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|defaults_box
argument_list|)
argument_list|,
name|checkbutton
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|checkbutton
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|crop_checkbutton_update
argument_list|,
operator|&
name|options
operator|.
name|default_to_crop
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|checkbutton
argument_list|)
argument_list|,
name|options
operator|.
name|default_to_crop
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|checkbutton
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|defaults_box
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|defaults_frame
argument_list|)
expr_stmt|;
comment|/* Register this selection options widget with the main tools    * options dialog */
name|tools_register_options
argument_list|(
name|CROP
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_checkbutton_update (GtkWidget * w,gpointer data)
name|crop_checkbutton_update
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
modifier|*
name|toggle_val
decl_stmt|;
name|toggle_val
operator|=
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|w
argument_list|)
operator|->
name|active
condition|)
operator|*
name|toggle_val
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|toggle_val
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_button_press (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|crop_button_press
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|INACTIVE
condition|)
name|crop
operator|->
name|function
operator|=
name|CREATING
expr_stmt|;
elseif|else
if|if
condition|(
name|gdisp_ptr
operator|!=
name|tool
operator|->
name|gdisp_ptr
condition|)
name|crop
operator|->
name|function
operator|=
name|CREATING
expr_stmt|;
else|else
block|{
comment|/*  If the cursor is in either the upper left or lower right boxes, 	  The new function will be to resize the current crop area        */
if|if
condition|(
name|bevent
operator|->
name|x
operator|==
name|BOUNDS
argument_list|(
name|bevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|x1
operator|+
name|crop
operator|->
name|srw
argument_list|)
operator|&&
name|bevent
operator|->
name|y
operator|==
name|BOUNDS
argument_list|(
name|bevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|y1
operator|+
name|crop
operator|->
name|srh
argument_list|)
condition|)
name|crop
operator|->
name|function
operator|=
name|RESIZING_LEFT
expr_stmt|;
elseif|else
if|if
condition|(
name|bevent
operator|->
name|x
operator|==
name|BOUNDS
argument_list|(
name|bevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|x2
argument_list|)
operator|&&
name|bevent
operator|->
name|y
operator|==
name|BOUNDS
argument_list|(
name|bevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
condition|)
name|crop
operator|->
name|function
operator|=
name|RESIZING_RIGHT
expr_stmt|;
comment|/*  If the cursor is in either the upper right or lower left boxes, 	  The new function will be to translate the current crop area     */
elseif|else
if|if
condition|(
operator|(
name|bevent
operator|->
name|x
operator|==
name|BOUNDS
argument_list|(
name|bevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|x1
operator|+
name|crop
operator|->
name|srw
argument_list|)
operator|&&
name|bevent
operator|->
name|y
operator|==
name|BOUNDS
argument_list|(
name|bevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
operator|)
operator|||
operator|(
name|bevent
operator|->
name|x
operator|==
name|BOUNDS
argument_list|(
name|bevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|x2
argument_list|)
operator|&&
name|bevent
operator|->
name|y
operator|==
name|BOUNDS
argument_list|(
name|bevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|y1
operator|+
name|crop
operator|->
name|srh
argument_list|)
operator|)
condition|)
name|crop
operator|->
name|function
operator|=
name|MOVING
expr_stmt|;
comment|/*  If the pointer is in the rectangular region, crop or resize it!  */
elseif|else
if|if
condition|(
name|bevent
operator|->
name|x
operator|>
name|crop
operator|->
name|x1
operator|&&
name|bevent
operator|->
name|x
operator|<
name|crop
operator|->
name|x2
operator|&&
name|bevent
operator|->
name|y
operator|>
name|crop
operator|->
name|y1
operator|&&
name|bevent
operator|->
name|y
operator|<
name|crop
operator|->
name|y2
condition|)
block|{
if|if
condition|(
name|options
operator|.
name|default_to_crop
condition|)
block|{
if|if
condition|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
name|crop
operator|->
name|function
operator|=
name|REFRAMING
expr_stmt|;
else|else
name|crop
operator|->
name|function
operator|=
name|CROPPING
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
name|crop
operator|->
name|function
operator|=
name|CROPPING
expr_stmt|;
else|else
name|crop
operator|->
name|function
operator|=
name|REFRAMING
expr_stmt|;
block|}
block|}
comment|/*  otherwise, the new function will be creating, since we want to start anew  */
else|else
name|crop
operator|->
name|function
operator|=
name|CREATING
expr_stmt|;
block|}
if|if
condition|(
name|crop
operator|->
name|function
operator|==
name|CREATING
condition|)
block|{
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
condition|)
name|draw_core_stop
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|tool
operator|->
name|gdisp_ptr
operator|=
name|gdisp_ptr
expr_stmt|;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
operator|&
name|crop
operator|->
name|tx1
argument_list|,
operator|&
name|crop
operator|->
name|ty1
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|crop
operator|->
name|tx1
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|crop
operator|->
name|ty1
expr_stmt|;
name|crop_start
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
block|}
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
operator|&
name|crop
operator|->
name|startx
argument_list|,
operator|&
name|crop
operator|->
name|starty
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|crop
operator|->
name|lastx
operator|=
name|crop
operator|->
name|startx
expr_stmt|;
name|crop
operator|->
name|lasty
operator|=
name|crop
operator|->
name|starty
expr_stmt|;
name|gdk_pointer_grab
argument_list|(
name|gdisp
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|FALSE
argument_list|,
name|GDK_POINTER_MOTION_HINT_MASK
operator||
name|GDK_BUTTON1_MOTION_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|ACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_button_release (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|crop_button_release
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|gdk_pointer_ungrab
argument_list|(
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
name|gtk_statusbar_pop
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
name|crop
operator|->
name|context_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|bevent
operator|->
name|state
operator|&
name|GDK_BUTTON3_MASK
operator|)
condition|)
block|{
switch|switch
condition|(
name|crop
operator|->
name|function
condition|)
block|{
case|case
name|CROPPING
case|:
name|crop_image
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
name|options
operator|.
name|layer_only
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|REFRAMING
case|:
name|crop_image
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
name|options
operator|.
name|layer_only
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
break|break;
default|default:
name|crop_info_update
argument_list|(
name|tool
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/*  Finish the tool  */
name|draw_core_stop
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|info_dialog_popdown
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_adjust_guides (GImage * gimage,int x1,int y1,int x2,int y2)
name|crop_adjust_guides
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|int
name|x1
parameter_list|,
name|int
name|y1
parameter_list|,
name|int
name|x2
parameter_list|,
name|int
name|y2
parameter_list|)
block|{
name|GList
modifier|*
name|glist
decl_stmt|;
name|Guide
modifier|*
name|guide
decl_stmt|;
name|gint
name|remove_guide
decl_stmt|;
comment|/* initialize the traverser */
name|glist
operator|=
name|gimage
operator|->
name|guides
expr_stmt|;
while|while
condition|(
name|glist
operator|!=
name|NULL
condition|)
block|{
name|guide
operator|=
operator|(
name|Guide
operator|*
operator|)
name|glist
operator|->
name|data
expr_stmt|;
name|remove_guide
operator|=
name|FALSE
expr_stmt|;
switch|switch
condition|(
name|guide
operator|->
name|orientation
condition|)
block|{
case|case
name|HORIZONTAL_GUIDE
case|:
if|if
condition|(
operator|(
name|guide
operator|->
name|position
operator|<
name|y1
operator|)
operator|||
operator|(
name|guide
operator|->
name|position
operator|>
name|y2
operator|)
condition|)
name|remove_guide
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|VERTICAL_GUIDE
case|:
if|if
condition|(
operator|(
name|guide
operator|->
name|position
operator|<
name|x1
operator|)
operator|||
operator|(
name|guide
operator|->
name|position
operator|>
name|x2
operator|)
condition|)
name|remove_guide
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
comment|/* edit the guide */
name|gdisplays_expose_guide
argument_list|(
name|gimage
argument_list|,
name|guide
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
if|if
condition|(
name|remove_guide
condition|)
block|{
name|guide
operator|->
name|position
operator|=
operator|-
literal|1
expr_stmt|;
name|guide
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|guide
operator|->
name|orientation
operator|==
name|HORIZONTAL_GUIDE
condition|)
block|{
name|guide
operator|->
name|position
operator|-=
name|y1
expr_stmt|;
block|}
else|else
block|{
name|guide
operator|->
name|position
operator|-=
name|x1
expr_stmt|;
block|}
block|}
name|glist
operator|=
name|glist
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_motion (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|crop_motion
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|int
name|curx
decl_stmt|,
name|cury
decl_stmt|;
name|int
name|inc_x
decl_stmt|,
name|inc_y
decl_stmt|;
name|gchar
name|size
index|[
name|STATUSBAR_SIZE
index|]
decl_stmt|;
name|int
name|clamp
decl_stmt|;
name|int
name|min_x
decl_stmt|,
name|min_y
decl_stmt|,
name|max_x
decl_stmt|,
name|max_y
decl_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
comment|/*  This is the only case when the motion events should be ignored--       we're just waiting for the button release event to crop the image  */
if|if
condition|(
name|crop
operator|->
name|function
operator|==
name|CROPPING
operator|||
name|crop
operator|->
name|function
operator|==
name|REFRAMING
condition|)
return|return;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|mevent
operator|->
name|x
argument_list|,
name|mevent
operator|->
name|y
argument_list|,
operator|&
name|curx
argument_list|,
operator|&
name|cury
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|x1
operator|=
name|crop
operator|->
name|startx
expr_stmt|;
name|y1
operator|=
name|crop
operator|->
name|starty
expr_stmt|;
name|x2
operator|=
name|curx
expr_stmt|;
name|y2
operator|=
name|cury
expr_stmt|;
name|inc_x
operator|=
operator|(
name|x2
operator|-
name|x1
operator|)
expr_stmt|;
name|inc_y
operator|=
operator|(
name|y2
operator|-
name|y1
operator|)
expr_stmt|;
comment|/*  If there have been no changes... return  */
if|if
condition|(
name|crop
operator|->
name|lastx
operator|==
name|curx
operator|&&
name|crop
operator|->
name|lasty
operator|==
name|cury
condition|)
return|return;
name|draw_core_pause
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
comment|/* shall we clamp the coordinates to the image dimensions? */
if|if
condition|(
name|options
operator|.
name|default_to_enlarge
condition|)
block|{
if|if
condition|(
name|mevent
operator|->
name|state
operator|&
name|GDK_MOD1_MASK
condition|)
name|clamp
operator|=
name|TRUE
expr_stmt|;
else|else
name|clamp
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mevent
operator|->
name|state
operator|&
name|GDK_MOD1_MASK
condition|)
name|clamp
operator|=
name|FALSE
expr_stmt|;
else|else
name|clamp
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|.
name|layer_only
condition|)
block|{
name|layer
operator|=
operator|(
name|gdisp
operator|->
name|gimage
operator|)
operator|->
name|active_layer
expr_stmt|;
name|drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|min_x
argument_list|,
operator|&
name|min_y
argument_list|)
expr_stmt|;
name|max_x
operator|=
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|min_x
expr_stmt|;
name|max_y
operator|=
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|min_y
expr_stmt|;
block|}
else|else
block|{
name|min_x
operator|=
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|width
expr_stmt|;
name|max_y
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|height
expr_stmt|;
block|}
switch|switch
condition|(
name|crop
operator|->
name|function
condition|)
block|{
case|case
name|CREATING
case|:
if|if
condition|(
name|clamp
condition|)
block|{
name|x1
operator|=
name|BOUNDS
argument_list|(
name|x1
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|y1
operator|=
name|BOUNDS
argument_list|(
name|y1
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
name|x2
operator|=
name|BOUNDS
argument_list|(
name|x2
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|y2
operator|=
name|BOUNDS
argument_list|(
name|y2
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RESIZING_LEFT
case|:
name|x1
operator|=
name|crop
operator|->
name|tx1
operator|+
name|inc_x
expr_stmt|;
name|y1
operator|=
name|crop
operator|->
name|ty1
operator|+
name|inc_y
expr_stmt|;
if|if
condition|(
name|clamp
condition|)
block|{
name|x1
operator|=
name|BOUNDS
argument_list|(
name|x1
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|y1
operator|=
name|BOUNDS
argument_list|(
name|y1
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
block|}
name|x2
operator|=
name|MAXIMUM
argument_list|(
name|x1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|)
expr_stmt|;
name|y2
operator|=
name|MAXIMUM
argument_list|(
name|y1
argument_list|,
name|crop
operator|->
name|ty2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|startx
operator|=
name|curx
expr_stmt|;
name|crop
operator|->
name|starty
operator|=
name|cury
expr_stmt|;
break|break;
case|case
name|RESIZING_RIGHT
case|:
name|x2
operator|=
name|crop
operator|->
name|tx2
operator|+
name|inc_x
expr_stmt|;
name|y2
operator|=
name|crop
operator|->
name|ty2
operator|+
name|inc_y
expr_stmt|;
if|if
condition|(
name|clamp
condition|)
block|{
name|x2
operator|=
name|BOUNDS
argument_list|(
name|x2
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|y2
operator|=
name|BOUNDS
argument_list|(
name|y2
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
block|}
name|x1
operator|=
name|MINIMUM
argument_list|(
name|crop
operator|->
name|tx1
argument_list|,
name|x2
argument_list|)
expr_stmt|;
name|y1
operator|=
name|MINIMUM
argument_list|(
name|crop
operator|->
name|ty1
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|startx
operator|=
name|curx
expr_stmt|;
name|crop
operator|->
name|starty
operator|=
name|cury
expr_stmt|;
break|break;
case|case
name|MOVING
case|:
if|if
condition|(
name|clamp
condition|)
block|{
name|inc_x
operator|=
name|BOUNDS
argument_list|(
name|inc_x
argument_list|,
name|min_x
operator|-
name|crop
operator|->
name|tx1
argument_list|,
name|max_x
operator|-
name|crop
operator|->
name|tx2
argument_list|)
expr_stmt|;
name|inc_y
operator|=
name|BOUNDS
argument_list|(
name|inc_y
argument_list|,
name|min_y
operator|-
name|crop
operator|->
name|ty1
argument_list|,
name|max_y
operator|-
name|crop
operator|->
name|ty2
argument_list|)
expr_stmt|;
block|}
name|x1
operator|=
name|crop
operator|->
name|tx1
operator|+
name|inc_x
expr_stmt|;
name|x2
operator|=
name|crop
operator|->
name|tx2
operator|+
name|inc_x
expr_stmt|;
name|y1
operator|=
name|crop
operator|->
name|ty1
operator|+
name|inc_y
expr_stmt|;
name|y2
operator|=
name|crop
operator|->
name|ty2
operator|+
name|inc_y
expr_stmt|;
name|crop
operator|->
name|startx
operator|=
name|curx
expr_stmt|;
name|crop
operator|->
name|starty
operator|=
name|cury
expr_stmt|;
break|break;
block|}
comment|/*  make sure that the coords are in bounds  */
name|crop
operator|->
name|tx1
operator|=
name|MINIMUM
argument_list|(
name|x1
argument_list|,
name|x2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|ty1
operator|=
name|MINIMUM
argument_list|(
name|y1
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|MAXIMUM
argument_list|(
name|x1
argument_list|,
name|x2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|MAXIMUM
argument_list|(
name|y1
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|lastx
operator|=
name|curx
expr_stmt|;
name|crop
operator|->
name|lasty
operator|=
name|cury
expr_stmt|;
comment|/*  recalculate the coordinates for crop_draw based on the new values  */
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
if|if
condition|(
name|crop
operator|->
name|function
operator|==
name|CREATING
operator|||
name|crop
operator|->
name|function
operator|==
name|RESIZING_LEFT
operator|||
name|crop
operator|->
name|function
operator|==
name|RESIZING_RIGHT
condition|)
block|{
name|gtk_statusbar_pop
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
name|crop
operator|->
name|context_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|gdisp
operator|->
name|dot_for_dot
condition|)
block|{
name|g_snprintf
argument_list|(
name|size
argument_list|,
name|STATUSBAR_SIZE
argument_list|,
name|gdisp
operator|->
name|cursor_format_str
argument_list|,
name|_
argument_list|(
literal|"Crop: "
argument_list|)
argument_list|,
operator|(
name|crop
operator|->
name|tx2
operator|-
name|crop
operator|->
name|tx1
operator|)
argument_list|,
literal|" x "
argument_list|,
operator|(
name|crop
operator|->
name|ty2
operator|-
name|crop
operator|->
name|ty1
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* show real world units */
block|{
name|float
name|unit_factor
init|=
name|gimp_unit_get_factor
argument_list|(
name|gdisp
operator|->
name|gimage
operator|->
name|unit
argument_list|)
decl_stmt|;
name|g_snprintf
argument_list|(
name|size
argument_list|,
name|STATUSBAR_SIZE
argument_list|,
name|gdisp
operator|->
name|cursor_format_str
argument_list|,
name|_
argument_list|(
literal|"Crop: "
argument_list|)
argument_list|,
call|(
name|float
call|)
argument_list|(
name|crop
operator|->
name|tx2
operator|-
name|crop
operator|->
name|tx1
argument_list|)
operator|*
name|unit_factor
operator|/
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
argument_list|,
literal|" x "
argument_list|,
call|(
name|float
call|)
argument_list|(
name|crop
operator|->
name|ty2
operator|-
name|crop
operator|->
name|ty1
argument_list|)
operator|*
name|unit_factor
operator|/
name|gdisp
operator|->
name|gimage
operator|->
name|yresolution
argument_list|)
expr_stmt|;
block|}
name|gtk_statusbar_push
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
name|crop
operator|->
name|context_id
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
name|draw_core_resume
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_cursor_update (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|crop_cursor_update
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|GdkCursorType
name|ctype
decl_stmt|;
name|Crop
modifier|*
name|crop
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|mevent
operator|->
name|x
argument_list|,
name|mevent
operator|->
name|y
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|INACTIVE
operator|||
operator|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
operator|&&
name|tool
operator|->
name|gdisp_ptr
operator|!=
name|gdisp_ptr
operator|)
condition|)
name|ctype
operator|=
name|GDK_CROSS
expr_stmt|;
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|==
name|BOUNDS
argument_list|(
name|mevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|x1
operator|+
name|crop
operator|->
name|srw
argument_list|)
operator|&&
name|mevent
operator|->
name|y
operator|==
name|BOUNDS
argument_list|(
name|mevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|y1
operator|+
name|crop
operator|->
name|srh
argument_list|)
condition|)
name|ctype
operator|=
name|GDK_TOP_LEFT_CORNER
expr_stmt|;
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|==
name|BOUNDS
argument_list|(
name|mevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|x2
argument_list|)
operator|&&
name|mevent
operator|->
name|y
operator|==
name|BOUNDS
argument_list|(
name|mevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
condition|)
name|ctype
operator|=
name|GDK_BOTTOM_RIGHT_CORNER
expr_stmt|;
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|==
name|BOUNDS
argument_list|(
name|mevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|x1
operator|+
name|crop
operator|->
name|srw
argument_list|)
operator|&&
name|mevent
operator|->
name|y
operator|==
name|BOUNDS
argument_list|(
name|mevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
condition|)
name|ctype
operator|=
name|GDK_FLEUR
expr_stmt|;
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|==
name|BOUNDS
argument_list|(
name|mevent
operator|->
name|x
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|x2
argument_list|)
operator|&&
name|mevent
operator|->
name|y
operator|==
name|BOUNDS
argument_list|(
name|mevent
operator|->
name|y
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|y1
operator|+
name|crop
operator|->
name|srh
argument_list|)
condition|)
name|ctype
operator|=
name|GDK_FLEUR
expr_stmt|;
elseif|else
if|if
condition|(
name|mevent
operator|->
name|x
operator|>
name|crop
operator|->
name|x1
operator|&&
name|mevent
operator|->
name|x
operator|<
name|crop
operator|->
name|x2
operator|&&
name|mevent
operator|->
name|y
operator|>
name|crop
operator|->
name|y1
operator|&&
name|mevent
operator|->
name|y
operator|<
name|crop
operator|->
name|y2
condition|)
block|{
if|if
condition|(
name|options
operator|.
name|default_to_crop
condition|)
block|{
if|if
condition|(
name|mevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
name|ctype
operator|=
name|GDK_SIZING
expr_stmt|;
else|else
name|ctype
operator|=
name|GDK_ICON
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
name|ctype
operator|=
name|GDK_ICON
expr_stmt|;
else|else
name|ctype
operator|=
name|GDK_SIZING
expr_stmt|;
block|}
block|}
else|else
name|ctype
operator|=
name|GDK_CROSS
expr_stmt|;
name|gdisplay_install_tool_cursor
argument_list|(
name|gdisp
argument_list|,
name|ctype
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_arrow_keys_func (Tool * tool,GdkEventKey * kevent,gpointer gdisp_ptr)
name|crop_arrow_keys_func
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventKey
modifier|*
name|kevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|int
name|inc_x
decl_stmt|,
name|inc_y
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|Crop
modifier|*
name|crop
decl_stmt|;
name|int
name|clamp
decl_stmt|;
name|int
name|min_x
decl_stmt|,
name|min_y
decl_stmt|,
name|max_x
decl_stmt|,
name|max_y
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
condition|)
block|{
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|inc_x
operator|=
name|inc_y
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|kevent
operator|->
name|keyval
condition|)
block|{
case|case
name|GDK_Up
case|:
name|inc_y
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|GDK_Left
case|:
name|inc_x
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|GDK_Right
case|:
name|inc_x
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|GDK_Down
case|:
name|inc_y
operator|=
literal|1
expr_stmt|;
break|break;
block|}
comment|/*  If the shift key is down, move by an accelerated increment  */
if|if
condition|(
name|kevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
name|inc_y
operator|*=
name|ARROW_VELOCITY
expr_stmt|;
name|inc_x
operator|*=
name|ARROW_VELOCITY
expr_stmt|;
block|}
name|draw_core_pause
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
comment|/* shall we clamp the coordinates to the image dimensions? */
if|if
condition|(
name|options
operator|.
name|default_to_enlarge
condition|)
block|{
if|if
condition|(
name|kevent
operator|->
name|state
operator|&
name|GDK_MOD1_MASK
condition|)
name|clamp
operator|=
name|TRUE
expr_stmt|;
else|else
name|clamp
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|kevent
operator|->
name|state
operator|&
name|GDK_MOD1_MASK
condition|)
name|clamp
operator|=
name|FALSE
expr_stmt|;
else|else
name|clamp
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|.
name|layer_only
condition|)
block|{
name|layer
operator|=
operator|(
name|gdisp
operator|->
name|gimage
operator|)
operator|->
name|active_layer
expr_stmt|;
name|drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|min_x
argument_list|,
operator|&
name|min_y
argument_list|)
expr_stmt|;
name|max_x
operator|=
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|min_x
expr_stmt|;
name|max_y
operator|=
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|min_y
expr_stmt|;
block|}
else|else
block|{
name|min_x
operator|=
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|width
expr_stmt|;
name|max_y
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|height
expr_stmt|;
block|}
if|if
condition|(
name|kevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
condition|)
comment|/* RESIZING */
block|{
name|crop
operator|->
name|tx2
operator|=
name|crop
operator|->
name|tx2
operator|+
name|inc_x
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|crop
operator|->
name|ty2
operator|+
name|inc_y
expr_stmt|;
if|if
condition|(
name|clamp
condition|)
block|{
name|crop
operator|->
name|tx2
operator|=
name|BOUNDS
argument_list|(
name|crop
operator|->
name|tx2
argument_list|,
name|min_x
argument_list|,
name|max_x
argument_list|)
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|BOUNDS
argument_list|(
name|crop
operator|->
name|ty2
argument_list|,
name|min_y
argument_list|,
name|max_y
argument_list|)
expr_stmt|;
block|}
name|crop
operator|->
name|tx1
operator|=
name|MINIMUM
argument_list|(
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|)
expr_stmt|;
name|crop
operator|->
name|ty1
operator|=
name|MINIMUM
argument_list|(
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|ty2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|clamp
condition|)
block|{
name|inc_x
operator|=
name|BOUNDS
argument_list|(
name|inc_x
argument_list|,
operator|-
name|crop
operator|->
name|tx1
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|width
operator|-
name|crop
operator|->
name|tx2
argument_list|)
expr_stmt|;
name|inc_y
operator|=
name|BOUNDS
argument_list|(
name|inc_y
argument_list|,
operator|-
name|crop
operator|->
name|ty1
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|height
operator|-
name|crop
operator|->
name|ty2
argument_list|)
expr_stmt|;
block|}
name|crop
operator|->
name|tx1
operator|+=
name|inc_x
expr_stmt|;
name|crop
operator|->
name|tx2
operator|+=
name|inc_x
expr_stmt|;
name|crop
operator|->
name|ty1
operator|+=
name|inc_y
expr_stmt|;
name|crop
operator|->
name|ty2
operator|+=
name|inc_y
expr_stmt|;
block|}
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|draw_core_resume
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_control (Tool * tool,int action,gpointer gdisp_ptr)
name|crop_control
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|int
name|action
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|Crop
modifier|*
name|crop
decl_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|PAUSE
case|:
name|draw_core_pause
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
break|break;
case|case
name|RESUME
case|:
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|draw_core_resume
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
break|break;
case|case
name|HALT
case|:
name|draw_core_stop
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|info_dialog_popdown
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
DECL|function|crop_draw (Tool * tool)
name|crop_draw
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|)
block|{
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
DECL|macro|SRW
define|#
directive|define
name|SRW
value|10
DECL|macro|SRH
define|#
directive|define
name|SRH
value|10
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|crop
operator|->
name|core
operator|->
name|win
argument_list|,
name|crop
operator|->
name|core
operator|->
name|gc
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|gdisp
operator|->
name|disp_width
argument_list|,
name|crop
operator|->
name|y1
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|crop
operator|->
name|core
operator|->
name|win
argument_list|,
name|crop
operator|->
name|core
operator|->
name|gc
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|gdisp
operator|->
name|disp_height
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|crop
operator|->
name|core
operator|->
name|win
argument_list|,
name|crop
operator|->
name|core
operator|->
name|gc
argument_list|,
name|crop
operator|->
name|x2
argument_list|,
name|crop
operator|->
name|y2
argument_list|,
literal|0
argument_list|,
name|crop
operator|->
name|y2
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|crop
operator|->
name|core
operator|->
name|win
argument_list|,
name|crop
operator|->
name|core
operator|->
name|gc
argument_list|,
name|crop
operator|->
name|x2
argument_list|,
name|crop
operator|->
name|y2
argument_list|,
name|crop
operator|->
name|x2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crop
operator|->
name|srw
operator|=
operator|(
operator|(
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|x1
operator|)
operator|<
name|SRW
operator|)
condition|?
operator|(
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|x1
operator|)
else|:
name|SRW
expr_stmt|;
name|crop
operator|->
name|srh
operator|=
operator|(
operator|(
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|y1
operator|)
operator|<
name|SRH
operator|)
condition|?
operator|(
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|y1
operator|)
else|:
name|SRH
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|crop
operator|->
name|core
operator|->
name|win
argument_list|,
name|crop
operator|->
name|core
operator|->
name|gc
argument_list|,
literal|1
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|srh
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|crop
operator|->
name|core
operator|->
name|win
argument_list|,
name|crop
operator|->
name|core
operator|->
name|gc
argument_list|,
literal|1
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|srh
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|crop
operator|->
name|core
operator|->
name|win
argument_list|,
name|crop
operator|->
name|core
operator|->
name|gc
argument_list|,
literal|1
argument_list|,
name|crop
operator|->
name|x2
operator|-
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|y1
argument_list|,
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|srh
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|crop
operator|->
name|core
operator|->
name|win
argument_list|,
name|crop
operator|->
name|core
operator|->
name|gc
argument_list|,
literal|1
argument_list|,
name|crop
operator|->
name|x1
argument_list|,
name|crop
operator|->
name|y2
operator|-
name|crop
operator|->
name|srh
argument_list|,
name|crop
operator|->
name|srw
argument_list|,
name|crop
operator|->
name|srh
argument_list|)
expr_stmt|;
name|crop_info_update
argument_list|(
name|tool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Tool
modifier|*
DECL|function|tools_new_crop ()
name|tools_new_crop
parameter_list|()
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|Crop
modifier|*
name|private
decl_stmt|;
if|if
condition|(
operator|!
name|options_widget
condition|)
name|init_crop_options
argument_list|()
expr_stmt|;
name|tool
operator|=
operator|(
name|Tool
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Tool
argument_list|)
argument_list|)
expr_stmt|;
name|private
operator|=
operator|(
name|Crop
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Crop
argument_list|)
argument_list|)
expr_stmt|;
name|private
operator|->
name|core
operator|=
name|draw_core_new
argument_list|(
name|crop_draw
argument_list|)
expr_stmt|;
name|private
operator|->
name|startx
operator|=
name|private
operator|->
name|starty
operator|=
literal|0
expr_stmt|;
name|private
operator|->
name|function
operator|=
name|CREATING
expr_stmt|;
name|tool
operator|->
name|type
operator|=
name|CROP
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
name|tool
operator|->
name|scroll_lock
operator|=
literal|0
expr_stmt|;
comment|/*  Allow scrolling  */
name|tool
operator|->
name|auto_snap_to
operator|=
name|TRUE
expr_stmt|;
name|tool
operator|->
name|private
operator|=
operator|(
name|void
operator|*
operator|)
name|private
expr_stmt|;
name|tool
operator|->
name|button_press_func
operator|=
name|crop_button_press
expr_stmt|;
name|tool
operator|->
name|button_release_func
operator|=
name|crop_button_release
expr_stmt|;
name|tool
operator|->
name|motion_func
operator|=
name|crop_motion
expr_stmt|;
name|tool
operator|->
name|arrow_keys_func
operator|=
name|crop_arrow_keys_func
expr_stmt|;
name|tool
operator|->
name|cursor_update_func
operator|=
name|crop_cursor_update
expr_stmt|;
name|tool
operator|->
name|control_func
operator|=
name|crop_control
expr_stmt|;
name|tool
operator|->
name|preserve
operator|=
name|TRUE
expr_stmt|;
comment|/* XXX Check me */
return|return
name|tool
return|;
block|}
end_function

begin_function
name|void
DECL|function|tools_free_crop (Tool * tool)
name|tools_free_crop
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|)
block|{
name|Crop
modifier|*
name|crop
decl_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
if|if
condition|(
name|tool
operator|->
name|state
operator|==
name|ACTIVE
condition|)
name|draw_core_stop
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|draw_core_free
argument_list|(
name|crop
operator|->
name|core
argument_list|)
expr_stmt|;
if|if
condition|(
name|crop_info
condition|)
block|{
name|info_dialog_popdown
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|crop_info
operator|=
name|NULL
expr_stmt|;
block|}
name|g_free
argument_list|(
name|crop
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_image (GImage * gimage,int x1,int y1,int x2,int y2,int layer_only,int crop_layers)
name|crop_image
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|int
name|x1
parameter_list|,
name|int
name|y1
parameter_list|,
name|int
name|x2
parameter_list|,
name|int
name|y2
parameter_list|,
name|int
name|layer_only
parameter_list|,
name|int
name|crop_layers
parameter_list|)
block|{
name|Layer
modifier|*
name|layer
decl_stmt|;
name|Layer
modifier|*
name|floating_layer
decl_stmt|;
name|Channel
modifier|*
name|channel
decl_stmt|;
name|GList
modifier|*
name|guide_list_ptr
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|lx1
decl_stmt|,
name|ly1
decl_stmt|,
name|lx2
decl_stmt|,
name|ly2
decl_stmt|;
name|int
name|off_x
decl_stmt|,
name|off_y
decl_stmt|;
name|int
name|doff_x
decl_stmt|,
name|doff_y
decl_stmt|;
name|width
operator|=
name|x2
operator|-
name|x1
expr_stmt|;
name|height
operator|=
name|y2
operator|-
name|y1
expr_stmt|;
comment|/*  Make sure new width and height are non-zero  */
if|if
condition|(
name|width
operator|&&
name|height
condition|)
block|{
name|gimp_add_busy_cursors
argument_list|()
expr_stmt|;
if|if
condition|(
name|layer_only
condition|)
block|{
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|LAYER_RESIZE_UNDO
argument_list|)
expr_stmt|;
name|layer
operator|=
name|gimage
operator|->
name|active_layer
expr_stmt|;
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_relax
argument_list|(
name|layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|doff_x
argument_list|,
operator|&
name|doff_y
argument_list|)
expr_stmt|;
name|off_x
operator|=
operator|(
name|doff_x
operator|-
name|x1
operator|)
expr_stmt|;
name|off_y
operator|=
operator|(
name|doff_y
operator|-
name|y1
operator|)
expr_stmt|;
name|layer_resize
argument_list|(
name|layer
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|off_x
argument_list|,
name|off_y
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_rigor
argument_list|(
name|layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|floating_layer
operator|=
name|gimage_floating_sel
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|CROP_UNDO
argument_list|)
expr_stmt|;
comment|/*  relax the floating layer  */
if|if
condition|(
name|floating_layer
condition|)
name|floating_sel_relax
argument_list|(
name|floating_layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/*  Push the image size to the stack  */
name|undo_push_gimage_mod
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/*  Set the new width and height  */
name|gimage
operator|->
name|width
operator|=
name|width
expr_stmt|;
name|gimage
operator|->
name|height
operator|=
name|height
expr_stmt|;
comment|/*  Resize all channels  */
name|list
operator|=
name|gimage
operator|->
name|channels
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|channel
operator|=
operator|(
name|Channel
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|channel_resize
argument_list|(
name|channel
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
name|x1
argument_list|,
operator|-
name|y1
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
comment|/*  Don't forget the selection mask!  */
name|channel_resize
argument_list|(
name|gimage
operator|->
name|selection_mask
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
name|x1
argument_list|,
operator|-
name|y1
argument_list|)
expr_stmt|;
name|gimage_mask_invalidate
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/*  crop all layers  */
name|list
operator|=
name|gimage
operator|->
name|layers
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|layer_translate
argument_list|(
name|layer
argument_list|,
operator|-
name|x1
argument_list|,
operator|-
name|y1
argument_list|)
expr_stmt|;
if|if
condition|(
name|crop_layers
condition|)
block|{
name|drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
name|lx1
operator|=
name|BOUNDS
argument_list|(
name|off_x
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|ly1
operator|=
name|BOUNDS
argument_list|(
name|off_y
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|lx2
operator|=
name|BOUNDS
argument_list|(
operator|(
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|off_x
operator|)
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|ly2
operator|=
name|BOUNDS
argument_list|(
operator|(
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
operator|+
name|off_y
operator|)
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|width
operator|=
name|lx2
operator|-
name|lx1
expr_stmt|;
name|height
operator|=
name|ly2
operator|-
name|ly1
expr_stmt|;
if|if
condition|(
name|width
operator|&&
name|height
condition|)
name|layer_resize
argument_list|(
name|layer
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
operator|(
name|lx1
operator|-
name|off_x
operator|)
argument_list|,
operator|-
operator|(
name|ly1
operator|-
name|off_y
operator|)
argument_list|)
expr_stmt|;
else|else
name|gimage_remove_layer
argument_list|(
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
block|}
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
comment|/*  Make sure the projection matches the gimage size  */
name|gimage_projection_realloc
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/*  rigor the floating layer  */
if|if
condition|(
name|floating_layer
condition|)
name|floating_sel_rigor
argument_list|(
name|floating_layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|guide_list_ptr
operator|=
name|gimage
operator|->
name|guides
expr_stmt|;
while|while
condition|(
name|guide_list_ptr
operator|!=
name|NULL
condition|)
block|{
name|undo_push_guide
argument_list|(
name|gimage
argument_list|,
operator|(
name|Guide
operator|*
operator|)
name|guide_list_ptr
operator|->
name|data
argument_list|)
expr_stmt|;
name|guide_list_ptr
operator|=
name|guide_list_ptr
operator|->
name|next
expr_stmt|;
block|}
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/* Adjust any guides we might have laying about */
name|crop_adjust_guides
argument_list|(
name|gimage
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
expr_stmt|;
comment|/*  shrink wrap and update all views  */
name|channel_invalidate_previews
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|layer_invalidate_previews
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gimage_invalidate_preview
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_update_full
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_shrink_wrap
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
name|gimp_remove_busy_cursors
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_recalc (Tool * tool,Crop * crop)
name|crop_recalc
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|Crop
modifier|*
name|crop
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|gdisplay_transform_coords
argument_list|(
name|gdisp
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
operator|&
name|crop
operator|->
name|x1
argument_list|,
operator|&
name|crop
operator|->
name|y1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gdisplay_transform_coords
argument_list|(
name|gdisp
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
operator|&
name|crop
operator|->
name|x2
argument_list|,
operator|&
name|crop
operator|->
name|y2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_start (Tool * tool,Crop * crop)
name|crop_start
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|Crop
modifier|*
name|crop
parameter_list|)
block|{
specifier|static
name|GDisplay
modifier|*
name|old_gdisp
init|=
name|NULL
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|crop_info
condition|)
name|crop_info_create
argument_list|(
name|tool
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|yresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|yresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_gdisp
operator|!=
name|gdisp
condition|)
block|{
name|gimp_size_entry_set_unit
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
operator|(
name|gdisp
operator|->
name|dot_for_dot
condition|?
name|UNIT_PIXEL
else|:
name|gdisp
operator|->
name|gimage
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_unit
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
operator|(
name|gdisp
operator|->
name|dot_for_dot
condition|?
name|UNIT_PIXEL
else|:
name|gdisp
operator|->
name|gimage
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
block|}
name|old_gdisp
operator|=
name|gdisp
expr_stmt|;
comment|/* initialize the statusbar display */
name|crop
operator|->
name|context_id
operator|=
name|gtk_statusbar_get_context_id
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
literal|"crop"
argument_list|)
expr_stmt|;
name|gtk_statusbar_push
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|gdisp
operator|->
name|statusbar
argument_list|)
argument_list|,
name|crop
operator|->
name|context_id
argument_list|,
name|_
argument_list|(
literal|"Crop: 0 x 0"
argument_list|)
argument_list|)
expr_stmt|;
name|draw_core_start
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|gdisp
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|tool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************/
end_comment

begin_comment
comment|/*  Crop dialog functions                              */
end_comment

begin_comment
comment|/*******************************************************/
end_comment

begin_decl_stmt
DECL|variable|action_items
specifier|static
name|ActionAreaItem
name|action_items
index|[
literal|4
index|]
init|=
block|{
block|{
name|N_
argument_list|(
literal|"Crop"
argument_list|)
block|,
name|crop_ok_callback
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Resize"
argument_list|)
block|,
name|crop_resize_callback
block|,
name|NULL
block|,
name|NULL
block|}
block|,
comment|/*  { N_("Selection"), crop_selection_callback, NULL, NULL },  */
block|{
name|N_
argument_list|(
literal|"Close"
argument_list|)
block|,
name|crop_close_callback
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|crop_info_create (Tool * tool)
name|crop_info_create
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|GtkWidget
modifier|*
name|spinbutton
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
comment|/*  create the info dialog  */
name|crop_info
operator|=
name|info_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Crop Information"
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  add the information fields  */
name|spinbutton
operator|=
name|info_dialog_add_spinbutton
argument_list|(
name|crop_info
argument_list|,
name|_
argument_list|(
literal|"Origin X:"
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|origin_sizeentry
operator|=
name|info_dialog_add_sizeentry
argument_list|(
name|crop_info
argument_list|,
name|_
argument_list|(
literal|"Y:"
argument_list|)
argument_list|,
name|orig_vals
argument_list|,
literal|1
argument_list|,
name|gdisp
operator|->
name|dot_for_dot
condition|?
name|UNIT_PIXEL
else|:
name|gdisp
operator|->
name|gimage
operator|->
name|unit
argument_list|,
literal|"%a"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|GIMP_SIZE_ENTRY_UPDATE_SIZE
argument_list|,
name|crop_orig_changed
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|gimp_size_entry_add_field
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|65536
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|orig_vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|-
literal|65536
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|yresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|origin_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|orig_vals
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|spinbutton
operator|=
name|info_dialog_add_spinbutton
argument_list|(
name|crop_info
argument_list|,
name|_
argument_list|(
literal|"Width:"
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|size_sizeentry
operator|=
name|info_dialog_add_sizeentry
argument_list|(
name|crop_info
argument_list|,
name|_
argument_list|(
literal|"Height:"
argument_list|)
argument_list|,
name|size_vals
argument_list|,
literal|1
argument_list|,
name|gdisp
operator|->
name|dot_for_dot
condition|?
name|UNIT_PIXEL
else|:
name|gdisp
operator|->
name|gimage
operator|->
name|unit
argument_list|,
literal|"%a"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|GIMP_SIZE_ENTRY_UPDATE_SIZE
argument_list|,
name|crop_size_changed
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|gimp_size_entry_add_field
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|65536
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|size_vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|-
literal|65536
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|yresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|size_vals
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|crop_info
operator|->
name|info_table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|crop_info
operator|->
name|info_table
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|crop_info
operator|->
name|info_table
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Create the action area  */
name|build_action_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|crop_info
operator|->
name|shell
argument_list|)
argument_list|,
name|action_items
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_info_update (Tool * tool)
name|crop_info_update
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|)
block|{
name|Crop
modifier|*
name|crop
decl_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|orig_vals
index|[
literal|0
index|]
operator|=
name|crop
operator|->
name|tx1
expr_stmt|;
name|orig_vals
index|[
literal|1
index|]
operator|=
name|crop
operator|->
name|ty1
expr_stmt|;
name|size_vals
index|[
literal|0
index|]
operator|=
name|crop
operator|->
name|tx2
operator|-
name|crop
operator|->
name|tx1
expr_stmt|;
name|size_vals
index|[
literal|1
index|]
operator|=
name|crop
operator|->
name|ty2
operator|-
name|crop
operator|->
name|ty1
expr_stmt|;
name|info_dialog_update
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|info_dialog_popup
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_ok_callback (GtkWidget * w,gpointer client_data)
name|crop_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|tool
operator|=
name|active_tool
expr_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|crop_image
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
name|options
operator|.
name|layer_only
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/*  Finish the tool  */
name|draw_core_stop
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|info_dialog_popdown
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_resize_callback (GtkWidget * w,gpointer client_data)
name|crop_resize_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|tool
operator|=
name|active_tool
expr_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|crop_image
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|crop
operator|->
name|tx1
argument_list|,
name|crop
operator|->
name|ty1
argument_list|,
name|crop
operator|->
name|tx2
argument_list|,
name|crop
operator|->
name|ty2
argument_list|,
name|options
operator|.
name|layer_only
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  Finish the tool  */
name|draw_core_stop
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|info_dialog_popdown
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_selection_callback (GtkWidget * w,gpointer client_data)
name|crop_selection_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|tool
operator|=
name|active_tool
expr_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|draw_core_pause
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gimage_mask_bounds
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
operator|&
name|crop
operator|->
name|tx1
argument_list|,
operator|&
name|crop
operator|->
name|ty1
argument_list|,
operator|&
name|crop
operator|->
name|tx2
argument_list|,
operator|&
name|crop
operator|->
name|ty2
argument_list|)
condition|)
block|{
name|crop
operator|->
name|tx1
operator|=
name|crop
operator|->
name|ty1
operator|=
literal|0
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|width
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|height
expr_stmt|;
block|}
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|draw_core_resume
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_close_callback (GtkWidget * w,gpointer client_data)
name|crop_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|tool
operator|=
name|active_tool
expr_stmt|;
name|draw_core_stop
argument_list|(
operator|(
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
operator|)
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|info_dialog_popdown
argument_list|(
name|crop_info
argument_list|)
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_orig_changed (GtkWidget * w,gpointer data)
name|crop_orig_changed
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|ox
decl_stmt|;
name|int
name|oy
decl_stmt|;
name|tool
operator|=
operator|(
name|Tool
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|tool
condition|)
block|{
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|ox
operator|=
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|oy
operator|=
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ox
operator|!=
name|crop
operator|->
name|tx1
operator|)
operator|||
operator|(
name|oy
operator|!=
name|crop
operator|->
name|ty1
operator|)
condition|)
block|{
name|draw_core_pause
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|crop
operator|->
name|tx2
operator|+
operator|(
name|ox
operator|-
name|crop
operator|->
name|tx1
operator|)
expr_stmt|;
name|crop
operator|->
name|tx1
operator|=
name|ox
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|crop
operator|->
name|ty2
operator|+
operator|(
name|oy
operator|-
name|crop
operator|->
name|ty1
operator|)
expr_stmt|;
name|crop
operator|->
name|ty1
operator|=
name|oy
expr_stmt|;
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|draw_core_resume
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|crop_size_changed (GtkWidget * w,gpointer data)
name|crop_size_changed
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|Crop
modifier|*
name|crop
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|sx
decl_stmt|;
name|int
name|sy
decl_stmt|;
name|tool
operator|=
operator|(
name|Tool
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|tool
condition|)
block|{
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|crop
operator|=
operator|(
name|Crop
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|sx
operator|=
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sy
operator|=
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|w
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sx
operator|!=
operator|(
name|crop
operator|->
name|tx2
operator|-
name|crop
operator|->
name|tx1
operator|)
operator|)
operator|||
operator|(
name|sy
operator|!=
operator|(
name|crop
operator|->
name|ty2
operator|-
name|crop
operator|->
name|ty1
operator|)
operator|)
condition|)
block|{
name|draw_core_pause
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
name|crop
operator|->
name|tx2
operator|=
name|sx
operator|+
name|crop
operator|->
name|tx1
expr_stmt|;
name|crop
operator|->
name|ty2
operator|=
name|sy
operator|+
name|crop
operator|->
name|ty1
expr_stmt|;
name|crop_recalc
argument_list|(
name|tool
argument_list|,
name|crop
argument_list|)
expr_stmt|;
name|draw_core_resume
argument_list|(
name|crop
operator|->
name|core
argument_list|,
name|tool
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  The procedure definition  */
end_comment

begin_decl_stmt
DECL|variable|crop_args
name|ProcArg
name|crop_args
index|[]
init|=
block|{
block|{
name|PDB_IMAGE
block|,
literal|"image"
block|,
literal|"the image"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"new_width"
block|,
literal|"new image width: (0< new_width<= width)"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"new_height"
block|,
literal|"new image height: (0< new_height<= height)"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"offx"
block|,
literal|"x offset: (0<= offx<= (width - new_width))"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"offy"
block|,
literal|"y offset: (0<= offy<= (height - new_height))"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|crop_proc
name|ProcRecord
name|crop_proc
init|=
block|{
literal|"gimp_crop"
block|,
literal|"Crop the image to the specified extents."
block|,
literal|"This procedure crops the image so that it's new width and height are equal to the supplied parameters.  Offsets are also provided which describe the position of the previous image's content.  All channels and layers within the image are cropped to the new image extents; this includes the image selection mask.  If any parameters are out of range, an error is returned."
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1995-1996"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|5
block|,
name|crop_args
block|,
comment|/*  Output arguments  */
literal|0
block|,
name|NULL
block|,
comment|/*  Exec method  */
block|{
block|{
name|crop_invoker
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|crop_invoker (Argument * args)
name|crop_invoker
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|int
name|success
decl_stmt|;
name|int
name|int_value
decl_stmt|;
name|int
name|new_width
decl_stmt|,
name|new_height
decl_stmt|;
name|int
name|offx
decl_stmt|,
name|offy
decl_stmt|;
name|int
name|layer_only
decl_stmt|,
name|crop_layers
decl_stmt|;
name|new_width
operator|=
literal|1
expr_stmt|;
name|new_height
operator|=
literal|1
expr_stmt|;
name|offx
operator|=
literal|0
expr_stmt|;
name|offy
operator|=
literal|0
expr_stmt|;
name|layer_only
operator|=
name|FALSE
expr_stmt|;
name|crop_layers
operator|=
name|TRUE
expr_stmt|;
name|success
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
operator|(
name|gimage
operator|=
name|gimage_get_ID
argument_list|(
name|int_value
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|success
condition|)
block|{
name|new_width
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|new_height
operator|=
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|new_width
operator|<=
literal|0
operator|||
name|new_height
operator|<=
literal|0
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|success
condition|)
block|{
name|offx
operator|=
name|args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|offy
operator|=
name|args
index|[
literal|4
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|new_width
operator|<=
literal|0
operator|||
name|new_width
operator|>
name|gimage
operator|->
name|width
operator|)
operator|||
operator|(
name|new_height
operator|<=
literal|0
operator|||
name|new_height
operator|>
name|gimage
operator|->
name|height
operator|)
operator|||
operator|(
name|offx
operator|<
literal|0
operator|||
name|offx
operator|>
operator|(
name|gimage
operator|->
name|width
operator|-
name|new_width
operator|)
operator|)
operator|||
operator|(
name|offy
operator|<
literal|0
operator|||
name|offy
operator|>
operator|(
name|gimage
operator|->
name|height
operator|-
name|new_height
operator|)
operator|)
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|success
condition|)
name|crop_image
argument_list|(
name|gimage
argument_list|,
name|offx
argument_list|,
name|offy
argument_list|,
name|offx
operator|+
name|new_width
argument_list|,
name|offy
operator|+
name|new_height
argument_list|,
name|layer_only
argument_list|,
name|crop_layers
argument_list|)
expr_stmt|;
return|return
name|procedural_db_return_args
argument_list|(
operator|&
name|crop_proc
argument_list|,
name|success
argument_list|)
return|;
block|}
end_function

end_unit

