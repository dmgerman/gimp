begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"gimage_mask.h"
end_include

begin_include
include|#
directive|include
file|"info_dialog.h"
end_include

begin_include
include|#
directive|include
file|"scale_tool.h"
end_include

begin_include
include|#
directive|include
file|"selection.h"
end_include

begin_include
include|#
directive|include
file|"tools.h"
end_include

begin_include
include|#
directive|include
file|"transform_core.h"
end_include

begin_include
include|#
directive|include
file|"transform_tool.h"
end_include

begin_include
include|#
directive|include
file|"undo.h"
end_include

begin_define
DECL|macro|X1
define|#
directive|define
name|X1
value|0
end_define

begin_define
DECL|macro|Y1
define|#
directive|define
name|Y1
value|1
end_define

begin_define
DECL|macro|X2
define|#
directive|define
name|X2
value|2
end_define

begin_define
DECL|macro|Y2
define|#
directive|define
name|Y2
value|3
end_define

begin_comment
comment|/*  storage for information dialog fields  */
end_comment

begin_decl_stmt
DECL|variable|orig_width_buf
name|char
name|orig_width_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|orig_height_buf
name|char
name|orig_height_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|width_buf
name|char
name|width_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|height_buf
name|char
name|height_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|x_ratio_buf
name|char
name|x_ratio_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|y_ratio_buf
name|char
name|y_ratio_buf
index|[
name|MAX_INFO_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  forward function declarations  */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|scale_tool_scale
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|int
parameter_list|,
name|double
modifier|*
parameter_list|,
name|TileManager
modifier|*
parameter_list|,
name|int
parameter_list|,
name|Matrix
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|scale_tool_recalc
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scale_tool_motion
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scale_info_update
parameter_list|(
name|Tool
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|scale_invoker
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
modifier|*
DECL|function|scale_tool_transform (tool,gdisp_ptr,state)
name|scale_tool_transform
parameter_list|(
name|tool
parameter_list|,
name|gdisp_ptr
parameter_list|,
name|state
parameter_list|)
name|Tool
modifier|*
name|tool
decl_stmt|;
name|gpointer
name|gdisp_ptr
decl_stmt|;
name|int
name|state
decl_stmt|;
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|TransformCore
modifier|*
name|transform_core
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|transform_core
operator|=
operator|(
name|TransformCore
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|INIT
case|:
if|if
condition|(
operator|!
name|transform_info
condition|)
block|{
name|transform_info
operator|=
name|info_dialog_new
argument_list|(
literal|"Scaling Information"
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|transform_info
argument_list|,
literal|"Original Width: "
argument_list|,
name|orig_width_buf
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|transform_info
argument_list|,
literal|"Original Height: "
argument_list|,
name|orig_height_buf
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|transform_info
argument_list|,
literal|"Current Width: "
argument_list|,
name|width_buf
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|transform_info
argument_list|,
literal|"Current Height: "
argument_list|,
name|height_buf
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|transform_info
argument_list|,
literal|"X Scale Ratio: "
argument_list|,
name|x_ratio_buf
argument_list|)
expr_stmt|;
name|info_dialog_add_field
argument_list|(
name|transform_info
argument_list|,
literal|"Y Scale Ratio: "
argument_list|,
name|y_ratio_buf
argument_list|)
expr_stmt|;
block|}
name|transform_core
operator|->
name|trans_info
index|[
name|X1
index|]
operator|=
operator|(
name|double
operator|)
name|transform_core
operator|->
name|x1
expr_stmt|;
name|transform_core
operator|->
name|trans_info
index|[
name|Y1
index|]
operator|=
operator|(
name|double
operator|)
name|transform_core
operator|->
name|y1
expr_stmt|;
name|transform_core
operator|->
name|trans_info
index|[
name|X2
index|]
operator|=
operator|(
name|double
operator|)
name|transform_core
operator|->
name|x2
expr_stmt|;
name|transform_core
operator|->
name|trans_info
index|[
name|Y2
index|]
operator|=
operator|(
name|double
operator|)
name|transform_core
operator|->
name|y2
expr_stmt|;
return|return
name|NULL
return|;
break|break;
case|case
name|MOTION
case|:
name|scale_tool_motion
argument_list|(
name|tool
argument_list|,
name|gdisp_ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|scale_tool_recalc
argument_list|(
name|tool
argument_list|,
name|gdisp_ptr
argument_list|)
operator|)
return|;
break|break;
case|case
name|RECALC
case|:
return|return
operator|(
name|scale_tool_recalc
argument_list|(
name|tool
argument_list|,
name|gdisp_ptr
argument_list|)
operator|)
return|;
break|break;
case|case
name|FINISH
case|:
return|return
name|scale_tool_scale
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|,
name|transform_core
operator|->
name|trans_info
argument_list|,
name|transform_core
operator|->
name|original
argument_list|,
name|transform_tool_smoothing
argument_list|()
argument_list|,
name|transform_core
operator|->
name|transform
argument_list|)
return|;
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|Tool
modifier|*
DECL|function|tools_new_scale_tool ()
name|tools_new_scale_tool
parameter_list|()
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|TransformCore
modifier|*
name|private
decl_stmt|;
name|tool
operator|=
name|transform_core_new
argument_list|(
name|SCALE
argument_list|,
name|INTERACTIVE
argument_list|)
expr_stmt|;
name|private
operator|=
name|tool
operator|->
name|private
expr_stmt|;
comment|/*  set the rotation specific transformation attributes  */
name|private
operator|->
name|trans_func
operator|=
name|scale_tool_transform
expr_stmt|;
name|private
operator|->
name|trans_info
index|[
name|X1
index|]
operator|=
literal|0
expr_stmt|;
name|private
operator|->
name|trans_info
index|[
name|Y1
index|]
operator|=
literal|0
expr_stmt|;
name|private
operator|->
name|trans_info
index|[
name|X2
index|]
operator|=
literal|0
expr_stmt|;
name|private
operator|->
name|trans_info
index|[
name|Y2
index|]
operator|=
literal|0
expr_stmt|;
comment|/*  assemble the transformation matrix  */
name|identity_matrix
argument_list|(
name|private
operator|->
name|transform
argument_list|)
expr_stmt|;
return|return
name|tool
return|;
block|}
end_function

begin_function
name|void
DECL|function|tools_free_scale_tool (tool)
name|tools_free_scale_tool
parameter_list|(
name|tool
parameter_list|)
name|Tool
modifier|*
name|tool
decl_stmt|;
block|{
name|transform_core_free
argument_list|(
name|tool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|scale_info_update (tool)
name|scale_info_update
parameter_list|(
name|tool
parameter_list|)
name|Tool
modifier|*
name|tool
decl_stmt|;
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|TransformCore
modifier|*
name|transform_core
decl_stmt|;
name|double
name|ratio_x
decl_stmt|,
name|ratio_y
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|x3
decl_stmt|,
name|y3
decl_stmt|,
name|x4
decl_stmt|,
name|y4
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|transform_core
operator|=
operator|(
name|TransformCore
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
comment|/*  Find original sizes  */
name|x1
operator|=
name|transform_core
operator|->
name|x1
expr_stmt|;
name|y1
operator|=
name|transform_core
operator|->
name|y1
expr_stmt|;
name|x2
operator|=
name|transform_core
operator|->
name|x2
expr_stmt|;
name|y2
operator|=
name|transform_core
operator|->
name|y2
expr_stmt|;
name|sprintf
argument_list|(
name|orig_width_buf
argument_list|,
literal|"%d"
argument_list|,
name|x2
operator|-
name|x1
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|orig_height_buf
argument_list|,
literal|"%d"
argument_list|,
name|y2
operator|-
name|y1
argument_list|)
expr_stmt|;
comment|/*  Find current sizes  */
name|x3
operator|=
operator|(
name|int
operator|)
name|transform_core
operator|->
name|trans_info
index|[
name|X1
index|]
expr_stmt|;
name|y3
operator|=
operator|(
name|int
operator|)
name|transform_core
operator|->
name|trans_info
index|[
name|Y1
index|]
expr_stmt|;
name|x4
operator|=
operator|(
name|int
operator|)
name|transform_core
operator|->
name|trans_info
index|[
name|X2
index|]
expr_stmt|;
name|y4
operator|=
operator|(
name|int
operator|)
name|transform_core
operator|->
name|trans_info
index|[
name|Y2
index|]
expr_stmt|;
name|sprintf
argument_list|(
name|width_buf
argument_list|,
literal|"%d"
argument_list|,
name|x4
operator|-
name|x3
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|height_buf
argument_list|,
literal|"%d"
argument_list|,
name|y4
operator|-
name|y3
argument_list|)
expr_stmt|;
name|ratio_x
operator|=
name|ratio_y
operator|=
literal|0.0
expr_stmt|;
if|if
condition|(
name|x2
operator|-
name|x1
condition|)
name|ratio_x
operator|=
call|(
name|double
call|)
argument_list|(
name|x4
operator|-
name|x3
argument_list|)
operator|/
call|(
name|double
call|)
argument_list|(
name|x2
operator|-
name|x1
argument_list|)
expr_stmt|;
if|if
condition|(
name|y2
operator|-
name|y1
condition|)
name|ratio_y
operator|=
call|(
name|double
call|)
argument_list|(
name|y4
operator|-
name|y3
argument_list|)
operator|/
call|(
name|double
call|)
argument_list|(
name|y2
operator|-
name|y1
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|x_ratio_buf
argument_list|,
literal|"%0.2f"
argument_list|,
name|ratio_x
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|y_ratio_buf
argument_list|,
literal|"%0.2f"
argument_list|,
name|ratio_y
argument_list|)
expr_stmt|;
name|info_dialog_update
argument_list|(
name|transform_info
argument_list|)
expr_stmt|;
name|info_dialog_popup
argument_list|(
name|transform_info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|scale_tool_motion (tool,gdisp_ptr)
name|scale_tool_motion
parameter_list|(
name|tool
parameter_list|,
name|gdisp_ptr
parameter_list|)
name|Tool
modifier|*
name|tool
decl_stmt|;
name|void
modifier|*
name|gdisp_ptr
decl_stmt|;
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|TransformCore
modifier|*
name|transform_core
decl_stmt|;
name|double
name|ratio
decl_stmt|;
name|double
modifier|*
name|x1
decl_stmt|,
modifier|*
name|y1
decl_stmt|;
name|double
modifier|*
name|x2
decl_stmt|,
modifier|*
name|y2
decl_stmt|;
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|dir_x
decl_stmt|,
name|dir_y
decl_stmt|;
name|int
name|diff_x
decl_stmt|,
name|diff_y
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|transform_core
operator|=
operator|(
name|TransformCore
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|diff_x
operator|=
name|transform_core
operator|->
name|curx
operator|-
name|transform_core
operator|->
name|lastx
expr_stmt|;
name|diff_y
operator|=
name|transform_core
operator|->
name|cury
operator|-
name|transform_core
operator|->
name|lasty
expr_stmt|;
switch|switch
condition|(
name|transform_core
operator|->
name|function
condition|)
block|{
case|case
name|HANDLE_1
case|:
name|x1
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|X1
index|]
expr_stmt|;
name|y1
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|Y1
index|]
expr_stmt|;
name|x2
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|X2
index|]
expr_stmt|;
name|y2
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|Y2
index|]
expr_stmt|;
name|dir_x
operator|=
name|dir_y
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|HANDLE_2
case|:
name|x1
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|X2
index|]
expr_stmt|;
name|y1
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|Y1
index|]
expr_stmt|;
name|x2
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|X1
index|]
expr_stmt|;
name|y2
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|Y2
index|]
expr_stmt|;
name|dir_x
operator|=
operator|-
literal|1
expr_stmt|;
name|dir_y
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|HANDLE_3
case|:
name|x1
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|X1
index|]
expr_stmt|;
name|y1
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|Y2
index|]
expr_stmt|;
name|x2
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|X2
index|]
expr_stmt|;
name|y2
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|Y1
index|]
expr_stmt|;
name|dir_x
operator|=
literal|1
expr_stmt|;
name|dir_y
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|HANDLE_4
case|:
name|x1
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|X2
index|]
expr_stmt|;
name|y1
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|Y2
index|]
expr_stmt|;
name|x2
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|X1
index|]
expr_stmt|;
name|y2
operator|=
operator|&
name|transform_core
operator|->
name|trans_info
index|[
name|Y1
index|]
expr_stmt|;
name|dir_x
operator|=
name|dir_y
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default :
return|return;
block|}
comment|/*  if just the control key is down, affect only the height  */
if|if
condition|(
name|transform_core
operator|->
name|state
operator|&
name|ControlMask
operator|&&
operator|!
operator|(
name|transform_core
operator|->
name|state
operator|&
name|ShiftMask
operator|)
condition|)
name|diff_x
operator|=
literal|0
expr_stmt|;
comment|/*  if just the shift key is down, affect only the width  */
elseif|else
if|if
condition|(
name|transform_core
operator|->
name|state
operator|&
name|ShiftMask
operator|&&
operator|!
operator|(
name|transform_core
operator|->
name|state
operator|&
name|ControlMask
operator|)
condition|)
name|diff_y
operator|=
literal|0
expr_stmt|;
operator|*
name|x1
operator|+=
name|diff_x
expr_stmt|;
operator|*
name|y1
operator|+=
name|diff_y
expr_stmt|;
if|if
condition|(
name|dir_x
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|x1
operator|>=
operator|*
name|x2
condition|)
operator|*
name|x1
operator|=
operator|*
name|x2
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|x1
operator|<=
operator|*
name|x2
condition|)
operator|*
name|x1
operator|=
operator|*
name|x2
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|dir_y
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|y1
operator|>=
operator|*
name|y2
condition|)
operator|*
name|y1
operator|=
operator|*
name|y2
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|y1
operator|<=
operator|*
name|y2
condition|)
operator|*
name|y1
operator|=
operator|*
name|y2
operator|+
literal|1
expr_stmt|;
block|}
comment|/*  if both the control key& shift keys are down, keep the aspect ratio intac t  */
if|if
condition|(
name|transform_core
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
operator|&&
name|transform_core
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
name|ratio
operator|=
call|(
name|double
call|)
argument_list|(
name|transform_core
operator|->
name|x2
operator|-
name|transform_core
operator|->
name|x1
argument_list|)
operator|/
call|(
name|double
call|)
argument_list|(
name|transform_core
operator|->
name|y2
operator|-
name|transform_core
operator|->
name|y1
argument_list|)
expr_stmt|;
name|w
operator|=
name|ABS
argument_list|(
operator|(
operator|*
name|x2
operator|-
operator|*
name|x1
operator|)
argument_list|)
expr_stmt|;
name|h
operator|=
name|ABS
argument_list|(
operator|(
operator|*
name|y2
operator|-
operator|*
name|y1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|>
name|h
operator|*
name|ratio
condition|)
name|h
operator|=
name|w
operator|/
name|ratio
expr_stmt|;
else|else
name|w
operator|=
name|h
operator|*
name|ratio
expr_stmt|;
operator|*
name|y1
operator|=
operator|*
name|y2
operator|-
name|dir_y
operator|*
name|h
expr_stmt|;
operator|*
name|x1
operator|=
operator|*
name|x2
operator|-
name|dir_x
operator|*
name|w
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|scale_tool_recalc (tool,gdisp_ptr)
name|scale_tool_recalc
parameter_list|(
name|tool
parameter_list|,
name|gdisp_ptr
parameter_list|)
name|Tool
modifier|*
name|tool
decl_stmt|;
name|void
modifier|*
name|gdisp_ptr
decl_stmt|;
block|{
name|TransformCore
modifier|*
name|transform_core
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|int
name|diffx
decl_stmt|,
name|diffy
decl_stmt|;
name|int
name|cx
decl_stmt|,
name|cy
decl_stmt|;
name|double
name|scalex
decl_stmt|,
name|scaley
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|tool
operator|->
name|gdisp_ptr
expr_stmt|;
name|transform_core
operator|=
operator|(
name|TransformCore
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
name|x1
operator|=
operator|(
name|int
operator|)
name|transform_core
operator|->
name|trans_info
index|[
name|X1
index|]
expr_stmt|;
name|y1
operator|=
operator|(
name|int
operator|)
name|transform_core
operator|->
name|trans_info
index|[
name|Y1
index|]
expr_stmt|;
name|x2
operator|=
operator|(
name|int
operator|)
name|transform_core
operator|->
name|trans_info
index|[
name|X2
index|]
expr_stmt|;
name|y2
operator|=
operator|(
name|int
operator|)
name|transform_core
operator|->
name|trans_info
index|[
name|Y2
index|]
expr_stmt|;
name|scalex
operator|=
name|scaley
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|transform_core
operator|->
name|x2
operator|-
name|transform_core
operator|->
name|x1
condition|)
name|scalex
operator|=
call|(
name|double
call|)
argument_list|(
name|x2
operator|-
name|x1
argument_list|)
operator|/
call|(
name|double
call|)
argument_list|(
name|transform_core
operator|->
name|x2
operator|-
name|transform_core
operator|->
name|x1
argument_list|)
expr_stmt|;
if|if
condition|(
name|transform_core
operator|->
name|y2
operator|-
name|transform_core
operator|->
name|y1
condition|)
name|scaley
operator|=
call|(
name|double
call|)
argument_list|(
name|y2
operator|-
name|y1
argument_list|)
operator|/
call|(
name|double
call|)
argument_list|(
name|transform_core
operator|->
name|y2
operator|-
name|transform_core
operator|->
name|y1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|transform_core
operator|->
name|function
condition|)
block|{
case|case
name|HANDLE_1
case|:
name|cx
operator|=
name|x2
expr_stmt|;
name|cy
operator|=
name|y2
expr_stmt|;
name|diffx
operator|=
name|x2
operator|-
name|transform_core
operator|->
name|x2
expr_stmt|;
name|diffy
operator|=
name|y2
operator|-
name|transform_core
operator|->
name|y2
expr_stmt|;
break|break;
case|case
name|HANDLE_2
case|:
name|cx
operator|=
name|x1
expr_stmt|;
name|cy
operator|=
name|y2
expr_stmt|;
name|diffx
operator|=
name|x1
operator|-
name|transform_core
operator|->
name|x1
expr_stmt|;
name|diffy
operator|=
name|y2
operator|-
name|transform_core
operator|->
name|y2
expr_stmt|;
break|break;
case|case
name|HANDLE_3
case|:
name|cx
operator|=
name|x2
expr_stmt|;
name|cy
operator|=
name|y1
expr_stmt|;
name|diffx
operator|=
name|x2
operator|-
name|transform_core
operator|->
name|x2
expr_stmt|;
name|diffy
operator|=
name|y1
operator|-
name|transform_core
operator|->
name|y1
expr_stmt|;
break|break;
case|case
name|HANDLE_4
case|:
name|cx
operator|=
name|x1
expr_stmt|;
name|cy
operator|=
name|y1
expr_stmt|;
name|diffx
operator|=
name|x1
operator|-
name|transform_core
operator|->
name|x1
expr_stmt|;
name|diffy
operator|=
name|y1
operator|-
name|transform_core
operator|->
name|y1
expr_stmt|;
break|break;
default|default :
name|cx
operator|=
name|x1
expr_stmt|;
name|cy
operator|=
name|y1
expr_stmt|;
name|diffx
operator|=
name|diffy
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|/*  assemble the transformation matrix  */
name|identity_matrix
argument_list|(
name|transform_core
operator|->
name|transform
argument_list|)
expr_stmt|;
name|translate_matrix
argument_list|(
name|transform_core
operator|->
name|transform
argument_list|,
operator|(
name|double
operator|)
operator|-
name|cx
operator|+
name|diffx
argument_list|,
operator|(
name|double
operator|)
operator|-
name|cy
operator|+
name|diffy
argument_list|)
expr_stmt|;
name|scale_matrix
argument_list|(
name|transform_core
operator|->
name|transform
argument_list|,
name|scalex
argument_list|,
name|scaley
argument_list|)
expr_stmt|;
name|translate_matrix
argument_list|(
name|transform_core
operator|->
name|transform
argument_list|,
operator|(
name|double
operator|)
name|cx
argument_list|,
operator|(
name|double
operator|)
name|cy
argument_list|)
expr_stmt|;
comment|/*  transform the bounding box  */
name|transform_bounding_box
argument_list|(
name|tool
argument_list|)
expr_stmt|;
comment|/*  update the information dialog  */
name|scale_info_update
argument_list|(
name|tool
argument_list|)
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|scale_tool_scale (gimage,drawable_id,trans_info,float_tiles,interpolation,matrix)
name|scale_tool_scale
parameter_list|(
name|gimage
parameter_list|,
name|drawable_id
parameter_list|,
name|trans_info
parameter_list|,
name|float_tiles
parameter_list|,
name|interpolation
parameter_list|,
name|matrix
parameter_list|)
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|int
name|drawable_id
decl_stmt|;
name|double
modifier|*
name|trans_info
decl_stmt|;
name|TileManager
modifier|*
name|float_tiles
decl_stmt|;
name|int
name|interpolation
decl_stmt|;
name|Matrix
name|matrix
decl_stmt|;
block|{
name|TileManager
modifier|*
name|new_tiles
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|PixelRegion
name|srcPR
decl_stmt|,
name|destPR
decl_stmt|;
name|x1
operator|=
name|trans_info
index|[
name|X1
index|]
expr_stmt|;
name|y1
operator|=
name|trans_info
index|[
name|Y1
index|]
expr_stmt|;
name|x2
operator|=
name|trans_info
index|[
name|X2
index|]
expr_stmt|;
name|y2
operator|=
name|trans_info
index|[
name|Y2
index|]
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|float_tiles
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|float_tiles
operator|->
name|levels
index|[
literal|0
index|]
operator|.
name|width
argument_list|,
name|float_tiles
operator|->
name|levels
index|[
literal|0
index|]
operator|.
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  Create the new tile manager  */
name|new_tiles
operator|=
name|tile_manager_new
argument_list|(
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|,
name|float_tiles
operator|->
name|levels
index|[
literal|0
index|]
operator|.
name|bpp
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|drawable_type
argument_list|(
name|drawable_id
argument_list|)
operator|==
name|INDEXED_GIMAGE
operator|||
name|drawable_type
argument_list|(
name|drawable_id
argument_list|)
operator|==
name|INDEXEDA_GIMAGE
operator|||
operator|!
name|interpolation
condition|)
name|scale_region_no_resample
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
else|else
name|scale_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
name|new_tiles
operator|->
name|x
operator|=
name|x1
expr_stmt|;
name|new_tiles
operator|->
name|y
operator|=
name|y1
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
name|new_tiles
return|;
block|}
end_function

begin_comment
comment|/*  The scale procedure definition  */
end_comment

begin_decl_stmt
DECL|variable|scale_args
name|ProcArg
name|scale_args
index|[]
init|=
block|{
block|{
name|PDB_IMAGE
block|,
literal|"image"
block|,
literal|"the image"
block|}
block|,
block|{
name|PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"the affected drawable"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"interpolation"
block|,
literal|"whether to use interpolation"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"x1"
block|,
literal|"the x coordinate of the upper-left corner of newly scaled region"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"y1"
block|,
literal|"the y coordinate of the upper-left corner of newly scaled region"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"x2"
block|,
literal|"the x coordinate of the lower-right corner of newly scaled region"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"y2"
block|,
literal|"the y coordinate of the lower-right corner of newly scaled region"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|scale_out_args
name|ProcArg
name|scale_out_args
index|[]
init|=
block|{
block|{
name|PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"the scaled drawable"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|scale_proc
name|ProcRecord
name|scale_proc
init|=
block|{
literal|"gimp_scale"
block|,
literal|"Scale the specified drawable"
block|,
literal|"This tool scales the specified drawable if no selection exists.  If a selection exists, the portion of the drawable which lies under the selection is cut from the drawable and made into a floating selection which is then scaled by the specified amount.  The interpolation parameter can be set to TRUE to indicate that either linear or cubic interpolation should be used to smooth the resulting scaled drawable.  The return value is the ID of the scaled drawable.  If there was no selection, this will be equal to the drawable ID supplied as input.  Otherwise, this will be the newly created and scaled drawable."
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1995-1996"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|7
block|,
name|scale_args
block|,
comment|/*  Output arguments  */
literal|1
block|,
name|scale_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|scale_invoker
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|scale_invoker (args)
name|scale_invoker
parameter_list|(
name|args
parameter_list|)
name|Argument
modifier|*
name|args
decl_stmt|;
block|{
name|int
name|success
init|=
name|TRUE
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|int
name|drawable_id
decl_stmt|;
name|int
name|interpolation
decl_stmt|;
name|double
name|trans_info
index|[
literal|4
index|]
decl_stmt|;
name|int
name|int_value
decl_stmt|;
name|TileManager
modifier|*
name|float_tiles
decl_stmt|;
name|TileManager
modifier|*
name|new_tiles
decl_stmt|;
name|Matrix
name|matrix
decl_stmt|;
name|int
name|new_layer
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|drawable_id
operator|=
operator|-
literal|1
expr_stmt|;
name|layer
operator|=
name|NULL
expr_stmt|;
comment|/*  the gimage  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|gimage_get_ID
argument_list|(
name|int_value
argument_list|)
operator|)
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  the drawable  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|gimage
operator|==
name|drawable_gimage
argument_list|(
name|int_value
argument_list|)
condition|)
name|drawable_id
operator|=
name|int_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  interpolation  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|interpolation
operator|=
operator|(
name|int_value
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
block|}
comment|/*  scale extents  */
if|if
condition|(
name|success
condition|)
block|{
name|trans_info
index|[
name|X1
index|]
operator|=
name|args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_float
expr_stmt|;
name|trans_info
index|[
name|Y1
index|]
operator|=
name|args
index|[
literal|4
index|]
operator|.
name|value
operator|.
name|pdb_float
expr_stmt|;
name|trans_info
index|[
name|X2
index|]
operator|=
name|args
index|[
literal|5
index|]
operator|.
name|value
operator|.
name|pdb_float
expr_stmt|;
name|trans_info
index|[
name|Y2
index|]
operator|=
name|args
index|[
literal|6
index|]
operator|.
name|value
operator|.
name|pdb_float
expr_stmt|;
if|if
condition|(
name|trans_info
index|[
name|X1
index|]
operator|>=
name|trans_info
index|[
name|X2
index|]
operator|||
name|trans_info
index|[
name|Y1
index|]
operator|>=
name|trans_info
index|[
name|Y2
index|]
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  call the scale procedure  */
if|if
condition|(
name|success
condition|)
block|{
name|double
name|scalex
decl_stmt|,
name|scaley
decl_stmt|;
comment|/*  Start a transform undo group  */
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|TRANSFORM_CORE_UNDO
argument_list|)
expr_stmt|;
comment|/*  Cut/Copy from the specified drawable  */
name|float_tiles
operator|=
name|transform_core_cut
argument_list|(
name|gimage
argument_list|,
name|drawable_id
argument_list|,
operator|&
name|new_layer
argument_list|)
expr_stmt|;
name|scalex
operator|=
name|scaley
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|float_tiles
operator|->
name|levels
index|[
literal|0
index|]
operator|.
name|width
condition|)
name|scalex
operator|=
operator|(
name|trans_info
index|[
name|X2
index|]
operator|-
name|trans_info
index|[
name|X1
index|]
operator|)
operator|/
operator|(
name|double
operator|)
name|float_tiles
operator|->
name|levels
index|[
literal|0
index|]
operator|.
name|width
expr_stmt|;
if|if
condition|(
name|float_tiles
operator|->
name|levels
index|[
literal|0
index|]
operator|.
name|height
condition|)
name|scaley
operator|=
operator|(
name|trans_info
index|[
name|Y2
index|]
operator|-
name|trans_info
index|[
name|Y1
index|]
operator|)
operator|/
operator|(
name|double
operator|)
name|float_tiles
operator|->
name|levels
index|[
literal|0
index|]
operator|.
name|height
expr_stmt|;
comment|/*  assemble the transformation matrix  */
name|identity_matrix
argument_list|(
name|matrix
argument_list|)
expr_stmt|;
name|translate_matrix
argument_list|(
name|matrix
argument_list|,
name|float_tiles
operator|->
name|x
argument_list|,
name|float_tiles
operator|->
name|y
argument_list|)
expr_stmt|;
name|scale_matrix
argument_list|(
name|matrix
argument_list|,
name|scalex
argument_list|,
name|scaley
argument_list|)
expr_stmt|;
name|translate_matrix
argument_list|(
name|matrix
argument_list|,
name|trans_info
index|[
name|X1
index|]
argument_list|,
name|trans_info
index|[
name|Y1
index|]
argument_list|)
expr_stmt|;
comment|/*  scale the buffer  */
name|new_tiles
operator|=
name|scale_tool_scale
argument_list|(
name|gimage
argument_list|,
name|drawable_id
argument_list|,
name|trans_info
argument_list|,
name|float_tiles
argument_list|,
name|interpolation
argument_list|,
name|matrix
argument_list|)
expr_stmt|;
comment|/*  free the cut/copied buffer  */
name|tile_manager_destroy
argument_list|(
name|float_tiles
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_tiles
condition|)
name|success
operator|=
operator|(
name|layer
operator|=
name|transform_core_paste
argument_list|(
name|gimage
argument_list|,
name|drawable_id
argument_list|,
name|new_tiles
argument_list|,
name|new_layer
argument_list|)
operator|)
operator|!=
name|NULL
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
comment|/*  push the undo group end  */
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|scale_proc
argument_list|,
name|success
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
condition|)
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|layer
operator|->
name|ID
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

end_unit

