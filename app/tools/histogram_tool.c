begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"actionarea.h"
end_include

begin_include
include|#
directive|include
file|"buildmenu.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"general.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"histogram.h"
end_include

begin_include
include|#
directive|include
file|"histogram_tool.h"
end_include

begin_include
include|#
directive|include
file|"image_map.h"
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_define
DECL|macro|TEXT_WIDTH
define|#
directive|define
name|TEXT_WIDTH
value|45
end_define

begin_define
DECL|macro|HISTOGRAM_WIDTH
define|#
directive|define
name|HISTOGRAM_WIDTH
value|256
end_define

begin_define
DECL|macro|HISTOGRAM_HEIGHT
define|#
directive|define
name|HISTOGRAM_HEIGHT
value|150
end_define

begin_typedef
DECL|typedef|HistogramTool
typedef|typedef
name|struct
name|_HistogramTool
name|HistogramTool
typedef|;
end_typedef

begin_struct
DECL|struct|_HistogramTool
struct|struct
name|_HistogramTool
block|{
DECL|member|x
DECL|member|y
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
comment|/*  coords for last mouse click  */
block|}
struct|;
end_struct

begin_typedef
DECL|typedef|HistogramToolDialog
typedef|typedef
name|struct
name|_HistogramToolDialog
name|HistogramToolDialog
typedef|;
end_typedef

begin_struct
DECL|struct|_HistogramToolDialog
struct|struct
name|_HistogramToolDialog
block|{
DECL|member|shell
name|GtkWidget
modifier|*
name|shell
decl_stmt|;
DECL|member|info_labels
name|GtkWidget
modifier|*
name|info_labels
index|[
literal|7
index|]
decl_stmt|;
DECL|member|channel_menu
name|GtkWidget
modifier|*
name|channel_menu
decl_stmt|;
DECL|member|histogram
name|Histogram
modifier|*
name|histogram
decl_stmt|;
DECL|member|mean
name|double
name|mean
decl_stmt|;
DECL|member|std_dev
name|double
name|std_dev
decl_stmt|;
DECL|member|median
name|double
name|median
decl_stmt|;
DECL|member|pixels
name|double
name|pixels
decl_stmt|;
DECL|member|count
name|double
name|count
decl_stmt|;
DECL|member|percentile
name|double
name|percentile
decl_stmt|;
DECL|member|drawable
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
DECL|member|image_map
name|ImageMap
name|image_map
decl_stmt|;
DECL|member|channel
name|int
name|channel
decl_stmt|;
DECL|member|color
name|int
name|color
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  histogram_tool action functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|histogram_tool_button_press
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_button_release
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventButton
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_motion
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_cursor_update
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|GdkEventMotion
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_control
parameter_list|(
name|Tool
modifier|*
parameter_list|,
name|int
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|HistogramToolDialog
modifier|*
name|histogram_tool_new_dialog
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_close_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|histogram_tool_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_value_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_red_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_green_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_blue_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|histogram_tool_options
specifier|static
name|void
modifier|*
name|histogram_tool_options
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|histogram_tool_dialog
specifier|static
name|HistogramToolDialog
modifier|*
name|histogram_tool_dialog
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|histogram_tool_histogram_info
parameter_list|(
name|PixelRegion
modifier|*
parameter_list|,
name|PixelRegion
modifier|*
parameter_list|,
name|HistogramValues
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_histogram_range
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|HistogramValues
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|histogram_tool_dialog_update
parameter_list|(
name|HistogramToolDialog
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|histogram_invoker
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|histogram_info_names
specifier|static
name|char
modifier|*
name|histogram_info_names
index|[
literal|7
index|]
init|=
block|{
literal|"Mean: "
block|,
literal|"Std Dev: "
block|,
literal|"Median: "
block|,
literal|"Pixels: "
block|,
literal|"Intensity: "
block|,
literal|"Count: "
block|,
literal|"Percentile: "
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  histogram_tool machinery  */
end_comment

begin_function
specifier|static
name|void
DECL|function|histogram_tool_histogram_info (PixelRegion * srcPR,PixelRegion * maskPR,HistogramValues values,void * user_data)
name|histogram_tool_histogram_info
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|maskPR
parameter_list|,
name|HistogramValues
name|values
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|HistogramToolDialog
modifier|*
name|htd
decl_stmt|;
name|unsigned
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mask
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|value
decl_stmt|,
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|mask
operator|=
name|NULL
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
name|htd
operator|=
operator|(
name|HistogramToolDialog
operator|*
operator|)
name|user_data
expr_stmt|;
name|h
operator|=
name|srcPR
operator|->
name|h
expr_stmt|;
name|src
operator|=
name|srcPR
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|mask
operator|=
name|maskPR
operator|->
name|data
expr_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|w
operator|=
name|srcPR
operator|->
name|w
expr_stmt|;
name|s
operator|=
name|src
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|m
operator|=
name|mask
expr_stmt|;
while|while
condition|(
name|w
operator|--
condition|)
block|{
if|if
condition|(
name|htd
operator|->
name|color
condition|)
block|{
name|value
operator|=
name|MAX
argument_list|(
name|s
index|[
name|RED_PIX
index|]
argument_list|,
name|s
index|[
name|GREEN_PIX
index|]
argument_list|)
expr_stmt|;
name|value
operator|=
name|MAX
argument_list|(
name|value
argument_list|,
name|s
index|[
name|BLUE_PIX
index|]
argument_list|)
expr_stmt|;
name|red
operator|=
name|s
index|[
name|RED_PIX
index|]
expr_stmt|;
name|green
operator|=
name|s
index|[
name|GREEN_PIX
index|]
expr_stmt|;
name|blue
operator|=
name|s
index|[
name|BLUE_PIX
index|]
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
block|{
name|values
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|value
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_RED
index|]
index|[
name|red
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_GREEN
index|]
index|[
name|green
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_BLUE
index|]
index|[
name|blue
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
block|}
else|else
block|{
name|values
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|value
index|]
operator|+=
literal|1.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_RED
index|]
index|[
name|red
index|]
operator|+=
literal|1.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_GREEN
index|]
index|[
name|green
index|]
operator|+=
literal|1.0
expr_stmt|;
name|values
index|[
name|HISTOGRAM_BLUE
index|]
index|[
name|blue
index|]
operator|+=
literal|1.0
expr_stmt|;
block|}
block|}
else|else
block|{
name|value
operator|=
name|s
index|[
name|GRAY_PIX
index|]
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|values
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|value
index|]
operator|+=
operator|(
name|double
operator|)
operator|*
name|m
operator|/
literal|255.0
expr_stmt|;
else|else
name|values
index|[
name|HISTOGRAM_VALUE
index|]
index|[
name|value
index|]
operator|+=
literal|1.0
expr_stmt|;
block|}
name|s
operator|+=
name|srcPR
operator|->
name|bytes
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|m
operator|+=
name|maskPR
operator|->
name|bytes
expr_stmt|;
block|}
name|src
operator|+=
name|srcPR
operator|->
name|rowstride
expr_stmt|;
if|if
condition|(
name|maskPR
condition|)
name|mask
operator|+=
name|maskPR
operator|->
name|rowstride
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_histogram_range (int start,int end,HistogramValues values,void * user_data)
name|histogram_tool_histogram_range
parameter_list|(
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|,
name|HistogramValues
name|values
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|HistogramToolDialog
modifier|*
name|htd
decl_stmt|;
name|double
name|pixels
decl_stmt|;
name|double
name|mean
decl_stmt|;
name|double
name|std_dev
decl_stmt|;
name|int
name|median
decl_stmt|;
name|double
name|count
decl_stmt|;
name|double
name|percentile
decl_stmt|;
name|double
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|htd
operator|=
operator|(
name|HistogramToolDialog
operator|*
operator|)
name|user_data
expr_stmt|;
name|count
operator|=
literal|0.0
expr_stmt|;
name|pixels
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|pixels
operator|+=
name|values
index|[
name|htd
operator|->
name|channel
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|start
operator|&&
name|i
operator|<=
name|end
condition|)
name|count
operator|+=
name|values
index|[
name|htd
operator|->
name|channel
index|]
index|[
name|i
index|]
expr_stmt|;
block|}
name|mean
operator|=
literal|0.0
expr_stmt|;
name|tmp
operator|=
literal|0.0
expr_stmt|;
name|median
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<=
name|end
condition|;
name|i
operator|++
control|)
block|{
name|mean
operator|+=
name|i
operator|*
name|values
index|[
name|htd
operator|->
name|channel
index|]
index|[
name|i
index|]
expr_stmt|;
name|tmp
operator|+=
name|values
index|[
name|htd
operator|->
name|channel
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|median
operator|==
operator|-
literal|1
operator|&&
name|tmp
operator|>
name|count
operator|/
literal|2
condition|)
name|median
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|count
condition|)
name|mean
operator|/=
name|count
expr_stmt|;
name|std_dev
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<=
name|end
condition|;
name|i
operator|++
control|)
name|std_dev
operator|+=
name|values
index|[
name|htd
operator|->
name|channel
index|]
index|[
name|i
index|]
operator|*
operator|(
name|i
operator|-
name|mean
operator|)
operator|*
operator|(
name|i
operator|-
name|mean
operator|)
expr_stmt|;
if|if
condition|(
name|count
condition|)
name|std_dev
operator|=
name|sqrt
argument_list|(
name|std_dev
operator|/
name|count
argument_list|)
expr_stmt|;
name|percentile
operator|=
name|count
operator|/
name|pixels
expr_stmt|;
name|htd
operator|->
name|mean
operator|=
name|mean
expr_stmt|;
name|htd
operator|->
name|std_dev
operator|=
name|std_dev
expr_stmt|;
name|htd
operator|->
name|median
operator|=
name|median
expr_stmt|;
name|htd
operator|->
name|pixels
operator|=
name|pixels
expr_stmt|;
name|htd
operator|->
name|count
operator|=
name|count
expr_stmt|;
name|htd
operator|->
name|percentile
operator|=
name|percentile
expr_stmt|;
if|if
condition|(
name|htd
operator|->
name|shell
condition|)
name|histogram_tool_dialog_update
argument_list|(
name|htd
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_dialog_update (HistogramToolDialog * htd,int start,int end)
name|histogram_tool_dialog_update
parameter_list|(
name|HistogramToolDialog
modifier|*
name|htd
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|)
block|{
name|char
name|text
index|[
literal|12
index|]
decl_stmt|;
comment|/*  mean  */
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%3.1f"
argument_list|,
name|htd
operator|->
name|mean
argument_list|)
expr_stmt|;
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|htd
operator|->
name|info_labels
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
comment|/*  std dev  */
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%3.1f"
argument_list|,
name|htd
operator|->
name|std_dev
argument_list|)
expr_stmt|;
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|htd
operator|->
name|info_labels
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
comment|/*  median  */
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%3.1f"
argument_list|,
name|htd
operator|->
name|median
argument_list|)
expr_stmt|;
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|htd
operator|->
name|info_labels
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
comment|/*  pixels  */
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%8.1f"
argument_list|,
name|htd
operator|->
name|pixels
argument_list|)
expr_stmt|;
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|htd
operator|->
name|info_labels
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
comment|/*  intensity  */
if|if
condition|(
name|start
operator|==
name|end
condition|)
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%d"
argument_list|,
name|start
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%d..%d"
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|htd
operator|->
name|info_labels
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
comment|/*  count  */
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%8.1f"
argument_list|,
name|htd
operator|->
name|count
argument_list|)
expr_stmt|;
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|htd
operator|->
name|info_labels
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
comment|/*  percentile  */
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"%2.2f"
argument_list|,
name|htd
operator|->
name|percentile
operator|*
literal|100
argument_list|)
expr_stmt|;
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|htd
operator|->
name|info_labels
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  histogram_tool action functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|histogram_tool_button_press (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|histogram_tool_button_press
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gdisp
operator|=
name|gdisp_ptr
expr_stmt|;
name|tool
operator|->
name|drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_button_release (Tool * tool,GdkEventButton * bevent,gpointer gdisp_ptr)
name|histogram_tool_button_release
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventButton
modifier|*
name|bevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_motion (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|histogram_tool_motion
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_cursor_update (Tool * tool,GdkEventMotion * mevent,gpointer gdisp_ptr)
name|histogram_tool_cursor_update
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|GdkEventMotion
modifier|*
name|mevent
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|gdisp_ptr
expr_stmt|;
name|gdisplay_install_tool_cursor
argument_list|(
name|gdisp
argument_list|,
name|GDK_TOP_LEFT_ARROW
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_control (Tool * tool,int action,gpointer gdisp_ptr)
name|histogram_tool_control
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|,
name|int
name|action
parameter_list|,
name|gpointer
name|gdisp_ptr
parameter_list|)
block|{
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|PAUSE
case|:
break|break;
case|case
name|RESUME
case|:
break|break;
case|case
name|HALT
case|:
if|if
condition|(
name|histogram_tool_dialog
condition|)
name|histogram_tool_close_callback
argument_list|(
name|NULL
argument_list|,
operator|(
name|gpointer
operator|)
name|histogram_tool_dialog
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|Tool
modifier|*
DECL|function|tools_new_histogram_tool ()
name|tools_new_histogram_tool
parameter_list|()
block|{
name|Tool
modifier|*
name|tool
decl_stmt|;
name|HistogramTool
modifier|*
name|private
decl_stmt|;
comment|/*  The tool options  */
if|if
condition|(
operator|!
name|histogram_tool_options
condition|)
name|histogram_tool_options
operator|=
name|tools_register_no_options
argument_list|(
name|HISTOGRAM
argument_list|,
literal|"Histogram Options"
argument_list|)
expr_stmt|;
name|tool
operator|=
operator|(
name|Tool
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Tool
argument_list|)
argument_list|)
expr_stmt|;
name|private
operator|=
operator|(
name|HistogramTool
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|HistogramTool
argument_list|)
argument_list|)
expr_stmt|;
name|tool
operator|->
name|type
operator|=
name|HISTOGRAM
expr_stmt|;
name|tool
operator|->
name|state
operator|=
name|INACTIVE
expr_stmt|;
name|tool
operator|->
name|scroll_lock
operator|=
literal|1
expr_stmt|;
comment|/*  Disallow scrolling  */
name|tool
operator|->
name|auto_snap_to
operator|=
name|TRUE
expr_stmt|;
name|tool
operator|->
name|private
operator|=
operator|(
name|void
operator|*
operator|)
name|private
expr_stmt|;
name|tool
operator|->
name|button_press_func
operator|=
name|histogram_tool_button_press
expr_stmt|;
name|tool
operator|->
name|button_release_func
operator|=
name|histogram_tool_button_release
expr_stmt|;
name|tool
operator|->
name|motion_func
operator|=
name|histogram_tool_motion
expr_stmt|;
name|tool
operator|->
name|arrow_keys_func
operator|=
name|standard_arrow_keys_func
expr_stmt|;
name|tool
operator|->
name|cursor_update_func
operator|=
name|histogram_tool_cursor_update
expr_stmt|;
name|tool
operator|->
name|control_func
operator|=
name|histogram_tool_control
expr_stmt|;
name|tool
operator|->
name|preserve
operator|=
name|FALSE
expr_stmt|;
return|return
name|tool
return|;
block|}
end_function

begin_function
name|void
DECL|function|tools_free_histogram_tool (Tool * tool)
name|tools_free_histogram_tool
parameter_list|(
name|Tool
modifier|*
name|tool
parameter_list|)
block|{
name|HistogramTool
modifier|*
name|hist
decl_stmt|;
name|hist
operator|=
operator|(
name|HistogramTool
operator|*
operator|)
name|tool
operator|->
name|private
expr_stmt|;
comment|/*  Close the histogram dialog  */
if|if
condition|(
name|histogram_tool_dialog
condition|)
name|histogram_tool_close_callback
argument_list|(
name|NULL
argument_list|,
operator|(
name|gpointer
operator|)
name|histogram_tool_dialog
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|hist
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|histogram_tool_initialize (GDisplay * gdisp)
name|histogram_tool_initialize
parameter_list|(
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
if|if
condition|(
name|drawable_indexed
argument_list|(
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Histogram does not operate on indexed drawables."
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*  The histogram_tool dialog  */
if|if
condition|(
operator|!
name|histogram_tool_dialog
condition|)
name|histogram_tool_dialog
operator|=
name|histogram_tool_new_dialog
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|GTK_WIDGET_VISIBLE
argument_list|(
name|histogram_tool_dialog
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_show
argument_list|(
name|histogram_tool_dialog
operator|->
name|shell
argument_list|)
expr_stmt|;
name|histogram_tool_dialog
operator|->
name|drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|histogram_tool_dialog
operator|->
name|color
operator|=
name|drawable_color
argument_list|(
name|histogram_tool_dialog
operator|->
name|drawable
argument_list|)
expr_stmt|;
comment|/*  hide or show the channel menu based on image type  */
if|if
condition|(
name|histogram_tool_dialog
operator|->
name|color
condition|)
name|gtk_widget_show
argument_list|(
name|histogram_tool_dialog
operator|->
name|channel_menu
argument_list|)
expr_stmt|;
else|else
name|gtk_widget_hide
argument_list|(
name|histogram_tool_dialog
operator|->
name|channel_menu
argument_list|)
expr_stmt|;
name|histogram_update
argument_list|(
name|histogram_tool_dialog
operator|->
name|histogram
argument_list|,
name|histogram_tool_dialog
operator|->
name|drawable
argument_list|,
name|histogram_tool_histogram_info
argument_list|,
operator|(
name|void
operator|*
operator|)
name|histogram_tool_dialog
argument_list|)
expr_stmt|;
name|histogram_range
argument_list|(
name|histogram_tool_dialog
operator|->
name|histogram
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************/
end_comment

begin_comment
comment|/*  Histogram Tool dialog  */
end_comment

begin_comment
comment|/***************************/
end_comment

begin_comment
comment|/*  the action area structure  */
end_comment

begin_decl_stmt
DECL|variable|action_items
specifier|static
name|ActionAreaItem
name|action_items
index|[]
init|=
block|{
block|{
literal|"Close"
block|,
name|histogram_tool_close_callback
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|color_option_items
specifier|static
name|MenuItem
name|color_option_items
index|[]
init|=
block|{
block|{
literal|"Value"
block|,
literal|0
block|,
literal|0
block|,
name|histogram_tool_value_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"Red"
block|,
literal|0
block|,
literal|0
block|,
name|histogram_tool_red_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"Green"
block|,
literal|0
block|,
literal|0
block|,
name|histogram_tool_green_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"Blue"
block|,
literal|0
block|,
literal|0
block|,
name|histogram_tool_blue_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|HistogramToolDialog
modifier|*
DECL|function|histogram_tool_new_dialog ()
name|histogram_tool_new_dialog
parameter_list|()
block|{
name|HistogramToolDialog
modifier|*
name|htd
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|option_menu
decl_stmt|;
name|GtkWidget
modifier|*
name|menu
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|htd
operator|=
operator|(
name|HistogramToolDialog
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|HistogramToolDialog
argument_list|)
argument_list|)
expr_stmt|;
name|htd
operator|->
name|channel
operator|=
name|HISTOGRAM_VALUE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|color_option_items
index|[
name|i
index|]
operator|.
name|user_data
operator|=
operator|(
name|gpointer
operator|)
name|htd
expr_stmt|;
comment|/*  The shell and main vbox  */
name|htd
operator|->
name|shell
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_wmclass
argument_list|(
name|GTK_WINDOW
argument_list|(
name|htd
operator|->
name|shell
argument_list|)
argument_list|,
literal|"histogram"
argument_list|,
literal|"Gimp"
argument_list|)
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|htd
operator|->
name|shell
argument_list|)
argument_list|,
literal|"Histogram"
argument_list|)
expr_stmt|;
comment|/* handle the wm close signal */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|htd
operator|->
name|shell
argument_list|)
argument_list|,
literal|"delete_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|histogram_tool_delete_callback
argument_list|,
name|htd
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|htd
operator|->
name|shell
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  The option menu for selecting channels  */
name|htd
operator|->
name|channel_menu
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|htd
operator|->
name|channel_menu
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Information on Channel: "
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|htd
operator|->
name|channel_menu
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|menu
operator|=
name|build_menu
argument_list|(
name|color_option_items
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|option_menu
operator|=
name|gtk_option_menu_new
argument_list|()
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|htd
operator|->
name|channel_menu
argument_list|)
argument_list|,
name|option_menu
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|option_menu
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|htd
operator|->
name|channel_menu
argument_list|)
expr_stmt|;
name|gtk_option_menu_set_menu
argument_list|(
name|GTK_OPTION_MENU
argument_list|(
name|option_menu
argument_list|)
argument_list|,
name|menu
argument_list|)
expr_stmt|;
comment|/*  The histogram tool histogram  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|htd
operator|->
name|histogram
operator|=
name|histogram_create
argument_list|(
name|HISTOGRAM_WIDTH
argument_list|,
name|HISTOGRAM_HEIGHT
argument_list|,
name|histogram_tool_histogram_range
argument_list|,
operator|(
name|void
operator|*
operator|)
name|htd
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|htd
operator|->
name|histogram
operator|->
name|histogram_widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|htd
operator|->
name|histogram
operator|->
name|histogram_widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*  The table containing histogram information  */
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|4
argument_list|,
literal|4
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  the labels for histogram information  */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
block|{
name|y
operator|=
operator|(
name|i
operator|%
literal|4
operator|)
expr_stmt|;
name|x
operator|=
operator|(
name|i
operator|/
literal|4
operator|)
operator|*
literal|2
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|histogram_info_names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
name|x
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
argument_list|,
name|y
operator|+
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|htd
operator|->
name|info_labels
index|[
name|i
index|]
operator|=
name|gtk_label_new
argument_list|(
literal|"0"
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|htd
operator|->
name|info_labels
index|[
name|i
index|]
argument_list|)
argument_list|,
literal|0.5
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|htd
operator|->
name|info_labels
index|[
name|i
index|]
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|x
operator|+
literal|2
argument_list|,
name|y
argument_list|,
name|y
operator|+
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|htd
operator|->
name|info_labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/*  The action area  */
name|action_items
index|[
literal|0
index|]
operator|.
name|user_data
operator|=
name|htd
expr_stmt|;
name|build_action_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|htd
operator|->
name|shell
argument_list|)
argument_list|,
name|action_items
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|htd
operator|->
name|shell
argument_list|)
expr_stmt|;
return|return
name|htd
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_close_callback (GtkWidget * widget,gpointer client_data)
name|histogram_tool_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|HistogramToolDialog
modifier|*
name|htd
decl_stmt|;
name|htd
operator|=
operator|(
name|HistogramToolDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|htd
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_hide
argument_list|(
name|htd
operator|->
name|shell
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|histogram_tool_delete_callback (GtkWidget * widget,GdkEvent * event,gpointer client_data)
name|histogram_tool_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|histogram_tool_close_callback
argument_list|(
name|widget
argument_list|,
name|client_data
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_value_callback (GtkWidget * w,gpointer client_data)
name|histogram_tool_value_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|HistogramToolDialog
modifier|*
name|htd
decl_stmt|;
name|htd
operator|=
operator|(
name|HistogramToolDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|htd
operator|->
name|channel
operator|!=
name|HISTOGRAM_VALUE
condition|)
block|{
name|htd
operator|->
name|channel
operator|=
name|HISTOGRAM_VALUE
expr_stmt|;
name|histogram_channel
argument_list|(
name|htd
operator|->
name|histogram
argument_list|,
name|htd
operator|->
name|channel
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_red_callback (GtkWidget * w,gpointer client_data)
name|histogram_tool_red_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|HistogramToolDialog
modifier|*
name|htd
decl_stmt|;
name|htd
operator|=
operator|(
name|HistogramToolDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|htd
operator|->
name|channel
operator|!=
name|HISTOGRAM_RED
condition|)
block|{
name|htd
operator|->
name|channel
operator|=
name|HISTOGRAM_RED
expr_stmt|;
name|histogram_channel
argument_list|(
name|htd
operator|->
name|histogram
argument_list|,
name|htd
operator|->
name|channel
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_green_callback (GtkWidget * w,gpointer client_data)
name|histogram_tool_green_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|HistogramToolDialog
modifier|*
name|htd
decl_stmt|;
name|htd
operator|=
operator|(
name|HistogramToolDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|htd
operator|->
name|channel
operator|!=
name|HISTOGRAM_GREEN
condition|)
block|{
name|htd
operator|->
name|channel
operator|=
name|HISTOGRAM_GREEN
expr_stmt|;
name|histogram_channel
argument_list|(
name|htd
operator|->
name|histogram
argument_list|,
name|htd
operator|->
name|channel
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|histogram_tool_blue_callback (GtkWidget * w,gpointer client_data)
name|histogram_tool_blue_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|HistogramToolDialog
modifier|*
name|htd
decl_stmt|;
name|htd
operator|=
operator|(
name|HistogramToolDialog
operator|*
operator|)
name|client_data
expr_stmt|;
if|if
condition|(
name|htd
operator|->
name|channel
operator|!=
name|HISTOGRAM_BLUE
condition|)
block|{
name|htd
operator|->
name|channel
operator|=
name|HISTOGRAM_BLUE
expr_stmt|;
name|histogram_channel
argument_list|(
name|htd
operator|->
name|histogram
argument_list|,
name|htd
operator|->
name|channel
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  The histogram procedure definition  */
end_comment

begin_decl_stmt
DECL|variable|histogram_args
name|ProcArg
name|histogram_args
index|[]
init|=
block|{
block|{
name|PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"the drawable"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"channel"
block|,
literal|"the channel to modify: { VALUE (0), RED (1), GREEN (2), BLUE (3), GRAY (0) }"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"start_range"
block|,
literal|"start of the intensity measurement range"
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"end_range"
block|,
literal|"end of the intensity measurement range"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|histogram_out_args
name|ProcArg
name|histogram_out_args
index|[]
init|=
block|{
block|{
name|PDB_FLOAT
block|,
literal|"mean"
block|,
literal|"mean intensity value"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"std_dev"
block|,
literal|"standard deviation of intensity values"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"median"
block|,
literal|"median intensity value"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"pixels"
block|,
literal|"alpha-weighted pixel count for entire image"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"count"
block|,
literal|"alpha-weighted pixel count for range"
block|}
block|,
block|{
name|PDB_FLOAT
block|,
literal|"percentile"
block|,
literal|"percentile that range falls under"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|histogram_proc
name|ProcRecord
name|histogram_proc
init|=
block|{
literal|"gimp_histogram"
block|,
literal|"Returns information on the intensity histogram for the specified drawable"
block|,
literal|"This tool makes it possible to gather information about the intensity histogram of a drawable.  A channel to examine is first specified.  This can be either value, red, green, or blue, depending on whether the drawable is of type color or grayscale.  The drawable may not be indexed.  Second, a range of intensities are specified.  The gimp_histogram function returns statistics based on the pixels in the drawable that fall under this range of values.  Mean, standard deviation, median, number of pixels, and percentile are all returned.  Additionally, the total count of pixels in the image is returned.  Counts of pixels are weighted by any associated alpha values and by the current selection mask.  That is, pixels that lie outside an active selection mask will not be counted.  Similarly, pixels with transparent alpha values will not be counted."
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1995-1996"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|4
block|,
name|histogram_args
block|,
comment|/*  Output arguments  */
literal|6
block|,
name|histogram_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|histogram_invoker
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|histogram_invoker (Argument * args)
name|histogram_invoker
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|PixelRegion
name|srcPR
decl_stmt|,
name|maskPR
decl_stmt|;
name|int
name|success
init|=
name|TRUE
decl_stmt|;
name|HistogramToolDialog
name|htd
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Channel
modifier|*
name|mask
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|int
name|channel
decl_stmt|;
name|int
name|low_range
decl_stmt|;
name|int
name|high_range
decl_stmt|;
name|int
name|int_value
decl_stmt|;
name|int
name|no_mask
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|int
name|off_x
decl_stmt|,
name|off_y
decl_stmt|;
name|void
modifier|*
name|pr
decl_stmt|;
name|drawable
operator|=
name|NULL
expr_stmt|;
name|low_range
operator|=
literal|0
expr_stmt|;
name|high_range
operator|=
literal|0
expr_stmt|;
comment|/*  the drawable  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|drawable
operator|=
name|drawable_get_ID
argument_list|(
name|int_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|drawable
operator|==
name|NULL
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
else|else
name|gimage
operator|=
name|drawable_gimage
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
comment|/*  channel  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|success
condition|)
block|{
if|if
condition|(
name|drawable_gray
argument_list|(
name|drawable
argument_list|)
condition|)
block|{
if|if
condition|(
name|int_value
operator|!=
literal|0
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drawable_color
argument_list|(
name|drawable
argument_list|)
condition|)
block|{
if|if
condition|(
name|int_value
operator|<
literal|0
operator|||
name|int_value
operator|>
literal|3
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
name|channel
operator|=
name|int_value
expr_stmt|;
block|}
comment|/*  low range  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|int_value
operator|>=
literal|0
operator|&&
name|int_value
operator|<
literal|256
condition|)
name|low_range
operator|=
name|int_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  high range  */
if|if
condition|(
name|success
condition|)
block|{
name|int_value
operator|=
name|args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
if|if
condition|(
name|int_value
operator|>=
literal|0
operator|&&
name|int_value
operator|<
literal|256
condition|)
name|high_range
operator|=
name|int_value
expr_stmt|;
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  arrange to calculate the histogram  */
if|if
condition|(
name|success
condition|)
block|{
name|htd
operator|.
name|shell
operator|=
name|NULL
expr_stmt|;
name|htd
operator|.
name|channel
operator|=
name|channel
expr_stmt|;
name|htd
operator|.
name|drawable
operator|=
name|drawable
expr_stmt|;
name|htd
operator|.
name|color
operator|=
name|drawable_color
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|htd
operator|.
name|histogram
operator|=
name|histogram_create
argument_list|(
name|HISTOGRAM_WIDTH
argument_list|,
name|HISTOGRAM_HEIGHT
argument_list|,
name|histogram_tool_histogram_range
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|htd
argument_list|)
expr_stmt|;
comment|/*  The information collection should occur only within selection bounds  */
name|no_mask
operator|=
operator|(
name|drawable_mask_bounds
argument_list|(
name|drawable
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|)
operator|==
name|FALSE
operator|)
expr_stmt|;
name|drawable_offsets
argument_list|(
name|drawable
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
comment|/*  Configure the src from the drawable data  */
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  Configure the mask from the gimage's selection mask  */
name|mask
operator|=
name|gimage_get_mask
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|maskPR
argument_list|,
name|drawable_data
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|mask
argument_list|)
argument_list|)
argument_list|,
name|x1
operator|+
name|off_x
argument_list|,
name|y1
operator|+
name|off_y
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  Apply the image transformation to the pixels  */
if|if
condition|(
name|no_mask
condition|)
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|1
argument_list|,
operator|&
name|srcPR
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
name|histogram_tool_histogram_info
argument_list|(
operator|&
name|srcPR
argument_list|,
name|NULL
argument_list|,
operator|*
operator|(
name|histogram_values
argument_list|(
name|htd
operator|.
name|histogram
argument_list|)
operator|)
argument_list|,
operator|&
name|htd
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|2
argument_list|,
operator|&
name|srcPR
argument_list|,
operator|&
name|maskPR
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
name|histogram_tool_histogram_info
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|maskPR
argument_list|,
operator|*
operator|(
name|histogram_values
argument_list|(
name|htd
operator|.
name|histogram
argument_list|)
operator|)
argument_list|,
operator|&
name|htd
argument_list|)
expr_stmt|;
comment|/*  calculate the statistics  */
name|histogram_tool_histogram_range
argument_list|(
name|low_range
argument_list|,
name|high_range
argument_list|,
operator|*
operator|(
name|histogram_values
argument_list|(
name|htd
operator|.
name|histogram
argument_list|)
operator|)
argument_list|,
operator|&
name|htd
argument_list|)
expr_stmt|;
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|histogram_proc
argument_list|,
name|success
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_float
operator|=
name|htd
operator|.
name|mean
expr_stmt|;
name|return_args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_float
operator|=
name|htd
operator|.
name|std_dev
expr_stmt|;
name|return_args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_float
operator|=
name|htd
operator|.
name|median
expr_stmt|;
name|return_args
index|[
literal|4
index|]
operator|.
name|value
operator|.
name|pdb_float
operator|=
name|htd
operator|.
name|pixels
expr_stmt|;
name|return_args
index|[
literal|5
index|]
operator|.
name|value
operator|.
name|pdb_float
operator|=
name|htd
operator|.
name|count
expr_stmt|;
name|return_args
index|[
literal|6
index|]
operator|.
name|value
operator|.
name|pdb_float
operator|=
name|htd
operator|.
name|percentile
expr_stmt|;
block|}
else|else
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|histogram_proc
argument_list|,
name|success
argument_list|)
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

end_unit

