begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<gegl.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"tools-types.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpboundary.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpchannel.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp-transform-utils.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpdrawable-transform.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp-utils.h"
end_include

begin_include
include|#
directive|include
file|"vectors/gimpvectors.h"
end_include

begin_include
include|#
directive|include
file|"vectors/gimpstroke.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimphelp-ids.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpcanvasgroup.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplay.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell-transform.h"
end_include

begin_include
include|#
directive|include
file|"gimpunifiedtransformtool.h"
end_include

begin_include
include|#
directive|include
file|"gimptoolcontrol.h"
end_include

begin_include
include|#
directive|include
file|"gimptransformoptions.h"
end_include

begin_include
include|#
directive|include
file|"gimp-intl.h"
end_include

begin_comment
comment|/*  index into trans_info array  */
end_comment

begin_enum
enum|enum
DECL|enum|__anon2bcf432e0103
block|{
DECL|enumerator|X0
name|X0
block|,
DECL|enumerator|Y0
name|Y0
block|,
DECL|enumerator|X1
name|X1
block|,
DECL|enumerator|Y1
name|Y1
block|,
DECL|enumerator|X2
name|X2
block|,
DECL|enumerator|Y2
name|Y2
block|,
DECL|enumerator|X3
name|X3
block|,
DECL|enumerator|Y3
name|Y3
block|,
DECL|enumerator|PIVOT_X
name|PIVOT_X
block|,
DECL|enumerator|PIVOT_Y
name|PIVOT_Y
block|, }
enum|;
end_enum

begin_comment
comment|/*  local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|void
name|gimp_transform_tool_oper_update
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
specifier|const
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|gboolean
name|proximity
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_unified_transform_tool_draw
parameter_list|(
name|GimpDrawTool
modifier|*
name|draw_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_unified_transform_tool_dialog
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_unified_transform_tool_dialog_update
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_unified_transform_tool_prepare
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_unified_transform_tool_motion
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_unified_transform_tool_recalc_matrix
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gchar
modifier|*
name|gimp_unified_transform_tool_get_undo_desc
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
function_decl|;
end_function_decl

begin_macro
DECL|function|G_DEFINE_TYPE (GimpUnifiedTransformTool,gimp_unified_transform_tool,GIMP_TYPE_TRANSFORM_TOOL)
name|G_DEFINE_TYPE
argument_list|(
argument|GimpUnifiedTransformTool
argument_list|,
argument|gimp_unified_transform_tool
argument_list|,
argument|GIMP_TYPE_TRANSFORM_TOOL
argument_list|)
end_macro

begin_function
name|void
name|gimp_unified_transform_tool_register
parameter_list|(
name|GimpToolRegisterCallback
name|callback
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
call|(
modifier|*
name|callback
call|)
argument_list|(
name|GIMP_TYPE_UNIFIED_TRANSFORM_TOOL
argument_list|,
name|GIMP_TYPE_TRANSFORM_OPTIONS
argument_list|,
name|gimp_transform_options_gui
argument_list|,
name|GIMP_CONTEXT_BACKGROUND_MASK
argument_list|,
literal|"gimp-unified-transform-tool"
argument_list|,
name|_
argument_list|(
literal|"Unified Transform"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Unified Transform Tool: "
literal|"Transform the layer, selection or path"
argument_list|)
argument_list|,
name|N_
argument_list|(
literal|"_Unified Transform"
argument_list|)
argument_list|,
literal|"<shift>L"
argument_list|,
name|NULL
argument_list|,
name|GIMP_HELP_TOOL_UNIFIED_TRANSFORM
argument_list|,
name|GIMP_STOCK_TOOL_UNIFIED_TRANSFORM
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_unified_transform_tool_class_init (GimpUnifiedTransformToolClass * klass)
name|gimp_unified_transform_tool_class_init
parameter_list|(
name|GimpUnifiedTransformToolClass
modifier|*
name|klass
parameter_list|)
block|{
name|GimpTransformToolClass
modifier|*
name|trans_class
init|=
name|GIMP_TRANSFORM_TOOL_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|GimpToolClass
modifier|*
name|tool_class
init|=
name|GIMP_TOOL_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|GimpDrawToolClass
modifier|*
name|draw_class
init|=
name|GIMP_DRAW_TOOL_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|trans_class
operator|->
name|dialog
operator|=
name|gimp_unified_transform_tool_dialog
expr_stmt|;
name|trans_class
operator|->
name|dialog_update
operator|=
name|gimp_unified_transform_tool_dialog_update
expr_stmt|;
name|trans_class
operator|->
name|prepare
operator|=
name|gimp_unified_transform_tool_prepare
expr_stmt|;
name|trans_class
operator|->
name|motion
operator|=
name|gimp_unified_transform_tool_motion
expr_stmt|;
name|trans_class
operator|->
name|recalc_matrix
operator|=
name|gimp_unified_transform_tool_recalc_matrix
expr_stmt|;
name|trans_class
operator|->
name|get_undo_desc
operator|=
name|gimp_unified_transform_tool_get_undo_desc
expr_stmt|;
name|tool_class
operator|->
name|oper_update
operator|=
name|gimp_transform_tool_oper_update
expr_stmt|;
name|draw_class
operator|->
name|draw
operator|=
name|gimp_unified_transform_tool_draw
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_unified_transform_tool_init (GimpUnifiedTransformTool * unified_tool)
name|gimp_unified_transform_tool_init
parameter_list|(
name|GimpUnifiedTransformTool
modifier|*
name|unified_tool
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
init|=
name|GIMP_TOOL
argument_list|(
name|unified_tool
argument_list|)
decl_stmt|;
name|GimpTransformTool
modifier|*
name|tr_tool
init|=
name|GIMP_TRANSFORM_TOOL
argument_list|(
name|unified_tool
argument_list|)
decl_stmt|;
name|gimp_tool_control_set_tool_cursor
argument_list|(
name|tool
operator|->
name|control
argument_list|,
name|GIMP_TOOL_CURSOR_UNIFIED_TRANSFORM
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|progress_text
operator|=
name|_
argument_list|(
literal|"Unified transform"
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|use_grid
operator|=
name|TRUE
expr_stmt|;
name|tr_tool
operator|->
name|use_handles
operator|=
name|TRUE
expr_stmt|;
name|tr_tool
operator|->
name|use_center
operator|=
name|TRUE
expr_stmt|;
name|tr_tool
operator|->
name|use_mid_handles
operator|=
name|TRUE
expr_stmt|;
name|tr_tool
operator|->
name|use_pivot
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_comment
comment|/*hack*/
end_comment

begin_function
specifier|static
name|void
DECL|function|gimp_transform_tool_set_function (GimpTransformTool * tr_tool,TransformAction function)
name|gimp_transform_tool_set_function
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|,
name|TransformAction
name|function
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
init|=
name|GIMP_TOOL
argument_list|(
name|tr_tool
argument_list|)
decl_stmt|;
if|if
condition|(
name|function
operator|!=
name|tr_tool
operator|->
name|function
condition|)
block|{
if|if
condition|(
name|tr_tool
operator|->
name|handles
index|[
name|tr_tool
operator|->
name|function
index|]
operator|&&
name|gimp_draw_tool_is_active
argument_list|(
name|GIMP_DRAW_TOOL
argument_list|(
name|tr_tool
argument_list|)
argument_list|)
condition|)
block|{
name|gimp_canvas_item_set_highlight
argument_list|(
name|tr_tool
operator|->
name|handles
index|[
name|tr_tool
operator|->
name|function
index|]
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_tool_pop_status
argument_list|(
name|tool
argument_list|,
name|tool
operator|->
name|display
argument_list|)
expr_stmt|;
block|}
name|tr_tool
operator|->
name|function
operator|=
name|function
expr_stmt|;
if|if
condition|(
name|tr_tool
operator|->
name|handles
index|[
name|tr_tool
operator|->
name|function
index|]
operator|&&
name|gimp_draw_tool_is_active
argument_list|(
name|GIMP_DRAW_TOOL
argument_list|(
name|tr_tool
argument_list|)
argument_list|)
condition|)
block|{
name|gimp_canvas_item_set_highlight
argument_list|(
name|tr_tool
operator|->
name|handles
index|[
name|tr_tool
operator|->
name|function
index|]
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_tool_push_status
argument_list|(
name|tool
argument_list|,
name|tool
operator|->
name|display
argument_list|,
literal|"%i"
argument_list|,
name|tr_tool
operator|->
name|function
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_transform_tool_oper_update (GimpTool * tool,const GimpCoords * coords,GdkModifierType state,gboolean proximity,GimpDisplay * display)
name|gimp_transform_tool_oper_update
parameter_list|(
name|GimpTool
modifier|*
name|tool
parameter_list|,
specifier|const
name|GimpCoords
modifier|*
name|coords
parameter_list|,
name|GdkModifierType
name|state
parameter_list|,
name|gboolean
name|proximity
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
block|{
name|GimpTransformTool
modifier|*
name|tr_tool
init|=
name|GIMP_TRANSFORM_TOOL
argument_list|(
name|tool
argument_list|)
decl_stmt|;
name|GimpDrawTool
modifier|*
name|draw_tool
init|=
name|GIMP_DRAW_TOOL
argument_list|(
name|tool
argument_list|)
decl_stmt|;
name|TransformAction
name|function
init|=
name|TRANSFORM_HANDLE_NONE
decl_stmt|;
name|TransformAction
name|i
decl_stmt|;
if|if
condition|(
name|display
operator|!=
name|tool
operator|->
name|display
operator|||
name|draw_tool
operator|->
name|item
operator|==
name|NULL
condition|)
block|{
name|gimp_transform_tool_set_function
argument_list|(
name|tr_tool
argument_list|,
name|TRANSFORM_HANDLE_NONE
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
name|TRANSFORM_HANDLE_NONE
operator|+
literal|1
init|;
name|i
operator|<
name|TRANSFORM_HANDLE_NUM
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|gimp_canvas_item_hit
argument_list|(
name|tr_tool
operator|->
name|handles
index|[
name|i
index|]
argument_list|,
name|coords
operator|->
name|x
argument_list|,
name|coords
operator|->
name|y
argument_list|)
condition|)
block|{
name|function
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
name|gimp_transform_tool_set_function
argument_list|(
name|tr_tool
argument_list|,
name|function
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* hack */
end_comment

begin_function
specifier|static
name|void
DECL|function|gimp_transform_tool_handles_recalc (GimpTransformTool * tr_tool,GimpDisplay * display,gint * handle_w,gint * handle_h)
name|gimp_transform_tool_handles_recalc
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|,
name|gint
modifier|*
name|handle_w
parameter_list|,
name|gint
modifier|*
name|handle_h
parameter_list|)
block|{
name|gint
name|dx1
decl_stmt|,
name|dy1
decl_stmt|;
name|gint
name|dx2
decl_stmt|,
name|dy2
decl_stmt|;
name|gint
name|dx3
decl_stmt|,
name|dy3
decl_stmt|;
name|gint
name|dx4
decl_stmt|,
name|dy4
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|;
name|gint
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gimp_display_shell_transform_xy
argument_list|(
name|gimp_display_get_shell
argument_list|(
name|display
argument_list|)
argument_list|,
name|tr_tool
operator|->
name|tx1
argument_list|,
name|tr_tool
operator|->
name|ty1
argument_list|,
operator|&
name|dx1
argument_list|,
operator|&
name|dy1
argument_list|)
expr_stmt|;
name|gimp_display_shell_transform_xy
argument_list|(
name|gimp_display_get_shell
argument_list|(
name|display
argument_list|)
argument_list|,
name|tr_tool
operator|->
name|tx2
argument_list|,
name|tr_tool
operator|->
name|ty2
argument_list|,
operator|&
name|dx2
argument_list|,
operator|&
name|dy2
argument_list|)
expr_stmt|;
name|gimp_display_shell_transform_xy
argument_list|(
name|gimp_display_get_shell
argument_list|(
name|display
argument_list|)
argument_list|,
name|tr_tool
operator|->
name|tx3
argument_list|,
name|tr_tool
operator|->
name|ty3
argument_list|,
operator|&
name|dx3
argument_list|,
operator|&
name|dy3
argument_list|)
expr_stmt|;
name|gimp_display_shell_transform_xy
argument_list|(
name|gimp_display_get_shell
argument_list|(
name|display
argument_list|)
argument_list|,
name|tr_tool
operator|->
name|tx4
argument_list|,
name|tr_tool
operator|->
name|ty4
argument_list|,
operator|&
name|dx4
argument_list|,
operator|&
name|dy4
argument_list|)
expr_stmt|;
name|x1
operator|=
name|MIN4
argument_list|(
name|dx1
argument_list|,
name|dx2
argument_list|,
name|dx3
argument_list|,
name|dx4
argument_list|)
expr_stmt|;
name|y1
operator|=
name|MIN4
argument_list|(
name|dy1
argument_list|,
name|dy2
argument_list|,
name|dy3
argument_list|,
name|dy4
argument_list|)
expr_stmt|;
name|x2
operator|=
name|MAX4
argument_list|(
name|dx1
argument_list|,
name|dx2
argument_list|,
name|dx3
argument_list|,
name|dx4
argument_list|)
expr_stmt|;
name|y2
operator|=
name|MAX4
argument_list|(
name|dy1
argument_list|,
name|dy2
argument_list|,
name|dy3
argument_list|,
name|dy4
argument_list|)
expr_stmt|;
operator|*
name|handle_w
operator|=
name|CLAMP
argument_list|(
operator|(
name|x2
operator|-
name|x1
operator|)
operator|/
literal|3
argument_list|,
literal|6
argument_list|,
name|GIMP_TOOL_HANDLE_SIZE_LARGE
argument_list|)
expr_stmt|;
operator|*
name|handle_h
operator|=
name|CLAMP
argument_list|(
operator|(
name|y2
operator|-
name|y1
operator|)
operator|/
literal|3
argument_list|,
literal|6
argument_list|,
name|GIMP_TOOL_HANDLE_SIZE_LARGE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_unified_transform_tool_draw (GimpDrawTool * draw_tool)
name|gimp_unified_transform_tool_draw
parameter_list|(
name|GimpDrawTool
modifier|*
name|draw_tool
parameter_list|)
block|{
name|GimpTool
modifier|*
name|tool
init|=
name|GIMP_TOOL
argument_list|(
name|draw_tool
argument_list|)
decl_stmt|;
name|GimpTransformTool
modifier|*
name|tr_tool
init|=
name|GIMP_TRANSFORM_TOOL
argument_list|(
name|draw_tool
argument_list|)
decl_stmt|;
name|GimpTransformOptions
modifier|*
name|options
init|=
name|GIMP_TRANSFORM_TOOL_GET_OPTIONS
argument_list|(
name|tool
argument_list|)
decl_stmt|;
name|GimpImage
modifier|*
name|image
init|=
name|gimp_display_get_image
argument_list|(
name|tool
operator|->
name|display
argument_list|)
decl_stmt|;
name|GimpCanvasGroup
modifier|*
name|stroke_group
decl_stmt|;
name|gint
name|handle_w
decl_stmt|,
name|handle_h
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|d
decl_stmt|;
name|gdouble
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|G_N_ELEMENTS
argument_list|(
name|tr_tool
operator|->
name|handles
argument_list|)
condition|;
name|i
operator|++
control|)
name|tr_tool
operator|->
name|handles
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|tr_tool
operator|->
name|use_grid
condition|)
block|{
if|if
condition|(
name|gimp_transform_options_show_preview
argument_list|(
name|options
argument_list|)
condition|)
block|{
name|gimp_draw_tool_add_transform_preview
argument_list|(
name|draw_tool
argument_list|,
name|tool
operator|->
name|drawable
argument_list|,
operator|&
name|tr_tool
operator|->
name|transform
argument_list|,
name|tr_tool
operator|->
name|x1
argument_list|,
name|tr_tool
operator|->
name|y1
argument_list|,
name|tr_tool
operator|->
name|x2
argument_list|,
name|tr_tool
operator|->
name|y2
argument_list|,
name|TRUE
argument_list|,
name|options
operator|->
name|preview_opacity
argument_list|)
expr_stmt|;
block|}
name|gimp_draw_tool_add_transform_guides
argument_list|(
name|draw_tool
argument_list|,
operator|&
name|tr_tool
operator|->
name|transform
argument_list|,
name|options
operator|->
name|grid_type
argument_list|,
name|options
operator|->
name|grid_size
argument_list|,
name|tr_tool
operator|->
name|x1
argument_list|,
name|tr_tool
operator|->
name|y1
argument_list|,
name|tr_tool
operator|->
name|x2
argument_list|,
name|tr_tool
operator|->
name|y2
argument_list|)
expr_stmt|;
block|}
name|gimp_transform_tool_handles_recalc
argument_list|(
name|tr_tool
argument_list|,
name|tool
operator|->
name|display
argument_list|,
operator|&
name|handle_w
argument_list|,
operator|&
name|handle_h
argument_list|)
expr_stmt|;
comment|/*  draw the scale handles  */
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_NW
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tx1
argument_list|,
name|tr_tool
operator|->
name|ty1
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_NORTH_WEST
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_NE
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tx2
argument_list|,
name|tr_tool
operator|->
name|ty2
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_NORTH_EAST
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_SW
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tx3
argument_list|,
name|tr_tool
operator|->
name|ty3
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_SOUTH_WEST
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_SE
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tx4
argument_list|,
name|tr_tool
operator|->
name|ty4
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_SOUTH_EAST
argument_list|)
expr_stmt|;
comment|/*  draw the perspective handles  */
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_NW_P
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tx1
argument_list|,
name|tr_tool
operator|->
name|ty1
argument_list|,
name|handle_w
operator|/
literal|4
operator|*
literal|3
argument_list|,
name|handle_h
operator|/
literal|4
operator|*
literal|3
argument_list|,
name|GIMP_HANDLE_ANCHOR_SOUTH_EAST
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_NE_P
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tx2
argument_list|,
name|tr_tool
operator|->
name|ty2
argument_list|,
name|handle_w
operator|/
literal|4
operator|*
literal|3
argument_list|,
name|handle_h
operator|/
literal|4
operator|*
literal|3
argument_list|,
name|GIMP_HANDLE_ANCHOR_SOUTH_WEST
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_SW_P
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tx3
argument_list|,
name|tr_tool
operator|->
name|ty3
argument_list|,
name|handle_w
operator|/
literal|4
operator|*
literal|3
argument_list|,
name|handle_h
operator|/
literal|4
operator|*
literal|3
argument_list|,
name|GIMP_HANDLE_ANCHOR_NORTH_EAST
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_SE_P
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tx4
argument_list|,
name|tr_tool
operator|->
name|ty4
argument_list|,
name|handle_w
operator|/
literal|4
operator|*
literal|3
argument_list|,
name|handle_h
operator|/
literal|4
operator|*
literal|3
argument_list|,
name|GIMP_HANDLE_ANCHOR_NORTH_WEST
argument_list|)
expr_stmt|;
comment|/*  draw the side handles  */
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx1
operator|+
name|tr_tool
operator|->
name|tx2
operator|)
operator|/
literal|2.0
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty1
operator|+
name|tr_tool
operator|->
name|ty2
operator|)
operator|/
literal|2.0
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_N
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx2
operator|+
name|tr_tool
operator|->
name|tx4
operator|)
operator|/
literal|2.0
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty2
operator|+
name|tr_tool
operator|->
name|ty4
operator|)
operator|/
literal|2.0
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_E
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx3
operator|+
name|tr_tool
operator|->
name|tx4
operator|)
operator|/
literal|2.0
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty3
operator|+
name|tr_tool
operator|->
name|ty4
operator|)
operator|/
literal|2.0
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_S
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx3
operator|+
name|tr_tool
operator|->
name|tx1
operator|)
operator|/
literal|2.0
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty3
operator|+
name|tr_tool
operator|->
name|ty1
operator|)
operator|/
literal|2.0
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_W
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
comment|/*  draw the shear handles  */
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx1
operator|*
literal|2
operator|+
name|tr_tool
operator|->
name|tx2
operator|*
literal|3
operator|)
operator|/
literal|5
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty1
operator|*
literal|2
operator|+
name|tr_tool
operator|->
name|ty2
operator|*
literal|3
operator|)
operator|/
literal|5
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_N_S
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_FILLED_DIAMOND
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx2
operator|*
literal|2
operator|+
name|tr_tool
operator|->
name|tx4
operator|*
literal|3
operator|)
operator|/
literal|5
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty2
operator|*
literal|2
operator|+
name|tr_tool
operator|->
name|ty4
operator|*
literal|3
operator|)
operator|/
literal|5
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_E_S
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_FILLED_DIAMOND
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx3
operator|*
literal|3
operator|+
name|tr_tool
operator|->
name|tx4
operator|*
literal|2
operator|)
operator|/
literal|5
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty3
operator|*
literal|3
operator|+
name|tr_tool
operator|->
name|ty4
operator|*
literal|2
operator|)
operator|/
literal|5
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_S_S
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_FILLED_DIAMOND
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx3
operator|*
literal|3
operator|+
name|tr_tool
operator|->
name|tx1
operator|*
literal|2
operator|)
operator|/
literal|5
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty3
operator|*
literal|3
operator|+
name|tr_tool
operator|->
name|ty1
operator|*
literal|2
operator|)
operator|/
literal|5
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_W_S
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_FILLED_DIAMOND
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
comment|/*  draw the rotation handle  */
name|x
operator|=
operator|(
name|tr_tool
operator|->
name|tx1
operator|*
literal|3
operator|+
name|tr_tool
operator|->
name|tx2
operator|*
literal|2
operator|)
operator|/
literal|5
expr_stmt|;
name|y
operator|=
operator|(
name|tr_tool
operator|->
name|ty1
operator|*
literal|3
operator|+
name|tr_tool
operator|->
name|ty2
operator|*
literal|2
operator|)
operator|/
literal|5
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_ROTATION
index|]
operator|=
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_FILLED_CIRCLE
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|handle_w
argument_list|,
name|handle_h
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
comment|/*  draw the rotation center axis handle  */
name|d
operator|=
name|MIN
argument_list|(
name|handle_w
argument_list|,
name|handle_h
argument_list|)
operator|*
literal|2
expr_stmt|;
comment|/* so you can grab it from under the center handle */
name|stroke_group
operator|=
name|gimp_draw_tool_add_stroke_group
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_PIVOT
index|]
operator|=
name|GIMP_CANVAS_ITEM
argument_list|(
name|stroke_group
argument_list|)
expr_stmt|;
name|gimp_draw_tool_push_group
argument_list|(
name|draw_tool
argument_list|,
name|stroke_group
argument_list|)
expr_stmt|;
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_SQUARE
argument_list|,
name|tr_tool
operator|->
name|tpx
argument_list|,
name|tr_tool
operator|->
name|tpy
argument_list|,
name|d
argument_list|,
name|d
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_CROSS
argument_list|,
name|tr_tool
operator|->
name|tpx
argument_list|,
name|tr_tool
operator|->
name|tpy
argument_list|,
name|d
argument_list|,
name|d
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|gimp_draw_tool_pop_group
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
comment|/*  draw the move handle  */
name|d
operator|=
name|MIN
argument_list|(
name|handle_w
argument_list|,
name|handle_h
argument_list|)
expr_stmt|;
name|stroke_group
operator|=
name|gimp_draw_tool_add_stroke_group
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
name|tr_tool
operator|->
name|handles
index|[
name|TRANSFORM_HANDLE_CENTER
index|]
operator|=
name|GIMP_CANVAS_ITEM
argument_list|(
name|stroke_group
argument_list|)
expr_stmt|;
name|gimp_draw_tool_push_group
argument_list|(
name|draw_tool
argument_list|,
name|stroke_group
argument_list|)
expr_stmt|;
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_CIRCLE
argument_list|,
name|tr_tool
operator|->
name|tcx
argument_list|,
name|tr_tool
operator|->
name|tcy
argument_list|,
name|d
argument_list|,
name|d
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
name|gimp_draw_tool_add_handle
argument_list|(
name|draw_tool
argument_list|,
name|GIMP_HANDLE_CROSS
argument_list|,
name|tr_tool
operator|->
name|tcx
argument_list|,
name|tr_tool
operator|->
name|tcy
argument_list|,
name|d
argument_list|,
name|d
argument_list|,
name|GIMP_HANDLE_ANCHOR_CENTER
argument_list|)
expr_stmt|;
comment|/* draw an item at 40,80 in screen coordinates */
comment|//gint x, y;
comment|//gimp_display_shell_untransform_xy (gimp_display_get_shell (tool->display),
comment|//                                 40, 80,&x,&y, TRUE);
comment|//gimp_draw_tool_add_handle (draw_tool,
comment|//                           GIMP_HANDLE_SQUARE,
comment|//                           x, y,
comment|//                           5, 5,
comment|//                           GIMP_HANDLE_ANCHOR_CENTER);
name|gimp_draw_tool_pop_group
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
if|if
condition|(
name|tr_tool
operator|->
name|handles
index|[
name|tr_tool
operator|->
name|function
index|]
condition|)
block|{
name|gimp_canvas_item_set_highlight
argument_list|(
name|tr_tool
operator|->
name|handles
index|[
name|tr_tool
operator|->
name|function
index|]
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
comment|/* the rest of the function is the same as in the parent class */
if|if
condition|(
name|options
operator|->
name|type
operator|==
name|GIMP_TRANSFORM_TYPE_SELECTION
condition|)
block|{
name|GimpMatrix3
name|matrix
init|=
name|tr_tool
operator|->
name|transform
decl_stmt|;
specifier|const
name|GimpBoundSeg
modifier|*
name|orig_in
decl_stmt|;
specifier|const
name|GimpBoundSeg
modifier|*
name|orig_out
decl_stmt|;
name|GimpBoundSeg
modifier|*
name|segs_in
decl_stmt|;
name|GimpBoundSeg
modifier|*
name|segs_out
decl_stmt|;
name|gint
name|num_segs_in
decl_stmt|;
name|gint
name|num_segs_out
decl_stmt|;
name|gimp_channel_boundary
argument_list|(
name|gimp_image_get_mask
argument_list|(
name|image
argument_list|)
argument_list|,
operator|&
name|orig_in
argument_list|,
operator|&
name|orig_out
argument_list|,
operator|&
name|num_segs_in
argument_list|,
operator|&
name|num_segs_out
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|segs_in
operator|=
name|g_memdup
argument_list|(
name|orig_in
argument_list|,
name|num_segs_in
operator|*
sizeof|sizeof
argument_list|(
name|GimpBoundSeg
argument_list|)
argument_list|)
expr_stmt|;
name|segs_out
operator|=
name|g_memdup
argument_list|(
name|orig_out
argument_list|,
name|num_segs_out
operator|*
sizeof|sizeof
argument_list|(
name|GimpBoundSeg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|segs_in
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_segs_in
condition|;
name|i
operator|++
control|)
block|{
name|gdouble
name|tx
decl_stmt|,
name|ty
decl_stmt|;
name|gimp_matrix3_transform_point
argument_list|(
operator|&
name|matrix
argument_list|,
name|segs_in
index|[
name|i
index|]
operator|.
name|x1
argument_list|,
name|segs_in
index|[
name|i
index|]
operator|.
name|y1
argument_list|,
operator|&
name|tx
argument_list|,
operator|&
name|ty
argument_list|)
expr_stmt|;
name|segs_in
index|[
name|i
index|]
operator|.
name|x1
operator|=
name|RINT
argument_list|(
name|tx
argument_list|)
expr_stmt|;
name|segs_in
index|[
name|i
index|]
operator|.
name|y1
operator|=
name|RINT
argument_list|(
name|ty
argument_list|)
expr_stmt|;
name|gimp_matrix3_transform_point
argument_list|(
operator|&
name|matrix
argument_list|,
name|segs_in
index|[
name|i
index|]
operator|.
name|x2
argument_list|,
name|segs_in
index|[
name|i
index|]
operator|.
name|y2
argument_list|,
operator|&
name|tx
argument_list|,
operator|&
name|ty
argument_list|)
expr_stmt|;
name|segs_in
index|[
name|i
index|]
operator|.
name|x2
operator|=
name|RINT
argument_list|(
name|tx
argument_list|)
expr_stmt|;
name|segs_in
index|[
name|i
index|]
operator|.
name|y2
operator|=
name|RINT
argument_list|(
name|ty
argument_list|)
expr_stmt|;
block|}
name|gimp_draw_tool_add_boundary
argument_list|(
name|draw_tool
argument_list|,
name|segs_in
argument_list|,
name|num_segs_in
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|segs_in
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|segs_out
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_segs_out
condition|;
name|i
operator|++
control|)
block|{
name|gdouble
name|tx
decl_stmt|,
name|ty
decl_stmt|;
name|gimp_matrix3_transform_point
argument_list|(
operator|&
name|matrix
argument_list|,
name|segs_out
index|[
name|i
index|]
operator|.
name|x1
argument_list|,
name|segs_out
index|[
name|i
index|]
operator|.
name|y1
argument_list|,
operator|&
name|tx
argument_list|,
operator|&
name|ty
argument_list|)
expr_stmt|;
name|segs_out
index|[
name|i
index|]
operator|.
name|x1
operator|=
name|RINT
argument_list|(
name|tx
argument_list|)
expr_stmt|;
name|segs_out
index|[
name|i
index|]
operator|.
name|y1
operator|=
name|RINT
argument_list|(
name|ty
argument_list|)
expr_stmt|;
name|gimp_matrix3_transform_point
argument_list|(
operator|&
name|matrix
argument_list|,
name|segs_out
index|[
name|i
index|]
operator|.
name|x2
argument_list|,
name|segs_out
index|[
name|i
index|]
operator|.
name|y2
argument_list|,
operator|&
name|tx
argument_list|,
operator|&
name|ty
argument_list|)
expr_stmt|;
name|segs_out
index|[
name|i
index|]
operator|.
name|x2
operator|=
name|RINT
argument_list|(
name|tx
argument_list|)
expr_stmt|;
name|segs_out
index|[
name|i
index|]
operator|.
name|y2
operator|=
name|RINT
argument_list|(
name|ty
argument_list|)
expr_stmt|;
block|}
name|gimp_draw_tool_add_boundary
argument_list|(
name|draw_tool
argument_list|,
name|segs_out
argument_list|,
name|num_segs_out
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|segs_out
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|options
operator|->
name|type
operator|==
name|GIMP_TRANSFORM_TYPE_PATH
condition|)
block|{
name|GimpVectors
modifier|*
name|vectors
decl_stmt|;
name|GimpStroke
modifier|*
name|stroke
init|=
name|NULL
decl_stmt|;
name|GimpMatrix3
name|matrix
init|=
name|tr_tool
operator|->
name|transform
decl_stmt|;
name|vectors
operator|=
name|gimp_image_get_active_vectors
argument_list|(
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
name|vectors
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|direction
operator|==
name|GIMP_TRANSFORM_BACKWARD
condition|)
name|gimp_matrix3_invert
argument_list|(
operator|&
name|matrix
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|stroke
operator|=
name|gimp_vectors_stroke_get_next
argument_list|(
name|vectors
argument_list|,
name|stroke
argument_list|)
operator|)
condition|)
block|{
name|GArray
modifier|*
name|coords
decl_stmt|;
name|gboolean
name|closed
decl_stmt|;
name|coords
operator|=
name|gimp_stroke_interpolate
argument_list|(
name|stroke
argument_list|,
literal|1.0
argument_list|,
operator|&
name|closed
argument_list|)
expr_stmt|;
if|if
condition|(
name|coords
operator|&&
name|coords
operator|->
name|len
condition|)
block|{
name|gint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|coords
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|GimpCoords
modifier|*
name|curr
init|=
operator|&
name|g_array_index
argument_list|(
name|coords
argument_list|,
name|GimpCoords
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|gimp_matrix3_transform_point
argument_list|(
operator|&
name|matrix
argument_list|,
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|,
operator|&
name|curr
operator|->
name|x
argument_list|,
operator|&
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
name|gimp_draw_tool_add_strokes
argument_list|(
name|draw_tool
argument_list|,
operator|&
name|g_array_index
argument_list|(
name|coords
argument_list|,
name|GimpCoords
argument_list|,
literal|0
argument_list|)
argument_list|,
name|coords
operator|->
name|len
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|coords
condition|)
name|g_array_free
argument_list|(
name|coords
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_unified_transform_tool_dialog (GimpTransformTool * tr_tool)
name|gimp_unified_transform_tool_dialog
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
block|{
name|GimpUnifiedTransformTool
modifier|*
name|unified
init|=
name|GIMP_UNIFIED_TRANSFORM_TOOL
argument_list|(
name|tr_tool
argument_list|)
decl_stmt|;
name|GtkWidget
modifier|*
name|content_area
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|content_area
operator|=
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|tr_tool
operator|->
name|dialog
argument_list|)
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Transform Matrix"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|content_area
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
literal|3
condition|;
name|y
operator|++
control|)
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
literal|3
condition|;
name|x
operator|++
control|)
block|{
name|GtkWidget
modifier|*
name|label
init|=
name|gtk_label_new
argument_list|(
literal|" "
argument_list|)
decl_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_label_set_width_chars
argument_list|(
name|GTK_LABEL
argument_list|(
name|label
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
name|x
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
argument_list|,
name|y
operator|+
literal|1
argument_list|,
name|GTK_EXPAND
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|unified
operator|->
name|label
index|[
name|y
index|]
index|[
name|x
index|]
operator|=
name|label
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_unified_transform_tool_dialog_update (GimpTransformTool * tr_tool)
name|gimp_unified_transform_tool_dialog_update
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
block|{
name|GimpUnifiedTransformTool
modifier|*
name|unified
init|=
name|GIMP_UNIFIED_TRANSFORM_TOOL
argument_list|(
name|tr_tool
argument_list|)
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
literal|3
condition|;
name|y
operator|++
control|)
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
literal|3
condition|;
name|x
operator|++
control|)
block|{
name|gchar
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|g_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%10.5f"
argument_list|,
name|tr_tool
operator|->
name|transform
operator|.
name|coeff
index|[
name|y
index|]
index|[
name|x
index|]
argument_list|)
expr_stmt|;
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|unified
operator|->
name|label
index|[
name|y
index|]
index|[
name|x
index|]
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_unified_transform_tool_prepare (GimpTransformTool * tr_tool)
name|gimp_unified_transform_tool_prepare
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
block|{
name|tr_tool
operator|->
name|trans_info
index|[
name|PIVOT_X
index|]
operator|=
call|(
name|gdouble
call|)
argument_list|(
name|tr_tool
operator|->
name|x1
operator|+
name|tr_tool
operator|->
name|x2
argument_list|)
operator|/
literal|2.0
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|PIVOT_Y
index|]
operator|=
call|(
name|gdouble
call|)
argument_list|(
name|tr_tool
operator|->
name|y1
operator|+
name|tr_tool
operator|->
name|y2
argument_list|)
operator|/
literal|2.0
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|X0
index|]
operator|=
operator|(
name|gdouble
operator|)
name|tr_tool
operator|->
name|x1
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|Y0
index|]
operator|=
operator|(
name|gdouble
operator|)
name|tr_tool
operator|->
name|y1
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|X1
index|]
operator|=
operator|(
name|gdouble
operator|)
name|tr_tool
operator|->
name|x2
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|Y1
index|]
operator|=
operator|(
name|gdouble
operator|)
name|tr_tool
operator|->
name|y1
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|X2
index|]
operator|=
operator|(
name|gdouble
operator|)
name|tr_tool
operator|->
name|x1
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|Y2
index|]
operator|=
operator|(
name|gdouble
operator|)
name|tr_tool
operator|->
name|y2
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|X3
index|]
operator|=
operator|(
name|gdouble
operator|)
name|tr_tool
operator|->
name|x2
expr_stmt|;
name|tr_tool
operator|->
name|trans_info
index|[
name|Y3
index|]
operator|=
operator|(
name|gdouble
operator|)
name|tr_tool
operator|->
name|y2
expr_stmt|;
block|}
end_function

begin_function
DECL|function|dotprod (GimpVector2 a,GimpVector2 b)
specifier|static
specifier|inline
name|gdouble
name|dotprod
parameter_list|(
name|GimpVector2
name|a
parameter_list|,
name|GimpVector2
name|b
parameter_list|)
block|{
return|return
name|a
operator|.
name|x
operator|*
name|b
operator|.
name|x
operator|+
name|a
operator|.
name|y
operator|*
name|b
operator|.
name|y
return|;
block|}
end_function

begin_function
DECL|function|norm (GimpVector2 a)
specifier|static
specifier|inline
name|gdouble
name|norm
parameter_list|(
name|GimpVector2
name|a
parameter_list|)
block|{
return|return
name|sqrt
argument_list|(
name|dotprod
argument_list|(
name|a
argument_list|,
name|a
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|vectorsubtract (GimpVector2 a,GimpVector2 b)
specifier|static
specifier|inline
name|GimpVector2
name|vectorsubtract
parameter_list|(
name|GimpVector2
name|a
parameter_list|,
name|GimpVector2
name|b
parameter_list|)
block|{
name|GimpVector2
name|c
decl_stmt|;
name|c
operator|.
name|x
operator|=
name|a
operator|.
name|x
operator|-
name|b
operator|.
name|x
expr_stmt|;
name|c
operator|.
name|y
operator|=
name|a
operator|.
name|y
operator|-
name|b
operator|.
name|y
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

begin_function
DECL|function|vectoradd (GimpVector2 a,GimpVector2 b)
specifier|static
specifier|inline
name|GimpVector2
name|vectoradd
parameter_list|(
name|GimpVector2
name|a
parameter_list|,
name|GimpVector2
name|b
parameter_list|)
block|{
name|GimpVector2
name|c
decl_stmt|;
name|c
operator|.
name|x
operator|=
name|a
operator|.
name|x
operator|+
name|b
operator|.
name|x
expr_stmt|;
name|c
operator|.
name|y
operator|=
name|a
operator|.
name|y
operator|+
name|b
operator|.
name|y
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

begin_function
DECL|function|scalemult (GimpVector2 a,gdouble b)
specifier|static
specifier|inline
name|GimpVector2
name|scalemult
parameter_list|(
name|GimpVector2
name|a
parameter_list|,
name|gdouble
name|b
parameter_list|)
block|{
name|GimpVector2
name|c
decl_stmt|;
name|c
operator|.
name|x
operator|=
name|a
operator|.
name|x
operator|*
name|b
expr_stmt|;
name|c
operator|.
name|y
operator|=
name|a
operator|.
name|y
operator|*
name|b
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

begin_function
DECL|function|vectorproject (GimpVector2 a,GimpVector2 b)
specifier|static
specifier|inline
name|GimpVector2
name|vectorproject
parameter_list|(
name|GimpVector2
name|a
parameter_list|,
name|GimpVector2
name|b
parameter_list|)
block|{
return|return
name|scalemult
argument_list|(
name|b
argument_list|,
name|dotprod
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
operator|/
name|dotprod
argument_list|(
name|b
argument_list|,
name|b
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* finds the clockwise angle between the vectors given, 0-2Ï */
end_comment

begin_function
DECL|function|calcangle (GimpVector2 a,GimpVector2 b)
specifier|static
specifier|inline
name|gdouble
name|calcangle
parameter_list|(
name|GimpVector2
name|a
parameter_list|,
name|GimpVector2
name|b
parameter_list|)
block|{
name|gdouble
name|angle
decl_stmt|,
name|angle2
decl_stmt|,
name|length
init|=
name|norm
argument_list|(
name|a
argument_list|)
operator|*
name|norm
argument_list|(
name|b
argument_list|)
decl_stmt|;
name|angle
operator|=
name|acos
argument_list|(
name|dotprod
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
operator|/
name|length
argument_list|)
expr_stmt|;
name|angle2
operator|=
name|b
operator|.
name|y
expr_stmt|;
name|b
operator|.
name|y
operator|=
operator|-
name|b
operator|.
name|x
expr_stmt|;
name|b
operator|.
name|x
operator|=
name|angle2
expr_stmt|;
name|angle2
operator|=
name|acos
argument_list|(
name|dotprod
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
operator|/
name|length
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|angle2
operator|>
name|G_PI
operator|/
literal|2.
operator|)
condition|?
name|angle
else|:
literal|2
operator|*
name|G_PI
operator|-
name|angle
operator|)
return|;
block|}
end_function

begin_function
DECL|function|rotate2d (GimpVector2 p,gdouble angle)
specifier|static
specifier|inline
name|GimpVector2
name|rotate2d
parameter_list|(
name|GimpVector2
name|p
parameter_list|,
name|gdouble
name|angle
parameter_list|)
block|{
name|GimpVector2
name|ret
decl_stmt|;
name|ret
operator|.
name|x
operator|=
name|cos
argument_list|(
name|angle
argument_list|)
operator|*
name|p
operator|.
name|x
operator|-
name|sin
argument_list|(
name|angle
argument_list|)
operator|*
name|p
operator|.
name|y
expr_stmt|;
name|ret
operator|.
name|y
operator|=
name|sin
argument_list|(
name|angle
argument_list|)
operator|*
name|p
operator|.
name|x
operator|+
name|cos
argument_list|(
name|angle
argument_list|)
operator|*
name|p
operator|.
name|y
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
DECL|function|lineintersect (GimpVector2 p1,GimpVector2 p2,GimpVector2 q1,GimpVector2 q2)
specifier|static
specifier|inline
name|GimpVector2
name|lineintersect
parameter_list|(
name|GimpVector2
name|p1
parameter_list|,
name|GimpVector2
name|p2
parameter_list|,
name|GimpVector2
name|q1
parameter_list|,
name|GimpVector2
name|q2
parameter_list|)
block|{
name|gdouble
name|denom
decl_stmt|,
name|u
decl_stmt|;
name|GimpVector2
name|p
decl_stmt|;
name|denom
operator|=
operator|(
name|q2
operator|.
name|y
operator|-
name|q1
operator|.
name|y
operator|)
operator|*
operator|(
name|p2
operator|.
name|x
operator|-
name|p1
operator|.
name|x
operator|)
operator|-
operator|(
name|q2
operator|.
name|x
operator|-
name|q1
operator|.
name|x
operator|)
operator|*
operator|(
name|p2
operator|.
name|y
operator|-
name|p1
operator|.
name|y
operator|)
expr_stmt|;
if|if
condition|(
name|denom
operator|==
literal|0.0
condition|)
block|{
name|p
operator|.
name|x
operator|=
operator|(
name|p1
operator|.
name|x
operator|+
name|p2
operator|.
name|x
operator|+
name|q1
operator|.
name|x
operator|+
name|q2
operator|.
name|x
operator|)
operator|/
literal|4
expr_stmt|;
name|p
operator|.
name|y
operator|=
operator|(
name|p1
operator|.
name|y
operator|+
name|p2
operator|.
name|y
operator|+
name|q1
operator|.
name|y
operator|+
name|q2
operator|.
name|y
operator|)
operator|/
literal|4
expr_stmt|;
block|}
else|else
block|{
name|u
operator|=
operator|(
name|q2
operator|.
name|x
operator|-
name|q1
operator|.
name|x
operator|)
operator|*
operator|(
name|p1
operator|.
name|y
operator|-
name|q1
operator|.
name|y
operator|)
operator|-
operator|(
name|q2
operator|.
name|y
operator|-
name|q1
operator|.
name|y
operator|)
operator|*
operator|(
name|p1
operator|.
name|x
operator|-
name|q1
operator|.
name|x
operator|)
expr_stmt|;
name|u
operator|/=
name|denom
expr_stmt|;
name|p
operator|.
name|x
operator|=
name|p1
operator|.
name|x
operator|+
name|u
operator|*
operator|(
name|p2
operator|.
name|x
operator|-
name|p1
operator|.
name|x
operator|)
expr_stmt|;
name|p
operator|.
name|y
operator|=
name|p1
operator|.
name|y
operator|+
name|u
operator|*
operator|(
name|p2
operator|.
name|y
operator|-
name|p1
operator|.
name|y
operator|)
expr_stmt|;
block|}
return|return
name|p
return|;
block|}
end_function

begin_function
DECL|function|getpivotdelta (GimpTransformTool * tr_tool)
specifier|static
specifier|inline
name|GimpVector2
name|getpivotdelta
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
block|{
name|TransInfo
name|tr
decl_stmt|;
name|GimpMatrix3
name|transform_before
decl_stmt|,
name|transform_after
decl_stmt|;
name|GimpVector2
name|delta
decl_stmt|;
name|gimp_matrix3_identity
argument_list|(
operator|&
name|transform_before
argument_list|)
expr_stmt|;
name|gimp_matrix3_identity
argument_list|(
operator|&
name|transform_after
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tr
argument_list|,
name|tr_tool
operator|->
name|trans_info
argument_list|,
sizeof|sizeof
argument_list|(
name|TransInfo
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_transform_matrix_perspective
argument_list|(
operator|&
name|transform_after
argument_list|,
name|tr_tool
operator|->
name|x1
argument_list|,
name|tr_tool
operator|->
name|y1
argument_list|,
name|tr_tool
operator|->
name|x2
operator|-
name|tr_tool
operator|->
name|x1
argument_list|,
name|tr_tool
operator|->
name|y2
operator|-
name|tr_tool
operator|->
name|y1
argument_list|,
name|tr
index|[
name|X0
index|]
argument_list|,
name|tr
index|[
name|Y0
index|]
argument_list|,
name|tr
index|[
name|X1
index|]
argument_list|,
name|tr
index|[
name|Y1
index|]
argument_list|,
name|tr
index|[
name|X2
index|]
argument_list|,
name|tr
index|[
name|Y2
index|]
argument_list|,
name|tr
index|[
name|X3
index|]
argument_list|,
name|tr
index|[
name|Y3
index|]
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tr
argument_list|,
name|tr_tool
operator|->
name|prev_trans_info
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|TransInfo
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_transform_matrix_perspective
argument_list|(
operator|&
name|transform_before
argument_list|,
name|tr_tool
operator|->
name|x1
argument_list|,
name|tr_tool
operator|->
name|y1
argument_list|,
name|tr_tool
operator|->
name|x2
operator|-
name|tr_tool
operator|->
name|x1
argument_list|,
name|tr_tool
operator|->
name|y2
operator|-
name|tr_tool
operator|->
name|y1
argument_list|,
name|tr
index|[
name|X0
index|]
argument_list|,
name|tr
index|[
name|Y0
index|]
argument_list|,
name|tr
index|[
name|X1
index|]
argument_list|,
name|tr
index|[
name|Y1
index|]
argument_list|,
name|tr
index|[
name|X2
index|]
argument_list|,
name|tr
index|[
name|Y2
index|]
argument_list|,
name|tr
index|[
name|X3
index|]
argument_list|,
name|tr
index|[
name|Y3
index|]
argument_list|)
expr_stmt|;
name|gimp_matrix3_invert
argument_list|(
operator|&
name|transform_before
argument_list|)
expr_stmt|;
name|gimp_matrix3_mult
argument_list|(
operator|&
name|transform_after
argument_list|,
operator|&
name|transform_before
argument_list|)
expr_stmt|;
name|gimp_matrix3_transform_point
argument_list|(
operator|&
name|transform_before
argument_list|,
name|tr
index|[
name|PIVOT_X
index|]
argument_list|,
name|tr
index|[
name|PIVOT_Y
index|]
argument_list|,
operator|&
name|delta
operator|.
name|x
argument_list|,
operator|&
name|delta
operator|.
name|y
argument_list|)
expr_stmt|;
name|delta
operator|.
name|x
operator|-=
name|tr
index|[
name|PIVOT_X
index|]
expr_stmt|;
name|delta
operator|.
name|y
operator|-=
name|tr
index|[
name|PIVOT_Y
index|]
expr_stmt|;
return|return
name|delta
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_unified_transform_tool_motion (GimpTransformTool * transform_tool)
name|gimp_unified_transform_tool_motion
parameter_list|(
name|GimpTransformTool
modifier|*
name|transform_tool
parameter_list|)
block|{
name|gdouble
name|dx
init|=
name|transform_tool
operator|->
name|curx
operator|-
name|transform_tool
operator|->
name|mousex
decl_stmt|;
name|gdouble
name|dy
init|=
name|transform_tool
operator|->
name|cury
operator|-
name|transform_tool
operator|->
name|mousey
decl_stmt|;
name|gdouble
modifier|*
name|x
index|[
literal|4
index|]
decl_stmt|,
modifier|*
name|y
index|[
literal|4
index|]
decl_stmt|,
name|px
index|[
literal|5
index|]
decl_stmt|,
name|py
index|[
literal|5
index|]
decl_stmt|,
modifier|*
name|pivot_x
decl_stmt|,
modifier|*
name|pivot_y
decl_stmt|,
name|ppivot_x
decl_stmt|,
name|ppivot_y
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|GimpTransformOptions
modifier|*
name|options
init|=
name|GIMP_TRANSFORM_TOOL_GET_OPTIONS
argument_list|(
name|transform_tool
argument_list|)
decl_stmt|;
name|gboolean
name|constrain
init|=
name|options
operator|->
name|constrain
decl_stmt|;
name|gboolean
name|keepaspect
init|=
name|options
operator|->
name|keepaspect
decl_stmt|;
name|gboolean
name|frompivot
init|=
name|options
operator|->
name|frompivot
decl_stmt|;
name|gboolean
name|freeshear
init|=
name|options
operator|->
name|freeshear
decl_stmt|;
name|gboolean
name|cornersnap
init|=
name|options
operator|->
name|cornersnap
decl_stmt|;
name|gboolean
name|fixedpivot
init|=
name|options
operator|->
name|fixedpivot
decl_stmt|;
name|TransformAction
name|function
init|=
name|transform_tool
operator|->
name|function
decl_stmt|;
name|x
index|[
literal|0
index|]
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|X0
index|]
expr_stmt|;
name|x
index|[
literal|1
index|]
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|X1
index|]
expr_stmt|;
name|x
index|[
literal|2
index|]
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|X2
index|]
expr_stmt|;
name|x
index|[
literal|3
index|]
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|X3
index|]
expr_stmt|;
name|y
index|[
literal|0
index|]
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|Y0
index|]
expr_stmt|;
name|y
index|[
literal|1
index|]
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|Y1
index|]
expr_stmt|;
name|y
index|[
literal|2
index|]
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|Y2
index|]
expr_stmt|;
name|y
index|[
literal|3
index|]
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|Y3
index|]
expr_stmt|;
name|px
index|[
literal|0
index|]
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|X0
index|]
expr_stmt|;
name|px
index|[
literal|1
index|]
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|X1
index|]
expr_stmt|;
name|px
index|[
literal|2
index|]
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|X2
index|]
expr_stmt|;
name|px
index|[
literal|3
index|]
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|X3
index|]
expr_stmt|;
name|py
index|[
literal|0
index|]
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|Y0
index|]
expr_stmt|;
name|py
index|[
literal|1
index|]
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|Y1
index|]
expr_stmt|;
name|py
index|[
literal|2
index|]
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|Y2
index|]
expr_stmt|;
name|py
index|[
literal|3
index|]
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|Y3
index|]
expr_stmt|;
comment|/* put center point in this array too */
name|px
index|[
literal|4
index|]
operator|=
operator|(
name|px
index|[
literal|0
index|]
operator|+
name|px
index|[
literal|1
index|]
operator|+
name|px
index|[
literal|2
index|]
operator|+
name|px
index|[
literal|3
index|]
operator|)
operator|/
literal|4.
expr_stmt|;
name|py
index|[
literal|4
index|]
operator|=
operator|(
name|py
index|[
literal|0
index|]
operator|+
name|py
index|[
literal|1
index|]
operator|+
name|py
index|[
literal|2
index|]
operator|+
name|py
index|[
literal|3
index|]
operator|)
operator|/
literal|4.
expr_stmt|;
name|pivot_x
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|PIVOT_X
index|]
expr_stmt|;
name|pivot_y
operator|=
operator|&
name|transform_tool
operator|->
name|trans_info
index|[
name|PIVOT_Y
index|]
expr_stmt|;
name|ppivot_x
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|PIVOT_X
index|]
expr_stmt|;
name|ppivot_y
operator|=
operator|(
operator|*
name|transform_tool
operator|->
name|prev_trans_info
operator|)
index|[
name|PIVOT_Y
index|]
expr_stmt|;
comment|/* move */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_CENTER
condition|)
block|{
if|if
condition|(
name|constrain
condition|)
block|{
comment|/* snap to 45 degree vectors from starting point */
name|gdouble
name|angle
init|=
name|calcangle
argument_list|(
operator|(
name|GimpVector2
operator|)
block|{
literal|1.
block|,
literal|0.
block|}
argument_list|,
operator|(
name|GimpVector2
operator|)
block|{
name|dx
block|,
name|dy
block|}
argument_list|)
operator|/
operator|(
literal|2.
operator|*
name|G_PI
operator|)
decl_stmt|;
if|if
condition|(
name|angle
operator|<
literal|1.
operator|/
literal|16
operator|||
name|angle
operator|>
literal|15.
operator|/
literal|16
condition|)
name|dy
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|angle
operator|<
literal|3.
operator|/
literal|16
condition|)
name|dy
operator|=
operator|-
operator|(
name|dx
operator|=
name|sqrt
argument_list|(
name|dx
operator|*
name|dx
operator|+
name|dy
operator|*
name|dy
argument_list|)
operator|/
name|sqrt
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|angle
operator|<
literal|5.
operator|/
literal|16
condition|)
name|dx
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|angle
operator|<
literal|7.
operator|/
literal|16
condition|)
name|dx
operator|=
name|dy
operator|=
operator|-
name|sqrt
argument_list|(
name|dx
operator|*
name|dx
operator|+
name|dy
operator|*
name|dy
argument_list|)
operator|/
name|sqrt
argument_list|(
literal|2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|angle
operator|<
literal|9.
operator|/
literal|16
condition|)
name|dy
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|angle
operator|<
literal|11.
operator|/
literal|16
condition|)
name|dx
operator|=
operator|-
operator|(
name|dy
operator|=
name|sqrt
argument_list|(
name|dx
operator|*
name|dx
operator|+
name|dy
operator|*
name|dy
argument_list|)
operator|/
name|sqrt
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|angle
operator|<
literal|13.
operator|/
literal|16
condition|)
name|dx
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|angle
operator|<
literal|15.
operator|/
literal|16
condition|)
name|dx
operator|=
name|dy
operator|=
name|sqrt
argument_list|(
name|dx
operator|*
name|dx
operator|+
name|dy
operator|*
name|dy
argument_list|)
operator|/
name|sqrt
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|x
index|[
name|i
index|]
operator|=
name|px
index|[
name|i
index|]
operator|+
name|dx
expr_stmt|;
operator|*
name|y
index|[
name|i
index|]
operator|=
name|py
index|[
name|i
index|]
operator|+
name|dy
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fixedpivot
condition|)
block|{
operator|*
name|pivot_x
operator|=
name|ppivot_x
operator|+
name|dx
expr_stmt|;
operator|*
name|pivot_y
operator|=
name|ppivot_y
operator|+
name|dy
expr_stmt|;
name|fixedpivot
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
comment|/* rotate */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_ROTATION
condition|)
block|{
name|GimpVector2
name|m
init|=
block|{
operator|.
name|x
operator|=
name|transform_tool
operator|->
name|curx
block|,
operator|.
name|y
operator|=
name|transform_tool
operator|->
name|cury
block|}
decl_stmt|;
name|GimpVector2
name|p
init|=
block|{
operator|.
name|x
operator|=
name|transform_tool
operator|->
name|mousex
block|,
operator|.
name|y
operator|=
name|transform_tool
operator|->
name|mousey
block|}
decl_stmt|;
name|GimpVector2
name|c
init|=
block|{
operator|.
name|x
operator|=
name|ppivot_x
block|,
operator|.
name|y
operator|=
name|ppivot_y
block|}
decl_stmt|;
name|gdouble
name|angle
init|=
name|calcangle
argument_list|(
name|vectorsubtract
argument_list|(
name|m
argument_list|,
name|c
argument_list|)
argument_list|,
name|vectorsubtract
argument_list|(
name|p
argument_list|,
name|c
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|constrain
condition|)
block|{
comment|/* round to 15 degree multiple */
name|angle
operator|/=
literal|2
operator|*
name|G_PI
operator|/
literal|24.
expr_stmt|;
name|angle
operator|=
name|round
argument_list|(
name|angle
argument_list|)
expr_stmt|;
name|angle
operator|*=
literal|2
operator|*
name|G_PI
operator|/
literal|24.
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|.
name|x
operator|=
name|px
index|[
name|i
index|]
expr_stmt|;
name|p
operator|.
name|y
operator|=
name|py
index|[
name|i
index|]
expr_stmt|;
name|m
operator|=
name|vectoradd
argument_list|(
name|c
argument_list|,
name|rotate2d
argument_list|(
name|vectorsubtract
argument_list|(
name|p
argument_list|,
name|c
argument_list|)
argument_list|,
name|angle
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|x
index|[
name|i
index|]
operator|=
name|m
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|i
index|]
operator|=
name|m
operator|.
name|y
expr_stmt|;
block|}
name|fixedpivot
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* move rotation axis */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_PIVOT
condition|)
block|{
name|gint
name|screenx
decl_stmt|,
name|screeny
decl_stmt|;
if|if
condition|(
name|cornersnap
condition|)
block|{
comment|/* snap to corner points and center */
name|gint
name|closest
init|=
literal|0
decl_stmt|;
name|gdouble
name|closest_dist
init|=
name|G_MAXDOUBLE
decl_stmt|,
name|dist
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|dist
operator|=
name|norm
argument_list|(
name|vectorsubtract
argument_list|(
operator|(
name|GimpVector2
operator|)
block|{
name|transform_tool
operator|->
name|curx
block|,
name|transform_tool
operator|->
name|cury
block|}
argument_list|,
operator|(
name|GimpVector2
operator|)
block|{
name|px
index|[
name|i
index|]
block|,
name|py
index|[
name|i
index|]
block|}
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dist
operator|<
name|closest_dist
condition|)
block|{
name|closest_dist
operator|=
name|dist
expr_stmt|;
name|closest
operator|=
name|i
expr_stmt|;
block|}
block|}
if|if
condition|(
name|closest_dist
operator|*
name|gimp_display_get_shell
argument_list|(
name|GIMP_TOOL
argument_list|(
name|transform_tool
argument_list|)
operator|->
name|display
argument_list|)
operator|->
name|scale_x
operator|<
literal|50
condition|)
block|{
operator|*
name|pivot_x
operator|=
name|px
index|[
name|closest
index|]
expr_stmt|;
operator|*
name|pivot_y
operator|=
name|py
index|[
name|closest
index|]
expr_stmt|;
return|return;
block|}
block|}
operator|*
name|pivot_x
operator|=
name|ppivot_x
operator|+
name|dx
expr_stmt|;
operator|*
name|pivot_y
operator|=
name|ppivot_y
operator|+
name|dy
expr_stmt|;
name|fixedpivot
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* scaling via corner */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_NW
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_NE
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_SE
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_SW
condition|)
block|{
comment|/* Scaling through scale handles means translating one corner point,        * with all sides at constant angles. */
name|gint
name|this
decl_stmt|,
name|left
decl_stmt|,
name|right
decl_stmt|,
name|opposite
decl_stmt|;
comment|/* 0: northwest, 1: northeast, 2: southwest, 3: southeast */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_NW
condition|)
block|{
name|this
operator|=
literal|0
expr_stmt|;
name|left
operator|=
literal|1
expr_stmt|;
name|right
operator|=
literal|2
expr_stmt|;
name|opposite
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_NE
condition|)
block|{
name|this
operator|=
literal|1
expr_stmt|;
name|left
operator|=
literal|3
expr_stmt|;
name|right
operator|=
literal|0
expr_stmt|;
name|opposite
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_SW
condition|)
block|{
name|this
operator|=
literal|2
expr_stmt|;
name|left
operator|=
literal|0
expr_stmt|;
name|right
operator|=
literal|3
expr_stmt|;
name|opposite
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_SE
condition|)
block|{
name|this
operator|=
literal|3
expr_stmt|;
name|left
operator|=
literal|2
expr_stmt|;
name|right
operator|=
literal|1
expr_stmt|;
name|opposite
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|g_assert_not_reached
argument_list|()
expr_stmt|;
name|GimpVector2
name|lp
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|left
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|left
index|]
block|}
decl_stmt|,
name|rp
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|right
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|right
index|]
block|}
decl_stmt|,
name|tp
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|this
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|this
index|]
block|}
decl_stmt|,
name|op
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|opposite
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|opposite
index|]
block|}
decl_stmt|,
name|p
init|=
block|{
operator|.
name|x
operator|=
name|dx
block|,
operator|.
name|y
operator|=
name|dy
block|}
decl_stmt|,
name|pivot
init|=
block|{
operator|.
name|x
operator|=
name|ppivot_x
block|,
operator|.
name|y
operator|=
name|ppivot_y
block|}
decl_stmt|,
name|nt
decl_stmt|,
name|nr
decl_stmt|,
name|nl
decl_stmt|,
name|no
init|=
name|op
decl_stmt|;
comment|/* when the keep aspect transformation constraint is enabled, the        * translation shall only be along the diagonal that runs trough        * this corner point. */
if|if
condition|(
name|keepaspect
condition|)
block|{
comment|/* restrict to movement along the diagonal */
name|GimpVector2
name|diag
init|=
name|vectorsubtract
argument_list|(
name|tp
argument_list|,
name|op
argument_list|)
decl_stmt|;
name|p
operator|=
name|vectorproject
argument_list|(
name|p
argument_list|,
name|diag
argument_list|)
expr_stmt|;
block|}
comment|/* Move the corner being interacted with */
comment|/*    rp---------tp        *   /           /\<- p, the interaction vector        *  /           /  tp        * op----------/        *        */
name|nt
operator|=
name|vectoradd
argument_list|(
name|tp
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* Where the corner to the right and left would go, need these to form        * lines to intersect with the sides */
comment|/*    rp----------/        *   /\          /\        *  /  nr       /  nt        * op----------lp        *              \        *               nl        */
name|nr
operator|=
name|vectoradd
argument_list|(
name|rp
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|nl
operator|=
name|vectoradd
argument_list|(
name|lp
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* Now we just need to find the intersection of op-rp and nr-nt.        * If frompivot mode is active, then op also moved,        * so we add no-op to rp */
comment|/*    rp----------/        *   /           /        *  /  nr==========nt        * op----------/        *        */
name|nr
operator|=
name|lineintersect
argument_list|(
name|nr
argument_list|,
name|nt
argument_list|,
name|no
argument_list|,
name|vectoradd
argument_list|(
name|rp
argument_list|,
name|vectorsubtract
argument_list|(
name|no
argument_list|,
name|op
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|nl
operator|=
name|lineintersect
argument_list|(
name|nl
argument_list|,
name|nt
argument_list|,
name|no
argument_list|,
name|vectoradd
argument_list|(
name|lp
argument_list|,
name|vectorsubtract
argument_list|(
name|no
argument_list|,
name|op
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/*    /-----------/        *   /           /        *  rp============nt        * op----------/        *        */
operator|*
name|x
index|[
name|this
index|]
operator|=
name|nt
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|this
index|]
operator|=
name|nt
operator|.
name|y
expr_stmt|;
operator|*
name|x
index|[
name|right
index|]
operator|=
name|nr
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|right
index|]
operator|=
name|nr
operator|.
name|y
expr_stmt|;
operator|*
name|x
index|[
name|left
index|]
operator|=
name|nl
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|left
index|]
operator|=
name|nl
operator|.
name|y
expr_stmt|;
operator|*
name|x
index|[
name|opposite
index|]
operator|=
name|no
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|opposite
index|]
operator|=
name|no
operator|.
name|y
expr_stmt|;
comment|/*        *        *  /--------------/        * /--------------/        *        */
if|if
condition|(
name|frompivot
condition|)
block|{
comment|/* transform the pivot point before the interaction and after, and move everything by            * this difference */
comment|//TODO don't fly off to hell when the transform is 'invalid'
comment|//TODO the handle doesn't actually end up where the mouse cursor is
name|gint
name|i
decl_stmt|;
name|GimpVector2
name|delta
init|=
name|getpivotdelta
argument_list|(
name|transform_tool
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|x
index|[
name|i
index|]
operator|-=
name|delta
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|i
index|]
operator|-=
name|delta
operator|.
name|y
expr_stmt|;
block|}
name|fixedpivot
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
comment|/* scaling via sides */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_N
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_E
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_S
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_W
condition|)
block|{
name|gint
name|this_l
decl_stmt|,
name|this_r
decl_stmt|,
name|opp_l
decl_stmt|,
name|opp_r
decl_stmt|;
comment|/* 0: northwest, 1: northeast, 2: southwest, 3: southeast */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_N
condition|)
block|{
name|this_l
operator|=
literal|1
expr_stmt|;
name|this_r
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_E
condition|)
block|{
name|this_l
operator|=
literal|3
expr_stmt|;
name|this_r
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_S
condition|)
block|{
name|this_l
operator|=
literal|2
expr_stmt|;
name|this_r
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_W
condition|)
block|{
name|this_l
operator|=
literal|0
expr_stmt|;
name|this_r
operator|=
literal|2
expr_stmt|;
block|}
else|else
name|g_assert_not_reached
argument_list|()
expr_stmt|;
name|opp_l
operator|=
literal|3
operator|-
name|this_r
expr_stmt|;
name|opp_r
operator|=
literal|3
operator|-
name|this_l
expr_stmt|;
name|GimpVector2
name|tl
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|this_l
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|this_l
index|]
block|}
decl_stmt|,
name|tr
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|this_r
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|this_r
index|]
block|}
decl_stmt|,
name|ol
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|opp_l
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|opp_l
index|]
block|}
decl_stmt|,
name|or
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|opp_r
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|opp_r
index|]
block|}
decl_stmt|,
name|p
init|=
block|{
operator|.
name|x
operator|=
name|dx
block|,
operator|.
name|y
operator|=
name|dy
block|}
decl_stmt|,
name|pivot
init|=
block|{
operator|.
name|x
operator|=
name|ppivot_x
block|,
operator|.
name|y
operator|=
name|ppivot_y
block|}
decl_stmt|,
name|side_l
init|=
name|vectorsubtract
argument_list|(
name|ol
argument_list|,
name|tl
argument_list|)
decl_stmt|,
name|side_r
init|=
name|vectorsubtract
argument_list|(
name|or
argument_list|,
name|tr
argument_list|)
decl_stmt|,
name|midline
init|=
name|vectoradd
argument_list|(
name|side_l
argument_list|,
name|side_r
argument_list|)
decl_stmt|;
comment|/* restrict to movement along the midline */
name|p
operator|=
name|vectorproject
argument_list|(
name|p
argument_list|,
name|midline
argument_list|)
expr_stmt|;
if|if
condition|(
name|keepaspect
condition|)
block|{
if|if
condition|(
operator|!
name|frompivot
condition|)
block|{
comment|/* center of the opposite side is pivot */
name|pivot
operator|=
name|scalemult
argument_list|(
name|vectoradd
argument_list|(
name|ol
argument_list|,
name|or
argument_list|)
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
block|}
name|GimpVector2
name|mouse
init|=
block|{
operator|.
name|x
operator|=
name|transform_tool
operator|->
name|mousex
block|,
operator|.
name|y
operator|=
name|transform_tool
operator|->
name|mousey
block|}
decl_stmt|;
name|GimpVector2
name|cur
init|=
block|{
operator|.
name|x
operator|=
name|transform_tool
operator|->
name|curx
block|,
operator|.
name|y
operator|=
name|transform_tool
operator|->
name|cury
block|}
decl_stmt|;
name|GimpVector2
name|before
init|=
name|vectorsubtract
argument_list|(
name|pivot
argument_list|,
name|mouse
argument_list|)
decl_stmt|;
name|GimpVector2
name|after
init|=
name|vectorsubtract
argument_list|(
name|pivot
argument_list|,
name|cur
argument_list|)
decl_stmt|;
name|after
operator|=
name|vectorproject
argument_list|(
name|after
argument_list|,
name|before
argument_list|)
expr_stmt|;
name|gdouble
name|distance
init|=
literal|0.5
operator|*
operator|(
name|after
operator|.
name|x
operator|/
name|before
operator|.
name|x
operator|+
name|after
operator|.
name|y
operator|/
name|before
operator|.
name|y
operator|)
decl_stmt|;
name|tl
operator|=
name|vectoradd
argument_list|(
name|pivot
argument_list|,
name|scalemult
argument_list|(
name|vectorsubtract
argument_list|(
name|tl
argument_list|,
name|pivot
argument_list|)
argument_list|,
name|distance
argument_list|)
argument_list|)
expr_stmt|;
name|tr
operator|=
name|vectoradd
argument_list|(
name|pivot
argument_list|,
name|scalemult
argument_list|(
name|vectorsubtract
argument_list|(
name|tr
argument_list|,
name|pivot
argument_list|)
argument_list|,
name|distance
argument_list|)
argument_list|)
expr_stmt|;
name|ol
operator|=
name|vectoradd
argument_list|(
name|pivot
argument_list|,
name|scalemult
argument_list|(
name|vectorsubtract
argument_list|(
name|ol
argument_list|,
name|pivot
argument_list|)
argument_list|,
name|distance
argument_list|)
argument_list|)
expr_stmt|;
name|or
operator|=
name|vectoradd
argument_list|(
name|pivot
argument_list|,
name|scalemult
argument_list|(
name|vectorsubtract
argument_list|(
name|or
argument_list|,
name|pivot
argument_list|)
argument_list|,
name|distance
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* just move the side */
name|tl
operator|=
name|vectoradd
argument_list|(
name|tl
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|tr
operator|=
name|vectoradd
argument_list|(
name|tr
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
operator|*
name|x
index|[
name|this_l
index|]
operator|=
name|tl
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|this_l
index|]
operator|=
name|tl
operator|.
name|y
expr_stmt|;
operator|*
name|x
index|[
name|this_r
index|]
operator|=
name|tr
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|this_r
index|]
operator|=
name|tr
operator|.
name|y
expr_stmt|;
operator|*
name|x
index|[
name|opp_l
index|]
operator|=
name|ol
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|opp_l
index|]
operator|=
name|ol
operator|.
name|y
expr_stmt|;
operator|*
name|x
index|[
name|opp_r
index|]
operator|=
name|or
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|opp_r
index|]
operator|=
name|or
operator|.
name|y
expr_stmt|;
if|if
condition|(
operator|!
name|keepaspect
operator|&&
name|frompivot
condition|)
block|{
name|GimpVector2
name|delta
init|=
name|getpivotdelta
argument_list|(
name|transform_tool
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|x
index|[
name|i
index|]
operator|-=
name|delta
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|i
index|]
operator|-=
name|delta
operator|.
name|y
expr_stmt|;
block|}
name|fixedpivot
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
comment|/* shear */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_N_S
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_E_S
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_S_S
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_W_S
condition|)
block|{
comment|/* o for the opposite edge, for frompivot */
name|gint
name|left
decl_stmt|,
name|right
decl_stmt|,
name|lefto
decl_stmt|,
name|righto
decl_stmt|;
name|gdouble
name|dxo
decl_stmt|,
name|dyo
decl_stmt|;
comment|/* set up indices for this edge and the opposite edge */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_N_S
condition|)
block|{
name|left
operator|=
literal|1
expr_stmt|;
name|right
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_W_S
condition|)
block|{
name|left
operator|=
literal|0
expr_stmt|;
name|right
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_S_S
condition|)
block|{
name|left
operator|=
literal|2
expr_stmt|;
name|right
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_E_S
condition|)
block|{
name|left
operator|=
literal|3
expr_stmt|;
name|right
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|g_assert_not_reached
argument_list|()
expr_stmt|;
name|lefto
operator|=
literal|3
operator|-
name|left
expr_stmt|;
name|righto
operator|=
literal|3
operator|-
name|right
expr_stmt|;
if|if
condition|(
name|frompivot
condition|)
block|{
name|dxo
operator|=
operator|-
name|dx
expr_stmt|;
name|dyo
operator|=
operator|-
name|dy
expr_stmt|;
block|}
else|else
block|{
name|dxo
operator|=
name|dyo
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|freeshear
condition|)
block|{
comment|/* restrict to movement along the side */
name|GimpVector2
name|lp
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|left
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|left
index|]
block|}
decl_stmt|,
name|rp
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|right
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|right
index|]
block|}
decl_stmt|,
name|p
init|=
block|{
operator|.
name|x
operator|=
name|dx
block|,
operator|.
name|y
operator|=
name|dy
block|}
decl_stmt|,
name|side
init|=
name|vectorsubtract
argument_list|(
name|rp
argument_list|,
name|lp
argument_list|)
decl_stmt|;
name|p
operator|=
name|vectorproject
argument_list|(
name|p
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|dx
operator|=
name|p
operator|.
name|x
expr_stmt|;
name|dy
operator|=
name|p
operator|.
name|y
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|freeshear
operator|&&
name|frompivot
condition|)
block|{
comment|/* restrict to movement along the opposite side */
name|GimpVector2
name|lp
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|lefto
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|lefto
index|]
block|}
decl_stmt|,
name|rp
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|righto
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|righto
index|]
block|}
decl_stmt|,
name|p
init|=
block|{
operator|.
name|x
operator|=
name|dxo
block|,
operator|.
name|y
operator|=
name|dyo
block|}
decl_stmt|,
name|side
init|=
name|vectorsubtract
argument_list|(
name|rp
argument_list|,
name|lp
argument_list|)
decl_stmt|;
name|p
operator|=
name|vectorproject
argument_list|(
name|p
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|dxo
operator|=
name|p
operator|.
name|x
expr_stmt|;
name|dyo
operator|=
name|p
operator|.
name|y
expr_stmt|;
block|}
operator|*
name|x
index|[
name|left
index|]
operator|=
name|px
index|[
name|left
index|]
operator|+
name|dx
expr_stmt|;
operator|*
name|y
index|[
name|left
index|]
operator|=
name|py
index|[
name|left
index|]
operator|+
name|dy
expr_stmt|;
operator|*
name|x
index|[
name|right
index|]
operator|=
name|px
index|[
name|right
index|]
operator|+
name|dx
expr_stmt|;
operator|*
name|y
index|[
name|right
index|]
operator|=
name|py
index|[
name|right
index|]
operator|+
name|dy
expr_stmt|;
comment|/* We have to set these unconditionally, or the opposite edge will stay        * in place when you toggle the frompivot constraint during an action */
operator|*
name|x
index|[
name|lefto
index|]
operator|=
name|px
index|[
name|lefto
index|]
operator|+
name|dxo
expr_stmt|;
operator|*
name|y
index|[
name|lefto
index|]
operator|=
name|py
index|[
name|lefto
index|]
operator|+
name|dyo
expr_stmt|;
operator|*
name|x
index|[
name|righto
index|]
operator|=
name|px
index|[
name|righto
index|]
operator|+
name|dxo
expr_stmt|;
operator|*
name|y
index|[
name|righto
index|]
operator|=
name|py
index|[
name|righto
index|]
operator|+
name|dyo
expr_stmt|;
block|}
comment|/* perspective transform */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_NW_P
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_NE_P
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_SE_P
operator|||
name|function
operator|==
name|TRANSFORM_HANDLE_SW_P
condition|)
block|{
name|gint
name|this
decl_stmt|,
name|left
decl_stmt|,
name|right
decl_stmt|,
name|opposite
decl_stmt|;
comment|/* 0: northwest, 1: northeast, 2: southwest, 3: southeast */
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_NW_P
condition|)
block|{
name|this
operator|=
literal|0
expr_stmt|;
name|left
operator|=
literal|1
expr_stmt|;
name|right
operator|=
literal|2
expr_stmt|;
name|opposite
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_NE_P
condition|)
block|{
name|this
operator|=
literal|1
expr_stmt|;
name|left
operator|=
literal|3
expr_stmt|;
name|right
operator|=
literal|0
expr_stmt|;
name|opposite
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_SW_P
condition|)
block|{
name|this
operator|=
literal|2
expr_stmt|;
name|left
operator|=
literal|0
expr_stmt|;
name|right
operator|=
literal|3
expr_stmt|;
name|opposite
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|function
operator|==
name|TRANSFORM_HANDLE_SE_P
condition|)
block|{
name|this
operator|=
literal|3
expr_stmt|;
name|left
operator|=
literal|2
expr_stmt|;
name|right
operator|=
literal|1
expr_stmt|;
name|opposite
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|g_assert_not_reached
argument_list|()
expr_stmt|;
if|if
condition|(
name|constrain
condition|)
block|{
comment|/* when the constrain transformation constraint is enabled, the              translation shall only be either along the side angles of the              two sides that run to this corner point, or along the              diagonal that runs trough this corner point. */
name|GimpVector2
name|l
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|left
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|left
index|]
block|}
decl_stmt|;
name|GimpVector2
name|r
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|right
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|right
index|]
block|}
decl_stmt|;
name|GimpVector2
name|o
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|opposite
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|opposite
index|]
block|}
decl_stmt|;
name|GimpVector2
name|t
init|=
block|{
operator|.
name|x
operator|=
name|px
index|[
name|this
index|]
block|,
operator|.
name|y
operator|=
name|py
index|[
name|this
index|]
block|}
decl_stmt|;
name|GimpVector2
name|p
init|=
block|{
operator|.
name|x
operator|=
name|dx
block|,
operator|.
name|y
operator|=
name|dy
block|}
decl_stmt|;
name|GimpVector2
name|lp
decl_stmt|,
name|rp
decl_stmt|,
name|op
decl_stmt|;
name|gdouble
name|rej_lp
decl_stmt|,
name|rej_rp
decl_stmt|,
name|rej_op
decl_stmt|;
comment|/* get the vectors along the sides and the diagonal */
name|l
operator|=
name|vectorsubtract
argument_list|(
name|t
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|r
operator|=
name|vectorsubtract
argument_list|(
name|t
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|o
operator|=
name|vectorsubtract
argument_list|(
name|t
argument_list|,
name|o
argument_list|)
expr_stmt|;
comment|/* project p on l, r and o and see which has the shortest rejection */
name|lp
operator|=
name|vectorproject
argument_list|(
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|rp
operator|=
name|vectorproject
argument_list|(
name|p
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|op
operator|=
name|vectorproject
argument_list|(
name|p
argument_list|,
name|o
argument_list|)
expr_stmt|;
name|rej_lp
operator|=
name|norm
argument_list|(
name|vectorsubtract
argument_list|(
name|p
argument_list|,
name|lp
argument_list|)
argument_list|)
expr_stmt|;
name|rej_rp
operator|=
name|norm
argument_list|(
name|vectorsubtract
argument_list|(
name|p
argument_list|,
name|rp
argument_list|)
argument_list|)
expr_stmt|;
name|rej_op
operator|=
name|norm
argument_list|(
name|vectorsubtract
argument_list|(
name|p
argument_list|,
name|op
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rej_lp
operator|<
name|rej_rp
operator|&&
name|rej_lp
operator|<
name|rej_op
condition|)
name|p
operator|=
name|lp
expr_stmt|;
elseif|else
if|if
condition|(
name|rej_rp
operator|<
name|rej_op
condition|)
name|p
operator|=
name|rp
expr_stmt|;
else|else
name|p
operator|=
name|op
expr_stmt|;
name|dx
operator|=
name|p
operator|.
name|x
expr_stmt|;
name|dy
operator|=
name|p
operator|.
name|y
expr_stmt|;
block|}
operator|*
name|x
index|[
name|this
index|]
operator|=
name|px
index|[
name|this
index|]
operator|+
name|dx
expr_stmt|;
operator|*
name|y
index|[
name|this
index|]
operator|=
name|py
index|[
name|this
index|]
operator|+
name|dy
expr_stmt|;
if|if
condition|(
name|frompivot
condition|)
block|{
name|gint
name|i
decl_stmt|;
name|GimpVector2
name|delta
init|=
name|getpivotdelta
argument_list|(
name|transform_tool
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|x
index|[
name|i
index|]
operator|-=
name|delta
operator|.
name|x
expr_stmt|;
operator|*
name|y
index|[
name|i
index|]
operator|-=
name|delta
operator|.
name|y
expr_stmt|;
block|}
name|fixedpivot
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|fixedpivot
condition|)
block|{
name|GimpVector2
name|delta
init|=
name|getpivotdelta
argument_list|(
name|transform_tool
argument_list|)
decl_stmt|;
operator|*
name|pivot_x
operator|=
name|ppivot_x
operator|+
name|delta
operator|.
name|x
expr_stmt|;
operator|*
name|pivot_y
operator|=
name|ppivot_y
operator|+
name|delta
operator|.
name|y
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_unified_transform_tool_recalc_matrix (GimpTransformTool * tr_tool)
name|gimp_unified_transform_tool_recalc_matrix
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
block|{
name|tr_tool
operator|->
name|px
operator|=
name|tr_tool
operator|->
name|trans_info
index|[
name|PIVOT_X
index|]
expr_stmt|;
name|tr_tool
operator|->
name|py
operator|=
name|tr_tool
operator|->
name|trans_info
index|[
name|PIVOT_Y
index|]
expr_stmt|;
name|gimp_matrix3_identity
argument_list|(
operator|&
name|tr_tool
operator|->
name|transform
argument_list|)
expr_stmt|;
name|gimp_transform_matrix_perspective
argument_list|(
operator|&
name|tr_tool
operator|->
name|transform
argument_list|,
name|tr_tool
operator|->
name|x1
argument_list|,
name|tr_tool
operator|->
name|y1
argument_list|,
name|tr_tool
operator|->
name|x2
operator|-
name|tr_tool
operator|->
name|x1
argument_list|,
name|tr_tool
operator|->
name|y2
operator|-
name|tr_tool
operator|->
name|y1
argument_list|,
name|tr_tool
operator|->
name|trans_info
index|[
name|X0
index|]
argument_list|,
name|tr_tool
operator|->
name|trans_info
index|[
name|Y0
index|]
argument_list|,
name|tr_tool
operator|->
name|trans_info
index|[
name|X1
index|]
argument_list|,
name|tr_tool
operator|->
name|trans_info
index|[
name|Y1
index|]
argument_list|,
name|tr_tool
operator|->
name|trans_info
index|[
name|X2
index|]
argument_list|,
name|tr_tool
operator|->
name|trans_info
index|[
name|Y2
index|]
argument_list|,
name|tr_tool
operator|->
name|trans_info
index|[
name|X3
index|]
argument_list|,
name|tr_tool
operator|->
name|trans_info
index|[
name|Y3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|gimp_unified_transform_tool_get_undo_desc (GimpTransformTool * tr_tool)
name|gimp_unified_transform_tool_get_undo_desc
parameter_list|(
name|GimpTransformTool
modifier|*
name|tr_tool
parameter_list|)
block|{
return|return
name|g_strdup
argument_list|(
name|C_
argument_list|(
literal|"undo-type"
argument_list|,
literal|"Unified Transform"
argument_list|)
argument_list|)
return|;
block|}
end_function

end_unit

