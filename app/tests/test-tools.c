begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 2009 Martin Nordholts<martinn@src.gnome.org>  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<gegl.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<gdk/gdkkeysyms.h>
end_include

begin_include
include|#
directive|include
file|"libgimpbase/gimpbase.h"
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"tools/tools-types.h"
end_include

begin_include
include|#
directive|include
file|"tools/gimprectangleoptions.h"
end_include

begin_include
include|#
directive|include
file|"tools/tool_manager.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplay.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell-scale.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell-callbacks.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpdisplayshell-transform.h"
end_include

begin_include
include|#
directive|include
file|"display/gimpimagewindow.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpdialogfactory.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpdock.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpdockable.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpdockbook.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpdocked.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpdockwindow.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimphelp-ids.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpsessioninfo.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimptoolbox.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimptooloptionseditor.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpuimanager.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpwidgets-utils.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpchannel.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpcontext.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage.h"
end_include

begin_include
include|#
directive|include
file|"core/gimplayer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimptoolinfo.h"
end_include

begin_include
include|#
directive|include
file|"core/gimptooloptions.h"
end_include

begin_include
include|#
directive|include
file|"tests.h"
end_include

begin_include
include|#
directive|include
file|"gimp-app-test-utils.h"
end_include

begin_define
DECL|macro|GIMP_TEST_IMAGE_WIDTH
define|#
directive|define
name|GIMP_TEST_IMAGE_WIDTH
value|150
end_define

begin_define
DECL|macro|GIMP_TEST_IMAGE_HEIGHT
define|#
directive|define
name|GIMP_TEST_IMAGE_HEIGHT
value|267
end_define

begin_comment
comment|/* Put this in the code below when you want the test to pause so you  * can do measurements of widgets on the screen for example  */
end_comment

begin_define
DECL|macro|GIMP_PAUSE
define|#
directive|define
name|GIMP_PAUSE
value|(g_usleep (2 * 1000 * 1000))
end_define

begin_define
DECL|macro|ADD_TEST (function)
define|#
directive|define
name|ADD_TEST
parameter_list|(
name|function
parameter_list|)
define|\
value|g_test_add ("/gimp-tools/" #function, \               GimpTestFixture, \               gimp, \               gimp_tools_setup_image, \               function, \               gimp_tools_teardown_image);
end_define

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ab9c99c0108
block|{
DECL|member|avoid_sizeof_zero
name|int
name|avoid_sizeof_zero
decl_stmt|;
DECL|typedef|GimpTestFixture
block|}
name|GimpTestFixture
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|gimp_tools_setup_image
parameter_list|(
name|GimpTestFixture
modifier|*
name|fixture
parameter_list|,
name|gconstpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tools_teardown_image
parameter_list|(
name|GimpTestFixture
modifier|*
name|fixture
parameter_list|,
name|gconstpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tools_synthesize_image_click_drag_release
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gdouble
name|start_image_x
parameter_list|,
name|gdouble
name|start_image_y
parameter_list|,
name|gdouble
name|end_image_x
parameter_list|,
name|gdouble
name|end_image_y
parameter_list|,
name|gint
name|button
parameter_list|,
name|GdkModifierType
name|modifiers
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GimpDisplay
modifier|*
name|gimp_test_get_only_display
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GimpImage
modifier|*
name|gimp_test_get_only_image
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GimpDisplayShell
modifier|*
name|gimp_test_get_only_display_shell
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
DECL|function|gimp_tools_setup_image (GimpTestFixture * fixture,gconstpointer data)
name|gimp_tools_setup_image
parameter_list|(
name|GimpTestFixture
modifier|*
name|fixture
parameter_list|,
name|gconstpointer
name|data
parameter_list|)
block|{
name|Gimp
modifier|*
name|gimp
init|=
name|GIMP
argument_list|(
name|data
argument_list|)
decl_stmt|;
name|gimp_test_utils_create_image
argument_list|(
name|gimp
argument_list|,
name|GIMP_TEST_IMAGE_WIDTH
argument_list|,
name|GIMP_TEST_IMAGE_HEIGHT
argument_list|)
expr_stmt|;
name|gimp_test_run_mainloop_until_idle
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tools_teardown_image (GimpTestFixture * fixture,gconstpointer data)
name|gimp_tools_teardown_image
parameter_list|(
name|GimpTestFixture
modifier|*
name|fixture
parameter_list|,
name|gconstpointer
name|data
parameter_list|)
block|{
name|Gimp
modifier|*
name|gimp
init|=
name|GIMP
argument_list|(
name|data
argument_list|)
decl_stmt|;
name|g_object_unref
argument_list|(
name|gimp_test_get_only_image
argument_list|(
name|gimp
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_display_close
argument_list|(
name|gimp_test_get_only_display
argument_list|(
name|gimp
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_test_run_mainloop_until_idle
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * gimp_tools_set_tool:  * @gimp:  * @tool_id:  * @display:  *  * Makes sure the given tool is the active tool and that the passed  * display is the focused tool display.  **/
end_comment

begin_function
specifier|static
name|void
DECL|function|gimp_tools_set_tool (Gimp * gimp,const gchar * tool_id,GimpDisplay * display)
name|gimp_tools_set_tool
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|,
specifier|const
name|gchar
modifier|*
name|tool_id
parameter_list|,
name|GimpDisplay
modifier|*
name|display
parameter_list|)
block|{
comment|/* Activate tool and setup active display for the new tool */
name|gimp_context_set_tool
argument_list|(
name|gimp_get_user_context
argument_list|(
name|gimp
argument_list|)
argument_list|,
name|gimp_get_tool_info
argument_list|(
name|gimp
argument_list|,
name|tool_id
argument_list|)
argument_list|)
expr_stmt|;
name|tool_manager_focus_display_active
argument_list|(
name|gimp
argument_list|,
name|display
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * gimp_test_get_only_display:  * @gimp:  *  * Asserts that there only is one image and display and then  * returns the display.  *  * Returns: The #GimpDisplay.  **/
end_comment

begin_function
specifier|static
name|GimpDisplay
modifier|*
DECL|function|gimp_test_get_only_display (Gimp * gimp)
name|gimp_test_get_only_display
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|)
block|{
name|g_assert
argument_list|(
name|g_list_length
argument_list|(
name|gimp_get_image_iter
argument_list|(
name|gimp
argument_list|)
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|g_list_length
argument_list|(
name|gimp_get_display_iter
argument_list|(
name|gimp
argument_list|)
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
return|return
name|GIMP_DISPLAY
argument_list|(
name|gimp_get_display_iter
argument_list|(
name|gimp
argument_list|)
operator|->
name|data
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * gimp_test_get_only_display_shell:  * @gimp:  *  * Asserts that there only is one image and display shell and then  * returns the display shell.  *  * Returns: The #GimpDisplayShell.  **/
end_comment

begin_function
specifier|static
name|GimpDisplayShell
modifier|*
DECL|function|gimp_test_get_only_display_shell (Gimp * gimp)
name|gimp_test_get_only_display_shell
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|)
block|{
return|return
name|gimp_display_get_shell
argument_list|(
name|gimp_test_get_only_display
argument_list|(
name|gimp
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * gimp_test_get_only_image:  * @gimp:  *  * Asserts that there is only one image and returns that.  *  * Returns: The #GimpImage.  **/
end_comment

begin_function
specifier|static
name|GimpImage
modifier|*
DECL|function|gimp_test_get_only_image (Gimp * gimp)
name|gimp_test_get_only_image
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|)
block|{
name|g_assert
argument_list|(
name|g_list_length
argument_list|(
name|gimp_get_image_iter
argument_list|(
name|gimp
argument_list|)
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|g_list_length
argument_list|(
name|gimp_get_display_iter
argument_list|(
name|gimp
argument_list|)
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
return|return
name|GIMP_IMAGE
argument_list|(
name|gimp_get_image_iter
argument_list|(
name|gimp
argument_list|)
operator|->
name|data
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_test_synthesize_tool_button_event (GimpDisplayShell * shell,gint x,gint y,gint button,gint modifiers,GdkEventType button_event_type)
name|gimp_test_synthesize_tool_button_event
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|button
parameter_list|,
name|gint
name|modifiers
parameter_list|,
name|GdkEventType
name|button_event_type
parameter_list|)
block|{
name|GdkEvent
modifier|*
name|event
init|=
name|gdk_event_new
argument_list|(
name|button_event_type
argument_list|)
decl_stmt|;
name|GdkWindow
modifier|*
name|window
init|=
name|gtk_widget_get_window
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|)
decl_stmt|;
name|GdkDisplay
modifier|*
name|display
init|=
name|gdk_drawable_get_display
argument_list|(
name|GDK_DRAWABLE
argument_list|(
name|window
argument_list|)
argument_list|)
decl_stmt|;
name|g_assert
argument_list|(
name|button_event_type
operator|==
name|GDK_BUTTON_PRESS
operator|||
name|button_event_type
operator|==
name|GDK_BUTTON_RELEASE
argument_list|)
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|window
operator|=
name|g_object_ref
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|send_event
operator|=
name|TRUE
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|time
operator|=
name|gtk_get_current_event_time
argument_list|()
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|y
operator|=
name|y
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|axes
operator|=
name|NULL
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|state
operator|=
literal|0
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|button
operator|=
name|button
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|device
operator|=
name|gdk_display_get_core_pointer
argument_list|(
name|display
argument_list|)
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|x_root
operator|=
operator|-
literal|1
expr_stmt|;
name|event
operator|->
name|button
operator|.
name|y_root
operator|=
operator|-
literal|1
expr_stmt|;
name|gimp_display_shell_canvas_tool_events
argument_list|(
name|shell
operator|->
name|canvas
argument_list|,
name|event
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gdk_event_free
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_test_synthesize_tool_motion_event (GimpDisplayShell * shell,gint x,gint y,gint modifiers)
name|gimp_test_synthesize_tool_motion_event
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|modifiers
parameter_list|)
block|{
name|GdkEvent
modifier|*
name|event
init|=
name|gdk_event_new
argument_list|(
name|GDK_MOTION_NOTIFY
argument_list|)
decl_stmt|;
name|GdkWindow
modifier|*
name|window
init|=
name|gtk_widget_get_window
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|)
decl_stmt|;
name|GdkDisplay
modifier|*
name|display
init|=
name|gdk_drawable_get_display
argument_list|(
name|GDK_DRAWABLE
argument_list|(
name|window
argument_list|)
argument_list|)
decl_stmt|;
name|event
operator|->
name|motion
operator|.
name|window
operator|=
name|g_object_ref
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|send_event
operator|=
name|TRUE
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|time
operator|=
name|gtk_get_current_event_time
argument_list|()
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|y
operator|=
name|y
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|axes
operator|=
name|NULL
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|state
operator|=
name|GDK_BUTTON1_MASK
operator||
name|modifiers
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|is_hint
operator|=
name|FALSE
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|device
operator|=
name|gdk_display_get_core_pointer
argument_list|(
name|display
argument_list|)
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|x_root
operator|=
operator|-
literal|1
expr_stmt|;
name|event
operator|->
name|motion
operator|.
name|y_root
operator|=
operator|-
literal|1
expr_stmt|;
name|gimp_display_shell_canvas_tool_events
argument_list|(
name|shell
operator|->
name|canvas
argument_list|,
name|event
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gdk_event_free
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_test_synthesize_tool_crossing_event (GimpDisplayShell * shell,gint x,gint y,gint modifiers,GdkEventType crossing_event_type)
name|gimp_test_synthesize_tool_crossing_event
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|modifiers
parameter_list|,
name|GdkEventType
name|crossing_event_type
parameter_list|)
block|{
name|GdkEvent
modifier|*
name|event
init|=
name|gdk_event_new
argument_list|(
name|crossing_event_type
argument_list|)
decl_stmt|;
name|GdkWindow
modifier|*
name|window
init|=
name|gtk_widget_get_window
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|)
decl_stmt|;
name|g_assert
argument_list|(
name|crossing_event_type
operator|==
name|GDK_ENTER_NOTIFY
operator|||
name|crossing_event_type
operator|==
name|GDK_LEAVE_NOTIFY
argument_list|)
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|window
operator|=
name|g_object_ref
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|send_event
operator|=
name|TRUE
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|subwindow
operator|=
name|NULL
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|time
operator|=
name|gtk_get_current_event_time
argument_list|()
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|y
operator|=
name|y
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|x_root
operator|=
operator|-
literal|1
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|y_root
operator|=
operator|-
literal|1
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|mode
operator|=
name|GDK_CROSSING_NORMAL
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|detail
operator|=
name|GDK_NOTIFY_UNKNOWN
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|focus
operator|=
name|TRUE
expr_stmt|;
name|event
operator|->
name|crossing
operator|.
name|state
operator|=
name|modifiers
expr_stmt|;
name|gimp_display_shell_canvas_tool_events
argument_list|(
name|shell
operator|->
name|canvas
argument_list|,
name|event
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gdk_event_free
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tools_synthesize_image_click_drag_release (GimpDisplayShell * shell,gdouble start_image_x,gdouble start_image_y,gdouble end_image_x,gdouble end_image_y,gint button,GdkModifierType modifiers)
name|gimp_tools_synthesize_image_click_drag_release
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gdouble
name|start_image_x
parameter_list|,
name|gdouble
name|start_image_y
parameter_list|,
name|gdouble
name|end_image_x
parameter_list|,
name|gdouble
name|end_image_y
parameter_list|,
name|gint
name|button
comment|/*1..3*/
parameter_list|,
name|GdkModifierType
name|modifiers
parameter_list|)
block|{
name|gdouble
name|start_canvas_x
init|=
operator|-
literal|1.0
decl_stmt|;
name|gdouble
name|start_canvas_y
init|=
operator|-
literal|1.0
decl_stmt|;
name|gdouble
name|middle_canvas_x
init|=
operator|-
literal|1.0
decl_stmt|;
name|gdouble
name|middle_canvas_y
init|=
operator|-
literal|1.0
decl_stmt|;
name|gdouble
name|end_canvas_x
init|=
operator|-
literal|1.0
decl_stmt|;
name|gdouble
name|end_canvas_y
init|=
operator|-
literal|1.0
decl_stmt|;
comment|/* Transform coordinates */
name|gimp_display_shell_transform_xy_f
argument_list|(
name|shell
argument_list|,
name|start_image_x
argument_list|,
name|start_image_y
argument_list|,
operator|&
name|start_canvas_x
argument_list|,
operator|&
name|start_canvas_y
argument_list|)
expr_stmt|;
name|gimp_display_shell_transform_xy_f
argument_list|(
name|shell
argument_list|,
name|end_image_x
argument_list|,
name|end_image_y
argument_list|,
operator|&
name|end_canvas_x
argument_list|,
operator|&
name|end_canvas_y
argument_list|)
expr_stmt|;
name|middle_canvas_x
operator|=
operator|(
name|start_canvas_x
operator|+
name|end_canvas_x
operator|)
operator|/
literal|2
expr_stmt|;
name|middle_canvas_y
operator|=
operator|(
name|start_canvas_y
operator|+
name|end_canvas_y
operator|)
operator|/
literal|2
expr_stmt|;
comment|/* Enter notify */
name|gimp_test_synthesize_tool_crossing_event
argument_list|(
name|shell
argument_list|,
operator|(
name|int
operator|)
name|start_canvas_x
argument_list|,
operator|(
name|int
operator|)
name|start_canvas_y
argument_list|,
name|modifiers
argument_list|,
name|GDK_ENTER_NOTIFY
argument_list|)
expr_stmt|;
comment|/* Button press */
name|gimp_test_synthesize_tool_button_event
argument_list|(
name|shell
argument_list|,
operator|(
name|int
operator|)
name|start_canvas_x
argument_list|,
operator|(
name|int
operator|)
name|start_canvas_y
argument_list|,
name|button
argument_list|,
name|modifiers
argument_list|,
name|GDK_BUTTON_PRESS
argument_list|)
expr_stmt|;
comment|/* Move events */
name|gimp_test_synthesize_tool_motion_event
argument_list|(
name|shell
argument_list|,
operator|(
name|int
operator|)
name|start_canvas_x
argument_list|,
operator|(
name|int
operator|)
name|start_canvas_y
argument_list|,
name|modifiers
argument_list|)
expr_stmt|;
name|gimp_test_synthesize_tool_motion_event
argument_list|(
name|shell
argument_list|,
operator|(
name|int
operator|)
name|middle_canvas_x
argument_list|,
operator|(
name|int
operator|)
name|middle_canvas_y
argument_list|,
name|modifiers
argument_list|)
expr_stmt|;
name|gimp_test_synthesize_tool_motion_event
argument_list|(
name|shell
argument_list|,
operator|(
name|int
operator|)
name|end_canvas_x
argument_list|,
operator|(
name|int
operator|)
name|end_canvas_y
argument_list|,
name|modifiers
argument_list|)
expr_stmt|;
comment|/* Button release */
name|gimp_test_synthesize_tool_button_event
argument_list|(
name|shell
argument_list|,
operator|(
name|int
operator|)
name|end_canvas_x
argument_list|,
operator|(
name|int
operator|)
name|end_canvas_y
argument_list|,
name|button
argument_list|,
name|modifiers
argument_list|,
name|GDK_BUTTON_RELEASE
argument_list|)
expr_stmt|;
comment|/* Leave notify */
name|gimp_test_synthesize_tool_crossing_event
argument_list|(
name|shell
argument_list|,
operator|(
name|int
operator|)
name|start_canvas_x
argument_list|,
operator|(
name|int
operator|)
name|start_canvas_y
argument_list|,
name|modifiers
argument_list|,
name|GDK_LEAVE_NOTIFY
argument_list|)
expr_stmt|;
comment|/* Process them */
name|gimp_test_run_mainloop_until_idle
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * crop_tool_can_crop:  * @fixture:  * @data:  *  * Make sure it's possible to crop at all. Regression test for  * "Bug 315255 - SIGSEGV, while doing a crop".  **/
end_comment

begin_function
specifier|static
name|void
DECL|function|crop_tool_can_crop (GimpTestFixture * fixture,gconstpointer data)
name|crop_tool_can_crop
parameter_list|(
name|GimpTestFixture
modifier|*
name|fixture
parameter_list|,
name|gconstpointer
name|data
parameter_list|)
block|{
name|Gimp
modifier|*
name|gimp
init|=
name|GIMP
argument_list|(
name|data
argument_list|)
decl_stmt|;
name|GimpImage
modifier|*
name|image
init|=
name|gimp_test_get_only_image
argument_list|(
name|gimp
argument_list|)
decl_stmt|;
name|GimpDisplayShell
modifier|*
name|shell
init|=
name|gimp_test_get_only_display_shell
argument_list|(
name|gimp
argument_list|)
decl_stmt|;
name|gint
name|cropped_x
init|=
literal|10
decl_stmt|;
name|gint
name|cropped_y
init|=
literal|10
decl_stmt|;
name|gint
name|cropped_w
init|=
literal|20
decl_stmt|;
name|gint
name|cropped_h
init|=
literal|30
decl_stmt|;
comment|/* Fit display and pause and let it stabalize (two idlings seems to    * always be enough)    */
name|gimp_ui_manager_activate_action
argument_list|(
name|gimp_test_utils_get_ui_manager
argument_list|(
name|gimp
argument_list|)
argument_list|,
literal|"view"
argument_list|,
literal|"view-shrink-wrap"
argument_list|)
expr_stmt|;
name|gimp_test_run_mainloop_until_idle
argument_list|()
expr_stmt|;
name|gimp_test_run_mainloop_until_idle
argument_list|()
expr_stmt|;
comment|/* Activate crop tool */
name|gimp_tools_set_tool
argument_list|(
name|gimp
argument_list|,
literal|"gimp-crop-tool"
argument_list|,
name|shell
operator|->
name|display
argument_list|)
expr_stmt|;
comment|/* Do the crop rect */
name|gimp_tools_synthesize_image_click_drag_release
argument_list|(
name|shell
argument_list|,
name|cropped_x
argument_list|,
name|cropped_y
argument_list|,
name|cropped_x
operator|+
name|cropped_w
argument_list|,
name|cropped_y
operator|+
name|cropped_h
argument_list|,
literal|1
comment|/*button*/
argument_list|,
literal|0
comment|/*modifiers*/
argument_list|)
expr_stmt|;
comment|/* Crop */
name|gimp_test_utils_synthesize_key_event
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|GDK_KEY_Return
argument_list|)
expr_stmt|;
name|gimp_test_run_mainloop_until_idle
argument_list|()
expr_stmt|;
comment|/* Make sure the new image has the expected size */
name|g_assert_cmpint
argument_list|(
name|cropped_w
argument_list|,
operator|==
argument_list|,
name|gimp_image_get_width
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
name|g_assert_cmpint
argument_list|(
name|cropped_h
argument_list|,
operator|==
argument_list|,
name|gimp_image_get_height
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * crop_tool_can_crop:  * @fixture:  * @data:  *  * Make sure it's possible to change width of crop rect in tool  * options without there being a pending rectangle. Regression test  * for "Bug 322396 - Crop dimension entering causes crash".  **/
end_comment

begin_function
specifier|static
name|void
DECL|function|crop_set_width_without_pending_rect (GimpTestFixture * fixture,gconstpointer data)
name|crop_set_width_without_pending_rect
parameter_list|(
name|GimpTestFixture
modifier|*
name|fixture
parameter_list|,
name|gconstpointer
name|data
parameter_list|)
block|{
name|Gimp
modifier|*
name|gimp
init|=
name|GIMP
argument_list|(
name|data
argument_list|)
decl_stmt|;
name|GimpDisplay
modifier|*
name|display
init|=
name|gimp_test_get_only_display
argument_list|(
name|gimp
argument_list|)
decl_stmt|;
name|GimpToolInfo
modifier|*
name|tool_info
decl_stmt|;
name|GimpRectangleOptions
modifier|*
name|rectangle_options
decl_stmt|;
name|GtkWidget
modifier|*
name|tool_options_gui
decl_stmt|;
name|GtkWidget
modifier|*
name|size_entry
decl_stmt|;
comment|/* Activate crop tool */
name|gimp_tools_set_tool
argument_list|(
name|gimp
argument_list|,
literal|"gimp-crop-tool"
argument_list|,
name|display
argument_list|)
expr_stmt|;
comment|/* Get tool options */
name|tool_info
operator|=
name|gimp_get_tool_info
argument_list|(
name|gimp
argument_list|,
literal|"gimp-crop-tool"
argument_list|)
expr_stmt|;
name|tool_options_gui
operator|=
name|gimp_tools_get_tool_options_gui
argument_list|(
name|tool_info
operator|->
name|tool_options
argument_list|)
expr_stmt|;
name|rectangle_options
operator|=
name|GIMP_RECTANGLE_OPTIONS
argument_list|(
name|tool_info
operator|->
name|tool_options
argument_list|)
expr_stmt|;
comment|/* Find 'Width' or 'Height' GtkTextEntry in tool options */
name|size_entry
operator|=
name|gimp_rectangle_options_get_width_entry
argument_list|(
name|rectangle_options
argument_list|)
expr_stmt|;
comment|/* Set arbitrary non-0 value */
name|gimp_size_entry_set_value
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|size_entry
argument_list|)
argument_list|,
literal|0
comment|/*field*/
argument_list|,
literal|42.0
comment|/*lower*/
argument_list|)
expr_stmt|;
comment|/* If we don't crash, everything s fine */
block|}
end_function

begin_function
DECL|function|main (int argc,char ** argv)
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|Gimp
modifier|*
name|gimp
init|=
name|NULL
decl_stmt|;
name|gint
name|result
init|=
operator|-
literal|1
decl_stmt|;
name|gimp_test_bail_if_no_display
argument_list|()
expr_stmt|;
name|gtk_test_init
argument_list|(
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_test_utils_set_gimp2_directory
argument_list|(
literal|"GIMP_TESTING_ABS_TOP_SRCDIR"
argument_list|,
literal|"app/tests/gimpdir"
argument_list|)
expr_stmt|;
name|gimp_test_utils_setup_menus_dir
argument_list|()
expr_stmt|;
comment|/* Start up GIMP */
name|gimp
operator|=
name|gimp_init_for_gui_testing
argument_list|(
name|TRUE
comment|/*show_gui*/
argument_list|)
expr_stmt|;
name|gimp_test_run_mainloop_until_idle
argument_list|()
expr_stmt|;
comment|/* Add tests */
name|ADD_TEST
argument_list|(
name|crop_tool_can_crop
argument_list|)
expr_stmt|;
name|ADD_TEST
argument_list|(
name|crop_set_width_without_pending_rect
argument_list|)
expr_stmt|;
comment|/* Run the tests and return status */
name|result
operator|=
name|g_test_run
argument_list|()
expr_stmt|;
comment|/* Don't write files to the source dir */
name|gimp_test_utils_set_gimp2_directory
argument_list|(
literal|"GIMP_TESTING_ABS_TOP_BUILDDIR"
argument_list|,
literal|"app/tests/gimpdir-output"
argument_list|)
expr_stmt|;
comment|/* Exit properly so we don't break script-fu plug-in wire */
name|gimp_exit
argument_list|(
name|gimp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

end_unit

