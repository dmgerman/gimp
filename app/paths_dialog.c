begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1999 Andy Thomas alt@picnic.demon.co.uk  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  * Some of this code is based on the layers_dialog box code.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|"gdk/gdkkeysyms.h"
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"draw_core.h"
end_include

begin_include
include|#
directive|include
file|"actionarea.h"
end_include

begin_include
include|#
directive|include
file|"buildmenu.h"
end_include

begin_include
include|#
directive|include
file|"colormaps.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"floating_sel.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"gimage.h"
end_include

begin_include
include|#
directive|include
file|"gimage_mask.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"gimpset.h"
end_include

begin_include
include|#
directive|include
file|"general.h"
end_include

begin_include
include|#
directive|include
file|"image_render.h"
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"layers_dialog.h"
end_include

begin_include
include|#
directive|include
file|"layers_dialogP.h"
end_include

begin_include
include|#
directive|include
file|"ops_buttons.h"
end_include

begin_include
include|#
directive|include
file|"paint_funcs.h"
end_include

begin_include
include|#
directive|include
file|"bezier_select.h"
end_include

begin_include
include|#
directive|include
file|"bezier_selectP.h"
end_include

begin_include
include|#
directive|include
file|"pathsP.h"
end_include

begin_include
include|#
directive|include
file|"paths_dialog.h"
end_include

begin_include
include|#
directive|include
file|"resize.h"
end_include

begin_include
include|#
directive|include
file|"session.h"
end_include

begin_include
include|#
directive|include
file|"undo.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpmatrix.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_include
include|#
directive|include
file|"pixmaps/new.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/duplicate.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/delete.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/pennorm.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/penadd.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/pendel.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/penedit.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/penstroke.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/toselection.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/path.xbm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/locked.xpm"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|HAVE_RINT
end_ifndef

begin_define
DECL|macro|rint (x)
define|#
directive|define
name|rint
parameter_list|(
name|x
parameter_list|)
value|floor (x + 0.5)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
DECL|macro|PREVIEW_EVENT_MASK
define|#
directive|define
name|PREVIEW_EVENT_MASK
value|GDK_EXPOSURE_MASK | GDK_BUTTON_PRESS_MASK | GDK_ENTER_NOTIFY_MASK
end_define

begin_define
DECL|macro|PATHS_LIST_WIDTH
define|#
directive|define
name|PATHS_LIST_WIDTH
value|200
end_define

begin_define
DECL|macro|PATHS_LIST_HEIGHT
define|#
directive|define
name|PATHS_LIST_HEIGHT
value|150
end_define

begin_typedef
DECL|struct|__anon2bbe97ae0108
typedef|typedef
struct|struct
block|{
DECL|member|paths_list
name|GtkWidget
modifier|*
name|paths_list
decl_stmt|;
DECL|member|vbox
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
DECL|member|ops_menu
name|GtkWidget
modifier|*
name|ops_menu
decl_stmt|;
DECL|member|accel_group
name|GtkAccelGroup
modifier|*
name|accel_group
decl_stmt|;
DECL|member|ratio
name|double
name|ratio
decl_stmt|;
DECL|member|image_width
DECL|member|image_height
name|int
name|image_width
decl_stmt|,
name|image_height
decl_stmt|;
DECL|member|gimage_width
DECL|member|gimage_height
name|int
name|gimage_width
decl_stmt|,
name|gimage_height
decl_stmt|;
comment|/* pixmaps for the no preview bitmap */
DECL|member|pixmap_normal
name|GdkPixmap
modifier|*
name|pixmap_normal
decl_stmt|;
DECL|member|pixmap_selected
name|GdkPixmap
modifier|*
name|pixmap_selected
decl_stmt|;
DECL|member|pixmap_locked
name|GdkPixmap
modifier|*
name|pixmap_locked
decl_stmt|;
comment|/*  state information  */
DECL|member|selsigid
name|gint
name|selsigid
decl_stmt|;
DECL|member|gimage
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
DECL|member|gc
name|GdkGC
modifier|*
name|gc
decl_stmt|;
DECL|member|black
name|GdkColor
name|black
decl_stmt|;
DECL|member|white
name|GdkColor
name|white
decl_stmt|;
DECL|member|selected_row_num
name|gint
name|selected_row_num
decl_stmt|;
DECL|member|been_selected
name|gboolean
name|been_selected
decl_stmt|;
DECL|member|current_path_list
name|PATHIMAGELISTP
name|current_path_list
decl_stmt|;
DECL|typedef|PATHSLIST
DECL|typedef|PATHSLISTP
block|}
name|PATHSLIST
operator|,
typedef|*
name|PATHSLISTP
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|paths_dialog
specifier|static
name|PATHSLISTP
name|paths_dialog
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|copy_pp
specifier|static
name|PATHP
name|copy_pp
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_typedef
DECL|struct|__anon2bbe97ae0208
typedef|typedef
struct|struct
block|{
DECL|member|paths_pixmap
name|GdkPixmap
modifier|*
name|paths_pixmap
decl_stmt|;
DECL|member|text
name|GString
modifier|*
name|text
decl_stmt|;
DECL|member|bzp
name|PATHP
name|bzp
decl_stmt|;
DECL|typedef|PATHWIDGET
DECL|typedef|PATHWIDGETP
block|}
name|PATHWIDGET
operator|,
typedef|*
name|PATHWIDGETP
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2bbe97ae0308
typedef|typedef
struct|struct
block|{
DECL|member|tattoo
name|Tattoo
name|tattoo
decl_stmt|;
DECL|member|copy_path
name|PATHP
name|copy_path
decl_stmt|;
DECL|typedef|PATHUNDO
block|}
name|PATHUNDO
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2bbe97ae0408
typedef|typedef
struct|struct
block|{
DECL|member|c_count
name|CountCurves
name|c_count
decl_stmt|;
comment|/* Must be the first element */
DECL|member|total_count
name|gint
name|total_count
decl_stmt|;
comment|/* Total number of curves    */
DECL|typedef|PATHCOUNTS
DECL|typedef|PATHCOUNTSP
block|}
name|PATHCOUNTS
operator|,
typedef|*
name|PATHCOUNTSP
typedef|;
end_typedef

begin_function_decl
specifier|static
name|gchar
modifier|*
name|unique_name
parameter_list|(
name|GimpImage
modifier|*
parameter_list|,
name|gchar
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|path_widget_preview_events
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_realized
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_select_row
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|row
parameter_list|,
name|gint
name|column
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_unselect_row
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|row
parameter_list|,
name|gint
name|column
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|paths_list_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_new_path_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_delete_path_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_map_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_unmap_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_dup_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_copy_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_paste_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_stroke_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_path_to_sel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_destroy_cb
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_update_paths
parameter_list|(
name|gpointer
name|data
parameter_list|,
name|gint
name|row
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GSList
modifier|*
name|pathpoints_copy
parameter_list|(
name|GSList
modifier|*
name|list
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pathpoints_free
parameter_list|(
name|GSList
modifier|*
name|list
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_update_preview
parameter_list|(
name|BezierSelect
modifier|*
name|bezier_sel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_preview_extents
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_new_point_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_add_point_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_delete_point_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_edit_point_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_import_path_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_export_path_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|path_close
parameter_list|(
name|PATHP
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|paths_ops
specifier|static
name|MenuItem
name|paths_ops
index|[]
init|=
block|{
block|{
name|N_
argument_list|(
literal|"New Path"
argument_list|)
block|,
literal|'N'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_new_path_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Duplicate Path"
argument_list|)
block|,
literal|'U'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_dup_path_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Path to Selection"
argument_list|)
block|,
literal|'S'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_path_to_sel_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Stroke Path"
argument_list|)
block|,
literal|'T'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_stroke_path_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Delete Path"
argument_list|)
block|,
literal|'D'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_delete_path_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Import Path"
argument_list|)
block|,
literal|'I'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_import_path_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Export Path"
argument_list|)
block|,
literal|'E'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_export_path_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Copy Path"
argument_list|)
block|,
literal|'C'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_copy_path_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|N_
argument_list|(
literal|"Paste Path"
argument_list|)
block|,
literal|'P'
block|,
name|GDK_CONTROL_MASK
block|,
name|paths_dialog_paste_path_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
DECL|macro|NEW_PATH_BUTTON
define|#
directive|define
name|NEW_PATH_BUTTON
value|1
end_define

begin_define
DECL|macro|DUP_PATH_BUTTON
define|#
directive|define
name|DUP_PATH_BUTTON
value|2
end_define

begin_define
DECL|macro|PATH_TO_SEL_BUTTON
define|#
directive|define
name|PATH_TO_SEL_BUTTON
value|3
end_define

begin_define
DECL|macro|STROKE_PATH_BUTTON
define|#
directive|define
name|STROKE_PATH_BUTTON
value|4
end_define

begin_define
DECL|macro|DEL_PATH_BUTTON
define|#
directive|define
name|DEL_PATH_BUTTON
value|5
end_define

begin_define
DECL|macro|COPY_PATH_BUTTON
define|#
directive|define
name|COPY_PATH_BUTTON
value|8
end_define

begin_define
DECL|macro|PASTE_PATH_BUTTON
define|#
directive|define
name|PASTE_PATH_BUTTON
value|9
end_define

begin_decl_stmt
DECL|variable|paths_ops_buttons
specifier|static
name|OpsButton
name|paths_ops_buttons
index|[]
init|=
block|{
block|{
name|new_xpm
block|,
name|paths_dialog_new_path_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"New Path"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|duplicate_xpm
block|,
name|paths_dialog_dup_path_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Duplicate Path"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|toselection_xpm
block|,
name|paths_dialog_path_to_sel_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Path to Selection"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|penstroke_xpm
block|,
name|paths_dialog_stroke_path_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Stroke Path"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|delete_xpm
block|,
name|paths_dialog_delete_path_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Delete Path"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
DECL|macro|POINT_NEW_BUTTON
define|#
directive|define
name|POINT_NEW_BUTTON
value|1
end_define

begin_define
DECL|macro|POINT_ADD_BUTTON
define|#
directive|define
name|POINT_ADD_BUTTON
value|2
end_define

begin_define
DECL|macro|POINT_DEL_BUTTON
define|#
directive|define
name|POINT_DEL_BUTTON
value|3
end_define

begin_define
DECL|macro|POINT_EDIT_BUTTON
define|#
directive|define
name|POINT_EDIT_BUTTON
value|4
end_define

begin_decl_stmt
DECL|variable|point_ops_buttons
specifier|static
name|OpsButton
name|point_ops_buttons
index|[]
init|=
block|{
block|{
name|pennorm_xpm
block|,
name|paths_dialog_new_point_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"New Point"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|penadd_xpm
block|,
name|paths_dialog_add_point_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Add Point"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|pendel_xpm
block|,
name|paths_dialog_delete_point_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Delete Point"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|penedit_xpm
block|,
name|paths_dialog_edit_point_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Edit Point"
argument_list|)
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|paths_ops_button_set_sensitive (gint but,gboolean sensitive)
name|paths_ops_button_set_sensitive
parameter_list|(
name|gint
name|but
parameter_list|,
name|gboolean
name|sensitive
parameter_list|)
block|{
switch|switch
condition|(
name|but
condition|)
block|{
case|case
name|NEW_PATH_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops
index|[
literal|0
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops_buttons
index|[
literal|0
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|DUP_PATH_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops
index|[
literal|1
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops_buttons
index|[
literal|1
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|PATH_TO_SEL_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops
index|[
literal|2
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops_buttons
index|[
literal|2
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|STROKE_PATH_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops
index|[
literal|3
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops_buttons
index|[
literal|3
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|DEL_PATH_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops
index|[
literal|4
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops_buttons
index|[
literal|4
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|COPY_PATH_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops
index|[
literal|7
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|PASTE_PATH_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|paths_ops
index|[
literal|8
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"paths_ops_button_set_sensitive:: invalid button specified"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|point_ops_button_set_sensitive (gint but,gboolean sensitive)
name|point_ops_button_set_sensitive
parameter_list|(
name|gint
name|but
parameter_list|,
name|gboolean
name|sensitive
parameter_list|)
block|{
switch|switch
condition|(
name|but
condition|)
block|{
case|case
name|POINT_NEW_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|point_ops_buttons
index|[
literal|0
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|POINT_ADD_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|point_ops_buttons
index|[
literal|1
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|POINT_DEL_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|point_ops_buttons
index|[
literal|2
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
case|case
name|POINT_EDIT_BUTTON
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|point_ops_buttons
index|[
literal|3
index|]
operator|.
name|widget
argument_list|,
name|sensitive
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"point_ops_button_set_sensitive:: invalid button specified"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_list_destroy (GtkWidget * w)
name|paths_list_destroy
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|)
block|{
name|paths_dialog
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
DECL|function|paths_dialog_create ()
name|GtkWidget
modifier|*
name|paths_dialog_create
parameter_list|()
block|{
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|paths_list
decl_stmt|;
name|GtkWidget
modifier|*
name|scrolled_win
decl_stmt|;
name|GtkWidget
modifier|*
name|button_box
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
condition|)
block|{
name|paths_dialog
operator|=
name|g_new0
argument_list|(
name|PATHSLIST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/*  The paths box  */
name|paths_dialog
operator|->
name|vbox
operator|=
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* The point operations */
name|button_box
operator|=
name|ops_button_box_new
argument_list|(
name|lc_shell
argument_list|,
name|tool_tips
argument_list|,
name|point_ops_buttons
argument_list|,
name|OPS_BUTTON_RADIO
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|button_box
argument_list|)
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button_box
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button_box
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|scrolled_win
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|scrolled_win
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_win
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_ALWAYS
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|paths_list
operator|=
name|paths_list
operator|=
name|gtk_clist_new
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|paths_list_destroy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*       gtk_clist_set_column_title(GTK_CLIST(paths_list), 0, _("Locked"));    */
comment|/*       gtk_clist_set_column_title(GTK_CLIST(paths_list), 1, _("Path"));    */
comment|/*       gtk_clist_column_titles_show(GTK_CLIST(paths_list));   */
comment|/*      gtk_clist_columns_autosize(GTK_CLIST(paths_list));  */
name|gtk_clist_set_column_width
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|scrolled_win
argument_list|)
argument_list|,
name|paths_list
argument_list|)
expr_stmt|;
name|gtk_clist_set_selection_mode
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_list
argument_list|)
argument_list|,
name|GTK_SELECTION_BROWSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|paths_list_events
argument_list|,
name|paths_dialog
argument_list|)
expr_stmt|;
name|gtk_container_set_focus_vadjustment
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|paths_list
argument_list|)
argument_list|,
name|gtk_scrolled_window_get_vadjustment
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_win
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_win
argument_list|)
operator|->
name|vscrollbar
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|selsigid
operator|=
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|"select_row"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|paths_select_row
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|"unselect_row"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|paths_unselect_row
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|scrolled_win
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|paths_list
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|"realize"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|paths_dialog_realized
argument_list|,
operator|(
name|gpointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
comment|/* The ops buttons */
name|button_box
operator|=
name|ops_button_box_new
argument_list|(
name|lc_shell
argument_list|,
name|tool_tips
argument_list|,
name|paths_ops_buttons
argument_list|,
name|OPS_BUTTON_NORMAL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button_box
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button_box
argument_list|)
expr_stmt|;
comment|/*  Set up signals for map/unmap for the accelerators  */
name|paths_dialog
operator|->
name|accel_group
operator|=
name|gtk_accel_group_new
argument_list|()
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|"map"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|paths_dialog_map_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|"unmap"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|paths_dialog_unmap_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|ops_menu
operator|=
name|build_menu
argument_list|(
name|paths_ops
argument_list|,
name|paths_dialog
operator|->
name|accel_group
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
return|return
name|paths_dialog
operator|->
name|vbox
return|;
block|}
end_function

begin_function
DECL|function|paths_dialog_realized (GtkWidget * widget)
specifier|static
name|void
name|paths_dialog_realized
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
block|{
name|GdkColormap
modifier|*
name|colormap
decl_stmt|;
name|gchar
name|dash_list
index|[
literal|2
index|]
init|=
block|{
literal|3
block|,
literal|3
block|}
decl_stmt|;
comment|/* Help out small displays */
if|if
condition|(
name|preview_size
operator|<
literal|64
condition|)
name|dash_list
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|paths_dialog
operator|->
name|gc
operator|=
name|gdk_gc_new
argument_list|(
name|widget
operator|->
name|window
argument_list|)
expr_stmt|;
name|gdk_gc_set_dashes
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
literal|2
argument_list|,
name|dash_list
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|colormap
operator|=
name|gtk_widget_get_colormap
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
expr_stmt|;
name|gdk_color_parse
argument_list|(
literal|"black"
argument_list|,
operator|&
name|paths_dialog
operator|->
name|black
argument_list|)
expr_stmt|;
name|gdk_color_alloc
argument_list|(
name|colormap
argument_list|,
operator|&
name|paths_dialog
operator|->
name|black
argument_list|)
expr_stmt|;
name|gdk_color_parse
argument_list|(
literal|"white"
argument_list|,
operator|&
name|paths_dialog
operator|->
name|white
argument_list|)
expr_stmt|;
name|gdk_color_alloc
argument_list|(
name|colormap
argument_list|,
operator|&
name|paths_dialog
operator|->
name|white
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Clears out row when list element is deleted/destroyed */
end_comment

begin_function
specifier|static
name|void
DECL|function|clear_pathwidget (gpointer data)
name|clear_pathwidget
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|PATHWIDGETP
name|pwidget
init|=
name|data
decl_stmt|;
if|if
condition|(
name|pwidget
condition|)
block|{
name|g_free
argument_list|(
name|pwidget
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|pathpoint_free (gpointer data,gpointer user_data)
name|pathpoint_free
parameter_list|(
name|gpointer
name|data
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|PATHPOINTP
name|pathpoint
init|=
name|data
decl_stmt|;
name|g_free
argument_list|(
name|pathpoint
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|path_free (gpointer data,gpointer user_data)
name|path_free
parameter_list|(
name|gpointer
name|data
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|PATHP
name|bzp
init|=
name|data
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|bzp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|bzp
operator|->
name|name
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|pathpoints_free
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|PATHP
DECL|function|path_dialog_new (GimpImage * gimage,gint name_seed,gpointer udata)
name|path_dialog_new
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|name_seed
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|PATHP
name|bzp
decl_stmt|;
name|GString
modifier|*
name|s
init|=
name|g_string_new
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|suniq
decl_stmt|;
name|g_string_sprintf
argument_list|(
name|s
argument_list|,
literal|"path %d"
argument_list|,
name|name_seed
argument_list|)
expr_stmt|;
name|suniq
operator|=
name|unique_name
argument_list|(
name|gimage
argument_list|,
name|s
operator|->
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|suniq
condition|)
block|{
name|g_string_free
argument_list|(
name|s
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|s
operator|=
name|g_string_new
argument_list|(
name|suniq
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|suniq
argument_list|)
expr_stmt|;
block|}
name|bzp
operator|=
name|path_new
argument_list|(
name|gimage
argument_list|,
name|BEZIER
argument_list|,
operator|(
name|GSList
operator|*
operator|)
name|udata
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|s
operator|->
name|str
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|s
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|bzp
return|;
block|}
end_function

begin_comment
comment|/* Always return a copy that must be freed later */
end_comment

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|strip_off_cnumber (gchar * str)
name|strip_off_cnumber
parameter_list|(
name|gchar
modifier|*
name|str
parameter_list|)
block|{
name|gchar
modifier|*
name|hashptr
decl_stmt|;
name|gint
name|num
decl_stmt|;
name|gchar
modifier|*
name|copy
decl_stmt|;
if|if
condition|(
operator|!
name|str
condition|)
return|return
name|str
return|;
name|copy
operator|=
name|g_strdup
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hashptr
operator|=
name|strrchr
argument_list|(
name|copy
argument_list|,
literal|'#'
argument_list|)
operator|)
operator|&&
comment|/* have a hash */
name|strlen
argument_list|(
name|hashptr
argument_list|)
operator|>
literal|0
operator|&&
comment|/* followed by something */
operator|(
name|num
operator|=
name|atoi
argument_list|(
name|hashptr
operator|+
literal|1
argument_list|)
operator|)
operator|>
literal|0
operator|&&
comment|/* which is a number */
operator|(
operator|(
name|int
operator|)
name|log10
argument_list|(
name|num
argument_list|)
operator|+
literal|1
operator|)
operator|==
name|strlen
argument_list|(
name|hashptr
operator|+
literal|1
argument_list|)
condition|)
comment|/* which is at the end */
block|{
name|gchar
modifier|*
name|tstr
decl_stmt|;
comment|/* Has a #<number> */
operator|*
name|hashptr
operator|=
literal|'\0'
expr_stmt|;
name|tstr
operator|=
name|g_strdup
argument_list|(
name|copy
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|copy
argument_list|)
expr_stmt|;
name|copy
operator|=
name|tstr
expr_stmt|;
block|}
return|return
name|copy
return|;
block|}
end_function

begin_comment
comment|/* Return NULL is already unique else a unique string */
end_comment

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|unique_name (GimpImage * gimage,gchar * cstr)
name|unique_name
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gchar
modifier|*
name|cstr
parameter_list|)
block|{
name|GSList
modifier|*
name|tlist
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|gboolean
name|unique
init|=
name|TRUE
decl_stmt|;
name|gchar
modifier|*
name|copy_cstr
decl_stmt|;
name|gchar
modifier|*
name|copy_test
decl_stmt|;
name|gchar
modifier|*
name|stripped_copy
decl_stmt|;
name|gint
name|counter
init|=
literal|1
decl_stmt|;
comment|/* Get bzpath structure  */
if|if
condition|(
operator|!
name|gimage
operator|||
operator|!
operator|(
name|plp
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
operator|)
condition|)
return|return
name|NULL
return|;
name|tlist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
while|while
condition|(
name|tlist
condition|)
block|{
name|gchar
modifier|*
name|test_str
init|=
operator|(
call|(
name|PATHP
call|)
argument_list|(
name|tlist
operator|->
name|data
argument_list|)
operator|)
operator|->
name|name
operator|->
name|str
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cstr
argument_list|,
name|test_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|unique
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
name|tlist
operator|=
name|g_slist_next
argument_list|(
name|tlist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|unique
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* OK Clashes with something */
comment|/* restart scan to find unique name */
name|stripped_copy
operator|=
name|strip_off_cnumber
argument_list|(
name|cstr
argument_list|)
expr_stmt|;
name|copy_cstr
operator|=
name|g_strdup_printf
argument_list|(
literal|"%s#%d"
argument_list|,
name|stripped_copy
argument_list|,
name|counter
operator|++
argument_list|)
expr_stmt|;
name|tlist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
while|while
condition|(
name|tlist
condition|)
block|{
name|copy_test
operator|=
operator|(
call|(
name|PATHP
call|)
argument_list|(
name|tlist
operator|->
name|data
argument_list|)
operator|)
operator|->
name|name
operator|->
name|str
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|copy_cstr
argument_list|,
name|copy_test
argument_list|)
operator|==
literal|0
condition|)
block|{
name|g_free
argument_list|(
name|copy_cstr
argument_list|)
expr_stmt|;
name|copy_cstr
operator|=
name|g_strdup_printf
argument_list|(
literal|"%s#%d"
argument_list|,
name|stripped_copy
argument_list|,
name|counter
operator|++
argument_list|)
expr_stmt|;
name|tlist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
continue|continue;
block|}
name|tlist
operator|=
name|g_slist_next
argument_list|(
name|tlist
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|stripped_copy
argument_list|)
expr_stmt|;
return|return
name|copy_cstr
return|;
block|}
end_function

begin_function
specifier|static
name|PATHP
DECL|function|path_copy (GimpImage * gimage,PATHP p)
name|path_copy
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|PATHP
name|p
parameter_list|)
block|{
name|PATHP
name|p_copy
init|=
name|g_new0
argument_list|(
name|PATH
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|ext
decl_stmt|;
name|ext
operator|=
name|unique_name
argument_list|(
name|gimage
argument_list|,
name|p
operator|->
name|name
operator|->
name|str
argument_list|)
expr_stmt|;
name|p_copy
operator|->
name|name
operator|=
name|g_string_new
argument_list|(
name|ext
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|ext
argument_list|)
expr_stmt|;
name|p_copy
operator|->
name|closed
operator|=
name|p
operator|->
name|closed
expr_stmt|;
name|p_copy
operator|->
name|state
operator|=
name|p
operator|->
name|state
expr_stmt|;
name|p_copy
operator|->
name|pathtype
operator|=
name|p
operator|->
name|pathtype
expr_stmt|;
name|p_copy
operator|->
name|path_details
operator|=
name|pathpoints_copy
argument_list|(
name|p
operator|->
name|path_details
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimage
condition|)
name|p_copy
operator|->
name|tattoo
operator|=
name|gimp_image_get_new_tattoo
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
else|else
name|p_copy
operator|->
name|tattoo
operator|=
name|p
operator|->
name|tattoo
expr_stmt|;
return|return
name|p_copy
return|;
block|}
end_function

begin_function
specifier|static
name|PATHPOINTP
DECL|function|path_start_last_seg (GSList * plist)
name|path_start_last_seg
parameter_list|(
name|GSList
modifier|*
name|plist
parameter_list|)
block|{
name|PATHPOINTP
name|retp
init|=
name|plist
operator|->
name|data
decl_stmt|;
while|while
condition|(
name|plist
condition|)
block|{
if|if
condition|(
operator|(
call|(
name|PATHPOINTP
call|)
argument_list|(
name|plist
operator|->
name|data
argument_list|)
operator|)
operator|->
name|type
operator|==
name|BEZIER_MOVE
operator|&&
name|g_slist_next
argument_list|(
name|plist
argument_list|)
condition|)
block|{
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
name|retp
operator|=
name|plist
operator|->
name|data
expr_stmt|;
block|}
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
return|return
name|retp
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|path_close (PATHP bzp)
name|path_close
parameter_list|(
name|PATHP
name|bzp
parameter_list|)
block|{
name|PATHPOINTP
name|pdata
decl_stmt|;
name|PATHPOINTP
name|pathpoint
decl_stmt|;
comment|/* bzpaths are only really closed when converted to the BezierSelect ones */
name|bzp
operator|->
name|closed
operator|=
literal|1
expr_stmt|;
comment|/* first point */
name|pdata
operator|=
operator|(
name|PATHPOINTP
operator|)
name|bzp
operator|->
name|path_details
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|g_slist_length
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
operator|<
literal|5
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|pathpoint
operator|=
name|g_new0
argument_list|(
name|PATHPOINT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pathpoint
operator|->
name|type
operator|=
operator|(
name|i
operator|&
literal|1
operator|)
condition|?
name|BEZIER_ANCHOR
else|:
name|BEZIER_CONTROL
expr_stmt|;
name|pathpoint
operator|->
name|x
operator|=
name|pdata
operator|->
name|x
operator|+
name|i
expr_stmt|;
name|pathpoint
operator|->
name|y
operator|=
name|pdata
operator|->
name|y
operator|+
name|i
expr_stmt|;
name|bzp
operator|->
name|path_details
operator|=
name|g_slist_append
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|,
name|pathpoint
argument_list|)
expr_stmt|;
block|}
block|}
name|pathpoint
operator|=
name|g_new0
argument_list|(
name|PATHPOINT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pdata
operator|=
name|path_start_last_seg
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|pathpoint
operator|->
name|type
operator|=
name|BEZIER_CONTROL
expr_stmt|;
name|pathpoint
operator|->
name|x
operator|=
name|pdata
operator|->
name|x
expr_stmt|;
name|pathpoint
operator|->
name|y
operator|=
name|pdata
operator|->
name|y
expr_stmt|;
comment|/*   printf("Closing to x,y %d,%d\n",(gint)pdata->x,(gint)pdata->y); */
name|bzp
operator|->
name|path_details
operator|=
name|g_slist_append
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|,
name|pathpoint
argument_list|)
expr_stmt|;
name|bzp
operator|->
name|state
operator|=
name|BEZIER_EDIT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|beziersel_free (BezierSelect * bezier_sel)
name|beziersel_free
parameter_list|(
name|BezierSelect
modifier|*
name|bezier_sel
parameter_list|)
block|{
name|bezier_select_reset
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|BezierSelect
modifier|*
DECL|function|path_to_beziersel (PATHP bzp)
name|path_to_beziersel
parameter_list|(
name|PATHP
name|bzp
parameter_list|)
block|{
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|BezierPoint
modifier|*
name|bpnt
init|=
name|NULL
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
if|if
condition|(
operator|!
name|bzp
condition|)
block|{
name|g_warning
argument_list|(
literal|"path_to_beziersel:: NULL bzp"
argument_list|)
expr_stmt|;
block|}
name|list
operator|=
name|bzp
operator|->
name|path_details
expr_stmt|;
name|bezier_sel
operator|=
name|g_new0
argument_list|(
name|BezierSelect
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bezier_sel
operator|->
name|num_points
operator|=
literal|0
expr_stmt|;
name|bezier_sel
operator|->
name|mask
operator|=
name|NULL
expr_stmt|;
name|bezier_sel
operator|->
name|core
operator|=
name|NULL
expr_stmt|;
comment|/* not required will be reset in bezier code */
name|bezier_select_reset
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_sel
operator|->
name|closed
operator|=
name|bzp
operator|->
name|closed
expr_stmt|;
comment|/*   bezier_sel->state = BEZIER_ADD; */
name|bezier_sel
operator|->
name|state
operator|=
name|bzp
operator|->
name|state
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|PATHPOINTP
name|pdata
decl_stmt|;
name|pdata
operator|=
operator|(
name|PATHPOINTP
operator|)
name|list
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|pdata
operator|->
name|type
operator|==
name|BEZIER_MOVE
condition|)
block|{
comment|/* 	  printf("Close last curve off\n"); */
name|bezier_sel
operator|->
name|last_point
operator|->
name|next
operator|=
name|bpnt
expr_stmt|;
name|bpnt
operator|->
name|prev
operator|=
name|bezier_sel
operator|->
name|last_point
expr_stmt|;
name|bezier_sel
operator|->
name|cur_anchor
operator|=
name|NULL
expr_stmt|;
name|bezier_sel
operator|->
name|cur_control
operator|=
name|NULL
expr_stmt|;
name|bpnt
operator|=
name|NULL
expr_stmt|;
block|}
name|bezier_add_point
argument_list|(
name|bezier_sel
argument_list|,
operator|(
name|gint
operator|)
name|pdata
operator|->
name|type
argument_list|,
name|rint
argument_list|(
name|pdata
operator|->
name|x
argument_list|)
argument_list|,
comment|/* ALT add rint() */
name|rint
argument_list|(
name|pdata
operator|->
name|y
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpnt
operator|==
name|NULL
condition|)
name|bpnt
operator|=
name|bezier_sel
operator|->
name|last_point
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bezier_sel
operator|->
name|closed
condition|)
block|{
name|bezier_sel
operator|->
name|last_point
operator|->
name|next
operator|=
name|bpnt
expr_stmt|;
name|bpnt
operator|->
name|prev
operator|=
name|bezier_sel
operator|->
name|last_point
expr_stmt|;
name|bezier_sel
operator|->
name|cur_anchor
operator|=
name|bezier_sel
operator|->
name|points
expr_stmt|;
name|bezier_sel
operator|->
name|cur_control
operator|=
name|bezier_sel
operator|->
name|points
operator|->
name|next
expr_stmt|;
block|}
return|return
name|bezier_sel
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|pathimagelist_free (PATHIMAGELISTP iml)
name|pathimagelist_free
parameter_list|(
name|PATHIMAGELISTP
name|iml
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|iml
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iml
operator|->
name|bz_paths
condition|)
block|{
name|g_slist_foreach
argument_list|(
name|iml
operator|->
name|bz_paths
argument_list|,
name|path_free
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_slist_free
argument_list|(
name|iml
operator|->
name|bz_paths
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|iml
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|bz_change_name_row_to (gint row,gchar * text)
name|bz_change_name_row_to
parameter_list|(
name|gint
name|row
parameter_list|,
name|gchar
modifier|*
name|text
parameter_list|)
block|{
name|PATHWIDGETP
name|pwidget
decl_stmt|;
name|pwidget
operator|=
operator|(
name|PATHWIDGETP
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pwidget
condition|)
return|return;
name|g_string_free
argument_list|(
name|pwidget
operator|->
name|bzp
operator|->
name|name
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|pwidget
operator|->
name|bzp
operator|->
name|name
operator|=
name|g_string_new
argument_list|(
name|text
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_set_dash_line (GdkGC * gc,gboolean state)
name|paths_set_dash_line
parameter_list|(
name|GdkGC
modifier|*
name|gc
parameter_list|,
name|gboolean
name|state
parameter_list|)
block|{
name|gdk_gc_set_foreground
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
operator|&
name|paths_dialog
operator|->
name|black
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
condition|)
block|{
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
literal|0
argument_list|,
name|GDK_LINE_ON_OFF_DASH
argument_list|,
name|GDK_CAP_BUTT
argument_list|,
name|GDK_JOIN_ROUND
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
literal|0
argument_list|,
name|GDK_LINE_SOLID
argument_list|,
name|GDK_CAP_BUTT
argument_list|,
name|GDK_JOIN_ROUND
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|clear_pixmap_preview (PATHWIDGETP pwidget)
name|clear_pixmap_preview
parameter_list|(
name|PATHWIDGETP
name|pwidget
parameter_list|)
block|{
name|gchar
modifier|*
name|rgb_buf
decl_stmt|;
name|rgb_buf
operator|=
name|g_new0
argument_list|(
name|gchar
argument_list|,
operator|(
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
operator|)
operator|*
operator|(
name|paths_dialog
operator|->
name|image_height
operator|+
literal|4
operator|)
operator|*
literal|3
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|rgb_buf
argument_list|,
literal|0xFF
argument_list|,
operator|(
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
operator|)
operator|*
operator|(
name|paths_dialog
operator|->
name|image_height
operator|+
literal|4
operator|)
operator|*
literal|3
argument_list|)
expr_stmt|;
name|gdk_draw_rgb_image
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|paths_dialog
operator|->
name|gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|4
argument_list|,
name|GDK_RGB_DITHER_NORMAL
argument_list|,
name|rgb_buf
argument_list|,
operator|(
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
operator|)
operator|*
literal|3
argument_list|)
expr_stmt|;
name|paths_set_dash_line
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|paths_dialog
operator|->
name|gc
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|image_width
operator|+
literal|3
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|3
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|paths_dialog
operator|->
name|gc
argument_list|,
name|FALSE
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|paths_dialog
operator|->
name|image_width
operator|+
literal|1
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* insrow == -1 -> append else insert at insrow */
end_comment

begin_function
DECL|function|paths_add_path (PATHP bzp,gint insrow)
name|void
name|paths_add_path
parameter_list|(
name|PATHP
name|bzp
parameter_list|,
name|gint
name|insrow
parameter_list|)
block|{
comment|/* Create a new entry in the list */
name|PATHWIDGETP
name|pwidget
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|gchar
modifier|*
name|row_data
index|[
literal|2
index|]
decl_stmt|;
name|GdkBitmap
modifier|*
name|mask
decl_stmt|;
name|pwidget
operator|=
name|g_new0
argument_list|(
name|PATHWIDGET
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|GTK_WIDGET_REALIZED
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
condition|)
name|gtk_widget_realize
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
expr_stmt|;
name|paths_dialog_preview_extents
argument_list|()
expr_stmt|;
if|if
condition|(
name|preview_size
condition|)
block|{
comment|/* Need to add this to the list */
name|pwidget
operator|->
name|paths_pixmap
operator|=
name|gdk_pixmap_new
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|4
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|clear_pixmap_preview
argument_list|(
name|pwidget
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|paths_dialog
operator|->
name|pixmap_normal
condition|)
block|{
name|paths_dialog
operator|->
name|pixmap_normal
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
name|path_bits
argument_list|,
name|paths_dialog
operator|->
name|image_width
argument_list|,
name|paths_dialog
operator|->
name|image_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|pixmap_selected
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
name|path_bits
argument_list|,
name|paths_dialog
operator|->
name|image_width
argument_list|,
name|paths_dialog
operator|->
name|image_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|)
expr_stmt|;
block|}
name|pwidget
operator|->
name|paths_pixmap
operator|=
name|paths_dialog
operator|->
name|pixmap_normal
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|paths_dialog
operator|->
name|pixmap_locked
condition|)
block|{
name|paths_dialog
operator|->
name|pixmap_locked
operator|=
name|gdk_pixmap_create_from_xpm_d
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
operator|&
name|mask
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|locked_xpm
argument_list|)
expr_stmt|;
block|}
name|gtk_clist_set_row_height
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|6
argument_list|)
expr_stmt|;
name|row_data
index|[
literal|0
index|]
operator|=
literal|""
expr_stmt|;
name|row_data
index|[
literal|1
index|]
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|insrow
operator|==
operator|-
literal|1
condition|)
name|row
operator|=
name|gtk_clist_append
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row_data
argument_list|)
expr_stmt|;
else|else
name|row
operator|=
name|gtk_clist_insert
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|insrow
argument_list|,
name|row_data
argument_list|)
expr_stmt|;
name|gtk_clist_set_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|1
argument_list|,
name|bzp
operator|->
name|name
operator|->
name|str
argument_list|,
literal|2
argument_list|,
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_clist_set_row_data_full
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
operator|(
name|gpointer
operator|)
name|pwidget
argument_list|,
name|clear_pathwidget
argument_list|)
expr_stmt|;
name|gtk_signal_handler_block
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_signal_handler_unblock
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|pwidget
operator|->
name|bzp
operator|=
name|bzp
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_preview_extents ()
name|paths_dialog_preview_extents
parameter_list|()
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
expr_stmt|;
name|paths_dialog
operator|->
name|gimage_width
operator|=
name|gimage
operator|->
name|width
expr_stmt|;
name|paths_dialog
operator|->
name|gimage_height
operator|=
name|gimage
operator|->
name|height
expr_stmt|;
comment|/*  Get the image width and height variables, based on the gimage  */
if|if
condition|(
name|gimage
operator|->
name|width
operator|>
name|gimage
operator|->
name|height
condition|)
name|paths_dialog
operator|->
name|ratio
operator|=
operator|(
name|double
operator|)
name|preview_size
operator|/
operator|(
name|double
operator|)
name|gimage
operator|->
name|width
expr_stmt|;
else|else
name|paths_dialog
operator|->
name|ratio
operator|=
operator|(
name|double
operator|)
name|preview_size
operator|/
operator|(
name|double
operator|)
name|gimage
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|preview_size
condition|)
block|{
name|paths_dialog
operator|->
name|image_width
operator|=
call|(
name|int
call|)
argument_list|(
name|paths_dialog
operator|->
name|ratio
operator|*
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|image_height
operator|=
call|(
name|int
call|)
argument_list|(
name|paths_dialog
operator|->
name|ratio
operator|*
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|paths_dialog
operator|->
name|image_width
operator|<
literal|1
condition|)
name|paths_dialog
operator|->
name|image_width
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|paths_dialog
operator|->
name|image_height
operator|<
literal|1
condition|)
name|paths_dialog
operator|->
name|image_height
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|paths_dialog
operator|->
name|image_width
operator|=
name|path_width
expr_stmt|;
name|paths_dialog
operator|->
name|image_height
operator|=
name|path_height
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|path_widget_preview_events (GtkWidget * widget,GdkEvent * event)
name|path_widget_preview_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_BUTTON_PRESS
case|:
comment|/*  Control-button press disables the application of the mask  */
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
break|break;
case|case
name|GDK_EXPOSE
case|:
if|if
condition|(
name|preview_size
condition|)
block|{
comment|/* 	  layer_widget_preview_redraw (layer_widget, preview_type); */
comment|/* 	  gdk_draw_pixmap (widget->window, */
comment|/* 			   widget->style->black_gc, */
comment|/* 			   *pixmap, */
comment|/* 			   0, 0, 2, 2, */
comment|/* 			   layersD->image_width, */
comment|/* 			   layersD->image_height); */
block|}
break|break;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_select_row (GtkWidget * widget,gint row,gint column,GdkEventButton * event,gpointer data)
name|paths_select_row
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|row
parameter_list|,
name|gint
name|column
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|PATHWIDGETP
name|pwidget
decl_stmt|;
name|PATHP
name|bzp
decl_stmt|;
name|BezierSelect
modifier|*
name|bsel
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gint
name|last_row
decl_stmt|;
name|pwidget
operator|=
operator|(
name|PATHWIDGETP
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|widget
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pwidget
operator|||
operator|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|==
name|row
operator|&&
name|paths_dialog
operator|->
name|been_selected
operator|==
name|TRUE
operator|)
condition|)
block|{
if|if
condition|(
name|column
condition|)
return|return;
block|}
name|last_row
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|bzp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|column
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bzp
operator|->
name|locked
operator|==
literal|0
condition|)
block|{
name|bzp
operator|->
name|locked
operator|=
literal|1
expr_stmt|;
name|gtk_clist_set_pixmap
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|pixmap_locked
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gint
name|tmprow
decl_stmt|;
name|bzp
operator|->
name|locked
operator|=
literal|0
expr_stmt|;
name|gtk_clist_set_text
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* There should be an easier way of updating the preview! */
name|bsel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
block|}
comment|/* Put hightlight back on the old original selection */
name|gtk_signal_handler_block
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|last_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_signal_handler_unblock
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
return|return;
block|}
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|paths_dialog
operator|->
name|been_selected
operator|=
name|TRUE
expr_stmt|;
name|bsel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gdisp
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gdisp
condition|)
block|{
name|g_warning
argument_list|(
literal|"Lost image which bezier curve belonged to"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bsel
argument_list|)
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_unselect_row (GtkWidget * widget,gint row,gint column,GdkEventButton * event,gpointer data)
name|paths_unselect_row
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|row
parameter_list|,
name|gint
name|column
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|PATHWIDGETP
name|pwidget
decl_stmt|;
name|pwidget
operator|=
operator|(
name|PATHWIDGETP
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|widget
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pwidget
condition|)
return|return;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_update (GimpImage * gimage)
name|paths_dialog_update
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|PATHIMAGELISTP
name|new_path_list
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
name|gint
name|loop
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
operator|||
operator|!
name|gimage
condition|)
return|return;
comment|/* The last pointer comparison forces update if something has changed    * under our feet.    */
if|if
condition|(
operator|!
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
condition|)
block|{
comment|/* No paths is this layer */
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|paths_dialog
operator|->
name|gimage
operator|==
name|gimage
operator|&&
name|paths_dialog
operator|->
name|current_path_list
operator|==
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
condition|)
return|return;
name|paths_dialog
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
name|paths_dialog_preview_extents
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|GTK_WIDGET_REALIZED
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
condition|)
name|gtk_widget_realize
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
expr_stmt|;
comment|/* ALT removed& replaced return;*/
comment|/* clear clist out */
name|gtk_clist_freeze
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_clist_clear
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_clist_thaw
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Find bz list */
name|new_path_list
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|new_path_list
expr_stmt|;
name|paths_dialog
operator|->
name|been_selected
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|!
name|new_path_list
condition|)
block|{
comment|/* No list assoc with this image */
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
operator|(
name|copy_pp
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
comment|/* update the clist to reflect this images bz list */
comment|/* go around the image list populating the clist */
if|if
condition|(
name|gimage
operator|!=
name|new_path_list
operator|->
name|gimage
condition|)
block|{
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"paths list: internal list error"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|plist
operator|=
name|new_path_list
operator|->
name|bz_paths
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
while|while
condition|(
name|plist
condition|)
block|{
name|paths_update_paths
argument_list|(
name|plist
operator|->
name|data
argument_list|,
name|loop
argument_list|)
expr_stmt|;
name|loop
operator|++
expr_stmt|;
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
comment|/* select last one */
name|gtk_signal_handler_block
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_signal_handler_unblock
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|gtk_clist_moveto
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|0
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_update_paths (gpointer data,gint row)
name|paths_update_paths
parameter_list|(
name|gpointer
name|data
parameter_list|,
name|gint
name|row
parameter_list|)
block|{
name|PATHP
name|bzp
decl_stmt|;
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|paths_add_path
argument_list|(
operator|(
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|data
operator|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|bzp
operator|->
name|locked
condition|)
name|gtk_clist_set_pixmap
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|pixmap_locked
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|do_rename_paths_callback (GtkWidget * widget,gpointer call_data,gpointer client_data)
name|do_rename_paths_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|call_data
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|gchar
modifier|*
name|text
decl_stmt|;
name|GdkBitmap
modifier|*
name|mask
decl_stmt|;
name|guint8
name|spacing
decl_stmt|;
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|GTK_CLIST
argument_list|(
name|call_data
argument_list|)
operator|->
name|selection
operator|)
condition|)
return|return;
name|text
operator|=
name|g_strdup
argument_list|(
name|client_data
argument_list|)
expr_stmt|;
name|gtk_clist_get_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
operator|&
name|spacing
argument_list|,
operator|&
name|pixmap
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
name|gtk_clist_set_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|call_data
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|,
literal|1
argument_list|,
name|text
argument_list|,
name|spacing
argument_list|,
name|pixmap
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|bz_change_name_row_to
argument_list|(
name|paths_dialog
operator|->
name|selected_row_num
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_edit_path_query (GtkWidget * widget)
name|paths_dialog_edit_path_query
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
block|{
name|gchar
modifier|*
name|text
decl_stmt|;
name|gint
name|ret
decl_stmt|;
name|GdkBitmap
modifier|*
name|mask
decl_stmt|;
comment|/* Get the current name */
name|ret
operator|=
name|gtk_clist_get_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|,
literal|1
argument_list|,
operator|&
name|text
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
name|query_string_box
argument_list|(
name|_
argument_list|(
literal|"Rename path"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Enter a new name for the path"
argument_list|)
argument_list|,
name|text
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|do_rename_paths_callback
argument_list|,
name|widget
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|paths_list_events (GtkWidget * widget,GdkEvent * event)
name|paths_list_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|GdkEventKey
modifier|*
name|kevent
decl_stmt|;
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
specifier|static
name|gint
name|last_row
init|=
operator|-
literal|1
decl_stmt|;
name|gint
name|this_colunm
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_BUTTON_PRESS
case|:
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
operator|!
name|gtk_clist_get_selection_info
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
operator|&
name|last_row
argument_list|,
operator|&
name|this_colunm
argument_list|)
condition|)
name|last_row
operator|=
operator|-
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|!=
name|last_row
condition|)
name|last_row
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|bevent
operator|->
name|button
operator|==
literal|3
operator|||
name|bevent
operator|->
name|button
operator|==
literal|2
condition|)
name|gtk_menu_popup
argument_list|(
name|GTK_MENU
argument_list|(
name|paths_dialog
operator|->
name|ops_menu
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|bevent
operator|->
name|button
argument_list|,
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_2BUTTON_PRESS
case|:
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
name|last_row
operator|!=
operator|-
literal|1
operator|&&
name|gtk_clist_get_selection_info
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
name|NULL
argument_list|,
operator|&
name|this_colunm
argument_list|)
condition|)
block|{
if|if
condition|(
name|this_colunm
operator|==
literal|1
condition|)
block|{
name|paths_dialog_edit_path_query
argument_list|(
name|widget
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
else|else
return|return
name|FALSE
return|;
block|}
else|else
return|return
name|FALSE
return|;
case|case
name|GDK_KEY_PRESS
case|:
name|kevent
operator|=
operator|(
name|GdkEventKey
operator|*
operator|)
name|event
expr_stmt|;
switch|switch
condition|(
name|kevent
operator|->
name|keyval
condition|)
block|{
case|case
name|GDK_Up
case|:
name|printf
argument_list|(
literal|"up arrow\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_Down
case|:
name|printf
argument_list|(
literal|"down arrow\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|PATHIMAGELISTP
DECL|function|path_add_to_current (PATHIMAGELISTP pip,PATHP bzp,GimpImage * gimage,gint pos)
name|path_add_to_current
parameter_list|(
name|PATHIMAGELISTP
name|pip
parameter_list|,
name|PATHP
name|bzp
parameter_list|,
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|pos
parameter_list|)
block|{
comment|/* add bzp to current list */
if|if
condition|(
operator|!
name|pip
condition|)
block|{
comment|/* This image does not have a list */
name|pip
operator|=
name|pathsList_new
argument_list|(
name|gimage
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* add to gimage */
name|gimp_image_set_paths
argument_list|(
name|gimage
argument_list|,
name|pip
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|<
literal|0
condition|)
name|pip
operator|->
name|bz_paths
operator|=
name|g_slist_append
argument_list|(
name|pip
operator|->
name|bz_paths
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
else|else
name|pip
operator|->
name|bz_paths
operator|=
name|g_slist_insert
argument_list|(
name|pip
operator|->
name|bz_paths
argument_list|,
name|bzp
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
name|pip
return|;
block|}
end_function

begin_function
specifier|static
name|PATHP
DECL|function|paths_dialog_new_path (PATHIMAGELISTP * plp,gpointer points,GimpImage * gimage,gint pos)
name|paths_dialog_new_path
parameter_list|(
name|PATHIMAGELISTP
modifier|*
name|plp
parameter_list|,
name|gpointer
name|points
parameter_list|,
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|pos
parameter_list|)
block|{
specifier|static
name|gint
name|nseed
init|=
literal|0
decl_stmt|;
name|PATHP
name|bzp
init|=
name|path_dialog_new
argument_list|(
name|gimage
argument_list|,
name|nseed
operator|++
argument_list|,
name|points
argument_list|)
decl_stmt|;
operator|*
name|plp
operator|=
name|path_add_to_current
argument_list|(
operator|*
name|plp
argument_list|,
name|bzp
argument_list|,
name|gimage
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
operator|(
name|bzp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_new_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_new_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|PATHP
name|bzp
init|=
name|paths_dialog_new_path
argument_list|(
operator|&
name|paths_dialog
operator|->
name|current_path_list
argument_list|,
name|NULL
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|)
decl_stmt|;
name|paths_add_path
argument_list|(
name|bzp
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|)
expr_stmt|;
comment|/* Enable the buttons!*/
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
operator|(
name|copy_pp
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_delete_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_delete_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|PATHP
name|bzp
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|gboolean
name|new_sz
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure& delete its content */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Remove from list */
name|plp
operator|->
name|bz_paths
operator|=
name|g_slist_remove
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
name|new_sz
operator|=
operator|(
name|g_slist_length
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|)
operator|>
literal|0
operator|)
expr_stmt|;
name|path_free
argument_list|(
name|bzp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* If now empty free everything up */
if|if
condition|(
operator|!
name|plp
operator|->
name|bz_paths
operator|||
name|g_slist_length
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gtk_signal_disconnect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|plp
operator|->
name|gimage
argument_list|)
argument_list|,
name|plp
operator|->
name|sig_id
argument_list|)
expr_stmt|;
name|gimp_image_set_paths
argument_list|(
name|plp
operator|->
name|gimage
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pathimagelist_free
argument_list|(
name|plp
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Do this last since it might cause a new row to become selected */
comment|/* Remove from the clist ... */
name|gtk_clist_remove
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|new_sz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_paste_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_paste_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|PATHP
name|bzp
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|PATHPOINTP
name|pp
decl_stmt|;
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|copy_pp
condition|)
return|return;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|bzp
operator|->
name|path_details
condition|)
block|{
name|pp
operator|=
name|bzp
operator|->
name|path_details
operator|->
name|data
expr_stmt|;
name|pp
operator|->
name|type
operator|=
name|BEZIER_MOVE
expr_stmt|;
name|bzp
operator|->
name|path_details
operator|=
name|g_slist_concat
argument_list|(
name|copy_pp
operator|->
name|path_details
argument_list|,
name|bzp
operator|->
name|path_details
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bzp
operator|->
name|closed
operator|=
name|TRUE
expr_stmt|;
name|bzp
operator|->
name|path_details
operator|=
name|copy_pp
operator|->
name|path_details
expr_stmt|;
name|bzp
operator|->
name|state
operator|=
name|copy_pp
operator|->
name|state
expr_stmt|;
block|}
comment|/* First point on new curve is a moveto */
name|copy_pp
operator|->
name|path_details
operator|=
name|NULL
expr_stmt|;
name|path_free
argument_list|(
name|copy_pp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|copy_pp
operator|=
name|NULL
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gdisp
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_copy_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_copy_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|PATHP
name|bzp
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bzp
operator|->
name|path_details
operator|||
name|g_slist_length
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
operator|<=
literal|5
condition|)
return|return;
comment|/* And store in static array */
name|copy_pp
operator|=
name|path_copy
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
comment|/* All paths that are in the cut buffer must be closed */
if|if
condition|(
operator|!
name|copy_pp
operator|->
name|closed
condition|)
name|path_close
argument_list|(
name|copy_pp
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_dup_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_dup_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|PATHP
name|bzp
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Insert at the current position */
name|bzp
operator|=
name|path_copy
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
name|plp
operator|->
name|bz_paths
operator|=
name|g_slist_insert
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|bzp
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzp
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_path_to_sel_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_path_to_sel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|PATHP
name|bzp
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Now do the selection....*/
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gdisp
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bzp
operator|->
name|closed
condition|)
block|{
name|PATHP
name|bzpcopy
init|=
name|path_copy
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|bzp
argument_list|)
decl_stmt|;
comment|/* Close it */
name|path_close
argument_list|(
name|bzpcopy
argument_list|)
expr_stmt|;
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzpcopy
argument_list|)
expr_stmt|;
name|path_free
argument_list|(
name|bzpcopy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|bezier_to_selection
argument_list|(
name|bezier_sel
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
comment|/* Force display to show no closed curve */
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|bezier_to_selection
argument_list|(
name|bezier_sel
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_stroke_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_stroke_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|PATHP
name|bzp
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Now do the stroke....*/
name|paths_stroke
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_map_callback (GtkWidget * w,gpointer client_data)
name|paths_dialog_map_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
name|gtk_window_add_accel_group
argument_list|(
name|GTK_WINDOW
argument_list|(
name|gtk_widget_get_toplevel
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|accel_group
argument_list|)
expr_stmt|;
name|paths_dialog_preview_extents
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_unmap_callback (GtkWidget * w,gpointer client_data)
name|paths_dialog_unmap_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
name|gtk_window_remove_accel_group
argument_list|(
name|GTK_WINDOW
argument_list|(
name|gtk_widget_get_toplevel
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|accel_group
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_destroy_cb (GimpImage * gimage)
name|paths_dialog_destroy_cb
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|PATHIMAGELISTP
name|new_path_list
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
if|if
condition|(
name|paths_dialog
operator|->
name|current_path_list
operator|&&
name|gimage
operator|==
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gimage
condition|)
block|{
comment|/* showing could be last so remove here.. might get  	 done again if not the last one       */
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|NULL
expr_stmt|;
name|paths_dialog
operator|->
name|been_selected
operator|=
name|FALSE
expr_stmt|;
name|gtk_clist_freeze
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_clist_clear
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_clist_thaw
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Find bz list */
name|new_path_list
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_path_list
condition|)
return|return;
comment|/* Already removed - signal handler jsut left in the air */
name|pathimagelist_free
argument_list|(
name|new_path_list
argument_list|)
expr_stmt|;
name|gimp_image_set_paths
argument_list|(
name|gimage
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Functions used from the bezier code .. tie in with this code */
end_comment

begin_function
specifier|static
name|void
DECL|function|pathpoints_free (GSList * list)
name|pathpoints_free
parameter_list|(
name|GSList
modifier|*
name|list
parameter_list|)
block|{
if|if
condition|(
operator|!
name|list
condition|)
return|return;
name|g_slist_foreach
argument_list|(
name|list
argument_list|,
name|pathpoint_free
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_slist_free
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|GSList
modifier|*
DECL|function|pathpoints_create (BezierSelect * sel)
name|pathpoints_create
parameter_list|(
name|BezierSelect
modifier|*
name|sel
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|GSList
modifier|*
name|list
init|=
name|NULL
decl_stmt|;
name|PATHPOINTP
name|pathpoint
decl_stmt|;
name|BezierPoint
modifier|*
name|pts
init|=
operator|(
name|BezierPoint
operator|*
operator|)
name|sel
operator|->
name|points
decl_stmt|;
name|BezierPoint
modifier|*
name|start_pnt
init|=
name|pts
decl_stmt|;
name|gint
name|need_move
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sel
operator|->
name|num_points
condition|;
name|i
operator|++
control|)
block|{
name|pathpoint
operator|=
name|pathpoint_new
argument_list|(
operator|(
name|need_move
operator|)
condition|?
name|BEZIER_MOVE
else|:
name|pts
operator|->
name|type
argument_list|,
operator|(
name|gdouble
operator|)
name|pts
operator|->
name|x
argument_list|,
operator|(
name|gdouble
operator|)
name|pts
operator|->
name|y
argument_list|)
expr_stmt|;
name|need_move
operator|=
literal|0
expr_stmt|;
name|list
operator|=
name|g_slist_append
argument_list|(
name|list
argument_list|,
name|pathpoint
argument_list|)
expr_stmt|;
if|if
condition|(
name|pts
operator|->
name|next_curve
condition|)
block|{
comment|/* The curve must loop back on itself */
if|if
condition|(
name|start_pnt
operator|!=
name|pts
operator|->
name|next
condition|)
name|g_warning
argument_list|(
literal|"Curve of of sync"
argument_list|)
expr_stmt|;
name|need_move
operator|=
literal|1
expr_stmt|;
name|pts
operator|=
name|pts
operator|->
name|next_curve
expr_stmt|;
name|start_pnt
operator|=
name|pts
expr_stmt|;
block|}
else|else
block|{
name|pts
operator|=
name|pts
operator|->
name|next
expr_stmt|;
block|}
block|}
return|return
operator|(
name|list
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|GSList
modifier|*
DECL|function|pathpoints_copy (GSList * list)
name|pathpoints_copy
parameter_list|(
name|GSList
modifier|*
name|list
parameter_list|)
block|{
name|GSList
modifier|*
name|slcopy
init|=
name|NULL
decl_stmt|;
name|PATHPOINTP
name|pdata
decl_stmt|;
name|PATHPOINTP
name|pathpoint
decl_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|pathpoint
operator|=
name|g_new0
argument_list|(
name|PATHPOINT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pdata
operator|=
operator|(
name|PATHPOINTP
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|pathpoint
operator|->
name|type
operator|=
name|pdata
operator|->
name|type
expr_stmt|;
name|pathpoint
operator|->
name|x
operator|=
name|pdata
operator|->
name|x
expr_stmt|;
name|pathpoint
operator|->
name|y
operator|=
name|pdata
operator|->
name|y
expr_stmt|;
name|slcopy
operator|=
name|g_slist_append
argument_list|(
name|slcopy
argument_list|,
name|pathpoint
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
return|return
name|slcopy
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_update_bzpath (PATHIMAGELISTP plp,BezierSelect * bezier_sel)
name|paths_update_bzpath
parameter_list|(
name|PATHIMAGELISTP
name|plp
parameter_list|,
name|BezierSelect
modifier|*
name|bezier_sel
parameter_list|)
block|{
name|PATHP
name|p
decl_stmt|;
name|p
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|plp
operator|->
name|last_selected_row
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|path_details
condition|)
name|pathpoints_free
argument_list|(
name|p
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|p
operator|->
name|path_details
operator|=
name|pathpoints_create
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|p
operator|->
name|closed
operator|=
name|bezier_sel
operator|->
name|closed
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|bezier_sel
operator|->
name|state
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|paths_replaced_current (PATHIMAGELISTP plp,BezierSelect * bezier_sel)
name|paths_replaced_current
parameter_list|(
name|PATHIMAGELISTP
name|plp
parameter_list|,
name|BezierSelect
modifier|*
name|bezier_sel
parameter_list|)
block|{
comment|/* Is there a currently selected path in this image? */
comment|/* ALT if(paths_dialog&& plp&&  */
if|if
condition|(
name|plp
operator|&&
name|plp
operator|->
name|last_selected_row
operator|>=
literal|0
condition|)
block|{
name|paths_update_bzpath
argument_list|(
name|plp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|number_curves_in_path (GSList * plist)
name|number_curves_in_path
parameter_list|(
name|GSList
modifier|*
name|plist
parameter_list|)
block|{
name|gint
name|count
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|plist
condition|)
block|{
if|if
condition|(
operator|(
call|(
name|PATHPOINTP
call|)
argument_list|(
name|plist
operator|->
name|data
argument_list|)
operator|)
operator|->
name|type
operator|==
name|BEZIER_MOVE
operator|&&
name|g_slist_next
argument_list|(
name|plist
argument_list|)
condition|)
block|{
name|count
operator|++
expr_stmt|;
block|}
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_draw_segment_points (BezierSelect * bezier_sel,GdkPoint * pnt,int npoints,gpointer udata)
name|paths_draw_segment_points
parameter_list|(
name|BezierSelect
modifier|*
name|bezier_sel
parameter_list|,
name|GdkPoint
modifier|*
name|pnt
parameter_list|,
name|int
name|npoints
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
comment|/*     * hopefully the image points are already in image space co-ords.    * so just scale by ratio factor and draw 'em    */
name|gint
name|loop
decl_stmt|;
name|gint
name|pcount
init|=
literal|0
decl_stmt|;
name|GdkPoint
modifier|*
name|copy_pnt
init|=
name|g_new
argument_list|(
name|GdkPoint
argument_list|,
name|npoints
argument_list|)
decl_stmt|;
name|GdkPoint
modifier|*
name|cur_pnt
init|=
name|copy_pnt
decl_stmt|;
name|GdkPoint
modifier|*
name|last_pnt
init|=
name|NULL
decl_stmt|;
name|PATHWIDGETP
name|pwidget
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|PATHCOUNTSP
name|curve_count
init|=
operator|(
name|PATHCOUNTSP
operator|)
name|udata
decl_stmt|;
comment|/* we could remove duplicate points here */
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
name|npoints
condition|;
name|loop
operator|++
control|)
block|{
comment|/* The "2" is because we have a boarder */
name|cur_pnt
operator|->
name|x
operator|=
literal|2
operator|+
call|(
name|int
call|)
argument_list|(
name|paths_dialog
operator|->
name|ratio
operator|*
name|pnt
operator|->
name|x
argument_list|)
expr_stmt|;
name|cur_pnt
operator|->
name|y
operator|=
literal|2
operator|+
call|(
name|int
call|)
argument_list|(
name|paths_dialog
operator|->
name|ratio
operator|*
name|pnt
operator|->
name|y
argument_list|)
expr_stmt|;
name|pnt
operator|++
expr_stmt|;
if|if
condition|(
name|last_pnt
operator|&&
name|last_pnt
operator|->
name|x
operator|==
name|cur_pnt
operator|->
name|x
operator|&&
name|last_pnt
operator|->
name|y
operator|==
name|cur_pnt
operator|->
name|y
condition|)
block|{
comment|/* same as last ... don't need this one */
continue|continue;
block|}
comment|/*       printf("converting %d [%d,%d] => [%d,%d]\n", */
comment|/* 	     pcount,(int)pnt->x,(int)pnt->y,(int)cur_pnt->x,(int)cur_pnt->y); */
name|last_pnt
operator|=
name|cur_pnt
expr_stmt|;
name|pcount
operator|++
expr_stmt|;
name|cur_pnt
operator|++
expr_stmt|;
block|}
name|row
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|pwidget
operator|=
operator|(
name|PATHWIDGETP
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcount
operator|==
literal|0
condition|)
return|return;
name|g_return_if_fail
argument_list|(
name|pwidget
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|curve_count
operator|->
name|c_count
operator|.
name|count
operator|<
name|curve_count
operator|->
name|total_count
operator|||
name|bezier_sel
operator|->
name|closed
condition|)
name|paths_set_dash_line
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
else|else
name|paths_set_dash_line
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gdk_draw_lines
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|paths_dialog
operator|->
name|gc
argument_list|,
name|copy_pnt
argument_list|,
name|pcount
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|copy_pnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_update_preview (BezierSelect * bezier_sel)
name|paths_update_preview
parameter_list|(
name|BezierSelect
modifier|*
name|bezier_sel
parameter_list|)
block|{
name|gint
name|row
decl_stmt|;
name|PATHCOUNTS
name|curve_count
decl_stmt|;
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|current_path_list
operator|&&
operator|(
name|row
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|)
operator|>=
literal|0
operator|&&
name|preview_size
condition|)
block|{
name|PATHWIDGETP
name|pwidget
decl_stmt|;
name|pwidget
operator|=
operator|(
name|PATHWIDGETP
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Clear pixmap */
name|clear_pixmap_preview
argument_list|(
name|pwidget
argument_list|)
expr_stmt|;
name|curve_count
operator|.
name|total_count
operator|=
name|number_curves_in_path
argument_list|(
name|pwidget
operator|->
name|bzp
operator|->
name|path_details
argument_list|)
expr_stmt|;
comment|/* update .. */
name|bezier_draw_curve
argument_list|(
name|bezier_sel
argument_list|,
name|paths_draw_segment_points
argument_list|,
name|IMAGE_COORDS
argument_list|,
operator|&
name|curve_count
argument_list|)
expr_stmt|;
comment|/* update the pixmap */
name|gtk_clist_set_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|1
argument_list|,
name|pwidget
operator|->
name|bzp
operator|->
name|name
operator|->
name|str
argument_list|,
literal|2
argument_list|,
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_new_point_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_new_point_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|bezier_select_mode
argument_list|(
name|EXTEND_NEW
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_add_point_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_add_point_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|bezier_select_mode
argument_list|(
name|EXTEND_ADD
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_delete_point_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_delete_point_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|bezier_select_mode
argument_list|(
name|EXTEND_REMOVE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_edit_point_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_edit_point_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|bezier_select_mode
argument_list|(
name|EXTEND_EDIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_flush ()
name|paths_dialog_flush
parameter_list|()
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
expr_stmt|;
if|if
condition|(
operator|(
name|gimage
operator|->
name|width
operator|!=
name|paths_dialog
operator|->
name|gimage_width
operator|)
operator|||
operator|(
name|gimage
operator|->
name|height
operator|!=
name|paths_dialog
operator|->
name|gimage_height
operator|)
condition|)
block|{
name|paths_dialog
operator|->
name|gimage
operator|=
name|NULL
expr_stmt|;
name|paths_dialog_update
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|paths_first_button_press (BezierSelect * bezier_sel,GDisplay * gdisp)
name|paths_first_button_press
parameter_list|(
name|BezierSelect
modifier|*
name|bezier_sel
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
comment|/* First time a button is pressed in this display */
comment|/* We have two choices here       Either:-      1) We already have a paths item in the list.          => In this case the new one replaces the current entry. We 	need a callback into the bezier code to free things up.      2) We don't have an entry.          => Create a new one and add this curve.       In either case we need to update the preview widget..       All this of course depends on the fact that gdisp is the same      as before.    */
name|PATHP
name|bzp
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
if|if
condition|(
name|paths_dialog
condition|)
block|{
name|paths_dialog
operator|->
name|been_selected
operator|=
name|FALSE
expr_stmt|;
comment|/*ALT return;*/
block|}
comment|/* Button not pressed in this image...    * find which one it was pressed in if any.    */
name|plp
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
comment|/* Since beziers are part of the save format.. make the image dirty */
comment|/*   gimp_image_dirty(gdisp->gimage); */
if|if
condition|(
operator|!
name|paths_replaced_current
argument_list|(
name|plp
argument_list|,
name|bezier_sel
argument_list|)
condition|)
block|{
name|bzp
operator|=
name|paths_dialog_new_path
argument_list|(
operator|&
name|plp
argument_list|,
name|pathpoints_create
argument_list|(
name|bezier_sel
argument_list|)
argument_list|,
name|gdisp
operator|->
name|gimage
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bzp
operator|->
name|closed
operator|=
name|bezier_sel
operator|->
name|closed
expr_stmt|;
name|bzp
operator|->
name|state
operator|=
name|bezier_sel
operator|->
name|state
expr_stmt|;
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|gimage
operator|==
name|gdisp
operator|->
name|gimage
condition|)
block|{
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|plp
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzp
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
DECL|function|paths_newpoint_current (BezierSelect * bezier_sel,GDisplay * gdisp)
name|paths_newpoint_current
parameter_list|(
name|BezierSelect
modifier|*
name|bezier_sel
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
comment|/* Check if currently showing the paths we are updating */
if|if
condition|(
name|paths_dialog
operator|&&
name|gdisp
operator|->
name|gimage
operator|==
name|paths_dialog
operator|->
name|gimage
condition|)
block|{
comment|/* Enable the buttons!*/
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
operator|(
name|copy_pp
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
name|paths_first_button_press
argument_list|(
name|bezier_sel
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_new_bezier_select_tool ()
name|paths_new_bezier_select_tool
parameter_list|()
block|{
if|if
condition|(
name|paths_dialog
condition|)
name|paths_dialog
operator|->
name|been_selected
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************/
end_comment

begin_comment
comment|/* Code to serialise the bezier curves.  * The curves will be saved out in XCF property format.  * The "save as XCF format" will prompt to save the curves away.  *  * Note the save should really used PDB function to get the  * curves etc. But I have yet to do those 8-)  */
end_comment

begin_comment
comment|/**************************************************************/
end_comment

begin_function
name|PATHPOINTP
DECL|function|pathpoint_new (gint type,gdouble x,gdouble y)
name|pathpoint_new
parameter_list|(
name|gint
name|type
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
block|{
name|PATHPOINTP
name|pathpoint
init|=
name|g_new0
argument_list|(
name|PATHPOINT
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|pathpoint
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|pathpoint
operator|->
name|x
operator|=
name|x
expr_stmt|;
name|pathpoint
operator|->
name|y
operator|=
name|y
expr_stmt|;
return|return
operator|(
name|pathpoint
operator|)
return|;
block|}
end_function

begin_function
name|PATHP
DECL|function|path_new (GimpImage * gimage,PathType ptype,GSList * path_details,gint closed,gint state,gint locked,gint tattoo,gchar * name)
name|path_new
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|PathType
name|ptype
parameter_list|,
name|GSList
modifier|*
name|path_details
parameter_list|,
name|gint
name|closed
parameter_list|,
name|gint
name|state
parameter_list|,
name|gint
name|locked
parameter_list|,
name|gint
name|tattoo
parameter_list|,
name|gchar
modifier|*
name|name
parameter_list|)
block|{
name|PATHP
name|path
init|=
name|g_new0
argument_list|(
name|PATH
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|path
operator|->
name|path_details
operator|=
name|path_details
expr_stmt|;
name|path
operator|->
name|closed
operator|=
name|closed
expr_stmt|;
name|path
operator|->
name|state
operator|=
name|state
expr_stmt|;
name|path
operator|->
name|locked
operator|=
name|locked
expr_stmt|;
name|path
operator|->
name|name
operator|=
name|g_string_new
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|path
operator|->
name|pathtype
operator|=
name|ptype
expr_stmt|;
if|if
condition|(
name|tattoo
condition|)
name|path
operator|->
name|tattoo
operator|=
name|tattoo
expr_stmt|;
else|else
name|path
operator|->
name|tattoo
operator|=
name|gimp_image_get_new_tattoo
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
return|return
name|path
return|;
block|}
end_function

begin_function
name|PathsList
modifier|*
DECL|function|pathsList_new (GimpImage * gimage,gint last_selected_row,GSList * bz_paths)
name|pathsList_new
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|last_selected_row
parameter_list|,
name|GSList
modifier|*
name|bz_paths
parameter_list|)
block|{
name|PATHIMAGELISTP
name|pip
init|=
name|g_new0
argument_list|(
name|PATHIMAGELIST
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|pip
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
name|pip
operator|->
name|last_selected_row
operator|=
name|last_selected_row
expr_stmt|;
comment|/* add connector to image delete/destroy */
name|pip
operator|->
name|sig_id
operator|=
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|gimage
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|paths_dialog_destroy_cb
argument_list|)
argument_list|,
name|pip
argument_list|)
expr_stmt|;
name|pip
operator|->
name|bz_paths
operator|=
name|bz_paths
expr_stmt|;
return|return
operator|(
name|PathsList
operator|*
operator|)
name|pip
return|;
block|}
end_function

begin_comment
comment|/**************************************************************/
end_comment

begin_comment
comment|/* Code to save/load from filesystem                          */
end_comment

begin_comment
comment|/**************************************************************/
end_comment

begin_decl_stmt
DECL|variable|file_dlg
specifier|static
name|GtkWidget
modifier|*
name|file_dlg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|load_store
specifier|static
name|int
name|load_store
decl_stmt|;
end_decl_stmt

begin_function
DECL|function|path_write_current_to_file (FILE * f,PATHP bzp)
specifier|static
name|void
name|path_write_current_to_file
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|PATHP
name|bzp
parameter_list|)
block|{
name|GSList
modifier|*
name|list
init|=
name|bzp
operator|->
name|path_details
decl_stmt|;
name|PATHPOINTP
name|pdata
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"Name: %s\n"
argument_list|,
name|bzp
operator|->
name|name
operator|->
name|str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"#POINTS: %d\n"
argument_list|,
name|g_slist_length
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"CLOSED: %d\n"
argument_list|,
name|bzp
operator|->
name|closed
operator|==
literal|1
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"DRAW: %d\n"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"STATE: %d\n"
argument_list|,
name|bzp
operator|->
name|state
argument_list|)
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|pdata
operator|=
operator|(
name|PATHPOINTP
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"TYPE: %d X: %d Y: %d\n"
argument_list|,
name|pdata
operator|->
name|type
argument_list|,
operator|(
name|gint
operator|)
name|pdata
operator|->
name|x
argument_list|,
operator|(
name|gint
operator|)
name|pdata
operator|->
name|y
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|file_ok_callback (GtkWidget * widget,gpointer client_data)
specifier|static
name|void
name|file_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|GtkFileSelection
modifier|*
name|fs
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
name|PATHP
name|bzpath
decl_stmt|;
name|GSList
modifier|*
name|pts_list
init|=
name|NULL
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|fs
operator|=
name|GTK_FILE_SELECTION
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
name|filename
operator|=
name|gtk_file_selection_get_filename
argument_list|(
name|fs
argument_list|)
expr_stmt|;
if|if
condition|(
name|load_store
condition|)
block|{
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Unable to open file %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
operator|!
name|feof
argument_list|(
name|f
argument_list|)
condition|)
block|{
name|gchar
modifier|*
name|txt
init|=
name|g_new
argument_list|(
name|gchar
argument_list|,
literal|512
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|txtstart
init|=
name|txt
decl_stmt|;
name|gint
name|readfields
init|=
literal|0
decl_stmt|;
name|int
name|val
decl_stmt|,
name|type
decl_stmt|,
name|closed
decl_stmt|,
name|i
decl_stmt|,
name|draw
decl_stmt|,
name|state
decl_stmt|;
name|double
name|x
decl_stmt|,
name|y
decl_stmt|;
if|if
condition|(
operator|!
name|fgets
argument_list|(
name|txt
argument_list|,
literal|512
argument_list|,
name|f
argument_list|)
operator|||
name|strlen
argument_list|(
name|txt
argument_list|)
operator|<
literal|7
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Failed to read from %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
name|txt
operator|+=
literal|6
expr_stmt|;
comment|/* Miss out 'Name: ' bit */
name|txt
index|[
name|strlen
argument_list|(
name|txt
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|readfields
operator|+=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"#POINTS: %d\n"
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|readfields
operator|+=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"CLOSED: %d\n"
argument_list|,
operator|&
name|closed
argument_list|)
expr_stmt|;
name|readfields
operator|+=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"DRAW: %d\n"
argument_list|,
operator|&
name|draw
argument_list|)
expr_stmt|;
name|readfields
operator|+=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"STATE: %d\n"
argument_list|,
operator|&
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|readfields
operator|!=
literal|4
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Failed to read path from %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|val
operator|<=
literal|0
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"No points specified in path file %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|val
condition|;
name|i
operator|++
control|)
block|{
name|PATHPOINTP
name|bpt
decl_stmt|;
name|readfields
operator|=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"TYPE: %d X: %lg Y: %lg\n"
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|readfields
operator|!=
literal|3
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Failed to read path points from %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
name|bpt
operator|=
name|pathpoint_new
argument_list|(
name|type
argument_list|,
operator|(
name|gdouble
operator|)
name|x
argument_list|,
operator|(
name|gdouble
operator|)
name|y
argument_list|)
expr_stmt|;
name|pts_list
operator|=
name|g_slist_append
argument_list|(
name|pts_list
argument_list|,
name|bpt
argument_list|)
expr_stmt|;
block|}
name|bzpath
operator|=
name|path_new
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|BEZIER
argument_list|,
name|pts_list
argument_list|,
name|closed
argument_list|,
name|state
argument_list|,
literal|0
argument_list|,
comment|/* Can't be locked */
literal|0
argument_list|,
comment|/* No tattoo assigned */
name|txt
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|txtstart
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|path_add_to_current
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
argument_list|,
name|bzpath
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzpath
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
operator|(
name|copy_pp
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PATHP
name|bzp
decl_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|f
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"open failed on %s: %s\n"
argument_list|)
argument_list|,
name|filename
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Write the current selection out. */
name|path_write_current_to_file
argument_list|(
name|f
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|file_cancel_callback (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|file_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|make_file_dlg (gpointer data)
specifier|static
name|void
name|make_file_dlg
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|file_dlg
operator|=
name|gtk_file_selection_new
argument_list|(
name|_
argument_list|(
literal|"Load/Store Bezier Curves"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_window_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|GTK_FILE_SELECTION
argument_list|(
name|file_dlg
argument_list|)
operator|->
name|cancel_button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|file_cancel_callback
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|GTK_FILE_SELECTION
argument_list|(
name|file_dlg
argument_list|)
operator|->
name|ok_button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|file_ok_callback
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|path_load_callback ()
name|path_load_callback
parameter_list|()
block|{
if|if
condition|(
operator|!
name|file_dlg
condition|)
block|{
name|make_file_dlg
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|file_dlg
argument_list|)
condition|)
return|return;
block|}
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Load Path"
argument_list|)
argument_list|)
expr_stmt|;
name|load_store
operator|=
literal|1
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|path_store_callback ()
name|path_store_callback
parameter_list|()
block|{
if|if
condition|(
operator|!
name|file_dlg
condition|)
block|{
name|make_file_dlg
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|file_dlg
argument_list|)
condition|)
return|return;
block|}
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Store Path"
argument_list|)
argument_list|)
expr_stmt|;
name|load_store
operator|=
literal|0
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_import_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_import_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
comment|/* Read and add at current position */
name|path_load_callback
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_export_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_export_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
comment|/* Export the path to a file */
name|path_store_callback
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/* Function for transforming paths   */
end_comment

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/* These functions are the undo functions for the paths  * that have undergone transformations.   *  * Generally speaking paths do not belong with the undo   * structures. However when a path undergoes a transformation   * then THIS path transformation should be part of the undo.  * We do have a problem here since a point could have been  * added to the path after the transformation. This   * point will be lost if the undo stuff is performed. It would   * then appear that this point is part of the undo structure.  * I think it is fair that this happens since the user is telling  * us to restore the state before the transformation took place.  * Note tattoos are used to find which paths have been stored in the  * undo buffer. So deleted paths will not suddenly reappear. (I did say  * generally paths are not part of the undo structures).  */
end_comment

begin_function
name|void
modifier|*
DECL|function|paths_transform_start_undo (GimpImage * gimage)
name|paths_transform_start_undo
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
comment|/* Save only the locked paths away */
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
name|PATHP
name|p
decl_stmt|;
name|PATHP
name|p_copy
decl_stmt|;
name|GSList
modifier|*
name|undo_list
init|=
name|NULL
decl_stmt|;
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return
name|NULL
return|;
name|plist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
while|while
condition|(
name|plist
condition|)
block|{
name|p
operator|=
operator|(
name|PATHP
operator|)
name|plist
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|locked
condition|)
block|{
comment|/* save away for a rainly day */
name|p_copy
operator|=
name|path_copy
argument_list|(
name|NULL
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* NULL means dont want new tattoo */
name|undo_list
operator|=
name|g_slist_append
argument_list|(
name|undo_list
argument_list|,
name|p_copy
argument_list|)
expr_stmt|;
block|}
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
return|return
name|undo_list
return|;
block|}
end_function

begin_function
name|void
DECL|function|paths_transform_free_undo (void * data)
name|paths_transform_free_undo
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|GSList
modifier|*
name|pundolist
init|=
name|data
decl_stmt|;
name|PATHP
name|p
decl_stmt|;
comment|/* free data associated with the transform path undo */
while|while
condition|(
name|pundolist
condition|)
block|{
name|p
operator|=
operator|(
name|PATHP
operator|)
name|pundolist
operator|->
name|data
expr_stmt|;
name|path_free
argument_list|(
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pundolist
operator|=
name|g_slist_next
argument_list|(
name|pundolist
argument_list|)
expr_stmt|;
block|}
name|g_slist_free
argument_list|(
operator|(
name|GSList
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_transform_do_undo (GimpImage * gimage,void * data)
name|paths_transform_do_undo
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|GSList
modifier|*
name|pundolist
init|=
name|data
decl_stmt|;
comment|/* Restore the paths as they were before this transform took place. */
name|PATHP
name|p_undo
decl_stmt|;
name|PATHP
name|p
decl_stmt|;
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
name|gint
name|loop
decl_stmt|;
name|gboolean
name|preview_update
init|=
name|FALSE
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
comment|/* free data associated with the transform path undo */
while|while
condition|(
name|pundolist
condition|)
block|{
name|p_undo
operator|=
operator|(
name|PATHP
operator|)
name|pundolist
operator|->
name|data
expr_stmt|;
comment|/* Find the old path and replace it */
name|p
operator|=
name|paths_get_path_by_tattoo
argument_list|(
name|gimage
argument_list|,
name|p_undo
operator|->
name|tattoo
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
comment|/* Path is still around... undo the transform stuff */
name|pathpoints_free
argument_list|(
name|p
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|p
operator|->
name|closed
operator|=
name|p_undo
operator|->
name|closed
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|p_undo
operator|->
name|state
expr_stmt|;
name|p
operator|->
name|pathtype
operator|=
name|p_undo
operator|->
name|pathtype
expr_stmt|;
name|p
operator|->
name|path_details
operator|=
name|pathpoints_copy
argument_list|(
name|p_undo
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|preview_update
operator|=
name|TRUE
expr_stmt|;
block|}
name|pundolist
operator|=
name|g_slist_next
argument_list|(
name|pundolist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|preview_update
operator|&&
name|paths_dialog
condition|)
block|{
comment|/* Heck the previews need updating...*/
name|plp
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|plist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|plist
operator|&&
name|g_slist_length
argument_list|(
name|plist
argument_list|)
operator|&&
name|paths_dialog
operator|->
name|current_path_list
condition|)
block|{
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|plist
operator|->
name|data
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|loop
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
name|loop
operator|++
expr_stmt|;
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
comment|/* Force selection .. it may have changed */
if|if
condition|(
name|bezier_tool_selected
argument_list|()
operator|&&
name|paths_dialog
operator|->
name|current_path_list
condition|)
block|{
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
DECL|function|paths_transform_current_path (GimpImage * gimage,GimpMatrix transform,gboolean forpreview)
name|paths_transform_current_path
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|GimpMatrix
name|transform
parameter_list|,
name|gboolean
name|forpreview
parameter_list|)
block|{
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|PATHP
name|p
decl_stmt|;
name|PATHP
name|p_copy
decl_stmt|;
name|GSList
modifier|*
name|points_list
decl_stmt|;
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
name|gint
name|loop
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
comment|/* As a first off lets just translate the current path */
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return;
name|plist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|plist
condition|)
block|{
name|p
operator|=
operator|(
name|PATHP
operator|)
name|plist
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|locked
condition|)
block|{
if|if
condition|(
name|forpreview
condition|)
name|p_copy
operator|=
name|path_copy
argument_list|(
name|NULL
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* NULL means dont want new tattoo */
else|else
name|p_copy
operator|=
name|p
expr_stmt|;
name|points_list
operator|=
name|p_copy
operator|->
name|path_details
expr_stmt|;
while|while
condition|(
name|points_list
condition|)
block|{
name|gdouble
name|newx
decl_stmt|,
name|newy
decl_stmt|;
name|PATHPOINTP
name|ppoint
init|=
name|points_list
operator|->
name|data
decl_stmt|;
comment|/*       printf("[x,y] = [%g,%g]\n",ppoint->x, ppoint->y); */
name|gimp_matrix_transform_point
argument_list|(
name|transform
argument_list|,
name|ppoint
operator|->
name|x
argument_list|,
name|ppoint
operator|->
name|y
argument_list|,
operator|&
name|newx
argument_list|,
operator|&
name|newy
argument_list|)
expr_stmt|;
comment|/*       printf("->[x,y] = [%g,%g]\n", newx, newy); */
name|ppoint
operator|->
name|x
operator|=
name|newx
expr_stmt|;
name|ppoint
operator|->
name|y
operator|=
name|newy
expr_stmt|;
name|points_list
operator|=
name|points_list
operator|->
name|next
expr_stmt|;
block|}
comment|/* Only update if we have a dialog, we have a currently  	   * selected path and its the showing the same image. 	   */
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|current_path_list
operator|&&
name|paths_dialog
operator|->
name|gimage
operator|==
name|gimage
condition|)
block|{
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|p_copy
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|loop
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
block|}
if|if
condition|(
name|forpreview
condition|)
name|path_free
argument_list|(
name|p_copy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
name|loop
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|paths_draw_current (GDisplay * gdisp,DrawCore * core,GimpMatrix transform)
name|paths_draw_current
parameter_list|(
name|GDisplay
modifier|*
name|gdisp
parameter_list|,
name|DrawCore
modifier|*
name|core
parameter_list|,
name|GimpMatrix
name|transform
parameter_list|)
block|{
name|PATHIMAGELISTP
name|plp
decl_stmt|;
name|PATHP
name|bzp
decl_stmt|;
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|PATHP
name|p_copy
decl_stmt|;
name|GSList
modifier|*
name|points_list
decl_stmt|;
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return;
name|bzp
operator|=
operator|(
name|PATHP
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|plp
operator|->
name|last_selected_row
argument_list|)
expr_stmt|;
comment|/* This image path is locked */
if|if
condition|(
name|bzp
operator|->
name|locked
condition|)
block|{
name|p_copy
operator|=
name|path_copy
argument_list|(
name|NULL
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
comment|/* NULL means dont want new tattoo */
name|points_list
operator|=
name|p_copy
operator|->
name|path_details
expr_stmt|;
while|while
condition|(
name|points_list
condition|)
block|{
name|gdouble
name|newx
decl_stmt|,
name|newy
decl_stmt|;
name|PATHPOINTP
name|ppoint
init|=
name|points_list
operator|->
name|data
decl_stmt|;
comment|/*       printf("[x,y] = [%g,%g]\n",ppoint->x, ppoint->y); */
name|gimp_matrix_transform_point
argument_list|(
name|transform
argument_list|,
name|ppoint
operator|->
name|x
argument_list|,
name|ppoint
operator|->
name|y
argument_list|,
operator|&
name|newx
argument_list|,
operator|&
name|newy
argument_list|)
expr_stmt|;
comment|/*       printf("->[x,y] = [%g,%g]\n", newx, newy); */
name|ppoint
operator|->
name|x
operator|=
name|newx
expr_stmt|;
name|ppoint
operator|->
name|y
operator|=
name|newy
expr_stmt|;
name|points_list
operator|=
name|points_list
operator|->
name|next
expr_stmt|;
block|}
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|p_copy
argument_list|)
expr_stmt|;
name|bezier_sel
operator|->
name|core
operator|=
name|core
expr_stmt|;
comment|/* A bit hacky */
name|bezier_draw
argument_list|(
name|gdisp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|path_free
argument_list|(
name|p_copy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/* PDB function aids                 */
end_comment

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/* Return TRUE if setting the path worked, else false */
end_comment

begin_function
name|gboolean
DECL|function|paths_set_path (GimpImage * gimage,gchar * pname)
name|paths_set_path
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gchar
modifier|*
name|pname
parameter_list|)
block|{
name|gint
name|row
init|=
literal|0
decl_stmt|;
name|gboolean
name|found
init|=
name|FALSE
decl_stmt|;
name|GSList
modifier|*
name|tlist
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return
name|FALSE
return|;
name|tlist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
while|while
condition|(
name|tlist
condition|)
block|{
name|gchar
modifier|*
name|test_str
init|=
operator|(
call|(
name|PATHP
call|)
argument_list|(
name|tlist
operator|->
name|data
argument_list|)
operator|)
operator|->
name|name
operator|->
name|str
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pname
argument_list|,
name|test_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|row
operator|++
expr_stmt|;
name|tlist
operator|=
name|g_slist_next
argument_list|(
name|tlist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|paths_dialog
condition|)
block|{
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|plp
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Set a path with the given set of points. */
end_comment

begin_comment
comment|/* We assume that there are enough points */
end_comment

begin_comment
comment|/* Return TRUE if path created OK. */
end_comment

begin_function
name|gboolean
DECL|function|paths_set_path_points (GimpImage * gimage,gchar * pname,gint ptype,gint pclosed,gint num_pnts,gdouble * pnts)
name|paths_set_path_points
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gchar
modifier|*
name|pname
parameter_list|,
name|gint
name|ptype
parameter_list|,
name|gint
name|pclosed
parameter_list|,
name|gint
name|num_pnts
parameter_list|,
name|gdouble
modifier|*
name|pnts
parameter_list|)
block|{
name|PathsList
modifier|*
name|plist
init|=
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
decl_stmt|;
name|GSList
modifier|*
name|pts_list
init|=
name|NULL
decl_stmt|;
name|PATHP
name|bzpath
decl_stmt|;
name|gint
name|pcount
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|num_pnts
operator|<
literal|6
operator|||
operator|(
name|pclosed
operator|&&
operator|(
operator|(
name|num_pnts
operator|/
literal|2
operator|)
operator|%
literal|3
operator|)
operator|)
operator|||
operator|(
operator|!
name|pclosed
operator|&&
operator|(
operator|(
name|num_pnts
operator|/
literal|2
operator|)
operator|%
literal|3
operator|)
operator|!=
literal|2
operator|)
condition|)
block|{
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"wrong number of points\n"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|ptype
operator|!=
name|BEZIER
condition|)
name|ptype
operator|=
name|BEZIER
expr_stmt|;
while|while
condition|(
name|num_pnts
condition|)
block|{
name|PATHPOINTP
name|bpt
decl_stmt|;
name|gint
name|type
decl_stmt|;
name|gdouble
name|x
decl_stmt|;
name|gdouble
name|y
decl_stmt|;
if|if
condition|(
operator|(
name|pcount
operator|/
literal|2
operator|)
operator|%
literal|3
condition|)
name|type
operator|=
name|BEZIER_CONTROL
expr_stmt|;
else|else
name|type
operator|=
name|BEZIER_ANCHOR
expr_stmt|;
name|x
operator|=
name|pnts
index|[
name|pcount
operator|++
index|]
expr_stmt|;
name|y
operator|=
name|pnts
index|[
name|pcount
operator|++
index|]
expr_stmt|;
comment|/*       printf("New point type = %s, x = %d y= %d\n", */
comment|/* 	     (type==BEZIER_CONTROL)?"CNTL":"ANCH", */
comment|/* 	     (int)x, */
comment|/* 	     (int)y); */
name|bpt
operator|=
name|pathpoint_new
argument_list|(
name|type
argument_list|,
operator|(
name|gdouble
operator|)
name|x
argument_list|,
operator|(
name|gdouble
operator|)
name|y
argument_list|)
expr_stmt|;
name|pts_list
operator|=
name|g_slist_append
argument_list|(
name|pts_list
argument_list|,
name|bpt
argument_list|)
expr_stmt|;
name|num_pnts
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|plist
condition|)
block|{
name|GSList
modifier|*
name|bzp_list
init|=
name|NULL
decl_stmt|;
comment|/* No paths at all.... create one& rename */
name|bzpath
operator|=
name|path_new
argument_list|(
name|gimage
argument_list|,
name|ptype
argument_list|,
name|pts_list
argument_list|,
name|pclosed
argument_list|,
operator|(
name|pclosed
operator|)
condition|?
name|BEZIER_EDIT
else|:
name|BEZIER_ADD
argument_list|,
comment|/*state,*/
literal|0
argument_list|,
comment|/* Can't be locked */
literal|0
argument_list|,
comment|/* No tattoo assigned */
name|pname
argument_list|)
expr_stmt|;
name|bzp_list
operator|=
name|g_slist_append
argument_list|(
name|bzp_list
argument_list|,
name|bzpath
argument_list|)
expr_stmt|;
name|plist
operator|=
name|pathsList_new
argument_list|(
name|gimage
argument_list|,
literal|0
argument_list|,
name|bzp_list
argument_list|)
expr_stmt|;
name|gimp_image_set_paths
argument_list|(
name|gimage
argument_list|,
name|plist
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|GSList
modifier|*
name|tlist
decl_stmt|;
name|PATHP
name|pp
init|=
name|NULL
decl_stmt|;
name|gint
name|row
init|=
literal|0
decl_stmt|;
comment|/* Check if name already exists.. if so delete all points assoc with it        * if not create a new one with the passed name.        */
name|tlist
operator|=
name|plist
operator|->
name|bz_paths
expr_stmt|;
while|while
condition|(
name|tlist
condition|)
block|{
name|gchar
modifier|*
name|test_str
init|=
operator|(
call|(
name|PATHP
call|)
argument_list|(
name|tlist
operator|->
name|data
argument_list|)
operator|)
operator|->
name|name
operator|->
name|str
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pname
argument_list|,
name|test_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pp
operator|=
call|(
name|PATHP
call|)
argument_list|(
name|tlist
operator|->
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
name|tlist
operator|=
name|g_slist_next
argument_list|(
name|tlist
argument_list|)
expr_stmt|;
name|row
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pp
condition|)
block|{
name|pathpoints_free
argument_list|(
name|pp
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|pp
operator|->
name|path_details
operator|=
name|pts_list
expr_stmt|;
name|pp
operator|->
name|pathtype
operator|=
name|ptype
expr_stmt|;
name|pp
operator|->
name|closed
operator|=
name|pclosed
expr_stmt|;
name|pp
operator|->
name|locked
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|paths_dialog
condition|)
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
else|else
block|{
name|bzpath
operator|=
name|path_new
argument_list|(
name|gimage
argument_list|,
name|ptype
argument_list|,
name|pts_list
argument_list|,
name|pclosed
argument_list|,
operator|(
name|pclosed
operator|)
condition|?
name|BEZIER_EDIT
else|:
name|BEZIER_ADD
argument_list|,
comment|/*state,*/
literal|0
argument_list|,
comment|/* Can't be locked */
literal|0
argument_list|,
comment|/* No tattoo assigned */
name|pname
argument_list|)
expr_stmt|;
name|path_add_to_current
argument_list|(
name|plist
argument_list|,
name|bzpath
argument_list|,
name|gimage
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|paths_dialog
condition|)
block|{
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|path_add_to_current
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
argument_list|,
name|bzpath
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzpath
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DUP_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|DEL_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|STROKE_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PATH_TO_SEL_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|COPY_PATH_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|paths_ops_button_set_sensitive
argument_list|(
name|PASTE_PATH_BUTTON
argument_list|,
operator|(
name|copy_pp
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_ADD_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_DEL_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_NEW_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|point_ops_button_set_sensitive
argument_list|(
name|POINT_EDIT_BUTTON
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|void
DECL|function|paths_stroke (GimpImage * gimage,PathsList * pl,PATHP bzp)
name|paths_stroke
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|PathsList
modifier|*
name|pl
parameter_list|,
name|PATHP
name|bzp
parameter_list|)
block|{
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|pl
operator|->
name|gdisp
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|bezier_stroke
argument_list|(
name|bezier_sel
argument_list|,
name|gdisp
argument_list|,
name|SUBDIVIDE
argument_list|,
operator|!
name|bzp
operator|->
name|closed
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|gint
DECL|function|paths_distance (PATHP bzp,gdouble dist,gint * x,gint * y,gdouble * grad)
name|paths_distance
parameter_list|(
name|PATHP
name|bzp
parameter_list|,
name|gdouble
name|dist
parameter_list|,
name|gint
modifier|*
name|x
parameter_list|,
name|gint
modifier|*
name|y
parameter_list|,
name|gdouble
modifier|*
name|grad
parameter_list|)
block|{
name|gint
name|ret
decl_stmt|;
name|BezierSelect
modifier|*
name|bezier_sel
decl_stmt|;
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|bezier_distance_along
argument_list|(
name|bezier_sel
argument_list|,
operator|!
name|bzp
operator|->
name|closed
argument_list|,
name|dist
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|grad
argument_list|)
expr_stmt|;
name|beziersel_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|Tattoo
DECL|function|paths_get_tattoo (PATHP p)
name|paths_get_tattoo
parameter_list|(
name|PATHP
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"paths_get_tattoo: invalid path"
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|(
name|p
operator|->
name|tattoo
operator|)
return|;
block|}
end_function

begin_function
name|PATHP
DECL|function|paths_get_path_by_tattoo (GimpImage * gimage,Tattoo tattoo)
name|paths_get_path_by_tattoo
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|Tattoo
name|tattoo
parameter_list|)
block|{
name|GSList
modifier|*
name|tlist
decl_stmt|;
name|PATHIMAGELISTP
name|plp
decl_stmt|;
if|if
condition|(
operator|!
name|gimage
operator|||
operator|!
name|tattoo
condition|)
return|return
name|NULL
return|;
comment|/* Go around the list and check all tattoos. */
comment|/* Get path structure  */
name|plp
operator|=
operator|(
name|PATHIMAGELISTP
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|tlist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
while|while
condition|(
name|tlist
condition|)
block|{
name|PATHP
name|p
init|=
call|(
name|PATHP
call|)
argument_list|(
name|tlist
operator|->
name|data
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|tattoo
operator|==
name|tattoo
condition|)
return|return
operator|(
name|p
operator|)
return|;
name|tlist
operator|=
name|g_slist_next
argument_list|(
name|tlist
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

end_unit

