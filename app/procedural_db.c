begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"app_procs.h"
end_include

begin_include
include|#
directive|include
file|"general.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"plug_in.h"
end_include

begin_include
include|#
directive|include
file|"procedural_db.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/parasite.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"regex.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_comment
comment|/*  Query structure  */
end_comment

begin_typedef
DECL|typedef|PDBQuery
typedef|typedef
name|struct
name|_PDBQuery
name|PDBQuery
typedef|;
end_typedef

begin_struct
DECL|struct|_PDBQuery
struct|struct
name|_PDBQuery
block|{
DECL|member|name_regex
name|regex_t
name|name_regex
decl_stmt|;
DECL|member|blurb_regex
name|regex_t
name|blurb_regex
decl_stmt|;
DECL|member|help_regex
name|regex_t
name|help_regex
decl_stmt|;
DECL|member|author_regex
name|regex_t
name|author_regex
decl_stmt|;
DECL|member|copyright_regex
name|regex_t
name|copyright_regex
decl_stmt|;
DECL|member|date_regex
name|regex_t
name|date_regex
decl_stmt|;
DECL|member|proc_type_regex
name|regex_t
name|proc_type_regex
decl_stmt|;
DECL|member|list_of_procs
name|char
modifier|*
modifier|*
name|list_of_procs
decl_stmt|;
DECL|member|num_procs
name|int
name|num_procs
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
DECL|typedef|PDBData
typedef|typedef
name|struct
name|_PDBData
name|PDBData
typedef|;
end_typedef

begin_struct
DECL|struct|_PDBData
struct|struct
name|_PDBData
block|{
DECL|member|identifier
name|char
modifier|*
name|identifier
decl_stmt|;
DECL|member|bytes
name|int
name|bytes
decl_stmt|;
DECL|member|data
name|char
modifier|*
name|data
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  Local functions  */
end_comment

begin_function_decl
specifier|static
name|Argument
modifier|*
name|procedural_db_dump
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|procedural_db_print_entry
parameter_list|(
name|gpointer
parameter_list|,
name|gpointer
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|output_string
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|procedural_db_proc_info
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|procedural_db_proc_arg
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|procedural_db_proc_val
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|procedural_db_get_data
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|procedural_db_get_data_size
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|procedural_db_set_data
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Argument
modifier|*
name|procedural_db_query
parameter_list|(
name|Argument
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|procedural_db_query_entry
parameter_list|(
name|gpointer
parameter_list|,
name|gpointer
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|match_strings
parameter_list|(
name|regex_t
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|guint
name|procedural_db_hash_func
parameter_list|(
name|gconstpointer
name|key
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pdb_id_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  Local data  */
end_comment

begin_decl_stmt
DECL|variable|procedural_ht
specifier|static
name|GHashTable
modifier|*
name|procedural_ht
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_out
specifier|static
name|FILE
modifier|*
name|procedural_db_out
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|data_list
specifier|static
name|GList
modifier|*
name|data_list
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|type_str
specifier|static
name|char
modifier|*
name|type_str
index|[]
init|=
block|{
literal|"PDB_INT32"
block|,
literal|"PDB_INT16"
block|,
literal|"PDB_INT8"
block|,
literal|"PDB_FLOAT"
block|,
literal|"PDB_STRING"
block|,
literal|"PDB_INT32ARRAY"
block|,
literal|"PDB_INT16ARRAY"
block|,
literal|"PDB_INT8ARRAY"
block|,
literal|"PDB_FLOATARRAY"
block|,
literal|"PDB_STRINGARRAY"
block|,
literal|"PDB_COLOR"
block|,
literal|"PDB_REGION"
block|,
literal|"PDB_DISPLAY"
block|,
literal|"PDB_IMAGE"
block|,
literal|"PDB_LAYER"
block|,
literal|"PDB_CHANNEL"
block|,
literal|"PDB_DRAWABLE"
block|,
literal|"PDB_SELECTION"
block|,
literal|"PDB_BOUNDARY"
block|,
literal|"PDB_PATH"
block|,
literal|"PDB_PARASITE"
block|,
literal|"PDB_STATUS"
block|,
literal|"PDB_END"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|proc_type_str
specifier|static
name|char
modifier|*
name|proc_type_str
index|[]
init|=
block|{
name|N_
argument_list|(
literal|"Internal GIMP procedure"
argument_list|)
block|,
name|N_
argument_list|(
literal|"GIMP Plug-In"
argument_list|)
block|,
name|N_
argument_list|(
literal|"GIMP Extension"
argument_list|)
block|,
name|N_
argument_list|(
literal|"Temporary Procedure"
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/************************/
end_comment

begin_comment
comment|/*  PROCEDURAL_DB_DUMP  */
end_comment

begin_decl_stmt
DECL|variable|procedural_db_dump_args
specifier|static
name|ProcArg
name|procedural_db_dump_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"filename"
block|,
name|N_
argument_list|(
literal|"the dump filename"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_dump_proc
name|ProcRecord
name|procedural_db_dump_proc
init|=
block|{
literal|"gimp_procedural_db_dump"
block|,
name|N_
argument_list|(
literal|"Dumps the current contents of the procedural database"
argument_list|)
block|,
name|N_
argument_list|(
literal|"This procedure dumps the contents of the procedural database to the specified file.  The file will contain all of the information provided for each registered procedure.  This file is in a format appropriate for use with the supplied \"pdb_self_doc.el\" Elisp script, which generates a texinfo document."
argument_list|)
block|,
literal|"Spencer Kimball& Josh MacDonald"
block|,
literal|"Spencer Kimball& Josh MacDonald& Peter Mattis"
block|,
literal|"1995-1996"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|1
block|,
name|procedural_db_dump_args
block|,
comment|/*  Output arguments  */
literal|0
block|,
name|NULL
block|,
comment|/*  Exec method  */
block|{
block|{
name|procedural_db_dump
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************/
end_comment

begin_comment
comment|/*  PROCEDURAL_DB_PROC_INFO  */
end_comment

begin_decl_stmt
DECL|variable|procedural_db_proc_info_args
specifier|static
name|ProcArg
name|procedural_db_proc_info_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"procedure"
block|,
name|N_
argument_list|(
literal|"the procedure name"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_proc_info_out_args
specifier|static
name|ProcArg
name|procedural_db_proc_info_out_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"blurb"
block|,
name|N_
argument_list|(
literal|"a short blurb"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"help"
block|,
name|N_
argument_list|(
literal|"detailed procedure help"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"author"
block|,
name|N_
argument_list|(
literal|"author(s) of the procedure"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"copyright"
block|,
name|N_
argument_list|(
literal|"the copyright"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"date"
block|,
name|N_
argument_list|(
literal|"copyright date"
argument_list|)
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"proc_type"
block|,
name|N_
argument_list|(
literal|"the procedure type: { INTERNAL (0), PLUGIN (1), EXTENSION (2) }"
argument_list|)
block|,   }
block|,
block|{
name|PDB_INT32
block|,
literal|"num_args"
block|,
name|N_
argument_list|(
literal|"the number of input arguments"
argument_list|)
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"num_rvals"
block|,
name|N_
argument_list|(
literal|"the number of return values"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_proc_info_proc
name|ProcRecord
name|procedural_db_proc_info_proc
init|=
block|{
literal|"gimp_procedural_db_proc_info"
block|,
name|N_
argument_list|(
literal|"Queries the procedural database for information on the specified procedure"
argument_list|)
block|,
name|N_
argument_list|(
literal|"This procedure returns information on the specified procedure.  A short blurb, detailed help, author(s), copyright information, procedure type, number of input, and number of return values are returned.  For specific information on each input argument and return value, use the 'gimp_procedural_db_query_proc_arg' and 'gimp_procedural_db_query_proc_val' procedures"
argument_list|)
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1997"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|1
block|,
name|procedural_db_proc_info_args
block|,
comment|/*  Output arguments  */
literal|8
block|,
name|procedural_db_proc_info_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|procedural_db_proc_info
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**********************************/
end_comment

begin_comment
comment|/*  PROCEDURAL_DB_PROC_ARG  */
end_comment

begin_decl_stmt
DECL|variable|procedural_db_proc_arg_args
specifier|static
name|ProcArg
name|procedural_db_proc_arg_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"procedure"
block|,
name|N_
argument_list|(
literal|"the procedure name"
argument_list|)
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"arg_num"
block|,
name|N_
argument_list|(
literal|"the argument number"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_proc_arg_out_args
specifier|static
name|ProcArg
name|procedural_db_proc_arg_out_args
index|[]
init|=
block|{
block|{
name|PDB_INT32
block|,
literal|"arg_type"
block|,
name|N_
argument_list|(
literal|"the type of argument { PDB_INT32 (0), PDB_INT16 (1), PDB_INT8 (2), PDB_FLOAT (3), PDB_STRING (4), PDB_INT32ARRAY (5), PDB_INT16ARRAY (6), PDB_INT8ARRAY (7), PDB_FLOATARRAY (8), PDB_STRINGARRAY (9), PDB_COLOR (10), PDB_REGION (11), PDB_DISPLAY (12), PDB_IMAGE (13), PDB_LAYER (14), PDB_CHANNEL (15), PDB_DRAWABLE (16), PDB_SELECTION (17), PDB_BOUNDARY (18), PDB_PATH (19), PDB_PARASITE (20), PDB_STATUS (21) }"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"arg_name"
block|,
name|N_
argument_list|(
literal|"the name of the argument"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"arg_desc"
block|,
name|N_
argument_list|(
literal|"a description of the argument"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_proc_arg_proc
name|ProcRecord
name|procedural_db_proc_arg_proc
init|=
block|{
literal|"gimp_procedural_db_proc_arg"
block|,
name|N_
argument_list|(
literal|"Queries the procedural database for information on the specified procedure's argument"
argument_list|)
block|,
name|N_
argument_list|(
literal|"This procedure returns information on the specified procedure's argument.  The argument type, name, and a description are retrieved."
argument_list|)
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1997"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|2
block|,
name|procedural_db_proc_arg_args
block|,
comment|/*  Output arguments  */
literal|3
block|,
name|procedural_db_proc_arg_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|procedural_db_proc_arg
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  PROCEDURAL_DB_PROC_VAL  */
end_comment

begin_decl_stmt
DECL|variable|procedural_db_proc_val_args
specifier|static
name|ProcArg
name|procedural_db_proc_val_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"procedure"
block|,
name|N_
argument_list|(
literal|"the procedure name"
argument_list|)
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"val_num"
block|,
name|N_
argument_list|(
literal|"the return value number"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_proc_val_out_args
specifier|static
name|ProcArg
name|procedural_db_proc_val_out_args
index|[]
init|=
block|{
block|{
name|PDB_INT32
block|,
literal|"val_type"
block|,
name|N_
argument_list|(
literal|"the type of return value { PDB_INT32 (0), PDB_INT16 (1), PDB_INT8 (2), PDB_FLOAT (3), PDB_STRING (4), PDB_INT32ARRAY (5), PDB_INT16ARRAY (6), PDB_INT8ARRAY (7), PDB_FLOATARRAY (8), PDB_STRINGARRAY (9), PDB_COLOR (10), PDB_REGION (11), PDB_DISPLAY (12), PDB_IMAGE (13), PDB_LAYER (14), PDB_CHANNEL (15), PDB_DRAWABLE (16), PDB_SELECTION (17), PDB_BOUNDARY (18), PDB_PATH (19), PDB_PARASITE (20), PDB_STATUS (21) }"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"val_name"
block|,
name|N_
argument_list|(
literal|"the name of the return value"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"val_desc"
block|,
name|N_
argument_list|(
literal|"a description of the return value"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_proc_val_proc
name|ProcRecord
name|procedural_db_proc_val_proc
init|=
block|{
literal|"gimp_procedural_db_proc_val"
block|,
name|N_
argument_list|(
literal|"Queries the procedural database for information on the specified procedure's return value"
argument_list|)
block|,
name|N_
argument_list|(
literal|"This procedure returns information on the specified procedure's return value.  The return value type, name, and a description are retrieved."
argument_list|)
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1997"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|2
block|,
name|procedural_db_proc_val_args
block|,
comment|/*  Output arguments  */
literal|3
block|,
name|procedural_db_proc_val_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|procedural_db_proc_val
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*********************************/
end_comment

begin_comment
comment|/*  PROCEDURAL_DB_GET_DATA_SIZE  */
end_comment

begin_decl_stmt
DECL|variable|procedural_db_get_data_size_args
specifier|static
name|ProcArg
name|procedural_db_get_data_size_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"identifier"
block|,
name|N_
argument_list|(
literal|"the identifier associated with data"
argument_list|)
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_get_data_size_out_args
specifier|static
name|ProcArg
name|procedural_db_get_data_size_out_args
index|[]
init|=
block|{
block|{
name|PDB_INT32
block|,
literal|"bytes"
block|,
name|N_
argument_list|(
literal|"the number of bytes in the data"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_get_data_size_proc
name|ProcRecord
name|procedural_db_get_data_size_proc
init|=
block|{
literal|"gimp_procedural_db_get_data_size"
block|,
name|N_
argument_list|(
literal|"Returns size of data associated with the specified identifier"
argument_list|)
block|,
name|N_
argument_list|(
literal|"This procedure returns the size of any data which may have been associated with the specified identifier. If no data has been associated with the identifier, an error is returned."
argument_list|)
block|,
literal|"Nick Lamb"
block|,
literal|"Nick Lamb"
block|,
literal|"1998"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|1
block|,
name|procedural_db_get_data_size_args
block|,
comment|/*  Output arguments  */
literal|2
block|,
name|procedural_db_get_data_size_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|procedural_db_get_data_size
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  PROCEDURAL_DB_GET_DATA  */
end_comment

begin_decl_stmt
DECL|variable|procedural_db_get_data_args
specifier|static
name|ProcArg
name|procedural_db_get_data_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"identifier"
block|,
name|N_
argument_list|(
literal|"the identifier associated with data"
argument_list|)
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_get_data_out_args
specifier|static
name|ProcArg
name|procedural_db_get_data_out_args
index|[]
init|=
block|{
block|{
name|PDB_INT32
block|,
literal|"bytes"
block|,
name|N_
argument_list|(
literal|"the number of bytes in the data"
argument_list|)
block|}
block|,
block|{
name|PDB_INT8ARRAY
block|,
literal|"data"
block|,
name|N_
argument_list|(
literal|"a byte array containing data"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_get_data_proc
name|ProcRecord
name|procedural_db_get_data_proc
init|=
block|{
literal|"gimp_procedural_db_get_data"
block|,
name|N_
argument_list|(
literal|"Returns data associated with the specified identifier"
argument_list|)
block|,
name|N_
argument_list|(
literal|"This procedure returns any data which may have been associated with the specified identifier.  The data is a variable length array of bytes.  If no data has been associated with the identifier, an error is returned."
argument_list|)
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1997"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|1
block|,
name|procedural_db_get_data_args
block|,
comment|/*  Output arguments  */
literal|2
block|,
name|procedural_db_get_data_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|procedural_db_get_data
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  PROCEDURAL_DB_SET_DATA  */
end_comment

begin_decl_stmt
DECL|variable|procedural_db_set_data_args
specifier|static
name|ProcArg
name|procedural_db_set_data_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"identifier"
block|,
name|N_
argument_list|(
literal|"the identifier for association with data"
argument_list|)
block|}
block|,
block|{
name|PDB_INT32
block|,
literal|"bytes"
block|,
name|N_
argument_list|(
literal|"the number of bytes in data"
argument_list|)
block|}
block|,
block|{
name|PDB_INT8ARRAY
block|,
literal|"data"
block|,
name|N_
argument_list|(
literal|"the data"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_set_data_proc
name|ProcRecord
name|procedural_db_set_data_proc
init|=
block|{
literal|"gimp_procedural_db_set_data"
block|,
name|N_
argument_list|(
literal|"Associates the specified identifier with the supplied data"
argument_list|)
block|,
name|N_
argument_list|(
literal|"This procedure associates the supplied data with the provided identifier.  The data may be subsequently retrieved by a call to 'procedural_db_get_data'."
argument_list|)
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1997"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|3
block|,
name|procedural_db_set_data_args
block|,
comment|/*  Output arguments  */
literal|0
block|,
name|NULL
block|,
comment|/*  Exec method  */
block|{
block|{
name|procedural_db_set_data
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*************************/
end_comment

begin_comment
comment|/*  PROCEDURAL_DB_QUERY  */
end_comment

begin_decl_stmt
DECL|variable|procedural_db_query_args
specifier|static
name|ProcArg
name|procedural_db_query_args
index|[]
init|=
block|{
block|{
name|PDB_STRING
block|,
literal|"name"
block|,
name|N_
argument_list|(
literal|"the regex for procedure name"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"blurb"
block|,
name|N_
argument_list|(
literal|"the regex for procedure blurb"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"help"
block|,
name|N_
argument_list|(
literal|"the regex for procedure help"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"author"
block|,
name|N_
argument_list|(
literal|"the regex for procedure author"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"copyright"
block|,
name|N_
argument_list|(
literal|"the regex for procedure copyright"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"date"
block|,
name|N_
argument_list|(
literal|"the regex for procedure date"
argument_list|)
block|}
block|,
block|{
name|PDB_STRING
block|,
literal|"proc_type"
block|,
name|N_
argument_list|(
literal|"the regex for procedure type: {'Internal GIMP procedure', 'GIMP Plug-In', 'GIMP Extension'}"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_query_out_args
specifier|static
name|ProcArg
name|procedural_db_query_out_args
index|[]
init|=
block|{
block|{
name|PDB_INT32
block|,
literal|"num_matches"
block|,
name|N_
argument_list|(
literal|"the number of matching procedures"
argument_list|)
block|}
block|,
block|{
name|PDB_STRINGARRAY
block|,
literal|"procedure_names"
block|,
name|N_
argument_list|(
literal|"the list of procedure names"
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|procedural_db_query_proc
name|ProcRecord
name|procedural_db_query_proc
init|=
block|{
literal|"gimp_procedural_db_query"
block|,
name|N_
argument_list|(
literal|"Queries the procedural database for its contents using regular expression matching"
argument_list|)
block|,
name|N_
argument_list|(
literal|"This procedure queries the contents of the procedural database.  It is supplied with seven arguments matching procedures on {name, blurb, help, author, copyright, date, procedure type}.  This is accomplished using regular expression matching.  For instance, to find all procedures with \"jpeg\" listed in the blurb, all seven arguments can be supplied as \".*\", except for the second, which can be supplied as \".*jpeg.*\".  There are two return arguments for this procedure.  The first is the number of procedures matching the query.  The second is a concatenated list of procedure names corresponding to those matching the query.  If no matching entries are found, then the returned string is NULL and the number of entries is 0."
argument_list|)
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"Spencer Kimball& Peter Mattis"
block|,
literal|"1995-1996"
block|,
name|PDB_INTERNAL
block|,
comment|/*  Input arguments  */
literal|7
block|,
name|procedural_db_query_args
block|,
comment|/*  Output arguments  */
literal|2
block|,
name|procedural_db_query_out_args
block|,
comment|/*  Exec method  */
block|{
block|{
name|procedural_db_query
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|procedural_db_init ()
name|procedural_db_init
parameter_list|()
block|{
name|app_init_update_status
argument_list|(
name|_
argument_list|(
literal|"Procedural Database"
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|procedural_ht
condition|)
name|procedural_ht
operator|=
name|g_hash_table_new
argument_list|(
name|procedural_db_hash_func
argument_list|,
name|g_str_equal
argument_list|)
expr_stmt|;
name|pdb_id_init
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|procedural_db_free ()
name|procedural_db_free
parameter_list|()
block|{
if|if
condition|(
name|procedural_ht
condition|)
name|g_hash_table_destroy
argument_list|(
name|procedural_ht
argument_list|)
expr_stmt|;
name|procedural_ht
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|procedural_db_register (ProcRecord * procedure)
name|procedural_db_register
parameter_list|(
name|ProcRecord
modifier|*
name|procedure
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
if|if
condition|(
operator|!
name|procedural_ht
condition|)
name|procedural_db_init
argument_list|()
expr_stmt|;
name|list
operator|=
name|g_hash_table_lookup
argument_list|(
name|procedural_ht
argument_list|,
operator|(
name|gpointer
operator|)
name|procedure
operator|->
name|name
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_list_prepend
argument_list|(
name|list
argument_list|,
operator|(
name|gpointer
operator|)
name|procedure
argument_list|)
expr_stmt|;
name|g_hash_table_insert
argument_list|(
name|procedural_ht
argument_list|,
operator|(
name|gpointer
operator|)
name|procedure
operator|->
name|name
argument_list|,
operator|(
name|gpointer
operator|)
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|procedural_db_unregister (gchar * name)
name|procedural_db_unregister
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|list
operator|=
name|g_hash_table_lookup
argument_list|(
name|procedural_ht
argument_list|,
operator|(
name|gpointer
operator|)
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
condition|)
block|{
name|list
operator|=
name|g_list_remove
argument_list|(
name|list
argument_list|,
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
condition|)
name|g_hash_table_insert
argument_list|(
name|procedural_ht
argument_list|,
operator|(
name|gpointer
operator|)
name|name
argument_list|,
operator|(
name|gpointer
operator|)
name|list
argument_list|)
expr_stmt|;
else|else
name|g_hash_table_remove
argument_list|(
name|procedural_ht
argument_list|,
operator|(
name|gpointer
operator|)
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|ProcRecord
modifier|*
DECL|function|procedural_db_lookup (gchar * name)
name|procedural_db_lookup
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|ProcRecord
modifier|*
name|procedure
decl_stmt|;
name|list
operator|=
name|g_hash_table_lookup
argument_list|(
name|procedural_ht
argument_list|,
operator|(
name|gpointer
operator|)
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|!=
name|NULL
condition|)
name|procedure
operator|=
operator|(
name|ProcRecord
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
else|else
name|procedure
operator|=
name|NULL
expr_stmt|;
return|return
name|procedure
return|;
block|}
end_function

begin_function
name|Argument
modifier|*
DECL|function|procedural_db_execute (gchar * name,Argument * args)
name|procedural_db_execute
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|,
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|ProcRecord
modifier|*
name|procedure
decl_stmt|;
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|int
name|i
decl_stmt|;
name|return_args
operator|=
name|NULL
expr_stmt|;
name|list
operator|=
name|g_hash_table_lookup
argument_list|(
name|procedural_ht
argument_list|,
operator|(
name|gpointer
operator|)
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
if|if
condition|(
operator|(
name|procedure
operator|=
operator|(
name|ProcRecord
operator|*
operator|)
name|list
operator|->
name|data
operator|)
operator|==
name|NULL
condition|)
block|{
name|return_args
operator|=
operator|(
name|Argument
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Argument
argument_list|)
argument_list|)
expr_stmt|;
name|return_args
operator|->
name|arg_type
operator|=
name|PDB_STATUS
expr_stmt|;
name|return_args
operator|->
name|value
operator|.
name|pdb_int
operator|=
name|PDB_CALLING_ERROR
expr_stmt|;
return|return
name|return_args
return|;
block|}
name|list
operator|=
name|list
operator|->
name|next
expr_stmt|;
comment|/*  check the arguments  */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|procedure
operator|->
name|num_args
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|args
index|[
name|i
index|]
operator|.
name|arg_type
operator|!=
name|procedure
operator|->
name|args
index|[
name|i
index|]
operator|.
name|arg_type
condition|)
block|{
name|return_args
operator|=
operator|(
name|Argument
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Argument
argument_list|)
argument_list|)
expr_stmt|;
name|return_args
operator|->
name|arg_type
operator|=
name|PDB_STATUS
expr_stmt|;
name|return_args
operator|->
name|value
operator|.
name|pdb_int
operator|=
name|PDB_CALLING_ERROR
expr_stmt|;
name|g_message
argument_list|(
name|_
argument_list|(
literal|"PDB calling error %s"
argument_list|)
argument_list|,
name|procedure
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|return_args
return|;
block|}
block|}
comment|/*  call the procedure  */
switch|switch
condition|(
name|procedure
operator|->
name|proc_type
condition|)
block|{
case|case
name|PDB_INTERNAL
case|:
name|return_args
operator|=
call|(
modifier|*
name|procedure
operator|->
name|exec_method
operator|.
name|internal
operator|.
name|marshal_func
call|)
argument_list|(
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_PLUGIN
case|:
name|return_args
operator|=
name|plug_in_run
argument_list|(
name|procedure
argument_list|,
name|args
argument_list|,
name|procedure
operator|->
name|num_args
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_EXTENSION
case|:
name|return_args
operator|=
name|plug_in_run
argument_list|(
name|procedure
argument_list|,
name|args
argument_list|,
name|procedure
operator|->
name|num_args
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_TEMPORARY
case|:
name|return_args
operator|=
name|plug_in_run
argument_list|(
name|procedure
argument_list|,
name|args
argument_list|,
name|procedure
operator|->
name|num_args
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|return_args
operator|=
operator|(
name|Argument
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Argument
argument_list|)
argument_list|)
expr_stmt|;
name|return_args
operator|->
name|arg_type
operator|=
name|PDB_STATUS
expr_stmt|;
name|return_args
operator|->
name|value
operator|.
name|pdb_int
operator|=
name|PDB_EXECUTION_ERROR
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|return_args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|!=
name|PDB_SUCCESS
operator|)
operator|&&
operator|(
name|procedure
operator|->
name|num_values
operator|>
literal|0
operator|)
condition|)
name|memset
argument_list|(
operator|&
name|return_args
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|Argument
argument_list|)
operator|*
name|procedure
operator|->
name|num_values
argument_list|)
expr_stmt|;
comment|/*  Check if the return value is a PDB_PASS_THROUGH, in which case run the        *  next procedure in the list        */
if|if
condition|(
name|return_args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|!=
name|PDB_PASS_THROUGH
condition|)
break|break;
elseif|else
if|if
condition|(
name|list
condition|)
comment|/*  Pass through, so destroy return values and run another procedure  */
name|procedural_db_destroy_args
argument_list|(
name|return_args
argument_list|,
name|procedure
operator|->
name|num_values
argument_list|)
expr_stmt|;
block|}
return|return
name|return_args
return|;
block|}
end_function

begin_function
name|Argument
modifier|*
DECL|function|procedural_db_run_proc (gchar * name,gint * nreturn_vals,...)
name|procedural_db_run_proc
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
modifier|...
parameter_list|)
block|{
name|ProcRecord
modifier|*
name|proc
decl_stmt|;
name|Argument
modifier|*
name|params
decl_stmt|;
name|Argument
modifier|*
name|return_vals
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|proc
operator|=
name|procedural_db_lookup
argument_list|(
name|name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|return_vals
operator|=
operator|(
name|Argument
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Argument
argument_list|)
argument_list|)
expr_stmt|;
name|return_vals
operator|->
name|arg_type
operator|=
name|PDB_STATUS
expr_stmt|;
name|return_vals
operator|->
name|value
operator|.
name|pdb_int
operator|=
name|PDB_CALLING_ERROR
expr_stmt|;
return|return
name|return_vals
return|;
block|}
comment|/*  allocate the parameter array  */
name|params
operator|=
name|g_new
argument_list|(
name|Argument
argument_list|,
name|proc
operator|->
name|num_args
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|nreturn_vals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|proc
operator|->
name|num_args
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|proc
operator|->
name|args
index|[
name|i
index|]
operator|.
name|arg_type
operator|!=
operator|(
name|params
index|[
name|i
index|]
operator|.
name|arg_type
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|PDBArgType
argument_list|)
operator|)
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Incorrect arguments passed to procedural_db_run_proc"
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|params
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
switch|switch
condition|(
name|proc
operator|->
name|args
index|[
name|i
index|]
operator|.
name|arg_type
condition|)
block|{
case|case
name|PDB_INT32
case|:
case|case
name|PDB_INT16
case|:
case|case
name|PDB_INT8
case|:
case|case
name|PDB_DISPLAY
case|:
name|params
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
operator|(
name|gint32
operator|)
name|va_arg
argument_list|(
name|args
argument_list|,
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_FLOAT
case|:
name|params
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_float
operator|=
operator|(
name|gdouble
operator|)
name|va_arg
argument_list|(
name|args
argument_list|,
name|double
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_STRING
case|:
case|case
name|PDB_INT32ARRAY
case|:
case|case
name|PDB_INT16ARRAY
case|:
case|case
name|PDB_INT8ARRAY
case|:
case|case
name|PDB_FLOATARRAY
case|:
case|case
name|PDB_STRINGARRAY
case|:
case|case
name|PDB_COLOR
case|:
name|params
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|void
operator|*
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_REGION
case|:
break|break;
case|case
name|PDB_IMAGE
case|:
case|case
name|PDB_LAYER
case|:
case|case
name|PDB_CHANNEL
case|:
case|case
name|PDB_DRAWABLE
case|:
case|case
name|PDB_SELECTION
case|:
case|case
name|PDB_BOUNDARY
case|:
case|case
name|PDB_PATH
case|:
name|params
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
operator|(
name|gint32
operator|)
name|va_arg
argument_list|(
name|args
argument_list|,
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_PARASITE
case|:
name|params
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|void
operator|*
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_STATUS
case|:
name|params
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
operator|(
name|gint32
operator|)
name|va_arg
argument_list|(
name|args
argument_list|,
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_END
case|:
break|break;
block|}
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
name|proc
operator|->
name|num_values
expr_stmt|;
name|return_vals
operator|=
name|procedural_db_execute
argument_list|(
name|name
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|params
argument_list|)
expr_stmt|;
return|return
name|return_vals
return|;
block|}
end_function

begin_function
name|Argument
modifier|*
DECL|function|procedural_db_return_args (ProcRecord * procedure,int success)
name|procedural_db_return_args
parameter_list|(
name|ProcRecord
modifier|*
name|procedure
parameter_list|,
name|int
name|success
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|int
name|i
decl_stmt|;
name|return_args
operator|=
operator|(
name|Argument
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Argument
argument_list|)
operator|*
operator|(
name|procedure
operator|->
name|num_values
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
condition|)
block|{
name|return_args
index|[
literal|0
index|]
operator|.
name|arg_type
operator|=
name|PDB_STATUS
expr_stmt|;
name|return_args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|PDB_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|return_args
index|[
literal|0
index|]
operator|.
name|arg_type
operator|=
name|PDB_STATUS
expr_stmt|;
name|return_args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|PDB_EXECUTION_ERROR
expr_stmt|;
block|}
comment|/*  Set the arg types for the return values  */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|procedure
operator|->
name|num_values
condition|;
name|i
operator|++
control|)
name|return_args
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|arg_type
operator|=
name|procedure
operator|->
name|values
index|[
name|i
index|]
operator|.
name|arg_type
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

begin_function
name|void
DECL|function|procedural_db_destroy_args (Argument * args,int nargs)
name|procedural_db_destroy_args
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|,
name|int
name|nargs
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|prev_val
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|strs
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nargs
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|args
index|[
name|i
index|]
operator|.
name|arg_type
condition|)
block|{
case|case
name|PDB_INT32
case|:
comment|/*  Keep this around in case we need to free an array of strings  */
name|prev_val
operator|=
name|args
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
break|break;
case|case
name|PDB_INT16
case|:
case|case
name|PDB_INT8
case|:
case|case
name|PDB_FLOAT
case|:
break|break;
case|case
name|PDB_STRING
case|:
case|case
name|PDB_INT32ARRAY
case|:
case|case
name|PDB_INT16ARRAY
case|:
case|case
name|PDB_INT8ARRAY
case|:
case|case
name|PDB_FLOATARRAY
case|:
name|g_free
argument_list|(
name|args
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_STRINGARRAY
case|:
name|strs
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|args
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|prev_val
condition|;
name|j
operator|++
control|)
name|g_free
argument_list|(
name|strs
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|strs
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_COLOR
case|:
name|g_free
argument_list|(
name|args
index|[
name|i
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDB_REGION
case|:
case|case
name|PDB_DISPLAY
case|:
case|case
name|PDB_IMAGE
case|:
case|case
name|PDB_LAYER
case|:
case|case
name|PDB_CHANNEL
case|:
case|case
name|PDB_DRAWABLE
case|:
case|case
name|PDB_SELECTION
case|:
case|case
name|PDB_BOUNDARY
case|:
case|case
name|PDB_PATH
case|:
case|case
name|PDB_PARASITE
case|:
case|case
name|PDB_STATUS
case|:
case|case
name|PDB_END
case|:
break|break;
block|}
block|}
name|g_free
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|procedural_db_dump (Argument * args)
name|procedural_db_dump
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|char
modifier|*
name|filename
decl_stmt|;
name|int
name|success
init|=
name|TRUE
decl_stmt|;
name|filename
operator|=
operator|(
name|char
operator|*
operator|)
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
if|if
condition|(
name|filename
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|procedural_db_out
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"wb"
argument_list|)
operator|)
condition|)
name|success
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|success
condition|)
block|{
name|g_hash_table_foreach
argument_list|(
name|procedural_ht
argument_list|,
name|procedural_db_print_entry
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|procedural_db_out
argument_list|)
expr_stmt|;
block|}
return|return
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_dump_proc
argument_list|,
name|success
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|procedural_db_print_entry (gpointer key,gpointer value,gpointer user_data)
name|procedural_db_print_entry
parameter_list|(
name|gpointer
name|key
parameter_list|,
name|gpointer
name|value
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|ProcRecord
modifier|*
name|procedure
decl_stmt|;
name|GList
modifier|*
name|list
init|=
operator|(
name|GList
operator|*
operator|)
name|value
decl_stmt|;
name|int
name|num
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|num
operator|++
expr_stmt|;
name|procedure
operator|=
operator|(
name|ProcRecord
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|list
operator|->
name|next
expr_stmt|;
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"\n(register-procedure "
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|||
name|num
operator|!=
literal|1
condition|)
block|{
name|buf
operator|=
name|g_new
argument_list|(
name|char
argument_list|,
name|strlen
argument_list|(
name|procedure
operator|->
name|name
argument_list|)
operator|+
literal|10
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s<%d>"
argument_list|,
name|procedure
operator|->
name|name
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|output_string
argument_list|(
name|procedure
operator|->
name|name
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|blurb
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|help
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|author
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|copyright
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|date
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|proc_type_str
index|[
operator|(
name|int
operator|)
name|procedure
operator|->
name|proc_type
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"( "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|procedure
operator|->
name|num_args
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"( "
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|args
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|type_str
index|[
name|procedure
operator|->
name|args
index|[
name|i
index|]
operator|.
name|arg_type
index|]
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|args
index|[
name|i
index|]
operator|.
name|description
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|" ) "
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|" ) "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"( "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|procedure
operator|->
name|num_values
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"( "
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|values
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|type_str
index|[
name|procedure
operator|->
name|values
index|[
name|i
index|]
operator|.
name|arg_type
index|]
argument_list|)
expr_stmt|;
name|output_string
argument_list|(
name|procedure
operator|->
name|values
index|[
name|i
index|]
operator|.
name|description
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|" ) "
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|" ) "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|" ) "
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|output_string (char * string)
name|output_string
parameter_list|(
name|char
modifier|*
name|string
parameter_list|)
block|{
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"\""
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|string
condition|)
block|{
switch|switch
condition|(
operator|*
name|string
condition|)
block|{
case|case
literal|'\\'
case|:
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"\\\\"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\"'
case|:
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"\\\""
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'{'
case|:
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"@{"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'@'
case|:
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"@@"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'}'
case|:
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"@}"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"%c"
argument_list|,
operator|*
name|string
argument_list|)
expr_stmt|;
block|}
name|string
operator|++
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|procedural_db_out
argument_list|,
literal|"\"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|procedural_db_proc_info (Argument * args)
name|procedural_db_proc_info
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|char
modifier|*
name|proc_name
decl_stmt|;
name|ProcRecord
modifier|*
name|proc
decl_stmt|;
name|proc_name
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
name|proc
operator|=
name|procedural_db_lookup
argument_list|(
name|proc_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|proc
operator|!=
name|NULL
condition|)
block|{
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_info_proc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|proc
operator|->
name|blurb
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|proc
operator|->
name|help
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|proc
operator|->
name|author
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|4
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|proc
operator|->
name|copyright
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|5
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|proc
operator|->
name|date
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|6
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|proc
operator|->
name|proc_type
expr_stmt|;
name|return_args
index|[
literal|7
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|proc
operator|->
name|num_args
expr_stmt|;
name|return_args
index|[
literal|8
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|proc
operator|->
name|num_values
expr_stmt|;
block|}
else|else
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_info_proc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|procedural_db_proc_arg (Argument * args)
name|procedural_db_proc_arg
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|ProcArg
modifier|*
name|arg
decl_stmt|;
name|int
name|arg_num
decl_stmt|;
name|char
modifier|*
name|proc_name
decl_stmt|;
name|ProcRecord
modifier|*
name|proc
decl_stmt|;
name|proc_name
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
name|arg_num
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|proc
operator|=
name|procedural_db_lookup
argument_list|(
name|proc_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|proc
operator|!=
name|NULL
operator|&&
operator|(
name|arg_num
operator|>=
literal|0
operator|&&
name|arg_num
operator|<
name|proc
operator|->
name|num_args
operator|)
condition|)
block|{
name|arg
operator|=
operator|&
name|proc
operator|->
name|args
index|[
name|arg_num
index|]
expr_stmt|;
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_arg_proc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|arg
operator|->
name|arg_type
expr_stmt|;
name|return_args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|arg
operator|->
name|name
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|arg
operator|->
name|description
argument_list|)
expr_stmt|;
block|}
else|else
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_arg_proc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|procedural_db_proc_val (Argument * args)
name|procedural_db_proc_val
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|ProcArg
modifier|*
name|val
decl_stmt|;
name|int
name|val_num
decl_stmt|;
name|char
modifier|*
name|proc_name
decl_stmt|;
name|ProcRecord
modifier|*
name|proc
decl_stmt|;
name|proc_name
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
name|val_num
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|proc
operator|=
name|procedural_db_lookup
argument_list|(
name|proc_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|proc
operator|!=
name|NULL
operator|&&
operator|(
name|val_num
operator|>=
literal|0
operator|&&
name|val_num
operator|<
name|proc
operator|->
name|num_values
operator|)
condition|)
block|{
name|val
operator|=
operator|&
name|proc
operator|->
name|values
index|[
name|val_num
index|]
expr_stmt|;
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_val_proc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|val
operator|->
name|arg_type
expr_stmt|;
name|return_args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|val
operator|->
name|name
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|g_strdup
argument_list|(
name|val
operator|->
name|description
argument_list|)
expr_stmt|;
block|}
else|else
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_val_proc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|procedural_db_get_data (Argument * args)
name|procedural_db_get_data
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|PDBData
modifier|*
name|data
decl_stmt|;
name|char
modifier|*
name|data_copy
decl_stmt|;
name|char
modifier|*
name|identifier
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|identifier
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
name|list
operator|=
name|data_list
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|data
operator|=
operator|(
name|PDBData
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|list
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|data
operator|->
name|identifier
argument_list|,
name|identifier
argument_list|)
operator|==
literal|0
condition|)
block|{
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_get_data_proc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|data
operator|->
name|bytes
expr_stmt|;
name|data_copy
operator|=
name|g_new
argument_list|(
name|char
argument_list|,
name|data
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data_copy
argument_list|,
name|data
operator|->
name|data
argument_list|,
name|data
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|data_copy
expr_stmt|;
return|return
name|return_args
return|;
block|}
block|}
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_val_proc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|procedural_db_get_data_size (Argument * args)
name|procedural_db_get_data_size
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|PDBData
modifier|*
name|data
decl_stmt|;
name|char
modifier|*
name|identifier
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|identifier
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
name|list
operator|=
name|data_list
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|data
operator|=
operator|(
name|PDBData
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|list
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|data
operator|->
name|identifier
argument_list|,
name|identifier
argument_list|)
operator|==
literal|0
condition|)
block|{
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_get_data_size_proc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|data
operator|->
name|bytes
expr_stmt|;
return|return
name|return_args
return|;
block|}
block|}
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_val_proc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|procedural_db_set_data (Argument * args)
name|procedural_db_set_data
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|PDBData
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|identifier
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|identifier
operator|=
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_pointer
expr_stmt|;
name|list
operator|=
name|data_list
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|(
operator|(
name|PDBData
operator|*
operator|)
name|list
operator|->
name|data
operator|)
operator|->
name|identifier
argument_list|,
name|identifier
argument_list|)
operator|==
literal|0
condition|)
name|data
operator|=
operator|(
name|PDBData
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|list
operator|->
name|next
expr_stmt|;
block|}
comment|/*  If there is not already data with the specified identifier, create a new one  */
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|data
operator|=
operator|(
name|PDBData
operator|*
operator|)
name|g_new
argument_list|(
name|PDBData
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|data_list
operator|=
name|g_list_append
argument_list|(
name|data_list
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
comment|/*  If there is, free the data  */
else|else
name|g_free
argument_list|(
name|data
operator|->
name|data
argument_list|)
expr_stmt|;
name|data
operator|->
name|identifier
operator|=
name|g_strdup
argument_list|(
name|identifier
argument_list|)
expr_stmt|;
name|data
operator|->
name|bytes
operator|=
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
expr_stmt|;
name|data
operator|->
name|data
operator|=
name|g_new
argument_list|(
name|char
argument_list|,
name|data
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|data
argument_list|,
operator|(
name|char
operator|*
operator|)
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|,
name|data
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_proc_val_proc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

begin_function
specifier|static
name|Argument
modifier|*
DECL|function|procedural_db_query (Argument * args)
name|procedural_db_query
parameter_list|(
name|Argument
modifier|*
name|args
parameter_list|)
block|{
name|Argument
modifier|*
name|return_args
decl_stmt|;
name|PDBQuery
name|pdb_query
decl_stmt|;
name|regcomp
argument_list|(
operator|&
name|pdb_query
operator|.
name|name_regex
argument_list|,
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regcomp
argument_list|(
operator|&
name|pdb_query
operator|.
name|blurb_regex
argument_list|,
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regcomp
argument_list|(
operator|&
name|pdb_query
operator|.
name|help_regex
argument_list|,
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regcomp
argument_list|(
operator|&
name|pdb_query
operator|.
name|author_regex
argument_list|,
name|args
index|[
literal|3
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regcomp
argument_list|(
operator|&
name|pdb_query
operator|.
name|copyright_regex
argument_list|,
name|args
index|[
literal|4
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regcomp
argument_list|(
operator|&
name|pdb_query
operator|.
name|date_regex
argument_list|,
name|args
index|[
literal|5
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regcomp
argument_list|(
operator|&
name|pdb_query
operator|.
name|proc_type_regex
argument_list|,
name|args
index|[
literal|6
index|]
operator|.
name|value
operator|.
name|pdb_pointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pdb_query
operator|.
name|list_of_procs
operator|=
name|NULL
expr_stmt|;
name|pdb_query
operator|.
name|num_procs
operator|=
literal|0
expr_stmt|;
name|g_hash_table_foreach
argument_list|(
name|procedural_ht
argument_list|,
name|procedural_db_query_entry
argument_list|,
operator|&
name|pdb_query
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pdb_query
operator|.
name|name_regex
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pdb_query
operator|.
name|blurb_regex
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pdb_query
operator|.
name|help_regex
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pdb_query
operator|.
name|author_regex
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pdb_query
operator|.
name|copyright_regex
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pdb_query
operator|.
name|date_regex
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pdb_query
operator|.
name|proc_type_regex
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|return_args
operator|=
name|procedural_db_return_args
argument_list|(
operator|&
name|procedural_db_query_proc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|return_args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|pdb_query
operator|.
name|num_procs
expr_stmt|;
name|return_args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_pointer
operator|=
name|pdb_query
operator|.
name|list_of_procs
expr_stmt|;
return|return
name|return_args
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|procedural_db_query_entry (gpointer key,gpointer value,gpointer user_data)
name|procedural_db_query_entry
parameter_list|(
name|gpointer
name|key
parameter_list|,
name|gpointer
name|value
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|ProcRecord
modifier|*
name|proc
decl_stmt|;
name|PDBQuery
modifier|*
name|pdb_query
decl_stmt|;
name|int
name|new_length
decl_stmt|;
name|list
operator|=
operator|(
name|GList
operator|*
operator|)
name|value
expr_stmt|;
name|proc
operator|=
operator|(
name|ProcRecord
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|pdb_query
operator|=
operator|(
name|PDBQuery
operator|*
operator|)
name|user_data
expr_stmt|;
if|if
condition|(
operator|!
name|match_strings
argument_list|(
operator|&
name|pdb_query
operator|->
name|name_regex
argument_list|,
name|proc
operator|->
name|name
argument_list|)
operator|&&
operator|!
name|match_strings
argument_list|(
operator|&
name|pdb_query
operator|->
name|blurb_regex
argument_list|,
name|proc
operator|->
name|blurb
argument_list|)
operator|&&
operator|!
name|match_strings
argument_list|(
operator|&
name|pdb_query
operator|->
name|help_regex
argument_list|,
name|proc
operator|->
name|help
argument_list|)
operator|&&
operator|!
name|match_strings
argument_list|(
operator|&
name|pdb_query
operator|->
name|author_regex
argument_list|,
name|proc
operator|->
name|author
argument_list|)
operator|&&
operator|!
name|match_strings
argument_list|(
operator|&
name|pdb_query
operator|->
name|copyright_regex
argument_list|,
name|proc
operator|->
name|copyright
argument_list|)
operator|&&
operator|!
name|match_strings
argument_list|(
operator|&
name|pdb_query
operator|->
name|date_regex
argument_list|,
name|proc
operator|->
name|date
argument_list|)
operator|&&
operator|!
name|match_strings
argument_list|(
operator|&
name|pdb_query
operator|->
name|proc_type_regex
argument_list|,
name|proc_type_str
index|[
operator|(
name|int
operator|)
name|proc
operator|->
name|proc_type
index|]
argument_list|)
condition|)
block|{
name|new_length
operator|=
operator|(
name|proc
operator|->
name|name
operator|)
condition|?
operator|(
name|strlen
argument_list|(
name|proc
operator|->
name|name
argument_list|)
operator|+
literal|1
operator|)
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|new_length
condition|)
block|{
name|pdb_query
operator|->
name|num_procs
operator|++
expr_stmt|;
name|pdb_query
operator|->
name|list_of_procs
operator|=
name|g_realloc
argument_list|(
name|pdb_query
operator|->
name|list_of_procs
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|char
operator|*
operator|*
argument_list|)
operator|*
name|pdb_query
operator|->
name|num_procs
operator|)
argument_list|)
expr_stmt|;
name|pdb_query
operator|->
name|list_of_procs
index|[
name|pdb_query
operator|->
name|num_procs
operator|-
literal|1
index|]
operator|=
name|g_strdup
argument_list|(
name|proc
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|match_strings (regex_t * preg,char * a)
name|match_strings
parameter_list|(
name|regex_t
modifier|*
name|preg
parameter_list|,
name|char
modifier|*
name|a
parameter_list|)
block|{
return|return
name|regexec
argument_list|(
name|preg
argument_list|,
name|a
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* We could just use g_str_hash() here ... that uses a different  * hash function, though  */
end_comment

begin_function
specifier|static
name|guint
DECL|function|procedural_db_hash_func (gconstpointer key)
name|procedural_db_hash_func
parameter_list|(
name|gconstpointer
name|key
parameter_list|)
block|{
specifier|const
name|gchar
modifier|*
name|string
decl_stmt|;
name|guint
name|result
decl_stmt|;
name|int
name|c
decl_stmt|;
comment|/*    * I tried a zillion different hash functions and asked many other    * people for advice.  Many people had their own favorite functions,    * all different, but no-one had much idea why they were good ones.    * I chose the one below (multiply by 9 and add new character)    * because of the following reasons:    *    * 1. Multiplying by 10 is perfect for keys that are decimal strings,    *    and multiplying by 9 is just about as good.    * 2. Times-9 is (shift-left-3) plus (old).  This means that each    *    character's bits hang around in the low-order bits of the    *    hash value for ever, plus they spread fairly rapidly up to    *    the high-order bits to fill out the hash value.  This seems    *    works well both for decimal and non-decimal strings.    *    * tclHash.c --    *    *      Implementation of in-memory hash tables for Tcl and Tcl-based    *      applications.    *    * Copyright (c) 1991-1993 The Regents of the University of California.    * Copyright (c) 1994 Sun Microsystems, Inc.    */
name|string
operator|=
operator|(
specifier|const
name|gchar
operator|*
operator|)
name|key
expr_stmt|;
name|result
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|c
operator|=
operator|*
name|string
expr_stmt|;
name|string
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
break|break;
name|result
operator|+=
operator|(
name|result
operator|<<
literal|3
operator|)
operator|+
name|c
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* The id system's remnants ... */
end_comment

begin_decl_stmt
DECL|variable|next_image_id
specifier|static
name|gint
name|next_image_id
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* static gint next_drawable_id; static gint next_display_id; */
end_comment

begin_decl_stmt
DECL|variable|image_hash
specifier|static
name|GHashTable
modifier|*
name|image_hash
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|drawable_hash
specifier|static
name|GHashTable
modifier|*
name|drawable_hash
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|display_hash
specifier|static
name|GHashTable
modifier|*
name|display_hash
decl_stmt|;
end_decl_stmt

begin_function
DECL|function|id_hash_func (gconstpointer id)
specifier|static
name|guint
name|id_hash_func
parameter_list|(
name|gconstpointer
name|id
parameter_list|)
block|{
return|return
operator|*
operator|(
operator|(
name|guint
operator|*
operator|)
name|id
operator|)
return|;
block|}
end_function

begin_function
DECL|function|id_cmp_func (gconstpointer id1,gconstpointer id2)
specifier|static
name|gboolean
name|id_cmp_func
parameter_list|(
name|gconstpointer
name|id1
parameter_list|,
name|gconstpointer
name|id2
parameter_list|)
block|{
return|return
operator|(
operator|*
operator|(
operator|(
name|guint
operator|*
operator|)
name|id1
operator|)
operator|==
operator|*
operator|(
operator|(
name|guint
operator|*
operator|)
name|id2
operator|)
operator|)
return|;
block|}
end_function

begin_function
DECL|function|add_cb (GimpSet * set,GimpImage * gimage,gpointer data)
specifier|static
name|void
name|add_cb
parameter_list|(
name|GimpSet
modifier|*
name|set
parameter_list|,
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|guint
modifier|*
name|id
init|=
name|g_new
argument_list|(
name|guint
argument_list|,
literal|1
argument_list|)
decl_stmt|;
operator|*
name|id
operator|=
name|next_image_id
operator|++
expr_stmt|;
name|gtk_object_set_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|gimage
argument_list|)
argument_list|,
literal|"pdb_id"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|g_hash_table_insert
argument_list|(
name|image_hash
argument_list|,
name|id
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|remove_cb (GimpSet * set,GimpImage * image,gpointer data)
specifier|static
name|void
name|remove_cb
parameter_list|(
name|GimpSet
modifier|*
name|set
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|guint
modifier|*
name|id
init|=
name|gtk_object_get_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|image
argument_list|)
argument_list|,
literal|"pdb_id"
argument_list|)
decl_stmt|;
name|gtk_object_remove_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|image
argument_list|)
argument_list|,
literal|"pdb_id"
argument_list|)
expr_stmt|;
name|g_hash_table_remove
argument_list|(
name|image_hash
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pdb_id_init (void)
specifier|static
name|void
name|pdb_id_init
parameter_list|(
name|void
parameter_list|)
block|{
name|image_hash
operator|=
name|g_hash_table_new
argument_list|(
name|id_hash_func
argument_list|,
name|id_cmp_func
argument_list|)
expr_stmt|;
name|drawable_hash
operator|=
name|g_hash_table_new
argument_list|(
name|id_hash_func
argument_list|,
name|id_cmp_func
argument_list|)
expr_stmt|;
name|display_hash
operator|=
name|g_hash_table_new
argument_list|(
name|id_hash_func
argument_list|,
name|id_cmp_func
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|image_context
argument_list|)
argument_list|,
literal|"add"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|add_cb
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|image_context
argument_list|)
argument_list|,
literal|"remove"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|remove_cb
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pdb_image_to_id (GimpImage * gimage)
name|gint
name|pdb_image_to_id
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|guint
modifier|*
name|id
init|=
name|gtk_object_get_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|gimage
argument_list|)
argument_list|,
literal|"pdb_id"
argument_list|)
decl_stmt|;
return|return
name|id
condition|?
operator|(
name|gint
operator|)
operator|*
name|id
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
DECL|function|pdb_id_to_image (gint id)
name|GimpImage
modifier|*
name|pdb_id_to_image
parameter_list|(
name|gint
name|id
parameter_list|)
block|{
return|return
name|g_hash_table_lookup
argument_list|(
name|image_hash
argument_list|,
operator|&
name|id
argument_list|)
return|;
block|}
end_function

end_unit

