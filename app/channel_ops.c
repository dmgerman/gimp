begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"channel_ops.h"
end_include

begin_include
include|#
directive|include
file|"cursorutil.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"floating_sel.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"gimpcontext.h"
end_include

begin_include
include|#
directive|include
file|"gimpui.h"
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpsizeentry.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_include
include|#
directive|include
file|"channel_pvt.h"
end_include

begin_include
include|#
directive|include
file|"layer_pvt.h"
end_include

begin_define
DECL|macro|ENTRY_WIDTH
define|#
directive|define
name|ENTRY_WIDTH
value|60
end_define

begin_typedef
DECL|typedef|OffsetDialog
typedef|typedef
name|struct
name|_OffsetDialog
name|OffsetDialog
typedef|;
end_typedef

begin_struct
DECL|struct|_OffsetDialog
struct|struct
name|_OffsetDialog
block|{
DECL|member|dlg
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
DECL|member|off_se
name|GtkWidget
modifier|*
name|off_se
decl_stmt|;
DECL|member|wrap_around
name|gboolean
name|wrap_around
decl_stmt|;
DECL|member|fill_type
name|ChannelOffsetType
name|fill_type
decl_stmt|;
DECL|member|gimage
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  Forward declarations  */
end_comment

begin_function_decl
specifier|static
name|void
name|offset_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|offset_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|offset_halfheight_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
DECL|function|channel_ops_offset (GimpImage * gimage)
name|channel_ops_offset
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|OffsetDialog
modifier|*
name|off_d
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|check
decl_stmt|;
name|GtkWidget
modifier|*
name|push
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkObject
modifier|*
name|adjustment
decl_stmt|;
name|GtkWidget
modifier|*
name|spinbutton
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|radio_button
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|off_d
operator|=
name|g_new
argument_list|(
name|OffsetDialog
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|off_d
operator|->
name|wrap_around
operator|=
name|TRUE
expr_stmt|;
name|off_d
operator|->
name|fill_type
operator|=
name|drawable_has_alpha
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|off_d
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
name|off_d
operator|->
name|dlg
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Offset"
argument_list|)
argument_list|,
literal|"offset"
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"dialogs/offset.html"
argument_list|,
name|GTK_WIN_POS_NONE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"OK"
argument_list|)
argument_list|,
name|offset_ok_callback
argument_list|,
name|off_d
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|,
name|offset_cancel_callback
argument_list|,
name|off_d
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  The vbox for first column of options  */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|off_d
operator|->
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
comment|/*  The table for the offsets  */
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  The offset labels  */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Offset X:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Y:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/*  The offset sizeentry  */
name|adjustment
operator|=
name|gtk_adjustment_new
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|spinbutton
operator|=
name|gtk_spin_button_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|adjustment
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_shadow_type
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|GTK_SHADOW_NONE
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_numeric
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|spinbutton
argument_list|,
literal|75
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|off_d
operator|->
name|off_se
operator|=
name|gimp_size_entry_new
argument_list|(
literal|1
argument_list|,
name|gimage
operator|->
name|unit
argument_list|,
literal|"%a"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|75
argument_list|,
name|GIMP_SIZE_ENTRY_UPDATE_SIZE
argument_list|)
expr_stmt|;
name|gimp_size_entry_add_field
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_table_attach_defaults
argument_list|(
name|GTK_TABLE
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
name|spinbutton
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|spinbutton
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|off_d
operator|->
name|off_se
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_unit
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
name|UNIT_PIXEL
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|xresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|1
argument_list|,
name|gimage
operator|->
name|yresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
name|gimage
operator|->
name|width
argument_list|,
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|-
name|gimage
operator|->
name|height
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/*  The wrap around option  */
name|check
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Wrap Around"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|check
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
comment|/*  The fill options  */
name|frame
operator|=
name|gimp_radio_group_new2
argument_list|(
name|TRUE
argument_list|,
name|_
argument_list|(
literal|"Fill Options"
argument_list|)
argument_list|,
name|gimp_radio_button_update
argument_list|,
operator|&
name|off_d
operator|->
name|fill_type
argument_list|,
operator|(
name|gpointer
operator|)
name|off_d
operator|->
name|fill_type
argument_list|,
name|_
argument_list|(
literal|"Background"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|OFFSET_BACKGROUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Transparent"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|OFFSET_TRANSPARENT
argument_list|,
operator|&
name|radio_button
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drawable_has_alpha
argument_list|(
name|drawable
argument_list|)
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|radio_button
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  The by half height and half width option */
name|push
operator|=
name|gtk_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Offset by (x/2),(y/2)"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|push
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|push
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|push
argument_list|)
expr_stmt|;
comment|/*  Hook up the wrap around  */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|check
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|off_d
operator|->
name|wrap_around
argument_list|)
expr_stmt|;
name|gtk_object_set_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|check
argument_list|)
argument_list|,
literal|"inverse_sensitive"
argument_list|,
name|frame
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|check
argument_list|)
argument_list|,
name|off_d
operator|->
name|wrap_around
argument_list|)
expr_stmt|;
comment|/*  Hook up the by half  */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|push
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|offset_halfheight_callback
argument_list|,
name|off_d
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|off_d
operator|->
name|dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|offset (GimpImage * gimage,GimpDrawable * drawable,gboolean wrap_around,ChannelOffsetType fill_type,gint offset_x,gint offset_y)
name|offset
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gboolean
name|wrap_around
parameter_list|,
name|ChannelOffsetType
name|fill_type
parameter_list|,
name|gint
name|offset_x
parameter_list|,
name|gint
name|offset_y
parameter_list|)
block|{
name|PixelRegion
name|srcPR
decl_stmt|,
name|destPR
decl_stmt|;
name|TileManager
modifier|*
name|new_tiles
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|src_x
decl_stmt|,
name|src_y
decl_stmt|;
name|int
name|dest_x
decl_stmt|,
name|dest_y
decl_stmt|;
name|unsigned
name|char
name|fill
index|[
name|MAX_CHANNELS
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|drawable
condition|)
return|return;
name|width
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|height
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrap_around
condition|)
block|{
name|offset_x
operator|%=
name|width
expr_stmt|;
name|offset_y
operator|%=
name|height
expr_stmt|;
block|}
else|else
block|{
name|offset_x
operator|=
name|BOUNDS
argument_list|(
name|offset_x
argument_list|,
operator|-
name|width
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|offset_y
operator|=
name|BOUNDS
argument_list|(
name|offset_y
argument_list|,
operator|-
name|height
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|offset_x
operator|==
literal|0
operator|&&
name|offset_y
operator|==
literal|0
condition|)
return|return;
name|new_tiles
operator|=
name|tile_manager_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|drawable_bytes
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset_x
operator|>=
literal|0
condition|)
block|{
name|src_x
operator|=
literal|0
expr_stmt|;
name|dest_x
operator|=
name|offset_x
expr_stmt|;
name|width
operator|=
name|BOUNDS
argument_list|(
operator|(
name|width
operator|-
name|offset_x
operator|)
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|src_x
operator|=
operator|-
name|offset_x
expr_stmt|;
name|dest_x
operator|=
literal|0
expr_stmt|;
name|width
operator|=
name|BOUNDS
argument_list|(
operator|(
name|width
operator|+
name|offset_x
operator|)
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|offset_y
operator|>=
literal|0
condition|)
block|{
name|src_y
operator|=
literal|0
expr_stmt|;
name|dest_y
operator|=
name|offset_y
expr_stmt|;
name|height
operator|=
name|BOUNDS
argument_list|(
operator|(
name|height
operator|-
name|offset_y
operator|)
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|src_y
operator|=
operator|-
name|offset_y
expr_stmt|;
name|dest_y
operator|=
literal|0
expr_stmt|;
name|height
operator|=
name|BOUNDS
argument_list|(
operator|(
name|height
operator|+
name|offset_y
operator|)
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
comment|/*  Copy the center region  */
if|if
condition|(
name|width
operator|&&
name|height
condition|)
block|{
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|src_x
argument_list|,
name|src_y
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
argument_list|,
name|dest_y
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|copy_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
block|}
comment|/*  Copy appropriately for wrap around  */
if|if
condition|(
name|wrap_around
operator|==
name|TRUE
condition|)
block|{
if|if
condition|(
name|offset_x
operator|>=
literal|0
operator|&&
name|offset_y
operator|>=
literal|0
condition|)
block|{
name|src_x
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|-
name|offset_x
expr_stmt|;
name|src_y
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|-
name|offset_y
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset_x
operator|>=
literal|0
operator|&&
name|offset_y
operator|<
literal|0
condition|)
block|{
name|src_x
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|-
name|offset_x
expr_stmt|;
name|src_y
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset_x
operator|<
literal|0
operator|&&
name|offset_y
operator|>=
literal|0
condition|)
block|{
name|src_x
operator|=
literal|0
expr_stmt|;
name|src_y
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|-
name|offset_y
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset_x
operator|<
literal|0
operator|&&
name|offset_y
operator|<
literal|0
condition|)
block|{
name|src_x
operator|=
literal|0
expr_stmt|;
name|src_y
operator|=
literal|0
expr_stmt|;
block|}
name|dest_x
operator|=
operator|(
name|src_x
operator|+
name|offset_x
operator|)
operator|%
name|drawable_width
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest_x
operator|<
literal|0
condition|)
name|dest_x
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|+
name|dest_x
expr_stmt|;
name|dest_y
operator|=
operator|(
name|src_y
operator|+
name|offset_y
operator|)
operator|%
name|drawable_height
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest_y
operator|<
literal|0
condition|)
name|dest_y
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|+
name|dest_y
expr_stmt|;
comment|/*  intersecting region  */
if|if
condition|(
name|offset_x
operator|!=
literal|0
operator|&&
name|offset_y
operator|!=
literal|0
condition|)
block|{
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|src_x
argument_list|,
name|src_y
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
argument_list|,
name|dest_y
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|copy_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
block|}
comment|/*  X offset  */
if|if
condition|(
name|offset_x
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|offset_y
operator|>=
literal|0
condition|)
block|{
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|src_x
argument_list|,
literal|0
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
argument_list|,
name|dest_y
operator|+
name|offset_y
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset_y
operator|<
literal|0
condition|)
block|{
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|src_x
argument_list|,
name|src_y
operator|-
name|offset_y
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
argument_list|,
literal|0
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
name|copy_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
block|}
comment|/*  X offset  */
if|if
condition|(
name|offset_y
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|offset_x
operator|>=
literal|0
condition|)
block|{
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
literal|0
argument_list|,
name|src_y
argument_list|,
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
operator|+
name|offset_x
argument_list|,
name|dest_y
argument_list|,
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset_x
operator|<
literal|0
condition|)
block|{
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|src_x
operator|-
name|offset_x
argument_list|,
name|src_y
argument_list|,
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
literal|0
argument_list|,
name|dest_y
argument_list|,
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
name|copy_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  Otherwise, fill the vacated regions  */
else|else
block|{
if|if
condition|(
name|fill_type
operator|==
name|OFFSET_BACKGROUND
condition|)
block|{
name|gimp_context_get_background
argument_list|(
name|NULL
argument_list|,
operator|&
name|fill
index|[
literal|0
index|]
argument_list|,
operator|&
name|fill
index|[
literal|1
index|]
argument_list|,
operator|&
name|fill
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|drawable_has_alpha
argument_list|(
name|drawable
argument_list|)
condition|)
name|fill
index|[
name|drawable_bytes
argument_list|(
name|drawable
argument_list|)
operator|-
literal|1
index|]
operator|=
name|OPAQUE_OPACITY
expr_stmt|;
block|}
if|if
condition|(
name|offset_x
operator|>=
literal|0
operator|&&
name|offset_y
operator|>=
literal|0
condition|)
block|{
name|dest_x
operator|=
literal|0
expr_stmt|;
name|dest_y
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset_x
operator|>=
literal|0
operator|&&
name|offset_y
operator|<
literal|0
condition|)
block|{
name|dest_x
operator|=
literal|0
expr_stmt|;
name|dest_y
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|+
name|offset_y
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset_x
operator|<
literal|0
operator|&&
name|offset_y
operator|>=
literal|0
condition|)
block|{
name|dest_x
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|+
name|offset_x
expr_stmt|;
name|dest_y
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset_x
operator|<
literal|0
operator|&&
name|offset_y
operator|<
literal|0
condition|)
block|{
name|dest_x
operator|=
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|+
name|offset_x
expr_stmt|;
name|dest_y
operator|=
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|+
name|offset_y
expr_stmt|;
block|}
comment|/*  intersecting region  */
if|if
condition|(
name|offset_x
operator|!=
literal|0
operator|&&
name|offset_y
operator|!=
literal|0
condition|)
block|{
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
argument_list|,
name|dest_y
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|color_region
argument_list|(
operator|&
name|destPR
argument_list|,
name|fill
argument_list|)
expr_stmt|;
block|}
comment|/*  X offset  */
if|if
condition|(
name|offset_x
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|offset_y
operator|>=
literal|0
condition|)
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
argument_list|,
name|dest_y
operator|+
name|offset_y
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset_y
operator|<
literal|0
condition|)
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
argument_list|,
literal|0
argument_list|,
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|color_region
argument_list|(
operator|&
name|destPR
argument_list|,
name|fill
argument_list|)
expr_stmt|;
block|}
comment|/*  X offset  */
if|if
condition|(
name|offset_y
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|offset_x
operator|>=
literal|0
condition|)
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
name|dest_x
operator|+
name|offset_x
argument_list|,
name|dest_y
argument_list|,
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|offset_x
operator|<
literal|0
condition|)
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|new_tiles
argument_list|,
literal|0
argument_list|,
name|dest_y
argument_list|,
name|drawable_width
argument_list|(
name|drawable
argument_list|)
operator|-
name|ABS
argument_list|(
name|offset_x
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|offset_y
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|color_region
argument_list|(
operator|&
name|destPR
argument_list|,
name|fill
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  push an undo  */
name|drawable_apply_image
argument_list|(
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable_width
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|drawable_data
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  swap the tiles  */
name|drawable
operator|->
name|tiles
operator|=
name|new_tiles
expr_stmt|;
comment|/*  update the drawable  */
name|drawable_update
argument_list|(
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable_width
argument_list|(
name|drawable
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  Interface callbacks  */
end_comment

begin_function
specifier|static
name|void
DECL|function|offset_ok_callback (GtkWidget * widget,gpointer data)
name|offset_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|OffsetDialog
modifier|*
name|off_d
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|gint
name|offset_x
decl_stmt|;
name|gint
name|offset_y
decl_stmt|;
name|off_d
operator|=
operator|(
name|OffsetDialog
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|gimage
operator|=
name|off_d
operator|->
name|gimage
operator|)
operator|!=
name|NULL
condition|)
block|{
name|drawable
operator|=
name|gimage_active_drawable
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|offset_x
operator|=
call|(
name|gint
call|)
argument_list|(
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|offset_y
operator|=
call|(
name|gint
call|)
argument_list|(
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|offset
argument_list|(
name|gimage
argument_list|,
name|drawable
argument_list|,
name|off_d
operator|->
name|wrap_around
argument_list|,
name|off_d
operator|->
name|fill_type
argument_list|,
name|offset_x
argument_list|,
name|offset_y
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
name|gtk_widget_destroy
argument_list|(
name|off_d
operator|->
name|dlg
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|off_d
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|offset_cancel_callback (GtkWidget * widget,gpointer data)
name|offset_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|OffsetDialog
modifier|*
name|off_d
decl_stmt|;
name|off_d
operator|=
operator|(
name|OffsetDialog
operator|*
operator|)
name|data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|off_d
operator|->
name|dlg
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|off_d
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|offset_halfheight_callback (GtkWidget * widget,gpointer data)
name|offset_halfheight_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|OffsetDialog
modifier|*
name|off_d
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|off_d
operator|=
operator|(
name|OffsetDialog
operator|*
operator|)
name|data
expr_stmt|;
name|gimage
operator|=
name|off_d
operator|->
name|gimage
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
operator|/
literal|2
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|off_d
operator|->
name|off_se
argument_list|)
argument_list|,
literal|1
argument_list|,
name|gimage
operator|->
name|height
operator|/
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GimpImage
modifier|*
DECL|function|duplicate (GimpImage * gimage)
name|duplicate
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|PixelRegion
name|srcPR
decl_stmt|,
name|destPR
decl_stmt|;
name|GimpImage
modifier|*
name|new_gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|,
modifier|*
name|new_layer
decl_stmt|;
name|Layer
modifier|*
name|floating_layer
decl_stmt|;
name|Channel
modifier|*
name|channel
decl_stmt|,
modifier|*
name|new_channel
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
name|GList
modifier|*
name|glist
decl_stmt|;
name|Guide
modifier|*
name|guide
init|=
name|NULL
decl_stmt|;
name|Layer
modifier|*
name|active_layer
init|=
name|NULL
decl_stmt|;
name|Channel
modifier|*
name|active_channel
init|=
name|NULL
decl_stmt|;
name|GimpDrawable
modifier|*
name|new_floating_sel_drawable
init|=
name|NULL
decl_stmt|;
name|GimpDrawable
modifier|*
name|floating_sel_drawable
init|=
name|NULL
decl_stmt|;
name|gint
name|count
decl_stmt|;
name|gimp_add_busy_cursors_until_idle
argument_list|()
expr_stmt|;
comment|/*  Create a new image  */
name|new_gimage
operator|=
name|gimage_new
argument_list|(
name|gimage
operator|->
name|width
argument_list|,
name|gimage
operator|->
name|height
argument_list|,
name|gimage
operator|->
name|base_type
argument_list|)
expr_stmt|;
name|gimage_disable_undo
argument_list|(
name|new_gimage
argument_list|)
expr_stmt|;
comment|/*  Copy resolution and unit information  */
name|new_gimage
operator|->
name|xresolution
operator|=
name|gimage
operator|->
name|xresolution
expr_stmt|;
name|new_gimage
operator|->
name|yresolution
operator|=
name|gimage
operator|->
name|yresolution
expr_stmt|;
name|new_gimage
operator|->
name|unit
operator|=
name|gimage
operator|->
name|unit
expr_stmt|;
comment|/*  Copy floating layer  */
name|floating_layer
operator|=
name|gimage_floating_sel
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
name|floating_layer
condition|)
block|{
name|floating_sel_relax
argument_list|(
name|floating_layer
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|floating_sel_drawable
operator|=
name|floating_layer
operator|->
name|fs
operator|.
name|drawable
expr_stmt|;
name|floating_layer
operator|=
name|NULL
expr_stmt|;
block|}
comment|/*  Copy the layers  */
name|list
operator|=
name|gimage
operator|->
name|layers
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|layer
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|new_layer
operator|=
name|layer_copy
argument_list|(
name|layer
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_drawable_set_gimage
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|new_layer
argument_list|)
argument_list|,
name|new_gimage
argument_list|)
expr_stmt|;
comment|/*  Make sure the copied layer doesn't say: "<old layer> copy"  */
name|layer_set_name
argument_list|(
name|GIMP_LAYER
argument_list|(
name|new_layer
argument_list|)
argument_list|,
name|layer_get_name
argument_list|(
name|GIMP_LAYER
argument_list|(
name|layer
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  Make sure if the layer has a layer mask, it's name isn't screwed up  */
if|if
condition|(
name|new_layer
operator|->
name|mask
condition|)
block|{
name|gimp_drawable_set_name
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|new_layer
operator|->
name|mask
argument_list|)
argument_list|,
name|gimp_drawable_get_name
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
operator|->
name|mask
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gimage
operator|->
name|active_layer
operator|==
name|layer
condition|)
name|active_layer
operator|=
name|new_layer
expr_stmt|;
if|if
condition|(
name|gimage
operator|->
name|floating_sel
operator|==
name|layer
condition|)
name|floating_layer
operator|=
name|new_layer
expr_stmt|;
if|if
condition|(
name|floating_sel_drawable
operator|==
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
condition|)
name|new_floating_sel_drawable
operator|=
name|GIMP_DRAWABLE
argument_list|(
name|new_layer
argument_list|)
expr_stmt|;
comment|/*  Add the layer  */
if|if
condition|(
name|floating_layer
operator|!=
name|new_layer
condition|)
name|gimage_add_layer
argument_list|(
name|new_gimage
argument_list|,
name|new_layer
argument_list|,
name|count
operator|++
argument_list|)
expr_stmt|;
block|}
comment|/*  Copy the channels  */
name|list
operator|=
name|gimage
operator|->
name|channels
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|channel
operator|=
operator|(
name|Channel
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|new_channel
operator|=
name|channel_copy
argument_list|(
name|channel
argument_list|)
expr_stmt|;
name|gimp_drawable_set_gimage
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|new_channel
argument_list|)
argument_list|,
name|new_gimage
argument_list|)
expr_stmt|;
comment|/*  Make sure the copied channel doesn't say: "<old channel> copy"  */
name|gimp_drawable_set_name
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|new_channel
argument_list|)
argument_list|,
name|gimp_drawable_get_name
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|channel
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimage
operator|->
name|active_channel
operator|==
name|channel
condition|)
name|active_channel
operator|=
operator|(
name|new_channel
operator|)
expr_stmt|;
if|if
condition|(
name|floating_sel_drawable
operator|==
name|GIMP_DRAWABLE
argument_list|(
name|channel
argument_list|)
condition|)
name|new_floating_sel_drawable
operator|=
name|GIMP_DRAWABLE
argument_list|(
name|new_channel
argument_list|)
expr_stmt|;
comment|/*  Add the channel  */
name|gimage_add_channel
argument_list|(
name|new_gimage
argument_list|,
name|new_channel
argument_list|,
name|count
operator|++
argument_list|)
expr_stmt|;
block|}
comment|/*  Copy the selection mask  */
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable_data
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|gimage
operator|->
name|selection_mask
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|,
name|gimage
operator|->
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|drawable_data
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|new_gimage
operator|->
name|selection_mask
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|,
name|gimage
operator|->
name|height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|copy_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
name|new_gimage
operator|->
name|selection_mask
operator|->
name|bounds_known
operator|=
name|FALSE
expr_stmt|;
name|new_gimage
operator|->
name|selection_mask
operator|->
name|boundary_known
operator|=
name|FALSE
expr_stmt|;
comment|/*  Set active layer, active channel  */
name|new_gimage
operator|->
name|active_layer
operator|=
name|active_layer
expr_stmt|;
name|new_gimage
operator|->
name|active_channel
operator|=
name|active_channel
expr_stmt|;
if|if
condition|(
name|floating_layer
condition|)
name|floating_sel_attach
argument_list|(
name|floating_layer
argument_list|,
name|new_floating_sel_drawable
argument_list|)
expr_stmt|;
comment|/*  Copy the colormap if necessary  */
if|if
condition|(
name|new_gimage
operator|->
name|base_type
operator|==
name|INDEXED
condition|)
name|memcpy
argument_list|(
name|new_gimage
operator|->
name|cmap
argument_list|,
name|gimage
operator|->
name|cmap
argument_list|,
name|gimage
operator|->
name|num_cols
operator|*
literal|3
argument_list|)
expr_stmt|;
name|new_gimage
operator|->
name|num_cols
operator|=
name|gimage
operator|->
name|num_cols
expr_stmt|;
comment|/*  copy state of all color channels  */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
name|MAX_CHANNELS
condition|;
name|count
operator|++
control|)
block|{
name|new_gimage
operator|->
name|visible
index|[
name|count
index|]
operator|=
name|gimage
operator|->
name|visible
index|[
name|count
index|]
expr_stmt|;
name|new_gimage
operator|->
name|active
index|[
name|count
index|]
operator|=
name|gimage
operator|->
name|active
index|[
name|count
index|]
expr_stmt|;
block|}
comment|/*  Copy any Guides  */
name|glist
operator|=
name|gimage
operator|->
name|guides
expr_stmt|;
while|while
condition|(
name|glist
condition|)
block|{
name|Guide
modifier|*
name|new_guide
decl_stmt|;
name|guide
operator|=
operator|(
name|Guide
operator|*
operator|)
name|glist
operator|->
name|data
expr_stmt|;
name|glist
operator|=
name|g_list_next
argument_list|(
name|glist
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|guide
operator|->
name|orientation
condition|)
block|{
case|case
name|ORIENTATION_HORIZONTAL
case|:
name|new_guide
operator|=
name|gimp_image_add_hguide
argument_list|(
name|new_gimage
argument_list|)
expr_stmt|;
name|new_guide
operator|->
name|position
operator|=
name|guide
operator|->
name|position
expr_stmt|;
break|break;
case|case
name|ORIENTATION_VERTICAL
case|:
name|new_guide
operator|=
name|gimp_image_add_vguide
argument_list|(
name|new_gimage
argument_list|)
expr_stmt|;
name|new_guide
operator|->
name|position
operator|=
name|guide
operator|->
name|position
expr_stmt|;
break|break;
default|default:
name|g_error
argument_list|(
literal|"Unknown guide orientation.\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Copy the qmask info */
name|new_gimage
operator|->
name|qmask_state
operator|=
name|gimage
operator|->
name|qmask_state
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|3
condition|;
name|count
operator|++
control|)
name|new_gimage
operator|->
name|qmask_color
index|[
name|count
index|]
operator|=
name|gimage
operator|->
name|qmask_color
index|[
name|count
index|]
expr_stmt|;
name|new_gimage
operator|->
name|qmask_opacity
operator|=
name|gimage
operator|->
name|qmask_opacity
expr_stmt|;
name|gimage_enable_undo
argument_list|(
name|new_gimage
argument_list|)
expr_stmt|;
return|return
name|new_gimage
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|I_LIKE_BOGUS_CRAP
end_ifdef

begin_function
specifier|static
name|void
DECL|function|duplicate_projection (GimpImage * oldgimage,GimpImage * newgimage,GDisplay * newgdisplay)
name|duplicate_projection
parameter_list|(
name|GimpImage
modifier|*
name|oldgimage
parameter_list|,
name|GimpImage
modifier|*
name|newgimage
parameter_list|,
name|GDisplay
modifier|*
name|newgdisplay
parameter_list|)
block|{
name|PixelRegion
name|srcPR
decl_stmt|,
name|destPR
decl_stmt|;
comment|/*  Copy-on-write the projection tilemanager so we don't have    *  to reproject the new gimage - since if we do the duplicate    *  operation correctly, the projection for the new gimage is    *  identical to that of the source.  (Is this true?  View-only    *  attributes vs. image meta-attributes? -- View-only attributes    *  *should* strictly be applied post-projection.)    */
if|#
directive|if
literal|0
block|newgimage->construct_flag = oldgimage->construct_flag;    g_warning("CONSTR:%d %dx%dx%d",newgimage->construct_flag, 	    tile_manager_level_width(gimp_image_projection (newgimage)), 	    tile_manager_level_height(gimp_image_projection (newgimage)), 	    tile_manager_level_bpp(gimp_image_projection (newgimage)) 	    );    gdisplay_expose_area(newgdisplay, 		       newgdisplay->disp_xoffset, newgdisplay->disp_yoffset, 		       newgdisplay->disp_width, newgdisplay->disp_height);      if (newgimage->construct_flag)
endif|#
directive|endif
block|{
name|tile_manager_set_user_data
argument_list|(
name|gimp_image_projection
argument_list|(
name|newgimage
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|newgimage
argument_list|)
expr_stmt|;
comment|/*       newgimage->proj_type = oldgimage->proj_type;       newgimage->proj_bytes = oldgimage->proj_bytes;       newgimage->proj_level = oldgimage->proj_level;              gimage_projection_realloc (new_gimage);*/
name|pixel_region_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|gimp_image_projection
argument_list|(
name|oldgimage
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|oldgimage
operator|->
name|width
argument_list|,
name|oldgimage
operator|->
name|height
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|destPR
argument_list|,
name|gimp_image_projection
argument_list|(
name|newgimage
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|newgimage
operator|->
name|width
argument_list|,
name|newgimage
operator|->
name|height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|copy_region
argument_list|(
operator|&
name|srcPR
argument_list|,
operator|&
name|destPR
argument_list|)
expr_stmt|;
comment|/*       pixel_region_init (&srcPR, gimp_image_projection (oldgimage), 			 newgdisplay->disp_xoffset, newgdisplay->disp_yoffset, 			 newgdisplay->disp_width, newgdisplay->disp_height, 			 FALSE);       pixel_region_init (&destPR, gimp_image_projection (newgimage), 			 newgdisplay->disp_xoffset, newgdisplay->disp_yoffset, 			 newgdisplay->disp_width, newgdisplay->disp_height, 			 TRUE);       copy_region(&srcPR,&destPR);       */
if|if
condition|(
literal|1
condition|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gdisp
operator|=
name|newgdisplay
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" [pointers: %p, %p ] "
argument_list|,
name|oldgimage
argument_list|,
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gdisplay_untransform_coords
argument_list|(
name|gdisp
argument_list|,
name|gdisp
operator|->
name|disp_width
argument_list|,
name|gdisp
operator|->
name|disp_height
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"<%dx%d %dx%d %d,%d->%d,%d> "
argument_list|,
name|oldgimage
operator|->
name|width
argument_list|,
name|oldgimage
operator|->
name|height
argument_list|,
name|newgimage
operator|->
name|width
argument_list|,
name|newgimage
operator|->
name|height
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|gimage_invalidate_without_render
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|,
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|,
comment|//	  64,64,128,128);
comment|//					  newgdisplay->disp_width,newgdisplay->disp_height,
comment|//					  newgdisplay->disp_width+newgdisplay->disp_xoffset,newgdisplay->disp_height+newgdisplay->disp_yoffset
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
DECL|function|channel_ops_duplicate (GimpImage * gimage)
name|channel_ops_duplicate
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|GDisplay
modifier|*
name|new_gdisp
decl_stmt|;
name|GImage
modifier|*
name|new_gimage
decl_stmt|;
name|new_gimage
operator|=
name|duplicate
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
comment|/* We don't want to copy a half-redrawn projection, so force a flush. */
comment|/* gdisplays_finish_draw();   gdisplays_flush_now(); */
name|new_gdisp
operator|=
name|gdisplay_new
argument_list|(
name|new_gimage
argument_list|,
literal|0x0101
argument_list|)
expr_stmt|;
comment|/* duplicate_projection(gimage, new_gimage, new_gdisp);*/
block|}
end_function

end_unit

