begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<glib.h>
end_include

begin_include
include|#
directive|include
file|<fontconfig/fontconfig.h>
end_include

begin_include
include|#
directive|include
file|<pango/pangoft2.h>
end_include

begin_include
include|#
directive|include
file|"libgimpbase/gimpenv.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp-utils.h"
end_include

begin_include
include|#
directive|include
file|"sanity.h"
end_include

begin_include
include|#
directive|include
file|"gimp-intl.h"
end_include

begin_function_decl
specifier|static
name|gchar
modifier|*
name|sanity_check_glib
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gchar
modifier|*
name|sanity_check_fontconfig
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gchar
modifier|*
name|sanity_check_freetype
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gchar
modifier|*
name|sanity_check_filename_encoding
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  public functions  */
end_comment

begin_function
specifier|const
name|gchar
modifier|*
DECL|function|sanity_check (void)
name|sanity_check
parameter_list|(
name|void
parameter_list|)
block|{
name|gchar
modifier|*
name|abort_message
init|=
name|sanity_check_glib
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|abort_message
condition|)
name|abort_message
operator|=
name|sanity_check_fontconfig
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|abort_message
condition|)
name|abort_message
operator|=
name|sanity_check_freetype
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|abort_message
condition|)
name|abort_message
operator|=
name|sanity_check_filename_encoding
argument_list|()
expr_stmt|;
return|return
name|abort_message
return|;
block|}
end_function

begin_comment
comment|/*  private functions  */
end_comment

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|sanity_check_glib (void)
name|sanity_check_glib
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|gchar
modifier|*
name|mismatch
decl_stmt|;
DECL|macro|GLIB_REQUIRED_MAJOR
define|#
directive|define
name|GLIB_REQUIRED_MAJOR
value|2
DECL|macro|GLIB_REQUIRED_MINOR
define|#
directive|define
name|GLIB_REQUIRED_MINOR
value|4
DECL|macro|GLIB_REQUIRED_MICRO
define|#
directive|define
name|GLIB_REQUIRED_MICRO
value|5
name|mismatch
operator|=
name|gimp_check_glib_version
argument_list|(
name|GLIB_REQUIRED_MAJOR
argument_list|,
name|GLIB_REQUIRED_MINOR
argument_list|,
name|GLIB_REQUIRED_MICRO
argument_list|)
expr_stmt|;
if|if
condition|(
name|mismatch
condition|)
block|{
return|return
name|g_strdup_printf
argument_list|(
literal|"%s\n\n"
literal|"The GIMP requires GLib+ version %d.%d.%d or later.\n"
literal|"Installed GLib+ version is %d.%d.%d.\n\n"
literal|"Somehow you or your software packager managed\n"
literal|"to install The GIMP with an older GLib+ version.\n\n"
literal|"Please upgrade to GLib+ version %d.%d.%d or later."
argument_list|,
name|mismatch
argument_list|,
name|GLIB_REQUIRED_MAJOR
argument_list|,
name|GLIB_REQUIRED_MINOR
argument_list|,
name|GLIB_REQUIRED_MICRO
argument_list|,
name|glib_major_version
argument_list|,
name|glib_minor_version
argument_list|,
name|glib_micro_version
argument_list|,
name|GLIB_REQUIRED_MAJOR
argument_list|,
name|GLIB_REQUIRED_MINOR
argument_list|,
name|GLIB_REQUIRED_MICRO
argument_list|)
return|;
block|}
undef|#
directive|undef
name|GLIB_REQUIRED_MAJOR
undef|#
directive|undef
name|GLIB_REQUIRED_MINOR
undef|#
directive|undef
name|GLIB_REQUIRED_MICRO
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|sanity_check_fontconfig (void)
name|sanity_check_fontconfig
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|fc_version
init|=
name|FcGetVersion
argument_list|()
decl_stmt|;
name|gint
name|fc_major_version
init|=
name|fc_version
operator|/
literal|100
operator|/
literal|100
decl_stmt|;
name|gint
name|fc_minor_version
init|=
name|fc_version
operator|/
literal|100
operator|%
literal|100
decl_stmt|;
name|gint
name|fc_micro_version
init|=
name|fc_version
operator|%
literal|100
decl_stmt|;
DECL|macro|FC_REQUIRED_MAJOR
define|#
directive|define
name|FC_REQUIRED_MAJOR
value|2
DECL|macro|FC_REQUIRED_MINOR
define|#
directive|define
name|FC_REQUIRED_MINOR
value|2
DECL|macro|FC_REQUIRED_MICRO
define|#
directive|define
name|FC_REQUIRED_MICRO
value|0
if|if
condition|(
name|fc_version
operator|<
operator|(
operator|(
name|FC_REQUIRED_MAJOR
operator|*
literal|10000
operator|)
operator|+
operator|(
name|FC_REQUIRED_MINOR
operator|*
literal|100
operator|)
operator|+
operator|(
name|FC_REQUIRED_MICRO
operator|*
literal|1
operator|)
operator|)
condition|)
block|{
return|return
name|g_strdup_printf
argument_list|(
literal|"The Fontconfig version being used is too old!\n\n"
literal|"The GIMP requires Fontconfig version %d.%d.%d or later.\n"
literal|"The Fontconfig version loaded by The GIMP is %d.%d.%d.\n\n"
literal|"This may be caused by another instance of libfontconfig.so.1\n"
literal|"being installed in the system, probably in /usr/X11R6/lib.\n"
literal|"Please correct the situation or report it to someone who can."
argument_list|,
name|FC_REQUIRED_MAJOR
argument_list|,
name|FC_REQUIRED_MINOR
argument_list|,
name|FC_REQUIRED_MICRO
argument_list|,
name|fc_major_version
argument_list|,
name|fc_minor_version
argument_list|,
name|fc_micro_version
argument_list|)
return|;
block|}
undef|#
directive|undef
name|FC_REQUIRED_MAJOR
undef|#
directive|undef
name|FC_REQUIRED_MINOR
undef|#
directive|undef
name|FC_REQUIRED_MICRO
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|sanity_check_freetype (void)
name|sanity_check_freetype
parameter_list|(
name|void
parameter_list|)
block|{
name|FT_Library
name|ft_library
decl_stmt|;
name|FT_Int
name|ft_major_version
decl_stmt|;
name|FT_Int
name|ft_minor_version
decl_stmt|;
name|FT_Int
name|ft_micro_version
decl_stmt|;
name|FT_Int
name|ft_version
decl_stmt|;
ifdef|#
directive|ifdef
name|G_OS_WIN32
DECL|macro|FT_REQUIRED_MAJOR
define|#
directive|define
name|FT_REQUIRED_MAJOR
value|2
DECL|macro|FT_REQUIRED_MINOR
define|#
directive|define
name|FT_REQUIRED_MINOR
value|1
DECL|macro|FT_REQUIRED_MICRO
define|#
directive|define
name|FT_REQUIRED_MICRO
value|7
else|#
directive|else
DECL|macro|FT_REQUIRED_MAJOR
define|#
directive|define
name|FT_REQUIRED_MAJOR
value|2
DECL|macro|FT_REQUIRED_MINOR
define|#
directive|define
name|FT_REQUIRED_MINOR
value|1
DECL|macro|FT_REQUIRED_MICRO
define|#
directive|define
name|FT_REQUIRED_MICRO
value|7
endif|#
directive|endif
if|if
condition|(
name|FT_Init_FreeType
argument_list|(
operator|&
name|ft_library
argument_list|)
operator|!=
literal|0
condition|)
name|g_error
argument_list|(
literal|"FT_Init_FreeType() failed"
argument_list|)
expr_stmt|;
name|FT_Library_Version
argument_list|(
name|ft_library
argument_list|,
operator|&
name|ft_major_version
argument_list|,
operator|&
name|ft_minor_version
argument_list|,
operator|&
name|ft_micro_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|FT_Done_FreeType
argument_list|(
name|ft_library
argument_list|)
operator|!=
literal|0
condition|)
name|g_error
argument_list|(
literal|"FT_Done_FreeType() failed"
argument_list|)
expr_stmt|;
name|ft_version
operator|=
operator|(
name|ft_major_version
operator|*
literal|10000
operator|+
name|ft_minor_version
operator|*
literal|100
operator|+
name|ft_micro_version
operator|*
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|ft_version
operator|<
operator|(
operator|(
name|FT_REQUIRED_MAJOR
operator|*
literal|10000
operator|)
operator|+
operator|(
name|FT_REQUIRED_MINOR
operator|*
literal|100
operator|)
operator|+
operator|(
name|FT_REQUIRED_MICRO
operator|*
literal|1
operator|)
operator|)
condition|)
block|{
return|return
name|g_strdup_printf
argument_list|(
literal|"FreeType version too old!\n\n"
literal|"The GIMP requires FreeType version %d.%d.%d or later.\n"
literal|"Installed FreeType version is %d.%d.%d.\n\n"
literal|"Somehow you or your software packager managed\n"
literal|"to install The GIMP with an older FreeType version.\n\n"
literal|"Please upgrade to FreeType version %d.%d.%d or later."
argument_list|,
name|FT_REQUIRED_MAJOR
argument_list|,
name|FT_REQUIRED_MINOR
argument_list|,
name|FT_REQUIRED_MICRO
argument_list|,
name|ft_major_version
argument_list|,
name|ft_minor_version
argument_list|,
name|ft_micro_version
argument_list|,
name|FT_REQUIRED_MAJOR
argument_list|,
name|FT_REQUIRED_MINOR
argument_list|,
name|FT_REQUIRED_MICRO
argument_list|)
return|;
block|}
undef|#
directive|undef
name|FT_REQUIRED_MAJOR
undef|#
directive|undef
name|FT_REQUIRED_MINOR
undef|#
directive|undef
name|FT_REQUIRED_MICRO
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|sanity_check_filename_encoding (void)
name|sanity_check_filename_encoding
parameter_list|(
name|void
parameter_list|)
block|{
name|gchar
modifier|*
name|result
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|g_filename_to_utf8
argument_list|(
literal|""
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
block|{
name|gchar
modifier|*
name|msg
init|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"The configured filename encoding cannot be converted to UTF-8: "
literal|"%s\n\n"
literal|"Please check the value of the environment variable "
literal|"G_FILENAME_ENCODING."
argument_list|)
argument_list|,
name|error
operator|->
name|message
argument_list|)
decl_stmt|;
name|g_error_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
return|return
name|msg
return|;
block|}
name|g_free
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|result
operator|=
name|g_filename_to_utf8
argument_list|(
name|gimp_directory
argument_list|()
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
block|{
name|gchar
modifier|*
name|msg
init|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"The name of the directory holding the GIMP user configuration "
literal|"cannot be converted to UTF-8: "
literal|"%s\n\n"
literal|"Most probably your filesystem stores files in an encoding "
literal|"different from UTF-8 and you didn't tell GLib about this. "
literal|"Please set the environment variable G_FILENAME_ENCODING."
argument_list|)
argument_list|,
name|error
operator|->
name|message
argument_list|)
decl_stmt|;
name|g_error_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
return|return
name|msg
return|;
block|}
name|g_free
argument_list|(
name|result
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

end_unit

