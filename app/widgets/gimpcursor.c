begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"cursorutil.h"
end_include

begin_include
include|#
directive|include
file|"dialog_handler.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_comment
comment|/* for gdisplay_*_override_cursor() */
end_comment

begin_include
include|#
directive|include
file|"../cursors/mouse1"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1msk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_p"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_pmsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_m"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_mmsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_u"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_umsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/dropper"
end_include

begin_include
include|#
directive|include
file|"../cursors/droppermsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_ap"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_apmsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_cp"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_cpmsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_mm"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_mmmsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_selm"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_selmmsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_selp"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_selpmsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_selu"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_selumsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_sel"
end_include

begin_include
include|#
directive|include
file|"../cursors/mouse1_selmsk"
end_include

begin_include
include|#
directive|include
file|"../cursors/bad"
end_include

begin_include
include|#
directive|include
file|"../cursors/badmsk"
end_include

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2913c12a0108
block|{
DECL|member|bits
name|unsigned
name|char
modifier|*
name|bits
decl_stmt|;
DECL|member|mask_bits
name|unsigned
name|char
modifier|*
name|mask_bits
decl_stmt|;
DECL|member|width
DECL|member|height
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
DECL|member|x_hot
DECL|member|y_hot
name|int
name|x_hot
decl_stmt|,
name|y_hot
decl_stmt|;
DECL|member|cursor
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
DECL|typedef|BM_Cursor
block|}
name|BM_Cursor
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|gimp_cursors
specifier|static
name|BM_Cursor
name|gimp_cursors
index|[]
init|=
comment|/* these have to match up with the enum in cursorutil.h */
block|{
block|{
name|mouse1_bits
block|,
name|mouse1msk_bits
block|,
name|mouse1_width
block|,
name|mouse1_height
block|,
name|mouse1_x_hot
block|,
name|mouse1_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_p_bits
block|,
name|mouse1_pmsk_bits
block|,
name|mouse1_p_width
block|,
name|mouse1_p_height
block|,
name|mouse1_p_x_hot
block|,
name|mouse1_p_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_m_bits
block|,
name|mouse1_mmsk_bits
block|,
name|mouse1_m_width
block|,
name|mouse1_m_height
block|,
name|mouse1_m_x_hot
block|,
name|mouse1_m_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_u_bits
block|,
name|mouse1_umsk_bits
block|,
name|mouse1_u_width
block|,
name|mouse1_u_height
block|,
name|mouse1_u_x_hot
block|,
name|mouse1_u_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|dropper_bits
block|,
name|droppermsk_bits
block|,
name|dropper_width
block|,
name|dropper_height
block|,
name|dropper_x_hot
block|,
name|dropper_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_ap_bits
block|,
name|mouse1_apmsk_bits
block|,
name|mouse1_ap_width
block|,
name|mouse1_ap_height
block|,
name|mouse1_ap_x_hot
block|,
name|mouse1_ap_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_cp_bits
block|,
name|mouse1_cpmsk_bits
block|,
name|mouse1_cp_width
block|,
name|mouse1_cp_height
block|,
name|mouse1_cp_x_hot
block|,
name|mouse1_cp_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_mm_bits
block|,
name|mouse1_mmmsk_bits
block|,
name|mouse1_mm_width
block|,
name|mouse1_mm_height
block|,
name|mouse1_mm_x_hot
block|,
name|mouse1_mm_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_selp_bits
block|,
name|mouse1_selpmsk_bits
block|,
name|mouse1_selp_width
block|,
name|mouse1_selp_height
block|,
name|mouse1_selp_x_hot
block|,
name|mouse1_selp_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_selm_bits
block|,
name|mouse1_selmmsk_bits
block|,
name|mouse1_selm_width
block|,
name|mouse1_selm_height
block|,
name|mouse1_selm_x_hot
block|,
name|mouse1_selm_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_selu_bits
block|,
name|mouse1_selumsk_bits
block|,
name|mouse1_selu_width
block|,
name|mouse1_selu_height
block|,
name|mouse1_selu_x_hot
block|,
name|mouse1_selu_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse1_sel_bits
block|,
name|mouse1_selmsk_bits
block|,
name|mouse1_sel_width
block|,
name|mouse1_sel_height
block|,
name|mouse1_sel_x_hot
block|,
name|mouse1_sel_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|bad_bits
block|,
name|badmsk_bits
block|,
name|bad_width
block|,
name|bad_height
block|,
name|bad_x_hot
block|,
name|bad_y_hot
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|GSList
modifier|*
name|display_list
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* It's in gdisplay.c, FYI */
end_comment

begin_decl_stmt
DECL|variable|pending_removebusy
specifier|static
name|gboolean
name|pending_removebusy
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|create_cursor (BM_Cursor * bmcursor)
name|create_cursor
parameter_list|(
name|BM_Cursor
modifier|*
name|bmcursor
parameter_list|)
block|{
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
name|GdkPixmap
modifier|*
name|pixmapmsk
decl_stmt|;
name|GdkColor
name|fg
decl_stmt|,
name|bg
decl_stmt|;
comment|/* should have a way to configure the mouse colors */
name|gdk_color_parse
argument_list|(
literal|"#FFFFFF"
argument_list|,
operator|&
name|bg
argument_list|)
expr_stmt|;
name|gdk_color_parse
argument_list|(
literal|"#000000"
argument_list|,
operator|&
name|fg
argument_list|)
expr_stmt|;
name|pixmap
operator|=
name|gdk_bitmap_create_from_data
argument_list|(
name|NULL
argument_list|,
name|bmcursor
operator|->
name|bits
argument_list|,
name|bmcursor
operator|->
name|width
argument_list|,
name|bmcursor
operator|->
name|height
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|pixmap
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|pixmapmsk
operator|=
name|gdk_bitmap_create_from_data
argument_list|(
name|NULL
argument_list|,
name|bmcursor
operator|->
name|mask_bits
argument_list|,
name|bmcursor
operator|->
name|width
argument_list|,
name|bmcursor
operator|->
name|height
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|pixmapmsk
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|bmcursor
operator|->
name|cursor
operator|=
name|gdk_cursor_new_from_pixmap
argument_list|(
name|pixmap
argument_list|,
name|pixmapmsk
argument_list|,
operator|&
name|fg
argument_list|,
operator|&
name|bg
argument_list|,
name|bmcursor
operator|->
name|x_hot
argument_list|,
name|bmcursor
operator|->
name|y_hot
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|bmcursor
operator|->
name|cursor
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_change_win_cursor (GdkWindow * win,GimpCursorType curtype)
name|gimp_change_win_cursor
parameter_list|(
name|GdkWindow
modifier|*
name|win
parameter_list|,
name|GimpCursorType
name|curtype
parameter_list|)
block|{
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|curtype
operator|<
name|GIMP_LAST_CURSOR_ENTRY
argument_list|)
expr_stmt|;
name|curtype
operator|-=
name|GIMP_MOUSE1_CURSOR
expr_stmt|;
if|if
condition|(
operator|!
name|gimp_cursors
index|[
operator|(
name|int
operator|)
name|curtype
index|]
operator|.
name|cursor
condition|)
name|create_cursor
argument_list|(
operator|&
name|gimp_cursors
index|[
operator|(
name|int
operator|)
name|curtype
index|]
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|gimp_cursors
index|[
operator|(
name|int
operator|)
name|curtype
index|]
operator|.
name|cursor
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|win
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|change_win_cursor (win,cursortype)
name|change_win_cursor
parameter_list|(
name|win
parameter_list|,
name|cursortype
parameter_list|)
name|GdkWindow
modifier|*
name|win
decl_stmt|;
name|GdkCursorType
name|cursortype
decl_stmt|;
block|{
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
if|if
condition|(
name|cursortype
operator|>
name|GDK_LAST_CURSOR
condition|)
block|{
name|gimp_change_win_cursor
argument_list|(
name|win
argument_list|,
operator|(
name|GimpCursorType
operator|)
name|cursortype
argument_list|)
expr_stmt|;
return|return;
block|}
name|cursor
operator|=
name|gdk_cursor_new
argument_list|(
name|cursortype
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|win
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_destroy
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|unset_win_cursor (win)
name|unset_win_cursor
parameter_list|(
name|win
parameter_list|)
name|GdkWindow
modifier|*
name|win
decl_stmt|;
block|{
name|gdk_window_set_cursor
argument_list|(
name|win
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_add_busy_cursors_until_idle (void)
name|gimp_add_busy_cursors_until_idle
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pending_removebusy
condition|)
block|{
name|gimp_add_busy_cursors
argument_list|()
expr_stmt|;
name|gtk_idle_add_priority
argument_list|(
name|GTK_PRIORITY_HIGH
argument_list|,
name|gimp_remove_busy_cursors
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pending_removebusy
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_add_busy_cursors (void)
name|gimp_add_busy_cursors
parameter_list|(
name|void
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|GSList
modifier|*
name|list
init|=
name|display_list
decl_stmt|;
comment|/* Canvases */
while|while
condition|(
name|list
condition|)
block|{
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|gdisplay_install_override_cursor
argument_list|(
name|gdisp
argument_list|,
name|GDK_WATCH
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
comment|/* Dialogs */
name|dialog_idle_all
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|gint
DECL|function|gimp_remove_busy_cursors (gpointer data)
name|gimp_remove_busy_cursors
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|GSList
modifier|*
name|list
init|=
name|display_list
decl_stmt|;
comment|/* Canvases */
while|while
condition|(
name|list
condition|)
block|{
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|gdisplay_remove_override_cursor
argument_list|(
name|gdisp
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
comment|/* Dialogs */
name|dialog_unidle_all
argument_list|()
expr_stmt|;
name|pending_removebusy
operator|=
name|FALSE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/***************************************************************/
end_comment

begin_comment
comment|/* gtkutil_compress_motion:     This function walks the whole GDK event queue seeking motion events    corresponding to the widget 'widget'.  If it finds any it will    remove them from the queue, write the most recent motion offset    to 'lastmotion_x' and 'lastmotion_y', then return TRUE.  Otherwise    it will return FALSE and 'lastmotion_x' / 'lastmotion_y' will be    untouched.  */
end_comment

begin_comment
comment|/* The gtkutil_compress_motion function source may be re-used under    the XFree86-style license.<adam@gimp.org> */
end_comment

begin_function
name|gboolean
DECL|function|gtkutil_compress_motion (GtkWidget * widget,gdouble * lastmotion_x,gdouble * lastmotion_y)
name|gtkutil_compress_motion
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gdouble
modifier|*
name|lastmotion_x
parameter_list|,
name|gdouble
modifier|*
name|lastmotion_y
parameter_list|)
block|{
name|GdkEvent
modifier|*
name|event
decl_stmt|;
name|GList
modifier|*
name|requeued_events
init|=
name|NULL
decl_stmt|;
name|gboolean
name|success
init|=
name|FALSE
decl_stmt|;
comment|/* Move the entire GDK event queue to a private list, filtering      out any motion events for the desired widget. */
while|while
condition|(
name|gdk_events_pending
argument_list|()
condition|)
block|{
name|event
operator|=
name|gdk_event_get
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|gtk_get_event_widget
argument_list|(
name|event
argument_list|)
operator|==
name|widget
operator|)
operator|&&
operator|(
name|event
operator|->
name|any
operator|.
name|type
operator|==
name|GDK_MOTION_NOTIFY
operator|)
condition|)
block|{
operator|*
name|lastmotion_x
operator|=
name|event
operator|->
name|motion
operator|.
name|x
expr_stmt|;
operator|*
name|lastmotion_y
operator|=
name|event
operator|->
name|motion
operator|.
name|y
expr_stmt|;
name|gdk_event_free
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|success
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|requeued_events
operator|=
name|g_list_append
argument_list|(
name|requeued_events
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Replay the remains of our private event list back into the      event queue in order. */
while|while
condition|(
name|requeued_events
condition|)
block|{
name|gdk_event_put
argument_list|(
operator|(
name|GdkEvent
operator|*
operator|)
name|requeued_events
operator|->
name|data
argument_list|)
expr_stmt|;
name|gdk_event_free
argument_list|(
operator|(
name|GdkEvent
operator|*
operator|)
name|requeued_events
operator|->
name|data
argument_list|)
expr_stmt|;
name|requeued_events
operator|=
name|g_list_remove_link
argument_list|(
name|requeued_events
argument_list|,
name|requeued_events
argument_list|)
expr_stmt|;
block|}
return|return
name|success
return|;
block|}
end_function

end_unit

