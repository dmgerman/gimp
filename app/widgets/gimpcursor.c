begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"cursorutil.h"
end_include

begin_include
include|#
directive|include
file|"dialog_handler.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_comment
comment|/* for gdisplay_*_override_cursor() */
end_comment

begin_include
include|#
directive|include
file|"cursors/mouse.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/crosshair.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/crosshair_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_add.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_add_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_subtract.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_subtract_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_intersect.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_intersect_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_point.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_point_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_rectangle.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_rectangle_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_move.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/mouse_move_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_add.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_add_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_subtract.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_subtract_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_intersect.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_intersect_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_move.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/selection_move_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/bad.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/bad_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/dropper.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/dropper_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/zoom_in.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/zoom_in_mask.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/zoom_out.xbm"
end_include

begin_include
include|#
directive|include
file|"cursors/zoom_out_mask.xbm"
end_include

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon27c070f00108
block|{
DECL|member|bits
name|guchar
modifier|*
name|bits
decl_stmt|;
DECL|member|mask_bits
name|guchar
modifier|*
name|mask_bits
decl_stmt|;
DECL|member|width
DECL|member|height
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
DECL|member|x_hot
DECL|member|y_hot
name|gint
name|x_hot
decl_stmt|,
name|y_hot
decl_stmt|;
DECL|member|cursor
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
DECL|typedef|BM_Cursor
block|}
name|BM_Cursor
typedef|;
end_typedef

begin_comment
comment|/* FIXME: gimp_busy HACK */
end_comment

begin_decl_stmt
DECL|variable|gimp_busy
name|gboolean
name|gimp_busy
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gimp_cursors
specifier|static
name|BM_Cursor
name|gimp_cursors
index|[]
init|=
comment|/* these have to match up with the enum in cursorutil.h */
block|{
block|{
name|mouse_bits
block|,
name|mouse_mask_bits
block|,
name|mouse_width
block|,
name|mouse_height
block|,
name|mouse_x_hot
block|,
name|mouse_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|crosshair_bits
block|,
name|crosshair_mask_bits
block|,
name|crosshair_width
block|,
name|crosshair_height
block|,
name|crosshair_x_hot
block|,
name|crosshair_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse_add_bits
block|,
name|mouse_add_mask_bits
block|,
name|mouse_add_width
block|,
name|mouse_add_height
block|,
name|mouse_add_x_hot
block|,
name|mouse_add_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse_subtract_bits
block|,
name|mouse_subtract_mask_bits
block|,
name|mouse_subtract_width
block|,
name|mouse_subtract_height
block|,
name|mouse_subtract_x_hot
block|,
name|mouse_subtract_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse_intersect_bits
block|,
name|mouse_intersect_mask_bits
block|,
name|mouse_intersect_width
block|,
name|mouse_intersect_height
block|,
name|mouse_intersect_x_hot
block|,
name|mouse_intersect_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse_point_bits
block|,
name|mouse_point_mask_bits
block|,
name|mouse_point_width
block|,
name|mouse_point_height
block|,
name|mouse_point_x_hot
block|,
name|mouse_point_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse_rectangle_bits
block|,
name|mouse_rectangle_mask_bits
block|,
name|mouse_rectangle_width
block|,
name|mouse_rectangle_height
block|,
name|mouse_rectangle_x_hot
block|,
name|mouse_rectangle_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|mouse_move_bits
block|,
name|mouse_move_mask_bits
block|,
name|mouse_move_width
block|,
name|mouse_move_height
block|,
name|mouse_move_x_hot
block|,
name|mouse_move_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|selection_bits
block|,
name|selection_mask_bits
block|,
name|selection_width
block|,
name|selection_height
block|,
name|selection_x_hot
block|,
name|selection_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|selection_add_bits
block|,
name|selection_add_mask_bits
block|,
name|selection_add_width
block|,
name|selection_add_height
block|,
name|selection_add_x_hot
block|,
name|selection_add_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|selection_subtract_bits
block|,
name|selection_subtract_mask_bits
block|,
name|selection_subtract_width
block|,
name|selection_subtract_height
block|,
name|selection_subtract_x_hot
block|,
name|selection_subtract_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|selection_intersect_bits
block|,
name|selection_intersect_mask_bits
block|,
name|selection_intersect_width
block|,
name|selection_intersect_height
block|,
name|selection_intersect_x_hot
block|,
name|selection_intersect_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|selection_move_bits
block|,
name|selection_move_mask_bits
block|,
name|selection_move_width
block|,
name|selection_move_height
block|,
name|selection_move_x_hot
block|,
name|selection_move_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|bad_bits
block|,
name|bad_mask_bits
block|,
name|bad_width
block|,
name|bad_height
block|,
name|bad_x_hot
block|,
name|bad_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|dropper_bits
block|,
name|dropper_mask_bits
block|,
name|dropper_width
block|,
name|dropper_height
block|,
name|dropper_x_hot
block|,
name|dropper_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|zoom_in_bits
block|,
name|zoom_in_mask_bits
block|,
name|zoom_in_width
block|,
name|zoom_in_height
block|,
name|zoom_in_x_hot
block|,
name|zoom_in_y_hot
block|,
name|NULL
block|}
block|,
block|{
name|zoom_out_bits
block|,
name|zoom_out_mask_bits
block|,
name|zoom_out_width
block|,
name|zoom_out_height
block|,
name|zoom_out_x_hot
block|,
name|zoom_out_y_hot
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|GSList
modifier|*
name|display_list
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* It's in gdisplay.c, FYI */
end_comment

begin_decl_stmt
DECL|variable|pending_removebusy
specifier|static
name|gboolean
name|pending_removebusy
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|create_cursor (BM_Cursor * bmcursor)
name|create_cursor
parameter_list|(
name|BM_Cursor
modifier|*
name|bmcursor
parameter_list|)
block|{
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
name|GdkPixmap
modifier|*
name|pixmapmsk
decl_stmt|;
name|GdkColor
name|fg
decl_stmt|,
name|bg
decl_stmt|;
comment|/* should have a way to configure the mouse colors */
name|gdk_color_parse
argument_list|(
literal|"#FFFFFF"
argument_list|,
operator|&
name|bg
argument_list|)
expr_stmt|;
name|gdk_color_parse
argument_list|(
literal|"#000000"
argument_list|,
operator|&
name|fg
argument_list|)
expr_stmt|;
name|pixmap
operator|=
name|gdk_bitmap_create_from_data
argument_list|(
name|NULL
argument_list|,
name|bmcursor
operator|->
name|bits
argument_list|,
name|bmcursor
operator|->
name|width
argument_list|,
name|bmcursor
operator|->
name|height
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|pixmap
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|pixmapmsk
operator|=
name|gdk_bitmap_create_from_data
argument_list|(
name|NULL
argument_list|,
name|bmcursor
operator|->
name|mask_bits
argument_list|,
name|bmcursor
operator|->
name|width
argument_list|,
name|bmcursor
operator|->
name|height
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|pixmapmsk
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|bmcursor
operator|->
name|cursor
operator|=
name|gdk_cursor_new_from_pixmap
argument_list|(
name|pixmap
argument_list|,
name|pixmapmsk
argument_list|,
operator|&
name|fg
argument_list|,
operator|&
name|bg
argument_list|,
name|bmcursor
operator|->
name|x_hot
argument_list|,
name|bmcursor
operator|->
name|y_hot
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|bmcursor
operator|->
name|cursor
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_change_win_cursor (GdkWindow * win,GimpCursorType curtype)
name|gimp_change_win_cursor
parameter_list|(
name|GdkWindow
modifier|*
name|win
parameter_list|,
name|GimpCursorType
name|curtype
parameter_list|)
block|{
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|curtype
operator|<
name|GIMP_LAST_CURSOR_ENTRY
argument_list|)
expr_stmt|;
name|curtype
operator|-=
name|GIMP_MOUSE_CURSOR
expr_stmt|;
if|if
condition|(
operator|!
name|gimp_cursors
index|[
operator|(
name|int
operator|)
name|curtype
index|]
operator|.
name|cursor
condition|)
name|create_cursor
argument_list|(
operator|&
name|gimp_cursors
index|[
operator|(
name|int
operator|)
name|curtype
index|]
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|gimp_cursors
index|[
operator|(
name|int
operator|)
name|curtype
index|]
operator|.
name|cursor
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|win
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|change_win_cursor (GdkWindow * win,GdkCursorType cursortype)
name|change_win_cursor
parameter_list|(
name|GdkWindow
modifier|*
name|win
parameter_list|,
name|GdkCursorType
name|cursortype
parameter_list|)
block|{
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
if|if
condition|(
name|cursortype
operator|>
name|GDK_LAST_CURSOR
condition|)
block|{
name|gimp_change_win_cursor
argument_list|(
name|win
argument_list|,
operator|(
name|GimpCursorType
operator|)
name|cursortype
argument_list|)
expr_stmt|;
return|return;
block|}
name|cursor
operator|=
name|gdk_cursor_new
argument_list|(
name|cursortype
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|win
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_destroy
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|unset_win_cursor (GdkWindow * win)
name|unset_win_cursor
parameter_list|(
name|GdkWindow
modifier|*
name|win
parameter_list|)
block|{
name|gdk_window_set_cursor
argument_list|(
name|win
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_add_busy_cursors_until_idle (void)
name|gimp_add_busy_cursors_until_idle
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pending_removebusy
condition|)
block|{
name|gimp_add_busy_cursors
argument_list|()
expr_stmt|;
name|gtk_idle_add_priority
argument_list|(
name|GTK_PRIORITY_HIGH
argument_list|,
name|gimp_remove_busy_cursors
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pending_removebusy
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_add_busy_cursors (void)
name|gimp_add_busy_cursors
parameter_list|(
name|void
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
comment|/* FIXME: gimp_busy HACK */
name|gimp_busy
operator|=
name|TRUE
expr_stmt|;
comment|/* Canvases */
for|for
control|(
name|list
operator|=
name|display_list
init|;
name|list
condition|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|gdisplay_install_override_cursor
argument_list|(
name|gdisp
argument_list|,
name|GDK_WATCH
argument_list|)
expr_stmt|;
block|}
comment|/* Dialogs */
name|dialog_idle_all
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|gint
DECL|function|gimp_remove_busy_cursors (gpointer data)
name|gimp_remove_busy_cursors
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
comment|/* Canvases */
for|for
control|(
name|list
operator|=
name|display_list
init|;
name|list
condition|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|gdisp
operator|=
operator|(
name|GDisplay
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|gdisplay_remove_override_cursor
argument_list|(
name|gdisp
argument_list|)
expr_stmt|;
block|}
comment|/* Dialogs */
name|dialog_unidle_all
argument_list|()
expr_stmt|;
name|pending_removebusy
operator|=
name|FALSE
expr_stmt|;
comment|/* FIXME: gimp_busy HACK */
name|gimp_busy
operator|=
name|FALSE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/***************************************************************/
end_comment

begin_comment
comment|/* gtkutil_compress_motion:     This function walks the whole GDK event queue seeking motion events    corresponding to the widget 'widget'.  If it finds any it will    remove them from the queue, write the most recent motion offset    to 'lastmotion_x' and 'lastmotion_y', then return TRUE.  Otherwise    it will return FALSE and 'lastmotion_x' / 'lastmotion_y' will be    untouched.  */
end_comment

begin_comment
comment|/* The gtkutil_compress_motion function source may be re-used under    the XFree86-style license.<adam@gimp.org> */
end_comment

begin_function
name|gboolean
DECL|function|gtkutil_compress_motion (GtkWidget * widget,gdouble * lastmotion_x,gdouble * lastmotion_y)
name|gtkutil_compress_motion
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gdouble
modifier|*
name|lastmotion_x
parameter_list|,
name|gdouble
modifier|*
name|lastmotion_y
parameter_list|)
block|{
name|GdkEvent
modifier|*
name|event
decl_stmt|;
name|GList
modifier|*
name|requeued_events
init|=
name|NULL
decl_stmt|;
name|gboolean
name|success
init|=
name|FALSE
decl_stmt|;
comment|/* Move the entire GDK event queue to a private list, filtering      out any motion events for the desired widget. */
while|while
condition|(
name|gdk_events_pending
argument_list|()
condition|)
block|{
name|event
operator|=
name|gdk_event_get
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|event
condition|)
block|{
comment|/* Do nothing */
block|}
elseif|else
if|if
condition|(
operator|(
name|gtk_get_event_widget
argument_list|(
name|event
argument_list|)
operator|==
name|widget
operator|)
operator|&&
operator|(
name|event
operator|->
name|any
operator|.
name|type
operator|==
name|GDK_MOTION_NOTIFY
operator|)
condition|)
block|{
operator|*
name|lastmotion_x
operator|=
name|event
operator|->
name|motion
operator|.
name|x
expr_stmt|;
operator|*
name|lastmotion_y
operator|=
name|event
operator|->
name|motion
operator|.
name|y
expr_stmt|;
name|gdk_event_free
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|success
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|requeued_events
operator|=
name|g_list_append
argument_list|(
name|requeued_events
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Replay the remains of our private event list back into the      event queue in order. */
while|while
condition|(
name|requeued_events
condition|)
block|{
name|gdk_event_put
argument_list|(
operator|(
name|GdkEvent
operator|*
operator|)
name|requeued_events
operator|->
name|data
argument_list|)
expr_stmt|;
name|gdk_event_free
argument_list|(
operator|(
name|GdkEvent
operator|*
operator|)
name|requeued_events
operator|->
name|data
argument_list|)
expr_stmt|;
name|requeued_events
operator|=
name|g_list_remove_link
argument_list|(
name|requeued_events
argument_list|,
name|requeued_events
argument_list|)
expr_stmt|;
block|}
return|return
name|success
return|;
block|}
end_function

end_unit

