begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * Gradient editor module copyight (C) 1996-1997 Federico Mena Quintero  * federico@nuclecu.unam.mx  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURIGHTE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* Special thanks to:  *  * Luis Albarran (luis4@mindspring.com) - Nice UI suggestions  *  * Miguel de Icaza (miguel@nuclecu.unam.mx) - Pop-up menu suggestion  *  * Marcelo Malheiros (malheiro@dca.fee.unicamp.br) - many, many  * suggestions, nice gradient files  *  * Adam Moss (adam@uunet.pipex.com) - idea for the hint bar  *  * Everyone on #gimp - many suggestions  */
end_comment

begin_comment
comment|/* TODO:  *  * - Fix memory leaks: grad_free_gradient_editor() and any others  * which I may have missed.  *  * - Add all of Marcelo's neat suggestions:  *   - Hue rotate, saturation, brightness, contrast.  *  * - Better handling of bogus gradient files and inconsistent  *   segments.  Do not loop indefinitely in seg_get_segment_at() if  *   there is a missing segment between two others.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_warning
warning|#
directive|warning
warning|GTK_DISABLE_DEPRECATED
end_warning

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|GTK_DISABLE_DEPRECATED
end_undef

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|"libgimpcolor/gimpcolor.h"
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimpbase/gimpbase.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"gui-types.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpcontainer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpcontext.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpdatafactory.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpgradient.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpdnd.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpitemfactory.h"
end_include

begin_include
include|#
directive|include
file|"gradient-editor.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_define
DECL|macro|EPSILON
define|#
directive|define
name|EPSILON
value|1e-10
end_define

begin_define
DECL|macro|GRAD_SCROLLBAR_STEP_SIZE
define|#
directive|define
name|GRAD_SCROLLBAR_STEP_SIZE
value|0.05
end_define

begin_define
DECL|macro|GRAD_SCROLLBAR_PAGE_SIZE
define|#
directive|define
name|GRAD_SCROLLBAR_PAGE_SIZE
value|0.75
end_define

begin_define
DECL|macro|GRAD_PREVIEW_WIDTH
define|#
directive|define
name|GRAD_PREVIEW_WIDTH
value|600
end_define

begin_define
DECL|macro|GRAD_PREVIEW_HEIGHT
define|#
directive|define
name|GRAD_PREVIEW_HEIGHT
value|64
end_define

begin_define
DECL|macro|GRAD_CONTROL_HEIGHT
define|#
directive|define
name|GRAD_CONTROL_HEIGHT
value|10
end_define

begin_define
DECL|macro|GRAD_MOVE_TIME
define|#
directive|define
name|GRAD_MOVE_TIME
value|150
end_define

begin_comment
DECL|macro|GRAD_MOVE_TIME
comment|/* ms between mouse click and detection of movement in gradient control */
end_comment

begin_define
DECL|macro|GRAD_PREVIEW_EVENT_MASK
define|#
directive|define
name|GRAD_PREVIEW_EVENT_MASK
value|(GDK_EXPOSURE_MASK            | \                                  GDK_LEAVE_NOTIFY_MASK        | \ 				 GDK_POINTER_MOTION_MASK      | \                                  GDK_POINTER_MOTION_HINT_MASK | \ 				 GDK_BUTTON_PRESS_MASK        | \                                  GDK_BUTTON_RELEASE_MASK)
end_define

begin_define
DECL|macro|GRAD_CONTROL_EVENT_MASK
define|#
directive|define
name|GRAD_CONTROL_EVENT_MASK
value|(GDK_EXPOSURE_MASK            | \ 				 GDK_LEAVE_NOTIFY_MASK        | \ 				 GDK_POINTER_MOTION_MASK      | \ 				 GDK_POINTER_MOTION_HINT_MASK | \ 				 GDK_BUTTON_PRESS_MASK        | \ 				 GDK_BUTTON_RELEASE_MASK      | \ 				 GDK_BUTTON1_MOTION_MASK)
end_define

begin_comment
comment|/*  local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|void
name|gradient_editor_gradient_changed
parameter_list|(
name|GimpContext
modifier|*
name|context
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_name_activate
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_name_focus_out
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_drop_gradient
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GimpViewable
modifier|*
name|viewable
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_scrollbar_update
parameter_list|(
name|GtkAdjustment
modifier|*
name|adjustment
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_zoom_all_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_zoom_out_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_zoom_in_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_instant_update_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_editor_set_hint
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
specifier|const
name|gchar
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Gradient preview functions */
end_comment

begin_function_decl
specifier|static
name|gint
name|preview_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_set_hint
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_set_foreground
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_set_background
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_update
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gboolean
name|recalculate
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_fill_image
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|width
parameter_list|,
name|gint
name|height
parameter_list|,
name|gdouble
name|left
parameter_list|,
name|gdouble
name|right
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Gradient control functions */
end_comment

begin_function_decl
specifier|static
name|gint
name|control_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_do_hint
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_button_press
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guint
name|button
parameter_list|,
name|guint
name|state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|control_point_in_handle
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|GimpGradientSegment
modifier|*
name|seg
parameter_list|,
name|GradientEditorDragMode
name|handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_select_single_segment
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradientSegment
modifier|*
name|seg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_extend_selection
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradientSegment
modifier|*
name|seg
parameter_list|,
name|gdouble
name|pos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_motion
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|gint
name|x
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_compress_left
parameter_list|(
name|GimpGradientSegment
modifier|*
name|range_l
parameter_list|,
name|GimpGradientSegment
modifier|*
name|range_r
parameter_list|,
name|GimpGradientSegment
modifier|*
name|drag_seg
parameter_list|,
name|gdouble
name|pos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_compress_range
parameter_list|(
name|GimpGradientSegment
modifier|*
name|range_l
parameter_list|,
name|GimpGradientSegment
modifier|*
name|range_r
parameter_list|,
name|gdouble
name|new_l
parameter_list|,
name|gdouble
name|new_r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|control_move
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradientSegment
modifier|*
name|range_l
parameter_list|,
name|GimpGradientSegment
modifier|*
name|range_r
parameter_list|,
name|gdouble
name|delta
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Control update/redraw functions */
end_comment

begin_function_decl
specifier|static
name|void
name|control_update
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|gboolean
name|recalculate
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_draw
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|,
name|gint
name|width
parameter_list|,
name|gint
name|height
parameter_list|,
name|gdouble
name|left
parameter_list|,
name|gdouble
name|right
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_draw_normal_handle
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|,
name|gdouble
name|pos
parameter_list|,
name|gint
name|height
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_draw_middle_handle
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|,
name|gdouble
name|pos
parameter_list|,
name|gint
name|height
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_draw_handle
parameter_list|(
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|,
name|GdkGC
modifier|*
name|border_gc
parameter_list|,
name|GdkGC
modifier|*
name|fill_gc
parameter_list|,
name|gint
name|xpos
parameter_list|,
name|gint
name|height
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|control_calc_p_pos
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gdouble
name|pos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gdouble
name|control_calc_g_pos
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|pos
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Segment functions */
end_comment

begin_function_decl
specifier|static
name|void
name|seg_get_closest_handle
parameter_list|(
name|GimpGradient
modifier|*
name|grad
parameter_list|,
name|gdouble
name|pos
parameter_list|,
name|GimpGradientSegment
modifier|*
modifier|*
name|seg
parameter_list|,
name|GradientEditorDragMode
modifier|*
name|handle
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  public functions  */
end_comment

begin_function
name|GradientEditor
modifier|*
DECL|function|gradient_editor_new (Gimp * gimp)
name|gradient_editor_new
parameter_list|(
name|Gimp
modifier|*
name|gimp
parameter_list|)
block|{
name|GradientEditor
modifier|*
name|editor
decl_stmt|;
name|GtkWidget
modifier|*
name|main_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox2
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|image
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|editor
operator|=
name|g_new
argument_list|(
name|GradientEditor
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|editor
operator|->
name|context
operator|=
name|gimp_context_new
argument_list|(
name|gimp
argument_list|,
literal|"Gradient Editor"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|editor
operator|->
name|context
argument_list|)
argument_list|,
literal|"gradient_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_gradient_changed
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
comment|/* Shell and main vbox */
name|editor
operator|->
name|shell
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Gradient Editor"
argument_list|)
argument_list|,
literal|"gradient_editor"
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"dialogs/gradient_editor/gradient_editor.html"
argument_list|,
name|GTK_WIN_POS_NONE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|"_delete_event_"
argument_list|,
name|gradient_editor_close_callback
argument_list|,
name|editor
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|main_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|editor
operator|->
name|shell
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|main_vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|main_vbox
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
comment|/* Gradient's name */
name|editor
operator|->
name|name
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|editor
operator|->
name|name
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|editor
operator|->
name|name
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|editor
operator|->
name|name
argument_list|)
argument_list|,
literal|"activate"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_name_activate
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|editor
operator|->
name|name
argument_list|)
argument_list|,
literal|"focus_out_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_name_focus_out
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
comment|/* Frame for gradient preview and gradient control */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|vbox2
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox2
argument_list|)
expr_stmt|;
comment|/* Gradient preview */
name|editor
operator|->
name|preview_rows
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|editor
operator|->
name|preview_rows
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|editor
operator|->
name|preview_last_x
operator|=
literal|0
expr_stmt|;
name|editor
operator|->
name|preview_button_down
operator|=
name|FALSE
expr_stmt|;
name|editor
operator|->
name|preview
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_COLOR
argument_list|)
expr_stmt|;
name|gtk_preview_set_dither
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
argument_list|,
name|GDK_RGB_DITHER_MAX
argument_list|)
expr_stmt|;
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
argument_list|,
name|GRAD_PREVIEW_WIDTH
argument_list|,
name|GRAD_PREVIEW_HEIGHT
argument_list|)
expr_stmt|;
comment|/*  Enable auto-resizing of the preview but ensure a minimal size  */
name|gtk_widget_set_size_request
argument_list|(
name|editor
operator|->
name|preview
argument_list|,
name|GRAD_PREVIEW_WIDTH
argument_list|,
name|GRAD_PREVIEW_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_preview_set_expand
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|editor
operator|->
name|preview
argument_list|,
name|GRAD_PREVIEW_EVENT_MASK
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
argument_list|,
literal|"event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|preview_events
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
name|gimp_gtk_drag_dest_set_by_type
argument_list|(
name|editor
operator|->
name|preview
argument_list|,
name|GTK_DEST_DEFAULT_ALL
argument_list|,
name|GIMP_TYPE_GRADIENT
argument_list|,
name|GDK_ACTION_COPY
argument_list|)
expr_stmt|;
name|gimp_dnd_viewable_dest_set
argument_list|(
name|GTK_WIDGET
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
argument_list|,
name|GIMP_TYPE_GRADIENT
argument_list|,
name|gradient_editor_drop_gradient
argument_list|,
name|editor
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|editor
operator|->
name|preview
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
expr_stmt|;
comment|/* Gradient control */
name|editor
operator|->
name|control_pixmap
operator|=
name|NULL
expr_stmt|;
name|editor
operator|->
name|control_drag_segment
operator|=
name|NULL
expr_stmt|;
name|editor
operator|->
name|control_sel_l
operator|=
name|NULL
expr_stmt|;
name|editor
operator|->
name|control_sel_r
operator|=
name|NULL
expr_stmt|;
name|editor
operator|->
name|control_drag_mode
operator|=
name|GRAD_DRAG_NONE
expr_stmt|;
name|editor
operator|->
name|control_click_time
operator|=
literal|0
expr_stmt|;
name|editor
operator|->
name|control_compress
operator|=
name|FALSE
expr_stmt|;
name|editor
operator|->
name|control_last_x
operator|=
literal|0
expr_stmt|;
name|editor
operator|->
name|control_last_gx
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|control_orig_pos
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|control
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|editor
operator|->
name|control
argument_list|,
name|GRAD_PREVIEW_WIDTH
argument_list|,
name|GRAD_CONTROL_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|editor
operator|->
name|control
argument_list|,
name|GRAD_CONTROL_EVENT_MASK
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|editor
operator|->
name|control
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|editor
operator|->
name|control
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|editor
operator|->
name|control
argument_list|)
argument_list|,
literal|"event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|control_events
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
comment|/*  Scrollbar  */
name|editor
operator|->
name|zoom_factor
operator|=
literal|1
expr_stmt|;
name|editor
operator|->
name|scroll_data
operator|=
name|gtk_adjustment_new
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
operator|*
name|GRAD_SCROLLBAR_STEP_SIZE
argument_list|,
literal|1.0
operator|*
name|GRAD_SCROLLBAR_PAGE_SIZE
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_scrollbar_update
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_scrollbar_update
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
name|editor
operator|->
name|scrollbar
operator|=
name|gtk_hscrollbar_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|editor
operator|->
name|scrollbar
argument_list|)
argument_list|,
name|GTK_UPDATE_CONTINUOUS
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|editor
operator|->
name|scrollbar
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|editor
operator|->
name|scrollbar
argument_list|)
expr_stmt|;
comment|/*  Horizontal box for zoom controls and instant update toggle  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*  + and - buttons  */
name|button
operator|=
name|gtk_button_new
argument_list|()
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_RECEIVES_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_box_pack_end
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|image
operator|=
name|gtk_image_new_from_stock
argument_list|(
name|GTK_STOCK_ZOOM_OUT
argument_list|,
name|GTK_ICON_SIZE_MENU
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|button
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_zoom_out_callback
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new
argument_list|()
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_RECEIVES_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_box_pack_end
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|image
operator|=
name|gtk_image_new_from_stock
argument_list|(
name|GTK_STOCK_ZOOM_IN
argument_list|,
name|GTK_ICON_SIZE_MENU
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|button
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_zoom_in_callback
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
comment|/*  Zoom all button */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Zoom all"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_padding
argument_list|(
name|GTK_MISC
argument_list|(
name|GTK_BIN
argument_list|(
name|button
argument_list|)
operator|->
name|child
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_end
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_RECEIVES_DEFAULT
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_zoom_all_callback
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
comment|/* Instant update toggle */
name|editor
operator|->
name|instant_update
operator|=
name|TRUE
expr_stmt|;
name|button
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Instant update"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_box_pack_end
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gradient_editor_instant_update_update
argument_list|)
argument_list|,
name|editor
argument_list|)
expr_stmt|;
comment|/* Hint bar */
name|hbox
operator|=
name|GTK_DIALOG
argument_list|(
name|editor
operator|->
name|shell
argument_list|)
operator|->
name|action_area
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|hbox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_box_set_homogeneous
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|editor
operator|->
name|hint_label
operator|=
name|gtk_label_new
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|editor
operator|->
name|hint_label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|editor
operator|->
name|hint_label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|editor
operator|->
name|hint_label
argument_list|)
expr_stmt|;
comment|/* Initialize other data */
name|editor
operator|->
name|left_saved_segments
operator|=
name|NULL
expr_stmt|;
name|editor
operator|->
name|left_saved_dirty
operator|=
name|FALSE
expr_stmt|;
name|editor
operator|->
name|right_saved_segments
operator|=
name|NULL
expr_stmt|;
name|editor
operator|->
name|right_saved_dirty
operator|=
name|FALSE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|0
index|]
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
comment|/* Black */
name|editor
operator|->
name|saved_colors
index|[
literal|0
index|]
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|0
index|]
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|0
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|1
index|]
operator|.
name|r
operator|=
literal|0.5
expr_stmt|;
comment|/* 50% Gray */
name|editor
operator|->
name|saved_colors
index|[
literal|1
index|]
operator|.
name|g
operator|=
literal|0.5
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|1
index|]
operator|.
name|b
operator|=
literal|0.5
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|1
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|2
index|]
operator|.
name|r
operator|=
literal|1.0
expr_stmt|;
comment|/* White */
name|editor
operator|->
name|saved_colors
index|[
literal|2
index|]
operator|.
name|g
operator|=
literal|1.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|2
index|]
operator|.
name|b
operator|=
literal|1.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|2
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|3
index|]
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
comment|/* Clear */
name|editor
operator|->
name|saved_colors
index|[
literal|3
index|]
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|3
index|]
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|3
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_TRANSPARENT
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|4
index|]
operator|.
name|r
operator|=
literal|1.0
expr_stmt|;
comment|/* Red */
name|editor
operator|->
name|saved_colors
index|[
literal|4
index|]
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|4
index|]
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|4
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|5
index|]
operator|.
name|r
operator|=
literal|1.0
expr_stmt|;
comment|/* Yellow */
name|editor
operator|->
name|saved_colors
index|[
literal|5
index|]
operator|.
name|g
operator|=
literal|1.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|5
index|]
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|5
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|6
index|]
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
comment|/* Green */
name|editor
operator|->
name|saved_colors
index|[
literal|6
index|]
operator|.
name|g
operator|=
literal|1.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|6
index|]
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|6
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|7
index|]
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
comment|/* Cyan */
name|editor
operator|->
name|saved_colors
index|[
literal|7
index|]
operator|.
name|g
operator|=
literal|1.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|7
index|]
operator|.
name|b
operator|=
literal|1.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|7
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|8
index|]
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
comment|/* Blue */
name|editor
operator|->
name|saved_colors
index|[
literal|8
index|]
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|8
index|]
operator|.
name|b
operator|=
literal|1.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|8
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|9
index|]
operator|.
name|r
operator|=
literal|1.0
expr_stmt|;
comment|/* Magenta */
name|editor
operator|->
name|saved_colors
index|[
literal|9
index|]
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|9
index|]
operator|.
name|b
operator|=
literal|1.0
expr_stmt|;
name|editor
operator|->
name|saved_colors
index|[
literal|9
index|]
operator|.
name|a
operator|=
name|GIMP_OPACITY_OPAQUE
expr_stmt|;
if|if
condition|(
name|gimp_container_num_children
argument_list|(
name|gimp
operator|->
name|gradient_factory
operator|->
name|container
argument_list|)
condition|)
block|{
name|gimp_context_set_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|,
name|GIMP_GRADIENT
argument_list|(
name|gimp_container_get_child_by_index
argument_list|(
name|gimp
operator|->
name|gradient_factory
operator|->
name|container
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|GimpGradient
modifier|*
name|gradient
decl_stmt|;
name|gradient
operator|=
name|GIMP_GRADIENT
argument_list|(
name|gimp_gradient_new
argument_list|(
name|_
argument_list|(
literal|"Default"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_container_add
argument_list|(
name|gimp
operator|->
name|gradient_factory
operator|->
name|container
argument_list|,
name|GIMP_OBJECT
argument_list|(
name|gradient
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_show
argument_list|(
name|editor
operator|->
name|shell
argument_list|)
expr_stmt|;
return|return
name|editor
return|;
block|}
end_function

begin_function
name|void
DECL|function|gradient_editor_set_gradient (GradientEditor * editor,GimpGradient * gradient)
name|gradient_editor_set_gradient
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|editor
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_GRADIENT
argument_list|(
name|gradient
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_context_set_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|,
name|gradient
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gradient_editor_free (GradientEditor * editor)
name|gradient_editor_free
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|editor
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gradient_editor_update (GradientEditor * editor,GradientEditorUpdateMask flags)
name|gradient_editor_update
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GradientEditorUpdateMask
name|flags
parameter_list|)
block|{
name|GimpGradient
modifier|*
name|gradient
decl_stmt|;
name|gradient
operator|=
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|GRAD_UPDATE_GRADIENT
condition|)
block|{
name|preview_update
argument_list|(
name|editor
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|GRAD_UPDATE_PREVIEW
condition|)
name|preview_update
argument_list|(
name|editor
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|GRAD_UPDATE_CONTROL
condition|)
name|control_update
argument_list|(
name|editor
argument_list|,
name|gradient
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|GRAD_RESET_CONTROL
condition|)
name|control_update
argument_list|(
name|editor
argument_list|,
name|gradient
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  private functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gradient_editor_gradient_changed (GimpContext * context,GimpGradient * gradient,GradientEditor * editor)
name|gradient_editor_gradient_changed
parameter_list|(
name|GimpContext
modifier|*
name|context
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|editor
operator|->
name|name
argument_list|)
argument_list|,
name|gimp_object_get_name
argument_list|(
name|GIMP_OBJECT
argument_list|(
name|gradient
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_PREVIEW
operator||
name|GRAD_RESET_CONTROL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_close_callback (GtkWidget * widget,GradientEditor * editor)
name|gradient_editor_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|editor
operator|->
name|shell
argument_list|)
condition|)
name|gtk_widget_hide
argument_list|(
name|editor
operator|->
name|shell
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_name_activate (GtkWidget * widget,GradientEditor * editor)
name|gradient_editor_name_activate
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|GimpGradient
modifier|*
name|gradient
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|entry_text
decl_stmt|;
name|gradient
operator|=
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
expr_stmt|;
name|entry_text
operator|=
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_object_set_name
argument_list|(
name|GIMP_OBJECT
argument_list|(
name|gradient
argument_list|)
argument_list|,
name|entry_text
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_name_focus_out (GtkWidget * widget,GdkEvent * event,GradientEditor * editor)
name|gradient_editor_name_focus_out
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|gradient_editor_name_activate
argument_list|(
name|widget
argument_list|,
name|editor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_drop_gradient (GtkWidget * widget,GimpViewable * viewable,gpointer data)
name|gradient_editor_drop_gradient
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GimpViewable
modifier|*
name|viewable
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GradientEditor
modifier|*
name|editor
decl_stmt|;
name|editor
operator|=
operator|(
name|GradientEditor
operator|*
operator|)
name|data
expr_stmt|;
name|gradient_editor_set_gradient
argument_list|(
name|editor
argument_list|,
name|GIMP_GRADIENT
argument_list|(
name|viewable
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_scrollbar_update (GtkAdjustment * adjustment,GradientEditor * editor)
name|gradient_editor_scrollbar_update
parameter_list|(
name|GtkAdjustment
modifier|*
name|adjustment
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|gchar
modifier|*
name|str
decl_stmt|;
name|str
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Zoom factor: %d:1    Displaying [%0.6f, %0.6f]"
argument_list|)
argument_list|,
name|editor
operator|->
name|zoom_factor
argument_list|,
name|adjustment
operator|->
name|value
argument_list|,
name|adjustment
operator|->
name|value
operator|+
name|adjustment
operator|->
name|page_size
argument_list|)
expr_stmt|;
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_PREVIEW
operator||
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_zoom_all_callback (GtkWidget * widget,GradientEditor * editor)
name|gradient_editor_zoom_all_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|GtkAdjustment
modifier|*
name|adjustment
decl_stmt|;
name|adjustment
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
expr_stmt|;
name|editor
operator|->
name|zoom_factor
operator|=
literal|1
expr_stmt|;
name|adjustment
operator|->
name|value
operator|=
literal|0.0
expr_stmt|;
name|adjustment
operator|->
name|page_size
operator|=
literal|1.0
expr_stmt|;
name|adjustment
operator|->
name|step_increment
operator|=
literal|1.0
operator|*
name|GRAD_SCROLLBAR_STEP_SIZE
expr_stmt|;
name|adjustment
operator|->
name|page_increment
operator|=
literal|1.0
operator|*
name|GRAD_SCROLLBAR_PAGE_SIZE
expr_stmt|;
name|gtk_adjustment_changed
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_zoom_out_callback (GtkWidget * widget,GradientEditor * editor)
name|gradient_editor_zoom_out_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|GtkAdjustment
modifier|*
name|adjustment
decl_stmt|;
name|gdouble
name|old_value
decl_stmt|;
name|gdouble
name|value
decl_stmt|;
name|gdouble
name|old_page_size
decl_stmt|;
name|gdouble
name|page_size
decl_stmt|;
if|if
condition|(
name|editor
operator|->
name|zoom_factor
operator|<=
literal|1
condition|)
return|return;
name|adjustment
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
expr_stmt|;
name|old_value
operator|=
name|adjustment
operator|->
name|value
expr_stmt|;
name|old_page_size
operator|=
name|adjustment
operator|->
name|page_size
expr_stmt|;
name|editor
operator|->
name|zoom_factor
operator|--
expr_stmt|;
name|page_size
operator|=
literal|1.0
operator|/
name|editor
operator|->
name|zoom_factor
expr_stmt|;
name|value
operator|=
name|old_value
operator|-
operator|(
name|page_size
operator|-
name|old_page_size
operator|)
operator|/
literal|2.0
expr_stmt|;
if|if
condition|(
name|value
operator|<
literal|0.0
condition|)
name|value
operator|=
literal|0.0
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|value
operator|+
name|page_size
operator|)
operator|>
literal|1.0
condition|)
name|value
operator|=
literal|1.0
operator|-
name|page_size
expr_stmt|;
name|adjustment
operator|->
name|value
operator|=
name|value
expr_stmt|;
name|adjustment
operator|->
name|page_size
operator|=
name|page_size
expr_stmt|;
name|adjustment
operator|->
name|step_increment
operator|=
name|page_size
operator|*
name|GRAD_SCROLLBAR_STEP_SIZE
expr_stmt|;
name|adjustment
operator|->
name|page_increment
operator|=
name|page_size
operator|*
name|GRAD_SCROLLBAR_PAGE_SIZE
expr_stmt|;
name|gtk_adjustment_changed
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_zoom_in_callback (GtkWidget * widget,GradientEditor * editor)
name|gradient_editor_zoom_in_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|GtkAdjustment
modifier|*
name|adjustment
decl_stmt|;
name|gdouble
name|old_value
decl_stmt|;
name|gdouble
name|old_page_size
decl_stmt|;
name|gdouble
name|page_size
decl_stmt|;
name|adjustment
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
expr_stmt|;
name|old_value
operator|=
name|adjustment
operator|->
name|value
expr_stmt|;
name|old_page_size
operator|=
name|adjustment
operator|->
name|page_size
expr_stmt|;
name|editor
operator|->
name|zoom_factor
operator|++
expr_stmt|;
name|page_size
operator|=
literal|1.0
operator|/
name|editor
operator|->
name|zoom_factor
expr_stmt|;
name|adjustment
operator|->
name|value
operator|=
name|old_value
operator|+
operator|(
name|old_page_size
operator|-
name|page_size
operator|)
operator|/
literal|2.0
expr_stmt|;
name|adjustment
operator|->
name|page_size
operator|=
name|page_size
expr_stmt|;
name|adjustment
operator|->
name|step_increment
operator|=
name|page_size
operator|*
name|GRAD_SCROLLBAR_STEP_SIZE
expr_stmt|;
name|adjustment
operator|->
name|page_increment
operator|=
name|page_size
operator|*
name|GRAD_SCROLLBAR_PAGE_SIZE
expr_stmt|;
name|gtk_adjustment_changed
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_instant_update_update (GtkWidget * widget,GradientEditor * editor)
name|gradient_editor_instant_update_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
operator|->
name|active
condition|)
block|{
name|editor
operator|->
name|instant_update
operator|=
name|TRUE
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|editor
operator|->
name|scrollbar
argument_list|)
argument_list|,
name|GTK_UPDATE_CONTINUOUS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|editor
operator|->
name|instant_update
operator|=
name|FALSE
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|editor
operator|->
name|scrollbar
argument_list|)
argument_list|,
name|GTK_UPDATE_DELAYED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_editor_set_hint (GradientEditor * editor,const gchar * str)
name|gradient_editor_set_hint
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
specifier|const
name|gchar
modifier|*
name|str
parameter_list|)
block|{
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|editor
operator|->
name|hint_label
argument_list|)
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***** Gradient preview functions *****/
end_comment

begin_function
specifier|static
name|gint
DECL|function|preview_events (GtkWidget * widget,GdkEvent * event,GradientEditor * editor)
name|preview_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
name|GdkEventMotion
modifier|*
name|mevent
decl_stmt|;
name|GdkEventScroll
modifier|*
name|sevent
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_EXPOSE
case|:
name|preview_update
argument_list|(
name|editor
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
case|case
name|GDK_LEAVE_NOTIFY
case|:
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_MOTION_NOTIFY
case|:
name|gtk_widget_get_pointer
argument_list|(
name|editor
operator|->
name|preview
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
name|mevent
operator|=
operator|(
name|GdkEventMotion
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|editor
operator|->
name|preview_last_x
condition|)
block|{
name|editor
operator|->
name|preview_last_x
operator|=
name|x
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|preview_button_down
condition|)
block|{
if|if
condition|(
name|mevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
condition|)
name|preview_set_background
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
else|else
name|preview_set_foreground
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|preview_set_hint
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|GDK_BUTTON_PRESS
case|:
name|gtk_widget_get_pointer
argument_list|(
name|editor
operator|->
name|preview
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
switch|switch
condition|(
name|bevent
operator|->
name|button
condition|)
block|{
case|case
literal|1
case|:
name|editor
operator|->
name|preview_last_x
operator|=
name|x
expr_stmt|;
name|editor
operator|->
name|preview_button_down
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|bevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
condition|)
name|preview_set_background
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
else|else
name|preview_set_foreground
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
block|{
name|GimpItemFactory
modifier|*
name|factory
decl_stmt|;
name|factory
operator|=
name|gimp_item_factory_from_path
argument_list|(
literal|"<GradientEditor>"
argument_list|)
expr_stmt|;
name|gimp_item_factory_popup_with_data
argument_list|(
name|factory
argument_list|,
name|editor
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|GDK_SCROLL
case|:
name|sevent
operator|=
operator|(
name|GdkEventScroll
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
name|sevent
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
if|if
condition|(
name|sevent
operator|->
name|direction
operator|==
name|GDK_SCROLL_UP
condition|)
name|gradient_editor_zoom_in_callback
argument_list|(
name|NULL
argument_list|,
name|editor
argument_list|)
expr_stmt|;
else|else
name|gradient_editor_zoom_out_callback
argument_list|(
name|NULL
argument_list|,
name|editor
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|GtkAdjustment
modifier|*
name|adj
init|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
decl_stmt|;
name|gfloat
name|new_value
init|=
name|adj
operator|->
name|value
operator|+
operator|(
operator|(
name|sevent
operator|->
name|direction
operator|==
name|GDK_SCROLL_UP
operator|)
condition|?
operator|-
name|adj
operator|->
name|page_increment
operator|/
literal|2
else|:
name|adj
operator|->
name|page_increment
operator|/
literal|2
operator|)
decl_stmt|;
name|new_value
operator|=
name|CLAMP
argument_list|(
name|new_value
argument_list|,
name|adj
operator|->
name|lower
argument_list|,
name|adj
operator|->
name|upper
operator|-
name|adj
operator|->
name|page_size
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|adj
argument_list|,
name|new_value
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GDK_BUTTON_RELEASE
case|:
if|if
condition|(
name|editor
operator|->
name|preview_button_down
condition|)
block|{
name|gtk_widget_get_pointer
argument_list|(
name|editor
operator|->
name|preview
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
name|editor
operator|->
name|preview_last_x
operator|=
name|x
expr_stmt|;
name|editor
operator|->
name|preview_button_down
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|bevent
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
condition|)
name|preview_set_background
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
else|else
name|preview_set_foreground
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
break|break;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|preview_set_hint (GradientEditor * editor,gint x)
name|preview_set_hint
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|)
block|{
name|gdouble
name|xpos
decl_stmt|;
name|GimpRGB
name|rgb
decl_stmt|;
name|GimpHSV
name|hsv
decl_stmt|;
name|gchar
modifier|*
name|str
decl_stmt|;
name|xpos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|gimp_gradient_get_color_at
argument_list|(
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
argument_list|,
name|xpos
argument_list|,
operator|&
name|rgb
argument_list|)
expr_stmt|;
name|gimp_rgb_to_hsv
argument_list|(
operator|&
name|rgb
argument_list|,
operator|&
name|hsv
argument_list|)
expr_stmt|;
name|str
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Position: %0.6f    "
literal|"RGB (%0.3f, %0.3f, %0.3f)    "
literal|"HSV (%0.3f, %0.3f, %0.3f)    "
literal|"Opacity: %0.3f"
argument_list|)
argument_list|,
name|xpos
argument_list|,
name|rgb
operator|.
name|r
argument_list|,
name|rgb
operator|.
name|g
argument_list|,
name|rgb
operator|.
name|b
argument_list|,
name|hsv
operator|.
name|h
operator|*
literal|360.0
argument_list|,
name|hsv
operator|.
name|s
argument_list|,
name|hsv
operator|.
name|v
argument_list|,
name|rgb
operator|.
name|a
argument_list|)
expr_stmt|;
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|preview_set_foreground (GradientEditor * editor,gint x)
name|preview_set_foreground
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|)
block|{
name|GimpRGB
name|color
decl_stmt|;
name|gdouble
name|xpos
decl_stmt|;
name|gchar
modifier|*
name|str
decl_stmt|;
name|xpos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|gimp_gradient_get_color_at
argument_list|(
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
argument_list|,
name|xpos
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|gimp_context_set_foreground
argument_list|(
name|gimp_get_user_context
argument_list|(
name|editor
operator|->
name|context
operator|->
name|gimp
argument_list|)
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|str
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Foreground color set to RGB (%d, %d, %d)<-> "
literal|"(%0.3f, %0.3f, %0.3f)"
argument_list|)
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|color
operator|.
name|r
operator|*
literal|255.0
argument_list|)
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|color
operator|.
name|g
operator|*
literal|255.0
argument_list|)
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|color
operator|.
name|b
operator|*
literal|255.0
argument_list|)
argument_list|,
name|color
operator|.
name|r
argument_list|,
name|color
operator|.
name|g
argument_list|,
name|color
operator|.
name|b
argument_list|)
expr_stmt|;
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|preview_set_background (GradientEditor * editor,gint x)
name|preview_set_background
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|)
block|{
name|GimpRGB
name|color
decl_stmt|;
name|gdouble
name|xpos
decl_stmt|;
name|gchar
modifier|*
name|str
decl_stmt|;
name|xpos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|gimp_gradient_get_color_at
argument_list|(
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
argument_list|,
name|xpos
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|gimp_context_set_background
argument_list|(
name|gimp_get_user_context
argument_list|(
name|editor
operator|->
name|context
operator|->
name|gimp
argument_list|)
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|str
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Background color to RGB (%d, %d, %d)<-> "
literal|"(%0.3f, %0.3f, %0.3f)"
argument_list|)
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|color
operator|.
name|r
operator|*
literal|255.0
argument_list|)
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|color
operator|.
name|g
operator|*
literal|255.0
argument_list|)
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|color
operator|.
name|b
operator|*
literal|255.0
argument_list|)
argument_list|,
name|color
operator|.
name|r
argument_list|,
name|color
operator|.
name|g
argument_list|,
name|color
operator|.
name|b
argument_list|)
expr_stmt|;
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****/
end_comment

begin_function
specifier|static
name|void
DECL|function|preview_update (GradientEditor * editor,gboolean recalculate)
name|preview_update
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gboolean
name|recalculate
parameter_list|)
block|{
name|glong
name|rowsiz
decl_stmt|;
name|GtkAdjustment
modifier|*
name|adjustment
decl_stmt|;
name|guint16
name|width
decl_stmt|;
name|guint16
name|height
decl_stmt|;
specifier|static
name|guint16
name|last_width
init|=
literal|0
decl_stmt|;
specifier|static
name|guint16
name|last_height
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|GTK_WIDGET_DRAWABLE
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
condition|)
return|return;
comment|/*  See whether we have to re-create the preview widget    *  (note that the preview automatically follows the size of it's container)    */
name|width
operator|=
name|editor
operator|->
name|preview
operator|->
name|allocation
operator|.
name|width
expr_stmt|;
name|height
operator|=
name|editor
operator|->
name|preview
operator|->
name|allocation
operator|.
name|height
expr_stmt|;
if|if
condition|(
operator|!
name|editor
operator|->
name|preview_rows
index|[
literal|0
index|]
operator|||
operator|!
name|editor
operator|->
name|preview_rows
index|[
literal|1
index|]
operator|||
operator|(
name|width
operator|!=
name|last_width
operator|)
operator|||
operator|(
name|height
operator|!=
name|last_height
operator|)
condition|)
block|{
if|if
condition|(
name|editor
operator|->
name|preview_rows
index|[
literal|0
index|]
condition|)
name|g_free
argument_list|(
name|editor
operator|->
name|preview_rows
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|preview_rows
index|[
literal|1
index|]
condition|)
name|g_free
argument_list|(
name|editor
operator|->
name|preview_rows
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|rowsiz
operator|=
name|width
operator|*
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|guchar
argument_list|)
expr_stmt|;
name|editor
operator|->
name|preview_rows
index|[
literal|0
index|]
operator|=
name|g_malloc
argument_list|(
name|rowsiz
argument_list|)
expr_stmt|;
name|editor
operator|->
name|preview_rows
index|[
literal|1
index|]
operator|=
name|g_malloc
argument_list|(
name|rowsiz
argument_list|)
expr_stmt|;
name|recalculate
operator|=
name|TRUE
expr_stmt|;
comment|/* Force recalculation */
block|}
name|last_width
operator|=
name|width
expr_stmt|;
name|last_height
operator|=
name|height
expr_stmt|;
comment|/* Have to redraw? */
if|if
condition|(
name|recalculate
condition|)
block|{
name|adjustment
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
expr_stmt|;
name|preview_fill_image
argument_list|(
name|editor
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|adjustment
operator|->
name|value
argument_list|,
name|adjustment
operator|->
name|value
operator|+
name|adjustment
operator|->
name|page_size
argument_list|)
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|preview_fill_image (GradientEditor * editor,gint width,gint height,gdouble left,gdouble right)
name|preview_fill_image
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|width
parameter_list|,
name|gint
name|height
parameter_list|,
name|gdouble
name|left
parameter_list|,
name|gdouble
name|right
parameter_list|)
block|{
name|GimpGradient
modifier|*
name|gradient
decl_stmt|;
name|guchar
modifier|*
name|p0
decl_stmt|,
modifier|*
name|p1
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gdouble
name|dx
decl_stmt|,
name|cur_x
decl_stmt|;
name|GimpRGB
name|color
decl_stmt|;
name|gdouble
name|c0
decl_stmt|,
name|c1
decl_stmt|;
name|gradient
operator|=
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
expr_stmt|;
name|dx
operator|=
operator|(
name|right
operator|-
name|left
operator|)
operator|/
operator|(
name|width
operator|-
literal|1
operator|)
expr_stmt|;
name|cur_x
operator|=
name|left
expr_stmt|;
name|p0
operator|=
name|editor
operator|->
name|preview_rows
index|[
literal|0
index|]
expr_stmt|;
name|p1
operator|=
name|editor
operator|->
name|preview_rows
index|[
literal|1
index|]
expr_stmt|;
comment|/* Create lines to fill the image */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|++
control|)
block|{
name|gimp_gradient_get_color_at
argument_list|(
name|gradient
argument_list|,
name|cur_x
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|/
name|GIMP_CHECK_SIZE
operator|)
operator|&
literal|1
condition|)
block|{
name|c0
operator|=
name|GIMP_CHECK_LIGHT
expr_stmt|;
name|c1
operator|=
name|GIMP_CHECK_DARK
expr_stmt|;
block|}
else|else
block|{
name|c0
operator|=
name|GIMP_CHECK_DARK
expr_stmt|;
name|c1
operator|=
name|GIMP_CHECK_LIGHT
expr_stmt|;
block|}
operator|*
name|p0
operator|++
operator|=
operator|(
name|c0
operator|+
operator|(
name|color
operator|.
name|r
operator|-
name|c0
operator|)
operator|*
name|color
operator|.
name|a
operator|)
operator|*
literal|255.0
expr_stmt|;
operator|*
name|p0
operator|++
operator|=
operator|(
name|c0
operator|+
operator|(
name|color
operator|.
name|g
operator|-
name|c0
operator|)
operator|*
name|color
operator|.
name|a
operator|)
operator|*
literal|255.0
expr_stmt|;
operator|*
name|p0
operator|++
operator|=
operator|(
name|c0
operator|+
operator|(
name|color
operator|.
name|b
operator|-
name|c0
operator|)
operator|*
name|color
operator|.
name|a
operator|)
operator|*
literal|255.0
expr_stmt|;
operator|*
name|p1
operator|++
operator|=
operator|(
name|c1
operator|+
operator|(
name|color
operator|.
name|r
operator|-
name|c1
operator|)
operator|*
name|color
operator|.
name|a
operator|)
operator|*
literal|255.0
expr_stmt|;
operator|*
name|p1
operator|++
operator|=
operator|(
name|c1
operator|+
operator|(
name|color
operator|.
name|g
operator|-
name|c1
operator|)
operator|*
name|color
operator|.
name|a
operator|)
operator|*
literal|255.0
expr_stmt|;
operator|*
name|p1
operator|++
operator|=
operator|(
name|c1
operator|+
operator|(
name|color
operator|.
name|b
operator|-
name|c1
operator|)
operator|*
name|color
operator|.
name|a
operator|)
operator|*
literal|255.0
expr_stmt|;
name|cur_x
operator|+=
name|dx
expr_stmt|;
block|}
comment|/* Fill image */
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|y
operator|/
name|GIMP_CHECK_SIZE
operator|)
operator|&
literal|1
condition|)
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
argument_list|,
name|editor
operator|->
name|preview_rows
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
name|y
argument_list|,
name|width
argument_list|)
expr_stmt|;
else|else
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|editor
operator|->
name|preview
argument_list|)
argument_list|,
name|editor
operator|->
name|preview_rows
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
name|y
argument_list|,
name|width
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***** Gradient control functions *****/
end_comment

begin_comment
comment|/* *** WARNING *** WARNING *** WARNING ***  *  * All the event-handling code for the gradient control widget is  * extremely hairy.  You are not expected to understand it.  If you  * find bugs, mail me unless you are very brave and you want to fix  * them yourself ;-)  */
end_comment

begin_function
specifier|static
name|gint
DECL|function|control_events (GtkWidget * widget,GdkEvent * event,GradientEditor * editor)
name|control_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|GradientEditor
modifier|*
name|editor
parameter_list|)
block|{
name|GimpGradient
modifier|*
name|gradient
decl_stmt|;
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
name|GimpGradientSegment
modifier|*
name|seg
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|guint32
name|time
decl_stmt|;
name|gradient
operator|=
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_EXPOSE
case|:
name|control_update
argument_list|(
name|editor
argument_list|,
name|gradient
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_LEAVE_NOTIFY
case|:
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_BUTTON_PRESS
case|:
if|if
condition|(
name|editor
operator|->
name|control_drag_mode
operator|==
name|GRAD_DRAG_NONE
condition|)
block|{
name|gtk_widget_get_pointer
argument_list|(
name|editor
operator|->
name|control
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
name|editor
operator|->
name|control_last_x
operator|=
name|x
expr_stmt|;
name|editor
operator|->
name|control_click_time
operator|=
name|bevent
operator|->
name|time
expr_stmt|;
name|control_button_press
argument_list|(
name|editor
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|bevent
operator|->
name|button
argument_list|,
name|bevent
operator|->
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|control_drag_mode
operator|!=
name|GRAD_DRAG_NONE
condition|)
name|gtk_grab_add
argument_list|(
name|widget
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GDK_BUTTON_RELEASE
case|:
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|control_drag_mode
operator|!=
name|GRAD_DRAG_NONE
condition|)
block|{
name|gtk_grab_remove
argument_list|(
name|widget
argument_list|)
expr_stmt|;
name|gtk_widget_get_pointer
argument_list|(
name|editor
operator|->
name|control
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
name|time
operator|=
operator|(
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
operator|)
operator|->
name|time
expr_stmt|;
if|if
condition|(
operator|(
name|time
operator|-
name|editor
operator|->
name|control_click_time
operator|)
operator|>=
name|GRAD_MOVE_TIME
condition|)
block|{
if|if
condition|(
operator|!
name|editor
operator|->
name|instant_update
condition|)
name|gimp_data_dirty
argument_list|(
name|GIMP_DATA
argument_list|(
name|gradient
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Possible move */
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_GRADIENT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|editor
operator|->
name|control_drag_mode
operator|==
name|GRAD_DRAG_MIDDLE
operator|)
operator|||
operator|(
name|editor
operator|->
name|control_drag_mode
operator|==
name|GRAD_DRAG_ALL
operator|)
condition|)
block|{
name|seg
operator|=
name|editor
operator|->
name|control_drag_segment
expr_stmt|;
if|if
condition|(
operator|(
name|editor
operator|->
name|control_drag_mode
operator|==
name|GRAD_DRAG_ALL
operator|)
operator|&&
name|editor
operator|->
name|control_compress
condition|)
name|control_extend_selection
argument_list|(
name|editor
argument_list|,
name|seg
argument_list|,
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|control_select_single_segment
argument_list|(
name|editor
argument_list|,
name|seg
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
name|editor
operator|->
name|control_drag_mode
operator|=
name|GRAD_DRAG_NONE
expr_stmt|;
name|editor
operator|->
name|control_compress
operator|=
name|FALSE
expr_stmt|;
name|control_do_hint
argument_list|(
name|editor
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GDK_MOTION_NOTIFY
case|:
name|gtk_widget_get_pointer
argument_list|(
name|editor
operator|->
name|control
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|editor
operator|->
name|control_last_x
condition|)
block|{
name|editor
operator|->
name|control_last_x
operator|=
name|x
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|control_drag_mode
operator|!=
name|GRAD_DRAG_NONE
condition|)
block|{
name|time
operator|=
operator|(
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
operator|)
operator|->
name|time
expr_stmt|;
if|if
condition|(
operator|(
name|time
operator|-
name|editor
operator|->
name|control_click_time
operator|)
operator|>=
name|GRAD_MOVE_TIME
condition|)
name|control_motion
argument_list|(
name|editor
argument_list|,
name|gradient
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
name|control_do_hint
argument_list|(
name|editor
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_do_hint (GradientEditor * editor,gint x,gint y)
name|control_do_hint
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
name|GimpGradient
modifier|*
name|gradient
decl_stmt|;
name|GimpGradientSegment
modifier|*
name|seg
decl_stmt|;
name|GradientEditorDragMode
name|handle
decl_stmt|;
name|gboolean
name|in_handle
decl_stmt|;
name|double
name|pos
decl_stmt|;
name|gradient
operator|=
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
expr_stmt|;
name|pos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pos
operator|<
literal|0.0
operator|)
operator|||
operator|(
name|pos
operator|>
literal|1.0
operator|)
condition|)
return|return;
name|seg_get_closest_handle
argument_list|(
name|gradient
argument_list|,
name|pos
argument_list|,
operator|&
name|seg
argument_list|,
operator|&
name|handle
argument_list|)
expr_stmt|;
name|in_handle
operator|=
name|control_point_in_handle
argument_list|(
name|editor
argument_list|,
name|gradient
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|seg
argument_list|,
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|in_handle
condition|)
block|{
switch|switch
condition|(
name|handle
condition|)
block|{
case|case
name|GRAD_DRAG_LEFT
case|:
if|if
condition|(
name|seg
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|seg
operator|->
name|prev
operator|!=
name|NULL
condition|)
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|_
argument_list|(
literal|"Drag: move    "
literal|"<Shift>+Drag: move& compress"
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|_
argument_list|(
literal|"Click: select    "
literal|"<Shift>+Click: extend selection"
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|_
argument_list|(
literal|"Click: select    "
literal|"<Shift>+Click: extend selection"
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GRAD_DRAG_MIDDLE
case|:
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|_
argument_list|(
literal|"Click: select    "
literal|"<Shift>+Click: extend selection    "
literal|"Drag: move"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"%s: in_handle is true, but received handle type %d."
argument_list|,
name|G_STRLOC
argument_list|,
name|in_handle
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|_
argument_list|(
literal|"Click: select    "
literal|"<Shift>+Click: extend selection    "
literal|"Drag: move    "
literal|"<Shift>+Drag: move& compress"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_button_press (GradientEditor * editor,gint x,gint y,guint button,guint state)
name|control_button_press
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guint
name|button
parameter_list|,
name|guint
name|state
parameter_list|)
block|{
name|GimpGradient
modifier|*
name|gradient
decl_stmt|;
name|GimpGradientSegment
modifier|*
name|seg
decl_stmt|;
name|GradientEditorDragMode
name|handle
decl_stmt|;
name|double
name|xpos
decl_stmt|;
name|gboolean
name|in_handle
decl_stmt|;
name|gradient
operator|=
name|gimp_context_get_gradient
argument_list|(
name|editor
operator|->
name|context
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|button
condition|)
block|{
case|case
literal|1
case|:
break|break;
case|case
literal|3
case|:
block|{
name|GimpItemFactory
modifier|*
name|factory
decl_stmt|;
name|factory
operator|=
name|gimp_item_factory_from_path
argument_list|(
literal|"<GradientEditor>"
argument_list|)
expr_stmt|;
name|gimp_item_factory_popup_with_data
argument_list|(
name|factory
argument_list|,
name|editor
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return;
comment|/*  wheelmouse support  */
case|case
literal|4
case|:
block|{
name|GtkAdjustment
modifier|*
name|adj
init|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
decl_stmt|;
name|gfloat
name|new_value
init|=
name|adj
operator|->
name|value
operator|-
name|adj
operator|->
name|page_increment
operator|/
literal|2
decl_stmt|;
name|new_value
operator|=
name|CLAMP
argument_list|(
name|new_value
argument_list|,
name|adj
operator|->
name|lower
argument_list|,
name|adj
operator|->
name|upper
operator|-
name|adj
operator|->
name|page_size
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|adj
argument_list|,
name|new_value
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
literal|5
case|:
block|{
name|GtkAdjustment
modifier|*
name|adj
init|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
decl_stmt|;
name|gfloat
name|new_value
init|=
name|adj
operator|->
name|value
operator|+
name|adj
operator|->
name|page_increment
operator|/
literal|2
decl_stmt|;
name|new_value
operator|=
name|CLAMP
argument_list|(
name|new_value
argument_list|,
name|adj
operator|->
name|lower
argument_list|,
name|adj
operator|->
name|upper
operator|-
name|adj
operator|->
name|page_size
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|adj
argument_list|,
name|new_value
argument_list|)
expr_stmt|;
block|}
return|return;
default|default:
return|return;
block|}
comment|/* Find the closest handle */
name|xpos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|seg_get_closest_handle
argument_list|(
name|gradient
argument_list|,
name|xpos
argument_list|,
operator|&
name|seg
argument_list|,
operator|&
name|handle
argument_list|)
expr_stmt|;
name|in_handle
operator|=
name|control_point_in_handle
argument_list|(
name|editor
argument_list|,
name|gradient
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|seg
argument_list|,
name|handle
argument_list|)
expr_stmt|;
comment|/* Now see what we have */
if|if
condition|(
name|in_handle
condition|)
block|{
switch|switch
condition|(
name|handle
condition|)
block|{
case|case
name|GRAD_DRAG_LEFT
case|:
if|if
condition|(
name|seg
operator|!=
name|NULL
condition|)
block|{
comment|/* Left handle of some segment */
if|if
condition|(
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
if|if
condition|(
name|seg
operator|->
name|prev
operator|!=
name|NULL
condition|)
block|{
name|editor
operator|->
name|control_drag_mode
operator|=
name|GRAD_DRAG_LEFT
expr_stmt|;
name|editor
operator|->
name|control_drag_segment
operator|=
name|seg
expr_stmt|;
name|editor
operator|->
name|control_compress
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|control_extend_selection
argument_list|(
name|editor
argument_list|,
name|seg
argument_list|,
name|xpos
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|seg
operator|->
name|prev
operator|!=
name|NULL
condition|)
block|{
name|editor
operator|->
name|control_drag_mode
operator|=
name|GRAD_DRAG_LEFT
expr_stmt|;
name|editor
operator|->
name|control_drag_segment
operator|=
name|seg
expr_stmt|;
block|}
else|else
block|{
name|control_select_single_segment
argument_list|(
name|editor
argument_list|,
name|seg
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
else|else
comment|/* seg == NULL */
block|{
comment|/* Right handle of last segment */
name|seg
operator|=
name|gimp_gradient_segment_get_last
argument_list|(
name|gradient
operator|->
name|segments
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
name|control_extend_selection
argument_list|(
name|editor
argument_list|,
name|seg
argument_list|,
name|xpos
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|control_select_single_segment
argument_list|(
name|editor
argument_list|,
name|seg
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
break|break;
case|case
name|GRAD_DRAG_MIDDLE
case|:
if|if
condition|(
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
name|control_extend_selection
argument_list|(
name|editor
argument_list|,
name|seg
argument_list|,
name|xpos
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|editor
operator|->
name|control_drag_mode
operator|=
name|GRAD_DRAG_MIDDLE
expr_stmt|;
name|editor
operator|->
name|control_drag_segment
operator|=
name|seg
expr_stmt|;
block|}
return|return;
default|default:
name|g_warning
argument_list|(
literal|"%s: in_handle is true, but received handle type %d."
argument_list|,
name|G_STRLOC
argument_list|,
name|in_handle
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
comment|/* !in_handle */
block|{
name|seg
operator|=
name|gimp_gradient_get_segment_at
argument_list|(
name|gradient
argument_list|,
name|xpos
argument_list|)
expr_stmt|;
name|editor
operator|->
name|control_drag_mode
operator|=
name|GRAD_DRAG_ALL
expr_stmt|;
name|editor
operator|->
name|control_drag_segment
operator|=
name|seg
expr_stmt|;
name|editor
operator|->
name|control_last_gx
operator|=
name|xpos
expr_stmt|;
name|editor
operator|->
name|control_orig_pos
operator|=
name|xpos
expr_stmt|;
if|if
condition|(
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
name|editor
operator|->
name|control_compress
operator|=
name|TRUE
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|control_point_in_handle (GradientEditor * editor,GimpGradient * gradient,gint x,gint y,GimpGradientSegment * seg,GradientEditorDragMode handle)
name|control_point_in_handle
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|GimpGradientSegment
modifier|*
name|seg
parameter_list|,
name|GradientEditorDragMode
name|handle
parameter_list|)
block|{
name|gint
name|handle_pos
decl_stmt|;
switch|switch
condition|(
name|handle
condition|)
block|{
case|case
name|GRAD_DRAG_LEFT
case|:
if|if
condition|(
name|seg
condition|)
block|{
name|handle_pos
operator|=
name|control_calc_p_pos
argument_list|(
name|editor
argument_list|,
name|seg
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|seg
operator|=
name|gimp_gradient_segment_get_last
argument_list|(
name|gradient
operator|->
name|segments
argument_list|)
expr_stmt|;
name|handle_pos
operator|=
name|control_calc_p_pos
argument_list|(
name|editor
argument_list|,
name|seg
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GRAD_DRAG_MIDDLE
case|:
name|handle_pos
operator|=
name|control_calc_p_pos
argument_list|(
name|editor
argument_list|,
name|seg
operator|->
name|middle
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"%s: Cannot handle drag mode %d."
argument_list|,
name|G_STRLOC
argument_list|,
name|handle
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|y
operator|/=
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|>=
operator|(
name|handle_pos
operator|-
name|y
operator|)
operator|)
operator|&&
operator|(
name|x
operator|<=
operator|(
name|handle_pos
operator|+
name|y
operator|)
operator|)
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/*****/
end_comment

begin_function
specifier|static
name|void
DECL|function|control_select_single_segment (GradientEditor * editor,GimpGradientSegment * seg)
name|control_select_single_segment
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradientSegment
modifier|*
name|seg
parameter_list|)
block|{
name|editor
operator|->
name|control_sel_l
operator|=
name|seg
expr_stmt|;
name|editor
operator|->
name|control_sel_r
operator|=
name|seg
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_extend_selection (GradientEditor * editor,GimpGradientSegment * seg,gdouble pos)
name|control_extend_selection
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradientSegment
modifier|*
name|seg
parameter_list|,
name|gdouble
name|pos
parameter_list|)
block|{
if|if
condition|(
name|fabs
argument_list|(
name|pos
operator|-
name|editor
operator|->
name|control_sel_l
operator|->
name|left
argument_list|)
operator|<
name|fabs
argument_list|(
name|pos
operator|-
name|editor
operator|->
name|control_sel_r
operator|->
name|right
argument_list|)
condition|)
name|editor
operator|->
name|control_sel_l
operator|=
name|seg
expr_stmt|;
else|else
name|editor
operator|->
name|control_sel_r
operator|=
name|seg
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****/
end_comment

begin_function
specifier|static
name|void
DECL|function|control_motion (GradientEditor * editor,GimpGradient * gradient,gint x)
name|control_motion
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|gint
name|x
parameter_list|)
block|{
name|GimpGradientSegment
modifier|*
name|seg
decl_stmt|;
name|gdouble
name|pos
decl_stmt|;
name|gdouble
name|delta
decl_stmt|;
name|gchar
modifier|*
name|str
init|=
name|NULL
decl_stmt|;
name|seg
operator|=
name|editor
operator|->
name|control_drag_segment
expr_stmt|;
switch|switch
condition|(
name|editor
operator|->
name|control_drag_mode
condition|)
block|{
case|case
name|GRAD_DRAG_LEFT
case|:
name|pos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|editor
operator|->
name|control_compress
condition|)
name|seg
operator|->
name|prev
operator|->
name|right
operator|=
name|seg
operator|->
name|left
operator|=
name|CLAMP
argument_list|(
name|pos
argument_list|,
name|seg
operator|->
name|prev
operator|->
name|middle
operator|+
name|EPSILON
argument_list|,
name|seg
operator|->
name|middle
operator|-
name|EPSILON
argument_list|)
expr_stmt|;
else|else
name|control_compress_left
argument_list|(
name|editor
operator|->
name|control_sel_l
argument_list|,
name|editor
operator|->
name|control_sel_r
argument_list|,
name|seg
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|str
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Handle position: %0.6f"
argument_list|)
argument_list|,
name|seg
operator|->
name|left
argument_list|)
expr_stmt|;
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
case|case
name|GRAD_DRAG_MIDDLE
case|:
name|pos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|seg
operator|->
name|middle
operator|=
name|CLAMP
argument_list|(
name|pos
argument_list|,
name|seg
operator|->
name|left
operator|+
name|EPSILON
argument_list|,
name|seg
operator|->
name|right
operator|-
name|EPSILON
argument_list|)
expr_stmt|;
name|str
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Handle position: %0.6f"
argument_list|)
argument_list|,
name|seg
operator|->
name|middle
argument_list|)
expr_stmt|;
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
case|case
name|GRAD_DRAG_ALL
case|:
name|pos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|delta
operator|=
name|pos
operator|-
name|editor
operator|->
name|control_last_gx
expr_stmt|;
if|if
condition|(
operator|(
name|seg
operator|->
name|left
operator|>=
name|editor
operator|->
name|control_sel_l
operator|->
name|left
operator|)
operator|&&
operator|(
name|seg
operator|->
name|right
operator|<=
name|editor
operator|->
name|control_sel_r
operator|->
name|right
operator|)
condition|)
name|delta
operator|=
name|control_move
argument_list|(
name|editor
argument_list|,
name|editor
operator|->
name|control_sel_l
argument_list|,
name|editor
operator|->
name|control_sel_r
argument_list|,
name|delta
argument_list|)
expr_stmt|;
else|else
name|delta
operator|=
name|control_move
argument_list|(
name|editor
argument_list|,
name|seg
argument_list|,
name|seg
argument_list|,
name|delta
argument_list|)
expr_stmt|;
name|editor
operator|->
name|control_last_gx
operator|+=
name|delta
expr_stmt|;
name|str
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Distance: %0.6f"
argument_list|)
argument_list|,
name|editor
operator|->
name|control_last_gx
operator|-
name|editor
operator|->
name|control_orig_pos
argument_list|)
expr_stmt|;
name|gradient_editor_set_hint
argument_list|(
name|editor
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"%s: Attempting to move bogus handle %d."
argument_list|,
name|G_STRLOC
argument_list|,
name|editor
operator|->
name|control_drag_mode
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|str
condition|)
name|g_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|instant_update
condition|)
block|{
name|gimp_data_dirty
argument_list|(
name|GIMP_DATA
argument_list|(
name|gradient
argument_list|)
argument_list|)
expr_stmt|;
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_GRADIENT
operator||
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gradient_editor_update
argument_list|(
name|editor
argument_list|,
name|GRAD_UPDATE_CONTROL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_compress_left (GimpGradientSegment * range_l,GimpGradientSegment * range_r,GimpGradientSegment * drag_seg,gdouble pos)
name|control_compress_left
parameter_list|(
name|GimpGradientSegment
modifier|*
name|range_l
parameter_list|,
name|GimpGradientSegment
modifier|*
name|range_r
parameter_list|,
name|GimpGradientSegment
modifier|*
name|drag_seg
parameter_list|,
name|gdouble
name|pos
parameter_list|)
block|{
name|GimpGradientSegment
modifier|*
name|seg
decl_stmt|;
name|gdouble
name|lbound
decl_stmt|,
name|rbound
decl_stmt|;
name|gint
name|k
decl_stmt|;
comment|/* Check what we have to compress */
if|if
condition|(
operator|!
operator|(
operator|(
name|drag_seg
operator|->
name|left
operator|>=
name|range_l
operator|->
name|left
operator|)
operator|&&
operator|(
operator|(
name|drag_seg
operator|->
name|right
operator|<=
name|range_r
operator|->
name|right
operator|)
operator|||
operator|(
name|drag_seg
operator|==
name|range_r
operator|->
name|next
operator|)
operator|)
operator|)
condition|)
block|{
comment|/* We are compressing a segment outside the selection */
name|range_l
operator|=
name|range_r
operator|=
name|drag_seg
expr_stmt|;
block|}
comment|/* Calculate left bound for dragged hadle */
if|if
condition|(
name|drag_seg
operator|==
name|range_l
condition|)
name|lbound
operator|=
name|range_l
operator|->
name|prev
operator|->
name|left
operator|+
literal|2.0
operator|*
name|EPSILON
expr_stmt|;
else|else
block|{
comment|/* Count number of segments to the left of the dragged handle */
name|seg
operator|=
name|drag_seg
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|seg
operator|!=
name|range_l
condition|)
block|{
name|k
operator|++
expr_stmt|;
name|seg
operator|=
name|seg
operator|->
name|prev
expr_stmt|;
block|}
comment|/* 2*k handles have to fit */
name|lbound
operator|=
name|range_l
operator|->
name|left
operator|+
literal|2.0
operator|*
name|k
operator|*
name|EPSILON
expr_stmt|;
block|}
comment|/* Calculate right bound for dragged handle */
if|if
condition|(
name|drag_seg
operator|==
name|range_r
operator|->
name|next
condition|)
name|rbound
operator|=
name|range_r
operator|->
name|next
operator|->
name|right
operator|-
literal|2.0
operator|*
name|EPSILON
expr_stmt|;
else|else
block|{
comment|/* Count number of segments to the right of the dragged handle */
name|seg
operator|=
name|drag_seg
expr_stmt|;
name|k
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|seg
operator|!=
name|range_r
condition|)
block|{
name|k
operator|++
expr_stmt|;
name|seg
operator|=
name|seg
operator|->
name|next
expr_stmt|;
block|}
comment|/* 2*k handles have to fit */
name|rbound
operator|=
name|range_r
operator|->
name|right
operator|-
literal|2.0
operator|*
name|k
operator|*
name|EPSILON
expr_stmt|;
block|}
comment|/* Calculate position */
name|pos
operator|=
name|CLAMP
argument_list|(
name|pos
argument_list|,
name|lbound
argument_list|,
name|rbound
argument_list|)
expr_stmt|;
comment|/* Compress segments to the left of the handle */
if|if
condition|(
name|drag_seg
operator|==
name|range_l
condition|)
name|control_compress_range
argument_list|(
name|range_l
operator|->
name|prev
argument_list|,
name|range_l
operator|->
name|prev
argument_list|,
name|range_l
operator|->
name|prev
operator|->
name|left
argument_list|,
name|pos
argument_list|)
expr_stmt|;
else|else
name|control_compress_range
argument_list|(
name|range_l
argument_list|,
name|drag_seg
operator|->
name|prev
argument_list|,
name|range_l
operator|->
name|left
argument_list|,
name|pos
argument_list|)
expr_stmt|;
comment|/* Compress segments to the right of the handle */
if|if
condition|(
name|drag_seg
operator|!=
name|range_r
operator|->
name|next
condition|)
name|control_compress_range
argument_list|(
name|drag_seg
argument_list|,
name|range_r
argument_list|,
name|pos
argument_list|,
name|range_r
operator|->
name|right
argument_list|)
expr_stmt|;
else|else
name|control_compress_range
argument_list|(
name|drag_seg
argument_list|,
name|drag_seg
argument_list|,
name|pos
argument_list|,
name|drag_seg
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_compress_range (GimpGradientSegment * range_l,GimpGradientSegment * range_r,gdouble new_l,gdouble new_r)
name|control_compress_range
parameter_list|(
name|GimpGradientSegment
modifier|*
name|range_l
parameter_list|,
name|GimpGradientSegment
modifier|*
name|range_r
parameter_list|,
name|gdouble
name|new_l
parameter_list|,
name|gdouble
name|new_r
parameter_list|)
block|{
name|gdouble
name|orig_l
decl_stmt|,
name|orig_r
decl_stmt|;
name|gdouble
name|scale
decl_stmt|;
name|GimpGradientSegment
modifier|*
name|seg
decl_stmt|,
modifier|*
name|aseg
decl_stmt|;
name|orig_l
operator|=
name|range_l
operator|->
name|left
expr_stmt|;
name|orig_r
operator|=
name|range_r
operator|->
name|right
expr_stmt|;
name|scale
operator|=
operator|(
name|new_r
operator|-
name|new_l
operator|)
operator|/
operator|(
name|orig_r
operator|-
name|orig_l
operator|)
expr_stmt|;
name|seg
operator|=
name|range_l
expr_stmt|;
do|do
block|{
name|seg
operator|->
name|left
operator|=
name|new_l
operator|+
operator|(
name|seg
operator|->
name|left
operator|-
name|orig_l
operator|)
operator|*
name|scale
expr_stmt|;
name|seg
operator|->
name|middle
operator|=
name|new_l
operator|+
operator|(
name|seg
operator|->
name|middle
operator|-
name|orig_l
operator|)
operator|*
name|scale
expr_stmt|;
name|seg
operator|->
name|right
operator|=
name|new_l
operator|+
operator|(
name|seg
operator|->
name|right
operator|-
name|orig_l
operator|)
operator|*
name|scale
expr_stmt|;
comment|/* Next */
name|aseg
operator|=
name|seg
expr_stmt|;
name|seg
operator|=
name|seg
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|aseg
operator|!=
name|range_r
condition|)
do|;
block|}
end_function

begin_comment
comment|/*****/
end_comment

begin_function
specifier|static
name|gdouble
DECL|function|control_move (GradientEditor * editor,GimpGradientSegment * range_l,GimpGradientSegment * range_r,gdouble delta)
name|control_move
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradientSegment
modifier|*
name|range_l
parameter_list|,
name|GimpGradientSegment
modifier|*
name|range_r
parameter_list|,
name|gdouble
name|delta
parameter_list|)
block|{
name|gdouble
name|lbound
decl_stmt|,
name|rbound
decl_stmt|;
name|gint
name|is_first
decl_stmt|,
name|is_last
decl_stmt|;
name|GimpGradientSegment
modifier|*
name|seg
decl_stmt|,
modifier|*
name|aseg
decl_stmt|;
comment|/* First or last segments in gradient? */
name|is_first
operator|=
operator|(
name|range_l
operator|->
name|prev
operator|==
name|NULL
operator|)
expr_stmt|;
name|is_last
operator|=
operator|(
name|range_r
operator|->
name|next
operator|==
name|NULL
operator|)
expr_stmt|;
comment|/* Calculate drag bounds */
if|if
condition|(
operator|!
name|editor
operator|->
name|control_compress
condition|)
block|{
if|if
condition|(
operator|!
name|is_first
condition|)
name|lbound
operator|=
name|range_l
operator|->
name|prev
operator|->
name|middle
operator|+
name|EPSILON
expr_stmt|;
else|else
name|lbound
operator|=
name|range_l
operator|->
name|left
operator|+
name|EPSILON
expr_stmt|;
if|if
condition|(
operator|!
name|is_last
condition|)
name|rbound
operator|=
name|range_r
operator|->
name|next
operator|->
name|middle
operator|-
name|EPSILON
expr_stmt|;
else|else
name|rbound
operator|=
name|range_r
operator|->
name|right
operator|-
name|EPSILON
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|is_first
condition|)
name|lbound
operator|=
name|range_l
operator|->
name|prev
operator|->
name|left
operator|+
literal|2.0
operator|*
name|EPSILON
expr_stmt|;
else|else
name|lbound
operator|=
name|range_l
operator|->
name|left
operator|+
name|EPSILON
expr_stmt|;
if|if
condition|(
operator|!
name|is_last
condition|)
name|rbound
operator|=
name|range_r
operator|->
name|next
operator|->
name|right
operator|-
literal|2.0
operator|*
name|EPSILON
expr_stmt|;
else|else
name|rbound
operator|=
name|range_r
operator|->
name|right
operator|-
name|EPSILON
expr_stmt|;
block|}
comment|/* Fix the delta if necessary */
if|if
condition|(
name|delta
operator|<
literal|0.0
condition|)
block|{
if|if
condition|(
operator|!
name|is_first
condition|)
block|{
if|if
condition|(
name|range_l
operator|->
name|left
operator|+
name|delta
operator|<
name|lbound
condition|)
name|delta
operator|=
name|lbound
operator|-
name|range_l
operator|->
name|left
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|range_l
operator|->
name|middle
operator|+
name|delta
operator|<
name|lbound
condition|)
name|delta
operator|=
name|lbound
operator|-
name|range_l
operator|->
name|middle
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|is_last
condition|)
block|{
if|if
condition|(
name|range_r
operator|->
name|right
operator|+
name|delta
operator|>
name|rbound
condition|)
name|delta
operator|=
name|rbound
operator|-
name|range_r
operator|->
name|right
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|range_r
operator|->
name|middle
operator|+
name|delta
operator|>
name|rbound
condition|)
name|delta
operator|=
name|rbound
operator|-
name|range_r
operator|->
name|middle
expr_stmt|;
block|}
comment|/* Move all the segments inside the range */
name|seg
operator|=
name|range_l
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|seg
operator|==
name|range_l
operator|)
operator|&&
name|is_first
operator|)
condition|)
name|seg
operator|->
name|left
operator|+=
name|delta
expr_stmt|;
name|seg
operator|->
name|middle
operator|+=
name|delta
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|seg
operator|==
name|range_r
operator|)
operator|&&
name|is_last
operator|)
condition|)
name|seg
operator|->
name|right
operator|+=
name|delta
expr_stmt|;
comment|/* Next */
name|aseg
operator|=
name|seg
expr_stmt|;
name|seg
operator|=
name|seg
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|aseg
operator|!=
name|range_r
condition|)
do|;
comment|/* Fix the segments that surround the range */
if|if
condition|(
operator|!
name|is_first
condition|)
block|{
if|if
condition|(
operator|!
name|editor
operator|->
name|control_compress
condition|)
name|range_l
operator|->
name|prev
operator|->
name|right
operator|=
name|range_l
operator|->
name|left
expr_stmt|;
else|else
name|control_compress_range
argument_list|(
name|range_l
operator|->
name|prev
argument_list|,
name|range_l
operator|->
name|prev
argument_list|,
name|range_l
operator|->
name|prev
operator|->
name|left
argument_list|,
name|range_l
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|is_last
condition|)
block|{
if|if
condition|(
operator|!
name|editor
operator|->
name|control_compress
condition|)
name|range_r
operator|->
name|next
operator|->
name|left
operator|=
name|range_r
operator|->
name|right
expr_stmt|;
else|else
name|control_compress_range
argument_list|(
name|range_r
operator|->
name|next
argument_list|,
name|range_r
operator|->
name|next
argument_list|,
name|range_r
operator|->
name|right
argument_list|,
name|range_r
operator|->
name|next
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
return|return
name|delta
return|;
block|}
end_function

begin_comment
comment|/*****/
end_comment

begin_function
specifier|static
name|void
DECL|function|control_update (GradientEditor * editor,GimpGradient * gradient,gboolean recalculate)
name|control_update
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|gboolean
name|recalculate
parameter_list|)
block|{
name|GtkAdjustment
modifier|*
name|adjustment
decl_stmt|;
name|gint
name|cwidth
decl_stmt|,
name|cheight
decl_stmt|;
name|gint
name|pwidth
decl_stmt|,
name|pheight
decl_stmt|;
if|if
condition|(
operator|!
name|GTK_WIDGET_DRAWABLE
argument_list|(
name|editor
operator|->
name|control
argument_list|)
condition|)
return|return;
comment|/*  See whether we have to re-create the control pixmap    *  depending on the preview's width    */
name|cwidth
operator|=
name|editor
operator|->
name|preview
operator|->
name|allocation
operator|.
name|width
expr_stmt|;
name|cheight
operator|=
name|GRAD_CONTROL_HEIGHT
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|control_pixmap
condition|)
name|gdk_drawable_get_size
argument_list|(
name|editor
operator|->
name|control_pixmap
argument_list|,
operator|&
name|pwidth
argument_list|,
operator|&
name|pheight
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|editor
operator|->
name|control_pixmap
operator|||
operator|(
name|cwidth
operator|!=
name|pwidth
operator|)
operator|||
operator|(
name|cheight
operator|!=
name|pheight
operator|)
condition|)
block|{
if|if
condition|(
name|editor
operator|->
name|control_pixmap
condition|)
name|g_object_unref
argument_list|(
name|editor
operator|->
name|control_pixmap
argument_list|)
expr_stmt|;
name|editor
operator|->
name|control_pixmap
operator|=
name|gdk_pixmap_new
argument_list|(
name|editor
operator|->
name|control
operator|->
name|window
argument_list|,
name|cwidth
argument_list|,
name|cheight
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|recalculate
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* Avaoid segfault on first invocation */
if|if
condition|(
name|cwidth
operator|<
name|GRAD_PREVIEW_WIDTH
condition|)
return|return;
comment|/* Have to reset the selection? */
if|if
condition|(
name|recalculate
condition|)
name|control_select_single_segment
argument_list|(
name|editor
argument_list|,
name|gradient
operator|->
name|segments
argument_list|)
expr_stmt|;
comment|/* Redraw pixmap */
name|adjustment
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
expr_stmt|;
name|control_draw
argument_list|(
name|editor
argument_list|,
name|gradient
argument_list|,
name|editor
operator|->
name|control_pixmap
argument_list|,
name|cwidth
argument_list|,
name|cheight
argument_list|,
name|adjustment
operator|->
name|value
argument_list|,
name|adjustment
operator|->
name|value
operator|+
name|adjustment
operator|->
name|page_size
argument_list|)
expr_stmt|;
name|gdk_draw_drawable
argument_list|(
name|editor
operator|->
name|control
operator|->
name|window
argument_list|,
name|editor
operator|->
name|control
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|editor
operator|->
name|control_pixmap
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|cwidth
argument_list|,
name|cheight
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_draw (GradientEditor * editor,GimpGradient * gradient,GdkPixmap * pixmap,gint width,gint height,gdouble left,gdouble right)
name|control_draw
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GimpGradient
modifier|*
name|gradient
parameter_list|,
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|,
name|gint
name|width
parameter_list|,
name|gint
name|height
parameter_list|,
name|gdouble
name|left
parameter_list|,
name|gdouble
name|right
parameter_list|)
block|{
name|gint
name|sel_l
decl_stmt|,
name|sel_r
decl_stmt|;
name|gdouble
name|g_pos
decl_stmt|;
name|GimpGradientSegment
modifier|*
name|seg
decl_stmt|;
name|GradientEditorDragMode
name|handle
decl_stmt|;
comment|/* Clear the pixmap */
name|gdk_draw_rectangle
argument_list|(
name|pixmap
argument_list|,
name|editor
operator|->
name|control
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
comment|/* Draw selection */
name|sel_l
operator|=
name|control_calc_p_pos
argument_list|(
name|editor
argument_list|,
name|editor
operator|->
name|control_sel_l
operator|->
name|left
argument_list|)
expr_stmt|;
name|sel_r
operator|=
name|control_calc_p_pos
argument_list|(
name|editor
argument_list|,
name|editor
operator|->
name|control_sel_r
operator|->
name|right
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pixmap
argument_list|,
name|editor
operator|->
name|control
operator|->
name|style
operator|->
name|dark_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|TRUE
argument_list|,
name|sel_l
argument_list|,
literal|0
argument_list|,
name|sel_r
operator|-
name|sel_l
operator|+
literal|1
argument_list|,
name|height
argument_list|)
expr_stmt|;
comment|/* Draw handles */
name|seg
operator|=
name|gradient
operator|->
name|segments
expr_stmt|;
while|while
condition|(
name|seg
condition|)
block|{
name|control_draw_normal_handle
argument_list|(
name|editor
argument_list|,
name|pixmap
argument_list|,
name|seg
operator|->
name|left
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|control_draw_middle_handle
argument_list|(
name|editor
argument_list|,
name|pixmap
argument_list|,
name|seg
operator|->
name|middle
argument_list|,
name|height
argument_list|)
expr_stmt|;
comment|/* Draw right handle only if this is the last segment */
if|if
condition|(
name|seg
operator|->
name|next
operator|==
name|NULL
condition|)
name|control_draw_normal_handle
argument_list|(
name|editor
argument_list|,
name|pixmap
argument_list|,
name|seg
operator|->
name|right
argument_list|,
name|height
argument_list|)
expr_stmt|;
comment|/* Next! */
name|seg
operator|=
name|seg
operator|->
name|next
expr_stmt|;
block|}
comment|/* Draw the handle which is closest to the mouse position */
name|g_pos
operator|=
name|control_calc_g_pos
argument_list|(
name|editor
argument_list|,
name|editor
operator|->
name|control_last_x
argument_list|)
expr_stmt|;
name|seg_get_closest_handle
argument_list|(
name|gradient
argument_list|,
name|CLAMP
argument_list|(
name|g_pos
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|)
argument_list|,
operator|&
name|seg
argument_list|,
operator|&
name|handle
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|handle
condition|)
block|{
case|case
name|GRAD_DRAG_LEFT
case|:
if|if
condition|(
name|seg
condition|)
block|{
name|control_draw_normal_handle
argument_list|(
name|editor
argument_list|,
name|pixmap
argument_list|,
name|seg
operator|->
name|left
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|seg
operator|=
name|gimp_gradient_segment_get_last
argument_list|(
name|gradient
operator|->
name|segments
argument_list|)
expr_stmt|;
name|control_draw_normal_handle
argument_list|(
name|editor
argument_list|,
name|pixmap
argument_list|,
name|seg
operator|->
name|right
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GRAD_DRAG_MIDDLE
case|:
name|control_draw_middle_handle
argument_list|(
name|editor
argument_list|,
name|pixmap
argument_list|,
name|seg
operator|->
name|middle
argument_list|,
name|height
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_draw_normal_handle (GradientEditor * editor,GdkPixmap * pixmap,gdouble pos,gint height)
name|control_draw_normal_handle
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|,
name|gdouble
name|pos
parameter_list|,
name|gint
name|height
parameter_list|)
block|{
name|control_draw_handle
argument_list|(
name|pixmap
argument_list|,
name|editor
operator|->
name|control
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|editor
operator|->
name|control
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|control_calc_p_pos
argument_list|(
name|editor
argument_list|,
name|pos
argument_list|)
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_draw_middle_handle (GradientEditor * editor,GdkPixmap * pixmap,gdouble pos,gint height)
name|control_draw_middle_handle
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|,
name|gdouble
name|pos
parameter_list|,
name|gint
name|height
parameter_list|)
block|{
name|control_draw_handle
argument_list|(
name|pixmap
argument_list|,
name|editor
operator|->
name|control
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|editor
operator|->
name|control
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_PRELIGHT
index|]
argument_list|,
name|control_calc_p_pos
argument_list|(
name|editor
argument_list|,
name|pos
argument_list|)
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|control_draw_handle (GdkPixmap * pixmap,GdkGC * border_gc,GdkGC * fill_gc,gint xpos,gint height)
name|control_draw_handle
parameter_list|(
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|,
name|GdkGC
modifier|*
name|border_gc
parameter_list|,
name|GdkGC
modifier|*
name|fill_gc
parameter_list|,
name|gint
name|xpos
parameter_list|,
name|gint
name|height
parameter_list|)
block|{
name|gint
name|y
decl_stmt|;
name|gint
name|left
decl_stmt|,
name|right
decl_stmt|,
name|bottom
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|fill_gc
argument_list|,
name|xpos
operator|-
name|y
operator|/
literal|2
argument_list|,
name|y
argument_list|,
name|xpos
operator|+
name|y
operator|/
literal|2
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|bottom
operator|=
name|height
operator|-
literal|1
expr_stmt|;
name|left
operator|=
name|xpos
operator|-
name|bottom
operator|/
literal|2
expr_stmt|;
name|right
operator|=
name|xpos
operator|+
name|bottom
operator|/
literal|2
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|border_gc
argument_list|,
name|xpos
argument_list|,
literal|0
argument_list|,
name|left
argument_list|,
name|bottom
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|border_gc
argument_list|,
name|xpos
argument_list|,
literal|0
argument_list|,
name|right
argument_list|,
name|bottom
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|border_gc
argument_list|,
name|left
argument_list|,
name|bottom
argument_list|,
name|right
argument_list|,
name|bottom
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****/
end_comment

begin_function
specifier|static
name|gint
DECL|function|control_calc_p_pos (GradientEditor * editor,gdouble pos)
name|control_calc_p_pos
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gdouble
name|pos
parameter_list|)
block|{
name|gint
name|pwidth
decl_stmt|,
name|pheight
decl_stmt|;
name|GtkAdjustment
modifier|*
name|adjustment
decl_stmt|;
comment|/* Calculate the position (in widget's coordinates) of the    * requested point from the gradient.  Rounding is done to    * minimize mismatches between the rendered gradient preview    * and the gradient control's handles.    */
name|adjustment
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
expr_stmt|;
name|gdk_drawable_get_size
argument_list|(
name|editor
operator|->
name|control_pixmap
argument_list|,
operator|&
name|pwidth
argument_list|,
operator|&
name|pheight
argument_list|)
expr_stmt|;
return|return
name|RINT
argument_list|(
operator|(
name|pwidth
operator|-
literal|1
operator|)
operator|*
operator|(
name|pos
operator|-
name|adjustment
operator|->
name|value
operator|)
operator|/
name|adjustment
operator|->
name|page_size
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|control_calc_g_pos (GradientEditor * editor,gint pos)
name|control_calc_g_pos
parameter_list|(
name|GradientEditor
modifier|*
name|editor
parameter_list|,
name|gint
name|pos
parameter_list|)
block|{
name|gint
name|pwidth
decl_stmt|,
name|pheight
decl_stmt|;
name|GtkAdjustment
modifier|*
name|adjustment
decl_stmt|;
comment|/* Calculate the gradient position that corresponds to widget's coordinates */
name|adjustment
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|editor
operator|->
name|scroll_data
argument_list|)
expr_stmt|;
name|gdk_drawable_get_size
argument_list|(
name|editor
operator|->
name|control_pixmap
argument_list|,
operator|&
name|pwidth
argument_list|,
operator|&
name|pheight
argument_list|)
expr_stmt|;
return|return
name|adjustment
operator|->
name|page_size
operator|*
name|pos
operator|/
operator|(
name|pwidth
operator|-
literal|1
operator|)
operator|+
name|adjustment
operator|->
name|value
return|;
block|}
end_function

begin_comment
comment|/***** Segment functions *****/
end_comment

begin_function
specifier|static
name|void
DECL|function|seg_get_closest_handle (GimpGradient * grad,gdouble pos,GimpGradientSegment ** seg,GradientEditorDragMode * handle)
name|seg_get_closest_handle
parameter_list|(
name|GimpGradient
modifier|*
name|grad
parameter_list|,
name|gdouble
name|pos
parameter_list|,
name|GimpGradientSegment
modifier|*
modifier|*
name|seg
parameter_list|,
name|GradientEditorDragMode
modifier|*
name|handle
parameter_list|)
block|{
name|gdouble
name|l_delta
decl_stmt|,
name|m_delta
decl_stmt|,
name|r_delta
decl_stmt|;
operator|*
name|seg
operator|=
name|gimp_gradient_get_segment_at
argument_list|(
name|grad
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|m_delta
operator|=
name|fabs
argument_list|(
name|pos
operator|-
operator|(
operator|*
name|seg
operator|)
operator|->
name|middle
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|<
operator|(
operator|*
name|seg
operator|)
operator|->
name|middle
condition|)
block|{
name|l_delta
operator|=
name|fabs
argument_list|(
name|pos
operator|-
operator|(
operator|*
name|seg
operator|)
operator|->
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
name|l_delta
operator|<
name|m_delta
condition|)
operator|*
name|handle
operator|=
name|GRAD_DRAG_LEFT
expr_stmt|;
else|else
operator|*
name|handle
operator|=
name|GRAD_DRAG_MIDDLE
expr_stmt|;
block|}
else|else
block|{
name|r_delta
operator|=
name|fabs
argument_list|(
name|pos
operator|-
operator|(
operator|*
name|seg
operator|)
operator|->
name|right
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_delta
operator|<
name|r_delta
condition|)
block|{
operator|*
name|handle
operator|=
name|GRAD_DRAG_MIDDLE
expr_stmt|;
block|}
else|else
block|{
operator|*
name|seg
operator|=
operator|(
operator|*
name|seg
operator|)
operator|->
name|next
expr_stmt|;
operator|*
name|handle
operator|=
name|GRAD_DRAG_LEFT
expr_stmt|;
block|}
block|}
block|}
end_function

end_unit

