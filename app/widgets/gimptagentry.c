begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * gimptagentry.c  * Copyright (C) 2008 Aurimas JuÅ¡ka<aurisj@svn.gnome.org>  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<gdk/gdkkeysyms.h>
end_include

begin_include
include|#
directive|include
file|"widgets-types.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp-utils.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpcontainer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpcontext.h"
end_include

begin_include
include|#
directive|include
file|"core/gimptag.h"
end_include

begin_include
include|#
directive|include
file|"core/gimptagged.h"
end_include

begin_include
include|#
directive|include
file|"core/gimptaggedcontainer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpviewable.h"
end_include

begin_include
include|#
directive|include
file|"gimptagentry.h"
end_include

begin_include
include|#
directive|include
file|"gimp-intl.h"
end_include

begin_define
DECL|macro|GIMP_TAG_ENTRY_QUERY_DESC
define|#
directive|define
name|GIMP_TAG_ENTRY_QUERY_DESC
value|_("filter")
end_define

begin_define
DECL|macro|GIMP_TAG_ENTRY_ASSIGN_DESC
define|#
directive|define
name|GIMP_TAG_ENTRY_ASSIGN_DESC
value|_("enter tags")
end_define

begin_define
DECL|macro|GIMP_TAG_ENTRY_MAX_RECENT_ITEMS
define|#
directive|define
name|GIMP_TAG_ENTRY_MAX_RECENT_ITEMS
value|20
end_define

begin_typedef
typedef|typedef
enum|enum
DECL|enum|__anon2919856a0103
block|{
DECL|enumerator|TAG_SEARCH_NONE
name|TAG_SEARCH_NONE
block|,
DECL|enumerator|TAG_SEARCH_LEFT
name|TAG_SEARCH_LEFT
block|,
DECL|enumerator|TAG_SEARCH_RIGHT
name|TAG_SEARCH_RIGHT
block|, }
DECL|typedef|GimpTagSearchDir
name|GimpTagSearchDir
typedef|;
end_typedef

begin_enum
enum|enum
DECL|enum|__anon2919856a0203
block|{
DECL|enumerator|PROP_0
name|PROP_0
block|,
DECL|enumerator|PROP_CONTAINER
name|PROP_CONTAINER
block|,
DECL|enumerator|PROP_MODE
name|PROP_MODE
block|}
enum|;
end_enum

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_dispose
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_set_property
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|,
name|guint
name|property_id
parameter_list|,
specifier|const
name|GValue
modifier|*
name|value
parameter_list|,
name|GParamSpec
modifier|*
name|pspec
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_get_property
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|,
name|guint
name|property_id
parameter_list|,
name|GValue
modifier|*
name|value
parameter_list|,
name|GParamSpec
modifier|*
name|pspec
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_activate
parameter_list|(
name|GtkEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_changed
parameter_list|(
name|GtkEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_insert_text
parameter_list|(
name|GtkEditable
modifier|*
name|editable
parameter_list|,
name|gchar
modifier|*
name|new_text
parameter_list|,
name|gint
name|text_length
parameter_list|,
name|gint
modifier|*
name|position
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_delete_text
parameter_list|(
name|GtkEditable
modifier|*
name|editable
parameter_list|,
name|gint
name|start_pos
parameter_list|,
name|gint
name|end_pos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_focus_in
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventFocus
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_focus_out
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventFocus
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_container_changed
parameter_list|(
name|GimpContainer
modifier|*
name|container
parameter_list|,
name|GimpObject
modifier|*
name|object
parameter_list|,
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_button_release
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_key_press
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventKey
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_query_tag
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_assign_tags
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_load_selection
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|gboolean
name|sort
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_find_common_tags
parameter_list|(
name|gpointer
name|key
parameter_list|,
name|gpointer
name|value
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gchar
modifier|*
name|gimp_tag_entry_get_completion_prefix
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GList
modifier|*
name|gimp_tag_entry_get_completion_candidates
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|gchar
modifier|*
modifier|*
name|used_tags
parameter_list|,
name|gchar
modifier|*
name|prefix
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gchar
modifier|*
name|gimp_tag_entry_get_completion_string
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|GList
modifier|*
name|candidates
parameter_list|,
name|gchar
modifier|*
name|prefix
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_auto_complete
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_toggle_desc
parameter_list|(
name|GimpTagEntry
modifier|*
name|widget
parameter_list|,
name|gboolean
name|show
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_expose
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventExpose
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_commit_region
parameter_list|(
name|GString
modifier|*
name|tags
parameter_list|,
name|GString
modifier|*
name|mask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_commit_tags
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_commit_source_func
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_select_jellybean
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|gint
name|selection_start
parameter_list|,
name|gint
name|selection_end
parameter_list|,
name|GimpTagSearchDir
name|search_dir
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_try_select_jellybean
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_add_to_recent
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
specifier|const
name|gchar
modifier|*
name|tags_string
parameter_list|,
name|gboolean
name|to_front
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_next_tag
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|gboolean
name|select
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_previous_tag
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|gboolean
name|select
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_tag_entry_select_for_deletion
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|GimpTagSearchDir
name|search_dir
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_tag_entry_strip_extra_whitespace
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|G_DEFINE_TYPE
argument_list|(
name|GimpTagEntry
argument_list|,
name|gimp_tag_entry
argument_list|,
name|GTK_TYPE_ENTRY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
DECL|macro|parent_class
define|#
directive|define
name|parent_class
value|gimp_tag_entry_parent_class
end_define

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_class_init (GimpTagEntryClass * klass)
name|gimp_tag_entry_class_init
parameter_list|(
name|GimpTagEntryClass
modifier|*
name|klass
parameter_list|)
block|{
name|GObjectClass
modifier|*
name|object_class
init|=
name|G_OBJECT_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|GtkWidgetClass
modifier|*
name|widget_class
init|=
name|GTK_WIDGET_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|object_class
operator|->
name|dispose
operator|=
name|gimp_tag_entry_dispose
expr_stmt|;
name|object_class
operator|->
name|get_property
operator|=
name|gimp_tag_entry_get_property
expr_stmt|;
name|object_class
operator|->
name|set_property
operator|=
name|gimp_tag_entry_set_property
expr_stmt|;
name|widget_class
operator|->
name|button_release_event
operator|=
name|gimp_tag_entry_button_release
expr_stmt|;
name|g_object_class_install_property
argument_list|(
name|object_class
argument_list|,
name|PROP_CONTAINER
argument_list|,
name|g_param_spec_object
argument_list|(
literal|"container"
argument_list|,
literal|"Tagged container"
argument_list|,
literal|"The Tagged container"
argument_list|,
name|GIMP_TYPE_TAGGED_CONTAINER
argument_list|,
name|G_PARAM_CONSTRUCT_ONLY
operator||
name|G_PARAM_READWRITE
argument_list|)
argument_list|)
expr_stmt|;
name|g_object_class_install_property
argument_list|(
name|object_class
argument_list|,
name|PROP_MODE
argument_list|,
name|g_param_spec_enum
argument_list|(
literal|"mode"
argument_list|,
literal|"Working mode"
argument_list|,
literal|"Mode in which to work."
argument_list|,
name|GIMP_TYPE_TAG_ENTRY_MODE
argument_list|,
name|GIMP_TAG_ENTRY_MODE_QUERY
argument_list|,
name|G_PARAM_CONSTRUCT_ONLY
operator||
name|G_PARAM_READWRITE
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_init (GimpTagEntry * entry)
name|gimp_tag_entry_init
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
block|{
name|entry
operator|->
name|container
operator|=
name|NULL
expr_stmt|;
name|entry
operator|->
name|selected_items
operator|=
name|NULL
expr_stmt|;
name|entry
operator|->
name|common_tags
operator|=
name|NULL
expr_stmt|;
name|entry
operator|->
name|tab_completion_index
operator|=
operator|-
literal|1
expr_stmt|;
name|entry
operator|->
name|mode
operator|=
name|GIMP_TAG_ENTRY_MODE_QUERY
expr_stmt|;
name|entry
operator|->
name|description_shown
operator|=
name|FALSE
expr_stmt|;
name|entry
operator|->
name|has_invalid_tags
operator|=
name|FALSE
expr_stmt|;
name|entry
operator|->
name|mask
operator|=
name|g_string_new
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"activate"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_activate
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_changed
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"insert-text"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_insert_text
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"delete-text"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_delete_text
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"key-press-event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_key_press
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"focus-in-event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_focus_in
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"focus-out-event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_focus_out
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect_after
argument_list|(
name|entry
argument_list|,
literal|"expose-event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_expose
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_dispose (GObject * object)
name|gimp_tag_entry_dispose
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|object
argument_list|)
decl_stmt|;
if|if
condition|(
name|entry
operator|->
name|selected_items
condition|)
block|{
name|g_list_free
argument_list|(
name|entry
operator|->
name|selected_items
argument_list|)
expr_stmt|;
name|entry
operator|->
name|selected_items
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|common_tags
condition|)
block|{
name|g_list_free
argument_list|(
name|entry
operator|->
name|common_tags
argument_list|)
expr_stmt|;
name|entry
operator|->
name|common_tags
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|recent_list
condition|)
block|{
name|g_list_free_full
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
operator|(
name|GDestroyNotify
operator|)
name|g_free
argument_list|)
expr_stmt|;
name|entry
operator|->
name|recent_list
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|container
condition|)
block|{
name|g_signal_handlers_disconnect_by_func
argument_list|(
name|entry
operator|->
name|container
argument_list|,
name|gimp_tag_entry_container_changed
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|entry
operator|->
name|container
argument_list|)
expr_stmt|;
name|entry
operator|->
name|container
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|mask
condition|)
block|{
name|g_string_free
argument_list|(
name|entry
operator|->
name|mask
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|entry
operator|->
name|mask
operator|=
name|NULL
expr_stmt|;
block|}
name|G_OBJECT_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|dispose
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_set_property (GObject * object,guint property_id,const GValue * value,GParamSpec * pspec)
name|gimp_tag_entry_set_property
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|,
name|guint
name|property_id
parameter_list|,
specifier|const
name|GValue
modifier|*
name|value
parameter_list|,
name|GParamSpec
modifier|*
name|pspec
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|object
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|property_id
condition|)
block|{
case|case
name|PROP_CONTAINER
case|:
name|entry
operator|->
name|container
operator|=
name|g_value_dup_object
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
operator|->
name|container
argument_list|,
literal|"add"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_container_changed
argument_list|)
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
operator|->
name|container
argument_list|,
literal|"remove"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_container_changed
argument_list|)
argument_list|,
name|entry
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROP_MODE
case|:
name|entry
operator|->
name|mode
operator|=
name|g_value_get_enum
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|gimp_tag_entry_toggle_desc
argument_list|(
name|entry
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
break|break;
default|default:
name|G_OBJECT_WARN_INVALID_PROPERTY_ID
argument_list|(
name|object
argument_list|,
name|property_id
argument_list|,
name|pspec
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_get_property (GObject * object,guint property_id,GValue * value,GParamSpec * pspec)
name|gimp_tag_entry_get_property
parameter_list|(
name|GObject
modifier|*
name|object
parameter_list|,
name|guint
name|property_id
parameter_list|,
name|GValue
modifier|*
name|value
parameter_list|,
name|GParamSpec
modifier|*
name|pspec
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|object
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|property_id
condition|)
block|{
case|case
name|PROP_CONTAINER
case|:
name|g_value_set_object
argument_list|(
name|value
argument_list|,
name|entry
operator|->
name|container
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROP_MODE
case|:
name|g_value_set_enum
argument_list|(
name|value
argument_list|,
name|entry
operator|->
name|mode
argument_list|)
expr_stmt|;
break|break;
default|default:
name|G_OBJECT_WARN_INVALID_PROPERTY_ID
argument_list|(
name|object
argument_list|,
name|property_id
argument_list|,
name|pspec
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/**  * gimp_tag_entry_new:  * @container: a #GimpTaggedContainer object  * @mode:      #GimpTagEntryMode to work in.  *  * #GimpTagEntry is a widget which can query and assign tags to tagged objects.  * When operating in query mode, @container is kept up to date with  * tags selected. When operating in assignment mode, tags are assigned to  * objects selected and visible in @container.  *  * Return value: a new GimpTagEntry widget.  **/
end_comment

begin_function
name|GtkWidget
modifier|*
DECL|function|gimp_tag_entry_new (GimpTaggedContainer * container,GimpTagEntryMode mode)
name|gimp_tag_entry_new
parameter_list|(
name|GimpTaggedContainer
modifier|*
name|container
parameter_list|,
name|GimpTagEntryMode
name|mode
parameter_list|)
block|{
name|g_return_val_if_fail
argument_list|(
name|GIMP_IS_TAGGED_CONTAINER
argument_list|(
name|container
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|g_object_new
argument_list|(
name|GIMP_TYPE_TAG_ENTRY
argument_list|,
literal|"container"
argument_list|,
name|container
argument_list|,
literal|"mode"
argument_list|,
name|mode
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_activate (GtkEntry * entry)
name|gimp_tag_entry_activate
parameter_list|(
name|GtkEntry
modifier|*
name|entry
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|tag_entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
decl_stmt|;
name|gint
name|selection_start
decl_stmt|;
name|gint
name|selection_end
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|gimp_tag_entry_toggle_desc
argument_list|(
name|tag_entry
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|selection_start
argument_list|,
operator|&
name|selection_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|selection_start
operator|!=
name|selection_end
condition|)
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|selection_end
argument_list|,
name|selection_end
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|list
operator|=
name|tag_entry
operator|->
name|selected_items
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|gimp_container_have
argument_list|(
name|GIMP_CONTAINER
argument_list|(
name|tag_entry
operator|->
name|container
argument_list|)
argument_list|,
name|GIMP_OBJECT
argument_list|(
name|list
operator|->
name|data
argument_list|)
argument_list|)
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|tag_entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_ASSIGN
operator|&&
name|list
condition|)
block|{
name|gimp_tag_entry_assign_tags
argument_list|(
name|GIMP_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * gimp_tag_entry_set_tag_string:  * @entry:      a #GimpTagEntry object.  * @tag_string: string of tags, separated by any terminal punctuation  *              character.  *  * Sets tags from @tag_string to @tag_entry. Given tags do not need to  * be valid as they can be fixed or dropped automatically. Depending on  * selected #GimpTagEntryMode, appropriate action is peformed.  **/
end_comment

begin_function
name|void
DECL|function|gimp_tag_entry_set_tag_string (GimpTagEntry * entry,const gchar * tag_string)
name|gimp_tag_entry_set_tag_string
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
specifier|const
name|gchar
modifier|*
name|tag_string
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|entry
operator|->
name|suppress_tag_query
operator|++
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|tag_string
argument_list|)
expr_stmt|;
name|gtk_editable_set_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|entry
operator|->
name|suppress_tag_query
operator|--
expr_stmt|;
name|entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
name|gimp_tag_entry_commit_tags
argument_list|(
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_ASSIGN
condition|)
block|{
name|gimp_tag_entry_assign_tags
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_QUERY
condition|)
block|{
name|gimp_tag_entry_query_tag
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_changed (GtkEntry * entry)
name|gimp_tag_entry_changed
parameter_list|(
name|GtkEntry
modifier|*
name|entry
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|tag_entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|text
decl_stmt|;
name|text
operator|=
name|g_strdup
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|text
operator|=
name|g_strstrip
argument_list|(
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gtk_widget_has_focus
argument_list|(
name|GTK_WIDGET
argument_list|(
name|entry
argument_list|)
argument_list|)
operator|&&
name|strlen
argument_list|(
name|text
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gimp_tag_entry_toggle_desc
argument_list|(
name|tag_entry
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_tag_entry_toggle_desc
argument_list|(
name|tag_entry
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|tag_entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_QUERY
operator|&&
operator|!
name|tag_entry
operator|->
name|suppress_tag_query
operator|&&
operator|!
name|tag_entry
operator|->
name|tag_query_pending
condition|)
block|{
name|tag_entry
operator|->
name|tag_query_pending
operator|=
name|TRUE
expr_stmt|;
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|gimp_tag_entry_query_tag
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_insert_text (GtkEditable * editable,gchar * new_text,gint text_length,gint * position)
name|gimp_tag_entry_insert_text
parameter_list|(
name|GtkEditable
modifier|*
name|editable
parameter_list|,
name|gchar
modifier|*
name|new_text
parameter_list|,
name|gint
name|text_length
parameter_list|,
name|gint
modifier|*
name|position
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|editable
argument_list|)
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|entry_text
decl_stmt|;
name|gboolean
name|is_tag
index|[
literal|2
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|insert_pos
init|=
operator|*
name|position
decl_stmt|;
name|glong
name|num_chars
decl_stmt|;
name|entry_text
operator|=
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|editable
argument_list|)
argument_list|)
expr_stmt|;
name|num_chars
operator|=
name|g_utf8_strlen
argument_list|(
name|new_text
argument_list|,
name|text_length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|entry
operator|->
name|internal_operation
condition|)
block|{
comment|/* suppress tag queries until auto completion runs */
name|entry
operator|->
name|suppress_tag_query
operator|++
expr_stmt|;
block|}
name|is_tag
index|[
literal|0
index|]
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|*
name|position
operator|>
literal|0
condition|)
block|{
name|is_tag
index|[
literal|0
index|]
operator|=
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
operator|*
name|position
operator|-
literal|1
index|]
operator|==
literal|'t'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
operator|*
name|position
operator|-
literal|1
index|]
operator|==
literal|'s'
operator|)
expr_stmt|;
block|}
name|is_tag
index|[
literal|1
index|]
operator|=
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
operator|*
name|position
index|]
operator|==
literal|'t'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
operator|*
name|position
index|]
operator|==
literal|'s'
operator|)
expr_stmt|;
if|if
condition|(
name|is_tag
index|[
literal|0
index|]
operator|&&
name|is_tag
index|[
literal|1
index|]
condition|)
block|{
name|g_signal_stop_emission_by_name
argument_list|(
name|editable
argument_list|,
literal|"insert-text"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|num_chars
operator|>
literal|0
condition|)
block|{
name|gunichar
name|c
init|=
name|g_utf8_get_char
argument_list|(
name|new_text
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|entry
operator|->
name|internal_operation
operator|&&
operator|*
name|position
operator|>
literal|0
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
operator|*
name|position
operator|-
literal|1
index|]
operator|==
literal|'s'
operator|&&
operator|!
name|g_unichar_isspace
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|entry
operator|->
name|suppress_mask_update
condition|)
block|{
name|g_string_insert_c
argument_list|(
name|entry
operator|->
name|mask
argument_list|,
operator|*
name|position
argument_list|,
literal|'u'
argument_list|)
expr_stmt|;
block|}
name|g_signal_handlers_block_by_func
argument_list|(
name|editable
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_insert_text
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_editable_insert_text
argument_list|(
name|editable
argument_list|,
literal|" "
argument_list|,
literal|1
argument_list|,
name|position
argument_list|)
expr_stmt|;
name|gtk_editable_insert_text
argument_list|(
name|editable
argument_list|,
name|new_text
argument_list|,
name|text_length
argument_list|,
name|position
argument_list|)
expr_stmt|;
name|g_signal_handlers_unblock_by_func
argument_list|(
name|editable
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_insert_text
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_stop_emission_by_name
argument_list|(
name|editable
argument_list|,
literal|"insert-text"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|entry
operator|->
name|internal_operation
operator|&&
name|num_chars
operator|==
literal|1
operator|&&
operator|*
name|position
operator|<
name|entry
operator|->
name|mask
operator|->
name|len
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
operator|*
name|position
index|]
operator|==
literal|'t'
operator|&&
operator|!
name|g_unichar_isspace
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|entry
operator|->
name|suppress_mask_update
condition|)
block|{
name|g_string_insert_c
argument_list|(
name|entry
operator|->
name|mask
argument_list|,
operator|*
name|position
argument_list|,
literal|'u'
argument_list|)
expr_stmt|;
block|}
name|g_signal_handlers_block_by_func
argument_list|(
name|editable
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_insert_text
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_editable_insert_text
argument_list|(
name|editable
argument_list|,
name|new_text
argument_list|,
name|text_length
argument_list|,
name|position
argument_list|)
expr_stmt|;
name|gtk_editable_insert_text
argument_list|(
name|editable
argument_list|,
literal|" "
argument_list|,
literal|1
argument_list|,
name|position
argument_list|)
expr_stmt|;
operator|(
operator|*
name|position
operator|)
operator|--
expr_stmt|;
name|g_signal_handlers_unblock_by_func
argument_list|(
name|editable
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_tag_entry_insert_text
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_stop_emission_by_name
argument_list|(
name|editable
argument_list|,
literal|"insert-text"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|entry
operator|->
name|suppress_mask_update
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_chars
condition|;
name|i
operator|++
control|)
block|{
name|g_string_insert_c
argument_list|(
name|entry
operator|->
name|mask
argument_list|,
name|insert_pos
operator|+
name|i
argument_list|,
literal|'u'
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|entry
operator|->
name|internal_operation
condition|)
block|{
name|entry
operator|->
name|tab_completion_index
operator|=
operator|-
literal|1
expr_stmt|;
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|gimp_tag_entry_auto_complete
argument_list|,
name|editable
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_delete_text (GtkEditable * editable,gint start_pos,gint end_pos)
name|gimp_tag_entry_delete_text
parameter_list|(
name|GtkEditable
modifier|*
name|editable
parameter_list|,
name|gint
name|start_pos
parameter_list|,
name|gint
name|end_pos
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|editable
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|entry
operator|->
name|internal_operation
condition|)
block|{
name|g_signal_handlers_block_by_func
argument_list|(
name|editable
argument_list|,
name|gimp_tag_entry_delete_text
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_pos
operator|>
name|start_pos
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
operator|-
literal|1
index|]
operator|==
literal|'t'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
operator|-
literal|1
index|]
operator|==
literal|'s'
operator|)
condition|)
block|{
while|while
condition|(
name|end_pos
operator|<=
name|entry
operator|->
name|mask
operator|->
name|len
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
index|]
operator|==
literal|'s'
operator|)
condition|)
block|{
name|end_pos
operator|++
expr_stmt|;
block|}
block|}
name|gtk_editable_delete_text
argument_list|(
name|editable
argument_list|,
name|start_pos
argument_list|,
name|end_pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|entry
operator|->
name|suppress_mask_update
condition|)
block|{
name|g_string_erase
argument_list|(
name|entry
operator|->
name|mask
argument_list|,
name|start_pos
argument_list|,
name|end_pos
operator|-
name|start_pos
argument_list|)
expr_stmt|;
block|}
name|g_signal_handlers_unblock_by_func
argument_list|(
name|editable
argument_list|,
name|gimp_tag_entry_delete_text
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_stop_emission_by_name
argument_list|(
name|editable
argument_list|,
literal|"delete-text"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|entry
operator|->
name|suppress_mask_update
condition|)
block|{
name|g_string_erase
argument_list|(
name|entry
operator|->
name|mask
argument_list|,
name|start_pos
argument_list|,
name|end_pos
operator|-
name|start_pos
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_query_tag (GimpTagEntry * entry)
name|gimp_tag_entry_query_tag
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
block|{
name|gchar
modifier|*
modifier|*
name|parsed_tags
decl_stmt|;
name|gint
name|count
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|GList
modifier|*
name|query_list
init|=
name|NULL
decl_stmt|;
name|gboolean
name|has_invalid_tags
decl_stmt|;
if|if
condition|(
name|entry
operator|->
name|suppress_tag_query
condition|)
block|{
name|entry
operator|->
name|tag_query_pending
operator|=
name|FALSE
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|has_invalid_tags
operator|=
name|FALSE
expr_stmt|;
name|parsed_tags
operator|=
name|gimp_tag_entry_parse_tags
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|count
operator|=
name|g_strv_length
argument_list|(
name|parsed_tags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|parsed_tags
index|[
name|i
index|]
argument_list|)
operator|>
literal|0
condition|)
block|{
name|GimpTag
modifier|*
name|tag
init|=
name|gimp_tag_try_new
argument_list|(
name|parsed_tags
index|[
name|i
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|tag
condition|)
name|has_invalid_tags
operator|=
name|TRUE
expr_stmt|;
name|query_list
operator|=
name|g_list_append
argument_list|(
name|query_list
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
block|}
name|g_strfreev
argument_list|(
name|parsed_tags
argument_list|)
expr_stmt|;
name|gimp_tagged_container_set_filter
argument_list|(
name|GIMP_TAGGED_CONTAINER
argument_list|(
name|entry
operator|->
name|container
argument_list|)
argument_list|,
name|query_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|has_invalid_tags
operator|!=
name|entry
operator|->
name|has_invalid_tags
condition|)
block|{
name|entry
operator|->
name|has_invalid_tags
operator|=
name|has_invalid_tags
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|GTK_WIDGET
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|entry
operator|->
name|tag_query_pending
operator|=
name|FALSE
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_auto_complete (GimpTagEntry * tag_entry)
name|gimp_tag_entry_auto_complete
parameter_list|(
name|GimpTagEntry
modifier|*
name|tag_entry
parameter_list|)
block|{
name|GtkEntry
modifier|*
name|entry
init|=
name|GTK_ENTRY
argument_list|(
name|tag_entry
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|completion_prefix
decl_stmt|;
name|GList
modifier|*
name|completion_candidates
decl_stmt|;
name|gint
name|candidate_count
init|=
literal|0
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|tags
decl_stmt|;
name|gchar
modifier|*
name|completion
decl_stmt|;
name|gint
name|start_position
decl_stmt|;
name|gint
name|end_position
decl_stmt|;
name|tag_entry
operator|->
name|suppress_tag_query
operator|--
expr_stmt|;
if|if
condition|(
name|tag_entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_QUERY
condition|)
block|{
comment|/* tag query was suppressed until we got to auto completion (here),        * now queue tag query        */
name|tag_entry
operator|->
name|tag_query_pending
operator|=
name|TRUE
expr_stmt|;
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|gimp_tag_entry_query_tag
argument_list|,
name|tag_entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tag_entry
operator|->
name|tab_completion_index
operator|>=
literal|0
condition|)
block|{
name|tag_entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|tag_entry
operator|->
name|suppress_tag_query
operator|++
expr_stmt|;
name|gtk_editable_delete_selection
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|tag_entry
argument_list|)
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|suppress_tag_query
operator|--
expr_stmt|;
name|tag_entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
block|}
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|tag_entry
argument_list|)
argument_list|,
operator|&
name|start_position
argument_list|,
operator|&
name|end_position
argument_list|)
expr_stmt|;
if|if
condition|(
name|start_position
operator|!=
name|end_position
condition|)
block|{
comment|/* only autocomplete what user types,        * not was autocompleted in the previous step.        */
return|return
name|FALSE
return|;
block|}
name|completion_prefix
operator|=
name|gimp_tag_entry_get_completion_prefix
argument_list|(
name|GIMP_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|tags
operator|=
name|gimp_tag_entry_parse_tags
argument_list|(
name|GIMP_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|completion_candidates
operator|=
name|gimp_tag_entry_get_completion_candidates
argument_list|(
name|GIMP_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|tags
argument_list|,
name|completion_prefix
argument_list|)
expr_stmt|;
name|completion_candidates
operator|=
name|g_list_sort
argument_list|(
name|completion_candidates
argument_list|,
name|gimp_tag_compare_func
argument_list|)
expr_stmt|;
if|if
condition|(
name|tag_entry
operator|->
name|tab_completion_index
operator|>=
literal|0
operator|&&
name|completion_candidates
condition|)
block|{
name|GimpTag
modifier|*
name|the_chosen_one
decl_stmt|;
name|candidate_count
operator|=
name|g_list_length
argument_list|(
name|completion_candidates
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|tab_completion_index
operator|%=
name|candidate_count
expr_stmt|;
name|the_chosen_one
operator|=
name|g_list_nth_data
argument_list|(
name|completion_candidates
argument_list|,
name|tag_entry
operator|->
name|tab_completion_index
argument_list|)
expr_stmt|;
name|g_list_free
argument_list|(
name|completion_candidates
argument_list|)
expr_stmt|;
name|completion_candidates
operator|=
name|NULL
expr_stmt|;
name|completion_candidates
operator|=
name|g_list_append
argument_list|(
name|completion_candidates
argument_list|,
name|the_chosen_one
argument_list|)
expr_stmt|;
block|}
name|completion
operator|=
name|gimp_tag_entry_get_completion_string
argument_list|(
name|GIMP_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|completion_candidates
argument_list|,
name|completion_prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|completion
operator|&&
name|strlen
argument_list|(
name|completion
argument_list|)
operator|>
literal|0
condition|)
block|{
name|start_position
operator|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|end_position
operator|=
name|start_position
expr_stmt|;
name|tag_entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|gtk_editable_insert_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|completion
argument_list|,
name|strlen
argument_list|(
name|completion
argument_list|)
argument_list|,
operator|&
name|end_position
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
if|if
condition|(
name|tag_entry
operator|->
name|tab_completion_index
operator|>=
literal|0
operator|&&
name|candidate_count
operator|==
literal|1
condition|)
block|{
name|gtk_editable_set_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|end_position
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|start_position
argument_list|,
name|end_position
argument_list|)
expr_stmt|;
block|}
block|}
name|g_free
argument_list|(
name|completion
argument_list|)
expr_stmt|;
name|g_strfreev
argument_list|(
name|tags
argument_list|)
expr_stmt|;
name|g_list_free
argument_list|(
name|completion_candidates
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|completion_prefix
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_assign_tags (GimpTagEntry * tag_entry)
name|gimp_tag_entry_assign_tags
parameter_list|(
name|GimpTagEntry
modifier|*
name|tag_entry
parameter_list|)
block|{
name|gchar
modifier|*
modifier|*
name|parsed_tags
decl_stmt|;
name|gint
name|count
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|GimpTag
modifier|*
name|tag
decl_stmt|;
name|GList
modifier|*
name|resource_iter
decl_stmt|;
name|GList
modifier|*
name|tag_iter
decl_stmt|;
name|GList
modifier|*
name|dont_remove_list
init|=
name|NULL
decl_stmt|;
name|GList
modifier|*
name|remove_list
init|=
name|NULL
decl_stmt|;
name|GList
modifier|*
name|add_list
init|=
name|NULL
decl_stmt|;
name|GList
modifier|*
name|common_tags
init|=
name|NULL
decl_stmt|;
name|parsed_tags
operator|=
name|gimp_tag_entry_parse_tags
argument_list|(
name|tag_entry
argument_list|)
expr_stmt|;
name|count
operator|=
name|g_strv_length
argument_list|(
name|parsed_tags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|tag
operator|=
name|gimp_tag_new
argument_list|(
name|parsed_tags
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tag
condition|)
block|{
if|if
condition|(
name|g_list_find_custom
argument_list|(
name|tag_entry
operator|->
name|common_tags
argument_list|,
name|tag
argument_list|,
name|gimp_tag_compare_func
argument_list|)
condition|)
block|{
name|dont_remove_list
operator|=
name|g_list_prepend
argument_list|(
name|dont_remove_list
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|add_list
operator|=
name|g_list_prepend
argument_list|(
name|add_list
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
name|common_tags
operator|=
name|g_list_prepend
argument_list|(
name|common_tags
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
block|}
name|g_strfreev
argument_list|(
name|parsed_tags
argument_list|)
expr_stmt|;
comment|/* find common tags which were removed. */
for|for
control|(
name|tag_iter
operator|=
name|tag_entry
operator|->
name|common_tags
init|;
name|tag_iter
condition|;
name|tag_iter
operator|=
name|g_list_next
argument_list|(
name|tag_iter
argument_list|)
control|)
block|{
if|if
condition|(
operator|!
name|g_list_find_custom
argument_list|(
name|dont_remove_list
argument_list|,
name|tag_iter
operator|->
name|data
argument_list|,
name|gimp_tag_compare_func
argument_list|)
condition|)
block|{
name|remove_list
operator|=
name|g_list_prepend
argument_list|(
name|remove_list
argument_list|,
name|tag_iter
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
block|}
name|g_list_free
argument_list|(
name|dont_remove_list
argument_list|)
expr_stmt|;
for|for
control|(
name|resource_iter
operator|=
name|tag_entry
operator|->
name|selected_items
init|;
name|resource_iter
condition|;
name|resource_iter
operator|=
name|g_list_next
argument_list|(
name|resource_iter
argument_list|)
control|)
block|{
name|GimpTagged
modifier|*
name|tagged
init|=
name|GIMP_TAGGED
argument_list|(
name|resource_iter
operator|->
name|data
argument_list|)
decl_stmt|;
for|for
control|(
name|tag_iter
operator|=
name|remove_list
init|;
name|tag_iter
condition|;
name|tag_iter
operator|=
name|g_list_next
argument_list|(
name|tag_iter
argument_list|)
control|)
block|{
name|gimp_tagged_remove_tag
argument_list|(
name|tagged
argument_list|,
name|GIMP_TAG
argument_list|(
name|tag_iter
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|tag_iter
operator|=
name|add_list
init|;
name|tag_iter
condition|;
name|tag_iter
operator|=
name|g_list_next
argument_list|(
name|tag_iter
argument_list|)
control|)
block|{
name|gimp_tagged_add_tag
argument_list|(
name|tagged
argument_list|,
name|GIMP_TAG
argument_list|(
name|tag_iter
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|g_list_free
argument_list|(
name|add_list
argument_list|)
expr_stmt|;
name|g_list_free
argument_list|(
name|remove_list
argument_list|)
expr_stmt|;
comment|/* common tags list with changes applied. */
name|g_list_free
argument_list|(
name|tag_entry
operator|->
name|common_tags
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|common_tags
operator|=
name|common_tags
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * gimp_tag_entry_parse_tags:  * @entry:      a #GimpTagEntry widget.  *  * Parses currently entered tags from @entry. Tags do not need to be valid as  * they are fixed when necessary. Only valid tags are returned.  *  * Return value: a newly allocated NULL terminated list of strings. It should  * be freed using g_strfreev().  **/
end_comment

begin_function
name|gchar
modifier|*
modifier|*
DECL|function|gimp_tag_entry_parse_tags (GimpTagEntry * entry)
name|gimp_tag_entry_parse_tags
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
block|{
name|gchar
modifier|*
modifier|*
name|parsed_tags
decl_stmt|;
name|gint
name|length
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|GString
modifier|*
name|parsed_tag
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|cursor
decl_stmt|;
name|GList
modifier|*
name|tag_list
init|=
name|NULL
decl_stmt|;
name|GList
modifier|*
name|iterator
decl_stmt|;
name|gunichar
name|c
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|GIMP_IS_TAG_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|parsed_tag
operator|=
name|g_string_new
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
do|do
block|{
name|c
operator|=
name|g_utf8_get_char
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|g_utf8_next_char
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|||
name|gimp_tag_is_tag_separator
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
name|parsed_tag
operator|->
name|len
operator|>
literal|0
condition|)
block|{
name|gchar
modifier|*
name|validated_tag
init|=
name|gimp_tag_string_make_valid
argument_list|(
name|parsed_tag
operator|->
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
name|validated_tag
condition|)
block|{
name|tag_list
operator|=
name|g_list_append
argument_list|(
name|tag_list
argument_list|,
name|validated_tag
argument_list|)
expr_stmt|;
block|}
name|g_string_set_size
argument_list|(
name|parsed_tag
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|g_string_append_unichar
argument_list|(
name|parsed_tag
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|c
condition|)
do|;
name|g_string_free
argument_list|(
name|parsed_tag
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|length
operator|=
name|g_list_length
argument_list|(
name|tag_list
argument_list|)
expr_stmt|;
name|parsed_tags
operator|=
name|g_malloc
argument_list|(
operator|(
name|length
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|gchar
operator|*
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|iterator
operator|=
name|tag_list
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|parsed_tags
index|[
name|i
index|]
operator|=
operator|(
name|gchar
operator|*
operator|)
name|iterator
operator|->
name|data
expr_stmt|;
name|iterator
operator|=
name|g_list_next
argument_list|(
name|iterator
argument_list|)
expr_stmt|;
block|}
name|parsed_tags
index|[
name|length
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|parsed_tags
return|;
block|}
end_function

begin_comment
comment|/**  * gimp_tag_entry_set_selected_items:  * @tag_entry:  a #GimpTagEntry widget.  * @items:      a list of #GimpTagged objects.  *  * Set list of currently selected #GimpTagged objects. Only selected and  * visible (not filtered out) #GimpTagged objects are assigned tags when  * operating in tag assignment mode.  **/
end_comment

begin_function
name|void
DECL|function|gimp_tag_entry_set_selected_items (GimpTagEntry * tag_entry,GList * items)
name|gimp_tag_entry_set_selected_items
parameter_list|(
name|GimpTagEntry
modifier|*
name|tag_entry
parameter_list|,
name|GList
modifier|*
name|items
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_TAG_ENTRY
argument_list|(
name|tag_entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tag_entry
operator|->
name|selected_items
condition|)
block|{
name|g_list_free
argument_list|(
name|tag_entry
operator|->
name|selected_items
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|selected_items
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|tag_entry
operator|->
name|common_tags
condition|)
block|{
name|g_list_free
argument_list|(
name|tag_entry
operator|->
name|common_tags
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|common_tags
operator|=
name|NULL
expr_stmt|;
block|}
name|tag_entry
operator|->
name|selected_items
operator|=
name|g_list_copy
argument_list|(
name|items
argument_list|)
expr_stmt|;
if|if
condition|(
name|tag_entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_ASSIGN
condition|)
block|{
name|gimp_tag_entry_load_selection
argument_list|(
name|tag_entry
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_load_selection (GimpTagEntry * tag_entry,gboolean sort)
name|gimp_tag_entry_load_selection
parameter_list|(
name|GimpTagEntry
modifier|*
name|tag_entry
parameter_list|,
name|gboolean
name|sort
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|insert_pos
decl_stmt|;
name|GHashTable
modifier|*
name|refcounts
decl_stmt|;
name|GList
modifier|*
name|resource
decl_stmt|;
name|GList
modifier|*
name|tag
decl_stmt|;
name|tag_entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|gtk_editable_delete_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|tag_entry
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|tag_entry
operator|->
name|selected_items
condition|)
block|{
name|gimp_tag_entry_toggle_desc
argument_list|(
name|tag_entry
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
name|refcounts
operator|=
name|g_hash_table_new
argument_list|(
operator|(
name|GHashFunc
operator|)
name|gimp_tag_get_hash
argument_list|,
operator|(
name|GEqualFunc
operator|)
name|gimp_tag_equals
argument_list|)
expr_stmt|;
comment|/* find set of tags common to all resources. */
for|for
control|(
name|resource
operator|=
name|tag_entry
operator|->
name|selected_items
init|;
name|resource
condition|;
name|resource
operator|=
name|g_list_next
argument_list|(
name|resource
argument_list|)
control|)
block|{
for|for
control|(
name|tag
operator|=
name|gimp_tagged_get_tags
argument_list|(
name|GIMP_TAGGED
argument_list|(
name|resource
operator|->
name|data
argument_list|)
argument_list|)
init|;
name|tag
condition|;
name|tag
operator|=
name|g_list_next
argument_list|(
name|tag
argument_list|)
control|)
block|{
comment|/* count refcount for each tag */
name|guint
name|refcount
init|=
name|GPOINTER_TO_UINT
argument_list|(
name|g_hash_table_lookup
argument_list|(
name|refcounts
argument_list|,
name|tag
operator|->
name|data
argument_list|)
argument_list|)
decl_stmt|;
name|g_hash_table_insert
argument_list|(
name|refcounts
argument_list|,
name|tag
operator|->
name|data
argument_list|,
name|GUINT_TO_POINTER
argument_list|(
name|refcount
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|g_hash_table_foreach
argument_list|(
name|refcounts
argument_list|,
name|gimp_tag_entry_find_common_tags
argument_list|,
name|tag_entry
argument_list|)
expr_stmt|;
name|g_hash_table_destroy
argument_list|(
name|refcounts
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|common_tags
operator|=
name|g_list_sort
argument_list|(
name|tag_entry
operator|->
name|common_tags
argument_list|,
name|gimp_tag_compare_func
argument_list|)
expr_stmt|;
name|insert_pos
operator|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|tag_entry
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|list
operator|=
name|tag_entry
operator|->
name|common_tags
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|GimpTag
modifier|*
name|tag
init|=
name|list
operator|->
name|data
decl_stmt|;
name|gchar
modifier|*
name|text
decl_stmt|;
name|text
operator|=
name|g_strdup_printf
argument_list|(
literal|"%s%s "
argument_list|,
name|gimp_tag_get_name
argument_list|(
name|tag
argument_list|)
argument_list|,
name|gimp_tag_entry_get_separator
argument_list|()
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|gtk_editable_insert_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|tag_entry
argument_list|)
argument_list|,
name|text
argument_list|,
name|strlen
argument_list|(
name|text
argument_list|)
argument_list|,
operator|&
name|insert_pos
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
name|g_free
argument_list|(
name|text
argument_list|)
expr_stmt|;
block|}
name|gimp_tag_entry_commit_tags
argument_list|(
name|tag_entry
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_find_common_tags (gpointer key,gpointer value,gpointer user_data)
name|gimp_tag_entry_find_common_tags
parameter_list|(
name|gpointer
name|key
parameter_list|,
name|gpointer
name|value
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|guint
name|ref_count
init|=
name|GPOINTER_TO_UINT
argument_list|(
name|value
argument_list|)
decl_stmt|;
name|GimpTagEntry
modifier|*
name|tag_entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|user_data
argument_list|)
decl_stmt|;
comment|/* FIXME: more efficient list length */
if|if
condition|(
name|ref_count
operator|==
name|g_list_length
argument_list|(
name|tag_entry
operator|->
name|selected_items
argument_list|)
condition|)
block|{
name|tag_entry
operator|->
name|common_tags
operator|=
name|g_list_prepend
argument_list|(
name|tag_entry
operator|->
name|common_tags
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|gimp_tag_entry_get_completion_prefix (GimpTagEntry * entry)
name|gimp_tag_entry_get_completion_prefix
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
block|{
name|gchar
modifier|*
name|original_string
decl_stmt|;
name|gchar
modifier|*
name|prefix_start
decl_stmt|;
name|gchar
modifier|*
name|prefix
decl_stmt|;
name|gchar
modifier|*
name|cursor
decl_stmt|;
name|gint
name|position
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|position
operator|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|position
operator|<
literal|1
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
operator|-
literal|1
index|]
operator|!=
literal|'u'
condition|)
block|{
return|return
name|g_strdup
argument_list|(
literal|""
argument_list|)
return|;
block|}
name|original_string
operator|=
name|g_strdup
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|original_string
expr_stmt|;
name|prefix_start
operator|=
name|original_string
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|position
condition|;
name|i
operator|++
control|)
block|{
name|gunichar
name|c
decl_stmt|;
name|c
operator|=
name|g_utf8_get_char
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|g_utf8_next_char
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_tag_is_tag_separator
argument_list|(
name|c
argument_list|)
condition|)
name|prefix_start
operator|=
name|cursor
expr_stmt|;
block|}
operator|*
name|cursor
operator|=
literal|'\0'
expr_stmt|;
name|prefix
operator|=
name|g_strdup
argument_list|(
name|g_strchug
argument_list|(
name|prefix_start
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|original_string
argument_list|)
expr_stmt|;
return|return
name|prefix
return|;
block|}
end_function

begin_function
specifier|static
name|GList
modifier|*
DECL|function|gimp_tag_entry_get_completion_candidates (GimpTagEntry * tag_entry,gchar ** used_tags,gchar * src_prefix)
name|gimp_tag_entry_get_completion_candidates
parameter_list|(
name|GimpTagEntry
modifier|*
name|tag_entry
parameter_list|,
name|gchar
modifier|*
modifier|*
name|used_tags
parameter_list|,
name|gchar
modifier|*
name|src_prefix
parameter_list|)
block|{
name|GList
modifier|*
name|candidates
init|=
name|NULL
decl_stmt|;
name|GList
modifier|*
name|all_tags
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|tag_name
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|length
decl_stmt|;
name|gchar
modifier|*
name|prefix
decl_stmt|;
if|if
condition|(
operator|!
name|src_prefix
operator|||
name|strlen
argument_list|(
name|src_prefix
argument_list|)
operator|<
literal|1
condition|)
return|return
name|NULL
return|;
name|prefix
operator|=
name|g_utf8_normalize
argument_list|(
name|src_prefix
argument_list|,
operator|-
literal|1
argument_list|,
name|G_NORMALIZE_ALL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|prefix
condition|)
return|return
name|NULL
return|;
name|all_tags
operator|=
name|g_hash_table_get_keys
argument_list|(
name|tag_entry
operator|->
name|container
operator|->
name|tag_ref_counts
argument_list|)
expr_stmt|;
name|length
operator|=
name|g_strv_length
argument_list|(
name|used_tags
argument_list|)
expr_stmt|;
for|for
control|(
name|list
operator|=
name|all_tags
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|GimpTag
modifier|*
name|tag
init|=
name|list
operator|->
name|data
decl_stmt|;
name|tag_name
operator|=
name|gimp_tag_get_name
argument_list|(
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_str_has_prefix
argument_list|(
name|tag_name
argument_list|,
name|prefix
argument_list|)
condition|)
block|{
comment|/* check if tag is not already entered */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|gimp_tag_compare_with_string
argument_list|(
name|tag
argument_list|,
name|used_tags
index|[
name|i
index|]
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|length
condition|)
name|candidates
operator|=
name|g_list_append
argument_list|(
name|candidates
argument_list|,
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
block|}
name|g_list_free
argument_list|(
name|all_tags
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|prefix
argument_list|)
expr_stmt|;
return|return
name|candidates
return|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|gimp_tag_entry_get_completion_string (GimpTagEntry * tag_entry,GList * candidates,gchar * prefix)
name|gimp_tag_entry_get_completion_string
parameter_list|(
name|GimpTagEntry
modifier|*
name|tag_entry
parameter_list|,
name|GList
modifier|*
name|candidates
parameter_list|,
name|gchar
modifier|*
name|prefix
parameter_list|)
block|{
specifier|const
name|gchar
modifier|*
modifier|*
name|completions
decl_stmt|;
name|guint
name|length
decl_stmt|;
name|guint
name|i
decl_stmt|;
name|GList
modifier|*
name|candidate_iterator
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|candidate_string
decl_stmt|;
name|gint
name|prefix_length
decl_stmt|;
name|gunichar
name|c
decl_stmt|;
name|gunichar
name|d
decl_stmt|;
name|gint
name|num_chars_match
decl_stmt|;
name|gchar
modifier|*
name|completion
decl_stmt|;
name|gchar
modifier|*
name|completion_end
decl_stmt|;
name|gint
name|completion_length
decl_stmt|;
name|gchar
modifier|*
name|normalized_prefix
decl_stmt|;
if|if
condition|(
operator|!
name|candidates
condition|)
return|return
name|NULL
return|;
name|normalized_prefix
operator|=
name|g_utf8_normalize
argument_list|(
name|prefix
argument_list|,
operator|-
literal|1
argument_list|,
name|G_NORMALIZE_ALL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|normalized_prefix
condition|)
return|return
name|NULL
return|;
name|prefix_length
operator|=
name|strlen
argument_list|(
name|normalized_prefix
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|normalized_prefix
argument_list|)
expr_stmt|;
name|length
operator|=
name|g_list_length
argument_list|(
name|candidates
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|2
condition|)
block|{
name|candidate_string
operator|=
name|gimp_tag_get_name
argument_list|(
name|GIMP_TAG
argument_list|(
name|candidates
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|g_strdup
argument_list|(
name|candidate_string
operator|+
name|prefix_length
argument_list|)
return|;
block|}
name|completions
operator|=
name|g_malloc
argument_list|(
name|length
operator|*
sizeof|sizeof
argument_list|(
name|gchar
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|candidate_iterator
operator|=
name|candidates
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|candidate_string
operator|=
name|gimp_tag_get_name
argument_list|(
name|GIMP_TAG
argument_list|(
name|candidate_iterator
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|completions
index|[
name|i
index|]
operator|=
name|candidate_string
operator|+
name|prefix_length
expr_stmt|;
name|candidate_iterator
operator|=
name|g_list_next
argument_list|(
name|candidate_iterator
argument_list|)
expr_stmt|;
block|}
name|num_chars_match
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|c
operator|=
name|g_utf8_get_char
argument_list|(
name|completions
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|d
operator|=
name|g_utf8_get_char
argument_list|(
name|completions
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|!=
name|d
condition|)
block|{
name|candidate_string
operator|=
name|gimp_tag_get_name
argument_list|(
name|GIMP_TAG
argument_list|(
name|candidates
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|candidate_string
operator|+=
name|prefix_length
expr_stmt|;
name|completion_end
operator|=
name|g_utf8_offset_to_pointer
argument_list|(
name|candidate_string
argument_list|,
name|num_chars_match
argument_list|)
expr_stmt|;
name|completion_length
operator|=
name|completion_end
operator|-
name|candidate_string
expr_stmt|;
name|completion
operator|=
name|g_malloc
argument_list|(
name|completion_length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|completion
argument_list|,
name|candidate_string
argument_list|,
name|completion_length
argument_list|)
expr_stmt|;
name|completion
index|[
name|completion_length
index|]
operator|=
literal|'\0'
expr_stmt|;
name|g_free
argument_list|(
name|completions
argument_list|)
expr_stmt|;
return|return
name|completion
return|;
block|}
name|completions
index|[
name|i
index|]
operator|=
name|g_utf8_next_char
argument_list|(
name|completions
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|completions
index|[
literal|0
index|]
operator|=
name|g_utf8_next_char
argument_list|(
name|completions
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|num_chars_match
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|c
condition|)
do|;
name|g_free
argument_list|(
name|completions
argument_list|)
expr_stmt|;
name|candidate_string
operator|=
name|gimp_tag_get_name
argument_list|(
name|GIMP_TAG
argument_list|(
name|candidates
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|g_strdup
argument_list|(
name|candidate_string
operator|+
name|prefix_length
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_focus_in (GtkWidget * widget,GdkEventFocus * event)
name|gimp_tag_entry_focus_in
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventFocus
modifier|*
name|event
parameter_list|)
block|{
name|gimp_tag_entry_toggle_desc
argument_list|(
name|GIMP_TAG_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_focus_out (GtkWidget * widget,GdkEventFocus * event)
name|gimp_tag_entry_focus_out
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventFocus
modifier|*
name|event
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|tag_entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|widget
argument_list|)
decl_stmt|;
name|gimp_tag_entry_commit_tags
argument_list|(
name|tag_entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|tag_entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_ASSIGN
condition|)
block|{
name|gimp_tag_entry_assign_tags
argument_list|(
name|GIMP_TAG_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|gimp_tag_entry_add_to_recent
argument_list|(
name|tag_entry
argument_list|,
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_tag_entry_toggle_desc
argument_list|(
name|tag_entry
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_container_changed (GimpContainer * container,GimpObject * object,GimpTagEntry * tag_entry)
name|gimp_tag_entry_container_changed
parameter_list|(
name|GimpContainer
modifier|*
name|container
parameter_list|,
name|GimpObject
modifier|*
name|object
parameter_list|,
name|GimpTagEntry
modifier|*
name|tag_entry
parameter_list|)
block|{
if|if
condition|(
name|tag_entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_ASSIGN
condition|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
for|for
control|(
name|list
operator|=
name|tag_entry
operator|->
name|selected_items
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|gimp_tagged_get_tags
argument_list|(
name|GIMP_TAGGED
argument_list|(
name|list
operator|->
name|data
argument_list|)
argument_list|)
operator|&&
name|gimp_container_have
argument_list|(
name|GIMP_CONTAINER
argument_list|(
name|tag_entry
operator|->
name|container
argument_list|)
argument_list|,
name|GIMP_OBJECT
argument_list|(
name|list
operator|->
name|data
argument_list|)
argument_list|)
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|list
condition|)
block|{
name|tag_entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|gtk_editable_delete_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|tag_entry
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tag_entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_toggle_desc (GimpTagEntry * tag_entry,gboolean show)
name|gimp_tag_entry_toggle_desc
parameter_list|(
name|GimpTagEntry
modifier|*
name|tag_entry
parameter_list|,
name|gboolean
name|show
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|widget
init|=
name|GTK_WIDGET
argument_list|(
name|tag_entry
argument_list|)
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|display_text
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|show
operator|^
name|tag_entry
operator|->
name|description_shown
operator|)
condition|)
return|return;
if|if
condition|(
name|tag_entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_QUERY
condition|)
block|{
name|display_text
operator|=
name|GIMP_TAG_ENTRY_QUERY_DESC
expr_stmt|;
block|}
else|else
block|{
name|display_text
operator|=
name|GIMP_TAG_ENTRY_ASSIGN_DESC
expr_stmt|;
block|}
if|if
condition|(
name|show
condition|)
block|{
name|gchar
modifier|*
name|current_text
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|current_text
operator|=
name|g_strdup
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|tag_entry
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|current_text
operator|=
name|g_strstrip
argument_list|(
name|current_text
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|current_text
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|current_text
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
return|return;
block|}
name|tag_entry
operator|->
name|description_shown
operator|=
name|TRUE
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|widget
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tag_entry
operator|->
name|description_shown
operator|=
name|FALSE
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|widget
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_expose (GtkWidget * widget,GdkEventExpose * event)
name|gimp_tag_entry_expose
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventExpose
modifier|*
name|event
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|tag_entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|widget
argument_list|)
decl_stmt|;
name|PangoLayout
modifier|*
name|layout
decl_stmt|;
name|PangoAttrList
modifier|*
name|attr_list
decl_stmt|;
name|PangoAttribute
modifier|*
name|attribute
decl_stmt|;
name|gint
name|layout_width
decl_stmt|;
name|gint
name|layout_height
decl_stmt|;
name|gint
name|window_width
decl_stmt|;
name|gint
name|window_height
decl_stmt|;
name|gint
name|offset
decl_stmt|;
specifier|const
name|char
modifier|*
name|display_text
decl_stmt|;
comment|/* eeeeeek */
if|if
condition|(
name|event
operator|->
name|window
operator|!=
name|gtk_entry_get_text_window
argument_list|(
name|GTK_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|GIMP_TAG_ENTRY
argument_list|(
name|widget
argument_list|)
operator|->
name|description_shown
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|tag_entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_QUERY
condition|)
block|{
name|display_text
operator|=
name|GIMP_TAG_ENTRY_QUERY_DESC
expr_stmt|;
block|}
else|else
block|{
name|display_text
operator|=
name|GIMP_TAG_ENTRY_ASSIGN_DESC
expr_stmt|;
block|}
name|layout
operator|=
name|gtk_widget_create_pango_layout
argument_list|(
name|widget
argument_list|,
name|display_text
argument_list|)
expr_stmt|;
name|attr_list
operator|=
name|pango_attr_list_new
argument_list|()
expr_stmt|;
name|attribute
operator|=
name|pango_attr_style_new
argument_list|(
name|PANGO_STYLE_ITALIC
argument_list|)
expr_stmt|;
name|pango_attr_list_insert
argument_list|(
name|attr_list
argument_list|,
name|attribute
argument_list|)
expr_stmt|;
name|pango_layout_set_attributes
argument_list|(
name|layout
argument_list|,
name|attr_list
argument_list|)
expr_stmt|;
name|pango_attr_list_unref
argument_list|(
name|attr_list
argument_list|)
expr_stmt|;
if|#
directive|if
name|GTK_CHECK_VERSION
argument_list|(
literal|2
operator|,
literal|24
operator|,
literal|0
argument_list|)
name|window_width
operator|=
name|gdk_window_get_width
argument_list|(
name|event
operator|->
name|window
argument_list|)
expr_stmt|;
name|window_height
operator|=
name|gdk_window_get_height
argument_list|(
name|event
operator|->
name|window
argument_list|)
expr_stmt|;
else|#
directive|else
name|gdk_drawable_get_size
argument_list|(
name|GDK_DRAWABLE
argument_list|(
name|event
operator|->
name|window
argument_list|)
argument_list|,
operator|&
name|window_width
argument_list|,
operator|&
name|window_height
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pango_layout_get_size
argument_list|(
name|layout
argument_list|,
operator|&
name|layout_width
argument_list|,
operator|&
name|layout_height
argument_list|)
expr_stmt|;
name|offset
operator|=
operator|(
name|window_height
operator|-
name|PANGO_PIXELS
argument_list|(
name|layout_height
argument_list|)
operator|)
operator|/
literal|2
expr_stmt|;
name|gtk_paint_layout
argument_list|(
name|gtk_widget_get_style
argument_list|(
name|widget
argument_list|)
argument_list|,
name|event
operator|->
name|window
argument_list|,
name|GTK_STATE_INSENSITIVE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|event
operator|->
name|area
argument_list|,
name|widget
argument_list|,
name|NULL
argument_list|,
operator|(
name|gtk_widget_get_direction
argument_list|(
name|widget
argument_list|)
operator|==
name|GTK_TEXT_DIR_RTL
operator|)
condition|?
name|window_width
operator|-
name|PANGO_PIXELS
argument_list|(
name|layout_width
argument_list|)
operator|-
name|offset
else|:
name|offset
argument_list|,
name|offset
argument_list|,
name|layout
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|layout
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_key_press (GtkWidget * widget,GdkEventKey * event)
name|gimp_tag_entry_key_press
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventKey
modifier|*
name|event
parameter_list|)
block|{
name|GimpTagEntry
modifier|*
name|entry
init|=
name|GIMP_TAG_ENTRY
argument_list|(
name|widget
argument_list|)
decl_stmt|;
name|guchar
name|c
decl_stmt|;
name|c
operator|=
name|gdk_keyval_to_unicode
argument_list|(
name|event
operator|->
name|keyval
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_tag_is_tag_separator
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|gimp_tag_entry_commit_source_func
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
switch|switch
condition|(
name|event
operator|->
name|keyval
condition|)
block|{
case|case
name|GDK_Tab
case|:
case|case
name|GDK_KP_Tab
case|:
case|case
name|GDK_ISO_Left_Tab
case|:
comment|/*  allow to leave the widget with Ctrl+Tab  */
if|if
condition|(
operator|!
operator|(
name|event
operator|->
name|state
operator|&
name|GDK_CONTROL_MASK
operator|)
condition|)
block|{
name|entry
operator|->
name|tab_completion_index
operator|++
expr_stmt|;
name|entry
operator|->
name|suppress_tag_query
operator|++
expr_stmt|;
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|gimp_tag_entry_auto_complete
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_tag_entry_commit_tags
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|g_signal_emit_by_name
argument_list|(
name|widget
argument_list|,
literal|"move-focus"
argument_list|,
operator|(
name|event
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
condition|?
name|GTK_DIR_TAB_BACKWARD
else|:
name|GTK_DIR_TAB_FORWARD
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
case|case
name|GDK_Return
case|:
name|gimp_tag_entry_commit_tags
argument_list|(
name|entry
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_Left
case|:
name|gimp_tag_entry_previous_tag
argument_list|(
name|entry
argument_list|,
operator|(
name|event
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
case|case
name|GDK_Right
case|:
name|gimp_tag_entry_next_tag
argument_list|(
name|entry
argument_list|,
operator|(
name|event
operator|->
name|state
operator|&
name|GDK_SHIFT_MASK
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
case|case
name|GDK_BackSpace
case|:
block|{
name|gint
name|selection_start
decl_stmt|;
name|gint
name|selection_end
decl_stmt|;
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|selection_start
argument_list|,
operator|&
name|selection_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_tag_entry_select_jellybean
argument_list|(
name|entry
argument_list|,
name|selection_start
argument_list|,
name|selection_end
argument_list|,
name|TAG_SEARCH_LEFT
argument_list|)
condition|)
block|{
return|return
name|TRUE
return|;
block|}
else|else
block|{
name|gimp_tag_entry_select_for_deletion
argument_list|(
name|entry
argument_list|,
name|TAG_SEARCH_LEFT
argument_list|)
expr_stmt|;
comment|/* FIXME: need to remove idle handler in dispose */
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|gimp_tag_entry_strip_extra_whitespace
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|GDK_Delete
case|:
block|{
name|gint
name|selection_start
decl_stmt|;
name|gint
name|selection_end
decl_stmt|;
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|selection_start
argument_list|,
operator|&
name|selection_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_tag_entry_select_jellybean
argument_list|(
name|entry
argument_list|,
name|selection_start
argument_list|,
name|selection_end
argument_list|,
name|TAG_SEARCH_RIGHT
argument_list|)
condition|)
block|{
return|return
name|TRUE
return|;
block|}
else|else
block|{
name|gimp_tag_entry_select_for_deletion
argument_list|(
name|entry
argument_list|,
name|TAG_SEARCH_RIGHT
argument_list|)
expr_stmt|;
comment|/* FIXME: need to remove idle handler in dispose */
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|gimp_tag_entry_strip_extra_whitespace
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|GDK_Up
case|:
case|case
name|GDK_Down
case|:
if|if
condition|(
name|entry
operator|->
name|recent_list
operator|!=
name|NULL
condition|)
block|{
name|gchar
modifier|*
name|recent_item
decl_stmt|;
name|gchar
modifier|*
name|very_recent_item
decl_stmt|;
name|very_recent_item
operator|=
name|g_strdup
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_tag_entry_add_to_recent
argument_list|(
name|entry
argument_list|,
name|very_recent_item
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|very_recent_item
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|->
name|keyval
operator|==
name|GDK_Up
condition|)
block|{
name|recent_item
operator|=
operator|(
name|gchar
operator|*
operator|)
name|g_list_first
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|)
operator|->
name|data
expr_stmt|;
name|entry
operator|->
name|recent_list
operator|=
name|g_list_remove
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
name|recent_item
argument_list|)
expr_stmt|;
name|entry
operator|->
name|recent_list
operator|=
name|g_list_append
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
name|recent_item
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|recent_item
operator|=
operator|(
name|gchar
operator|*
operator|)
name|g_list_last
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|)
operator|->
name|data
expr_stmt|;
name|entry
operator|->
name|recent_list
operator|=
name|g_list_remove
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
name|recent_item
argument_list|)
expr_stmt|;
name|entry
operator|->
name|recent_list
operator|=
name|g_list_prepend
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
name|recent_item
argument_list|)
expr_stmt|;
block|}
name|recent_item
operator|=
operator|(
name|gchar
operator|*
operator|)
name|g_list_first
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|)
operator|->
name|data
expr_stmt|;
name|entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|recent_item
argument_list|)
expr_stmt|;
name|gtk_editable_set_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
block|}
return|return
name|TRUE
return|;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_button_release (GtkWidget * widget,GdkEventButton * event)
name|gimp_tag_entry_button_release
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|)
block|{
if|if
condition|(
name|event
operator|->
name|button
operator|==
literal|1
condition|)
block|{
comment|/* FIXME: need to remove idle handler in dispose */
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|gimp_tag_entry_try_select_jellybean
argument_list|,
name|widget
argument_list|)
expr_stmt|;
block|}
return|return
name|GTK_WIDGET_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|button_release_event
argument_list|(
name|widget
argument_list|,
name|event
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_try_select_jellybean (GimpTagEntry * entry)
name|gimp_tag_entry_try_select_jellybean
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
block|{
name|gint
name|selection_start
decl_stmt|;
name|gint
name|selection_end
decl_stmt|;
name|gint
name|selection_pos
init|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
decl_stmt|;
name|gint
name|char_count
init|=
name|g_utf8_strlen
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|selection_pos
operator|==
name|char_count
condition|)
block|{
return|return
name|FALSE
return|;
block|}
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|selection_start
argument_list|,
operator|&
name|selection_end
argument_list|)
expr_stmt|;
name|gimp_tag_entry_select_jellybean
argument_list|(
name|entry
argument_list|,
name|selection_start
argument_list|,
name|selection_end
argument_list|,
name|TAG_SEARCH_NONE
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_select_jellybean (GimpTagEntry * entry,gint selection_start,gint selection_end,GimpTagSearchDir search_dir)
name|gimp_tag_entry_select_jellybean
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|gint
name|selection_start
parameter_list|,
name|gint
name|selection_end
parameter_list|,
name|GimpTagSearchDir
name|search_dir
parameter_list|)
block|{
name|gint
name|prev_selection_start
decl_stmt|;
name|gint
name|prev_selection_end
decl_stmt|;
if|if
condition|(
operator|!
name|entry
operator|->
name|mask
operator|->
name|len
condition|)
block|{
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|selection_start
operator|>=
name|entry
operator|->
name|mask
operator|->
name|len
condition|)
block|{
name|selection_start
operator|=
name|entry
operator|->
name|mask
operator|->
name|len
operator|-
literal|1
expr_stmt|;
name|selection_end
operator|=
name|selection_start
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'u'
condition|)
block|{
return|return
name|FALSE
return|;
block|}
switch|switch
condition|(
name|search_dir
condition|)
block|{
case|case
name|TAG_SEARCH_NONE
case|:
if|if
condition|(
name|selection_start
operator|>
literal|0
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'s'
condition|)
block|{
name|selection_start
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|selection_start
operator|>
literal|0
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
operator|-
literal|1
index|]
operator|==
literal|'w'
operator|)
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'t'
operator|)
condition|)
block|{
comment|/* between whitespace and tag,            * should allow to select tag.            */
name|selection_start
operator|--
expr_stmt|;
block|}
break|break;
case|case
name|TAG_SEARCH_LEFT
case|:
if|if
condition|(
name|selection_start
operator|==
name|selection_end
condition|)
block|{
if|if
condition|(
name|selection_start
operator|>
literal|0
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'t'
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
operator|-
literal|1
index|]
operator|==
literal|'w'
condition|)
block|{
name|selection_start
operator|--
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'w'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'s'
operator|)
operator|&&
name|selection_start
operator|>
literal|0
condition|)
block|{
while|while
condition|(
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'w'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'s'
operator|)
operator|&&
name|selection_start
operator|>
literal|0
condition|)
block|{
name|selection_start
operator|--
expr_stmt|;
block|}
name|selection_end
operator|=
name|selection_start
operator|+
literal|1
expr_stmt|;
block|}
block|}
break|break;
case|case
name|TAG_SEARCH_RIGHT
case|:
if|if
condition|(
name|selection_start
operator|==
name|selection_end
condition|)
block|{
if|if
condition|(
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'w'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'s'
operator|)
operator|&&
name|selection_start
operator|<
name|entry
operator|->
name|mask
operator|->
name|len
operator|-
literal|1
condition|)
block|{
while|while
condition|(
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'w'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'s'
operator|)
operator|&&
name|selection_start
operator|<
name|entry
operator|->
name|mask
operator|->
name|len
operator|-
literal|1
condition|)
block|{
name|selection_start
operator|++
expr_stmt|;
block|}
name|selection_end
operator|=
name|selection_start
operator|+
literal|1
expr_stmt|;
block|}
block|}
break|break;
block|}
if|if
condition|(
name|selection_start
operator|<
name|entry
operator|->
name|mask
operator|->
name|len
operator|&&
name|selection_start
operator|==
name|selection_end
condition|)
block|{
name|selection_end
operator|=
name|selection_start
operator|+
literal|1
expr_stmt|;
block|}
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|prev_selection_start
argument_list|,
operator|&
name|prev_selection_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'t'
condition|)
block|{
while|while
condition|(
name|selection_start
operator|>
literal|0
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
operator|-
literal|1
index|]
operator|==
literal|'t'
operator|)
condition|)
block|{
name|selection_start
operator|--
expr_stmt|;
block|}
block|}
if|if
condition|(
name|selection_end
operator|>
name|selection_start
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_end
operator|-
literal|1
index|]
operator|==
literal|'t'
operator|)
condition|)
block|{
while|while
condition|(
name|selection_end
operator|<=
name|entry
operator|->
name|mask
operator|->
name|len
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_end
index|]
operator|==
literal|'t'
operator|)
condition|)
block|{
name|selection_end
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|search_dir
operator|==
name|TAG_SEARCH_NONE
operator|&&
name|selection_end
operator|-
name|selection_start
operator|==
literal|1
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'w'
condition|)
block|{
name|gtk_editable_set_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|selection_end
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
if|if
condition|(
operator|(
name|selection_start
operator|!=
name|prev_selection_start
operator|||
name|selection_end
operator|!=
name|prev_selection_end
operator|)
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|selection_start
index|]
operator|==
literal|'t'
operator|)
operator|&&
name|selection_start
operator|<
name|selection_end
condition|)
block|{
if|if
condition|(
name|search_dir
operator|==
name|TAG_SEARCH_LEFT
condition|)
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|selection_end
argument_list|,
name|selection_start
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|selection_start
argument_list|,
name|selection_end
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
else|else
block|{
return|return
name|FALSE
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_add_to_recent (GimpTagEntry * entry,const gchar * tags_string,gboolean to_front)
name|gimp_tag_entry_add_to_recent
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
specifier|const
name|gchar
modifier|*
name|tags_string
parameter_list|,
name|gboolean
name|to_front
parameter_list|)
block|{
name|gchar
modifier|*
name|recent_item
init|=
name|NULL
decl_stmt|;
name|gchar
modifier|*
name|stripped_string
decl_stmt|;
name|gint
name|stripped_length
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
if|if
condition|(
name|entry
operator|->
name|mode
operator|==
name|GIMP_TAG_ENTRY_MODE_ASSIGN
condition|)
return|return
name|FALSE
return|;
name|stripped_string
operator|=
name|g_strdup
argument_list|(
name|tags_string
argument_list|)
expr_stmt|;
name|stripped_string
operator|=
name|g_strstrip
argument_list|(
name|stripped_string
argument_list|)
expr_stmt|;
name|stripped_length
operator|=
name|strlen
argument_list|(
name|stripped_string
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|stripped_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|stripped_length
operator|<=
literal|0
condition|)
block|{
comment|/* there is no content in the string,        * therefore don't add to recent list.        */
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|g_list_length
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|)
operator|>=
name|GIMP_TAG_ENTRY_MAX_RECENT_ITEMS
condition|)
block|{
name|gchar
modifier|*
name|last_item
init|=
operator|(
name|gchar
operator|*
operator|)
name|g_list_last
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|)
operator|->
name|data
decl_stmt|;
name|entry
operator|->
name|recent_list
operator|=
name|g_list_remove
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
name|last_item
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|last_item
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|list
operator|=
name|entry
operator|->
name|recent_list
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|tags_string
argument_list|,
name|list
operator|->
name|data
argument_list|)
condition|)
block|{
name|recent_item
operator|=
name|list
operator|->
name|data
expr_stmt|;
name|entry
operator|->
name|recent_list
operator|=
name|g_list_remove
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
name|recent_item
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|recent_item
condition|)
block|{
name|recent_item
operator|=
name|g_strdup
argument_list|(
name|tags_string
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|to_front
condition|)
block|{
name|entry
operator|->
name|recent_list
operator|=
name|g_list_prepend
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
name|recent_item
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|entry
operator|->
name|recent_list
operator|=
name|g_list_append
argument_list|(
name|entry
operator|->
name|recent_list
argument_list|,
name|recent_item
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * gimp_tag_entry_get_separator:  *  * Tag separator is a single Unicode terminal punctuation  * character.  *  * Return value: returns locale dependent tag separator.  **/
end_comment

begin_function
specifier|const
name|gchar
modifier|*
DECL|function|gimp_tag_entry_get_separator (void)
name|gimp_tag_entry_get_separator
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Seperator for tags    * IMPORTANT: use only one of Unicode terminal punctuation chars.    * http://unicode.org/review/pr-23.html    */
return|return
name|_
argument_list|(
literal|","
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_commit_region (GString * tags,GString * mask)
name|gimp_tag_entry_commit_region
parameter_list|(
name|GString
modifier|*
name|tags
parameter_list|,
name|GString
modifier|*
name|mask
parameter_list|)
block|{
name|gint
name|i
init|=
literal|0
decl_stmt|;
name|gint
name|j
decl_stmt|;
name|gint
name|stage
init|=
literal|0
decl_stmt|;
name|gunichar
name|c
decl_stmt|;
name|gchar
modifier|*
name|cursor
decl_stmt|;
name|GString
modifier|*
name|out_tags
decl_stmt|;
name|GString
modifier|*
name|out_mask
decl_stmt|;
name|GString
modifier|*
name|tag_buffer
decl_stmt|;
name|out_tags
operator|=
name|g_string_new
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|out_mask
operator|=
name|g_string_new
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|tag_buffer
operator|=
name|g_string_new
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|tags
operator|->
name|str
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|mask
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
name|g_utf8_get_char
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|g_utf8_next_char
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|stage
operator|==
literal|0
condition|)
block|{
comment|/* whitespace before tag */
if|if
condition|(
name|g_unichar_isspace
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|g_string_append_unichar
argument_list|(
name|out_tags
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|g_string_append_c
argument_list|(
name|out_mask
argument_list|,
literal|'w'
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stage
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|stage
operator|==
literal|1
condition|)
block|{
comment|/* tag */
if|if
condition|(
name|c
operator|&&
operator|!
name|gimp_tag_is_tag_separator
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|g_string_append_unichar
argument_list|(
name|tag_buffer
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gchar
modifier|*
name|valid_tag
init|=
name|gimp_tag_string_make_valid
argument_list|(
name|tag_buffer
operator|->
name|str
argument_list|)
decl_stmt|;
name|gsize
name|tag_length
decl_stmt|;
if|if
condition|(
name|valid_tag
condition|)
block|{
name|tag_length
operator|=
name|g_utf8_strlen
argument_list|(
name|valid_tag
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|out_tags
argument_list|,
name|valid_tag
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|tag_length
condition|;
name|j
operator|++
control|)
block|{
name|g_string_append_c
argument_list|(
name|out_mask
argument_list|,
literal|'t'
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|valid_tag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
block|{
name|g_string_append
argument_list|(
name|out_tags
argument_list|,
name|gimp_tag_entry_get_separator
argument_list|()
argument_list|)
expr_stmt|;
name|g_string_append_c
argument_list|(
name|out_mask
argument_list|,
literal|'s'
argument_list|)
expr_stmt|;
block|}
name|stage
operator|++
expr_stmt|;
block|}
else|else
block|{
name|stage
operator|=
literal|0
expr_stmt|;
block|}
name|g_string_set_size
argument_list|(
name|tag_buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|stage
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|gimp_tag_is_tag_separator
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|g_string_append_unichar
argument_list|(
name|out_tags
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|g_string_append_c
argument_list|(
name|out_mask
argument_list|,
literal|'s'
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|g_unichar_isspace
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|g_string_append_unichar
argument_list|(
name|out_tags
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|g_string_append_c
argument_list|(
name|out_mask
argument_list|,
literal|'w'
argument_list|)
expr_stmt|;
block|}
name|stage
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
name|g_string_assign
argument_list|(
name|tags
argument_list|,
name|out_tags
operator|->
name|str
argument_list|)
expr_stmt|;
name|g_string_assign
argument_list|(
name|mask
argument_list|,
name|out_mask
operator|->
name|str
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|tag_buffer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|out_tags
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|out_mask
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_commit_tags (GimpTagEntry * entry)
name|gimp_tag_entry_commit_tags
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
block|{
name|gint
name|region_start
decl_stmt|;
name|gint
name|region_end
decl_stmt|;
name|gint
name|position
decl_stmt|;
name|gboolean
name|found_region
decl_stmt|;
name|gint
name|cursor_position
decl_stmt|;
name|glong
name|length_before
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|cursor_position
operator|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
do|do
block|{
name|found_region
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|->
name|mask
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|i
index|]
operator|==
literal|'u'
condition|)
block|{
name|found_region
operator|=
name|TRUE
expr_stmt|;
name|region_start
operator|=
name|i
expr_stmt|;
name|region_end
operator|=
name|i
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|++
init|;
name|i
operator|<
name|entry
operator|->
name|mask
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|i
index|]
operator|==
literal|'u'
condition|)
block|{
name|region_end
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
block|}
break|break;
block|}
block|}
if|if
condition|(
name|found_region
condition|)
block|{
name|gchar
modifier|*
name|tags_string
decl_stmt|;
name|GString
modifier|*
name|tags
decl_stmt|;
name|GString
modifier|*
name|mask
decl_stmt|;
name|tags_string
operator|=
name|gtk_editable_get_chars
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|region_start
argument_list|,
name|region_end
argument_list|)
expr_stmt|;
name|tags
operator|=
name|g_string_new
argument_list|(
name|tags_string
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tags_string
argument_list|)
expr_stmt|;
name|length_before
operator|=
name|region_end
operator|-
name|region_start
expr_stmt|;
name|mask
operator|=
name|g_string_new_len
argument_list|(
name|entry
operator|->
name|mask
operator|->
name|str
operator|+
name|region_start
argument_list|,
name|region_end
operator|-
name|region_start
argument_list|)
expr_stmt|;
name|gimp_tag_entry_commit_region
argument_list|(
name|tags
argument_list|,
name|mask
argument_list|)
expr_stmt|;
comment|/* prepend space before if needed */
if|if
condition|(
name|region_start
operator|>
literal|0
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|region_start
operator|-
literal|1
index|]
operator|!=
literal|'w'
operator|&&
name|mask
operator|->
name|len
operator|>
literal|0
operator|&&
name|mask
operator|->
name|str
index|[
literal|0
index|]
operator|!=
literal|'w'
condition|)
block|{
name|g_string_prepend_c
argument_list|(
name|tags
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|g_string_prepend_c
argument_list|(
name|mask
argument_list|,
literal|'w'
argument_list|)
expr_stmt|;
block|}
comment|/* append space after if needed */
if|if
condition|(
name|region_end
operator|<=
name|entry
operator|->
name|mask
operator|->
name|len
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|region_end
index|]
operator|!=
literal|'w'
operator|&&
name|mask
operator|->
name|len
operator|>
literal|0
operator|&&
name|mask
operator|->
name|str
index|[
name|mask
operator|->
name|len
operator|-
literal|1
index|]
operator|!=
literal|'w'
condition|)
block|{
name|g_string_append_c
argument_list|(
name|tags
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|g_string_append_c
argument_list|(
name|mask
argument_list|,
literal|'w'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cursor_position
operator|>=
name|region_start
condition|)
block|{
name|cursor_position
operator|+=
name|g_utf8_strlen
argument_list|(
name|tags
operator|->
name|str
argument_list|,
name|tags
operator|->
name|len
argument_list|)
operator|-
name|length_before
expr_stmt|;
block|}
name|entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|entry
operator|->
name|suppress_mask_update
operator|++
expr_stmt|;
name|entry
operator|->
name|suppress_tag_query
operator|++
expr_stmt|;
name|gtk_editable_delete_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|region_start
argument_list|,
name|region_end
argument_list|)
expr_stmt|;
name|position
operator|=
name|region_start
expr_stmt|;
name|gtk_editable_insert_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|tags
operator|->
name|str
argument_list|,
name|tags
operator|->
name|len
argument_list|,
operator|&
name|position
argument_list|)
expr_stmt|;
name|entry
operator|->
name|suppress_tag_query
operator|--
expr_stmt|;
name|entry
operator|->
name|suppress_mask_update
operator|--
expr_stmt|;
name|entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
name|g_string_erase
argument_list|(
name|entry
operator|->
name|mask
argument_list|,
name|region_start
argument_list|,
name|region_end
operator|-
name|region_start
argument_list|)
expr_stmt|;
name|g_string_insert_len
argument_list|(
name|entry
operator|->
name|mask
argument_list|,
name|region_start
argument_list|,
name|mask
operator|->
name|str
argument_list|,
name|mask
operator|->
name|len
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|mask
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|tags
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|found_region
condition|)
do|;
name|gtk_editable_set_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|cursor_position
argument_list|)
expr_stmt|;
name|gimp_tag_entry_strip_extra_whitespace
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_commit_source_func (GimpTagEntry * entry)
name|gimp_tag_entry_commit_source_func
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
block|{
name|gimp_tag_entry_commit_tags
argument_list|(
name|entry
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_next_tag (GimpTagEntry * entry,gboolean select)
name|gimp_tag_entry_next_tag
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|gboolean
name|select
parameter_list|)
block|{
name|gint
name|position
init|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
index|]
operator|!=
literal|'u'
condition|)
block|{
while|while
condition|(
name|position
operator|<
name|entry
operator|->
name|mask
operator|->
name|len
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
index|]
operator|!=
literal|'w'
operator|)
condition|)
block|{
name|position
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
index|]
operator|==
literal|'w'
condition|)
block|{
name|position
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|position
operator|<
name|entry
operator|->
name|mask
operator|->
name|len
condition|)
block|{
name|position
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|select
condition|)
block|{
name|gint
name|current_position
decl_stmt|;
name|gint
name|selection_start
decl_stmt|;
name|gint
name|selection_end
decl_stmt|;
name|current_position
operator|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|selection_start
argument_list|,
operator|&
name|selection_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_position
operator|==
name|selection_end
condition|)
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|selection_start
argument_list|,
name|position
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|current_position
operator|==
name|selection_start
condition|)
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|selection_end
argument_list|,
name|position
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|gtk_editable_set_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|position
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_previous_tag (GimpTagEntry * entry,gboolean select)
name|gimp_tag_entry_previous_tag
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|gboolean
name|select
parameter_list|)
block|{
name|gint
name|position
init|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|position
operator|>=
literal|1
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
operator|-
literal|1
index|]
operator|==
literal|'w'
condition|)
block|{
name|position
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|position
operator|<
literal|1
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
operator|-
literal|1
index|]
operator|!=
literal|'u'
condition|)
block|{
while|while
condition|(
name|position
operator|>
literal|0
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
operator|-
literal|1
index|]
operator|!=
literal|'w'
operator|)
condition|)
block|{
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
operator|-
literal|1
index|]
operator|==
literal|'u'
condition|)
block|{
break|break;
block|}
name|position
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
name|position
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|select
condition|)
block|{
name|gint
name|current_position
decl_stmt|;
name|gint
name|selection_start
decl_stmt|;
name|gint
name|selection_end
decl_stmt|;
name|current_position
operator|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|selection_start
argument_list|,
operator|&
name|selection_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_position
operator|==
name|selection_start
condition|)
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|selection_end
argument_list|,
name|position
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|current_position
operator|==
name|selection_end
condition|)
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|selection_start
argument_list|,
name|position
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|gtk_editable_set_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|position
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_tag_entry_select_for_deletion (GimpTagEntry * entry,GimpTagSearchDir search_dir)
name|gimp_tag_entry_select_for_deletion
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|,
name|GimpTagSearchDir
name|search_dir
parameter_list|)
block|{
name|gint
name|start_pos
decl_stmt|;
name|gint
name|end_pos
decl_stmt|;
comment|/* make sure the whole tag is selected,    * including a  separator    */
name|gtk_editable_get_selection_bounds
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|start_pos
argument_list|,
operator|&
name|end_pos
argument_list|)
expr_stmt|;
while|while
condition|(
name|start_pos
operator|>
literal|0
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|start_pos
operator|-
literal|1
index|]
operator|==
literal|'t'
operator|)
condition|)
block|{
name|start_pos
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|end_pos
operator|>
name|start_pos
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
operator|-
literal|1
index|]
operator|==
literal|'t'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
operator|-
literal|1
index|]
operator|==
literal|'s'
operator|)
condition|)
block|{
while|while
condition|(
name|end_pos
operator|<=
name|entry
operator|->
name|mask
operator|->
name|len
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
index|]
operator|==
literal|'s'
operator|)
condition|)
block|{
name|end_pos
operator|++
expr_stmt|;
block|}
block|}
comment|/* ensure there is no unnecessary whitespace selected */
while|while
condition|(
name|start_pos
operator|<
name|end_pos
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|start_pos
index|]
operator|==
literal|'w'
condition|)
block|{
name|start_pos
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|start_pos
operator|<
name|end_pos
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
operator|-
literal|1
index|]
operator|==
literal|'w'
condition|)
block|{
name|end_pos
operator|--
expr_stmt|;
block|}
comment|/* delete spaces in one side */
if|if
condition|(
name|search_dir
operator|==
name|TAG_SEARCH_LEFT
condition|)
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|end_pos
argument_list|,
name|start_pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|end_pos
operator|>
name|start_pos
operator|&&
name|search_dir
operator|==
name|TAG_SEARCH_RIGHT
operator|&&
operator|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
operator|-
literal|1
index|]
operator|==
literal|'t'
operator|||
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|end_pos
operator|-
literal|1
index|]
operator|==
literal|'s'
operator|)
condition|)
block|{
name|gtk_editable_select_region
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|start_pos
argument_list|,
name|end_pos
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_tag_entry_strip_extra_whitespace (GimpTagEntry * entry)
name|gimp_tag_entry_strip_extra_whitespace
parameter_list|(
name|GimpTagEntry
modifier|*
name|entry
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|gint
name|position
decl_stmt|;
name|position
operator|=
name|gtk_editable_get_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|->
name|internal_operation
operator|++
expr_stmt|;
name|entry
operator|->
name|suppress_tag_query
operator|++
expr_stmt|;
comment|/* strip whitespace in front */
while|while
condition|(
name|entry
operator|->
name|mask
operator|->
name|len
operator|>
literal|0
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
literal|0
index|]
operator|==
literal|'w'
condition|)
block|{
name|gtk_editable_delete_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* strip whitespace in back */
while|while
condition|(
name|entry
operator|->
name|mask
operator|->
name|len
operator|>
literal|1
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|entry
operator|->
name|mask
operator|->
name|len
operator|-
literal|1
index|]
operator|==
literal|'w'
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|entry
operator|->
name|mask
operator|->
name|len
operator|-
literal|2
index|]
operator|==
literal|'w'
condition|)
block|{
name|gtk_editable_delete_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|entry
operator|->
name|mask
operator|->
name|len
operator|-
literal|1
argument_list|,
name|entry
operator|->
name|mask
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|position
operator|==
name|entry
operator|->
name|mask
operator|->
name|len
condition|)
block|{
name|position
operator|--
expr_stmt|;
block|}
block|}
comment|/* strip extra whitespace in the middle */
for|for
control|(
name|i
operator|=
name|entry
operator|->
name|mask
operator|->
name|len
operator|-
literal|1
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|i
index|]
operator|==
literal|'w'
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|i
operator|-
literal|1
index|]
operator|==
literal|'w'
condition|)
block|{
name|gtk_editable_delete_text
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|position
operator|>=
name|i
condition|)
block|{
name|position
operator|--
expr_stmt|;
block|}
block|}
block|}
comment|/* special case when cursor is in the last position:    * it must be positioned after the last whitespace.    */
if|if
condition|(
name|position
operator|==
name|entry
operator|->
name|mask
operator|->
name|len
operator|-
literal|1
operator|&&
name|entry
operator|->
name|mask
operator|->
name|str
index|[
name|position
index|]
operator|==
literal|'w'
condition|)
block|{
name|position
operator|++
expr_stmt|;
block|}
name|gtk_editable_set_position
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|entry
argument_list|)
argument_list|,
name|position
argument_list|)
expr_stmt|;
name|entry
operator|->
name|suppress_tag_query
operator|--
expr_stmt|;
name|entry
operator|->
name|internal_operation
operator|--
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

end_unit

