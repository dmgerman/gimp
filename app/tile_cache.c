begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<glib.h>
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"tile_cache.h"
end_include

begin_include
include|#
directive|include
file|"tile_swap.h"
end_include

begin_comment
comment|/*  This is the percentage of the maximum cache size that should be cleared  *   from the cache when an eviction is necessary  */
end_comment

begin_define
DECL|macro|FREE_QUANTUM
define|#
directive|define
name|FREE_QUANTUM
value|0.1
end_define

begin_function_decl
specifier|static
name|void
name|tile_cache_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tile_cache_zorch_next
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|guint
name|tile_cache_hash
parameter_list|(
name|Tile
modifier|*
name|tile
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|initialize
specifier|static
name|int
name|initialize
init|=
name|TRUE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tile_hash_table
specifier|static
name|GHashTable
modifier|*
name|tile_hash_table
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tile_list_head
specifier|static
name|GList
modifier|*
name|tile_list_head
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tile_list_tail
specifier|static
name|GList
modifier|*
name|tile_list_tail
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|max_tile_size
specifier|static
name|unsigned
name|long
name|max_tile_size
init|=
name|TILE_WIDTH
operator|*
name|TILE_HEIGHT
operator|*
literal|4
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|cur_cache_size
specifier|static
name|unsigned
name|long
name|cur_cache_size
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|max_cache_size
specifier|static
name|unsigned
name|long
name|max_cache_size
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|tile_cache_insert (Tile * tile)
name|tile_cache_insert
parameter_list|(
name|Tile
modifier|*
name|tile
parameter_list|)
block|{
name|GList
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
name|initialize
condition|)
name|tile_cache_init
argument_list|()
expr_stmt|;
comment|/* First check and see if the tile is already    *  in the cache. In that case we will simply place    *  it at the end of the tile list to indicate that    *  it was the most recently accessed tile.    */
name|tmp
operator|=
name|g_hash_table_lookup
argument_list|(
name|tile_hash_table
argument_list|,
name|tile
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
block|{
comment|/* The tile was already in the cache. Place it at        *  the end of the tile list.        */
if|if
condition|(
name|tmp
operator|==
name|tile_list_tail
condition|)
name|tile_list_tail
operator|=
name|tile_list_tail
operator|->
name|prev
expr_stmt|;
name|tile_list_head
operator|=
name|g_list_remove_link
argument_list|(
name|tile_list_head
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tile_list_head
condition|)
name|tile_list_tail
operator|=
name|NULL
expr_stmt|;
name|g_list_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
comment|/* Remove the old reference to the tiles list node        *  in the tile hash table.        */
name|g_hash_table_remove
argument_list|(
name|tile_hash_table
argument_list|,
name|tile
argument_list|)
expr_stmt|;
name|tile_list_tail
operator|=
name|g_list_append
argument_list|(
name|tile_list_tail
argument_list|,
name|tile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tile_list_head
condition|)
name|tile_list_head
operator|=
name|tile_list_tail
expr_stmt|;
name|tile_list_tail
operator|=
name|g_list_last
argument_list|(
name|tile_list_tail
argument_list|)
expr_stmt|;
comment|/* Add the tiles list node to the tile hash table. The        *  list node is indexed by the tile itself. This makes        *  for a quick lookup of which list node the tile is in.        */
name|g_hash_table_insert
argument_list|(
name|tile_hash_table
argument_list|,
name|tile
argument_list|,
name|tile_list_tail
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The tile was not in the cache. First check and see        *  if there is room in the cache. If not then we'll have        *  to make room first. Note: it might be the case that the        *  cache is smaller than the size of a tile in which case        *  it won't be possible to put it in the cache.        */
if|if
condition|(
operator|(
name|cur_cache_size
operator|+
name|max_tile_size
operator|)
operator|>
name|max_cache_size
condition|)
block|{
while|while
condition|(
name|tile_list_head
operator|&&
operator|(
name|cur_cache_size
operator|+
name|max_cache_size
operator|*
name|FREE_QUANTUM
operator|)
operator|>
name|max_cache_size
condition|)
name|tile_cache_zorch_next
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|cur_cache_size
operator|+
name|max_tile_size
operator|)
operator|>
name|max_cache_size
condition|)
return|return;
block|}
comment|/* Place the tile at the end of the tile list.        */
name|tile_list_tail
operator|=
name|g_list_append
argument_list|(
name|tile_list_tail
argument_list|,
name|tile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tile_list_head
condition|)
name|tile_list_head
operator|=
name|tile_list_tail
expr_stmt|;
name|tile_list_tail
operator|=
name|g_list_last
argument_list|(
name|tile_list_tail
argument_list|)
expr_stmt|;
comment|/* Add the tiles list node to the tile hash table.        */
name|g_hash_table_insert
argument_list|(
name|tile_hash_table
argument_list|,
name|tile
argument_list|,
name|tile_list_tail
argument_list|)
expr_stmt|;
comment|/* Note the increase in the number of bytes the cache        *  is referencing.        */
name|cur_cache_size
operator|+=
name|tile_size
argument_list|(
name|tile
argument_list|)
expr_stmt|;
comment|/* Reference the tile so that it won't be swapped out        *  to disk. Swap the tile in if necessary.        * "tile_ref" cannot be used here since it calls this        *  function.        */
name|tile
operator|->
name|ref_count
operator|+=
literal|1
expr_stmt|;
block|{
specifier|extern
name|int
name|tile_ref_count
decl_stmt|;
name|tile_ref_count
operator|+=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|tile
operator|->
name|ref_count
operator|==
literal|1
condition|)
block|{
name|tile_swap_in
argument_list|(
name|tile
argument_list|)
expr_stmt|;
comment|/*  the tile must be clean  */
name|tile
operator|->
name|dirty
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
DECL|function|tile_cache_flush (Tile * tile)
name|tile_cache_flush
parameter_list|(
name|Tile
modifier|*
name|tile
parameter_list|)
block|{
name|GList
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
name|initialize
condition|)
name|tile_cache_init
argument_list|()
expr_stmt|;
comment|/* Find where the tile is in the cache.    */
name|tmp
operator|=
name|g_hash_table_lookup
argument_list|(
name|tile_hash_table
argument_list|,
name|tile
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
block|{
comment|/* If the tile is in the cache, then remove it from the        *  tile list.        */
if|if
condition|(
name|tmp
operator|==
name|tile_list_tail
condition|)
name|tile_list_tail
operator|=
name|tile_list_tail
operator|->
name|prev
expr_stmt|;
name|tile_list_head
operator|=
name|g_list_remove_link
argument_list|(
name|tile_list_head
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tile_list_head
condition|)
name|tile_list_tail
operator|=
name|NULL
expr_stmt|;
name|g_list_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
comment|/* Remove the tile from the tile hash table.        */
name|g_hash_table_remove
argument_list|(
name|tile_hash_table
argument_list|,
name|tile
argument_list|)
expr_stmt|;
comment|/* Note the decrease in the number of bytes the cache        *  is referencing.        */
name|cur_cache_size
operator|-=
name|tile_size
argument_list|(
name|tile
argument_list|)
expr_stmt|;
comment|/* Unreference the tile.        * "tile_unref" may be used here since it does not call        *  this function (or any of the cache functions).        */
name|tile_unref
argument_list|(
name|tile
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|tile_cache_set_size (unsigned long cache_size)
name|tile_cache_set_size
parameter_list|(
name|unsigned
name|long
name|cache_size
parameter_list|)
block|{
if|if
condition|(
name|initialize
condition|)
name|tile_cache_init
argument_list|()
expr_stmt|;
name|max_cache_size
operator|=
name|cache_size
expr_stmt|;
if|if
condition|(
name|max_cache_size
operator|>=
name|max_tile_size
condition|)
block|{
while|while
condition|(
name|cur_cache_size
operator|>
name|max_cache_size
condition|)
name|tile_cache_zorch_next
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|tile_cache_init ()
name|tile_cache_init
parameter_list|()
block|{
if|if
condition|(
name|initialize
condition|)
block|{
name|initialize
operator|=
name|FALSE
expr_stmt|;
name|tile_hash_table
operator|=
name|g_hash_table_new
argument_list|(
operator|(
name|GHashFunc
operator|)
name|tile_cache_hash
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|max_cache_size
operator|=
name|tile_cache_size
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|tile_cache_zorch_next ()
name|tile_cache_zorch_next
parameter_list|()
block|{
if|if
condition|(
name|tile_list_head
condition|)
name|tile_cache_flush
argument_list|(
operator|(
name|Tile
operator|*
operator|)
name|tile_list_head
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|guint
DECL|function|tile_cache_hash (Tile * tile)
name|tile_cache_hash
parameter_list|(
name|Tile
modifier|*
name|tile
parameter_list|)
block|{
return|return
operator|(
name|gulong
operator|)
name|tile
return|;
block|}
end_function

end_unit

