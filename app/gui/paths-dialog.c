begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1999 Andy Thomas alt@picnic.demon.co.uk  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  * Some of this code is based on the layers_dialog box code.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<gdk/gdkkeysyms.h>
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"core/core-types.h"
end_include

begin_include
include|#
directive|include
file|"tools/tools-types.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpcontext.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpdrawable.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage.h"
end_include

begin_include
include|#
directive|include
file|"tools/gimpbezierselecttool.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"menus.h"
end_include

begin_include
include|#
directive|include
file|"ops_buttons.h"
end_include

begin_include
include|#
directive|include
file|"paths-dialog.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"image_render.h"
end_include

begin_include
include|#
directive|include
file|"path.h"
end_include

begin_include
include|#
directive|include
file|"pathP.h"
end_include

begin_include
include|#
directive|include
file|"path_transform.h"
end_include

begin_include
include|#
directive|include
file|"plug_in.h"
end_include

begin_include
include|#
directive|include
file|"undo.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_include
include|#
directive|include
file|"pixmaps/new.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/duplicate.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/delete.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/pennorm.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/penadd.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/pendel.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/penedit.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/penstroke.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/toselection.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/topath.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/path.xbm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/locked.xbm"
end_include

begin_typedef
DECL|typedef|PathsDialog
typedef|typedef
name|struct
name|_PathsDialog
name|PathsDialog
typedef|;
end_typedef

begin_struct
DECL|struct|_PathsDialog
struct|struct
name|_PathsDialog
block|{
DECL|member|vbox
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
DECL|member|paths_list
name|GtkWidget
modifier|*
name|paths_list
decl_stmt|;
DECL|member|ops_menu
name|GtkWidget
modifier|*
name|ops_menu
decl_stmt|;
DECL|member|accel_group
name|GtkAccelGroup
modifier|*
name|accel_group
decl_stmt|;
DECL|member|ratio
name|gdouble
name|ratio
decl_stmt|;
DECL|member|image_width
DECL|member|image_height
name|gint
name|image_width
decl_stmt|,
name|image_height
decl_stmt|;
DECL|member|gimage_width
DECL|member|gimage_height
name|gint
name|gimage_width
decl_stmt|,
name|gimage_height
decl_stmt|;
comment|/* pixmaps for the no preview bitmap */
DECL|member|pixmap_normal
name|GdkPixmap
modifier|*
name|pixmap_normal
decl_stmt|;
DECL|member|pixmap_selected
name|GdkPixmap
modifier|*
name|pixmap_selected
decl_stmt|;
DECL|member|pixmap_locked_normal
name|GdkPixmap
modifier|*
name|pixmap_locked_normal
decl_stmt|;
DECL|member|pixmap_locked_selected
name|GdkPixmap
modifier|*
name|pixmap_locked_selected
decl_stmt|;
comment|/*  state information  */
DECL|member|selsigid
name|gint
name|selsigid
decl_stmt|;
DECL|member|gimage
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
DECL|member|gc
name|GdkGC
modifier|*
name|gc
decl_stmt|;
DECL|member|black
name|GdkColor
name|black
decl_stmt|;
DECL|member|white
name|GdkColor
name|white
decl_stmt|;
DECL|member|selected_row_num
name|gint
name|selected_row_num
decl_stmt|;
DECL|member|been_selected
name|gboolean
name|been_selected
decl_stmt|;
DECL|member|current_path_list
name|PathList
modifier|*
name|current_path_list
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
DECL|typedef|PathWidget
typedef|typedef
name|struct
name|_PathWidget
name|PathWidget
typedef|;
end_typedef

begin_struct
DECL|struct|_PathWidget
struct|struct
name|_PathWidget
block|{
DECL|member|paths_pixmap
name|GdkPixmap
modifier|*
name|paths_pixmap
decl_stmt|;
DECL|member|bzp
name|Path
modifier|*
name|bzp
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
DECL|typedef|PathCounts
typedef|typedef
name|struct
name|_PathCounts
name|PathCounts
typedef|;
end_typedef

begin_struct
DECL|struct|_PathCounts
struct|struct
name|_PathCounts
block|{
DECL|member|c_count
name|CountCurves
name|c_count
decl_stmt|;
comment|/* Must be the first element */
DECL|member|total_count
name|gint
name|total_count
decl_stmt|;
comment|/* Total number of curves    */
block|}
struct|;
end_struct

begin_decl_stmt
DECL|variable|paths_dialog
specifier|static
name|PathsDialog
modifier|*
name|paths_dialog
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|copy_pp
specifier|static
name|Path
modifier|*
name|copy_pp
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|paths_dialog_realized
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_select_row
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|row
parameter_list|,
name|gint
name|column
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_unselect_row
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|row
parameter_list|,
name|gint
name|column
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|paths_list_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_update_paths
parameter_list|(
name|gpointer
name|data
parameter_list|,
name|gint
name|row
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_update_preview
parameter_list|(
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_preview_extents
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_new_point_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_add_point_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_delete_point_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_edit_point_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paths_dialog_advanced_to_path_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|path_close
parameter_list|(
name|Path
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  the ops buttons  */
end_comment

begin_decl_stmt
DECL|variable|to_path_ext_callbacks
specifier|static
name|GtkSignalFunc
name|to_path_ext_callbacks
index|[]
init|=
block|{
name|G_CALLBACK
argument_list|(
name|paths_dialog_advanced_to_path_callback
argument_list|)
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|paths_ops_buttons
specifier|static
name|OpsButton
name|paths_ops_buttons
index|[]
init|=
block|{
block|{
name|new_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_new_path_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"New Path"
argument_list|)
block|,
literal|"paths/new_path.html"
block|,
name|NULL
block|}
block|,
block|{
name|duplicate_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_dup_path_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Duplicate Path"
argument_list|)
block|,
literal|"paths/duplicate_path.html"
block|,
name|NULL
block|}
block|,
block|{
name|toselection_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_path_to_sel_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Path to Selection"
argument_list|)
block|,
literal|"paths/path_to_selection.html"
block|,
name|NULL
block|}
block|,
block|{
name|topath_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_sel_to_path_callback
argument_list|)
block|,
name|to_path_ext_callbacks
block|,
name|N_
argument_list|(
literal|"Selection to Path"
argument_list|)
block|,
literal|"filters/sel2path.html"
block|,
name|NULL
block|}
block|,
block|{
name|penstroke_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_stroke_path_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Stroke Path"
argument_list|)
block|,
literal|"paths/stroke_path.html"
block|,
name|NULL
block|}
block|,
block|{
name|delete_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_delete_path_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Delete Path"
argument_list|)
block|,
literal|"paths/delete_path.html"
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|point_ops_buttons
specifier|static
name|OpsButton
name|point_ops_buttons
index|[]
init|=
block|{
block|{
name|pennorm_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_new_point_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"New Point"
argument_list|)
block|,
literal|"#new_point_button"
block|,
name|NULL
block|}
block|,
block|{
name|penadd_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_add_point_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Add Point"
argument_list|)
block|,
literal|"#add_point_button"
block|,
name|NULL
block|}
block|,
block|{
name|pendel_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_delete_point_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Delete Point"
argument_list|)
block|,
literal|"#delete_point_button"
block|,
name|NULL
block|}
block|,
block|{
name|penedit_xpm
block|,
name|G_CALLBACK
argument_list|(
name|paths_dialog_edit_point_callback
argument_list|)
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Edit Point"
argument_list|)
block|,
literal|"#edit_point_button"
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|paths_dialog_set_menu_sensitivity (void)
name|paths_dialog_set_menu_sensitivity
parameter_list|(
name|void
parameter_list|)
block|{
name|gboolean
name|gimage
init|=
name|FALSE
decl_stmt|;
comment|/*  is there a gimage  */
name|gboolean
name|pp
init|=
name|FALSE
decl_stmt|;
comment|/*  paths present  */
name|gboolean
name|cpp
init|=
name|FALSE
decl_stmt|;
comment|/*  is there a path in the pate buffer  */
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
if|if
condition|(
name|paths_dialog
operator|->
name|gimage
condition|)
name|gimage
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|gimage
operator|&&
name|gimp_image_get_paths
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|)
condition|)
name|pp
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|copy_pp
condition|)
name|cpp
operator|=
name|TRUE
expr_stmt|;
DECL|macro|SET_SENSITIVE (menu,condition)
define|#
directive|define
name|SET_SENSITIVE
parameter_list|(
name|menu
parameter_list|,
name|condition
parameter_list|)
define|\
value|menus_set_sensitive ("<Paths>/" menu, (condition) != 0)
DECL|macro|SET_OPS_SENSITIVE (button,condition)
define|#
directive|define
name|SET_OPS_SENSITIVE
parameter_list|(
name|button
parameter_list|,
name|condition
parameter_list|)
define|\
value|gtk_widget_set_sensitive (paths_ops_buttons[(button)].widget, \                                  (condition) != 0)
DECL|macro|SET_POINT_SENSITIVE (button,condition)
define|#
directive|define
name|SET_POINT_SENSITIVE
parameter_list|(
name|button
parameter_list|,
name|condition
parameter_list|)
define|\
value|gtk_widget_set_sensitive (point_ops_buttons[(button)].widget, \                                  (condition) != 0)
name|SET_SENSITIVE
argument_list|(
literal|"New Path"
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|0
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Duplicate Path"
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|1
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Path to Selection"
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|2
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Selection to Path"
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|3
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Stroke Path"
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|4
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Delete Path"
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|5
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Copy Path"
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Paste Path"
argument_list|,
name|pp
operator|&&
name|cpp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Import Path..."
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Export Path..."
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit Path Attributes..."
argument_list|,
name|pp
argument_list|)
expr_stmt|;
comment|/*  new point  */
name|SET_POINT_SENSITIVE
argument_list|(
literal|0
argument_list|,
name|pp
argument_list|)
expr_stmt|;
comment|/*  add point  */
name|SET_POINT_SENSITIVE
argument_list|(
literal|1
argument_list|,
name|pp
argument_list|)
expr_stmt|;
comment|/*  selete point  */
name|SET_POINT_SENSITIVE
argument_list|(
literal|2
argument_list|,
name|pp
argument_list|)
expr_stmt|;
comment|/*  edit point  */
name|SET_POINT_SENSITIVE
argument_list|(
literal|3
argument_list|,
name|pp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SET_POINT_SENSITIVE
undef|#
directive|undef
name|SET_OPS_SENSITIVE
undef|#
directive|undef
name|SET_SENSITIVE
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_set_default_op (void)
name|paths_dialog_set_default_op
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|paths_dialog
operator|!=
name|NULL
condition|)
comment|/* Bug #5049: Clients may call this because it is possible */
comment|/* to create a path before the L&C dialog exists.          */
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|point_ops_buttons
index|[
literal|0
index|]
operator|.
name|widget
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GtkWidget
modifier|*
DECL|function|paths_dialog_create (void)
name|paths_dialog_create
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkItemFactory
modifier|*
name|paths_factory
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|paths_list
decl_stmt|;
name|GtkWidget
modifier|*
name|scrolled_win
decl_stmt|;
name|GtkWidget
modifier|*
name|button_box
decl_stmt|;
if|if
condition|(
name|paths_dialog
condition|)
return|return
name|paths_dialog
operator|->
name|vbox
return|;
name|paths_dialog
operator|=
name|g_new0
argument_list|(
name|PathsDialog
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/*  The paths box  */
name|paths_dialog
operator|->
name|vbox
operator|=
name|gtk_event_box_new
argument_list|()
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|,
name|NULL
argument_list|,
literal|"dialogs/paths/paths.html"
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
comment|/* The point operations */
name|button_box
operator|=
name|ops_button_box_new
argument_list|(
name|point_ops_buttons
argument_list|,
name|OPS_BUTTON_RADIO
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button_box
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button_box
argument_list|)
expr_stmt|;
name|scrolled_win
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_win
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_ALWAYS
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|scrolled_win
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|paths_list
operator|=
name|paths_list
operator|=
name|gtk_clist_new
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|gtk_widget_destroyed
argument_list|)
argument_list|,
operator|&
name|paths_dialog
argument_list|)
expr_stmt|;
name|gtk_clist_set_selection_mode
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_list
argument_list|)
argument_list|,
name|GTK_SELECTION_BROWSE
argument_list|)
expr_stmt|;
name|gtk_clist_set_reorderable
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_list
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_clist_set_column_width
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|0
argument_list|,
name|locked_width
argument_list|)
expr_stmt|;
name|gtk_clist_set_column_auto_resize
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|scrolled_win
argument_list|)
argument_list|,
name|paths_list
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|paths_list_events
argument_list|,
name|paths_dialog
argument_list|)
expr_stmt|;
name|gtk_container_set_focus_vadjustment
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|paths_list
argument_list|)
argument_list|,
name|gtk_scrolled_window_get_vadjustment
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_win
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_win
argument_list|)
operator|->
name|vscrollbar
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|selsigid
operator|=
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|"select_row"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|paths_select_row
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_list
argument_list|)
argument_list|,
literal|"unselect_row"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|paths_unselect_row
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|scrolled_win
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|paths_list
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
argument_list|,
literal|"realize"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|paths_dialog_realized
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
expr_stmt|;
comment|/*  The ops buttons  */
name|button_box
operator|=
name|ops_button_box_new
argument_list|(
name|paths_ops_buttons
argument_list|,
name|OPS_BUTTON_NORMAL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button_box
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button_box
argument_list|)
expr_stmt|;
name|paths_factory
operator|=
name|menus_get_paths_factory
argument_list|()
expr_stmt|;
name|paths_dialog
operator|->
name|ops_menu
operator|=
name|paths_factory
operator|->
name|widget
expr_stmt|;
name|paths_dialog
operator|->
name|accel_group
operator|=
name|paths_factory
operator|->
name|accel_group
expr_stmt|;
empty_stmt|;
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
name|paths_dialog_set_default_op
argument_list|()
expr_stmt|;
return|return
name|paths_dialog
operator|->
name|vbox
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_realized (GtkWidget * widget)
name|paths_dialog_realized
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
block|{
name|GdkColormap
modifier|*
name|colormap
decl_stmt|;
name|gchar
name|dash_list
index|[
literal|2
index|]
init|=
block|{
literal|3
block|,
literal|3
block|}
decl_stmt|;
comment|/* Help out small displays */
if|if
condition|(
name|gimprc
operator|.
name|preview_size
operator|<
literal|64
condition|)
name|dash_list
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|paths_dialog
operator|->
name|gc
operator|=
name|gdk_gc_new
argument_list|(
name|widget
operator|->
name|window
argument_list|)
expr_stmt|;
name|gdk_gc_set_dashes
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
literal|2
argument_list|,
name|dash_list
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|colormap
operator|=
name|gtk_widget_get_colormap
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
expr_stmt|;
name|gdk_color_parse
argument_list|(
literal|"black"
argument_list|,
operator|&
name|paths_dialog
operator|->
name|black
argument_list|)
expr_stmt|;
name|gdk_color_alloc
argument_list|(
name|colormap
argument_list|,
operator|&
name|paths_dialog
operator|->
name|black
argument_list|)
expr_stmt|;
name|gdk_color_parse
argument_list|(
literal|"white"
argument_list|,
operator|&
name|paths_dialog
operator|->
name|white
argument_list|)
expr_stmt|;
name|gdk_color_alloc
argument_list|(
name|colormap
argument_list|,
operator|&
name|paths_dialog
operator|->
name|white
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Clears out row when list element is deleted/destroyed */
end_comment

begin_function
specifier|static
name|void
DECL|function|clear_pathwidget (gpointer data)
name|clear_pathwidget
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|PathWidget
modifier|*
name|pwidget
init|=
name|data
decl_stmt|;
if|if
condition|(
name|pwidget
condition|)
block|{
if|if
condition|(
name|pwidget
operator|->
name|paths_pixmap
condition|)
name|gdk_drawable_unref
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|pwidget
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|Path
modifier|*
DECL|function|path_dialog_new (GimpImage * gimage,gint name_seed,gpointer data)
name|path_dialog_new
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|name_seed
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
name|gchar
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Path %d"
argument_list|)
argument_list|,
name|name_seed
argument_list|)
expr_stmt|;
name|bzp
operator|=
name|path_new
argument_list|(
name|gimage
argument_list|,
name|BEZIER
argument_list|,
operator|(
name|GSList
operator|*
operator|)
name|data
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
name|bzp
return|;
block|}
end_function

begin_function
specifier|static
name|PathPoint
modifier|*
DECL|function|path_start_last_seg (GSList * plist)
name|path_start_last_seg
parameter_list|(
name|GSList
modifier|*
name|plist
parameter_list|)
block|{
name|PathPoint
modifier|*
name|retp
init|=
name|plist
operator|->
name|data
decl_stmt|;
while|while
condition|(
name|plist
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|PathPoint
operator|*
operator|)
operator|(
name|plist
operator|->
name|data
operator|)
operator|)
operator|->
name|type
operator|==
name|BEZIER_MOVE
operator|&&
name|g_slist_next
argument_list|(
name|plist
argument_list|)
condition|)
block|{
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
name|retp
operator|=
name|plist
operator|->
name|data
expr_stmt|;
block|}
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
return|return
name|retp
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|path_close (Path * bzp)
name|path_close
parameter_list|(
name|Path
modifier|*
name|bzp
parameter_list|)
block|{
name|PathPoint
modifier|*
name|pdata
decl_stmt|;
name|PathPoint
modifier|*
name|pathpoint
decl_stmt|;
comment|/* bzpaths are only really closed when converted to the BezierSelect ones */
name|bzp
operator|->
name|closed
operator|=
literal|1
expr_stmt|;
comment|/* first point */
name|pdata
operator|=
operator|(
name|PathPoint
operator|*
operator|)
name|bzp
operator|->
name|path_details
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|g_slist_length
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
operator|<
literal|5
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|pathpoint
operator|=
name|g_new0
argument_list|(
name|PathPoint
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pathpoint
operator|->
name|type
operator|=
operator|(
name|i
operator|&
literal|1
operator|)
condition|?
name|BEZIER_ANCHOR
else|:
name|BEZIER_CONTROL
expr_stmt|;
name|pathpoint
operator|->
name|x
operator|=
name|pdata
operator|->
name|x
operator|+
name|i
expr_stmt|;
name|pathpoint
operator|->
name|y
operator|=
name|pdata
operator|->
name|y
operator|+
name|i
expr_stmt|;
name|bzp
operator|->
name|path_details
operator|=
name|g_slist_append
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|,
name|pathpoint
argument_list|)
expr_stmt|;
block|}
block|}
name|pathpoint
operator|=
name|g_new0
argument_list|(
name|PathPoint
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pdata
operator|=
name|path_start_last_seg
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|pathpoint
operator|->
name|type
operator|=
name|BEZIER_CONTROL
expr_stmt|;
name|pathpoint
operator|->
name|x
operator|=
name|pdata
operator|->
name|x
expr_stmt|;
name|pathpoint
operator|->
name|y
operator|=
name|pdata
operator|->
name|y
expr_stmt|;
comment|/* printf("Closing to x,y %d,%d\n",(gint)pdata->x,(gint)pdata->y); */
name|bzp
operator|->
name|path_details
operator|=
name|g_slist_append
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|,
name|pathpoint
argument_list|)
expr_stmt|;
name|bzp
operator|->
name|state
operator|=
name|BEZIER_EDIT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|bz_change_name_row_to (gint row,gchar * text)
name|bz_change_name_row_to
parameter_list|(
name|gint
name|row
parameter_list|,
name|gchar
modifier|*
name|text
parameter_list|)
block|{
name|PathWidget
modifier|*
name|pwidget
decl_stmt|;
name|pwidget
operator|=
operator|(
name|PathWidget
operator|*
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pwidget
condition|)
return|return;
name|g_free
argument_list|(
name|pwidget
operator|->
name|bzp
operator|->
name|name
argument_list|)
expr_stmt|;
name|pwidget
operator|->
name|bzp
operator|->
name|name
operator|=
name|g_strdup
argument_list|(
name|text
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_set_dash_line (GdkGC * gc,gboolean state)
name|paths_set_dash_line
parameter_list|(
name|GdkGC
modifier|*
name|gc
parameter_list|,
name|gboolean
name|state
parameter_list|)
block|{
name|gdk_gc_set_foreground
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
operator|&
name|paths_dialog
operator|->
name|black
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
condition|)
block|{
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
literal|0
argument_list|,
name|GDK_LINE_ON_OFF_DASH
argument_list|,
name|GDK_CAP_BUTT
argument_list|,
name|GDK_JOIN_ROUND
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
literal|0
argument_list|,
name|GDK_LINE_SOLID
argument_list|,
name|GDK_CAP_BUTT
argument_list|,
name|GDK_JOIN_ROUND
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|clear_pixmap_preview (PathWidget * pwidget)
name|clear_pixmap_preview
parameter_list|(
name|PathWidget
modifier|*
name|pwidget
parameter_list|)
block|{
name|guchar
modifier|*
name|rgb_buf
decl_stmt|;
name|rgb_buf
operator|=
name|g_new0
argument_list|(
name|guchar
argument_list|,
operator|(
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
operator|)
operator|*
operator|(
name|paths_dialog
operator|->
name|image_height
operator|+
literal|4
operator|)
operator|*
literal|3
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|rgb_buf
argument_list|,
literal|0xFF
argument_list|,
operator|(
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
operator|)
operator|*
operator|(
name|paths_dialog
operator|->
name|image_height
operator|+
literal|4
operator|)
operator|*
literal|3
argument_list|)
expr_stmt|;
name|gdk_draw_rgb_image
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|paths_dialog
operator|->
name|gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|4
argument_list|,
name|GDK_RGB_DITHER_NORMAL
argument_list|,
name|rgb_buf
argument_list|,
operator|(
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
operator|)
operator|*
literal|3
argument_list|)
expr_stmt|;
name|paths_set_dash_line
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|paths_dialog
operator|->
name|gc
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|image_width
operator|+
literal|3
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|3
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|paths_dialog
operator|->
name|gc
argument_list|,
name|FALSE
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|paths_dialog
operator|->
name|image_width
operator|+
literal|1
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|rgb_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* insrow == -1 -> append else insert at insrow */
end_comment

begin_function
name|void
DECL|function|paths_add_path (Path * bzp,gint insrow)
name|paths_add_path
parameter_list|(
name|Path
modifier|*
name|bzp
parameter_list|,
name|gint
name|insrow
parameter_list|)
block|{
comment|/* Create a new entry in the list */
name|PathWidget
modifier|*
name|pwidget
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|gchar
modifier|*
name|row_data
index|[
literal|2
index|]
decl_stmt|;
name|pwidget
operator|=
name|g_new0
argument_list|(
name|PathWidget
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|GTK_WIDGET_REALIZED
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
condition|)
name|gtk_widget_realize
argument_list|(
name|paths_dialog
operator|->
name|vbox
argument_list|)
expr_stmt|;
name|paths_dialog_preview_extents
argument_list|()
expr_stmt|;
if|if
condition|(
name|gimprc
operator|.
name|preview_size
condition|)
block|{
comment|/* Need to add this to the list */
name|pwidget
operator|->
name|paths_pixmap
operator|=
name|gdk_pixmap_new
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
name|paths_dialog
operator|->
name|image_width
operator|+
literal|4
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|4
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|clear_pixmap_preview
argument_list|(
name|pwidget
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|paths_dialog
operator|->
name|pixmap_normal
condition|)
block|{
name|paths_dialog
operator|->
name|pixmap_normal
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
name|path_bits
argument_list|,
name|paths_dialog
operator|->
name|image_width
argument_list|,
name|paths_dialog
operator|->
name|image_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|pixmap_selected
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
name|path_bits
argument_list|,
name|paths_dialog
operator|->
name|image_width
argument_list|,
name|paths_dialog
operator|->
name|image_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|)
expr_stmt|;
block|}
name|pwidget
operator|->
name|paths_pixmap
operator|=
name|paths_dialog
operator|->
name|pixmap_normal
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|paths_dialog
operator|->
name|pixmap_locked_normal
condition|)
block|{
name|paths_dialog
operator|->
name|pixmap_locked_normal
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
name|locked_bits
argument_list|,
name|locked_width
argument_list|,
name|locked_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|white
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|pixmap_locked_selected
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|paths_dialog
operator|->
name|vbox
operator|->
name|window
argument_list|,
name|locked_bits
argument_list|,
name|locked_width
argument_list|,
name|locked_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|,
operator|&
name|paths_dialog
operator|->
name|vbox
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|)
expr_stmt|;
block|}
name|gtk_clist_set_row_height
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|image_height
operator|+
literal|6
argument_list|)
expr_stmt|;
name|row_data
index|[
literal|0
index|]
operator|=
literal|""
expr_stmt|;
name|row_data
index|[
literal|1
index|]
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|insrow
operator|==
operator|-
literal|1
condition|)
name|row
operator|=
name|gtk_clist_append
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row_data
argument_list|)
expr_stmt|;
else|else
name|row
operator|=
name|gtk_clist_insert
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|insrow
argument_list|,
name|row_data
argument_list|)
expr_stmt|;
name|gtk_clist_set_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|1
argument_list|,
name|bzp
operator|->
name|name
argument_list|,
literal|2
argument_list|,
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_clist_set_row_data_full
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
operator|(
name|gpointer
operator|)
name|pwidget
argument_list|,
name|clear_pathwidget
argument_list|)
expr_stmt|;
name|gtk_signal_handler_block
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_signal_handler_unblock
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|pwidget
operator|->
name|bzp
operator|=
name|bzp
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_preview_extents (void)
name|paths_dialog_preview_extents
parameter_list|(
name|void
parameter_list|)
block|{
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
operator|)
condition|)
return|return;
name|paths_dialog
operator|->
name|gimage_width
operator|=
name|gimage
operator|->
name|width
expr_stmt|;
name|paths_dialog
operator|->
name|gimage_height
operator|=
name|gimage
operator|->
name|height
expr_stmt|;
comment|/*  Get the image width and height variables, based on the gimage  */
if|if
condition|(
name|gimage
operator|->
name|width
operator|>
name|gimage
operator|->
name|height
condition|)
name|paths_dialog
operator|->
name|ratio
operator|=
operator|(
name|double
operator|)
name|gimprc
operator|.
name|preview_size
operator|/
operator|(
name|double
operator|)
name|gimage
operator|->
name|width
expr_stmt|;
else|else
name|paths_dialog
operator|->
name|ratio
operator|=
operator|(
name|double
operator|)
name|gimprc
operator|.
name|preview_size
operator|/
operator|(
name|double
operator|)
name|gimage
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|gimprc
operator|.
name|preview_size
condition|)
block|{
name|paths_dialog
operator|->
name|image_width
operator|=
call|(
name|int
call|)
argument_list|(
name|paths_dialog
operator|->
name|ratio
operator|*
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|image_height
operator|=
call|(
name|int
call|)
argument_list|(
name|paths_dialog
operator|->
name|ratio
operator|*
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|paths_dialog
operator|->
name|image_width
operator|<
literal|1
condition|)
name|paths_dialog
operator|->
name|image_width
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|paths_dialog
operator|->
name|image_height
operator|<
literal|1
condition|)
name|paths_dialog
operator|->
name|image_height
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|paths_dialog
operator|->
name|image_width
operator|=
name|path_width
expr_stmt|;
name|paths_dialog
operator|->
name|image_height
operator|=
name|path_height
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_select_row (GtkWidget * widget,gint row,gint column,GdkEventButton * event,gpointer data)
name|paths_select_row
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|row
parameter_list|,
name|gint
name|column
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|PathWidget
modifier|*
name|pwidget
decl_stmt|;
name|Path
modifier|*
name|bzp
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bsel
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gint
name|last_row
decl_stmt|;
name|pwidget
operator|=
operator|(
name|PathWidget
operator|*
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|widget
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pwidget
operator|||
operator|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|==
name|row
operator|&&
name|paths_dialog
operator|->
name|been_selected
operator|==
name|TRUE
operator|)
condition|)
block|{
if|if
condition|(
name|column
condition|)
return|return;
block|}
name|last_row
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|bzp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|column
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bzp
operator|->
name|locked
operator|==
literal|0
condition|)
block|{
name|bzp
operator|->
name|locked
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|==
name|row
condition|)
name|gtk_clist_set_pixmap
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|pixmap_locked_selected
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|gtk_clist_set_pixmap
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|pixmap_locked_normal
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gint
name|tmprow
decl_stmt|;
name|bzp
operator|->
name|locked
operator|=
literal|0
expr_stmt|;
name|gtk_clist_set_text
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* There should be an easier way of updating the preview! */
name|bsel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
block|}
comment|/* Put hightlight back on the old original selection */
name|gtk_signal_handler_block
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|last_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_signal_handler_unblock
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
return|return;
block|}
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|paths_dialog
operator|->
name|been_selected
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|bzp
operator|->
name|locked
condition|)
name|gtk_clist_set_pixmap
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|pixmap_locked_selected
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|bsel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gdisp
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gdisp
condition|)
block|{
comment|/*g_warning("Lost image which bezier curve belonged to");*/
return|return;
block|}
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bsel
argument_list|)
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_unselect_row (GtkWidget * widget,gint row,gint column,GdkEventButton * event,gpointer data)
name|paths_unselect_row
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|row
parameter_list|,
name|gint
name|column
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|PathWidget
modifier|*
name|pwidget
decl_stmt|;
name|Path
modifier|*
name|bzp
decl_stmt|;
name|pwidget
operator|=
operator|(
name|PathWidget
operator|*
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|widget
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pwidget
condition|)
return|return;
name|bzp
operator|=
name|pwidget
operator|->
name|bzp
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|bzp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|column
operator|&&
name|bzp
operator|->
name|locked
condition|)
block|{
name|gtk_clist_set_pixmap
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|pixmap_locked_normal
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_update (GimpImage * gimage)
name|paths_dialog_update
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|PathList
modifier|*
name|new_path_list
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
name|gint
name|loop
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
operator|||
operator|!
name|gimage
condition|)
return|return;
if|if
condition|(
name|paths_dialog
operator|->
name|gimage
operator|==
name|gimage
operator|&&
name|paths_dialog
operator|->
name|current_path_list
operator|==
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
condition|)
return|return;
name|paths_dialog
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
name|paths_dialog_preview_extents
argument_list|()
expr_stmt|;
comment|/*  clear clist out  */
name|gtk_clist_freeze
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_clist_clear
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_clist_thaw
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  Find bz list  */
name|new_path_list
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|new_path_list
expr_stmt|;
name|paths_dialog
operator|->
name|been_selected
operator|=
name|FALSE
expr_stmt|;
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
name|paths_dialog_set_default_op
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|new_path_list
condition|)
return|return;
comment|/* update the clist to reflect this images bz list */
comment|/* go around the image list populating the clist */
if|if
condition|(
name|gimage
operator|!=
name|new_path_list
operator|->
name|gimage
condition|)
block|{
name|g_warning
argument_list|(
literal|"paths list: internal list error"
argument_list|)
expr_stmt|;
block|}
name|plist
operator|=
name|new_path_list
operator|->
name|bz_paths
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
while|while
condition|(
name|plist
condition|)
block|{
name|paths_update_paths
argument_list|(
name|plist
operator|->
name|data
argument_list|,
name|loop
argument_list|)
expr_stmt|;
name|loop
operator|++
expr_stmt|;
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
comment|/* select last one */
name|gtk_signal_handler_block
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_signal_handler_unblock
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selsigid
argument_list|)
expr_stmt|;
name|gtk_clist_moveto
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|0
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_update_paths (gpointer data,gint row)
name|paths_update_paths
parameter_list|(
name|gpointer
name|data
parameter_list|,
name|gint
name|row
parameter_list|)
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|paths_add_path
argument_list|(
operator|(
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|data
operator|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|bzp
operator|->
name|locked
condition|)
block|{
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|==
name|row
condition|)
name|gtk_clist_set_pixmap
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|pixmap_locked_selected
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|gtk_clist_set_pixmap
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|paths_dialog
operator|->
name|pixmap_locked_normal
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|do_rename_paths_callback (GtkWidget * widget,gchar * text,gpointer data)
name|do_rename_paths_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gchar
modifier|*
name|text
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GdkBitmap
modifier|*
name|mask
decl_stmt|;
name|guint8
name|spacing
decl_stmt|;
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|GTK_CLIST
argument_list|(
name|data
argument_list|)
operator|->
name|selection
operator|)
condition|)
return|return;
name|gtk_clist_get_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
operator|&
name|spacing
argument_list|,
operator|&
name|pixmap
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
name|gtk_clist_set_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|data
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|,
literal|1
argument_list|,
name|text
argument_list|,
name|spacing
argument_list|,
name|pixmap
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|bz_change_name_row_to
argument_list|(
name|paths_dialog
operator|->
name|selected_row_num
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_edit_path_query (GtkWidget * widget)
name|paths_dialog_edit_path_query
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|qbox
decl_stmt|;
name|GdkBitmap
modifier|*
name|mask
decl_stmt|;
name|gchar
modifier|*
name|text
decl_stmt|;
name|gint
name|ret
decl_stmt|;
comment|/* Get the current name */
name|ret
operator|=
name|gtk_clist_get_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|,
literal|1
argument_list|,
operator|&
name|text
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
name|qbox
operator|=
name|gimp_query_string_box
argument_list|(
name|_
argument_list|(
literal|"Edit Path Attributes"
argument_list|)
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"paths/dialogs/edit_path_attributes.html"
argument_list|,
name|_
argument_list|(
literal|"Enter a new name for the path"
argument_list|)
argument_list|,
name|text
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|do_rename_paths_callback
argument_list|,
name|widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|qbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|paths_list_events (GtkWidget * widget,GdkEvent * event)
name|paths_list_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
specifier|static
name|gint
name|last_row
init|=
operator|-
literal|1
decl_stmt|;
name|gint
name|this_column
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_BUTTON_PRESS
case|:
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
operator|!
name|gtk_clist_get_selection_info
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
operator|&
name|last_row
argument_list|,
operator|&
name|this_column
argument_list|)
condition|)
name|last_row
operator|=
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|!=
name|last_row
condition|)
name|last_row
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|bevent
operator|->
name|button
operator|==
literal|3
condition|)
name|gtk_menu_popup
argument_list|(
name|GTK_MENU
argument_list|(
name|paths_dialog
operator|->
name|ops_menu
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|bevent
operator|->
name|button
argument_list|,
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_2BUTTON_PRESS
case|:
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
name|last_row
operator|!=
operator|-
literal|1
operator|&&
name|gtk_clist_get_selection_info
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|bevent
operator|->
name|x
argument_list|,
name|bevent
operator|->
name|y
argument_list|,
name|NULL
argument_list|,
operator|&
name|this_column
argument_list|)
condition|)
block|{
if|if
condition|(
name|this_column
operator|==
literal|1
condition|)
block|{
name|paths_dialog_edit_path_query
argument_list|(
name|widget
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
else|else
return|return
name|FALSE
return|;
block|}
else|else
return|return
name|FALSE
return|;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|PathList
modifier|*
DECL|function|path_add_to_current (PathList * pip,Path * bzp,GimpImage * gimage,gint pos)
name|path_add_to_current
parameter_list|(
name|PathList
modifier|*
name|pip
parameter_list|,
name|Path
modifier|*
name|bzp
parameter_list|,
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|pos
parameter_list|)
block|{
comment|/* add bzp to current list */
if|if
condition|(
operator|!
name|pip
condition|)
block|{
comment|/* This image does not have a list */
name|pip
operator|=
name|path_list_new
argument_list|(
name|gimage
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* add to gimage */
name|gimp_image_set_paths
argument_list|(
name|gimage
argument_list|,
name|pip
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|<
literal|0
condition|)
name|pip
operator|->
name|bz_paths
operator|=
name|g_slist_append
argument_list|(
name|pip
operator|->
name|bz_paths
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
else|else
name|pip
operator|->
name|bz_paths
operator|=
name|g_slist_insert
argument_list|(
name|pip
operator|->
name|bz_paths
argument_list|,
name|bzp
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
name|pip
return|;
block|}
end_function

begin_function
specifier|static
name|Path
modifier|*
DECL|function|paths_dialog_new_path (PathList ** plp,gpointer points,GimpImage * gimage,gint pos)
name|paths_dialog_new_path
parameter_list|(
name|PathList
modifier|*
modifier|*
name|plp
parameter_list|,
name|gpointer
name|points
parameter_list|,
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|pos
parameter_list|)
block|{
specifier|static
name|gint
name|nseed
init|=
literal|0
decl_stmt|;
name|Path
modifier|*
name|bzp
decl_stmt|;
name|bzp
operator|=
name|path_dialog_new
argument_list|(
name|gimage
argument_list|,
name|nseed
operator|++
argument_list|,
name|points
argument_list|)
expr_stmt|;
operator|*
name|plp
operator|=
name|path_add_to_current
argument_list|(
operator|*
name|plp
argument_list|,
name|bzp
argument_list|,
name|gimage
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
operator|(
name|bzp
operator|)
return|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_new_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_new_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpBezierSelectTool
modifier|*
name|bsel
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|Path
modifier|*
name|bzp
decl_stmt|;
name|bzp
operator|=
name|paths_dialog_new_path
argument_list|(
operator|&
name|paths_dialog
operator|->
name|current_path_list
argument_list|,
name|NULL
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|)
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzp
argument_list|,
name|paths_dialog
operator|->
name|selected_row_num
argument_list|)
expr_stmt|;
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
name|paths_dialog_set_default_op
argument_list|()
expr_stmt|;
comment|/* Clear the path display out */
name|bsel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gdisp
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bsel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_delete_path_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_delete_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
name|gboolean
name|new_sz
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bsel
init|=
name|NULL
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
init|=
name|NULL
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure& delete its content */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Remove from list */
name|plp
operator|->
name|bz_paths
operator|=
name|g_slist_remove
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
name|new_sz
operator|=
operator|(
name|g_slist_length
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|)
operator|>
literal|0
operator|)
expr_stmt|;
name|path_free
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
comment|/* Remove from the clist ... */
name|gtk_signal_handler_block_by_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
argument_list|)
expr_stmt|;
name|gtk_clist_remove
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|gtk_signal_handler_unblock_by_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
argument_list|)
expr_stmt|;
comment|/* If now empty free everything up */
if|if
condition|(
operator|!
name|plp
operator|->
name|bz_paths
operator|||
name|g_slist_length
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gtk_signal_disconnect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|plp
operator|->
name|gimage
argument_list|)
argument_list|,
name|plp
operator|->
name|sig_id
argument_list|)
expr_stmt|;
name|gimp_image_set_paths
argument_list|(
name|plp
operator|->
name|gimage
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|path_list_free
argument_list|(
name|plp
argument_list|)
expr_stmt|;
comment|/* Paste an empty BezierSelect to the current display to emulate an empty path list */
name|bsel
operator|=
name|g_new0
argument_list|(
name|GimpBezierSelectTool
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bezier_select_reset
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gdisp
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bsel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bsel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|NULL
expr_stmt|;
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|new_sz
condition|)
name|paths_dialog_set_default_op
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_paste_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_paste_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
name|PathPoint
modifier|*
name|pp
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|copy_pp
condition|)
return|return;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return;
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|bzp
operator|->
name|path_details
condition|)
block|{
name|pp
operator|=
name|bzp
operator|->
name|path_details
operator|->
name|data
expr_stmt|;
name|pp
operator|->
name|type
operator|=
name|BEZIER_MOVE
expr_stmt|;
name|bzp
operator|->
name|path_details
operator|=
name|g_slist_concat
argument_list|(
name|copy_pp
operator|->
name|path_details
argument_list|,
name|bzp
operator|->
name|path_details
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bzp
operator|->
name|closed
operator|=
name|TRUE
expr_stmt|;
name|bzp
operator|->
name|path_details
operator|=
name|copy_pp
operator|->
name|path_details
expr_stmt|;
name|bzp
operator|->
name|state
operator|=
name|copy_pp
operator|->
name|state
expr_stmt|;
block|}
comment|/* First point on new curve is a moveto */
name|copy_pp
operator|->
name|path_details
operator|=
name|NULL
expr_stmt|;
name|path_free
argument_list|(
name|copy_pp
argument_list|)
expr_stmt|;
name|copy_pp
operator|=
name|NULL
expr_stmt|;
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gdisp
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_copy_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_copy_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bzp
operator|->
name|path_details
operator|||
name|g_slist_length
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
operator|<=
literal|5
condition|)
return|return;
comment|/* And store in static array */
name|copy_pp
operator|=
name|path_copy
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
comment|/* All paths that are in the cut buffer must be closed */
if|if
condition|(
operator|!
name|copy_pp
operator|->
name|closed
condition|)
name|path_close
argument_list|(
name|copy_pp
argument_list|)
expr_stmt|;
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_dup_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_dup_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
name|row
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Insert at the current position */
name|bzp
operator|=
name|path_copy
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
name|plp
operator|->
name|bz_paths
operator|=
name|g_slist_insert
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|bzp
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzp
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_advanced_to_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_advanced_to_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ProcRecord
modifier|*
name|proc_rec
decl_stmt|;
name|Argument
modifier|*
name|args
decl_stmt|;
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
expr_stmt|;
comment|/*  find the sel2path PDB record  */
if|if
condition|(
operator|(
name|proc_rec
operator|=
name|procedural_db_lookup
argument_list|(
name|gimage
operator|->
name|gimp
argument_list|,
literal|"plug_in_sel2path_advanced"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|g_message
argument_list|(
literal|"paths_dialog_adavanced_to_path_callback(): selection to path (advanced) procedure lookup failed"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*  plug-in arguments as if called by<Image>/Filters/...  */
name|args
operator|=
name|g_new
argument_list|(
name|Argument
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|.
name|arg_type
operator|=
name|GIMP_PDB_INT32
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|RUN_INTERACTIVE
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|.
name|arg_type
operator|=
name|GIMP_PDB_IMAGE
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
operator|(
name|gint32
operator|)
name|gimp_image_get_ID
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|.
name|arg_type
operator|=
name|GIMP_PDB_DRAWABLE
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
operator|(
name|gint32
operator|)
name|gimp_drawable_get_ID
argument_list|(
name|gimp_image_active_drawable
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
name|plug_in_run
argument_list|(
name|proc_rec
argument_list|,
name|args
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|gimp_drawable_get_ID
argument_list|(
name|gimp_image_active_drawable
argument_list|(
name|gimage
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_sel_to_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_sel_to_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ProcRecord
modifier|*
name|proc_rec
decl_stmt|;
name|Argument
modifier|*
name|args
decl_stmt|;
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
expr_stmt|;
comment|/*  find the sel2path PDB record  */
if|if
condition|(
operator|(
name|proc_rec
operator|=
name|procedural_db_lookup
argument_list|(
name|gimage
operator|->
name|gimp
argument_list|,
literal|"plug_in_sel2path"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|g_message
argument_list|(
literal|"paths_dialog_sel_to_path_callback(): selection to path procedure lookup failed"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*  plug-in arguments as if called by<Image>/Filters/...  */
name|args
operator|=
name|g_new
argument_list|(
name|Argument
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|.
name|arg_type
operator|=
name|GIMP_PDB_INT32
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
name|RUN_INTERACTIVE
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|.
name|arg_type
operator|=
name|GIMP_PDB_IMAGE
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
operator|(
name|gint32
operator|)
name|gimp_image_get_ID
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|.
name|arg_type
operator|=
name|GIMP_PDB_DRAWABLE
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|.
name|value
operator|.
name|pdb_int
operator|=
operator|(
name|gint32
operator|)
name|gimp_drawable_get_ID
argument_list|(
name|gimp_image_active_drawable
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get the display by asking the current context */
name|gdisp
operator|=
name|gimp_context_get_display
argument_list|(
name|gimp_get_user_context
argument_list|(
name|gimage
operator|->
name|gimp
argument_list|)
argument_list|)
expr_stmt|;
name|plug_in_run
argument_list|(
name|proc_rec
argument_list|,
name|args
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|gdisp
condition|?
name|gdisp
operator|->
name|ID
else|:
literal|0
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_path_to_sel_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_path_to_sel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Return if no point list */
if|if
condition|(
operator|!
name|bzp
operator|->
name|path_details
condition|)
return|return;
comment|/* Now do the selection....*/
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gdisp
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bzp
operator|->
name|closed
condition|)
block|{
name|Path
modifier|*
name|bzpcopy
init|=
name|path_copy
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|bzp
argument_list|)
decl_stmt|;
comment|/* Close it */
name|path_close
argument_list|(
name|bzpcopy
argument_list|)
expr_stmt|;
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzpcopy
argument_list|)
expr_stmt|;
name|path_free
argument_list|(
name|bzpcopy
argument_list|)
expr_stmt|;
name|bezier_to_selection
argument_list|(
name|bezier_sel
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
comment|/* Force display to show no closed curve */
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzp
argument_list|)
expr_stmt|;
name|bezier_to_selection
argument_list|(
name|bezier_sel
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_stroke_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_stroke_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Now do the stroke....*/
name|path_stroke
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_edit_path_attributes_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_edit_path_attributes_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|paths_list
condition|)
name|paths_dialog_edit_path_query
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_destroy_cb (GtkObject * object,gpointer data)
name|paths_dialog_destroy_cb
parameter_list|(
name|GtkObject
modifier|*
name|object
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpImage
modifier|*
name|gimage
init|=
operator|(
name|GimpImage
operator|*
operator|)
name|object
decl_stmt|;
name|PathList
modifier|*
name|new_path_list
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
if|if
condition|(
name|paths_dialog
operator|->
name|current_path_list
operator|&&
name|gimage
operator|==
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|gimage
condition|)
block|{
comment|/* showing could be last so remove here.. might get  	 done again if not the last one       */
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|NULL
expr_stmt|;
name|paths_dialog
operator|->
name|been_selected
operator|=
name|FALSE
expr_stmt|;
name|gtk_clist_freeze
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_clist_clear
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_clist_thaw
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Find bz list */
name|new_path_list
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_path_list
condition|)
return|return;
comment|/* Already removed - signal handler just left in the air */
name|path_list_free
argument_list|(
name|new_path_list
argument_list|)
expr_stmt|;
name|gimp_image_set_paths
argument_list|(
name|gimage
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Functions used from the bezier code .. tie in with this code */
end_comment

begin_function
specifier|static
name|GSList
modifier|*
DECL|function|pathpoints_create (GimpBezierSelectTool * sel)
name|pathpoints_create
parameter_list|(
name|GimpBezierSelectTool
modifier|*
name|sel
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|GSList
modifier|*
name|list
init|=
name|NULL
decl_stmt|;
name|PathPoint
modifier|*
name|pathpoint
decl_stmt|;
name|GimpBezierSelectPoint
modifier|*
name|pts
init|=
operator|(
name|GimpBezierSelectPoint
operator|*
operator|)
name|sel
operator|->
name|points
decl_stmt|;
name|GimpBezierSelectPoint
modifier|*
name|start_pnt
init|=
name|pts
decl_stmt|;
name|gint
name|need_move
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sel
operator|->
name|num_points
condition|;
name|i
operator|++
control|)
block|{
name|pathpoint
operator|=
name|path_point_new
argument_list|(
operator|(
name|need_move
operator|)
condition|?
name|BEZIER_MOVE
else|:
name|pts
operator|->
name|type
argument_list|,
operator|(
name|gdouble
operator|)
name|pts
operator|->
name|x
argument_list|,
operator|(
name|gdouble
operator|)
name|pts
operator|->
name|y
argument_list|)
expr_stmt|;
name|need_move
operator|=
literal|0
expr_stmt|;
name|list
operator|=
name|g_slist_append
argument_list|(
name|list
argument_list|,
name|pathpoint
argument_list|)
expr_stmt|;
if|if
condition|(
name|pts
operator|->
name|next_curve
condition|)
block|{
comment|/* The curve must loop back on itself */
if|if
condition|(
name|start_pnt
operator|!=
name|pts
operator|->
name|next
condition|)
name|g_warning
argument_list|(
literal|"Curve of of sync"
argument_list|)
expr_stmt|;
name|need_move
operator|=
literal|1
expr_stmt|;
name|pts
operator|=
name|pts
operator|->
name|next_curve
expr_stmt|;
name|start_pnt
operator|=
name|pts
expr_stmt|;
block|}
else|else
block|{
name|pts
operator|=
name|pts
operator|->
name|next
expr_stmt|;
block|}
block|}
return|return
operator|(
name|list
operator|)
return|;
block|}
end_function

begin_function
name|GSList
modifier|*
DECL|function|pathpoints_copy (GSList * list)
name|pathpoints_copy
parameter_list|(
name|GSList
modifier|*
name|list
parameter_list|)
block|{
name|GSList
modifier|*
name|slcopy
init|=
name|NULL
decl_stmt|;
name|PathPoint
modifier|*
name|pdata
decl_stmt|;
name|PathPoint
modifier|*
name|pathpoint
decl_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|pathpoint
operator|=
name|g_new0
argument_list|(
name|PathPoint
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pdata
operator|=
operator|(
name|PathPoint
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|pathpoint
operator|->
name|type
operator|=
name|pdata
operator|->
name|type
expr_stmt|;
name|pathpoint
operator|->
name|x
operator|=
name|pdata
operator|->
name|x
expr_stmt|;
name|pathpoint
operator|->
name|y
operator|=
name|pdata
operator|->
name|y
expr_stmt|;
name|slcopy
operator|=
name|g_slist_append
argument_list|(
name|slcopy
argument_list|,
name|pathpoint
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
return|return
name|slcopy
return|;
block|}
end_function

begin_function
name|void
DECL|function|pathpoints_free (GSList * list)
name|pathpoints_free
parameter_list|(
name|GSList
modifier|*
name|list
parameter_list|)
block|{
if|if
condition|(
operator|!
name|list
condition|)
return|return;
name|g_slist_foreach
argument_list|(
name|list
argument_list|,
operator|(
name|GFunc
operator|)
name|path_point_free
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_slist_free
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_update_bzpath (PathList * plp,GimpBezierSelectTool * bezier_sel)
name|paths_update_bzpath
parameter_list|(
name|PathList
modifier|*
name|plp
parameter_list|,
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
parameter_list|)
block|{
name|Path
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|plp
operator|->
name|last_selected_row
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|path_details
condition|)
name|pathpoints_free
argument_list|(
name|p
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|p
operator|->
name|path_details
operator|=
name|pathpoints_create
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|p
operator|->
name|closed
operator|=
name|bezier_sel
operator|->
name|closed
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|bezier_sel
operator|->
name|state
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|paths_replaced_current (PathList * plp,GimpBezierSelectTool * bezier_sel)
name|paths_replaced_current
parameter_list|(
name|PathList
modifier|*
name|plp
parameter_list|,
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
parameter_list|)
block|{
comment|/* Is there a currently selected path in this image? */
comment|/* ALT if(paths_dialog&& plp&&  */
if|if
condition|(
name|plp
operator|&&
name|plp
operator|->
name|last_selected_row
operator|>=
literal|0
condition|)
block|{
name|paths_update_bzpath
argument_list|(
name|plp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|number_curves_in_path (GSList * plist)
name|number_curves_in_path
parameter_list|(
name|GSList
modifier|*
name|plist
parameter_list|)
block|{
name|gint
name|count
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|plist
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|PathPoint
operator|*
operator|)
operator|(
name|plist
operator|->
name|data
operator|)
operator|)
operator|->
name|type
operator|==
name|BEZIER_MOVE
operator|&&
name|g_slist_next
argument_list|(
name|plist
argument_list|)
condition|)
block|{
name|count
operator|++
expr_stmt|;
block|}
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_draw_segment_points (GimpBezierSelectTool * bezier_sel,GdkPoint * pnt,int npoints,gpointer udata)
name|paths_draw_segment_points
parameter_list|(
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
parameter_list|,
name|GdkPoint
modifier|*
name|pnt
parameter_list|,
name|int
name|npoints
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
comment|/*     * hopefully the image points are already in image space co-ords.    * so just scale by ratio factor and draw 'em    */
name|gint
name|loop
decl_stmt|;
name|gint
name|pcount
init|=
literal|0
decl_stmt|;
name|GdkPoint
modifier|*
name|copy_pnt
init|=
name|g_new
argument_list|(
name|GdkPoint
argument_list|,
name|npoints
argument_list|)
decl_stmt|;
name|GdkPoint
modifier|*
name|cur_pnt
init|=
name|copy_pnt
decl_stmt|;
name|GdkPoint
modifier|*
name|last_pnt
init|=
name|NULL
decl_stmt|;
name|PathWidget
modifier|*
name|pwidget
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|PathCounts
modifier|*
name|curve_count
init|=
operator|(
name|PathCounts
operator|*
operator|)
name|udata
decl_stmt|;
comment|/* we could remove duplicate points here */
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
name|npoints
condition|;
name|loop
operator|++
control|)
block|{
comment|/* The "2" is because we have a boarder */
name|cur_pnt
operator|->
name|x
operator|=
literal|2
operator|+
call|(
name|int
call|)
argument_list|(
name|paths_dialog
operator|->
name|ratio
operator|*
name|pnt
operator|->
name|x
argument_list|)
expr_stmt|;
name|cur_pnt
operator|->
name|y
operator|=
literal|2
operator|+
call|(
name|int
call|)
argument_list|(
name|paths_dialog
operator|->
name|ratio
operator|*
name|pnt
operator|->
name|y
argument_list|)
expr_stmt|;
name|pnt
operator|++
expr_stmt|;
if|if
condition|(
name|last_pnt
operator|&&
name|last_pnt
operator|->
name|x
operator|==
name|cur_pnt
operator|->
name|x
operator|&&
name|last_pnt
operator|->
name|y
operator|==
name|cur_pnt
operator|->
name|y
condition|)
block|{
comment|/* same as last ... don't need this one */
continue|continue;
block|}
comment|/*       printf("converting %d [%d,%d] => [%d,%d]\n", */
comment|/* 	     pcount,(int)pnt->x,(int)pnt->y,(int)cur_pnt->x,(int)cur_pnt->y); */
name|last_pnt
operator|=
name|cur_pnt
expr_stmt|;
name|pcount
operator|++
expr_stmt|;
name|cur_pnt
operator|++
expr_stmt|;
block|}
name|row
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|pwidget
operator|=
operator|(
name|PathWidget
operator|*
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcount
operator|<
literal|2
condition|)
return|return;
name|g_return_if_fail
argument_list|(
name|pwidget
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|curve_count
operator|->
name|c_count
operator|.
name|count
operator|<
name|curve_count
operator|->
name|total_count
operator|||
name|bezier_sel
operator|->
name|closed
condition|)
name|paths_set_dash_line
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
else|else
name|paths_set_dash_line
argument_list|(
name|paths_dialog
operator|->
name|gc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gdk_draw_lines
argument_list|(
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|paths_dialog
operator|->
name|gc
argument_list|,
name|copy_pnt
argument_list|,
name|pcount
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|copy_pnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_update_preview (GimpBezierSelectTool * bezier_sel)
name|paths_update_preview
parameter_list|(
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
parameter_list|)
block|{
name|gint
name|row
decl_stmt|;
name|PathCounts
name|curve_count
decl_stmt|;
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|current_path_list
operator|&&
operator|(
name|row
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|)
operator|>=
literal|0
operator|&&
name|gimprc
operator|.
name|preview_size
condition|)
block|{
name|PathWidget
modifier|*
name|pwidget
decl_stmt|;
name|pwidget
operator|=
operator|(
name|PathWidget
operator|*
operator|)
name|gtk_clist_get_row_data
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Clear pixmap */
name|clear_pixmap_preview
argument_list|(
name|pwidget
argument_list|)
expr_stmt|;
name|curve_count
operator|.
name|total_count
operator|=
name|number_curves_in_path
argument_list|(
name|pwidget
operator|->
name|bzp
operator|->
name|path_details
argument_list|)
expr_stmt|;
comment|/* update .. */
name|bezier_draw_curve
argument_list|(
name|bezier_sel
argument_list|,
name|paths_draw_segment_points
argument_list|,
name|IMAGE_COORDS
argument_list|,
operator|&
name|curve_count
argument_list|)
expr_stmt|;
comment|/* update the pixmap */
name|gtk_clist_set_pixtext
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|1
argument_list|,
name|pwidget
operator|->
name|bzp
operator|->
name|name
argument_list|,
literal|2
argument_list|,
name|pwidget
operator|->
name|paths_pixmap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_new_point_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_new_point_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|bezier_select_mode
argument_list|(
name|EXTEND_NEW
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_add_point_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_add_point_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|bezier_select_mode
argument_list|(
name|EXTEND_ADD
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_delete_point_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_delete_point_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|bezier_select_mode
argument_list|(
name|EXTEND_REMOVE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|paths_dialog_edit_point_callback (GtkWidget * widget,gpointer udata)
name|paths_dialog_edit_point_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|udata
parameter_list|)
block|{
name|bezier_select_mode
argument_list|(
name|EXTEND_EDIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_flush (void)
name|paths_dialog_flush
parameter_list|(
name|void
parameter_list|)
block|{
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|paths_dialog
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage
operator|=
name|paths_dialog
operator|->
name|gimage
expr_stmt|;
comment|/* Check current_path_list since we might not have a valid preview.    * which means it should be removed.. Or if we have one    * created it!    */
if|if
condition|(
operator|(
name|paths_dialog
operator|->
name|current_path_list
operator|==
name|NULL
operator|)
operator|||
operator|(
name|gimage
operator|->
name|width
operator|!=
name|paths_dialog
operator|->
name|gimage_width
operator|)
operator|||
operator|(
name|gimage
operator|->
name|height
operator|!=
name|paths_dialog
operator|->
name|gimage_height
operator|)
condition|)
block|{
name|paths_dialog
operator|->
name|gimage
operator|=
name|NULL
expr_stmt|;
name|paths_dialog_update
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|paths_first_button_press (GimpBezierSelectTool * bezier_sel,GDisplay * gdisp)
name|paths_first_button_press
parameter_list|(
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
comment|/* First time a button is pressed in this display */
comment|/* We have two choices here       Either:-      1) We already have a paths item in the list.          => In this case the new one replaces the current entry. We 	need a callback into the bezier code to free things up.      2) We don't have an entry.          => Create a new one and add this curve.       In either case we need to update the preview widget..       All this of course depends on the fact that gdisp is the same      as before.    */
name|Path
modifier|*
name|bzp
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
if|if
condition|(
name|paths_dialog
condition|)
block|{
name|paths_dialog
operator|->
name|been_selected
operator|=
name|FALSE
expr_stmt|;
comment|/*ALT return;*/
block|}
comment|/* Button not pressed in this image...    * find which one it was pressed in if any.    */
name|plp
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
comment|/* Since beziers are part of the save format.. make the image dirty */
comment|/*   undo_push_cantundo(gdisp->gimage, _("path modification")); */
if|if
condition|(
operator|!
name|paths_replaced_current
argument_list|(
name|plp
argument_list|,
name|bezier_sel
argument_list|)
condition|)
block|{
name|bzp
operator|=
name|paths_dialog_new_path
argument_list|(
operator|&
name|plp
argument_list|,
name|pathpoints_create
argument_list|(
name|bezier_sel
argument_list|)
argument_list|,
name|gdisp
operator|->
name|gimage
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bzp
operator|->
name|closed
operator|=
name|bezier_sel
operator|->
name|closed
expr_stmt|;
name|bzp
operator|->
name|state
operator|=
name|bezier_sel
operator|->
name|state
expr_stmt|;
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|gimage
operator|==
name|gdisp
operator|->
name|gimage
condition|)
block|{
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|plp
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzp
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
DECL|function|paths_newpoint_current (GimpBezierSelectTool * bezier_sel,GDisplay * gdisp)
name|paths_newpoint_current
parameter_list|(
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
parameter_list|,
name|GDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
comment|/*  Check if currently showing the paths we are updating  */
if|if
condition|(
name|paths_dialog
operator|&&
name|gdisp
operator|->
name|gimage
operator|==
name|paths_dialog
operator|->
name|gimage
condition|)
block|{
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
name|paths_first_button_press
argument_list|(
name|bezier_sel
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_new_bezier_select_tool (void)
name|paths_new_bezier_select_tool
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|paths_dialog
condition|)
name|paths_dialog
operator|->
name|been_selected
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************/
end_comment

begin_comment
comment|/* Code to save/load from filesystem                          */
end_comment

begin_comment
comment|/**************************************************************/
end_comment

begin_decl_stmt
DECL|variable|file_dlg
specifier|static
name|GtkWidget
modifier|*
name|file_dlg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|load_store
specifier|static
name|int
name|load_store
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|path_write_current_to_file (FILE * f,Path * bzp)
name|path_write_current_to_file
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|Path
modifier|*
name|bzp
parameter_list|)
block|{
name|GSList
modifier|*
name|list
init|=
name|bzp
operator|->
name|path_details
decl_stmt|;
name|PathPoint
modifier|*
name|pdata
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"Name: %s\n"
argument_list|,
name|bzp
operator|->
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"#POINTS: %d\n"
argument_list|,
name|g_slist_length
argument_list|(
name|bzp
operator|->
name|path_details
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"CLOSED: %d\n"
argument_list|,
name|bzp
operator|->
name|closed
operator|==
literal|1
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"DRAW: %d\n"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"STATE: %d\n"
argument_list|,
name|bzp
operator|->
name|state
argument_list|)
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|pdata
operator|=
operator|(
name|PathPoint
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"TYPE: %d X: %d Y: %d\n"
argument_list|,
name|pdata
operator|->
name|type
argument_list|,
operator|(
name|gint
operator|)
name|pdata
operator|->
name|x
argument_list|,
operator|(
name|gint
operator|)
name|pdata
operator|->
name|y
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|file_ok_callback (GtkWidget * widget,gpointer client_data)
name|file_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|GtkFileSelection
modifier|*
name|fs
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
decl_stmt|;
name|Path
modifier|*
name|bzpath
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
name|gint
name|row
init|=
name|paths_dialog
operator|->
name|selected_row_num
decl_stmt|;
name|gint
name|this_path_count
init|=
literal|0
decl_stmt|;
name|fs
operator|=
name|GTK_FILE_SELECTION
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
name|filename
operator|=
name|gtk_file_selection_get_filename
argument_list|(
name|fs
argument_list|)
expr_stmt|;
if|if
condition|(
name|load_store
condition|)
block|{
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Unable to open file %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
operator|!
name|feof
argument_list|(
name|f
argument_list|)
condition|)
block|{
name|GSList
modifier|*
name|pts_list
init|=
name|NULL
decl_stmt|;
name|gchar
modifier|*
name|txt
init|=
name|g_new
argument_list|(
name|gchar
argument_list|,
literal|512
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|txtstart
init|=
name|txt
decl_stmt|;
name|gint
name|readfields
init|=
literal|0
decl_stmt|;
name|int
name|val
decl_stmt|,
name|type
decl_stmt|,
name|closed
decl_stmt|,
name|i
decl_stmt|,
name|draw
decl_stmt|,
name|state
decl_stmt|;
name|double
name|x
decl_stmt|,
name|y
decl_stmt|;
if|if
condition|(
operator|!
name|fgets
argument_list|(
name|txt
argument_list|,
literal|512
argument_list|,
name|f
argument_list|)
operator|||
name|strlen
argument_list|(
name|txt
argument_list|)
operator|<
literal|7
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Failed to read from %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
name|txt
operator|+=
literal|6
expr_stmt|;
comment|/* Miss out 'Name: ' bit */
name|txt
index|[
name|strlen
argument_list|(
name|txt
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|readfields
operator|+=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"#POINTS: %d\n"
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|readfields
operator|+=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"CLOSED: %d\n"
argument_list|,
operator|&
name|closed
argument_list|)
expr_stmt|;
name|readfields
operator|+=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"DRAW: %d\n"
argument_list|,
operator|&
name|draw
argument_list|)
expr_stmt|;
name|readfields
operator|+=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"STATE: %d\n"
argument_list|,
operator|&
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|readfields
operator|!=
literal|4
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Failed to read path from %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|val
operator|<=
literal|0
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"No points specified in path file %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|val
condition|;
name|i
operator|++
control|)
block|{
name|PathPoint
modifier|*
name|bpt
decl_stmt|;
name|readfields
operator|=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"TYPE: %d X: %lg Y: %lg\n"
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|readfields
operator|!=
literal|3
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Failed to read path points from %s"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
name|this_path_count
operator|++
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|BEZIER_ANCHOR
case|:
case|case
name|BEZIER_CONTROL
case|:
break|break;
case|case
name|BEZIER_MOVE
case|:
if|if
condition|(
name|this_path_count
operator|<
literal|6
condition|)
block|{
name|g_warning
argument_list|(
literal|"Invalid single point in path\n"
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
name|this_path_count
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"Invalid point type passed\n"
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
return|return;
block|}
name|bpt
operator|=
name|path_point_new
argument_list|(
name|type
argument_list|,
operator|(
name|gdouble
operator|)
name|x
argument_list|,
operator|(
name|gdouble
operator|)
name|y
argument_list|)
expr_stmt|;
name|pts_list
operator|=
name|g_slist_append
argument_list|(
name|pts_list
argument_list|,
name|bpt
argument_list|)
expr_stmt|;
block|}
name|bzpath
operator|=
name|path_new
argument_list|(
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|BEZIER
argument_list|,
name|pts_list
argument_list|,
name|closed
argument_list|,
name|state
argument_list|,
literal|0
argument_list|,
comment|/* Can't be locked */
literal|0
argument_list|,
comment|/* No tattoo assigned */
name|txt
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|txtstart
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|path_add_to_current
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
argument_list|,
name|bzpath
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzpath
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|val
condition|)
name|paths_dialog_set_default_op
argument_list|()
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Path
modifier|*
name|bzp
decl_stmt|;
comment|/* Get current selection... ignore if none */
if|if
condition|(
name|paths_dialog
operator|->
name|selected_row_num
operator|<
literal|0
condition|)
return|return;
comment|/* Get bzpath structure  */
name|plp
operator|=
name|paths_dialog
operator|->
name|current_path_list
expr_stmt|;
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|f
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"open failed on %s: %s\n"
argument_list|)
argument_list|,
name|filename
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Write the current selection out. */
name|path_write_current_to_file
argument_list|(
name|f
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|file_cancel_callback (GtkWidget * widget,gpointer data)
name|file_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gtk_widget_hide
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|make_file_dlg (gpointer data)
name|make_file_dlg
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|file_dlg
operator|=
name|gtk_file_selection_new
argument_list|(
name|_
argument_list|(
literal|"Load/Store Bezier Curves"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_window_set_wmclass
argument_list|(
name|GTK_WINDOW
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
literal|"load_save_path"
argument_list|,
literal|"Gimp"
argument_list|)
expr_stmt|;
name|gtk_window_set_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_FILE_SELECTION
argument_list|(
name|file_dlg
argument_list|)
operator|->
name|button_area
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|GTK_FILE_SELECTION
argument_list|(
name|file_dlg
argument_list|)
operator|->
name|cancel_button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|file_cancel_callback
argument_list|)
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|GTK_FILE_SELECTION
argument_list|(
name|file_dlg
argument_list|)
operator|->
name|ok_button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|file_ok_callback
argument_list|)
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
literal|"delete_event"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|gtk_widget_hide
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  Connect the "F1" help key  */
name|gimp_help_connect
argument_list|(
name|file_dlg
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_import_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_import_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
comment|/* Read and add at current position */
if|if
condition|(
operator|!
name|file_dlg
condition|)
block|{
name|make_file_dlg
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|file_dlg
argument_list|)
condition|)
return|return;
block|}
name|gimp_help_set_help_data
argument_list|(
name|file_dlg
argument_list|,
name|NULL
argument_list|,
literal|"paths/dialogs/import_path.html"
argument_list|)
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Load Path"
argument_list|)
argument_list|)
expr_stmt|;
name|load_store
operator|=
literal|1
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|paths_dialog_export_path_callback (GtkWidget * widget,gpointer data)
name|paths_dialog_export_path_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
comment|/* Export the path to a file */
if|if
condition|(
operator|!
name|file_dlg
condition|)
block|{
name|make_file_dlg
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|file_dlg
argument_list|)
condition|)
return|return;
block|}
name|gimp_help_set_help_data
argument_list|(
name|file_dlg
argument_list|,
name|NULL
argument_list|,
literal|"paths/dialogs/export_path.html"
argument_list|)
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|file_dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Store Path"
argument_list|)
argument_list|)
expr_stmt|;
name|load_store
operator|=
literal|0
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|file_dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/* Function for transforming paths   */
end_comment

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/* These functions are the undo functions for the paths  * that have undergone transformations.   *  * Generally speaking paths do not belong with the undo   * structures. However when a path undergoes a transformation   * then THIS path transformation should be part of the undo.  * We do have a problem here since a point could have been  * added to the path after the transformation. This   * point will be lost if the undo stuff is performed. It would   * then appear that this point is part of the undo structure.  * I think it is fair that this happens since the user is telling  * us to restore the state before the transformation took place.  * Note tattoos are used to find which paths have been stored in the  * undo buffer. So deleted paths will not suddenly reappear. (I did say  * generally paths are not part of the undo structures).  */
end_comment

begin_function
name|PathUndo
modifier|*
DECL|function|path_transform_start_undo (GimpImage * gimage)
name|path_transform_start_undo
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
comment|/* Save only the locked paths away */
name|PathList
modifier|*
name|plp
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
name|Path
modifier|*
name|p
decl_stmt|;
name|Path
modifier|*
name|p_copy
decl_stmt|;
name|GSList
modifier|*
name|undo_list
init|=
name|NULL
decl_stmt|;
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return
name|NULL
return|;
name|plist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
for|for
control|(
name|plist
operator|=
name|plp
operator|->
name|bz_paths
init|;
name|plist
condition|;
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
control|)
block|{
name|p
operator|=
operator|(
name|Path
operator|*
operator|)
name|plist
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|locked
condition|)
block|{
comment|/* save away for a rainy day */
name|p_copy
operator|=
name|path_copy
argument_list|(
name|NULL
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* NULL means dont want new tattoo */
name|undo_list
operator|=
name|g_slist_append
argument_list|(
name|undo_list
argument_list|,
name|p_copy
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|PathUndo
operator|*
operator|)
name|undo_list
return|;
block|}
end_function

begin_function
name|void
DECL|function|path_transform_free_undo (PathUndo * pundo)
name|path_transform_free_undo
parameter_list|(
name|PathUndo
modifier|*
name|pundo
parameter_list|)
block|{
name|GSList
modifier|*
name|pundolist
init|=
operator|(
name|GSList
operator|*
operator|)
name|pundo
decl_stmt|;
name|Path
modifier|*
name|p
decl_stmt|;
comment|/* free data associated with the transform path undo */
while|while
condition|(
name|pundolist
condition|)
block|{
name|p
operator|=
operator|(
name|Path
operator|*
operator|)
name|pundolist
operator|->
name|data
expr_stmt|;
name|path_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|pundolist
operator|=
name|g_slist_next
argument_list|(
name|pundolist
argument_list|)
expr_stmt|;
block|}
name|g_slist_free
argument_list|(
name|pundolist
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|path_transform_do_undo (GimpImage * gimage,PathUndo * pundo)
name|path_transform_do_undo
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|PathUndo
modifier|*
name|pundo
parameter_list|)
block|{
name|GSList
modifier|*
name|pundolist
decl_stmt|;
comment|/* Restore the paths as they were before this transform took place. */
name|Path
modifier|*
name|p_undo
decl_stmt|;
name|Path
modifier|*
name|p
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
name|gint
name|loop
decl_stmt|;
name|gboolean
name|preview_update
init|=
name|FALSE
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
comment|/* free data associated with the transform path undo */
for|for
control|(
name|pundolist
operator|=
name|pundo
init|;
name|pundolist
condition|;
name|pundolist
operator|=
name|g_slist_next
argument_list|(
name|pundolist
argument_list|)
control|)
block|{
name|p_undo
operator|=
operator|(
name|Path
operator|*
operator|)
name|pundolist
operator|->
name|data
expr_stmt|;
comment|/* Find the old path and replace it */
name|p
operator|=
name|path_get_path_by_tattoo
argument_list|(
name|gimage
argument_list|,
name|p_undo
operator|->
name|tattoo
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
comment|/* Path is still around... undo the transform stuff */
name|pathpoints_free
argument_list|(
name|p
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|p
operator|->
name|closed
operator|=
name|p_undo
operator|->
name|closed
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|p_undo
operator|->
name|state
expr_stmt|;
name|p
operator|->
name|pathtype
operator|=
name|p_undo
operator|->
name|pathtype
expr_stmt|;
name|p
operator|->
name|path_details
operator|=
name|pathpoints_copy
argument_list|(
name|p_undo
operator|->
name|path_details
argument_list|)
expr_stmt|;
name|preview_update
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|preview_update
operator|&&
name|paths_dialog
condition|)
block|{
comment|/* Heck the previews need updating...*/
name|plp
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|plist
operator|=
name|plp
operator|->
name|bz_paths
expr_stmt|;
name|loop
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|plist
operator|&&
name|g_slist_length
argument_list|(
name|plist
argument_list|)
operator|&&
name|paths_dialog
operator|->
name|current_path_list
condition|)
block|{
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|plist
operator|->
name|data
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|loop
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
name|loop
operator|++
expr_stmt|;
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
expr_stmt|;
block|}
comment|/* Force selection .. it may have changed */
if|if
condition|(
name|bezier_tool_selected
argument_list|()
operator|&&
name|paths_dialog
operator|->
name|current_path_list
condition|)
block|{
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|transform_func (GimpImage * gimage,int flip,gdouble x,gdouble y)
name|transform_func
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|int
name|flip
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
block|{
name|PathList
modifier|*
name|plp
decl_stmt|;
name|Path
modifier|*
name|p
decl_stmt|;
name|Path
modifier|*
name|p_copy
decl_stmt|;
name|GSList
modifier|*
name|points_list
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
name|gint
name|loop
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
comment|/* As a first off lets just translate the current path */
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return;
name|loop
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|plist
operator|=
name|plp
operator|->
name|bz_paths
init|;
name|plist
condition|;
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
control|)
block|{
name|p
operator|=
operator|(
name|Path
operator|*
operator|)
name|plist
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|locked
condition|)
block|{
name|p_copy
operator|=
name|p
expr_stmt|;
for|for
control|(
name|points_list
operator|=
name|p_copy
operator|->
name|path_details
init|;
name|points_list
condition|;
name|points_list
operator|=
name|g_slist_next
argument_list|(
name|points_list
argument_list|)
control|)
block|{
name|PathPoint
modifier|*
name|ppoint
init|=
name|points_list
operator|->
name|data
decl_stmt|;
if|if
condition|(
name|flip
condition|)
block|{
if|if
condition|(
name|x
operator|>
literal|0.0
condition|)
block|{
name|ppoint
operator|->
name|y
operator|=
name|gimage
operator|->
name|height
operator|-
name|ppoint
operator|->
name|y
expr_stmt|;
block|}
else|else
block|{
name|ppoint
operator|->
name|x
operator|=
name|gimage
operator|->
name|width
operator|-
name|ppoint
operator|->
name|x
expr_stmt|;
block|}
block|}
else|else
block|{
name|ppoint
operator|->
name|y
operator|+=
name|y
expr_stmt|;
name|ppoint
operator|->
name|x
operator|+=
name|x
expr_stmt|;
block|}
block|}
comment|/* Only update if we have a dialog, we have a currently  	   * selected path and its the showing the same image. 	   */
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|current_path_list
operator|&&
name|paths_dialog
operator|->
name|gimage
operator|==
name|gimage
condition|)
block|{
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|p_copy
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|loop
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
block|}
block|}
name|loop
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|path_transform_flip_horz (GimpImage * gimage)
name|path_transform_flip_horz
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|transform_func
argument_list|(
name|gimage
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|path_transform_flip_vert (GimpImage * gimage)
name|path_transform_flip_vert
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|transform_func
argument_list|(
name|gimage
argument_list|,
name|TRUE
argument_list|,
literal|1.0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|path_transform_xy (GimpImage * gimage,gint x,gint y)
name|path_transform_xy
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
name|transform_func
argument_list|(
name|gimage
argument_list|,
name|FALSE
argument_list|,
operator|(
name|gdouble
operator|)
name|x
argument_list|,
operator|(
name|gdouble
operator|)
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|path_transform_current_path (GimpImage * gimage,GimpMatrix3 transform,gboolean forpreview)
name|path_transform_current_path
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|GimpMatrix3
name|transform
parameter_list|,
name|gboolean
name|forpreview
parameter_list|)
block|{
name|PathList
modifier|*
name|plp
decl_stmt|;
name|Path
modifier|*
name|p
decl_stmt|;
name|Path
modifier|*
name|p_copy
decl_stmt|;
name|GSList
modifier|*
name|points_list
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
name|gint
name|loop
decl_stmt|;
name|gint
name|tmprow
decl_stmt|;
comment|/* As a first off lets just translate the current path */
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return;
name|loop
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|plist
operator|=
name|plp
operator|->
name|bz_paths
init|;
name|plist
condition|;
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
control|)
block|{
name|p
operator|=
operator|(
name|Path
operator|*
operator|)
name|plist
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|locked
condition|)
block|{
if|if
condition|(
name|forpreview
condition|)
name|p_copy
operator|=
name|path_copy
argument_list|(
name|NULL
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* NULL means dont want new tattoo */
else|else
name|p_copy
operator|=
name|p
expr_stmt|;
for|for
control|(
name|points_list
operator|=
name|p_copy
operator|->
name|path_details
init|;
name|points_list
condition|;
name|points_list
operator|=
name|g_slist_next
argument_list|(
name|points_list
argument_list|)
control|)
block|{
name|gdouble
name|newx
decl_stmt|,
name|newy
decl_stmt|;
name|PathPoint
modifier|*
name|ppoint
init|=
name|points_list
operator|->
name|data
decl_stmt|;
comment|/*       printf("[x,y] = [%g,%g]\n",ppoint->x, ppoint->y); */
name|gimp_matrix3_transform_point
argument_list|(
name|transform
argument_list|,
name|ppoint
operator|->
name|x
argument_list|,
name|ppoint
operator|->
name|y
argument_list|,
operator|&
name|newx
argument_list|,
operator|&
name|newy
argument_list|)
expr_stmt|;
comment|/*       printf("->[x,y] = [%g,%g]\n", newx, newy); */
name|ppoint
operator|->
name|x
operator|=
name|newx
expr_stmt|;
name|ppoint
operator|->
name|y
operator|=
name|newy
expr_stmt|;
block|}
comment|/* Only update if we have a dialog, we have a currently  	   * selected path and its the showing the same image. 	   */
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|current_path_list
operator|&&
name|paths_dialog
operator|->
name|gimage
operator|==
name|gimage
condition|)
block|{
comment|/* Now fudge the drawing....*/
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|p_copy
argument_list|)
expr_stmt|;
name|tmprow
operator|=
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|loop
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
name|tmprow
expr_stmt|;
name|paths_dialog
operator|->
name|selected_row_num
operator|=
name|tmprow
expr_stmt|;
block|}
if|if
condition|(
name|forpreview
condition|)
name|path_free
argument_list|(
name|p_copy
argument_list|)
expr_stmt|;
block|}
name|loop
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|path_transform_draw_current (GDisplay * gdisp,GimpDrawTool * draw_tool,GimpMatrix3 transform)
name|path_transform_draw_current
parameter_list|(
name|GDisplay
modifier|*
name|gdisp
parameter_list|,
name|GimpDrawTool
modifier|*
name|draw_tool
parameter_list|,
name|GimpMatrix3
name|transform
parameter_list|)
block|{
name|PathList
modifier|*
name|plp
decl_stmt|;
name|Path
modifier|*
name|bzp
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|Path
modifier|*
name|p_copy
decl_stmt|;
name|GSList
modifier|*
name|points_list
decl_stmt|;
name|GSList
modifier|*
name|plist
decl_stmt|;
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return;
for|for
control|(
name|plist
operator|=
name|plp
operator|->
name|bz_paths
init|;
name|plist
condition|;
name|plist
operator|=
name|g_slist_next
argument_list|(
name|plist
argument_list|)
control|)
block|{
name|bzp
operator|=
operator|(
name|Path
operator|*
operator|)
name|plist
operator|->
name|data
expr_stmt|;
comment|/* This image path is locked */
if|if
condition|(
name|bzp
operator|->
name|locked
condition|)
block|{
name|p_copy
operator|=
name|path_copy
argument_list|(
name|NULL
argument_list|,
name|bzp
argument_list|)
expr_stmt|;
comment|/* NULL means dont want new tattoo */
for|for
control|(
name|points_list
operator|=
name|p_copy
operator|->
name|path_details
init|;
name|points_list
condition|;
name|points_list
operator|=
name|g_slist_next
argument_list|(
name|points_list
argument_list|)
control|)
block|{
name|gdouble
name|newx
decl_stmt|,
name|newy
decl_stmt|;
name|PathPoint
modifier|*
name|ppoint
init|=
name|points_list
operator|->
name|data
decl_stmt|;
comment|/*       printf("[x,y] = [%g,%g]\n",ppoint->x, ppoint->y); */
name|gimp_matrix3_transform_point
argument_list|(
name|transform
argument_list|,
name|ppoint
operator|->
name|x
argument_list|,
name|ppoint
operator|->
name|y
argument_list|,
operator|&
name|newx
argument_list|,
operator|&
name|newy
argument_list|)
expr_stmt|;
comment|/*       printf("->[x,y] = [%g,%g]\n", newx, newy); */
name|ppoint
operator|->
name|x
operator|=
name|newx
expr_stmt|;
name|ppoint
operator|->
name|y
operator|=
name|newy
expr_stmt|;
block|}
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|p_copy
argument_list|)
expr_stmt|;
name|bezier_sel
operator|=
name|GIMP_BEZIER_SELECT_TOOL
argument_list|(
name|draw_tool
argument_list|)
expr_stmt|;
name|bezier_draw
argument_list|(
name|gdisp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|path_free
argument_list|(
name|p_copy
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/* PDB function aids                 */
end_comment

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/* Return TRUE if setting the path worked, else false */
end_comment

begin_function
name|gboolean
DECL|function|path_set_path (GimpImage * gimage,gchar * pname)
name|path_set_path
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gchar
modifier|*
name|pname
parameter_list|)
block|{
name|gint
name|row
init|=
literal|0
decl_stmt|;
name|gboolean
name|found
init|=
name|FALSE
decl_stmt|;
name|GSList
modifier|*
name|tlist
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return
name|FALSE
return|;
for|for
control|(
name|tlist
operator|=
name|plp
operator|->
name|bz_paths
init|;
name|tlist
condition|;
name|tlist
operator|=
name|g_slist_next
argument_list|(
name|tlist
argument_list|)
control|)
block|{
name|gchar
modifier|*
name|test_str
init|=
operator|(
operator|(
name|Path
operator|*
operator|)
operator|(
name|tlist
operator|->
name|data
operator|)
operator|)
operator|->
name|name
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pname
argument_list|,
name|test_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|row
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|paths_dialog
condition|)
block|{
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|plp
operator|->
name|last_selected_row
operator|=
name|row
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Set a path with the given set of points. */
end_comment

begin_comment
comment|/* We assume that there are enough points */
end_comment

begin_comment
comment|/* Return TRUE if path created OK. */
end_comment

begin_function
name|gboolean
DECL|function|path_set_path_points (GimpImage * gimage,gchar * pname,gint ptype,gint pclosed,gint num_pnts,gdouble * pnts)
name|path_set_path_points
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gchar
modifier|*
name|pname
parameter_list|,
name|gint
name|ptype
parameter_list|,
name|gint
name|pclosed
parameter_list|,
name|gint
name|num_pnts
parameter_list|,
name|gdouble
modifier|*
name|pnts
parameter_list|)
block|{
name|PathList
modifier|*
name|plist
init|=
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
decl_stmt|;
name|GSList
modifier|*
name|pts_list
init|=
name|NULL
decl_stmt|;
name|Path
modifier|*
name|bzpath
decl_stmt|;
name|GimpBezierSelectTool
modifier|*
name|bezier_sel
decl_stmt|;
name|gint
name|pcount
init|=
literal|0
decl_stmt|;
name|gint
name|this_path_count
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|num_pnts
operator|<
literal|6
operator|||
operator|(
name|pclosed
operator|&&
operator|(
operator|(
name|num_pnts
operator|/
literal|3
operator|)
operator|%
literal|3
operator|)
operator|)
operator|||
operator|(
operator|!
name|pclosed
operator|&&
operator|(
operator|(
name|num_pnts
operator|/
literal|3
operator|)
operator|%
literal|3
operator|)
operator|!=
literal|2
operator|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"wrong number of points\n"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|ptype
operator|!=
name|BEZIER
condition|)
name|ptype
operator|=
name|BEZIER
expr_stmt|;
while|while
condition|(
name|num_pnts
condition|)
block|{
name|PathPoint
modifier|*
name|bpt
decl_stmt|;
name|gint
name|type
decl_stmt|;
name|gdouble
name|x
decl_stmt|;
name|gdouble
name|y
decl_stmt|;
comment|/*       if((pcount/2)%3) */
comment|/* 	type = BEZIER_CONTROL; */
comment|/*       else */
comment|/* 	type = BEZIER_ANCHOR; */
name|x
operator|=
name|pnts
index|[
name|pcount
operator|++
index|]
expr_stmt|;
name|y
operator|=
name|pnts
index|[
name|pcount
operator|++
index|]
expr_stmt|;
name|type
operator|=
operator|(
name|gint
operator|)
name|pnts
index|[
name|pcount
operator|++
index|]
expr_stmt|;
name|this_path_count
operator|++
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|BEZIER_ANCHOR
case|:
case|case
name|BEZIER_CONTROL
case|:
break|break;
case|case
name|BEZIER_MOVE
case|:
if|if
condition|(
name|this_path_count
operator|<
literal|6
condition|)
block|{
name|g_warning
argument_list|(
literal|"Invalid single point in path\n"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|this_path_count
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"Invalid point type passed\n"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/*       printf("New point type = %s, x = %d y= %d\n", */
comment|/* 	     (type==BEZIER_CONTROL)?"CNTL":"ANCH", */
comment|/* 	     (int)x, */
comment|/* 	     (int)y); */
name|bpt
operator|=
name|path_point_new
argument_list|(
name|type
argument_list|,
operator|(
name|gdouble
operator|)
name|x
argument_list|,
operator|(
name|gdouble
operator|)
name|y
argument_list|)
expr_stmt|;
name|pts_list
operator|=
name|g_slist_append
argument_list|(
name|pts_list
argument_list|,
name|bpt
argument_list|)
expr_stmt|;
name|num_pnts
operator|-=
literal|3
expr_stmt|;
block|}
name|bzpath
operator|=
name|path_new
argument_list|(
name|gimage
argument_list|,
name|ptype
argument_list|,
name|pts_list
argument_list|,
name|pclosed
argument_list|,
operator|(
name|pclosed
operator|)
condition|?
name|BEZIER_EDIT
else|:
name|BEZIER_ADD
argument_list|,
comment|/* state */
literal|0
argument_list|,
comment|/* Can't be locked */
literal|0
argument_list|,
comment|/* No tattoo assigned */
name|pname
argument_list|)
expr_stmt|;
name|bezier_sel
operator|=
name|path_to_beziersel
argument_list|(
name|bzpath
argument_list|)
expr_stmt|;
comment|/* Only add if paths dialog showing this window */
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|gimage
operator|==
name|gimage
condition|)
block|{
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|path_add_to_current
argument_list|(
name|paths_dialog
operator|->
name|current_path_list
argument_list|,
name|bzpath
argument_list|,
name|paths_dialog
operator|->
name|gimage
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|paths_add_path
argument_list|(
name|bzpath
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Update the preview */
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
operator|=
literal|0
expr_stmt|;
name|paths_update_preview
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
name|gtk_clist_select_row
argument_list|(
name|GTK_CLIST
argument_list|(
name|paths_dialog
operator|->
name|paths_list
argument_list|)
argument_list|,
name|paths_dialog
operator|->
name|current_path_list
operator|->
name|last_selected_row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|paths_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|GDisplay
modifier|*
name|gdisp
decl_stmt|;
if|if
condition|(
operator|!
name|plist
condition|)
block|{
comment|/* If we haven't got a paths dialog */
name|GSList
modifier|*
name|bzp_list
init|=
name|NULL
decl_stmt|;
name|bzp_list
operator|=
name|g_slist_append
argument_list|(
name|bzp_list
argument_list|,
name|bzpath
argument_list|)
expr_stmt|;
name|plist
operator|=
name|path_list_new
argument_list|(
name|gimage
argument_list|,
literal|0
argument_list|,
name|bzp_list
argument_list|)
expr_stmt|;
name|gimp_image_set_paths
argument_list|(
name|gimage
argument_list|,
name|plist
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|path_add_to_current
argument_list|(
name|plist
argument_list|,
name|bzpath
argument_list|,
name|gimage
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* This is a little HACK.. we need to find a display        * to put the path image on.        */
name|gdisp
operator|=
name|gdisplays_check_valid
argument_list|(
name|NULL
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
comment|/* Mark this path as selected */
name|plist
operator|->
name|last_selected_row
operator|=
literal|0
expr_stmt|;
comment|/* Only paste if we have an image to paste to! */
if|if
condition|(
name|gdisp
condition|)
name|bezier_paste_bezierselect_to_current
argument_list|(
name|gdisp
argument_list|,
name|bezier_sel
argument_list|)
expr_stmt|;
block|}
name|bezier_select_free
argument_list|(
name|bezier_sel
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|gboolean
DECL|function|path_delete_path (GimpImage * gimage,gchar * pname)
name|path_delete_path
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gchar
modifier|*
name|pname
parameter_list|)
block|{
name|gint
name|row
init|=
literal|0
decl_stmt|;
name|gboolean
name|found
init|=
name|FALSE
decl_stmt|;
name|GSList
modifier|*
name|tlist
decl_stmt|;
name|PathList
modifier|*
name|plp
decl_stmt|;
if|if
condition|(
operator|!
name|pname
operator|||
operator|!
name|gimage
condition|)
block|{
name|g_warning
argument_list|(
literal|"paths_delete_path: invalid path"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Removed the named path ... */
comment|/* Get bzpath structure  */
name|plp
operator|=
operator|(
name|PathList
operator|*
operator|)
name|gimp_image_get_paths
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|plp
condition|)
return|return
name|FALSE
return|;
for|for
control|(
name|tlist
operator|=
name|plp
operator|->
name|bz_paths
init|;
name|tlist
condition|;
name|tlist
operator|=
name|g_slist_next
argument_list|(
name|tlist
argument_list|)
control|)
block|{
name|gchar
modifier|*
name|test_str
init|=
operator|(
operator|(
name|Path
operator|*
operator|)
operator|(
name|tlist
operator|->
name|data
operator|)
operator|)
operator|->
name|name
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pname
argument_list|,
name|test_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|row
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
name|FALSE
return|;
name|plp
operator|->
name|bz_paths
operator|=
name|g_slist_remove
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|,
name|tlist
operator|->
name|data
argument_list|)
expr_stmt|;
comment|/* If now empty free everything up */
if|if
condition|(
operator|!
name|plp
operator|->
name|bz_paths
operator|||
name|g_slist_length
argument_list|(
name|plp
operator|->
name|bz_paths
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gtk_signal_disconnect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|plp
operator|->
name|gimage
argument_list|)
argument_list|,
name|plp
operator|->
name|sig_id
argument_list|)
expr_stmt|;
name|gimp_image_set_paths
argument_list|(
name|plp
operator|->
name|gimage
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|path_list_free
argument_list|(
name|plp
argument_list|)
expr_stmt|;
block|}
comment|/* Redisplay if required */
if|if
condition|(
name|paths_dialog
operator|&&
name|paths_dialog
operator|->
name|gimage
operator|==
name|gimage
condition|)
block|{
name|paths_dialog
operator|->
name|current_path_list
operator|=
name|NULL
expr_stmt|;
name|paths_dialog_flush
argument_list|()
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

end_unit

