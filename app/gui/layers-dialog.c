begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<gdk/gdkkeysyms.h>
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"colormaps.h"
end_include

begin_include
include|#
directive|include
file|"drawable.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"floating_sel.h"
end_include

begin_include
include|#
directive|include
file|"gdisplay.h"
end_include

begin_include
include|#
directive|include
file|"gimage.h"
end_include

begin_include
include|#
directive|include
file|"gimage_mask.h"
end_include

begin_include
include|#
directive|include
file|"gimpdnd.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"gimpui.h"
end_include

begin_include
include|#
directive|include
file|"image_render.h"
end_include

begin_include
include|#
directive|include
file|"layers_dialog.h"
end_include

begin_include
include|#
directive|include
file|"layers_dialogP.h"
end_include

begin_include
include|#
directive|include
file|"lc_dialogP.h"
end_include

begin_include
include|#
directive|include
file|"menus.h"
end_include

begin_include
include|#
directive|include
file|"ops_buttons.h"
end_include

begin_include
include|#
directive|include
file|"resize.h"
end_include

begin_include
include|#
directive|include
file|"undo.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimplimits.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpsizeentry.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_include
include|#
directive|include
file|"pixmaps/eye.xbm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/linked.xbm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/layer.xbm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/mask.xbm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/new.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/raise.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/lower.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/duplicate.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/delete.xpm"
end_include

begin_include
include|#
directive|include
file|"pixmaps/anchor.xpm"
end_include

begin_include
include|#
directive|include
file|"layer_pvt.h"
end_include

begin_define
DECL|macro|LAYER_PREVIEW
define|#
directive|define
name|LAYER_PREVIEW
value|0
end_define

begin_define
DECL|macro|MASK_PREVIEW
define|#
directive|define
name|MASK_PREVIEW
value|1
end_define

begin_define
DECL|macro|FS_PREVIEW
define|#
directive|define
name|FS_PREVIEW
value|2
end_define

begin_typedef
DECL|typedef|LayersDialog
typedef|typedef
name|struct
name|_LayersDialog
name|LayersDialog
typedef|;
end_typedef

begin_struct
DECL|struct|_LayersDialog
struct|struct
name|_LayersDialog
block|{
DECL|member|vbox
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
DECL|member|mode_option_menu
name|GtkWidget
modifier|*
name|mode_option_menu
decl_stmt|;
DECL|member|layer_list
name|GtkWidget
modifier|*
name|layer_list
decl_stmt|;
DECL|member|scrolled_win
name|GtkWidget
modifier|*
name|scrolled_win
decl_stmt|;
DECL|member|preserve_trans
name|GtkWidget
modifier|*
name|preserve_trans
decl_stmt|;
DECL|member|mode_box
name|GtkWidget
modifier|*
name|mode_box
decl_stmt|;
DECL|member|opacity_box
name|GtkWidget
modifier|*
name|opacity_box
decl_stmt|;
DECL|member|ops_menu
name|GtkWidget
modifier|*
name|ops_menu
decl_stmt|;
DECL|member|accel_group
name|GtkAccelGroup
modifier|*
name|accel_group
decl_stmt|;
DECL|member|opacity_data
name|GtkAdjustment
modifier|*
name|opacity_data
decl_stmt|;
DECL|member|red_gc
name|GdkGC
modifier|*
name|red_gc
decl_stmt|;
comment|/*  for non-applied layer masks  */
DECL|member|green_gc
name|GdkGC
modifier|*
name|green_gc
decl_stmt|;
comment|/*  for visible layer masks      */
DECL|member|layer_preview
name|GtkWidget
modifier|*
name|layer_preview
decl_stmt|;
DECL|member|ratio
name|gdouble
name|ratio
decl_stmt|;
DECL|member|image_width
DECL|member|image_height
name|gint
name|image_width
decl_stmt|,
name|image_height
decl_stmt|;
DECL|member|gimage_width
DECL|member|gimage_height
name|gint
name|gimage_width
decl_stmt|,
name|gimage_height
decl_stmt|;
comment|/*  state information  */
DECL|member|gimage
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
DECL|member|active_layer
name|Layer
modifier|*
name|active_layer
decl_stmt|;
DECL|member|active_channel
name|Channel
modifier|*
name|active_channel
decl_stmt|;
DECL|member|floating_sel
name|Layer
modifier|*
name|floating_sel
decl_stmt|;
DECL|member|layer_widgets
name|GSList
modifier|*
name|layer_widgets
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
DECL|typedef|LayerWidget
typedef|typedef
name|struct
name|_LayerWidget
name|LayerWidget
typedef|;
end_typedef

begin_struct
DECL|struct|_LayerWidget
struct|struct
name|_LayerWidget
block|{
DECL|member|eye_widget
name|GtkWidget
modifier|*
name|eye_widget
decl_stmt|;
DECL|member|linked_widget
name|GtkWidget
modifier|*
name|linked_widget
decl_stmt|;
DECL|member|clip_widget
name|GtkWidget
modifier|*
name|clip_widget
decl_stmt|;
DECL|member|layer_preview
name|GtkWidget
modifier|*
name|layer_preview
decl_stmt|;
DECL|member|mask_preview
name|GtkWidget
modifier|*
name|mask_preview
decl_stmt|;
DECL|member|list_item
name|GtkWidget
modifier|*
name|list_item
decl_stmt|;
DECL|member|label
name|GtkWidget
modifier|*
name|label
decl_stmt|;
DECL|member|gimage
name|GImage
modifier|*
name|gimage
decl_stmt|;
DECL|member|layer
name|Layer
modifier|*
name|layer
decl_stmt|;
DECL|member|layer_pixmap
name|GdkPixmap
modifier|*
name|layer_pixmap
decl_stmt|;
DECL|member|mask_pixmap
name|GdkPixmap
modifier|*
name|mask_pixmap
decl_stmt|;
DECL|member|active_preview
name|gint
name|active_preview
decl_stmt|;
DECL|member|width
DECL|member|height
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
comment|/*  state information  */
DECL|member|layer_mask
name|gboolean
name|layer_mask
decl_stmt|;
DECL|member|apply_mask
name|gboolean
name|apply_mask
decl_stmt|;
DECL|member|edit_mask
name|gboolean
name|edit_mask
decl_stmt|;
DECL|member|show_mask
name|gboolean
name|show_mask
decl_stmt|;
DECL|member|visited
name|gboolean
name|visited
decl_stmt|;
DECL|member|drop_type
name|GimpDropType
name|drop_type
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  layers dialog widget routines  */
end_comment

begin_function_decl
specifier|static
name|void
name|layers_dialog_preview_extents
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_set_menu_sensitivity
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_scroll_index
parameter_list|(
name|gint
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_set_active_layer
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_unset_layer
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_position_layer
parameter_list|(
name|Layer
modifier|*
parameter_list|,
name|gint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_add_layer
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_remove_layer
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_add_layer_mask
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_remove_layer_mask
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|paint_mode_menu_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|opacity_scale_update
parameter_list|(
name|GtkAdjustment
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preserve_trans_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|layer_list_events
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  for (un)installing the menu accelarators  */
end_comment

begin_function_decl
specifier|static
name|void
name|layers_dialog_map_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_unmap_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  ops buttons dnd callbacks  */
end_comment

begin_function_decl
specifier|static
name|gboolean
name|layers_dialog_drag_new_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkDragContext
modifier|*
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|,
name|guint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|layers_dialog_drag_duplicate_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkDragContext
modifier|*
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|,
name|guint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|layers_dialog_drag_trashcan_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkDragContext
modifier|*
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|,
name|guint
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  layer widget function prototypes  */
end_comment

begin_function_decl
specifier|static
name|LayerWidget
modifier|*
name|layer_widget_get_ID
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|LayerWidget
modifier|*
name|layer_widget_create
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|layer_widget_drag_motion_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkDragContext
modifier|*
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|,
name|guint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|layer_widget_drag_drop_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkDragContext
modifier|*
parameter_list|,
name|gint
parameter_list|,
name|gint
parameter_list|,
name|guint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_drag_begin_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkDragContext
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_mask_drag_begin_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkDragContext
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_drag_leave_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkDragContext
modifier|*
parameter_list|,
name|guint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_drag_indicator_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_draw_drop_indicator
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|,
name|GimpDropType
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_delete
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_select_update
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|layer_widget_button_events
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|layer_widget_preview_events
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|GdkEvent
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_boundary_redraw
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_preview_redraw
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_no_preview_redraw
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_eye_redraw
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_linked_redraw
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_clip_redraw
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_exclusive_visible
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layer_widget_layer_flush
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  assorted query dialogs  */
end_comment

begin_function_decl
specifier|static
name|void
name|layers_dialog_new_layer_query
parameter_list|(
name|GimpImage
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_edit_layer_query
parameter_list|(
name|LayerWidget
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_add_mask_query
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_apply_mask_query
parameter_list|(
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_scale_layer_query
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|layers_dialog_resize_layer_query
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|Layer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|layers_dialog_layer_merge_query
parameter_list|(
name|GImage
modifier|*
parameter_list|,
name|gboolean
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/****************/
end_comment

begin_comment
comment|/*  Local data  */
end_comment

begin_comment
comment|/****************/
end_comment

begin_decl_stmt
DECL|variable|layersD
specifier|static
name|LayersDialog
modifier|*
name|layersD
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|eye_pixmap
specifier|static
name|GdkPixmap
modifier|*
name|eye_pixmap
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|linked_pixmap
specifier|static
name|GdkPixmap
modifier|*
name|linked_pixmap
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|layer_pixmap
specifier|static
name|GdkPixmap
modifier|*
name|layer_pixmap
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mask_pixmap
specifier|static
name|GdkPixmap
modifier|*
name|mask_pixmap
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|suspend_gimage_notify
specifier|static
name|gint
name|suspend_gimage_notify
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  the ops buttons  */
end_comment

begin_decl_stmt
DECL|variable|raise_layers_ext_callbacks
specifier|static
name|GtkSignalFunc
name|raise_layers_ext_callbacks
index|[]
init|=
block|{
name|layers_dialog_raise_layer_to_top_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|lower_layers_ext_callbacks
specifier|static
name|GtkSignalFunc
name|lower_layers_ext_callbacks
index|[]
init|=
block|{
name|layers_dialog_lower_layer_to_bottom_callback
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|layers_ops_buttons
specifier|static
name|OpsButton
name|layers_ops_buttons
index|[]
init|=
block|{
block|{
name|new_xpm
block|,
name|layers_dialog_new_layer_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"New Layer"
argument_list|)
block|,
literal|"layers/dialogs/new_layer.html"
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|raise_xpm
block|,
name|layers_dialog_raise_layer_callback
block|,
name|raise_layers_ext_callbacks
block|,
name|N_
argument_list|(
literal|"Raise Layer    \n"
literal|"<Shift> To Top"
argument_list|)
block|,
literal|"layers/stack/stack.html#raise_layer"
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|lower_xpm
block|,
name|layers_dialog_lower_layer_callback
block|,
name|lower_layers_ext_callbacks
block|,
name|N_
argument_list|(
literal|"Lower Layer       \n"
literal|"<Shift> To Bottom"
argument_list|)
block|,
literal|"layers/stack/stack.html#lower_layer"
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|duplicate_xpm
block|,
name|layers_dialog_duplicate_layer_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Duplicate Layer"
argument_list|)
block|,
literal|"layers/duplicate_layer.html"
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|anchor_xpm
block|,
name|layers_dialog_anchor_layer_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Anchor Layer"
argument_list|)
block|,
literal|"layers/anchor_layer.html"
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|delete_xpm
block|,
name|layers_dialog_delete_layer_callback
block|,
name|NULL
block|,
name|N_
argument_list|(
literal|"Delete Layer"
argument_list|)
block|,
literal|"layers/delete_layer.html"
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  dnd structures  */
end_comment

begin_decl_stmt
DECL|variable|layer_target_table
specifier|static
name|GtkTargetEntry
name|layer_target_table
index|[]
init|=
block|{
name|GIMP_TARGET_LAYER
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|n_layer_targets
specifier|static
name|guint
name|n_layer_targets
init|=
operator|(
sizeof|sizeof
argument_list|(
name|layer_target_table
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|layer_target_table
index|[
literal|0
index|]
argument_list|)
operator|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|layer_mask_target_table
specifier|static
name|GtkTargetEntry
name|layer_mask_target_table
index|[]
init|=
block|{
name|GIMP_TARGET_LAYER_MASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|n_layer_mask_targets
specifier|static
name|guint
name|n_layer_mask_targets
init|=
operator|(
sizeof|sizeof
argument_list|(
name|layer_mask_target_table
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|layer_mask_target_table
index|[
literal|0
index|]
argument_list|)
operator|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|trashcan_target_table
specifier|static
name|GtkTargetEntry
name|trashcan_target_table
index|[]
init|=
block|{
name|GIMP_TARGET_LAYER
block|,
name|GIMP_TARGET_LAYER_MASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|n_trashcan_targets
specifier|static
name|guint
name|n_trashcan_targets
init|=
operator|(
sizeof|sizeof
argument_list|(
name|trashcan_target_table
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|trashcan_target_table
index|[
literal|0
index|]
argument_list|)
operator|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/************************************/
end_comment

begin_comment
comment|/*  Public layers dialog functions  */
end_comment

begin_comment
comment|/************************************/
end_comment

begin_function
name|GtkWidget
modifier|*
DECL|function|layers_dialog_create (void)
name|layers_dialog_create
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|util_box
decl_stmt|;
name|GtkWidget
modifier|*
name|button_box
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|slider
decl_stmt|;
if|if
condition|(
name|layersD
condition|)
return|return
name|layersD
operator|->
name|vbox
return|;
name|layersD
operator|=
name|g_new
argument_list|(
name|LayersDialog
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|layer_preview
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|gimage
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|active_layer
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|active_channel
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|floating_sel
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|layer_widgets
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|green_gc
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|red_gc
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|preview_size
condition|)
block|{
name|layersD
operator|->
name|layer_preview
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_COLOR
argument_list|)
expr_stmt|;
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|layersD
operator|->
name|layer_preview
argument_list|)
argument_list|,
name|preview_size
argument_list|,
name|preview_size
argument_list|)
expr_stmt|;
block|}
comment|/*  The main vbox  */
name|layersD
operator|->
name|vbox
operator|=
name|gtk_event_box_new
argument_list|()
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|layersD
operator|->
name|vbox
argument_list|,
name|NULL
argument_list|,
literal|"dialogs/layers/layers.html"
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|layersD
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
comment|/*  The layers commands pulldown menu  */
name|menus_get_layers_menu
argument_list|(
operator|&
name|layersD
operator|->
name|ops_menu
argument_list|,
operator|&
name|layersD
operator|->
name|accel_group
argument_list|)
expr_stmt|;
comment|/*  The Mode option menu, and the preserve transparency  */
name|layersD
operator|->
name|mode_box
operator|=
name|util_box
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|util_box
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Mode:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|mode_option_menu
operator|=
name|gimp_option_menu_new2
argument_list|(
name|FALSE
argument_list|,
name|paint_mode_menu_callback
argument_list|,
name|NULL
argument_list|,
operator|(
name|gpointer
operator|)
name|NORMAL_MODE
argument_list|,
name|_
argument_list|(
literal|"Normal"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|NORMAL_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Dissolve"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|DISSOLVE_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Multiply (Burn)"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|MULTIPLY_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Divide (Dodge)"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|DIVIDE_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Screen"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|SCREEN_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Overlay"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|OVERLAY_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Difference"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|DIFFERENCE_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Addition"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|ADDITION_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Subtract"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|SUBTRACT_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Darken Only"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|DARKEN_ONLY_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Lighten Only"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|LIGHTEN_ONLY_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Hue"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|HUE_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Saturation"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|SATURATION_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Color"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|COLOR_MODE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Value"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|VALUE_MODE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|layersD
operator|->
name|mode_option_menu
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layersD
operator|->
name|mode_option_menu
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|layersD
operator|->
name|mode_option_menu
argument_list|,
name|NULL
argument_list|,
literal|"#paint_mode_menu"
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|preserve_trans
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Keep Trans."
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|layersD
operator|->
name|preserve_trans
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layersD
operator|->
name|preserve_trans
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|preserve_trans_update
argument_list|,
name|layersD
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layersD
operator|->
name|preserve_trans
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|layersD
operator|->
name|preserve_trans
argument_list|,
name|NULL
argument_list|,
literal|"#keep_trans_button"
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|util_box
argument_list|)
expr_stmt|;
comment|/*  Opacity scale  */
name|layersD
operator|->
name|opacity_box
operator|=
name|util_box
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|util_box
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Opacity:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|opacity_data
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|gtk_adjustment_new
argument_list|(
literal|100.0
argument_list|,
literal|0.0
argument_list|,
literal|100.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
name|slider
operator|=
name|gtk_hscale_new
argument_list|(
name|layersD
operator|->
name|opacity_data
argument_list|)
expr_stmt|;
name|gtk_range_set_update_policy
argument_list|(
name|GTK_RANGE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_UPDATE_CONTINUOUS
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|slider
argument_list|)
argument_list|,
name|GTK_POS_RIGHT
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|util_box
argument_list|)
argument_list|,
name|slider
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layersD
operator|->
name|opacity_data
argument_list|)
argument_list|,
literal|"value_changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|opacity_scale_update
argument_list|,
name|layersD
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|slider
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|slider
argument_list|,
name|NULL
argument_list|,
literal|"#opacity_scale"
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|util_box
argument_list|)
expr_stmt|;
comment|/*  The layers listbox  */
name|layersD
operator|->
name|scrolled_win
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|layersD
operator|->
name|scrolled_win
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_ALWAYS
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|layersD
operator|->
name|scrolled_win
argument_list|,
name|LIST_WIDTH
argument_list|,
name|LIST_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|layersD
operator|->
name|scrolled_win
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|layer_list
operator|=
name|gtk_list_new
argument_list|()
expr_stmt|;
name|gtk_scrolled_window_add_with_viewport
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|layersD
operator|->
name|scrolled_win
argument_list|)
argument_list|,
name|layersD
operator|->
name|layer_list
argument_list|)
expr_stmt|;
name|gtk_list_set_selection_mode
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|GTK_SELECTION_BROWSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_list_events
argument_list|,
name|layersD
argument_list|)
expr_stmt|;
name|gtk_container_set_focus_vadjustment
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|gtk_scrolled_window_get_vadjustment
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|layersD
operator|->
name|scrolled_win
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|layersD
operator|->
name|scrolled_win
argument_list|)
operator|->
name|vscrollbar
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layersD
operator|->
name|scrolled_win
argument_list|)
expr_stmt|;
comment|/*  The ops buttons  */
name|button_box
operator|=
name|ops_button_box_new
argument_list|(
name|lc_dialog
operator|->
name|shell
argument_list|,
name|layers_ops_buttons
argument_list|,
name|OPS_BUTTON_NORMAL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button_box
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button_box
argument_list|)
expr_stmt|;
comment|/*  Drop to new  */
name|gtk_drag_dest_set
argument_list|(
name|layers_ops_buttons
index|[
literal|0
index|]
operator|.
name|widget
argument_list|,
name|GTK_DEST_DEFAULT_ALL
argument_list|,
name|layer_target_table
argument_list|,
name|n_layer_targets
argument_list|,
name|GDK_ACTION_COPY
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layers_ops_buttons
index|[
literal|0
index|]
operator|.
name|widget
argument_list|)
argument_list|,
literal|"drag_drop"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|layers_dialog_drag_new_layer_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  Drop to duplicate  */
name|gtk_drag_dest_set
argument_list|(
name|layers_ops_buttons
index|[
literal|3
index|]
operator|.
name|widget
argument_list|,
name|GTK_DEST_DEFAULT_ALL
argument_list|,
name|layer_target_table
argument_list|,
name|n_layer_targets
argument_list|,
name|GDK_ACTION_COPY
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layers_ops_buttons
index|[
literal|3
index|]
operator|.
name|widget
argument_list|)
argument_list|,
literal|"drag_drop"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|layers_dialog_drag_duplicate_layer_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  Drop to trahcan  */
name|gtk_drag_dest_set
argument_list|(
name|layers_ops_buttons
index|[
literal|5
index|]
operator|.
name|widget
argument_list|,
name|GTK_DEST_DEFAULT_ALL
argument_list|,
name|trashcan_target_table
argument_list|,
name|n_trashcan_targets
argument_list|,
name|GDK_ACTION_COPY
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layers_ops_buttons
index|[
literal|5
index|]
operator|.
name|widget
argument_list|)
argument_list|,
literal|"drag_drop"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|layers_dialog_drag_trashcan_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  Set up signals for map/unmap for the accelerators  */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layersD
operator|->
name|vbox
argument_list|)
argument_list|,
literal|"map"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layers_dialog_map_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layersD
operator|->
name|vbox
argument_list|)
argument_list|,
literal|"unmap"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layers_dialog_unmap_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layersD
operator|->
name|vbox
argument_list|)
expr_stmt|;
return|return
name|layersD
operator|->
name|vbox
return|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_free (void)
name|layers_dialog_free
parameter_list|(
name|void
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|lw
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
if|if
condition|(
name|layersD
operator|==
name|NULL
condition|)
return|return;
comment|/*  Free all elements in the layers listbox  */
name|gtk_list_clear_items
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|list
operator|=
name|layersD
operator|->
name|layer_widgets
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|lw
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|layer_widget_delete
argument_list|(
name|lw
argument_list|)
expr_stmt|;
block|}
name|layersD
operator|->
name|layer_widgets
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|active_layer
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|active_channel
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|floating_sel
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|layersD
operator|->
name|layer_preview
condition|)
name|gtk_object_sink
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layersD
operator|->
name|layer_preview
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|layersD
operator|->
name|green_gc
condition|)
name|gdk_gc_destroy
argument_list|(
name|layersD
operator|->
name|green_gc
argument_list|)
expr_stmt|;
if|if
condition|(
name|layersD
operator|->
name|red_gc
condition|)
name|gdk_gc_destroy
argument_list|(
name|layersD
operator|->
name|red_gc
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|layersD
argument_list|)
expr_stmt|;
name|layersD
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_invalidate_previews (GimpImage * gimage)
name|layers_dialog_invalidate_previews
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|GSList
modifier|*
name|list
init|=
name|gimage
operator|->
name|layers
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
comment|/*  Invalidate all previews ...    *  This is called during loading the image    */
while|while
condition|(
name|list
condition|)
block|{
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|preview_valid
operator|=
name|FALSE
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_update (GimpImage * gimage)
name|layers_dialog_update
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|Layer
modifier|*
name|layer
decl_stmt|;
name|LayerWidget
modifier|*
name|lw
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
name|GList
modifier|*
name|item_list
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
name|layersD
operator|->
name|gimage
operator|==
name|gimage
condition|)
return|return;
name|layersD
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
comment|/*  Make sure the gimage is not notified of this change  */
name|suspend_gimage_notify
operator|++
expr_stmt|;
comment|/*  Free all elements in the layers listbox  */
name|gtk_list_clear_items
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|list
operator|=
name|layersD
operator|->
name|layer_widgets
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|lw
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|layer_widget_delete
argument_list|(
name|lw
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|layersD
operator|->
name|layer_widgets
condition|)
name|g_warning
argument_list|(
literal|"layers_dialog_update(): layersD->layer_widgets not empty!"
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|layer_widgets
operator|=
name|NULL
expr_stmt|;
comment|/*  Find the preview extents  */
name|layers_dialog_preview_extents
argument_list|()
expr_stmt|;
name|layersD
operator|->
name|active_layer
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|active_channel
operator|=
name|NULL
expr_stmt|;
name|layersD
operator|->
name|floating_sel
operator|=
name|NULL
expr_stmt|;
name|item_list
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|list
operator|=
name|gimage
operator|->
name|layers
init|;
name|list
condition|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
control|)
block|{
comment|/*  create a layer list item  */
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|lw
operator|=
name|layer_widget_create
argument_list|(
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|layer_widgets
operator|=
name|g_slist_append
argument_list|(
name|layersD
operator|->
name|layer_widgets
argument_list|,
name|lw
argument_list|)
expr_stmt|;
name|item_list
operator|=
name|g_list_append
argument_list|(
name|item_list
argument_list|,
name|lw
operator|->
name|list_item
argument_list|)
expr_stmt|;
block|}
comment|/*  get the index of the active layer  */
if|if
condition|(
name|item_list
condition|)
name|gtk_list_insert_items
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|item_list
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|suspend_gimage_notify
operator|--
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_flush (void)
name|layers_dialog_flush
parameter_list|(
name|void
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|LayerWidget
modifier|*
name|lw
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
name|gint
name|pos
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
comment|/*  Make sure the gimage is not notified of this change  */
name|suspend_gimage_notify
operator|++
expr_stmt|;
comment|/*  Check if the gimage extents have changed  */
if|if
condition|(
operator|(
name|gimage
operator|->
name|width
operator|!=
name|layersD
operator|->
name|gimage_width
operator|)
operator|||
operator|(
name|gimage
operator|->
name|height
operator|!=
name|layersD
operator|->
name|gimage_height
operator|)
condition|)
block|{
name|layersD
operator|->
name|gimage
operator|=
name|NULL
expr_stmt|;
name|layers_dialog_update
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*  Set all current layer widgets to visited = FALSE  */
for|for
control|(
name|list
operator|=
name|layersD
operator|->
name|layer_widgets
init|;
name|list
condition|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|lw
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|lw
operator|->
name|visited
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/*  Add any missing layers  */
for|for
control|(
name|list
operator|=
name|gimage
operator|->
name|layers
init|;
name|list
condition|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|lw
operator|=
name|layer_widget_get_ID
argument_list|(
name|layer
argument_list|)
expr_stmt|;
comment|/*  If the layer isn't in the layer widget list, add it  */
if|if
condition|(
name|lw
operator|==
name|NULL
condition|)
block|{
comment|/*  sets visited = TRUE  */
name|layers_dialog_add_layer
argument_list|(
name|layer
argument_list|)
expr_stmt|;
block|}
else|else
name|lw
operator|->
name|visited
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/*  Remove any extraneous layers  */
name|list
operator|=
name|layersD
operator|->
name|layer_widgets
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|lw
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|lw
operator|->
name|visited
operator|==
name|FALSE
condition|)
name|layers_dialog_remove_layer
argument_list|(
name|lw
operator|->
name|layer
argument_list|)
expr_stmt|;
block|}
comment|/*  Switch positions of items if necessary  */
name|pos
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|list
operator|=
name|gimage
operator|->
name|layers
init|;
name|list
condition|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|layers_dialog_position_layer
argument_list|(
name|layer
argument_list|,
name|pos
operator|++
argument_list|)
expr_stmt|;
block|}
comment|/*  Set the active layer  */
if|if
condition|(
name|layersD
operator|->
name|active_layer
operator|!=
name|gimage
operator|->
name|active_layer
condition|)
name|layersD
operator|->
name|active_layer
operator|=
name|gimage
operator|->
name|active_layer
expr_stmt|;
comment|/*  Set the active channel  */
if|if
condition|(
name|layersD
operator|->
name|active_channel
operator|!=
name|gimage
operator|->
name|active_channel
condition|)
name|layersD
operator|->
name|active_channel
operator|=
name|gimage
operator|->
name|active_channel
expr_stmt|;
comment|/*  set the menus if floating sel status has changed  */
if|if
condition|(
name|layersD
operator|->
name|floating_sel
operator|!=
name|gimage
operator|->
name|floating_sel
condition|)
name|layersD
operator|->
name|floating_sel
operator|=
name|gimage
operator|->
name|floating_sel
expr_stmt|;
name|layers_dialog_set_menu_sensitivity
argument_list|()
expr_stmt|;
name|gtk_container_foreach
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|layer_widget_layer_flush
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|suspend_gimage_notify
operator|--
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_clear (void)
name|layers_dialog_clear
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|layersD
condition|)
return|return;
name|suspend_gimage_notify
operator|++
expr_stmt|;
name|gtk_list_clear_items
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|suspend_gimage_notify
operator|--
expr_stmt|;
name|layersD
operator|->
name|gimage
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/***********************/
end_comment

begin_comment
comment|/*  Preview functions  */
end_comment

begin_comment
comment|/***********************/
end_comment

begin_function
name|void
DECL|function|render_preview (TempBuf * preview_buf,GtkWidget * preview_widget,int width,int height,int channel)
name|render_preview
parameter_list|(
name|TempBuf
modifier|*
name|preview_buf
parameter_list|,
name|GtkWidget
modifier|*
name|preview_widget
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|unsigned
name|char
modifier|*
name|cb
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|a
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|b
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|int
name|rowstride
decl_stmt|;
name|int
name|color_buf
decl_stmt|;
name|int
name|color
decl_stmt|;
name|int
name|alpha
decl_stmt|;
name|int
name|has_alpha
decl_stmt|;
name|int
name|image_bytes
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|alpha
operator|=
name|ALPHA_PIX
expr_stmt|;
comment|/*  Here are the different cases this functions handles correctly:    *  1)  Offset preview_buf which does not necessarily cover full image area    *  2)  Color conversion of preview_buf if it is gray and image is color    *  3)  Background check buffer for transparent preview_bufs    *  4)  Using the optional "channel" argument, one channel can be extracted    *      from a multi-channel preview_buf and composited as a grayscale    *  Prereqs:    *  1)  Grayscale preview_bufs have bytes == {1, 2}    *  2)  Color preview_bufs have bytes == {3, 4}    *  3)  If image is gray, then preview_buf should have bytes == {1, 2}    */
name|color_buf
operator|=
operator|(
name|GTK_PREVIEW
argument_list|(
name|preview_widget
argument_list|)
operator|->
name|type
operator|==
name|GTK_PREVIEW_COLOR
operator|)
expr_stmt|;
name|image_bytes
operator|=
operator|(
name|color_buf
operator|)
condition|?
literal|3
else|:
literal|1
expr_stmt|;
name|has_alpha
operator|=
operator|(
name|preview_buf
operator|->
name|bytes
operator|==
literal|2
operator|||
name|preview_buf
operator|->
name|bytes
operator|==
literal|4
operator|)
expr_stmt|;
name|rowstride
operator|=
name|preview_buf
operator|->
name|width
operator|*
name|preview_buf
operator|->
name|bytes
expr_stmt|;
comment|/*  Determine if the preview buf supplied is color    *   Generally, if the bytes == {3, 4}, this is true.    *   However, if the channel argument supplied is not -1, then    *   the preview buf is assumed to be gray despite the number of    *   channels it contains    */
name|color
operator|=
operator|(
name|preview_buf
operator|->
name|bytes
operator|==
literal|3
operator|||
name|preview_buf
operator|->
name|bytes
operator|==
literal|4
operator|)
operator|&&
operator|(
name|channel
operator|==
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|has_alpha
condition|)
block|{
name|buf
operator|=
name|check_buf
expr_stmt|;
name|alpha
operator|=
operator|(
name|color
operator|)
condition|?
name|ALPHA_PIX
else|:
operator|(
operator|(
name|channel
operator|!=
operator|-
literal|1
operator|)
condition|?
operator|(
name|preview_buf
operator|->
name|bytes
operator|-
literal|1
operator|)
else|:
name|ALPHA_G_PIX
operator|)
expr_stmt|;
block|}
else|else
name|buf
operator|=
name|empty_buf
expr_stmt|;
name|x1
operator|=
name|CLAMP
argument_list|(
name|preview_buf
operator|->
name|x
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|y1
operator|=
name|CLAMP
argument_list|(
name|preview_buf
operator|->
name|y
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|x2
operator|=
name|CLAMP
argument_list|(
name|preview_buf
operator|->
name|x
operator|+
name|preview_buf
operator|->
name|width
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|y2
operator|=
name|CLAMP
argument_list|(
name|preview_buf
operator|->
name|y
operator|+
name|preview_buf
operator|->
name|height
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|src
operator|=
name|temp_buf_data
argument_list|(
name|preview_buf
argument_list|)
operator|+
operator|(
name|y1
operator|-
name|preview_buf
operator|->
name|y
operator|)
operator|*
name|rowstride
operator|+
operator|(
name|x1
operator|-
name|preview_buf
operator|->
name|x
operator|)
operator|*
name|preview_buf
operator|->
name|bytes
expr_stmt|;
comment|/*  One last thing for efficiency's sake:  */
if|if
condition|(
name|channel
operator|==
operator|-
literal|1
condition|)
name|channel
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|height
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|&
literal|0x4
condition|)
block|{
name|offset
operator|=
literal|4
expr_stmt|;
name|cb
operator|=
name|buf
operator|+
name|offset
operator|*
literal|3
expr_stmt|;
block|}
else|else
block|{
name|offset
operator|=
literal|0
expr_stmt|;
name|cb
operator|=
name|buf
expr_stmt|;
block|}
comment|/*  The interesting stuff between leading& trailing vertical transparency  */
if|if
condition|(
name|i
operator|>=
name|y1
operator|&&
name|i
operator|<
name|y2
condition|)
block|{
comment|/*  Handle the leading transparency  */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|x1
condition|;
name|j
operator|++
control|)
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|image_bytes
condition|;
name|b
operator|++
control|)
name|temp_buf
index|[
name|j
operator|*
name|image_bytes
operator|+
name|b
index|]
operator|=
name|cb
index|[
name|j
operator|*
literal|3
operator|+
name|b
index|]
expr_stmt|;
comment|/*  The stuff in the middle  */
name|s
operator|=
name|src
expr_stmt|;
for|for
control|(
name|j
operator|=
name|x1
init|;
name|j
operator|<
name|x2
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|color
condition|)
block|{
if|if
condition|(
name|has_alpha
condition|)
block|{
name|a
operator|=
name|s
index|[
name|alpha
index|]
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|+
name|offset
operator|)
operator|&
literal|0x4
condition|)
block|{
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|0
index|]
operator|=
name|blend_dark_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|RED_PIX
index|]
operator|)
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|blend_dark_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GREEN_PIX
index|]
operator|)
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|blend_dark_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|BLUE_PIX
index|]
operator|)
index|]
expr_stmt|;
block|}
else|else
block|{
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|0
index|]
operator|=
name|blend_light_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|RED_PIX
index|]
operator|)
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|blend_light_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GREEN_PIX
index|]
operator|)
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|blend_light_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|BLUE_PIX
index|]
operator|)
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|0
index|]
operator|=
name|s
index|[
name|RED_PIX
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|s
index|[
name|GREEN_PIX
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|s
index|[
name|BLUE_PIX
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|has_alpha
condition|)
block|{
name|a
operator|=
name|s
index|[
name|alpha
index|]
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|+
name|offset
operator|)
operator|&
literal|0x4
condition|)
block|{
if|if
condition|(
name|color_buf
condition|)
block|{
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|0
index|]
operator|=
name|blend_dark_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GRAY_PIX
index|]
operator|)
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|blend_dark_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GRAY_PIX
index|]
operator|)
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|blend_dark_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GRAY_PIX
index|]
operator|)
index|]
expr_stmt|;
block|}
else|else
name|temp_buf
index|[
name|j
index|]
operator|=
name|blend_dark_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GRAY_PIX
operator|+
name|channel
index|]
operator|)
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|color_buf
condition|)
block|{
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|0
index|]
operator|=
name|blend_light_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GRAY_PIX
index|]
operator|)
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|blend_light_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GRAY_PIX
index|]
operator|)
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|blend_light_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GRAY_PIX
index|]
operator|)
index|]
expr_stmt|;
block|}
else|else
name|temp_buf
index|[
name|j
index|]
operator|=
name|blend_light_check
index|[
operator|(
name|a
operator||
name|s
index|[
name|GRAY_PIX
operator|+
name|channel
index|]
operator|)
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|color_buf
condition|)
block|{
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|0
index|]
operator|=
name|s
index|[
name|GRAY_PIX
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|s
index|[
name|GRAY_PIX
index|]
expr_stmt|;
name|temp_buf
index|[
name|j
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|s
index|[
name|GRAY_PIX
index|]
expr_stmt|;
block|}
else|else
name|temp_buf
index|[
name|j
index|]
operator|=
name|s
index|[
name|GRAY_PIX
operator|+
name|channel
index|]
expr_stmt|;
block|}
block|}
name|s
operator|+=
name|preview_buf
operator|->
name|bytes
expr_stmt|;
block|}
comment|/*  Handle the trailing transparency  */
for|for
control|(
name|j
operator|=
name|x2
init|;
name|j
operator|<
name|width
condition|;
name|j
operator|++
control|)
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|image_bytes
condition|;
name|b
operator|++
control|)
name|temp_buf
index|[
name|j
operator|*
name|image_bytes
operator|+
name|b
index|]
operator|=
name|cb
index|[
name|j
operator|*
literal|3
operator|+
name|b
index|]
expr_stmt|;
name|src
operator|+=
name|rowstride
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|width
condition|;
name|j
operator|++
control|)
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|image_bytes
condition|;
name|b
operator|++
control|)
name|temp_buf
index|[
name|j
operator|*
name|image_bytes
operator|+
name|b
index|]
operator|=
name|cb
index|[
name|j
operator|*
literal|3
operator|+
name|b
index|]
expr_stmt|;
block|}
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|preview_widget
argument_list|)
argument_list|,
name|temp_buf
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|width
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|render_fs_preview (GtkWidget * widget,GdkPixmap * pixmap)
name|render_fs_preview
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkPixmap
modifier|*
name|pixmap
parameter_list|)
block|{
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|GdkPoint
name|poly
index|[
literal|6
index|]
decl_stmt|;
name|int
name|foldh
decl_stmt|,
name|foldw
decl_stmt|;
name|int
name|i
decl_stmt|;
name|gdk_window_get_size
argument_list|(
name|pixmap
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
name|x1
operator|=
literal|2
expr_stmt|;
name|y1
operator|=
name|h
operator|/
literal|8
operator|+
literal|2
expr_stmt|;
name|x2
operator|=
name|w
operator|-
name|w
operator|/
literal|8
operator|-
literal|2
expr_stmt|;
name|y2
operator|=
name|h
operator|-
literal|2
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
literal|0
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|)
expr_stmt|;
name|foldw
operator|=
name|w
operator|/
literal|4
expr_stmt|;
name|foldh
operator|=
name|h
operator|/
literal|4
expr_stmt|;
name|x1
operator|=
name|w
operator|/
literal|8
operator|+
literal|2
expr_stmt|;
name|y1
operator|=
literal|2
expr_stmt|;
name|x2
operator|=
name|w
operator|-
literal|2
expr_stmt|;
name|y2
operator|=
name|h
operator|-
name|h
operator|/
literal|8
operator|-
literal|2
expr_stmt|;
name|poly
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|x1
operator|+
name|foldw
expr_stmt|;
name|poly
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|y1
expr_stmt|;
name|poly
index|[
literal|1
index|]
operator|.
name|x
operator|=
name|x1
operator|+
name|foldw
expr_stmt|;
name|poly
index|[
literal|1
index|]
operator|.
name|y
operator|=
name|y1
operator|+
name|foldh
expr_stmt|;
name|poly
index|[
literal|2
index|]
operator|.
name|x
operator|=
name|x1
expr_stmt|;
name|poly
index|[
literal|2
index|]
operator|.
name|y
operator|=
name|y1
operator|+
name|foldh
expr_stmt|;
name|poly
index|[
literal|3
index|]
operator|.
name|x
operator|=
name|x1
expr_stmt|;
name|poly
index|[
literal|3
index|]
operator|.
name|y
operator|=
name|y2
expr_stmt|;
name|poly
index|[
literal|4
index|]
operator|.
name|x
operator|=
name|x2
expr_stmt|;
name|poly
index|[
literal|4
index|]
operator|.
name|y
operator|=
name|y2
expr_stmt|;
name|poly
index|[
literal|5
index|]
operator|.
name|x
operator|=
name|x2
expr_stmt|;
name|poly
index|[
literal|5
index|]
operator|.
name|y
operator|=
name|y1
expr_stmt|;
name|gdk_draw_polygon
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|white_gc
argument_list|,
literal|1
argument_list|,
name|poly
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|x1
argument_list|,
name|y1
operator|+
name|foldh
argument_list|,
name|x1
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|x1
argument_list|,
name|y2
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|,
name|x2
argument_list|,
name|y1
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|x1
operator|+
name|foldw
argument_list|,
name|y1
argument_list|,
name|x2
argument_list|,
name|y1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|foldw
condition|;
name|i
operator|++
control|)
name|gdk_draw_line
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|x1
operator|+
name|i
argument_list|,
name|y1
operator|+
name|foldh
argument_list|,
name|x1
operator|+
name|i
argument_list|,
operator|(
name|foldw
operator|==
literal|1
operator|)
condition|?
name|y1
else|:
operator|(
name|y1
operator|+
operator|(
name|foldh
operator|-
operator|(
name|foldh
operator|*
name|i
operator|)
operator|/
operator|(
name|foldw
operator|-
literal|1
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************/
end_comment

begin_comment
comment|/*  layers dialog widget routines    */
end_comment

begin_comment
comment|/*************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|layers_dialog_preview_extents (void)
name|layers_dialog_preview_extents
parameter_list|(
name|void
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
condition|)
return|return;
name|gimage
operator|=
name|layersD
operator|->
name|gimage
expr_stmt|;
name|layersD
operator|->
name|gimage_width
operator|=
name|gimage
operator|->
name|width
expr_stmt|;
name|layersD
operator|->
name|gimage_height
operator|=
name|gimage
operator|->
name|height
expr_stmt|;
comment|/*  Get the image width and height variables, based on the gimage  */
if|if
condition|(
name|gimage
operator|->
name|width
operator|>
name|gimage
operator|->
name|height
condition|)
name|layersD
operator|->
name|ratio
operator|=
operator|(
name|double
operator|)
name|preview_size
operator|/
operator|(
name|double
operator|)
name|gimage
operator|->
name|width
expr_stmt|;
else|else
name|layersD
operator|->
name|ratio
operator|=
operator|(
name|double
operator|)
name|preview_size
operator|/
operator|(
name|double
operator|)
name|gimage
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|preview_size
condition|)
block|{
name|layersD
operator|->
name|image_width
operator|=
call|(
name|int
call|)
argument_list|(
name|layersD
operator|->
name|ratio
operator|*
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|image_height
operator|=
call|(
name|int
call|)
argument_list|(
name|layersD
operator|->
name|ratio
operator|*
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|layersD
operator|->
name|image_width
operator|<
literal|1
condition|)
name|layersD
operator|->
name|image_width
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|layersD
operator|->
name|image_height
operator|<
literal|1
condition|)
name|layersD
operator|->
name|image_height
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|layersD
operator|->
name|image_width
operator|=
name|layer_width
expr_stmt|;
name|layersD
operator|->
name|image_height
operator|=
name|layer_height
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_set_menu_sensitivity (void)
name|layers_dialog_set_menu_sensitivity
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|fs
decl_stmt|;
comment|/*  floating sel  */
name|gint
name|ac
decl_stmt|;
comment|/*  active channel  */
name|gint
name|lm
decl_stmt|;
comment|/*  layer mask  */
name|gint
name|gimage
decl_stmt|;
comment|/*  is there a gimage  */
name|gint
name|lp
decl_stmt|;
comment|/*  layers present  */
name|gint
name|alpha
decl_stmt|;
comment|/*  alpha channel present  */
name|gint
name|next_alpha
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
name|GSList
modifier|*
name|next
decl_stmt|;
name|GSList
modifier|*
name|prev
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|lp
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|!
name|layersD
condition|)
return|return;
if|if
condition|(
operator|(
name|layer
operator|=
operator|(
name|layersD
operator|->
name|active_layer
operator|)
operator|)
operator|!=
name|NULL
condition|)
name|lm
operator|=
operator|(
name|layer
operator|->
name|mask
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
else|else
name|lm
operator|=
name|FALSE
expr_stmt|;
name|fs
operator|=
operator|(
name|layersD
operator|->
name|floating_sel
operator|==
name|NULL
operator|)
expr_stmt|;
name|ac
operator|=
operator|(
name|layersD
operator|->
name|active_channel
operator|==
name|NULL
operator|)
expr_stmt|;
name|gimage
operator|=
operator|(
name|layersD
operator|->
name|gimage
operator|!=
name|NULL
operator|)
expr_stmt|;
name|alpha
operator|=
name|layer
operator|&&
name|layer_has_alpha
argument_list|(
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimage
condition|)
name|lp
operator|=
operator|(
name|layersD
operator|->
name|gimage
operator|->
name|layers
operator|!=
name|NULL
operator|)
expr_stmt|;
name|list
operator|=
name|layersD
operator|->
name|gimage
operator|->
name|layers
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|next
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|layer
operator|==
operator|(
name|layersD
operator|->
name|active_layer
operator|)
condition|)
block|{
name|next
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|list
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|next
condition|)
block|{
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|next
operator|->
name|data
expr_stmt|;
name|next_alpha
operator|=
name|layer_has_alpha
argument_list|(
name|layer
argument_list|)
expr_stmt|;
block|}
else|else
name|next_alpha
operator|=
name|FALSE
expr_stmt|;
DECL|macro|SET_SENSITIVE (menu,condition)
define|#
directive|define
name|SET_SENSITIVE
parameter_list|(
name|menu
parameter_list|,
name|condition
parameter_list|)
define|\
value|menus_set_sensitive ("<Layers>/" menu, (condition) != 0)
DECL|macro|SET_OPS_SENSITIVE (button,condition)
define|#
directive|define
name|SET_OPS_SENSITIVE
parameter_list|(
name|button
parameter_list|,
name|condition
parameter_list|)
define|\
value|gtk_widget_set_sensitive (layers_ops_buttons[(button)].widget, \                                  (condition) != 0)
name|SET_SENSITIVE
argument_list|(
literal|"New Layer..."
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|0
argument_list|,
name|gimage
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Stack/Raise Layer"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
operator|&&
name|alpha
operator|&&
name|prev
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|1
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
operator|&&
name|alpha
operator|&&
name|prev
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Stack/Lower Layer"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
operator|&&
name|next
operator|&&
name|next_alpha
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|2
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
operator|&&
name|next
operator|&&
name|next_alpha
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Stack/Layer to Top"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
operator|&&
name|alpha
operator|&&
name|prev
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Stack/Layer to Bottom"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
operator|&&
name|next
operator|&&
name|next_alpha
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Duplicate Layer"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|3
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Anchor Layer"
argument_list|,
operator|!
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|4
argument_list|,
operator|!
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Delete Layer"
argument_list|,
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_OPS_SENSITIVE
argument_list|(
literal|5
argument_list|,
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layer Boundary Size..."
argument_list|,
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layer to Imagesize"
argument_list|,
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Scale Layer..."
argument_list|,
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Merge Visible Layers..."
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Merge Down"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Flatten Image"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Add Layer Mask..."
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
operator|!
name|lm
operator|&&
name|lp
operator|&&
name|alpha
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Apply Layer Mask..."
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lm
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Mask to Selection"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lm
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Add Alpha Channel"
argument_list|,
operator|!
name|alpha
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Alpha to Selection"
argument_list|,
name|fs
operator|&&
name|ac
operator|&&
name|gimage
operator|&&
name|lp
operator|&&
name|alpha
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit Layer Attributes..."
argument_list|,
name|ac
operator|&&
name|gimage
operator|&&
name|lp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SET_OPS_SENSITIVE
undef|#
directive|undef
name|SET_SENSITIVE
comment|/*  set mode, preserve transparency and opacity to insensitive    *  if there are no layers    */
name|gtk_widget_set_sensitive
argument_list|(
name|layersD
operator|->
name|preserve_trans
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|layersD
operator|->
name|opacity_box
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|layersD
operator|->
name|mode_box
argument_list|,
name|lp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_scroll_index (gint index)
name|layers_dialog_scroll_index
parameter_list|(
name|gint
name|index
parameter_list|)
block|{
name|GtkAdjustment
modifier|*
name|adj
decl_stmt|;
name|gint
name|item_height
decl_stmt|;
name|item_height
operator|=
literal|6
operator|+
operator|(
name|preview_size
condition|?
name|preview_size
else|:
name|layer_height
operator|)
expr_stmt|;
name|adj
operator|=
name|gtk_scrolled_window_get_vadjustment
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|layersD
operator|->
name|scrolled_win
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|*
name|item_height
operator|<
name|adj
operator|->
name|value
condition|)
block|{
name|adj
operator|->
name|value
operator|=
name|index
operator|*
name|item_height
expr_stmt|;
name|gtk_adjustment_value_changed
argument_list|(
name|adj
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|index
operator|+
literal|1
operator|)
operator|*
name|item_height
operator|>
name|adj
operator|->
name|value
operator|+
name|adj
operator|->
name|page_size
condition|)
block|{
name|adj
operator|->
name|value
operator|=
operator|(
name|index
operator|+
literal|1
operator|)
operator|*
name|item_height
operator|-
name|adj
operator|->
name|page_size
expr_stmt|;
name|gtk_adjustment_value_changed
argument_list|(
name|adj
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_set_active_layer (Layer * layer)
name|layers_dialog_set_active_layer
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|GtkStateType
name|state
decl_stmt|;
name|gint
name|index
decl_stmt|;
name|layer_widget
operator|=
name|layer_widget_get_ID
argument_list|(
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
name|layer_widget
condition|)
return|return;
comment|/*  Make sure the gimage is not notified of this change  */
name|suspend_gimage_notify
operator|++
expr_stmt|;
name|state
operator|=
name|layer_widget
operator|->
name|list_item
operator|->
name|state
expr_stmt|;
name|index
operator|=
name|gimage_get_layer_index
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|index
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|state
operator|!=
name|GTK_STATE_SELECTED
operator|)
condition|)
block|{
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_list_select_item
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|layers_dialog_scroll_index
argument_list|(
name|index
argument_list|)
expr_stmt|;
block|}
name|suspend_gimage_notify
operator|--
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_unset_layer (Layer * layer)
name|layers_dialog_unset_layer
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|GtkStateType
name|state
decl_stmt|;
name|gint
name|index
decl_stmt|;
name|layer_widget
operator|=
name|layer_widget_get_ID
argument_list|(
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
name|layer_widget
condition|)
return|return;
comment|/*  Make sure the gimage is not notified of this change  */
name|suspend_gimage_notify
operator|++
expr_stmt|;
name|state
operator|=
name|layer_widget
operator|->
name|list_item
operator|->
name|state
expr_stmt|;
name|index
operator|=
name|gimage_get_layer_index
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|index
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|state
operator|==
name|GTK_STATE_SELECTED
operator|)
condition|)
block|{
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_list_unselect_item
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
block|}
name|suspend_gimage_notify
operator|--
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_position_layer (Layer * layer,gint new_index)
name|layers_dialog_position_layer
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|,
name|gint
name|new_index
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|GList
modifier|*
name|list
init|=
name|NULL
decl_stmt|;
name|layer_widget
operator|=
name|layer_widget_get_ID
argument_list|(
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
name|layer_widget
condition|)
return|return;
if|if
condition|(
name|new_index
operator|==
name|g_slist_index
argument_list|(
name|layersD
operator|->
name|layer_widgets
argument_list|,
name|layer_widget
argument_list|)
condition|)
return|return;
comment|/*  Make sure the gimage is not notified of this change  */
name|suspend_gimage_notify
operator|++
expr_stmt|;
comment|/*  Remove the layer from the dialog  */
name|list
operator|=
name|g_list_append
argument_list|(
name|list
argument_list|,
name|layer_widget
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|gtk_list_remove_items
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|layer_widgets
operator|=
name|g_slist_remove
argument_list|(
name|layersD
operator|->
name|layer_widgets
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
comment|/*  Add it back at the proper index  */
name|gtk_list_insert_items
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|list
argument_list|,
name|new_index
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|layer_widgets
operator|=
name|g_slist_insert
argument_list|(
name|layersD
operator|->
name|layer_widgets
argument_list|,
name|layer_widget
argument_list|,
name|new_index
argument_list|)
expr_stmt|;
comment|/*  Adjust the scrollbar so the layer is visible  */
name|layers_dialog_scroll_index
argument_list|(
name|new_index
operator|>
literal|0
condition|?
name|new_index
operator|+
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|suspend_gimage_notify
operator|--
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_add_layer (Layer * layer)
name|layers_dialog_add_layer
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|GList
modifier|*
name|item_list
decl_stmt|;
name|gint
name|position
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
name|layer
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|item_list
operator|=
name|NULL
expr_stmt|;
name|layer_widget
operator|=
name|layer_widget_create
argument_list|(
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
name|item_list
operator|=
name|g_list_append
argument_list|(
name|item_list
argument_list|,
name|layer_widget
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|position
operator|=
name|gimage_get_layer_index
argument_list|(
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|layer_widgets
operator|=
name|g_slist_insert
argument_list|(
name|layersD
operator|->
name|layer_widgets
argument_list|,
name|layer_widget
argument_list|,
name|position
argument_list|)
expr_stmt|;
name|gtk_list_insert_items
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|item_list
argument_list|,
name|position
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_remove_layer (Layer * layer)
name|layers_dialog_remove_layer
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|GList
modifier|*
name|list
init|=
name|NULL
decl_stmt|;
name|layer_widget
operator|=
name|layer_widget_get_ID
argument_list|(
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
name|layer_widget
condition|)
return|return;
comment|/*  Make sure the gimage is not notified of this change  */
name|suspend_gimage_notify
operator|++
expr_stmt|;
comment|/*  Remove the requested layer from the dialog  */
name|list
operator|=
name|g_list_append
argument_list|(
name|list
argument_list|,
name|layer_widget
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|gtk_list_remove_items
argument_list|(
name|GTK_LIST
argument_list|(
name|layersD
operator|->
name|layer_list
argument_list|)
argument_list|,
name|list
argument_list|)
expr_stmt|;
comment|/*  Delete layer widget  */
name|layer_widget_delete
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
name|suspend_gimage_notify
operator|--
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_add_layer_mask (Layer * layer)
name|layers_dialog_add_layer_mask
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|layer_widget
operator|=
name|layer_widget_get_ID
argument_list|(
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
name|layer_widget
condition|)
return|return;
if|if
condition|(
operator|!
name|GTK_WIDGET_VISIBLE
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
condition|)
block|{
name|gtk_object_set_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
argument_list|,
literal|"gimp_layer_mask"
argument_list|,
name|layer_get_mask
argument_list|(
name|layer
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
expr_stmt|;
block|}
name|layer_widget
operator|->
name|active_preview
operator|=
name|MASK_PREVIEW
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|layer_widget
operator|->
name|layer_preview
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_remove_layer_mask (Layer * layer)
name|layers_dialog_remove_layer_mask
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|layer_widget
operator|=
name|layer_widget_get_ID
argument_list|(
name|layer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
name|layer_widget
condition|)
return|return;
if|if
condition|(
name|GTK_WIDGET_VISIBLE
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
condition|)
block|{
name|gtk_object_set_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
argument_list|,
literal|"gimp_layer_mask"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
expr_stmt|;
block|}
name|layer_widget
operator|->
name|active_preview
operator|=
name|LAYER_PREVIEW
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|layer_widget
operator|->
name|layer_preview
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************/
end_comment

begin_comment
comment|/*  paint mode, opacity& preserve trans. functions  */
end_comment

begin_comment
comment|/*****************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|paint_mode_menu_callback (GtkWidget * widget,gpointer data)
name|paint_mode_menu_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|LayerModeEffects
name|mode
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
operator|||
operator|!
operator|(
name|layer
operator|=
name|gimage
operator|->
name|active_layer
operator|)
condition|)
return|return;
comment|/*  If the layer has an alpha channel, set the transparency and redraw  */
if|if
condition|(
name|layer_has_alpha
argument_list|(
name|layer
argument_list|)
condition|)
block|{
name|mode
operator|=
operator|(
name|LayerModeEffects
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer
operator|->
name|mode
operator|!=
name|mode
condition|)
block|{
name|layer
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|drawable_update
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|width
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|height
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|opacity_scale_update (GtkAdjustment * adjustment,gpointer data)
name|opacity_scale_update
parameter_list|(
name|GtkAdjustment
modifier|*
name|adjustment
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|gint
name|opacity
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
operator|||
operator|!
operator|(
name|layer
operator|=
name|gimage
operator|->
name|active_layer
operator|)
condition|)
return|return;
comment|/*  add the 0.001 to insure there are no subtle rounding errors  */
name|opacity
operator|=
call|(
name|int
call|)
argument_list|(
name|adjustment
operator|->
name|value
operator|*
literal|2.55
operator|+
literal|0.001
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer
operator|->
name|opacity
operator|!=
name|opacity
condition|)
block|{
name|layer
operator|->
name|opacity
operator|=
name|opacity
expr_stmt|;
name|drawable_update
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|width
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|height
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|preserve_trans_update (GtkWidget * widget,gpointer data)
name|preserve_trans_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
operator|||
operator|!
operator|(
name|layer
operator|=
name|gimage
operator|->
name|active_layer
operator|)
condition|)
return|return;
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
operator|->
name|active
condition|)
name|layer
operator|->
name|preserve_trans
operator|=
name|TRUE
expr_stmt|;
else|else
name|layer
operator|->
name|preserve_trans
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/********************************/
end_comment

begin_comment
comment|/*  layer list events callback  */
end_comment

begin_comment
comment|/********************************/
end_comment

begin_function
specifier|static
name|gint
DECL|function|layer_list_events (GtkWidget * widget,GdkEvent * event,gpointer data)
name|layer_list_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
name|GtkWidget
modifier|*
name|event_widget
decl_stmt|;
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|event_widget
operator|=
name|gtk_get_event_widget
argument_list|(
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|GTK_IS_LIST_ITEM
argument_list|(
name|event_widget
argument_list|)
condition|)
block|{
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_widget
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_BUTTON_PRESS
case|:
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
name|bevent
operator|->
name|button
operator|==
literal|3
condition|)
block|{
name|gtk_menu_popup
argument_list|(
name|GTK_MENU
argument_list|(
name|layersD
operator|->
name|ops_menu
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|bevent
operator|->
name|button
argument_list|,
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|GDK_2BUTTON_PRESS
case|:
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
name|layers_dialog_edit_layer_query
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
default|default:
break|break;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/*****************************/
end_comment

begin_comment
comment|/*  layers dialog callbacks  */
end_comment

begin_comment
comment|/*****************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|layers_dialog_map_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_map_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
operator|!
name|layersD
condition|)
return|return;
name|gtk_window_add_accel_group
argument_list|(
name|GTK_WINDOW
argument_list|(
name|lc_dialog
operator|->
name|shell
argument_list|)
argument_list|,
name|layersD
operator|->
name|accel_group
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_unmap_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_unmap_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
operator|!
name|layersD
condition|)
return|return;
name|gtk_window_remove_accel_group
argument_list|(
name|GTK_WINDOW
argument_list|(
name|lc_dialog
operator|->
name|shell
argument_list|)
argument_list|,
name|layersD
operator|->
name|accel_group
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***********************************/
end_comment

begin_comment
comment|/*  callbacks exported to menus.c  */
end_comment

begin_comment
comment|/***********************************/
end_comment

begin_function
name|void
DECL|function|layers_dialog_previous_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_previous_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|new_layer
decl_stmt|;
name|gint
name|current_layer
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|current_layer
operator|=
name|gimage_get_layer_index
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
comment|/*  FIXME: don't use internal knowledge about layer lists    *  TODO : implement gimage_get_layer_by_index()    */
name|new_layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|gimage
operator|->
name|layers
argument_list|,
name|current_layer
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_layer
condition|)
block|{
name|gimage_set_active_layer
argument_list|(
name|gimage
argument_list|,
name|new_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_next_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_next_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|new_layer
decl_stmt|;
name|gint
name|current_layer
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|current_layer
operator|=
name|gimage_get_layer_index
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
comment|/*  FIXME: don't use internal knowledge about layer lists    *  TODO : implement gimage_get_layer_by_index()    */
name|new_layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|g_slist_nth_data
argument_list|(
name|gimage
operator|->
name|layers
argument_list|,
name|current_layer
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_layer
condition|)
block|{
name|gimage_set_active_layer
argument_list|(
name|gimage
argument_list|,
name|new_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_raise_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_raise_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage_raise_layer
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_lower_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_lower_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage_lower_layer
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_raise_layer_to_top_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_raise_layer_to_top_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage_raise_layer_to_top
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_lower_layer_to_bottom_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_lower_layer_to_bottom_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage_lower_layer_to_bottom
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_new_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_new_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
comment|/*  If there is a floating selection, the new command transforms    *  the current fs into a new layer    */
if|if
condition|(
operator|(
name|layer
operator|=
name|gimage_floating_sel
argument_list|(
name|gimage
argument_list|)
operator|)
condition|)
block|{
name|floating_sel_to_layer
argument_list|(
name|layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
else|else
name|layers_dialog_new_layer_query
argument_list|(
name|layersD
operator|->
name|gimage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_duplicate_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_duplicate_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|active_layer
decl_stmt|;
name|Layer
modifier|*
name|new_layer
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
comment|/*  Start a group undo  */
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|LAYER_ADD_UNDO
argument_list|)
expr_stmt|;
name|active_layer
operator|=
name|gimage_get_active_layer
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|new_layer
operator|=
name|layer_copy
argument_list|(
name|active_layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimage_add_layer
argument_list|(
name|gimage
argument_list|,
name|new_layer
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*  End the group undo  */
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_delete_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_delete_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
operator|||
operator|!
operator|(
name|layer
operator|=
name|gimage_get_active_layer
argument_list|(
name|gimage
argument_list|)
operator|)
condition|)
return|return;
comment|/*  if the layer is a floating selection, take special care  */
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_remove
argument_list|(
name|layer
argument_list|)
expr_stmt|;
else|else
name|gimage_remove_layer
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_scale_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_scale_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|layers_dialog_scale_layer_query
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_resize_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_resize_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|layers_dialog_resize_layer_query
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_resize_to_image_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_resize_to_image_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|layer_resize_to_image
argument_list|(
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_add_layer_mask_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_add_layer_mask_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|layers_dialog_add_mask_query
argument_list|(
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_apply_layer_mask_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_apply_layer_mask_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
comment|/*  Make sure there is a layer mask to apply  */
if|if
condition|(
operator|(
name|layer
operator|=
name|gimage
operator|->
name|active_layer
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|layer
operator|->
name|mask
condition|)
name|layers_dialog_apply_mask_query
argument_list|(
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_anchor_layer_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_anchor_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|floating_sel_anchor
argument_list|(
name|gimage_get_active_layer
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_merge_layers_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_merge_layers_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|layers_dialog_layer_merge_query
argument_list|(
name|gimage
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_merge_down_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_merge_down_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimp_image_merge_down
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|,
name|EXPAND_AS_NECESSARY
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_flatten_image_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_flatten_image_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage_flatten
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_alpha_select_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_alpha_select_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage_mask_layer_alpha
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_mask_select_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_mask_select_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
condition|)
return|return;
name|gimage_mask_layer_mask
argument_list|(
name|gimage
argument_list|,
name|gimage
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_add_alpha_channel_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_add_alpha_channel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
operator|||
operator|!
operator|(
name|gimage
operator|=
name|layersD
operator|->
name|gimage
operator|)
operator|||
operator|!
operator|(
name|layer
operator|=
name|gimage_get_active_layer
argument_list|(
name|gimage
argument_list|)
operator|)
condition|)
return|return;
name|layer_add_alpha
argument_list|(
name|layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_edit_layer_attributes_callback (GtkWidget * widget,gpointer data)
name|layers_dialog_edit_layer_attributes_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
name|layersD
operator|&&
name|layersD
operator|->
name|active_layer
condition|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|layer_widget
operator|=
name|layer_widget_get_ID
argument_list|(
name|layersD
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|layers_dialog_edit_layer_query
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*******************************/
end_comment

begin_comment
comment|/*  ops buttons dnd callbacks  */
end_comment

begin_comment
comment|/*******************************/
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|layers_dialog_drag_new_layer_callback (GtkWidget * widget,GdkDragContext * context,gint x,gint y,guint time)
name|layers_dialog_drag_new_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkDragContext
modifier|*
name|context
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guint
name|time
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|src_widget
decl_stmt|;
name|gboolean
name|return_val
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|(
name|src_widget
operator|=
name|gtk_drag_get_source_widget
argument_list|(
name|context
argument_list|)
operator|)
condition|)
block|{
name|Layer
modifier|*
name|layer
init|=
name|NULL
decl_stmt|;
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|gtk_object_get_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|src_widget
argument_list|)
argument_list|,
literal|"gimp_layer"
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer
operator|&&
name|layer
operator|==
name|layersD
operator|->
name|active_layer
condition|)
block|{
name|Layer
modifier|*
name|new_layer
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gint
name|off_x
decl_stmt|,
name|off_y
decl_stmt|;
name|gimage
operator|=
name|layersD
operator|->
name|gimage
expr_stmt|;
name|width
operator|=
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
expr_stmt|;
name|height
operator|=
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
comment|/*  Start a group undo  */
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|EDIT_PASTE_UNDO
argument_list|)
expr_stmt|;
name|new_layer
operator|=
name|layer_new
argument_list|(
name|gimage
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|gimage_base_type_with_alpha
argument_list|(
name|gimage
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Empty Layer Copy"
argument_list|)
argument_list|,
name|layer
operator|->
name|opacity
argument_list|,
name|layer
operator|->
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_layer
condition|)
block|{
name|drawable_fill
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|new_layer
argument_list|)
argument_list|,
name|TRANSPARENT_FILL
argument_list|)
expr_stmt|;
name|layer_translate
argument_list|(
name|new_layer
argument_list|,
name|off_x
argument_list|,
name|off_y
argument_list|)
expr_stmt|;
name|gimage_add_layer
argument_list|(
name|gimage
argument_list|,
name|new_layer
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*  End the group undo  */
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|g_message
argument_list|(
literal|"layers_dialog_drop_new_layer_callback():\n"
literal|"could not allocate new layer"
argument_list|)
expr_stmt|;
block|}
name|return_val
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
name|gtk_drag_finish
argument_list|(
name|context
argument_list|,
name|return_val
argument_list|,
name|FALSE
argument_list|,
name|time
argument_list|)
expr_stmt|;
return|return
name|return_val
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|layers_dialog_drag_duplicate_layer_callback (GtkWidget * widget,GdkDragContext * context,gint x,gint y,guint time)
name|layers_dialog_drag_duplicate_layer_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkDragContext
modifier|*
name|context
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guint
name|time
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|src_widget
decl_stmt|;
name|gboolean
name|return_val
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|(
name|src_widget
operator|=
name|gtk_drag_get_source_widget
argument_list|(
name|context
argument_list|)
operator|)
condition|)
block|{
name|Layer
modifier|*
name|layer
decl_stmt|;
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|gtk_object_get_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|src_widget
argument_list|)
argument_list|,
literal|"gimp_layer"
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer
operator|&&
name|layer
operator|==
name|layersD
operator|->
name|active_layer
operator|&&
operator|!
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
block|{
name|layers_dialog_duplicate_layer_callback
argument_list|(
name|widget
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|return_val
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
name|gtk_drag_finish
argument_list|(
name|context
argument_list|,
name|return_val
argument_list|,
name|FALSE
argument_list|,
name|time
argument_list|)
expr_stmt|;
return|return
name|return_val
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|layers_dialog_drag_trashcan_callback (GtkWidget * widget,GdkDragContext * context,gint x,gint y,guint time)
name|layers_dialog_drag_trashcan_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkDragContext
modifier|*
name|context
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guint
name|time
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|src_widget
decl_stmt|;
name|gboolean
name|return_val
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|(
name|src_widget
operator|=
name|gtk_drag_get_source_widget
argument_list|(
name|context
argument_list|)
operator|)
condition|)
block|{
name|Layer
modifier|*
name|layer
decl_stmt|;
name|LayerMask
modifier|*
name|layer_mask
decl_stmt|;
name|layer
operator|=
operator|(
name|Layer
operator|*
operator|)
name|gtk_object_get_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|src_widget
argument_list|)
argument_list|,
literal|"gimp_layer"
argument_list|)
expr_stmt|;
name|layer_mask
operator|=
operator|(
name|LayerMask
operator|*
operator|)
name|gtk_object_get_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|src_widget
argument_list|)
argument_list|,
literal|"gimp_layer_mask"
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer
operator|&&
name|layer
operator|==
name|layersD
operator|->
name|active_layer
condition|)
block|{
name|layers_dialog_delete_layer_callback
argument_list|(
name|widget
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|return_val
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|layer_mask
operator|&&
name|layer_mask_get_layer
argument_list|(
name|layer_mask
argument_list|)
operator|==
name|layersD
operator|->
name|active_layer
condition|)
block|{
name|layers_dialog_apply_layer_mask_callback
argument_list|(
name|widget
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|return_val
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
name|gtk_drag_finish
argument_list|(
name|context
argument_list|,
name|return_val
argument_list|,
name|FALSE
argument_list|,
name|time
argument_list|)
expr_stmt|;
return|return
name|return_val
return|;
block|}
end_function

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  layer widget functions  */
end_comment

begin_comment
comment|/****************************/
end_comment

begin_function
specifier|static
name|LayerWidget
modifier|*
DECL|function|layer_widget_get_ID (Layer * ID)
name|layer_widget_get_ID
parameter_list|(
name|Layer
modifier|*
name|ID
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|lw
decl_stmt|;
name|GSList
modifier|*
name|list
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
condition|)
return|return
name|NULL
return|;
name|list
operator|=
name|layersD
operator|->
name|layer_widgets
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|lw
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|lw
operator|->
name|layer
operator|==
name|ID
condition|)
return|return
name|lw
return|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|LayerWidget
modifier|*
DECL|function|layer_widget_create (GImage * gimage,Layer * layer)
name|layer_widget_create
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|GtkWidget
modifier|*
name|list_item
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|alignment
decl_stmt|;
name|list_item
operator|=
name|gtk_list_item_new
argument_list|()
expr_stmt|;
comment|/*  create the layer widget and add it to the list  */
name|layer_widget
operator|=
name|g_new
argument_list|(
name|LayerWidget
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|layer_widget
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
name|layer_widget
operator|->
name|layer
operator|=
name|layer
expr_stmt|;
name|layer_widget
operator|->
name|layer_preview
operator|=
name|NULL
expr_stmt|;
name|layer_widget
operator|->
name|mask_preview
operator|=
name|NULL
expr_stmt|;
name|layer_widget
operator|->
name|layer_pixmap
operator|=
name|NULL
expr_stmt|;
name|layer_widget
operator|->
name|mask_pixmap
operator|=
name|NULL
expr_stmt|;
name|layer_widget
operator|->
name|list_item
operator|=
name|list_item
expr_stmt|;
name|layer_widget
operator|->
name|width
operator|=
operator|-
literal|1
expr_stmt|;
name|layer_widget
operator|->
name|height
operator|=
operator|-
literal|1
expr_stmt|;
name|layer_widget
operator|->
name|layer_mask
operator|=
operator|(
name|layer
operator|->
name|mask
operator|!=
name|NULL
operator|)
expr_stmt|;
name|layer_widget
operator|->
name|apply_mask
operator|=
name|layer
operator|->
name|apply_mask
expr_stmt|;
name|layer_widget
operator|->
name|edit_mask
operator|=
name|layer
operator|->
name|edit_mask
expr_stmt|;
name|layer_widget
operator|->
name|show_mask
operator|=
name|layer
operator|->
name|show_mask
expr_stmt|;
name|layer_widget
operator|->
name|visited
operator|=
name|TRUE
expr_stmt|;
name|layer_widget
operator|->
name|drop_type
operator|=
name|GIMP_DROP_NONE
expr_stmt|;
if|if
condition|(
name|layer
operator|->
name|mask
condition|)
name|layer_widget
operator|->
name|active_preview
operator|=
operator|(
name|layer
operator|->
name|edit_mask
operator|)
condition|?
name|MASK_PREVIEW
else|:
name|LAYER_PREVIEW
expr_stmt|;
else|else
name|layer_widget
operator|->
name|active_preview
operator|=
name|LAYER_PREVIEW
expr_stmt|;
comment|/*  Need to let the list item know about the layer_widget  */
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
comment|/*  set up the list item observer  */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"select"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_widget_select_update
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"deselect"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_widget_select_update
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|list_item
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Create the visibility toggle button */
name|alignment
operator|=
name|gtk_alignment_new
argument_list|(
literal|0.5
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|alignment
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|layer_widget
operator|->
name|eye_widget
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|layer_widget
operator|->
name|eye_widget
argument_list|)
argument_list|,
name|eye_width
argument_list|,
name|eye_height
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|layer_widget
operator|->
name|eye_widget
argument_list|,
name|BUTTON_EVENT_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|eye_widget
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_widget_button_events
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|eye_widget
argument_list|)
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|alignment
argument_list|)
argument_list|,
name|layer_widget
operator|->
name|eye_widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layer_widget
operator|->
name|eye_widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|alignment
argument_list|)
expr_stmt|;
comment|/* Create the link toggle button */
name|alignment
operator|=
name|gtk_alignment_new
argument_list|(
literal|0.5
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|alignment
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|layer_widget
operator|->
name|linked_widget
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|layer_widget
operator|->
name|linked_widget
argument_list|)
argument_list|,
name|eye_width
argument_list|,
name|eye_height
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|layer_widget
operator|->
name|linked_widget
argument_list|,
name|BUTTON_EVENT_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|linked_widget
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_widget_button_events
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|linked_widget
argument_list|)
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|alignment
argument_list|)
argument_list|,
name|layer_widget
operator|->
name|linked_widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layer_widget
operator|->
name|linked_widget
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|alignment
argument_list|)
expr_stmt|;
comment|/*  The layer preview  */
name|alignment
operator|=
name|gtk_alignment_new
argument_list|(
literal|0.5
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|alignment
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|alignment
argument_list|)
expr_stmt|;
name|layer_widget
operator|->
name|layer_preview
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|layer_widget
operator|->
name|layer_preview
argument_list|)
argument_list|,
name|layersD
operator|->
name|image_width
operator|+
literal|4
argument_list|,
name|layersD
operator|->
name|image_height
operator|+
literal|4
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|layer_widget
operator|->
name|layer_preview
argument_list|,
name|PREVIEW_EVENT_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|layer_preview
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_widget_preview_events
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|layer_preview
argument_list|)
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|alignment
argument_list|)
argument_list|,
name|layer_widget
operator|->
name|layer_preview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layer_widget
operator|->
name|layer_preview
argument_list|)
expr_stmt|;
comment|/*  The layer mask preview  */
name|alignment
operator|=
name|gtk_alignment_new
argument_list|(
literal|0.5
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|alignment
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|alignment
argument_list|)
expr_stmt|;
name|layer_widget
operator|->
name|mask_preview
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
argument_list|,
name|layersD
operator|->
name|image_width
operator|+
literal|4
argument_list|,
name|layersD
operator|->
name|image_height
operator|+
literal|4
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|,
name|PREVIEW_EVENT_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_widget_preview_events
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|alignment
argument_list|)
argument_list|,
name|layer_widget
operator|->
name|mask_preview
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_get_mask
argument_list|(
name|layer
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|gtk_object_set_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
argument_list|,
literal|"gimp_layer_mask"
argument_list|,
name|layer_get_mask
argument_list|(
name|layer
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
expr_stmt|;
block|}
comment|/*  dnd source  */
name|gtk_drag_source_set
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|,
name|GDK_BUTTON1_MASK
operator||
name|GDK_BUTTON2_MASK
argument_list|,
name|layer_mask_target_table
argument_list|,
name|n_layer_mask_targets
argument_list|,
name|GDK_ACTION_MOVE
operator||
name|GDK_ACTION_COPY
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
argument_list|,
literal|"drag_begin"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|layer_mask_drag_begin_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  the layer name label */
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|layer_widget
operator|->
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Floating Selection"
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|layer_widget
operator|->
name|label
operator|=
name|gtk_label_new
argument_list|(
name|layer_get_name
argument_list|(
name|layer
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|layer_widget
operator|->
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|layer_widget
operator|->
name|label
argument_list|)
expr_stmt|;
name|layer_widget
operator|->
name|clip_widget
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|layer_widget
operator|->
name|clip_widget
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|layer_widget
operator|->
name|clip_widget
argument_list|,
name|BUTTON_EVENT_MASK
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|clip_widget
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_widget_button_events
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|layer_widget
operator|->
name|clip_widget
argument_list|)
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|layer_widget
operator|->
name|clip_widget
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* gtk_widget_show (layer_widget->clip_widget); */
comment|/*  dnd destination  */
name|gtk_drag_dest_set
argument_list|(
name|list_item
argument_list|,
name|GTK_DEST_DEFAULT_ALL
argument_list|,
name|layer_target_table
argument_list|,
name|n_layer_targets
argument_list|,
name|GDK_ACTION_MOVE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"drag_leave"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|layer_widget_drag_leave_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"drag_motion"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|layer_widget_drag_motion_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"drag_drop"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|layer_widget_drag_drop_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  re-paint the drop indicator after drawing the widget  */
name|gtk_signal_connect_after
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"draw"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|layer_widget_drag_indicator_callback
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
comment|/*  dnd source  */
name|gtk_drag_source_set
argument_list|(
name|list_item
argument_list|,
name|GDK_BUTTON1_MASK
operator||
name|GDK_BUTTON2_MASK
argument_list|,
name|layer_target_table
argument_list|,
name|n_layer_targets
argument_list|,
name|GDK_ACTION_MOVE
operator||
name|GDK_ACTION_COPY
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"drag_begin"
argument_list|,
name|GTK_SIGNAL_FUNC
argument_list|(
name|layer_widget_drag_begin_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_object_set_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"gimp_layer"
argument_list|,
operator|(
name|gpointer
operator|)
name|layer
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|list_item
argument_list|)
expr_stmt|;
name|gtk_widget_ref
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
expr_stmt|;
return|return
name|layer_widget
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|layer_widget_drag_motion_callback (GtkWidget * widget,GdkDragContext * context,gint x,gint y,guint time)
name|layer_widget_drag_motion_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkDragContext
modifier|*
name|context
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guint
name|time
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|dest
decl_stmt|;
name|gint
name|dest_index
decl_stmt|;
name|GtkWidget
modifier|*
name|src_widget
decl_stmt|;
name|LayerWidget
modifier|*
name|src
decl_stmt|;
name|gint
name|src_index
decl_stmt|;
name|gint
name|difference
decl_stmt|;
name|GimpDropType
name|drop_type
init|=
name|GIMP_DROP_NONE
decl_stmt|;
name|GdkDragAction
name|drag_action
init|=
name|GDK_ACTION_DEFAULT
decl_stmt|;
name|gboolean
name|return_val
init|=
name|FALSE
decl_stmt|;
name|dest
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest
operator|&&
name|layer_has_alpha
argument_list|(
name|dest
operator|->
name|layer
argument_list|)
operator|&&
operator|(
name|src_widget
operator|=
name|gtk_drag_get_source_widget
argument_list|(
name|context
argument_list|)
operator|)
condition|)
block|{
name|src
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|src_widget
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|&&
name|layer_has_alpha
argument_list|(
name|src
operator|->
name|layer
argument_list|)
operator|&&
operator|!
name|layer_is_floating_sel
argument_list|(
name|src
operator|->
name|layer
argument_list|)
operator|&&
name|src
operator|->
name|layer
operator|==
name|layersD
operator|->
name|active_layer
condition|)
block|{
name|src_index
operator|=
name|gimage_get_layer_index
argument_list|(
name|layersD
operator|->
name|gimage
argument_list|,
name|src
operator|->
name|layer
argument_list|)
expr_stmt|;
name|dest_index
operator|=
name|gimage_get_layer_index
argument_list|(
name|layersD
operator|->
name|gimage
argument_list|,
name|dest
operator|->
name|layer
argument_list|)
expr_stmt|;
name|difference
operator|=
name|dest_index
operator|-
name|src_index
expr_stmt|;
name|drop_type
operator|=
operator|(
operator|(
name|y
operator|<
name|widget
operator|->
name|allocation
operator|.
name|height
operator|/
literal|2
operator|)
condition|?
name|GIMP_DROP_ABOVE
else|:
name|GIMP_DROP_BELOW
operator|)
expr_stmt|;
if|if
condition|(
name|difference
operator|<
literal|0
operator|&&
name|drop_type
operator|==
name|GIMP_DROP_BELOW
condition|)
block|{
name|dest_index
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|difference
operator|>
literal|0
operator|&&
name|drop_type
operator|==
name|GIMP_DROP_ABOVE
condition|)
block|{
name|dest_index
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|src_index
operator|!=
name|dest_index
condition|)
block|{
name|drag_action
operator|=
name|GDK_ACTION_MOVE
expr_stmt|;
name|return_val
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|drop_type
operator|=
name|GIMP_DROP_NONE
expr_stmt|;
block|}
block|}
block|}
name|gdk_drag_status
argument_list|(
name|context
argument_list|,
name|drag_action
argument_list|,
name|time
argument_list|)
expr_stmt|;
if|if
condition|(
name|drop_type
operator|!=
name|dest
operator|->
name|drop_type
condition|)
block|{
name|layer_widget_draw_drop_indicator
argument_list|(
name|dest
argument_list|,
name|dest
operator|->
name|drop_type
argument_list|)
expr_stmt|;
name|layer_widget_draw_drop_indicator
argument_list|(
name|dest
argument_list|,
name|drop_type
argument_list|)
expr_stmt|;
name|dest
operator|->
name|drop_type
operator|=
name|drop_type
expr_stmt|;
block|}
return|return
name|return_val
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_drag_begin_callback (GtkWidget * widget,GdkDragContext * context)
name|layer_widget_drag_begin_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkDragContext
modifier|*
name|context
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_dnd_set_drawable_preview_icon
argument_list|(
name|widget
argument_list|,
name|context
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
argument_list|,
name|layer_widget
operator|->
name|layer_preview
operator|->
name|style
operator|->
name|black_gc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_mask_drag_begin_callback (GtkWidget * widget,GdkDragContext * context)
name|layer_mask_drag_begin_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkDragContext
modifier|*
name|context
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_dnd_set_drawable_preview_icon
argument_list|(
name|widget
argument_list|,
name|context
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|layer_get_mask
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
argument_list|)
argument_list|,
name|layer_widget
operator|->
name|mask_preview
operator|->
name|style
operator|->
name|black_gc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|layer_widget_drag_drop_callback (GtkWidget * widget,GdkDragContext * context,gint x,gint y,guint time)
name|layer_widget_drag_drop_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkDragContext
modifier|*
name|context
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guint
name|time
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|dest
decl_stmt|;
name|gint
name|dest_index
decl_stmt|;
name|GtkWidget
modifier|*
name|src_widget
decl_stmt|;
name|LayerWidget
modifier|*
name|src
decl_stmt|;
name|gint
name|src_index
decl_stmt|;
name|gint
name|difference
decl_stmt|;
name|GimpDropType
name|drop_type
init|=
name|GIMP_DROP_NONE
decl_stmt|;
name|gboolean
name|return_val
init|=
name|FALSE
decl_stmt|;
name|dest
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest
operator|&&
name|layer_has_alpha
argument_list|(
name|dest
operator|->
name|layer
argument_list|)
operator|&&
operator|(
name|src_widget
operator|=
name|gtk_drag_get_source_widget
argument_list|(
name|context
argument_list|)
operator|)
condition|)
block|{
name|src
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|src_widget
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|&&
name|layer_has_alpha
argument_list|(
name|src
operator|->
name|layer
argument_list|)
operator|&&
operator|!
name|layer_is_floating_sel
argument_list|(
name|src
operator|->
name|layer
argument_list|)
operator|&&
name|src
operator|->
name|layer
operator|==
name|layersD
operator|->
name|active_layer
condition|)
block|{
name|src_index
operator|=
name|gimage_get_layer_index
argument_list|(
name|layersD
operator|->
name|gimage
argument_list|,
name|src
operator|->
name|layer
argument_list|)
expr_stmt|;
name|dest_index
operator|=
name|gimage_get_layer_index
argument_list|(
name|layersD
operator|->
name|gimage
argument_list|,
name|dest
operator|->
name|layer
argument_list|)
expr_stmt|;
name|difference
operator|=
name|dest_index
operator|-
name|src_index
expr_stmt|;
name|drop_type
operator|=
operator|(
operator|(
name|y
operator|<
name|widget
operator|->
name|allocation
operator|.
name|height
operator|/
literal|2
operator|)
condition|?
name|GIMP_DROP_ABOVE
else|:
name|GIMP_DROP_BELOW
operator|)
expr_stmt|;
if|if
condition|(
name|difference
operator|<
literal|0
operator|&&
name|drop_type
operator|==
name|GIMP_DROP_BELOW
condition|)
block|{
name|dest_index
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|difference
operator|>
literal|0
operator|&&
name|drop_type
operator|==
name|GIMP_DROP_ABOVE
condition|)
block|{
name|dest_index
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|src_index
operator|!=
name|dest_index
condition|)
block|{
name|gimp_image_position_layer
argument_list|(
name|layersD
operator|->
name|gimage
argument_list|,
name|src
operator|->
name|layer
argument_list|,
name|dest_index
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
name|return_val
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
block|}
name|layer_widget_draw_drop_indicator
argument_list|(
name|dest
argument_list|,
name|dest
operator|->
name|drop_type
argument_list|)
expr_stmt|;
name|dest
operator|->
name|drop_type
operator|=
name|GIMP_DROP_NONE
expr_stmt|;
name|gtk_drag_finish
argument_list|(
name|context
argument_list|,
name|return_val
argument_list|,
name|FALSE
argument_list|,
name|time
argument_list|)
expr_stmt|;
return|return
name|return_val
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_drag_leave_callback (GtkWidget * widget,GdkDragContext * context,guint time)
name|layer_widget_drag_leave_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkDragContext
modifier|*
name|context
parameter_list|,
name|guint
name|time
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|layer_widget
operator|->
name|drop_type
operator|=
name|GIMP_DROP_NONE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_drag_indicator_callback (GtkWidget * widget,gpointer data)
name|layer_widget_drag_indicator_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|layer_widget_draw_drop_indicator
argument_list|(
name|layer_widget
argument_list|,
name|layer_widget
operator|->
name|drop_type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_draw_drop_indicator (LayerWidget * layer_widget,GimpDropType drop_type)
name|layer_widget_draw_drop_indicator
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|,
name|GimpDropType
name|drop_type
parameter_list|)
block|{
specifier|static
name|GdkGC
modifier|*
name|gc
init|=
name|NULL
decl_stmt|;
name|gint
name|y
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|gc
condition|)
block|{
name|GdkColor
name|fg
decl_stmt|,
name|bg
decl_stmt|;
name|gc
operator|=
name|gdk_gc_new
argument_list|(
name|layer_widget
operator|->
name|list_item
operator|->
name|window
argument_list|)
expr_stmt|;
name|fg
operator|.
name|pixel
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|bg
operator|.
name|pixel
operator|=
literal|0x00000000
expr_stmt|;
name|gdk_gc_set_function
argument_list|(
name|gc
argument_list|,
name|GDK_INVERT
argument_list|)
expr_stmt|;
name|gdk_gc_set_foreground
argument_list|(
name|gc
argument_list|,
operator|&
name|fg
argument_list|)
expr_stmt|;
name|gdk_gc_set_background
argument_list|(
name|gc
argument_list|,
operator|&
name|bg
argument_list|)
expr_stmt|;
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
literal|5
argument_list|,
name|GDK_LINE_SOLID
argument_list|,
name|GDK_CAP_BUTT
argument_list|,
name|GDK_JOIN_MITER
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drop_type
operator|!=
name|GIMP_DROP_NONE
condition|)
block|{
name|y
operator|=
operator|(
operator|(
name|drop_type
operator|==
name|GIMP_DROP_ABOVE
operator|)
condition|?
literal|3
else|:
name|layer_widget
operator|->
name|list_item
operator|->
name|allocation
operator|.
name|height
operator|-
literal|4
operator|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|layer_widget
operator|->
name|list_item
operator|->
name|window
argument_list|,
name|gc
argument_list|,
literal|2
argument_list|,
name|y
argument_list|,
name|layer_widget
operator|->
name|list_item
operator|->
name|allocation
operator|.
name|width
operator|-
literal|3
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_delete (LayerWidget * layer_widget)
name|layer_widget_delete
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|)
block|{
if|if
condition|(
name|layer_widget
operator|->
name|layer_pixmap
condition|)
name|gdk_pixmap_unref
argument_list|(
name|layer_widget
operator|->
name|layer_pixmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_widget
operator|->
name|mask_pixmap
condition|)
name|gdk_pixmap_unref
argument_list|(
name|layer_widget
operator|->
name|mask_pixmap
argument_list|)
expr_stmt|;
comment|/*  Remove the layer widget from the list  */
name|layersD
operator|->
name|layer_widgets
operator|=
name|g_slist_remove
argument_list|(
name|layersD
operator|->
name|layer_widgets
argument_list|,
name|layer_widget
argument_list|)
expr_stmt|;
comment|/*  Release the widget  */
name|gtk_widget_unref
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_select_update (GtkWidget * widget,gpointer data)
name|layer_widget_select_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|data
operator|)
condition|)
return|return;
comment|/*  Is the list item being selected?  */
if|if
condition|(
name|widget
operator|->
name|state
operator|!=
name|GTK_STATE_SELECTED
condition|)
return|return;
comment|/*  Only notify the gimage of an active layer change if necessary  */
if|if
condition|(
name|suspend_gimage_notify
operator|==
literal|0
condition|)
block|{
comment|/*  set the gimage's active layer to be this layer  */
name|gimage_set_active_layer
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|,
name|layer_widget
operator|->
name|layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|layer_widget_button_events (GtkWidget * widget,GdkEvent * event)
name|layer_widget_button_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|GtkWidget
modifier|*
name|event_widget
decl_stmt|;
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
name|gint
name|return_val
decl_stmt|;
specifier|static
name|gboolean
name|button_down
init|=
name|FALSE
decl_stmt|;
specifier|static
name|GtkWidget
modifier|*
name|click_widget
init|=
name|NULL
decl_stmt|;
specifier|static
name|gint
name|old_state
decl_stmt|;
specifier|static
name|gint
name|exclusive
decl_stmt|;
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|return_val
operator|=
name|FALSE
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_EXPOSE
case|:
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|eye_widget
condition|)
name|layer_widget_eye_redraw
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|linked_widget
condition|)
name|layer_widget_linked_redraw
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|clip_widget
condition|)
name|layer_widget_clip_redraw
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
break|break;
case|case
name|GDK_BUTTON_PRESS
case|:
name|return_val
operator|=
name|TRUE
expr_stmt|;
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
name|bevent
operator|->
name|button
operator|==
literal|3
condition|)
block|{
name|gtk_menu_popup
argument_list|(
name|GTK_MENU
argument_list|(
name|layersD
operator|->
name|ops_menu
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|3
argument_list|,
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
name|button_down
operator|=
name|TRUE
expr_stmt|;
name|click_widget
operator|=
name|widget
expr_stmt|;
name|gtk_grab_add
argument_list|(
name|click_widget
argument_list|)
expr_stmt|;
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|eye_widget
condition|)
block|{
name|old_state
operator|=
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|visible
expr_stmt|;
comment|/*  If this was a shift-click, make all/none visible  */
if|if
condition|(
name|event
operator|->
name|button
operator|.
name|state
operator|&
name|GDK_SHIFT_MASK
condition|)
block|{
name|exclusive
operator|=
name|TRUE
expr_stmt|;
name|layer_widget_exclusive_visible
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|exclusive
operator|=
name|FALSE
expr_stmt|;
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|visible
operator|=
operator|!
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|visible
expr_stmt|;
name|layer_widget_eye_redraw
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|linked_widget
condition|)
block|{
name|old_state
operator|=
name|layer_widget
operator|->
name|layer
operator|->
name|linked
expr_stmt|;
name|layer_widget
operator|->
name|layer
operator|->
name|linked
operator|=
operator|!
name|layer_widget
operator|->
name|layer
operator|->
name|linked
expr_stmt|;
name|layer_widget_linked_redraw
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GDK_BUTTON_RELEASE
case|:
name|return_val
operator|=
name|TRUE
expr_stmt|;
name|button_down
operator|=
name|FALSE
expr_stmt|;
name|gtk_grab_remove
argument_list|(
name|click_widget
argument_list|)
expr_stmt|;
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|eye_widget
condition|)
block|{
if|if
condition|(
name|exclusive
condition|)
block|{
name|gimage_invalidate_preview
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_update_area
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|layer_widget
operator|->
name|gimage
operator|->
name|width
argument_list|,
name|layer_widget
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|old_state
operator|!=
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|visible
condition|)
block|{
comment|/*  Invalidate the gimage preview  */
name|gimage_invalidate_preview
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|)
expr_stmt|;
name|drawable_update
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|width
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|height
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|widget
operator|==
name|layer_widget
operator|->
name|linked_widget
operator|)
operator|&&
operator|(
name|old_state
operator|!=
name|layer_widget
operator|->
name|layer
operator|->
name|linked
operator|)
condition|)
block|{ 	}
break|break;
case|case
name|GDK_LEAVE_NOTIFY
case|:
name|event_widget
operator|=
name|gtk_get_event_widget
argument_list|(
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|button_down
operator|&&
operator|(
name|event_widget
operator|==
name|click_widget
operator|)
condition|)
block|{
comment|/* the user moved the cursor out of the widget before              releasing the button -> cancel the button_press */
name|button_down
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|eye_widget
condition|)
block|{
if|if
condition|(
name|exclusive
condition|)
block|{
name|layer_widget_exclusive_visible
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|visible
operator|=
operator|!
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|visible
expr_stmt|;
name|layer_widget_eye_redraw
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|linked_widget
condition|)
block|{
name|layer_widget
operator|->
name|layer
operator|->
name|linked
operator|=
operator|!
name|layer_widget
operator|->
name|layer
operator|->
name|linked
expr_stmt|;
name|layer_widget_linked_redraw
argument_list|(
name|layer_widget
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
break|break;
block|}
return|return
name|return_val
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|layer_widget_preview_events (GtkWidget * widget,GdkEvent * event)
name|layer_widget_preview_events
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|GdkEventExpose
modifier|*
name|eevent
decl_stmt|;
name|GdkPixmap
modifier|*
modifier|*
name|pixmap
decl_stmt|;
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|int
name|valid
decl_stmt|;
name|int
name|preview_type
decl_stmt|;
name|int
name|sx
decl_stmt|,
name|sy
decl_stmt|,
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|pixmap
operator|=
name|NULL
expr_stmt|;
name|valid
operator|=
name|FALSE
expr_stmt|;
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|GIMP_IS_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|layer_preview
condition|)
name|preview_type
operator|=
name|LAYER_PREVIEW
expr_stmt|;
elseif|else
if|if
condition|(
name|widget
operator|==
name|layer_widget
operator|->
name|mask_preview
operator|&&
name|GTK_WIDGET_VISIBLE
argument_list|(
name|widget
argument_list|)
condition|)
name|preview_type
operator|=
name|MASK_PREVIEW
expr_stmt|;
else|else
return|return
name|FALSE
return|;
switch|switch
condition|(
name|preview_type
condition|)
block|{
case|case
name|LAYER_PREVIEW
case|:
name|pixmap
operator|=
operator|&
name|layer_widget
operator|->
name|layer_pixmap
expr_stmt|;
name|valid
operator|=
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|preview_valid
expr_stmt|;
break|break;
case|case
name|MASK_PREVIEW
case|:
name|pixmap
operator|=
operator|&
name|layer_widget
operator|->
name|mask_pixmap
expr_stmt|;
name|valid
operator|=
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
operator|->
name|mask
argument_list|)
operator|->
name|preview_valid
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
condition|)
name|preview_type
operator|=
name|FS_PREVIEW
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_BUTTON_PRESS
case|:
comment|/*  Control-button press disables the application of the mask  */
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
if|if
condition|(
name|bevent
operator|->
name|button
operator|==
literal|3
condition|)
block|{
name|gtk_menu_popup
argument_list|(
name|GTK_MENU
argument_list|(
name|layersD
operator|->
name|ops_menu
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|3
argument_list|,
name|bevent
operator|->
name|time
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
if|if
condition|(
name|event
operator|->
name|button
operator|.
name|state
operator|&
name|GDK_CONTROL_MASK
condition|)
block|{
if|if
condition|(
name|preview_type
operator|==
name|MASK_PREVIEW
condition|)
block|{
name|gimage_set_layer_mask_apply
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|,
name|layer_widget
operator|->
name|layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
comment|/*  Alt-button press makes the mask visible instead of the layer  */
elseif|else
if|if
condition|(
name|event
operator|->
name|button
operator|.
name|state
operator|&
name|GDK_MOD1_MASK
condition|)
block|{
if|if
condition|(
name|preview_type
operator|==
name|MASK_PREVIEW
condition|)
block|{
name|gimage_set_layer_mask_show
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|,
name|layer_widget
operator|->
name|layer
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|layer_widget
operator|->
name|active_preview
operator|!=
name|preview_type
condition|)
block|{
name|gimage_set_layer_mask_edit
argument_list|(
name|layer_widget
operator|->
name|gimage
argument_list|,
name|layer_widget
operator|->
name|layer
argument_list|,
operator|(
name|preview_type
operator|==
name|MASK_PREVIEW
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|GDK_EXPOSE
case|:
if|if
condition|(
operator|!
name|preview_size
operator|&&
name|preview_type
operator|!=
name|FS_PREVIEW
condition|)
name|layer_widget_no_preview_redraw
argument_list|(
name|layer_widget
argument_list|,
name|preview_type
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|valid
operator|||
operator|!
operator|*
name|pixmap
condition|)
block|{
name|layer_widget_preview_redraw
argument_list|(
name|layer_widget
argument_list|,
name|preview_type
argument_list|)
expr_stmt|;
name|gdk_draw_pixmap
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
operator|*
name|pixmap
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
name|layersD
operator|->
name|image_width
argument_list|,
name|layersD
operator|->
name|image_height
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eevent
operator|=
operator|(
name|GdkEventExpose
operator|*
operator|)
name|event
expr_stmt|;
name|w
operator|=
name|eevent
operator|->
name|area
operator|.
name|width
expr_stmt|;
name|h
operator|=
name|eevent
operator|->
name|area
operator|.
name|height
expr_stmt|;
if|if
condition|(
name|eevent
operator|->
name|area
operator|.
name|x
operator|<
literal|2
condition|)
block|{
name|sx
operator|=
name|eevent
operator|->
name|area
operator|.
name|x
expr_stmt|;
name|dx
operator|=
literal|2
expr_stmt|;
name|w
operator|-=
operator|(
literal|2
operator|-
name|eevent
operator|->
name|area
operator|.
name|x
operator|)
expr_stmt|;
block|}
else|else
block|{
name|sx
operator|=
name|eevent
operator|->
name|area
operator|.
name|x
operator|-
literal|2
expr_stmt|;
name|dx
operator|=
name|eevent
operator|->
name|area
operator|.
name|x
expr_stmt|;
block|}
if|if
condition|(
name|eevent
operator|->
name|area
operator|.
name|y
operator|<
literal|2
condition|)
block|{
name|sy
operator|=
name|eevent
operator|->
name|area
operator|.
name|y
expr_stmt|;
name|dy
operator|=
literal|2
expr_stmt|;
name|h
operator|-=
operator|(
literal|2
operator|-
name|eevent
operator|->
name|area
operator|.
name|y
operator|)
expr_stmt|;
block|}
else|else
block|{
name|sy
operator|=
name|eevent
operator|->
name|area
operator|.
name|y
operator|-
literal|2
expr_stmt|;
name|dy
operator|=
name|eevent
operator|->
name|area
operator|.
name|y
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sx
operator|+
name|w
operator|)
operator|>=
name|layersD
operator|->
name|image_width
condition|)
name|w
operator|=
name|layersD
operator|->
name|image_width
operator|-
name|sx
expr_stmt|;
if|if
condition|(
operator|(
name|sy
operator|+
name|h
operator|)
operator|>=
name|layersD
operator|->
name|image_height
condition|)
name|h
operator|=
name|layersD
operator|->
name|image_height
operator|-
name|sy
expr_stmt|;
if|if
condition|(
operator|(
name|w
operator|>
literal|0
operator|)
operator|&&
operator|(
name|h
operator|>
literal|0
operator|)
condition|)
name|gdk_draw_pixmap
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
operator|*
name|pixmap
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  The boundary indicating whether layer or mask is active  */
name|layer_widget_boundary_redraw
argument_list|(
name|layer_widget
argument_list|,
name|preview_type
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_boundary_redraw (LayerWidget * layer_widget,int preview_type)
name|layer_widget_boundary_redraw
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|,
name|int
name|preview_type
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|widget
decl_stmt|;
name|GdkGC
modifier|*
name|gc1
decl_stmt|,
modifier|*
name|gc2
decl_stmt|;
name|GtkStateType
name|state
decl_stmt|;
if|if
condition|(
name|preview_type
operator|==
name|LAYER_PREVIEW
condition|)
name|widget
operator|=
name|layer_widget
operator|->
name|layer_preview
expr_stmt|;
elseif|else
if|if
condition|(
name|preview_type
operator|==
name|MASK_PREVIEW
condition|)
name|widget
operator|=
name|layer_widget
operator|->
name|mask_preview
expr_stmt|;
else|else
return|return;
name|state
operator|=
name|layer_widget
operator|->
name|list_item
operator|->
name|state
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|GTK_STATE_SELECTED
condition|)
block|{
if|if
condition|(
name|layer_widget
operator|->
name|active_preview
operator|==
name|preview_type
condition|)
name|gc1
operator|=
name|layer_widget
operator|->
name|layer_preview
operator|->
name|style
operator|->
name|white_gc
expr_stmt|;
else|else
name|gc1
operator|=
name|layer_widget
operator|->
name|layer_preview
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_SELECTED
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|layer_widget
operator|->
name|active_preview
operator|==
name|preview_type
condition|)
name|gc1
operator|=
name|layer_widget
operator|->
name|layer_preview
operator|->
name|style
operator|->
name|black_gc
expr_stmt|;
else|else
name|gc1
operator|=
name|layer_widget
operator|->
name|layer_preview
operator|->
name|style
operator|->
name|white_gc
expr_stmt|;
block|}
name|gc2
operator|=
name|gc1
expr_stmt|;
if|if
condition|(
name|preview_type
operator|==
name|MASK_PREVIEW
condition|)
block|{
if|if
condition|(
name|layersD
operator|->
name|green_gc
operator|==
name|NULL
condition|)
block|{
name|GdkColor
name|green
decl_stmt|;
name|green
operator|.
name|pixel
operator|=
name|get_color
argument_list|(
literal|0
argument_list|,
literal|255
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|green_gc
operator|=
name|gdk_gc_new
argument_list|(
name|widget
operator|->
name|window
argument_list|)
expr_stmt|;
name|gdk_gc_set_foreground
argument_list|(
name|layersD
operator|->
name|green_gc
argument_list|,
operator|&
name|green
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|layersD
operator|->
name|red_gc
operator|==
name|NULL
condition|)
block|{
name|GdkColor
name|red
decl_stmt|;
name|red
operator|.
name|pixel
operator|=
name|get_color
argument_list|(
literal|255
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|layersD
operator|->
name|red_gc
operator|=
name|gdk_gc_new
argument_list|(
name|widget
operator|->
name|window
argument_list|)
expr_stmt|;
name|gdk_gc_set_foreground
argument_list|(
name|layersD
operator|->
name|red_gc
argument_list|,
operator|&
name|red
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|layer_widget
operator|->
name|layer
operator|->
name|show_mask
condition|)
name|gc2
operator|=
name|layersD
operator|->
name|green_gc
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|layer_widget
operator|->
name|layer
operator|->
name|apply_mask
condition|)
name|gc2
operator|=
name|layersD
operator|->
name|red_gc
expr_stmt|;
block|}
name|gdk_draw_rectangle
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|gc1
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|layersD
operator|->
name|image_width
operator|+
literal|3
argument_list|,
name|layersD
operator|->
name|image_height
operator|+
literal|3
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|gc2
argument_list|,
name|FALSE
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|layersD
operator|->
name|image_width
operator|+
literal|1
argument_list|,
name|layersD
operator|->
name|image_height
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_preview_redraw (LayerWidget * layer_widget,int preview_type)
name|layer_widget_preview_redraw
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|,
name|int
name|preview_type
parameter_list|)
block|{
name|TempBuf
modifier|*
name|preview_buf
decl_stmt|;
name|GdkPixmap
modifier|*
modifier|*
name|pixmap
decl_stmt|;
name|GtkWidget
modifier|*
name|widget
decl_stmt|;
name|int
name|offx
decl_stmt|,
name|offy
decl_stmt|;
name|preview_buf
operator|=
name|NULL
expr_stmt|;
name|pixmap
operator|=
name|NULL
expr_stmt|;
name|widget
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|preview_type
condition|)
block|{
case|case
name|LAYER_PREVIEW
case|:
case|case
name|FS_PREVIEW
case|:
name|widget
operator|=
name|layer_widget
operator|->
name|layer_preview
expr_stmt|;
name|pixmap
operator|=
operator|&
name|layer_widget
operator|->
name|layer_pixmap
expr_stmt|;
break|break;
case|case
name|MASK_PREVIEW
case|:
name|widget
operator|=
name|layer_widget
operator|->
name|mask_preview
expr_stmt|;
name|pixmap
operator|=
operator|&
name|layer_widget
operator|->
name|mask_pixmap
expr_stmt|;
break|break;
block|}
comment|/*  allocate the layer widget pixmap  */
if|if
condition|(
operator|!
operator|*
name|pixmap
condition|)
operator|*
name|pixmap
operator|=
name|gdk_pixmap_new
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|layersD
operator|->
name|image_width
argument_list|,
name|layersD
operator|->
name|image_height
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*  If this is a floating selection preview, draw the preview  */
if|if
condition|(
name|preview_type
operator|==
name|FS_PREVIEW
condition|)
name|render_fs_preview
argument_list|(
name|widget
argument_list|,
operator|*
name|pixmap
argument_list|)
expr_stmt|;
comment|/*  otherwise, ask the layer or mask for the preview  */
else|else
block|{
comment|/*  determine width and height  */
name|layer_widget
operator|->
name|width
operator|=
call|(
name|int
call|)
argument_list|(
name|layersD
operator|->
name|ratio
operator|*
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|width
argument_list|)
expr_stmt|;
name|layer_widget
operator|->
name|height
operator|=
call|(
name|int
call|)
argument_list|(
name|layersD
operator|->
name|ratio
operator|*
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_widget
operator|->
name|width
operator|<
literal|1
condition|)
name|layer_widget
operator|->
name|width
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|layer_widget
operator|->
name|height
operator|<
literal|1
condition|)
name|layer_widget
operator|->
name|height
operator|=
literal|1
expr_stmt|;
name|offx
operator|=
call|(
name|int
call|)
argument_list|(
name|layersD
operator|->
name|ratio
operator|*
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|offset_x
argument_list|)
expr_stmt|;
name|offy
operator|=
call|(
name|int
call|)
argument_list|(
name|layersD
operator|->
name|ratio
operator|*
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|offset_y
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|preview_type
condition|)
block|{
case|case
name|LAYER_PREVIEW
case|:
name|preview_buf
operator|=
name|layer_preview
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|,
name|layer_widget
operator|->
name|width
argument_list|,
name|layer_widget
operator|->
name|height
argument_list|)
expr_stmt|;
break|break;
case|case
name|MASK_PREVIEW
case|:
name|preview_buf
operator|=
name|layer_mask_preview
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|,
name|layer_widget
operator|->
name|width
argument_list|,
name|layer_widget
operator|->
name|height
argument_list|)
expr_stmt|;
break|break;
block|}
name|preview_buf
operator|->
name|x
operator|=
name|offx
expr_stmt|;
name|preview_buf
operator|->
name|y
operator|=
name|offy
expr_stmt|;
name|render_preview
argument_list|(
name|preview_buf
argument_list|,
name|layersD
operator|->
name|layer_preview
argument_list|,
name|layersD
operator|->
name|image_width
argument_list|,
name|layersD
operator|->
name|image_height
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_preview_put
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|layersD
operator|->
name|layer_preview
argument_list|)
argument_list|,
operator|*
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|layersD
operator|->
name|image_width
argument_list|,
name|layersD
operator|->
name|image_height
argument_list|)
expr_stmt|;
comment|/*  make sure the image has been transfered completely to the pixmap before        *  we use it again...        */
name|gdk_flush
argument_list|()
expr_stmt|;
block|}
name|lc_dialog_menu_preview_dirty
argument_list|(
name|GTK_OBJECT
argument_list|(
name|gimp_drawable_gimage
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_no_preview_redraw (LayerWidget * layer_widget,int preview_type)
name|layer_widget_no_preview_redraw
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|,
name|int
name|preview_type
parameter_list|)
block|{
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
name|GdkPixmap
modifier|*
modifier|*
name|pixmap_normal
decl_stmt|;
name|GdkPixmap
modifier|*
modifier|*
name|pixmap_selected
decl_stmt|;
name|GdkPixmap
modifier|*
modifier|*
name|pixmap_insensitive
decl_stmt|;
name|GdkColor
modifier|*
name|color
decl_stmt|;
name|GtkWidget
modifier|*
name|widget
decl_stmt|;
name|GtkStateType
name|state
decl_stmt|;
name|gchar
modifier|*
name|bits
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|pixmap_normal
operator|=
name|NULL
expr_stmt|;
name|pixmap_selected
operator|=
name|NULL
expr_stmt|;
name|pixmap_insensitive
operator|=
name|NULL
expr_stmt|;
name|widget
operator|=
name|NULL
expr_stmt|;
name|bits
operator|=
name|NULL
expr_stmt|;
name|width
operator|=
literal|0
expr_stmt|;
name|height
operator|=
literal|0
expr_stmt|;
name|state
operator|=
name|layer_widget
operator|->
name|list_item
operator|->
name|state
expr_stmt|;
switch|switch
condition|(
name|preview_type
condition|)
block|{
case|case
name|LAYER_PREVIEW
case|:
name|widget
operator|=
name|layer_widget
operator|->
name|layer_preview
expr_stmt|;
name|pixmap_normal
operator|=
operator|&
name|layer_pixmap
index|[
name|NORMAL
index|]
expr_stmt|;
name|pixmap_selected
operator|=
operator|&
name|layer_pixmap
index|[
name|SELECTED
index|]
expr_stmt|;
name|pixmap_insensitive
operator|=
operator|&
name|layer_pixmap
index|[
name|INSENSITIVE
index|]
expr_stmt|;
name|bits
operator|=
operator|(
name|gchar
operator|*
operator|)
name|layer_bits
expr_stmt|;
name|width
operator|=
name|layer_width
expr_stmt|;
name|height
operator|=
name|layer_height
expr_stmt|;
break|break;
case|case
name|MASK_PREVIEW
case|:
name|widget
operator|=
name|layer_widget
operator|->
name|mask_preview
expr_stmt|;
name|pixmap_normal
operator|=
operator|&
name|mask_pixmap
index|[
name|NORMAL
index|]
expr_stmt|;
name|pixmap_selected
operator|=
operator|&
name|mask_pixmap
index|[
name|SELECTED
index|]
expr_stmt|;
name|pixmap_insensitive
operator|=
operator|&
name|mask_pixmap
index|[
name|INSENSITIVE
index|]
expr_stmt|;
name|bits
operator|=
operator|(
name|gchar
operator|*
operator|)
name|mask_bits
expr_stmt|;
name|width
operator|=
name|mask_width
expr_stmt|;
name|height
operator|=
name|mask_height
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|GTK_STATE_SELECTED
condition|)
name|color
operator|=
operator|&
name|widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
expr_stmt|;
else|else
name|color
operator|=
operator|&
name|widget
operator|->
name|style
operator|->
name|white
expr_stmt|;
block|}
else|else
name|color
operator|=
operator|&
name|widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_INSENSITIVE
index|]
expr_stmt|;
name|gdk_window_set_background
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|color
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|pixmap_normal
condition|)
block|{
operator|*
name|pixmap_normal
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|bits
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|,
operator|&
name|widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|)
expr_stmt|;
operator|*
name|pixmap_selected
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|bits
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
operator|&
name|widget
operator|->
name|style
operator|->
name|white
argument_list|)
expr_stmt|;
operator|*
name|pixmap_insensitive
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|bits
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_INSENSITIVE
index|]
argument_list|,
operator|&
name|widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_INSENSITIVE
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|GTK_STATE_SELECTED
condition|)
name|pixmap
operator|=
operator|*
name|pixmap_selected
expr_stmt|;
else|else
name|pixmap
operator|=
operator|*
name|pixmap_normal
expr_stmt|;
block|}
else|else
name|pixmap
operator|=
operator|*
name|pixmap_insensitive
expr_stmt|;
name|gdk_draw_pixmap
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|pixmap
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_eye_redraw (LayerWidget * layer_widget)
name|layer_widget_eye_redraw
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|)
block|{
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
name|GdkColor
modifier|*
name|color
decl_stmt|;
name|GtkStateType
name|state
decl_stmt|;
name|state
operator|=
name|layer_widget
operator|->
name|list_item
operator|->
name|state
expr_stmt|;
if|if
condition|(
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|GTK_STATE_SELECTED
condition|)
name|color
operator|=
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
expr_stmt|;
else|else
name|color
operator|=
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|white
expr_stmt|;
block|}
else|else
name|color
operator|=
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_INSENSITIVE
index|]
expr_stmt|;
name|gdk_window_set_background
argument_list|(
name|layer_widget
operator|->
name|eye_widget
operator|->
name|window
argument_list|,
name|color
argument_list|)
expr_stmt|;
if|if
condition|(
name|GIMP_DRAWABLE
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|->
name|visible
condition|)
block|{
if|if
condition|(
operator|!
name|eye_pixmap
index|[
name|NORMAL
index|]
condition|)
block|{
name|eye_pixmap
index|[
name|NORMAL
index|]
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|layer_widget
operator|->
name|eye_widget
operator|->
name|window
argument_list|,
operator|(
name|gchar
operator|*
operator|)
name|eye_bits
argument_list|,
name|eye_width
argument_list|,
name|eye_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|white
argument_list|)
expr_stmt|;
name|eye_pixmap
index|[
name|SELECTED
index|]
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|layer_widget
operator|->
name|eye_widget
operator|->
name|window
argument_list|,
operator|(
name|gchar
operator|*
operator|)
name|eye_bits
argument_list|,
name|eye_width
argument_list|,
name|eye_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|,
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|)
expr_stmt|;
name|eye_pixmap
index|[
name|INSENSITIVE
index|]
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|layer_widget
operator|->
name|eye_widget
operator|->
name|window
argument_list|,
operator|(
name|gchar
operator|*
operator|)
name|eye_bits
argument_list|,
name|eye_width
argument_list|,
name|eye_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_INSENSITIVE
index|]
argument_list|,
operator|&
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_INSENSITIVE
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|GTK_STATE_SELECTED
condition|)
name|pixmap
operator|=
name|eye_pixmap
index|[
name|SELECTED
index|]
expr_stmt|;
else|else
name|pixmap
operator|=
name|eye_pixmap
index|[
name|NORMAL
index|]
expr_stmt|;
block|}
else|else
name|pixmap
operator|=
name|eye_pixmap
index|[
name|INSENSITIVE
index|]
expr_stmt|;
name|gdk_draw_pixmap
argument_list|(
name|layer_widget
operator|->
name|eye_widget
operator|->
name|window
argument_list|,
name|layer_widget
operator|->
name|eye_widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|pixmap
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|eye_width
argument_list|,
name|eye_height
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gdk_window_clear
argument_list|(
name|layer_widget
operator|->
name|eye_widget
operator|->
name|window
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_linked_redraw (LayerWidget * layer_widget)
name|layer_widget_linked_redraw
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|)
block|{
name|GdkPixmap
modifier|*
name|pixmap
decl_stmt|;
name|GdkColor
modifier|*
name|color
decl_stmt|;
name|GtkStateType
name|state
decl_stmt|;
name|state
operator|=
name|layer_widget
operator|->
name|list_item
operator|->
name|state
expr_stmt|;
if|if
condition|(
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|GTK_STATE_SELECTED
condition|)
name|color
operator|=
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
expr_stmt|;
else|else
name|color
operator|=
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|white
expr_stmt|;
block|}
else|else
name|color
operator|=
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_INSENSITIVE
index|]
expr_stmt|;
name|gdk_window_set_background
argument_list|(
name|layer_widget
operator|->
name|linked_widget
operator|->
name|window
argument_list|,
name|color
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_widget
operator|->
name|layer
operator|->
name|linked
condition|)
block|{
if|if
condition|(
operator|!
name|linked_pixmap
index|[
name|NORMAL
index|]
condition|)
block|{
name|linked_pixmap
index|[
name|NORMAL
index|]
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|layer_widget
operator|->
name|linked_widget
operator|->
name|window
argument_list|,
operator|(
name|gchar
operator|*
operator|)
name|linked_bits
argument_list|,
name|linked_width
argument_list|,
name|linked_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|white
argument_list|)
expr_stmt|;
name|linked_pixmap
index|[
name|SELECTED
index|]
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|layer_widget
operator|->
name|linked_widget
operator|->
name|window
argument_list|,
operator|(
name|gchar
operator|*
operator|)
name|linked_bits
argument_list|,
name|linked_width
argument_list|,
name|linked_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|,
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|)
expr_stmt|;
name|linked_pixmap
index|[
name|INSENSITIVE
index|]
operator|=
name|gdk_pixmap_create_from_data
argument_list|(
name|layer_widget
operator|->
name|linked_widget
operator|->
name|window
argument_list|,
operator|(
name|gchar
operator|*
operator|)
name|linked_bits
argument_list|,
name|linked_width
argument_list|,
name|linked_height
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|fg
index|[
name|GTK_STATE_INSENSITIVE
index|]
argument_list|,
operator|&
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_INSENSITIVE
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|GTK_STATE_SELECTED
condition|)
name|pixmap
operator|=
name|linked_pixmap
index|[
name|SELECTED
index|]
expr_stmt|;
else|else
name|pixmap
operator|=
name|linked_pixmap
index|[
name|NORMAL
index|]
expr_stmt|;
block|}
else|else
name|pixmap
operator|=
name|linked_pixmap
index|[
name|INSENSITIVE
index|]
expr_stmt|;
name|gdk_draw_pixmap
argument_list|(
name|layer_widget
operator|->
name|linked_widget
operator|->
name|window
argument_list|,
name|layer_widget
operator|->
name|linked_widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|pixmap
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|linked_width
argument_list|,
name|linked_height
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gdk_window_clear
argument_list|(
name|layer_widget
operator|->
name|linked_widget
operator|->
name|window
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_clip_redraw (LayerWidget * layer_widget)
name|layer_widget_clip_redraw
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|)
block|{
name|GdkColor
modifier|*
name|color
decl_stmt|;
name|GtkStateType
name|state
decl_stmt|;
name|state
operator|=
name|layer_widget
operator|->
name|list_item
operator|->
name|state
expr_stmt|;
name|color
operator|=
operator|&
name|layer_widget
operator|->
name|clip_widget
operator|->
name|style
operator|->
name|fg
index|[
name|state
index|]
expr_stmt|;
name|gdk_window_set_background
argument_list|(
name|layer_widget
operator|->
name|clip_widget
operator|->
name|window
argument_list|,
name|color
argument_list|)
expr_stmt|;
name|gdk_window_clear
argument_list|(
name|layer_widget
operator|->
name|clip_widget
operator|->
name|window
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_exclusive_visible (LayerWidget * layer_widget)
name|layer_widget_exclusive_visible
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|)
block|{
name|GSList
modifier|*
name|list
decl_stmt|;
name|LayerWidget
modifier|*
name|lw
decl_stmt|;
name|int
name|visible
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|!
name|layersD
condition|)
return|return;
comment|/*  First determine if _any_ other layer widgets are set to visible  */
name|list
operator|=
name|layersD
operator|->
name|layer_widgets
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|lw
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|lw
operator|!=
name|layer_widget
condition|)
name|visible
operator||=
name|GIMP_DRAWABLE
argument_list|(
name|lw
operator|->
name|layer
argument_list|)
operator|->
name|visible
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
comment|/*  Now, toggle the visibility for all layers except the specified one  */
name|list
operator|=
name|layersD
operator|->
name|layer_widgets
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|lw
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|lw
operator|!=
name|layer_widget
condition|)
name|GIMP_DRAWABLE
argument_list|(
name|lw
operator|->
name|layer
argument_list|)
operator|->
name|visible
operator|=
operator|!
name|visible
expr_stmt|;
else|else
name|GIMP_DRAWABLE
argument_list|(
name|lw
operator|->
name|layer
argument_list|)
operator|->
name|visible
operator|=
name|TRUE
expr_stmt|;
name|layer_widget_eye_redraw
argument_list|(
name|lw
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_widget_layer_flush (GtkWidget * widget,gpointer data)
name|layer_widget_layer_flush
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LayerWidget
modifier|*
name|layer_widget
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|label_name
decl_stmt|;
name|int
name|update_layer_preview
init|=
name|FALSE
decl_stmt|;
name|int
name|update_mask_preview
init|=
name|FALSE
decl_stmt|;
name|layer_widget
operator|=
operator|(
name|LayerWidget
operator|*
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|layer
operator|=
name|layer_widget
operator|->
name|layer
expr_stmt|;
comment|/*  Set sensitivity  */
comment|/*  to false if there is a floating selection, and this aint it  */
if|if
condition|(
operator|!
name|layer_is_floating_sel
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|&&
name|layersD
operator|->
name|floating_sel
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
comment|/*  to true if there is a floating selection, and this is it  */
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|&&
name|layersD
operator|->
name|floating_sel
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
comment|/*  to true if there is not floating selection  */
elseif|else
if|if
condition|(
name|layersD
operator|->
name|floating_sel
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|GTK_WIDGET_IS_SENSITIVE
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|)
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|layer_widget
operator|->
name|list_item
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
comment|/*  if there is an active channel, unselect layer  */
if|if
condition|(
name|layersD
operator|->
name|active_channel
operator|!=
name|NULL
condition|)
name|layers_dialog_unset_layer
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
expr_stmt|;
comment|/*  otherwise, if this is the active layer, set  */
elseif|else
if|if
condition|(
name|layersD
operator|->
name|active_layer
operator|==
name|layer_widget
operator|->
name|layer
condition|)
block|{
name|layers_dialog_set_active_layer
argument_list|(
name|layersD
operator|->
name|active_layer
argument_list|)
expr_stmt|;
comment|/*  set the data widgets to reflect this layer's values        *  1)  The opacity slider        *  2)  The paint mode menu        *  3)  The preserve trans button        */
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|layersD
operator|->
name|opacity_data
argument_list|)
argument_list|,
operator|(
name|gfloat
operator|)
name|layer_widget
operator|->
name|layer
operator|->
name|opacity
operator|/
literal|2.55
argument_list|)
expr_stmt|;
name|gimp_option_menu_set_history
argument_list|(
name|GTK_OPTION_MENU
argument_list|(
name|layersD
operator|->
name|mode_option_menu
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|layer_widget
operator|->
name|layer
operator|->
name|mode
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|layersD
operator|->
name|preserve_trans
argument_list|)
argument_list|,
operator|(
name|layer_widget
operator|->
name|layer
operator|->
name|preserve_trans
operator|)
condition|?
name|GTK_STATE_ACTIVE
else|:
name|GTK_STATE_NORMAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
condition|)
name|name
operator|=
name|_
argument_list|(
literal|"Floating Selection"
argument_list|)
expr_stmt|;
else|else
name|name
operator|=
name|layer_get_name
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
expr_stmt|;
comment|/*  we need to set the name label if necessary  */
name|gtk_label_get
argument_list|(
name|GTK_LABEL
argument_list|(
name|layer_widget
operator|->
name|label
argument_list|)
argument_list|,
operator|&
name|label_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|label_name
argument_list|)
condition|)
name|gtk_label_set
argument_list|(
name|GTK_LABEL
argument_list|(
name|layer_widget
operator|->
name|label
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/*  show the layer mask preview if necessary  */
if|if
condition|(
name|layer_widget
operator|->
name|layer
operator|->
name|mask
operator|==
name|NULL
operator|&&
name|layer_widget
operator|->
name|layer_mask
condition|)
block|{
name|layer_widget
operator|->
name|layer_mask
operator|=
name|FALSE
expr_stmt|;
name|layers_dialog_remove_layer_mask
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|layer_widget
operator|->
name|layer
operator|->
name|mask
operator|!=
name|NULL
operator|&&
operator|!
name|layer_widget
operator|->
name|layer_mask
condition|)
block|{
name|layer_widget
operator|->
name|layer_mask
operator|=
name|TRUE
expr_stmt|;
name|layers_dialog_add_layer_mask
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
expr_stmt|;
block|}
comment|/*  Update the previews  */
name|update_layer_preview
operator|=
operator|(
operator|!
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|preview_valid
operator|)
expr_stmt|;
if|if
condition|(
name|layer
operator|->
name|mask
condition|)
block|{
name|update_mask_preview
operator|=
operator|(
operator|!
name|GIMP_DRAWABLE
argument_list|(
name|layer
operator|->
name|mask
argument_list|)
operator|->
name|preview_valid
operator|)
expr_stmt|;
if|if
condition|(
name|layer
operator|->
name|apply_mask
operator|!=
name|layer_widget
operator|->
name|apply_mask
condition|)
block|{
name|layer_widget
operator|->
name|apply_mask
operator|=
name|layer
operator|->
name|apply_mask
expr_stmt|;
name|update_mask_preview
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|layer
operator|->
name|show_mask
operator|!=
name|layer_widget
operator|->
name|show_mask
condition|)
block|{
name|layer_widget
operator|->
name|show_mask
operator|=
name|layer
operator|->
name|show_mask
expr_stmt|;
name|update_mask_preview
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|layer
operator|->
name|edit_mask
operator|!=
name|layer_widget
operator|->
name|edit_mask
condition|)
block|{
name|layer_widget
operator|->
name|edit_mask
operator|=
name|layer
operator|->
name|edit_mask
expr_stmt|;
if|if
condition|(
name|layer
operator|->
name|edit_mask
operator|==
name|TRUE
condition|)
name|layer_widget
operator|->
name|active_preview
operator|=
name|MASK_PREVIEW
expr_stmt|;
else|else
name|layer_widget
operator|->
name|active_preview
operator|=
name|LAYER_PREVIEW
expr_stmt|;
comment|/*  The boundary indicating whether layer or mask is active  */
name|layer_widget_boundary_redraw
argument_list|(
name|layer_widget
argument_list|,
name|LAYER_PREVIEW
argument_list|)
expr_stmt|;
name|layer_widget_boundary_redraw
argument_list|(
name|layer_widget
argument_list|,
name|MASK_PREVIEW
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|update_layer_preview
condition|)
name|gtk_widget_queue_draw
argument_list|(
name|layer_widget
operator|->
name|layer_preview
argument_list|)
expr_stmt|;
if|if
condition|(
name|update_mask_preview
condition|)
name|gtk_widget_queue_draw
argument_list|(
name|layer_widget
operator|->
name|mask_preview
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/********************************/
end_comment

begin_comment
comment|/*  The new layer query dialog  */
end_comment

begin_comment
comment|/********************************/
end_comment

begin_typedef
DECL|typedef|NewLayerOptions
typedef|typedef
name|struct
name|_NewLayerOptions
name|NewLayerOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_NewLayerOptions
struct|struct
name|_NewLayerOptions
block|{
DECL|member|query_box
name|GtkWidget
modifier|*
name|query_box
decl_stmt|;
DECL|member|name_entry
name|GtkWidget
modifier|*
name|name_entry
decl_stmt|;
DECL|member|size_se
name|GtkWidget
modifier|*
name|size_se
decl_stmt|;
DECL|member|fill_type
name|GimpFillType
name|fill_type
decl_stmt|;
DECL|member|xsize
name|gint
name|xsize
decl_stmt|;
DECL|member|ysize
name|gint
name|ysize
decl_stmt|;
DECL|member|gimage
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
DECL|variable|fill_type
specifier|static
name|GimpFillType
name|fill_type
init|=
name|TRANSPARENT_FILL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|layer_name
specifier|static
name|gchar
modifier|*
name|layer_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|new_layer_query_ok_callback (GtkWidget * widget,gpointer data)
name|new_layer_query_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|NewLayerOptions
modifier|*
name|options
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|options
operator|=
operator|(
name|NewLayerOptions
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|layer_name
condition|)
name|g_free
argument_list|(
name|layer_name
argument_list|)
expr_stmt|;
name|layer_name
operator|=
name|g_strdup
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|options
operator|->
name|name_entry
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|options
operator|->
name|xsize
operator|=
call|(
name|gint
call|)
argument_list|(
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|options
operator|->
name|ysize
operator|=
call|(
name|gint
call|)
argument_list|(
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|fill_type
operator|=
name|options
operator|->
name|fill_type
expr_stmt|;
if|if
condition|(
operator|(
name|gimage
operator|=
name|options
operator|->
name|gimage
operator|)
condition|)
block|{
comment|/*  Start a group undo  */
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|LAYER_ADD_UNDO
argument_list|)
expr_stmt|;
name|layer
operator|=
name|layer_new
argument_list|(
name|gimage
argument_list|,
name|options
operator|->
name|xsize
argument_list|,
name|options
operator|->
name|ysize
argument_list|,
name|gimage_base_type_with_alpha
argument_list|(
name|gimage
argument_list|)
argument_list|,
name|layer_name
argument_list|,
name|OPAQUE_OPACITY
argument_list|,
name|NORMAL_MODE
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer
condition|)
block|{
name|drawable_fill
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
name|fill_type
argument_list|)
expr_stmt|;
name|gimage_add_layer
argument_list|(
name|gimage
argument_list|,
name|layer
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*  End the group undo  */
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|g_message
argument_list|(
literal|"new_layer_query_ok_callback():\n"
literal|"could not allocate new layer"
argument_list|)
expr_stmt|;
block|}
block|}
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|new_layer_query_cancel_callback (GtkWidget * widget,gpointer data)
name|new_layer_query_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|NewLayerOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|NewLayerOptions
operator|*
operator|)
name|data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_new_layer_query (GimpImage * gimage)
name|layers_dialog_new_layer_query
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|)
block|{
name|NewLayerOptions
modifier|*
name|options
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkObject
modifier|*
name|adjustment
decl_stmt|;
name|GtkWidget
modifier|*
name|spinbutton
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
comment|/*  The new options structure  */
name|options
operator|=
name|g_new
argument_list|(
name|NewLayerOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|options
operator|->
name|fill_type
operator|=
name|fill_type
expr_stmt|;
name|options
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
comment|/*  The dialog  */
name|options
operator|->
name|query_box
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"New Layer Options"
argument_list|)
argument_list|,
literal|"new_layer_options"
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"dialogs/layers/new_layer.html"
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"OK"
argument_list|)
argument_list|,
name|new_layer_query_ok_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|,
name|new_layer_query_cancel_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  The main vbox  */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  The name label and entry  */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Layer Name:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|options
operator|->
name|name_entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|options
operator|->
name|name_entry
argument_list|,
literal|75
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach_defaults
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|options
operator|->
name|name_entry
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|options
operator|->
name|name_entry
argument_list|)
argument_list|,
operator|(
name|layer_name
condition|?
name|layer_name
else|:
name|_
argument_list|(
literal|"New Layer"
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|name_entry
argument_list|)
expr_stmt|;
comment|/*  The size labels  */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Layer Width:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Height:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/*  The size sizeentry  */
name|adjustment
operator|=
name|gtk_adjustment_new
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|spinbutton
operator|=
name|gtk_spin_button_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|adjustment
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_shadow_type
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|GTK_SHADOW_NONE
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_numeric
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|spinbutton
argument_list|,
literal|75
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|options
operator|->
name|size_se
operator|=
name|gimp_size_entry_new
argument_list|(
literal|1
argument_list|,
name|gimage
operator|->
name|unit
argument_list|,
literal|"%a"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|75
argument_list|,
name|GIMP_SIZE_ENTRY_UPDATE_SIZE
argument_list|)
expr_stmt|;
name|gimp_size_entry_add_field
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
name|GTK_SPIN_BUTTON
argument_list|(
name|spinbutton
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_table_attach_defaults
argument_list|(
name|GTK_TABLE
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
name|spinbutton
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|spinbutton
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|options
operator|->
name|size_se
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_unit
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
name|GIMP_UNIT_PIXEL
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|xresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_resolution
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|1
argument_list|,
name|gimage
operator|->
name|yresolution
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|0
argument_list|,
name|GIMP_MIN_IMAGE_SIZE
argument_list|,
name|GIMP_MAX_IMAGE_SIZE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval_boundaries
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|1
argument_list|,
name|GIMP_MIN_IMAGE_SIZE
argument_list|,
name|GIMP_MAX_IMAGE_SIZE
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_size
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|options
operator|->
name|size_se
argument_list|)
argument_list|,
literal|1
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/*  The radio frame  */
name|frame
operator|=
name|gimp_radio_group_new2
argument_list|(
name|TRUE
argument_list|,
name|_
argument_list|(
literal|"Layer Fill Type"
argument_list|)
argument_list|,
name|gimp_radio_button_update
argument_list|,
operator|&
name|options
operator|->
name|fill_type
argument_list|,
operator|(
name|gpointer
operator|)
name|options
operator|->
name|fill_type
argument_list|,
name|_
argument_list|(
literal|"Foreground"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|FOREGROUND_FILL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Background"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|BACKGROUND_FILL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"White"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|WHITE_FILL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Transparent"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|TRANSPARENT_FILL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************/
end_comment

begin_comment
comment|/*  The edit layer attributes dialog  */
end_comment

begin_comment
comment|/**************************************/
end_comment

begin_typedef
DECL|typedef|EditLayerOptions
typedef|typedef
name|struct
name|_EditLayerOptions
name|EditLayerOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_EditLayerOptions
struct|struct
name|_EditLayerOptions
block|{
DECL|member|query_box
name|GtkWidget
modifier|*
name|query_box
decl_stmt|;
DECL|member|name_entry
name|GtkWidget
modifier|*
name|name_entry
decl_stmt|;
DECL|member|layer
name|GimpLayer
modifier|*
name|layer
decl_stmt|;
DECL|member|gimage
name|GImage
modifier|*
name|gimage
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
DECL|function|edit_layer_query_ok_callback (GtkWidget * widget,gpointer data)
name|edit_layer_query_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|EditLayerOptions
modifier|*
name|options
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|options
operator|=
operator|(
name|EditLayerOptions
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|layer
operator|=
name|options
operator|->
name|layer
operator|)
condition|)
block|{
comment|/*  Set the new layer name  */
if|if
condition|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|name
operator|&&
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
block|{
comment|/*  If the layer is a floating selection, make it a layer  */
name|floating_sel_to_layer
argument_list|(
name|layer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* We're doing a plain rename */
name|undo_push_layer_rename
argument_list|(
name|options
operator|->
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
block|}
name|layer_set_name
argument_list|(
name|layer
argument_list|,
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|options
operator|->
name|name_entry
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|gdisplays_flush
argument_list|()
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|edit_layer_query_cancel_callback (GtkWidget * widget,gpointer data)
name|edit_layer_query_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|EditLayerOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|EditLayerOptions
operator|*
operator|)
name|data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_edit_layer_query (LayerWidget * layer_widget)
name|layers_dialog_edit_layer_query
parameter_list|(
name|LayerWidget
modifier|*
name|layer_widget
parameter_list|)
block|{
name|EditLayerOptions
modifier|*
name|options
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
comment|/*  The new options structure  */
name|options
operator|=
name|g_new
argument_list|(
name|EditLayerOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|options
operator|->
name|layer
operator|=
name|layer_widget
operator|->
name|layer
expr_stmt|;
name|options
operator|->
name|gimage
operator|=
name|layer_widget
operator|->
name|gimage
expr_stmt|;
comment|/*  The dialog  */
name|options
operator|->
name|query_box
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Edit Layer Attributes"
argument_list|)
argument_list|,
literal|"edit_layer_attributes"
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"dialogs/layers/edit_layer_attributes.html"
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"OK"
argument_list|)
argument_list|,
name|edit_layer_query_ok_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|,
name|edit_layer_query_cancel_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  The main vbox  */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
comment|/*  The name hbox, label and entry  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Layer name:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|options
operator|->
name|name_entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|options
operator|->
name|name_entry
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|options
operator|->
name|name_entry
argument_list|)
argument_list|,
operator|(
operator|(
name|layer_is_floating_sel
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
condition|?
name|_
argument_list|(
literal|"Floating Selection"
argument_list|)
else|:
name|layer_get_name
argument_list|(
name|layer_widget
operator|->
name|layer
argument_list|)
operator|)
operator|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|name_entry
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************/
end_comment

begin_comment
comment|/*  The add mask query dialog  */
end_comment

begin_comment
comment|/*******************************/
end_comment

begin_typedef
DECL|typedef|AddMaskOptions
typedef|typedef
name|struct
name|_AddMaskOptions
name|AddMaskOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_AddMaskOptions
struct|struct
name|_AddMaskOptions
block|{
DECL|member|query_box
name|GtkWidget
modifier|*
name|query_box
decl_stmt|;
DECL|member|layer
name|Layer
modifier|*
name|layer
decl_stmt|;
DECL|member|add_mask_type
name|AddMaskType
name|add_mask_type
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
DECL|function|add_mask_query_ok_callback (GtkWidget * widget,gpointer data)
name|add_mask_query_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|AddMaskOptions
modifier|*
name|options
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|LayerMask
modifier|*
name|mask
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|options
operator|=
operator|(
name|AddMaskOptions
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|layer
operator|=
operator|(
name|options
operator|->
name|layer
operator|)
operator|)
operator|&&
operator|(
name|gimage
operator|=
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|gimage
operator|)
condition|)
block|{
name|mask
operator|=
name|layer_create_mask
argument_list|(
name|layer
argument_list|,
name|options
operator|->
name|add_mask_type
argument_list|)
expr_stmt|;
name|gimage_add_layer_mask
argument_list|(
name|gimage
argument_list|,
name|layer
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_mask_query_cancel_callback (GtkWidget * widget,gpointer data)
name|add_mask_query_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|AddMaskOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|AddMaskOptions
operator|*
operator|)
name|data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_add_mask_query (Layer * layer)
name|layers_dialog_add_mask_query
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|AddMaskOptions
modifier|*
name|options
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
comment|/*  The new options structure  */
name|options
operator|=
name|g_new
argument_list|(
name|AddMaskOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|options
operator|->
name|layer
operator|=
name|layer
expr_stmt|;
name|options
operator|->
name|add_mask_type
operator|=
name|ADD_WHITE_MASK
expr_stmt|;
comment|/*  The dialog  */
name|options
operator|->
name|query_box
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Add Mask Options"
argument_list|)
argument_list|,
literal|"add_mask_options"
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"dialogs/layers/add_mask.html"
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"OK"
argument_list|)
argument_list|,
name|add_mask_query_ok_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|,
name|add_mask_query_cancel_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  The radio frame and box  */
name|frame
operator|=
name|gimp_radio_group_new2
argument_list|(
name|TRUE
argument_list|,
name|_
argument_list|(
literal|"Initialize Layer Mask to:"
argument_list|)
argument_list|,
name|gimp_radio_button_update
argument_list|,
operator|&
name|options
operator|->
name|add_mask_type
argument_list|,
operator|(
name|gpointer
operator|)
name|options
operator|->
name|add_mask_type
argument_list|,
name|_
argument_list|(
literal|"White (Full Opacity)"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|ADD_WHITE_MASK
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Black (Full Transparency)"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|ADD_BLACK_MASK
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Layer's Alpha Channel"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|ADD_ALPHA_MASK
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*********************************/
end_comment

begin_comment
comment|/*  The apply layer mask dialog  */
end_comment

begin_comment
comment|/*********************************/
end_comment

begin_typedef
DECL|typedef|ApplyMaskOptions
typedef|typedef
name|struct
name|_ApplyMaskOptions
name|ApplyMaskOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_ApplyMaskOptions
struct|struct
name|_ApplyMaskOptions
block|{
DECL|member|query_box
name|GtkWidget
modifier|*
name|query_box
decl_stmt|;
DECL|member|layer
name|Layer
modifier|*
name|layer
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
DECL|function|apply_mask_query_apply_callback (GtkWidget * widget,gpointer data)
name|apply_mask_query_apply_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ApplyMaskOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|ApplyMaskOptions
operator|*
operator|)
name|data
expr_stmt|;
name|gimage_remove_layer_mask
argument_list|(
name|drawable_gimage
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|options
operator|->
name|layer
argument_list|)
argument_list|)
argument_list|,
name|options
operator|->
name|layer
argument_list|,
name|APPLY
argument_list|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|apply_mask_query_discard_callback (GtkWidget * widget,gpointer data)
name|apply_mask_query_discard_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ApplyMaskOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|ApplyMaskOptions
operator|*
operator|)
name|data
expr_stmt|;
name|gimage_remove_layer_mask
argument_list|(
name|drawable_gimage
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|options
operator|->
name|layer
argument_list|)
argument_list|)
argument_list|,
name|options
operator|->
name|layer
argument_list|,
name|DISCARD
argument_list|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|apply_mask_query_cancel_callback (GtkWidget * widget,gpointer data)
name|apply_mask_query_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ApplyMaskOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|ApplyMaskOptions
operator|*
operator|)
name|data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_apply_mask_query (Layer * layer)
name|layers_dialog_apply_mask_query
parameter_list|(
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|ApplyMaskOptions
modifier|*
name|options
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
comment|/*  The new options structure  */
name|options
operator|=
name|g_new
argument_list|(
name|ApplyMaskOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|options
operator|->
name|layer
operator|=
name|layer
expr_stmt|;
comment|/*  The dialog  */
name|options
operator|->
name|query_box
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Layer Mask Options"
argument_list|)
argument_list|,
literal|"layer_mask_options"
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"dialogs/layers/apply_mask.html"
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Apply"
argument_list|)
argument_list|,
name|apply_mask_query_apply_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Discard"
argument_list|)
argument_list|,
name|apply_mask_query_discard_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|,
name|apply_mask_query_cancel_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  The main vbox  */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
comment|/*  The name entry hbox, label and entry  */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Apply layer mask?"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  The scale layer dialog  */
end_comment

begin_comment
comment|/****************************/
end_comment

begin_typedef
DECL|typedef|ScaleLayerOptions
typedef|typedef
name|struct
name|_ScaleLayerOptions
name|ScaleLayerOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_ScaleLayerOptions
struct|struct
name|_ScaleLayerOptions
block|{
DECL|member|layer
name|Layer
modifier|*
name|layer
decl_stmt|;
DECL|member|resize
name|Resize
modifier|*
name|resize
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
DECL|function|scale_layer_query_ok_callback (GtkWidget * widget,gpointer data)
name|scale_layer_query_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ScaleLayerOptions
modifier|*
name|options
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|options
operator|=
operator|(
name|ScaleLayerOptions
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|resize
operator|->
name|width
operator|>
literal|0
operator|&&
name|options
operator|->
name|resize
operator|->
name|height
operator|>
literal|0
operator|&&
operator|(
name|layer
operator|=
operator|(
name|options
operator|->
name|layer
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|gimage
operator|=
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|gimage
operator|)
operator|!=
name|NULL
condition|)
block|{
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|LAYER_SCALE_UNDO
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_relax
argument_list|(
name|layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|layer_scale
argument_list|(
name|layer
argument_list|,
name|options
operator|->
name|resize
operator|->
name|width
argument_list|,
name|options
operator|->
name|resize
operator|->
name|height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_rigor
argument_list|(
name|layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
name|resize_widget_free
argument_list|(
name|options
operator|->
name|resize
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
else|else
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Invalid width or height.\n"
literal|"Both must be positive."
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|scale_layer_query_cancel_callback (GtkWidget * widget,gpointer data)
name|scale_layer_query_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ScaleLayerOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|ScaleLayerOptions
operator|*
operator|)
name|data
expr_stmt|;
name|resize_widget_free
argument_list|(
name|options
operator|->
name|resize
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_scale_layer_query (GImage * gimage,Layer * layer)
name|layers_dialog_scale_layer_query
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|ScaleLayerOptions
modifier|*
name|options
decl_stmt|;
comment|/*  the new options structure  */
name|options
operator|=
name|g_new
argument_list|(
name|ScaleLayerOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|options
operator|->
name|layer
operator|=
name|layer
expr_stmt|;
name|options
operator|->
name|resize
operator|=
name|resize_widget_new
argument_list|(
name|ScaleWidget
argument_list|,
name|ResizeLayer
argument_list|,
name|GTK_OBJECT
argument_list|(
name|layer
argument_list|)
argument_list|,
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
argument_list|,
name|gimage
operator|->
name|xresolution
argument_list|,
name|gimage
operator|->
name|yresolution
argument_list|,
name|gimage
operator|->
name|unit
argument_list|,
name|TRUE
argument_list|,
name|scale_layer_query_ok_callback
argument_list|,
name|scale_layer_query_cancel_callback
argument_list|,
name|options
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|resize
operator|->
name|resize_shell
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************/
end_comment

begin_comment
comment|/*  The resize layer dialog  */
end_comment

begin_comment
comment|/*****************************/
end_comment

begin_typedef
DECL|typedef|ResizeLayerOptions
typedef|typedef
name|struct
name|_ResizeLayerOptions
name|ResizeLayerOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_ResizeLayerOptions
struct|struct
name|_ResizeLayerOptions
block|{
DECL|member|layer
name|Layer
modifier|*
name|layer
decl_stmt|;
DECL|member|resize
name|Resize
modifier|*
name|resize
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
DECL|function|resize_layer_query_ok_callback (GtkWidget * widget,gpointer data)
name|resize_layer_query_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ResizeLayerOptions
modifier|*
name|options
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|Layer
modifier|*
name|layer
decl_stmt|;
name|options
operator|=
operator|(
name|ResizeLayerOptions
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|resize
operator|->
name|width
operator|>
literal|0
operator|&&
name|options
operator|->
name|resize
operator|->
name|height
operator|>
literal|0
operator|&&
operator|(
name|layer
operator|=
operator|(
name|options
operator|->
name|layer
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|gimage
operator|=
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
operator|->
name|gimage
operator|)
operator|!=
name|NULL
condition|)
block|{
name|undo_push_group_start
argument_list|(
name|gimage
argument_list|,
name|LAYER_RESIZE_UNDO
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_relax
argument_list|(
name|layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|layer_resize
argument_list|(
name|layer
argument_list|,
name|options
operator|->
name|resize
operator|->
name|width
argument_list|,
name|options
operator|->
name|resize
operator|->
name|height
argument_list|,
name|options
operator|->
name|resize
operator|->
name|offset_x
argument_list|,
name|options
operator|->
name|resize
operator|->
name|offset_y
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_is_floating_sel
argument_list|(
name|layer
argument_list|)
condition|)
name|floating_sel_rigor
argument_list|(
name|layer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|undo_push_group_end
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
block|}
name|resize_widget_free
argument_list|(
name|options
operator|->
name|resize
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
else|else
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Invalid width or height.\n"
literal|"Both must be positive."
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|resize_layer_query_cancel_callback (GtkWidget * widget,gpointer data)
name|resize_layer_query_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|ResizeLayerOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|ResizeLayerOptions
operator|*
operator|)
name|data
expr_stmt|;
name|resize_widget_free
argument_list|(
name|options
operator|->
name|resize
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layers_dialog_resize_layer_query (GImage * gimage,Layer * layer)
name|layers_dialog_resize_layer_query
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
name|Layer
modifier|*
name|layer
parameter_list|)
block|{
name|ResizeLayerOptions
modifier|*
name|options
decl_stmt|;
comment|/*  the new options structure  */
name|options
operator|=
name|g_new
argument_list|(
name|ResizeLayerOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|options
operator|->
name|layer
operator|=
name|layer
expr_stmt|;
name|options
operator|->
name|resize
operator|=
name|resize_widget_new
argument_list|(
name|ResizeWidget
argument_list|,
name|ResizeLayer
argument_list|,
name|GTK_OBJECT
argument_list|(
name|layer
argument_list|)
argument_list|,
name|drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
argument_list|,
name|drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
argument_list|,
name|gimage
operator|->
name|xresolution
argument_list|,
name|gimage
operator|->
name|yresolution
argument_list|,
name|gimage
operator|->
name|unit
argument_list|,
name|TRUE
argument_list|,
name|resize_layer_query_ok_callback
argument_list|,
name|resize_layer_query_cancel_callback
argument_list|,
name|options
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|resize
operator|->
name|resize_shell
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/*  The layer merge dialog  */
end_comment

begin_comment
comment|/****************************/
end_comment

begin_typedef
DECL|typedef|LayerMergeOptions
typedef|typedef
name|struct
name|_LayerMergeOptions
name|LayerMergeOptions
typedef|;
end_typedef

begin_struct
DECL|struct|_LayerMergeOptions
struct|struct
name|_LayerMergeOptions
block|{
DECL|member|query_box
name|GtkWidget
modifier|*
name|query_box
decl_stmt|;
DECL|member|gimage
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
DECL|member|merge_visible
name|gboolean
name|merge_visible
decl_stmt|;
DECL|member|merge_type
name|MergeType
name|merge_type
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
DECL|function|layer_merge_query_ok_callback (GtkWidget * widget,gpointer data)
name|layer_merge_query_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LayerMergeOptions
modifier|*
name|options
decl_stmt|;
name|GImage
modifier|*
name|gimage
decl_stmt|;
name|options
operator|=
operator|(
name|LayerMergeOptions
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimage
operator|=
name|options
operator|->
name|gimage
operator|)
condition|)
return|return;
if|if
condition|(
name|options
operator|->
name|merge_visible
condition|)
name|gimage_merge_visible_layers
argument_list|(
name|gimage
argument_list|,
name|options
operator|->
name|merge_type
argument_list|)
expr_stmt|;
name|gdisplays_flush
argument_list|()
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|layer_merge_query_cancel_callback (GtkWidget * widget,gpointer data)
name|layer_merge_query_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|LayerMergeOptions
modifier|*
name|options
decl_stmt|;
name|options
operator|=
operator|(
name|LayerMergeOptions
operator|*
operator|)
name|data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|layers_dialog_layer_merge_query (GImage * gimage,gboolean merge_visible)
name|layers_dialog_layer_merge_query
parameter_list|(
name|GImage
modifier|*
name|gimage
parameter_list|,
comment|/*  if FALSE, anchor active layer  */
name|gboolean
name|merge_visible
parameter_list|)
block|{
name|LayerMergeOptions
modifier|*
name|options
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
comment|/*  The new options structure  */
name|options
operator|=
name|g_new
argument_list|(
name|LayerMergeOptions
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|options
operator|->
name|gimage
operator|=
name|gimage
expr_stmt|;
name|options
operator|->
name|merge_visible
operator|=
name|merge_visible
expr_stmt|;
name|options
operator|->
name|merge_type
operator|=
name|EXPAND_AS_NECESSARY
expr_stmt|;
comment|/* The dialog  */
name|options
operator|->
name|query_box
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Layer Merge Options"
argument_list|)
argument_list|,
literal|"layer_merge_options"
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"dialogs/layers/merge_visible_layers.html"
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"OK"
argument_list|)
argument_list|,
name|layer_merge_query_ok_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|,
name|layer_merge_query_cancel_callback
argument_list|,
name|options
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  The main vbox  */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_radio_group_new2
argument_list|(
name|TRUE
argument_list|,
name|merge_visible
condition|?
name|_
argument_list|(
literal|"Final, Merged Layer should be:"
argument_list|)
else|:
name|_
argument_list|(
literal|"Final, Anchored Layer should be:"
argument_list|)
argument_list|,
name|gimp_radio_button_update
argument_list|,
operator|&
name|options
operator|->
name|merge_type
argument_list|,
operator|(
name|gpointer
operator|)
name|options
operator|->
name|merge_type
argument_list|,
name|_
argument_list|(
literal|"Expanded as necessary"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|EXPAND_AS_NECESSARY
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Clipped to image"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|CLIP_TO_IMAGE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Clipped to bottom layer"
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|CLIP_TO_BOTTOM_LAYER
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|options
operator|->
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

