begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<glib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"install.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"gimpui.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpenv.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|G_OS_WIN32
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|__EMX__
end_ifndef

begin_define
DECL|macro|USER_INSTALL
define|#
directive|define
name|USER_INSTALL
value|"user_install"
end_define

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<process.h>
end_include

begin_define
DECL|macro|USER_INSTALL
define|#
directive|define
name|USER_INSTALL
value|"user_install.cmd"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_define
DECL|macro|STRICT
define|#
directive|define
name|STRICT
end_define

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_define
DECL|macro|USER_INSTALL
define|#
directive|define
name|USER_INSTALL
value|"user_install.bat"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|install_run
parameter_list|(
name|InstallCallback
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|install_help
parameter_list|(
name|InstallCallback
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|help_install_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|help_ignore_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|help_quit_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|install_continue_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|install_quit_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|help_widget
specifier|static
name|GtkWidget
modifier|*
name|help_widget
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|install_widget
specifier|static
name|GtkWidget
modifier|*
name|install_widget
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|install_verify (InstallCallback install_callback)
name|install_verify
parameter_list|(
name|InstallCallback
name|install_callback
parameter_list|)
block|{
name|int
name|properly_installed
init|=
name|TRUE
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
name|struct
name|stat
name|stat_buf
decl_stmt|;
name|filename
operator|=
name|gimp_directory
argument_list|()
expr_stmt|;
comment|/* gimp_directory now always returns something */
if|if
condition|(
name|stat
argument_list|(
name|filename
argument_list|,
operator|&
name|stat_buf
argument_list|)
operator|!=
literal|0
condition|)
name|properly_installed
operator|=
name|FALSE
expr_stmt|;
comment|/*  If there is already a proper installation, invoke the callback  */
if|if
condition|(
name|properly_installed
condition|)
block|{
call|(
modifier|*
name|install_callback
call|)
argument_list|()
expr_stmt|;
block|}
comment|/*  Otherwise, prepare for installation  */
elseif|else
if|if
condition|(
name|no_interface
condition|)
block|{
name|g_print
argument_list|(
name|_
argument_list|(
literal|"The GIMP is not properly installed for the current user\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"User installation was skipped because the '--nointerface' flag was encountered\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"To perform user installation, run the GIMP without the '--nointerface' flag\n"
argument_list|)
argument_list|)
expr_stmt|;
call|(
modifier|*
name|install_callback
call|)
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|install_help
argument_list|(
name|install_callback
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*********************/
end_comment

begin_comment
comment|/*  Local functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|install_help (InstallCallback callback)
name|install_help
parameter_list|(
name|InstallCallback
name|callback
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|text
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|vsb
decl_stmt|;
name|GtkAdjustment
modifier|*
name|vadj
decl_stmt|;
name|GdkFont
modifier|*
name|font_strong
decl_stmt|;
name|GdkFont
modifier|*
name|font_emphasis
decl_stmt|;
name|GdkFont
modifier|*
name|font
decl_stmt|;
DECL|struct|__anon274e89970108
specifier|static
specifier|const
struct|struct
block|{
DECL|member|font
name|gint
name|font
decl_stmt|;
DECL|member|text
name|char
modifier|*
name|text
decl_stmt|;
block|}
name|help_lines
index|[]
init|=
block|{
block|{
literal|2
block|,
name|N_
argument_list|(
literal|"The GIMP - GNU Image Manipulation Program\n\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"Copyright (C) 1995 Spencer Kimball and Peter Mattis\n"
block|}
block|,
block|{
literal|0
block|,
literal|"\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"This program is free software; you can redistribute it and/or modify\n"
literal|"it under the terms of the GNU General Public License as published by\n"
literal|"the Free Software Foundation; either version 2 of the License, or\n"
literal|"(at your option) any later version.\n"
argument_list|)
block|}
block|,
block|{
literal|0
block|,
literal|"\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"This program is distributed in the hope that it will be useful,\n"
literal|"but WITHOUT ANY WARRANTY; without even the implied warranty of\n"
literal|"MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n"
literal|"See the GNU General Public License for more details.\n"
argument_list|)
block|}
block|,
block|{
literal|0
block|,
literal|"\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"You should have received a copy of the GNU General Public License\n"
literal|"along with this program; if not, write to the Free Software\n"
literal|"Foundation, Inc., 59 Temple Place - Suite 330, Boston,\n"
literal|"MA 02111-1307, USA.\n"
argument_list|)
block|}
block|,
block|{
literal|0
block|,
literal|"\n\n"
block|}
block|,
block|{
literal|2
block|,
name|N_
argument_list|(
literal|"Personal GIMP Installation\n\n"
argument_list|)
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"For a proper GIMP installation, a subdirectory called\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
name|NULL
block|}
block|,
comment|/* will be replaced with gimp_directory() */
block|{
literal|0
block|,
name|N_
argument_list|(
literal|" needs to be created.  This\n"
literal|"subdirectory will contain a number of important files:\n\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"gimprc\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThe gimprc is used to store personal preferences\n"
literal|"\t\tthat affect GIMP's default behavior.\n"
literal|"\t\tPaths to search for brushes, palettes, gradients,\n"
literal|"\t\tpatterns, plug-ins and modules can also configured here.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"pluginrc\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tPlug-ins and extensions are external programs run by\n"
literal|"\t\tthe GIMP which provide additional functionality.\n"
literal|"\t\tThese programs are searched for at run-time and\n"
literal|"\t\tinformation about their functionality and mod-times\n"
literal|"\t\tis cached in this file.  This file is intended to\n"
literal|"\t\tbe GIMP-readable only, and should not be edited.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"menurc\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tKey shortcuts can be dynamically redefined in The GIMP.\n"
literal|"\t\tThe menurc is a dump of your configuration so it can.\n"
literal|"\t\tbe remembered for the next session. You may edit this\n"
literal|"\t\tfile if you wish, but it is much easier to define the\n"
literal|"\t\tkeys from within The GIMP. Deleting this file will\n"
literal|"\t\trestore the default shortcuts.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"sessionrc\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThe sessionrc is used to store what dialog windows were\n"
literal|"\t\topen the last time you quit The GIMP. You can configure\n"
literal|"\t\tThe GIMP to reopen these dialogs at the saved position.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"unitrc\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThe unitrc is used to store your user units database.\n"
literal|"\t\tYou can define additional units and use them just\n"
literal|"\t\tlike you use the built-in units inches, millimeters,\n"
literal|"\t\tpoints and picas. This file is overwritten each time\n"
literal|"\t\tyou quit the GIMP.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"brushes\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which can be used to store\n"
literal|"\t\tuser defined brushes.  The default gimprc file\n"
literal|"\t\tchecks this subdirectory in addition to the system-\n"
literal|"\t\twide gimp brushes installation when searching for\n"
literal|"\t\tbrushes.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"generated_brushes\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which is used to store brushes\n"
literal|"\t\tthat are created with the brush editor.  The default\n"
literal|"\t\tgimprc file checks this subdirectory when searching for\n"
literal|"\t\tgenerated brushes.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"gradients\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which can be used to store\n"
literal|"\t\tuser defined gradients.  The default gimprc file\n"
literal|"\t\tchecks this subdirectory in addition to the system-\n"
literal|"\t\twide gimp gradients installation when searching for\n"
literal|"\t\tgradients.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"gfig\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which can be used to store\n"
literal|"\t\tuser defined figures to be used by the gfig plug-in.\n"
literal|"\t\tThe default gimprc file checks this subdirectory in\n"
literal|"\t\taddition to the systemwide gimp gfig installation\n"
literal|"\t\twhen searching for gfig figures.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"gflares\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which can be used to store\n"
literal|"\t\tuser defined gflares to be used by the gflare plug-in.\n"
literal|"\t\tThe default gimprc file checks this subdirectory in\n"
literal|"\t\taddition to the systemwide gimp gflares installation\n"
literal|"\t\twhen searching for gflares.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"fractalexplorer\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which can be used to store\n"
literal|"\t\tuser defined fractals to be used by the FractalExplorer\n"
literal|"\t\tplug-in. The default gimprc file checks this subdirectory in\n"
literal|"\t\taddition to the systemwide gimp FractalExplorer installation\n"
literal|"\t\twhen searching for fractals.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"palettes\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which can be used to store\n"
literal|"\t\tuser defined palettes.  The default gimprc file\n"
literal|"\t\tchecks only this subdirectory (not the system-wide\n"
literal|"\t\tinstallation) when searching for palettes.  During\n"
literal|"\t\tinstallation, the system palettes will be copied\n"
literal|"\t\there.  This is done to allow modifications made to\n"
literal|"\t\tpalettes during GIMP execution to persist across\n"
literal|"\t\tsessions.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"patterns\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which can be used to store\n"
literal|"\t\tuser defined patterns.  The default gimprc file\n"
literal|"\t\tchecks this subdirectory in addition to the system-\n"
literal|"\t\twide gimp patterns installation when searching for\n"
literal|"\t\tpatterns.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"plug-ins\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis is a subdirectory which can be used to store\n"
literal|"\t\tuser created, temporary, or otherwise non-system-\n"
literal|"\t\tsupported plug-ins.  The default gimprc file\n"
literal|"\t\tchecks this subdirectory in addition to the system-\n"
literal|"\t\twide GIMP plug-in directories when searching for\n"
literal|"\t\tplug-ins.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"modules\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis subdirectory can be used to store user created,\n"
literal|"\t\ttemporary, or otherwise non-system-supported DLL modules.\n"
literal|"\t\tThe default gimprc file checks this subdirectory\n"
literal|"\t\tin addition to the system-wide GIMP module directory\n"
literal|"\t\twhen searching for modules to load when initializing.\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"scripts\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis subdirectory is used by the GIMP to store \n"
literal|"\t\tuser created and installed scripts. The default gimprc\n"
literal|"\t\tfile checks this subdirectory in addition to the system\n"
literal|"\t\t-wide gimp scripts subdirectory when searching for scripts\n"
argument_list|)
block|}
block|,
block|{
literal|1
block|,
literal|"tmp\n"
block|}
block|,
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"\t\tThis subdirectory is used by the GIMP to temporarily\n"
literal|"\t\tstore undo buffers to reduce memory usage.  If GIMP is\n"
literal|"\t\tunceremoniously killed, files may persist in this directory\n"
literal|"\t\tof the form: gimp<#>.<#>.  These files are useless across\n"
literal|"\t\tGIMP sessions and can be destroyed with impunity.\n"
argument_list|)
block|}
block|}
struct|;
name|gint
name|nhelp_lines
init|=
sizeof|sizeof
argument_list|(
name|help_lines
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|help_lines
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|help_widget
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"GIMP Installation"
argument_list|)
argument_list|,
literal|"gimp_installation"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|GTK_WIN_POS_CENTER
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Install"
argument_list|)
argument_list|,
name|help_install_callback
argument_list|,
name|callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Ignore"
argument_list|)
argument_list|,
name|help_ignore_callback
argument_list|,
name|callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Quit"
argument_list|)
argument_list|,
name|help_quit_callback
argument_list|,
name|callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|help_widget
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|vadj
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|gtk_adjustment_new
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
name|vsb
operator|=
name|gtk_vscrollbar_new
argument_list|(
name|vadj
argument_list|)
expr_stmt|;
name|text
operator|=
name|gtk_text_new
argument_list|(
name|NULL
argument_list|,
name|vadj
argument_list|)
expr_stmt|;
name|gtk_text_set_editable
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|text
argument_list|,
literal|450
argument_list|,
literal|475
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|vsb
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|text
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|font_strong
operator|=
name|gdk_fontset_load
argument_list|(
name|_
argument_list|(
literal|"-*-helvetica-bold-r-normal-*-*-120-*-*-*-*-*-*,*"
argument_list|)
argument_list|)
expr_stmt|;
name|font_emphasis
operator|=
name|gdk_font_load
argument_list|(
name|_
argument_list|(
literal|"-*-helvetica-medium-o-normal-*-*-100-*-*-*-*-*-*"
argument_list|)
argument_list|)
expr_stmt|;
name|font
operator|=
name|gdk_fontset_load
argument_list|(
name|_
argument_list|(
literal|"-*-helvetica-medium-r-normal-*-*-100-*-*-*-*-*-*,*"
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  Realize the widget before allowing new text to be inserted  */
name|gtk_widget_realize
argument_list|(
name|text
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nhelp_lines
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|help_lines
index|[
name|i
index|]
operator|.
name|text
operator|==
name|NULL
condition|)
comment|/*  inserting gimp_directory () this way is a little ugly  */
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
operator|(
name|help_lines
index|[
name|i
index|]
operator|.
name|font
operator|==
literal|2
operator|)
condition|?
name|font_strong
else|:
operator|(
name|help_lines
index|[
name|i
index|]
operator|.
name|font
operator|==
literal|1
operator|)
condition|?
name|font_emphasis
else|:
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gimp_directory
argument_list|()
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
operator|(
name|help_lines
index|[
name|i
index|]
operator|.
name|font
operator|==
literal|2
operator|)
condition|?
name|font_strong
else|:
operator|(
name|help_lines
index|[
name|i
index|]
operator|.
name|font
operator|==
literal|1
operator|)
condition|?
name|font_emphasis
else|:
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gettext
argument_list|(
name|help_lines
index|[
name|i
index|]
operator|.
name|text
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* scroll back to the top */
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|vadj
argument_list|)
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vsb
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|help_widget
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|help_install_callback (GtkWidget * widget,gpointer client_data)
name|help_install_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|InstallCallback
name|callback
decl_stmt|;
name|callback
operator|=
operator|(
name|InstallCallback
operator|)
name|client_data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|help_widget
argument_list|)
expr_stmt|;
name|install_run
argument_list|(
name|callback
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|help_ignore_callback (GtkWidget * widget,gpointer client_data)
name|help_ignore_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|InstallCallback
name|callback
decl_stmt|;
name|callback
operator|=
operator|(
name|InstallCallback
operator|)
name|client_data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|help_widget
argument_list|)
expr_stmt|;
call|(
modifier|*
name|callback
call|)
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|help_quit_callback (GtkWidget * widget,gpointer client_data)
name|help_quit_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|gtk_widget_destroy
argument_list|(
name|help_widget
argument_list|)
expr_stmt|;
name|gtk_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|G_OS_WIN32
end_ifdef

begin_function
name|char
modifier|*
DECL|function|quote_spaces (char * string)
name|quote_spaces
parameter_list|(
name|char
modifier|*
name|string
parameter_list|)
block|{
name|int
name|nspaces
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|string
decl_stmt|,
modifier|*
name|q
decl_stmt|,
modifier|*
name|new
decl_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|' '
condition|)
name|nspaces
operator|++
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|nspaces
operator|==
literal|0
condition|)
return|return
name|g_strdup
argument_list|(
name|string
argument_list|)
return|;
name|new
operator|=
name|g_malloc
argument_list|(
name|strlen
argument_list|(
name|string
argument_list|)
operator|+
name|nspaces
operator|*
literal|2
operator|+
literal|1
argument_list|)
expr_stmt|;
name|p
operator|=
name|string
expr_stmt|;
name|q
operator|=
name|new
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|' '
condition|)
block|{
operator|*
name|q
operator|++
operator|=
literal|'"'
expr_stmt|;
operator|*
name|q
operator|++
operator|=
literal|' '
expr_stmt|;
operator|*
name|q
operator|++
operator|=
literal|'"'
expr_stmt|;
block|}
else|else
operator|*
name|q
operator|++
operator|=
operator|*
name|p
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
operator|*
name|q
operator|=
literal|'\0'
expr_stmt|;
return|return
name|new
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
DECL|function|install_run (InstallCallback callback)
name|install_run
parameter_list|(
name|InstallCallback
name|callback
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|text
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|vsb
decl_stmt|;
name|GtkAdjustment
modifier|*
name|vadj
decl_stmt|;
name|GdkFont
modifier|*
name|font_strong
decl_stmt|;
name|GdkFont
modifier|*
name|font
decl_stmt|;
name|FILE
modifier|*
name|pfp
decl_stmt|;
name|char
name|buffer
index|[
literal|2048
index|]
decl_stmt|;
name|struct
name|stat
name|stat_buf
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|executable
init|=
name|TRUE
decl_stmt|;
name|install_widget
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Installation Log"
argument_list|)
argument_list|,
literal|"installation_log"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|GTK_WIN_POS_CENTER
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Continue"
argument_list|)
argument_list|,
name|install_continue_callback
argument_list|,
name|callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Quit"
argument_list|)
argument_list|,
name|install_quit_callback
argument_list|,
name|callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|install_widget
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|vadj
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|gtk_adjustment_new
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
name|vsb
operator|=
name|gtk_vscrollbar_new
argument_list|(
name|vadj
argument_list|)
expr_stmt|;
name|text
operator|=
name|gtk_text_new
argument_list|(
name|NULL
argument_list|,
name|vadj
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|text
argument_list|,
literal|384
argument_list|,
literal|356
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|vsb
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|text
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|font_strong
operator|=
name|gdk_fontset_load
argument_list|(
name|_
argument_list|(
literal|"-*-helvetica-bold-r-normal-*-*-120-*-*-*-*-*-*,*"
argument_list|)
argument_list|)
expr_stmt|;
name|font
operator|=
name|gdk_fontset_load
argument_list|(
name|_
argument_list|(
literal|"-*-helvetica-medium-r-normal-*-*-120-*-*-*-*-*-*,*"
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  Realize the text widget before inserting text strings  */
name|gtk_widget_realize
argument_list|(
name|text
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|G_OS_WIN32
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font_strong
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"User Installation Log\n\n"
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*  Generate output  */
name|g_snprintf
argument_list|(
argument|buffer
argument_list|,
argument|sizeof(buffer)
argument_list|,
literal|"%s"
argument|G_DIR_SEPARATOR_S USER_INSTALL
argument_list|,
argument|gimp_data_directory ()
argument_list|)
empty_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|stat
argument_list|(
name|buffer
argument_list|,
operator|&
name|stat_buf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|buffer
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|" does not exist.  Cannot install.\n"
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|executable
operator|=
name|FALSE
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|S_IXUSR
elseif|else
if|if
condition|(
operator|!
operator|(
name|S_IXUSR
operator|&
name|stat_buf
operator|.
name|st_mode
operator|)
operator|||
operator|!
operator|(
name|S_IRUSR
operator|&
name|stat_buf
operator|.
name|st_mode
operator|)
condition|)
block|{
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|buffer
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|" has invalid permissions.\nCannot install."
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|executable
operator|=
name|FALSE
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|executable
operator|==
name|TRUE
condition|)
block|{
ifdef|#
directive|ifdef
name|G_OS_WIN32
name|char
modifier|*
name|quoted_data_dir
decl_stmt|,
modifier|*
name|quoted_user_dir
decl_stmt|;
comment|/* On Windows, it is common for the GIMP data directory        * to have spaces in it ("c:\Program Files\GIMP"). Put spaces in quotes.        */
name|quoted_data_dir
operator|=
name|quote_spaces
argument_list|(
name|gimp_data_directory
argument_list|()
argument_list|)
expr_stmt|;
name|quoted_user_dir
operator|=
name|quote_spaces
argument_list|(
name|gimp_directory
argument_list|()
argument_list|)
expr_stmt|;
comment|/* The Microsoft _popen doesn't work in Windows applications, sigh.        * Do the installation by calling system(). The user_install.bat        * ends with a pause command, so the user has to press enter in        * the console window to continue, and thus has a chance to read        * at the window contents.        */
name|AllocConsole
argument_list|()
expr_stmt|;
name|g_snprintf
argument_list|(
argument|buffer
argument_list|,
argument|sizeof(buffer)
argument_list|,
literal|"%s"
argument|G_DIR_SEPARATOR_S USER_INSTALL
literal|" %s %s"
argument_list|,
argument|quoted_data_dir
argument_list|,
argument|quoted_data_dir
argument_list|,
argument|quoted_user_dir
argument_list|)
empty_stmt|;
if|if
condition|(
name|system
argument_list|(
name|buffer
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|executable
operator|=
name|FALSE
expr_stmt|;
name|g_free
argument_list|(
name|quoted_data_dir
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|quoted_user_dir
argument_list|)
expr_stmt|;
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font_strong
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Did you notice any error messages\n"
literal|"in the console window? If not, installation\n"
literal|"was successful! Otherwise, quit and investigate\n"
literal|"the possible reason...\n"
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
ifndef|#
directive|ifndef
name|__EMX__
name|g_snprintf
argument_list|(
argument|buffer
argument_list|,
argument|sizeof(buffer)
argument_list|,
literal|"%s"
argument|G_DIR_SEPARATOR_S USER_INSTALL
literal|" %s %s"
argument_list|,
argument|gimp_data_directory ()
argument_list|,
argument|gimp_data_directory()
argument_list|,
argument|gimp_directory ()
argument_list|)
empty_stmt|;
else|#
directive|else
name|g_snprintf
argument_list|(
argument|buffer
argument_list|,
argument|sizeof(buffer)
argument_list|,
literal|"cmd.exe /c %s"
argument|G_DIR_SEPARATOR_S USER_INSTALL
literal|" %s %s"
argument_list|,
argument|gimp_data_directory ()
argument_list|,
argument|gimp_data_directory()
argument_list|,
argument|gimp_directory ()
argument_list|)
empty_stmt|;
block|{
name|char
modifier|*
name|s
init|=
name|buffer
operator|+
literal|10
decl_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
if|if
condition|(
operator|*
name|s
operator|==
literal|'/'
condition|)
operator|*
name|s
operator|=
literal|'\\'
expr_stmt|;
name|s
operator|++
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* urk - should really use something better than popen(), since        * we can't tell if the installation script failed --austin */
if|if
condition|(
operator|(
name|pfp
operator|=
name|popen
argument_list|(
name|buffer
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|pfp
argument_list|)
condition|)
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|buffer
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|pclose
argument_list|(
name|pfp
argument_list|)
expr_stmt|;
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"\nInstallation successful!\n"
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|executable
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
comment|/* !G_OS_WIN32 */
block|}
if|if
condition|(
name|executable
operator|==
name|FALSE
condition|)
name|gtk_text_insert
argument_list|(
name|GTK_TEXT
argument_list|(
name|text
argument_list|)
argument_list|,
name|font
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"\nInstallation failed.  Contact system administrator.\n"
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vsb
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|install_widget
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|install_continue_callback (GtkWidget * widget,gpointer client_data)
name|install_continue_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|InstallCallback
name|callback
decl_stmt|;
ifdef|#
directive|ifdef
name|G_OS_WIN32
name|FreeConsole
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|callback
operator|=
operator|(
name|InstallCallback
operator|)
name|client_data
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|install_widget
argument_list|)
expr_stmt|;
call|(
modifier|*
name|callback
call|)
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|install_quit_callback (GtkWidget * widget,gpointer client_data)
name|install_quit_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|gtk_widget_destroy
argument_list|(
name|install_widget
argument_list|)
expr_stmt|;
name|gtk_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

