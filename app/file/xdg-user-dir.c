begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This code is a slightly modified copy of xdg-user-dir-lockup.c  * as written by Alexander Larsson.  *  * See http://www.freedesktop.org/wiki/Software/xdg-user-dirs  */
end_comment

begin_comment
comment|/*   This file is not licenced under the GPL like the rest of the code.   Its is under the MIT license, to encourage reuse by cut-and-paste.    Copyright (c) 2007 Red Hat, inc    Permission is hereby granted, free of charge, to any person   obtaining a copy of this software and associated documentation files   (the "Software"), to deal in the Software without restriction,   including without limitation the rights to use, copy, modify, merge,   publish, distribute, sublicense, and/or sell copies of the Software,   and to permit persons to whom the Software is furnished to do so,   subject to the following conditions:    The above copyright notice and this permission notice shall be   included in all copies or substantial portions of the Software.    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,   EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF   MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND   NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS   BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN   ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN   CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE   SOFTWARE. */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<glib.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|"xdg-user-dir.h"
end_include

begin_comment
comment|/**  * xdg_user_dir_lookup_with_fallback:  * @type: a string specifying the type of directory  *  * Looks up a XDG user directory of the specified type.  * Example of types are "DESKTOP" and "DOWNLOAD".  *  * Return value: a newly allocated absolute pathname or %NULL  **/
end_comment

begin_function
name|gchar
modifier|*
DECL|function|xdg_user_dir_lookup (const gchar * type)
name|xdg_user_dir_lookup
parameter_list|(
specifier|const
name|gchar
modifier|*
name|type
parameter_list|)
block|{
name|FILE
modifier|*
name|file
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|home_dir
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|config_home
decl_stmt|;
name|gchar
name|buffer
index|[
literal|512
index|]
decl_stmt|;
name|gchar
modifier|*
name|filename
decl_stmt|;
name|gchar
modifier|*
name|user_dir
init|=
name|NULL
decl_stmt|;
name|gchar
modifier|*
name|p
decl_stmt|,
modifier|*
name|d
decl_stmt|;
name|gint
name|len
decl_stmt|;
name|gint
name|relative
decl_stmt|;
name|home_dir
operator|=
name|g_get_home_dir
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|home_dir
condition|)
return|return
name|NULL
return|;
name|config_home
operator|=
name|g_getenv
argument_list|(
literal|"XDG_CONFIG_HOME"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|config_home
operator|||
operator|!
operator|*
name|config_home
condition|)
block|{
name|filename
operator|=
name|g_build_filename
argument_list|(
name|home_dir
argument_list|,
literal|".config"
argument_list|,
literal|"user-dirs.dirs"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|filename
operator|=
name|g_build_filename
argument_list|(
name|config_home
argument_list|,
literal|"user-dirs.dirs"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|file
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|file
condition|)
return|return
name|NULL
return|;
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|file
argument_list|)
condition|)
block|{
comment|/* Remove newline at end */
name|len
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
name|buffer
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'\n'
condition|)
name|buffer
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|buffer
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|==
literal|' '
operator|||
operator|*
name|p
operator|==
literal|'\t'
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"XDG_"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|p
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|p
argument_list|,
name|type
argument_list|,
name|strlen
argument_list|(
name|type
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|p
operator|+=
name|strlen
argument_list|(
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"_DIR"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|p
operator|+=
literal|4
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|==
literal|' '
operator|||
operator|*
name|p
operator|==
literal|'\t'
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|'='
condition|)
continue|continue;
name|p
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|==
literal|' '
operator|||
operator|*
name|p
operator|==
literal|'\t'
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|'"'
condition|)
continue|continue;
name|p
operator|++
expr_stmt|;
name|relative
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"$HOME/"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|+=
literal|6
expr_stmt|;
name|relative
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|p
operator|!=
literal|'/'
condition|)
continue|continue;
if|if
condition|(
name|relative
condition|)
block|{
name|user_dir
operator|=
name|g_malloc
argument_list|(
name|strlen
argument_list|(
name|home_dir
argument_list|)
operator|+
literal|1
operator|+
name|strlen
argument_list|(
name|p
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|user_dir
argument_list|,
name|home_dir
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|user_dir
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|user_dir
operator|=
name|g_malloc
argument_list|(
name|strlen
argument_list|(
name|p
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
operator|*
name|user_dir
operator|=
literal|0
expr_stmt|;
block|}
name|d
operator|=
name|user_dir
operator|+
name|strlen
argument_list|(
name|user_dir
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|'"'
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|p
operator|==
literal|'\\'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|p
operator|+
literal|1
operator|)
operator|!=
literal|0
operator|)
condition|)
name|p
operator|++
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
block|}
operator|*
name|d
operator|=
literal|0
expr_stmt|;
block|}
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|user_dir
return|;
block|}
end_function

end_unit

