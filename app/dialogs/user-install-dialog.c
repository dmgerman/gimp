begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  * Copyright (C) 2000 Michael Natterer and Sven Neumann  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|G_OS_WIN32
end_ifdef

begin_include
include|#
directive|include
file|<libgimpbase/gimpwin32-io.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"libgimpbase/gimpbase.h"
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"dialogs-types.h"
end_include

begin_include
include|#
directive|include
file|"config/gimpconfig-file.h"
end_include

begin_include
include|#
directive|include
file|"config/gimprc.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp-templates.h"
end_include

begin_include
include|#
directive|include
file|"user-install-dialog.h"
end_include

begin_include
include|#
directive|include
file|"gimp-intl.h"
end_include

begin_enum
enum|enum
DECL|enum|__anon28ed62ed0103
block|{
DECL|enumerator|WELCOME_PAGE
name|WELCOME_PAGE
block|,
DECL|enumerator|INSTALLATION_PAGE
name|INSTALLATION_PAGE
block|,
DECL|enumerator|NUM_PAGES
name|NUM_PAGES
block|}
enum|;
end_enum

begin_enum
enum|enum
DECL|enum|__anon28ed62ed0203
block|{
DECL|enumerator|DIRENT_COLUMN
name|DIRENT_COLUMN
block|,
DECL|enumerator|PIXBUF_COLUMN
name|PIXBUF_COLUMN
block|,
DECL|enumerator|DESC_COLUMN
name|DESC_COLUMN
block|,
DECL|enumerator|NUM_COLUMNS
name|NUM_COLUMNS
block|}
enum|;
end_enum

begin_function_decl
specifier|static
name|void
name|user_install_response
parameter_list|(
name|GtkWidget
modifier|*
name|dialog
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|GimpRc
modifier|*
name|gimprc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|user_install_run
parameter_list|(
name|GtkWidget
modifier|*
name|dialog
parameter_list|,
specifier|const
name|gchar
modifier|*
name|oldgimp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  private stuff  */
end_comment

begin_decl_stmt
DECL|variable|notebook
specifier|static
name|GtkWidget
modifier|*
name|notebook
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|title_label
specifier|static
name|GtkWidget
modifier|*
name|title_label
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|footer_label
specifier|static
name|GtkWidget
modifier|*
name|footer_label
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|oldgimp
specifier|static
name|gchar
modifier|*
name|oldgimp
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|oldgimp_major
specifier|static
name|gint
name|oldgimp_major
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|oldgimp_minor
specifier|static
name|gint
name|oldgimp_minor
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|migrate
specifier|static
name|gboolean
name|migrate
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
enum|enum
DECL|enum|__anon28ed62ed0303
block|{
DECL|enumerator|USER_INSTALL_DO_NOTHING
name|USER_INSTALL_DO_NOTHING
block|,
comment|/* Don't pre-create            */
DECL|enumerator|USER_INSTALL_MKDIR
name|USER_INSTALL_MKDIR
block|,
comment|/* Create the directory        */
DECL|enumerator|USER_INSTALL_FROM_SYSCONF_DIR
name|USER_INSTALL_FROM_SYSCONF_DIR
comment|/* Copy from sysconf directory */
DECL|typedef|UserInstallAction
block|}
name|UserInstallAction
typedef|;
end_typedef

begin_struct
specifier|static
specifier|const
struct|struct
DECL|struct|__anon28ed62ed0408
block|{
DECL|member|name
specifier|const
name|gchar
modifier|*
name|name
decl_stmt|;
DECL|member|action
name|UserInstallAction
name|action
decl_stmt|;
block|}
DECL|variable|user_install_items
name|user_install_items
index|[]
init|=
block|{
block|{
literal|"gimprc"
block|,
name|USER_INSTALL_DO_NOTHING
block|}
block|,
block|{
literal|"gtkrc"
block|,
name|USER_INSTALL_FROM_SYSCONF_DIR
block|}
block|,
block|{
literal|"pluginrc"
block|,
name|USER_INSTALL_DO_NOTHING
block|}
block|,
block|{
literal|"menurc"
block|,
name|USER_INSTALL_DO_NOTHING
block|}
block|,
block|{
literal|"sessionrc"
block|,
name|USER_INSTALL_DO_NOTHING
block|}
block|,
block|{
literal|"templaterc"
block|,
name|USER_INSTALL_DO_NOTHING
block|}
block|,
block|{
literal|"unitrc"
block|,
name|USER_INSTALL_DO_NOTHING
block|}
block|,
block|{
literal|"brushes"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"fonts"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"gradients"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"palettes"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"patterns"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"plug-ins"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"modules"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"interpreters"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"environ"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"scripts"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"templates"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"themes"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"tmp"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"tool-options"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"curves"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"levels"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"fractalexplorer"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"gfig"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"gflare"
block|,
name|USER_INSTALL_MKDIR
block|}
block|,
block|{
literal|"gimpressionist"
block|,
name|USER_INSTALL_MKDIR
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|GtkWidget
modifier|*
DECL|function|user_install_notebook_set_page (GtkNotebook * notebook,gint index)
name|user_install_notebook_set_page
parameter_list|(
name|GtkNotebook
modifier|*
name|notebook
parameter_list|,
name|gint
name|index
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|page
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|title
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|footer
decl_stmt|;
name|page
operator|=
name|gtk_notebook_get_nth_page
argument_list|(
name|notebook
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|title
operator|=
name|g_object_get_data
argument_list|(
name|G_OBJECT
argument_list|(
name|page
argument_list|)
argument_list|,
literal|"title"
argument_list|)
expr_stmt|;
name|footer
operator|=
name|g_object_get_data
argument_list|(
name|G_OBJECT
argument_list|(
name|page
argument_list|)
argument_list|,
literal|"footer"
argument_list|)
expr_stmt|;
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|title_label
argument_list|)
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|footer_label
argument_list|)
argument_list|,
name|footer
argument_list|)
expr_stmt|;
name|gtk_notebook_set_current_page
argument_list|(
name|notebook
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|page
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|user_install_response (GtkWidget * dialog,gint response_id,GimpRc * gimprc)
name|user_install_response
parameter_list|(
name|GtkWidget
modifier|*
name|dialog
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|GimpRc
modifier|*
name|gimprc
parameter_list|)
block|{
name|gint
name|index
init|=
name|gtk_notebook_get_current_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|response_id
operator|!=
name|GTK_RESPONSE_OK
condition|)
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|index
condition|)
block|{
case|case
name|WELCOME_PAGE
case|:
block|{
name|GtkWidget
modifier|*
name|page
decl_stmt|;
name|page
operator|=
name|user_install_notebook_set_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
operator|++
name|index
argument_list|)
expr_stmt|;
comment|/*  Creating the directories can take some time on NFS, so inform          *  the user and set the buttons insensitive          */
name|gtk_dialog_set_response_sensitive
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_dialog_set_response_sensitive
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|user_install_run
argument_list|(
name|dialog
argument_list|,
name|migrate
condition|?
name|oldgimp
else|:
name|NULL
argument_list|)
condition|)
block|{
name|gtk_dialog_set_response_sensitive
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|footer_label
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Installation successful."
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|footer_label
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Installation failed!"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|gtk_dialog_set_response_sensitive
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|INSTALLATION_PAGE
case|:
if|if
condition|(
operator|!
name|migrate
condition|)
name|gimp_rc_save
argument_list|(
name|gimprc
argument_list|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|gtk_main_quit
argument_list|()
expr_stmt|;
break|break;
default|default:
name|g_assert_not_reached
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|GtkWidget
modifier|*
DECL|function|user_install_notebook_append_page (GtkNotebook * notebook,const gchar * title,const gchar * footer,gint vbox_spacing)
name|user_install_notebook_append_page
parameter_list|(
name|GtkNotebook
modifier|*
name|notebook
parameter_list|,
specifier|const
name|gchar
modifier|*
name|title
parameter_list|,
specifier|const
name|gchar
modifier|*
name|footer
parameter_list|,
name|gint
name|vbox_spacing
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|page
init|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
name|vbox_spacing
argument_list|)
decl_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|page
argument_list|)
argument_list|,
literal|"title"
argument_list|,
operator|(
name|gpointer
operator|)
name|title
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|page
argument_list|)
argument_list|,
literal|"footer"
argument_list|,
operator|(
name|gpointer
operator|)
name|footer
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|notebook
argument_list|,
name|page
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|page
argument_list|)
expr_stmt|;
return|return
name|page
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|user_install_details_expand (GtkExpander * expander)
name|user_install_details_expand
parameter_list|(
name|GtkExpander
modifier|*
name|expander
parameter_list|)
block|{
name|gtk_expander_set_label
argument_list|(
name|expander
argument_list|,
name|gtk_expander_get_expanded
argument_list|(
name|expander
argument_list|)
condition|?
name|_
argument_list|(
literal|"Hide _details"
argument_list|)
else|:
name|_
argument_list|(
literal|"Show _details"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_expander_set_use_underline
argument_list|(
name|expander
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|user_install_dialog_run (const gchar * alternate_system_gimprc,const gchar * alternate_gimprc,gboolean verbose)
name|user_install_dialog_run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|alternate_system_gimprc
parameter_list|,
specifier|const
name|gchar
modifier|*
name|alternate_gimprc
parameter_list|,
name|gboolean
name|verbose
parameter_list|)
block|{
name|GimpRc
modifier|*
name|gimprc
decl_stmt|;
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|page
decl_stmt|;
name|GtkWidget
modifier|*
name|widget
decl_stmt|;
name|GdkPixbuf
modifier|*
name|wilber
decl_stmt|;
name|gchar
modifier|*
name|filename
decl_stmt|;
name|gchar
modifier|*
name|version
decl_stmt|;
name|oldgimp
operator|=
name|g_strdup
argument_list|(
name|gimp_directory
argument_list|()
argument_list|)
expr_stmt|;
comment|/*  FIXME  */
name|version
operator|=
name|strstr
argument_list|(
name|oldgimp
argument_list|,
literal|"2.3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
condition|)
block|{
name|version
index|[
literal|2
index|]
operator|=
literal|'2'
expr_stmt|;
name|oldgimp_major
operator|=
literal|2
expr_stmt|;
name|oldgimp_minor
operator|=
literal|2
expr_stmt|;
block|}
name|migrate
operator|=
operator|(
name|version
operator|&&
name|g_file_test
argument_list|(
name|oldgimp
argument_list|,
name|G_FILE_TEST_IS_DIR
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|migrate
condition|)
block|{
if|if
condition|(
name|version
condition|)
block|{
name|version
index|[
literal|2
index|]
operator|=
literal|'0'
expr_stmt|;
name|oldgimp_major
operator|=
literal|2
expr_stmt|;
name|oldgimp_minor
operator|=
literal|0
expr_stmt|;
block|}
name|migrate
operator|=
operator|(
name|version
operator|&&
name|g_file_test
argument_list|(
name|oldgimp
argument_list|,
name|G_FILE_TEST_IS_DIR
argument_list|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|migrate
condition|)
block|{
name|g_free
argument_list|(
name|oldgimp
argument_list|)
expr_stmt|;
name|oldgimp
operator|=
name|NULL
expr_stmt|;
name|oldgimp_major
operator|=
literal|0
expr_stmt|;
name|oldgimp_minor
operator|=
literal|0
expr_stmt|;
block|}
name|dialog
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"GIMP User Installation"
argument_list|)
argument_list|,
literal|"gimp-user-installation"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|_
argument_list|(
literal|"Continue"
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gimprc
operator|=
name|gimp_rc_new
argument_list|(
name|alternate_system_gimprc
argument_list|,
name|alternate_gimprc
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dialog
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|user_install_response
argument_list|)
argument_list|,
name|gimprc
argument_list|)
expr_stmt|;
name|g_object_weak_ref
argument_list|(
name|G_OBJECT
argument_list|(
name|dialog
argument_list|)
argument_list|,
operator|(
name|GWeakNotify
operator|)
name|g_object_unref
argument_list|,
name|gimprc
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|filename
operator|=
name|g_build_filename
argument_list|(
name|gimp_data_directory
argument_list|()
argument_list|,
literal|"images"
argument_list|,
literal|"wilber-wizard.png"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wilber
operator|=
name|gdk_pixbuf_new_from_file
argument_list|(
name|filename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|wilber
condition|)
block|{
name|GtkWidget
modifier|*
name|image
init|=
name|gtk_image_new_from_pixbuf
argument_list|(
name|wilber
argument_list|)
decl_stmt|;
name|g_object_unref
argument_list|(
name|wilber
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|image
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|image
argument_list|)
expr_stmt|;
block|}
name|title_label
operator|=
name|gtk_label_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_label_set_justify
argument_list|(
name|GTK_LABEL
argument_list|(
name|title_label
argument_list|)
argument_list|,
name|GTK_JUSTIFY_LEFT
argument_list|)
expr_stmt|;
name|gtk_label_set_line_wrap
argument_list|(
name|GTK_LABEL
argument_list|(
name|title_label
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|title_label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gimp_label_set_attributes
argument_list|(
name|GTK_LABEL
argument_list|(
name|title_label
argument_list|)
argument_list|,
name|PANGO_ATTR_SCALE
argument_list|,
name|PANGO_SCALE_X_LARGE
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|title_label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|title_label
argument_list|)
expr_stmt|;
name|notebook
operator|=
name|gtk_notebook_new
argument_list|()
expr_stmt|;
name|gtk_notebook_set_show_tabs
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_notebook_set_show_border
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|notebook
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|footer_label
operator|=
name|gtk_label_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_label_set_justify
argument_list|(
name|GTK_LABEL
argument_list|(
name|footer_label
argument_list|)
argument_list|,
name|GTK_JUSTIFY_LEFT
argument_list|)
expr_stmt|;
name|gtk_label_set_line_wrap
argument_list|(
name|GTK_LABEL
argument_list|(
name|footer_label
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|footer_label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gimp_label_set_attributes
argument_list|(
name|GTK_LABEL
argument_list|(
name|footer_label
argument_list|)
argument_list|,
name|PANGO_ATTR_WEIGHT
argument_list|,
name|PANGO_WEIGHT_BOLD
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|footer_label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|footer_label
argument_list|)
expr_stmt|;
comment|/*  WELCOME_PAGE  */
name|page
operator|=
name|user_install_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Welcome to the GNU Image "
literal|"Manipulation Program"
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|12
argument_list|)
expr_stmt|;
if|if
condition|(
name|migrate
condition|)
block|{
name|gchar
modifier|*
name|title
decl_stmt|;
name|gchar
modifier|*
name|label
decl_stmt|;
name|title
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"It seems you have used GIMP %s before."
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|label
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"_Migrate GIMP %s user settings"
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|widget
operator|=
name|gimp_int_radio_group_new
argument_list|(
name|TRUE
argument_list|,
name|title
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_radio_button_update
argument_list|)
argument_list|,
operator|&
name|migrate
argument_list|,
name|migrate
argument_list|,
name|label
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Do a _fresh user installation"
argument_list|)
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|title
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gchar
modifier|*
name|text
decl_stmt|;
name|text
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"It appears that you are using GIMP for the "
literal|"first time.  GIMP will now create a folder "
literal|"named '<b>%s</b>' and copy some files to it."
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|gimp_directory
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|widget
operator|=
name|g_object_new
argument_list|(
name|GTK_TYPE_LABEL
argument_list|,
literal|"use-markup"
argument_list|,
name|TRUE
argument_list|,
literal|"label"
argument_list|,
name|text
argument_list|,
literal|"wrap"
argument_list|,
name|TRUE
argument_list|,
literal|"xalign"
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|text
argument_list|)
expr_stmt|;
block|}
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|page
argument_list|)
argument_list|,
name|widget
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|widget
argument_list|)
expr_stmt|;
comment|/*  INSTALLATION_PAGE  */
name|page
operator|=
name|user_install_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"User Installation"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Your personal GIMP folder is "
literal|"being created..."
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|{
name|GtkWidget
modifier|*
name|expander
decl_stmt|;
name|GtkWidget
modifier|*
name|scrolled_window
decl_stmt|;
name|GtkTextBuffer
modifier|*
name|log_buffer
decl_stmt|;
name|GtkWidget
modifier|*
name|log_view
decl_stmt|;
name|expander
operator|=
name|gtk_expander_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|page
argument_list|)
argument_list|,
name|expander
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|expander
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|expander
argument_list|,
literal|"notify::expanded"
argument_list|,
name|G_CALLBACK
argument_list|(
name|user_install_details_expand
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|user_install_details_expand
argument_list|(
name|GTK_EXPANDER
argument_list|(
name|expander
argument_list|)
argument_list|)
expr_stmt|;
name|scrolled_window
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|scrolled_window
argument_list|,
operator|-
literal|1
argument_list|,
literal|300
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|expander
argument_list|)
argument_list|,
name|scrolled_window
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|scrolled_window
argument_list|)
expr_stmt|;
name|log_buffer
operator|=
name|gtk_text_buffer_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_text_buffer_create_tag
argument_list|(
name|log_buffer
argument_list|,
literal|"bold"
argument_list|,
literal|"weight"
argument_list|,
name|PANGO_WEIGHT_BOLD
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|log_view
operator|=
name|gtk_text_view_new_with_buffer
argument_list|(
name|log_buffer
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|log_buffer
argument_list|)
expr_stmt|;
name|gtk_text_view_set_editable
argument_list|(
name|GTK_TEXT_VIEW
argument_list|(
name|log_view
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|log_view
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|log_view
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|dialog
argument_list|)
argument_list|,
literal|"log-view"
argument_list|,
name|log_view
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|dialog
argument_list|)
argument_list|,
literal|"log-buffer"
argument_list|,
name|log_buffer
argument_list|)
expr_stmt|;
block|}
name|user_install_notebook_set_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|WELCOME_PAGE
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
name|g_free
argument_list|(
name|oldgimp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*********************/
end_comment

begin_comment
comment|/*  Local functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|print_log (GtkWidget * view,GtkTextBuffer * buffer,GError * error)
name|print_log
parameter_list|(
name|GtkWidget
modifier|*
name|view
parameter_list|,
name|GtkTextBuffer
modifier|*
name|buffer
parameter_list|,
name|GError
modifier|*
name|error
parameter_list|)
block|{
name|GtkTextIter
name|cursor
decl_stmt|;
name|GdkPixbuf
modifier|*
name|pixbuf
decl_stmt|;
name|gtk_text_buffer_insert_at_cursor
argument_list|(
name|buffer
argument_list|,
name|error
condition|?
literal|"\n"
else|:
literal|" "
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_text_buffer_get_end_iter
argument_list|(
name|buffer
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
name|pixbuf
operator|=
name|gtk_widget_render_icon
argument_list|(
name|view
argument_list|,
name|error
condition|?
name|GIMP_STOCK_ERROR
else|:
name|GTK_STOCK_APPLY
argument_list|,
name|error
condition|?
name|GTK_ICON_SIZE_DIALOG
else|:
name|GTK_ICON_SIZE_MENU
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_text_buffer_insert_pixbuf
argument_list|(
name|buffer
argument_list|,
operator|&
name|cursor
argument_list|,
name|pixbuf
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|pixbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|gtk_text_buffer_insert
argument_list|(
name|buffer
argument_list|,
operator|&
name|cursor
argument_list|,
literal|"\n"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_text_buffer_insert_with_tags_by_name
argument_list|(
name|buffer
argument_list|,
operator|&
name|cursor
argument_list|,
name|error
operator|->
name|message
argument_list|,
operator|-
literal|1
argument_list|,
literal|"bold"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|gtk_text_buffer_insert
argument_list|(
name|buffer
argument_list|,
operator|&
name|cursor
argument_list|,
literal|"\n"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|gtk_events_pending
argument_list|()
condition|)
name|gtk_main_iteration
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|user_install_file_copy (GtkTextBuffer * log_buffer,const gchar * source,const gchar * dest,GError ** error)
name|user_install_file_copy
parameter_list|(
name|GtkTextBuffer
modifier|*
name|log_buffer
parameter_list|,
specifier|const
name|gchar
modifier|*
name|source
parameter_list|,
specifier|const
name|gchar
modifier|*
name|dest
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gchar
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Copying file '%s' from '%s'..."
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|dest
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_text_buffer_insert_at_cursor
argument_list|(
name|log_buffer
argument_list|,
name|msg
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
while|while
condition|(
name|gtk_events_pending
argument_list|()
condition|)
name|gtk_main_iteration
argument_list|()
expr_stmt|;
return|return
name|gimp_config_file_copy
argument_list|(
name|source
argument_list|,
name|dest
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|user_install_mkdir (GtkTextBuffer * log_buffer,const gchar * dirname,GError ** error)
name|user_install_mkdir
parameter_list|(
name|GtkTextBuffer
modifier|*
name|log_buffer
parameter_list|,
specifier|const
name|gchar
modifier|*
name|dirname
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gchar
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Creating folder '%s'..."
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|dirname
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_text_buffer_insert_at_cursor
argument_list|(
name|log_buffer
argument_list|,
name|msg
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
while|while
condition|(
name|gtk_events_pending
argument_list|()
condition|)
name|gtk_main_iteration
argument_list|()
expr_stmt|;
if|if
condition|(
name|g_mkdir
argument_list|(
name|dirname
argument_list|,
name|S_IRUSR
operator||
name|S_IWUSR
operator||
name|S_IXUSR
operator||
name|S_IRGRP
operator||
name|S_IXGRP
operator||
name|S_IROTH
operator||
name|S_IXOTH
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|g_file_error_from_errno
argument_list|(
name|errno
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Cannot create folder '%s': %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|dirname
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|user_install_dir_copy (GtkWidget * log_view,GtkTextBuffer * log_buffer,const gchar * source,const gchar * base,GError ** error)
name|user_install_dir_copy
parameter_list|(
name|GtkWidget
modifier|*
name|log_view
parameter_list|,
name|GtkTextBuffer
modifier|*
name|log_buffer
parameter_list|,
specifier|const
name|gchar
modifier|*
name|source
parameter_list|,
specifier|const
name|gchar
modifier|*
name|base
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|GDir
modifier|*
name|source_dir
init|=
name|NULL
decl_stmt|;
name|GDir
modifier|*
name|dest_dir
init|=
name|NULL
decl_stmt|;
name|gchar
name|dest
index|[
literal|1024
index|]
decl_stmt|;
name|gchar
modifier|*
name|basename
decl_stmt|;
name|gchar
modifier|*
name|dirname
decl_stmt|;
name|basename
operator|=
name|g_path_get_basename
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|dirname
operator|=
name|g_build_filename
argument_list|(
name|base
argument_list|,
name|basename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|basename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|user_install_mkdir
argument_list|(
name|log_buffer
argument_list|,
name|dirname
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|g_free
argument_list|(
name|dirname
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|print_log
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dest_dir
operator|=
name|g_dir_open
argument_list|(
name|dirname
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest_dir
condition|)
block|{
name|source_dir
operator|=
name|g_dir_open
argument_list|(
name|source
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|source_dir
condition|)
block|{
specifier|const
name|gchar
modifier|*
name|basename
decl_stmt|;
name|gchar
modifier|*
name|name
decl_stmt|;
while|while
condition|(
operator|(
name|basename
operator|=
name|g_dir_read_name
argument_list|(
name|source_dir
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|name
operator|=
name|g_build_filename
argument_list|(
name|source
argument_list|,
name|basename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_file_test
argument_list|(
name|name
argument_list|,
name|G_FILE_TEST_IS_REGULAR
argument_list|)
condition|)
block|{
name|g_snprintf
argument_list|(
name|dest
argument_list|,
sizeof|sizeof
argument_list|(
name|dest
argument_list|)
argument_list|,
literal|"%s%c%s"
argument_list|,
name|dirname
argument_list|,
name|G_DIR_SEPARATOR
argument_list|,
name|basename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|user_install_file_copy
argument_list|(
name|log_buffer
argument_list|,
name|name
argument_list|,
name|dest
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
goto|goto
name|break_out_of_loop
goto|;
block|}
name|print_log
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|break_out_of_loop
label|:
name|g_free
argument_list|(
name|dirname
argument_list|)
expr_stmt|;
if|if
condition|(
name|source_dir
condition|)
name|g_dir_close
argument_list|(
name|source_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest_dir
condition|)
name|g_dir_close
argument_list|(
name|dest_dir
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|error
operator|==
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|user_install_create_files (GtkWidget * log_view,GtkTextBuffer * log_buffer)
name|user_install_create_files
parameter_list|(
name|GtkWidget
modifier|*
name|log_view
parameter_list|,
name|GtkTextBuffer
modifier|*
name|log_buffer
parameter_list|)
block|{
name|gchar
name|dest
index|[
literal|1024
index|]
decl_stmt|;
name|gchar
name|source
index|[
literal|1024
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|G_N_ELEMENTS
argument_list|(
name|user_install_items
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|g_snprintf
argument_list|(
name|dest
argument_list|,
sizeof|sizeof
argument_list|(
name|dest
argument_list|)
argument_list|,
literal|"%s%c%s"
argument_list|,
name|gimp_directory
argument_list|()
argument_list|,
name|G_DIR_SEPARATOR
argument_list|,
name|user_install_items
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|user_install_items
index|[
name|i
index|]
operator|.
name|action
condition|)
block|{
case|case
name|USER_INSTALL_DO_NOTHING
case|:
break|break;
case|case
name|USER_INSTALL_MKDIR
case|:
if|if
condition|(
operator|!
name|user_install_mkdir
argument_list|(
name|log_buffer
argument_list|,
name|dest
argument_list|,
operator|&
name|error
argument_list|)
condition|)
goto|goto
name|break_out_of_loop
goto|;
break|break;
case|case
name|USER_INSTALL_FROM_SYSCONF_DIR
case|:
name|g_snprintf
argument_list|(
name|source
argument_list|,
sizeof|sizeof
argument_list|(
name|source
argument_list|)
argument_list|,
literal|"%s%c%s"
argument_list|,
name|gimp_sysconf_directory
argument_list|()
argument_list|,
name|G_DIR_SEPARATOR
argument_list|,
name|user_install_items
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|user_install_file_copy
argument_list|(
name|log_buffer
argument_list|,
name|source
argument_list|,
name|dest
argument_list|,
operator|&
name|error
argument_list|)
condition|)
goto|goto
name|break_out_of_loop
goto|;
break|break;
default|default:
name|g_assert_not_reached
argument_list|()
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|user_install_items
index|[
name|i
index|]
operator|.
name|action
operator|!=
name|USER_INSTALL_DO_NOTHING
condition|)
name|print_log
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|break_out_of_loop
label|:
if|if
condition|(
name|error
condition|)
block|{
name|print_log
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_clear_error
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|user_install_migrate_files (const gchar * oldgimp,gint oldgimp_major,gint oldgimp_minor,GtkWidget * log_view,GtkTextBuffer * log_buffer)
name|user_install_migrate_files
parameter_list|(
specifier|const
name|gchar
modifier|*
name|oldgimp
parameter_list|,
name|gint
name|oldgimp_major
parameter_list|,
name|gint
name|oldgimp_minor
parameter_list|,
name|GtkWidget
modifier|*
name|log_view
parameter_list|,
name|GtkTextBuffer
modifier|*
name|log_buffer
parameter_list|)
block|{
name|GDir
modifier|*
name|dir
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
name|dir
operator|=
name|g_dir_open
argument_list|(
name|oldgimp
argument_list|,
literal|0
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
condition|)
block|{
specifier|const
name|gchar
modifier|*
name|basename
decl_stmt|;
name|gchar
modifier|*
name|source
init|=
name|NULL
decl_stmt|;
name|gchar
name|dest
index|[
literal|1024
index|]
decl_stmt|;
while|while
condition|(
operator|(
name|basename
operator|=
name|g_dir_read_name
argument_list|(
name|dir
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|source
operator|=
name|g_build_filename
argument_list|(
name|oldgimp
argument_list|,
name|basename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_file_test
argument_list|(
name|source
argument_list|,
name|G_FILE_TEST_IS_REGULAR
argument_list|)
condition|)
block|{
comment|/*  skip these for all old versions  */
if|if
condition|(
operator|(
name|strncmp
argument_list|(
name|basename
argument_list|,
literal|"gimpswap."
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strncmp
argument_list|(
name|basename
argument_list|,
literal|"pluginrc"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strncmp
argument_list|(
name|basename
argument_list|,
literal|"themerc"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
goto|goto
name|next_file
goto|;
block|}
comment|/*  skip menurc for gimp 2.0 since the format has changed  */
if|if
condition|(
name|oldgimp_minor
operator|==
literal|0
operator|&&
operator|(
name|strncmp
argument_list|(
name|basename
argument_list|,
literal|"menurc"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
goto|goto
name|next_file
goto|;
block|}
name|g_snprintf
argument_list|(
name|dest
argument_list|,
sizeof|sizeof
argument_list|(
name|dest
argument_list|)
argument_list|,
literal|"%s%c%s"
argument_list|,
name|gimp_directory
argument_list|()
argument_list|,
name|G_DIR_SEPARATOR
argument_list|,
name|basename
argument_list|)
expr_stmt|;
name|user_install_file_copy
argument_list|(
name|log_buffer
argument_list|,
name|source
argument_list|,
name|dest
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
name|print_log
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_clear_error
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|g_file_test
argument_list|(
name|source
argument_list|,
name|G_FILE_TEST_IS_DIR
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|basename
argument_list|,
literal|"tmp"
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|user_install_dir_copy
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|source
argument_list|,
name|gimp_directory
argument_list|()
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|print_log
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_clear_error
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
block|}
block|}
name|next_file
label|:
name|g_free
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|source
operator|=
name|NULL
expr_stmt|;
block|}
comment|/*  create the tmp directory that was explicitely not copied  */
name|g_snprintf
argument_list|(
name|dest
argument_list|,
sizeof|sizeof
argument_list|(
name|dest
argument_list|)
argument_list|,
literal|"%s%c%s"
argument_list|,
name|gimp_directory
argument_list|()
argument_list|,
name|G_DIR_SEPARATOR
argument_list|,
literal|"tmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|user_install_mkdir
argument_list|(
name|log_buffer
argument_list|,
name|dest
argument_list|,
operator|&
name|error
argument_list|)
condition|)
name|print_log
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_dir_close
argument_list|(
name|dir
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
name|print_log
argument_list|(
name|log_view
argument_list|,
name|log_buffer
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_clear_error
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|gimp_templates_migrate
argument_list|(
name|oldgimp
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|user_install_run (GtkWidget * dialog,const gchar * oldgimp)
name|user_install_run
parameter_list|(
name|GtkWidget
modifier|*
name|dialog
parameter_list|,
specifier|const
name|gchar
modifier|*
name|oldgimp
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|view
init|=
name|g_object_get_data
argument_list|(
name|G_OBJECT
argument_list|(
name|dialog
argument_list|)
argument_list|,
literal|"log-view"
argument_list|)
decl_stmt|;
name|GtkTextBuffer
modifier|*
name|buffer
init|=
name|g_object_get_data
argument_list|(
name|G_OBJECT
argument_list|(
name|dialog
argument_list|)
argument_list|,
literal|"log-buffer"
argument_list|)
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|user_install_mkdir
argument_list|(
name|buffer
argument_list|,
name|gimp_directory
argument_list|()
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|print_log
argument_list|(
name|view
argument_list|,
name|buffer
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_clear_error
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|print_log
argument_list|(
name|view
argument_list|,
name|buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldgimp
condition|)
return|return
name|user_install_migrate_files
argument_list|(
name|oldgimp
argument_list|,
name|oldgimp_major
argument_list|,
name|oldgimp_minor
argument_list|,
name|view
argument_list|,
name|buffer
argument_list|)
return|;
else|else
return|return
name|user_install_create_files
argument_list|(
name|view
argument_list|,
name|buffer
argument_list|)
return|;
block|}
end_function

end_unit

