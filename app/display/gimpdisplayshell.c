begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|"libgimpbase/gimpbase.h"
end_include

begin_include
include|#
directive|include
file|"libgimpwidgets/gimpwidgets.h"
end_include

begin_include
include|#
directive|include
file|"display-types.h"
end_include

begin_include
include|#
directive|include
file|"gui/gui-types.h"
end_include

begin_comment
comment|/* FIXME */
end_comment

begin_include
include|#
directive|include
file|"base/temp-buf.h"
end_include

begin_include
include|#
directive|include
file|"core/gimp.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpbuffer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpcontainer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage.h"
end_include

begin_include
include|#
directive|include
file|"core/gimpimage-mask.h"
end_include

begin_include
include|#
directive|include
file|"core/gimplayer.h"
end_include

begin_include
include|#
directive|include
file|"core/gimplayermask.h"
end_include

begin_include
include|#
directive|include
file|"core/gimppattern.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpcursor.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpdnd.h"
end_include

begin_include
include|#
directive|include
file|"widgets/gimpwidgets-utils.h"
end_include

begin_include
include|#
directive|include
file|"gui/info-window.h"
end_include

begin_include
include|#
directive|include
file|"gui/menus.h"
end_include

begin_include
include|#
directive|include
file|"tools/tool_manager.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplay.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplay-area.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplay-selection.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplayshell.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplayshell-callbacks.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplayshell-dnd.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplayshell-handlers.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplayshell-qmask.h"
end_include

begin_include
include|#
directive|include
file|"gimpdisplayshell-render.h"
end_include

begin_include
include|#
directive|include
file|"gximage.h"
end_include

begin_include
include|#
directive|include
file|"colormaps.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"nav_window.h"
end_include

begin_include
include|#
directive|include
file|"plug_in.h"
end_include

begin_include
include|#
directive|include
file|"undo.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DISPLAY_FILTERS
end_ifdef

begin_include
include|#
directive|include
file|"gdisplay_color.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DISPLAY_FILTERS */
end_comment

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_include
include|#
directive|include
file|"pixmaps/wilber.xpm"
end_include

begin_define
DECL|macro|MAX_TITLE_BUF
define|#
directive|define
name|MAX_TITLE_BUF
value|256
end_define

begin_comment
comment|/*  local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_class_init
parameter_list|(
name|GimpDisplayShellClass
modifier|*
name|klass
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_init
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_destroy
parameter_list|(
name|GtkObject
modifier|*
name|object
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_display_shell_delete_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventAny
modifier|*
name|aevent
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gpointer
name|gimp_display_shell_get_accel_context
parameter_list|(
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_display_area
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_draw_cursor
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_format_title
parameter_list|(
name|GimpDisplayShell
modifier|*
name|gdisp
parameter_list|,
name|gchar
modifier|*
name|title
parameter_list|,
name|gint
name|title_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_update_icon
parameter_list|(
name|GimpDisplayShell
modifier|*
name|gdisp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_display_shell_update_icon_timer
parameter_list|(
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_display_shell_update_icon_invoker
parameter_list|(
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_update_icon_scheduler
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_close_warning_dialog
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
specifier|const
name|gchar
modifier|*
name|image_name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_display_shell_close_warning_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gboolean
name|close
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|parent_class
specifier|static
name|GtkWindowClass
modifier|*
name|parent_class
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|display_target_table
specifier|static
name|GtkTargetEntry
name|display_target_table
index|[]
init|=
block|{
name|GIMP_TARGET_LAYER
block|,
name|GIMP_TARGET_CHANNEL
block|,
name|GIMP_TARGET_LAYER_MASK
block|,
name|GIMP_TARGET_COLOR
block|,
name|GIMP_TARGET_PATTERN
block|,
name|GIMP_TARGET_BUFFER
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|GType
DECL|function|gimp_display_shell_get_type (void)
name|gimp_display_shell_get_type
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|GType
name|shell_type
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|shell_type
condition|)
block|{
specifier|static
specifier|const
name|GTypeInfo
name|shell_info
init|=
block|{
sizeof|sizeof
argument_list|(
name|GimpDisplayShellClass
argument_list|)
block|,
operator|(
name|GBaseInitFunc
operator|)
name|NULL
block|,
operator|(
name|GBaseFinalizeFunc
operator|)
name|NULL
block|,
operator|(
name|GClassInitFunc
operator|)
name|gimp_display_shell_class_init
block|,
name|NULL
block|,
comment|/* class_finalize */
name|NULL
block|,
comment|/* class_data     */
sizeof|sizeof
argument_list|(
name|GimpDisplayShell
argument_list|)
block|,
literal|0
block|,
comment|/* n_preallocs    */
operator|(
name|GInstanceInitFunc
operator|)
name|gimp_display_shell_init
block|,       }
decl_stmt|;
name|shell_type
operator|=
name|g_type_register_static
argument_list|(
name|GTK_TYPE_WINDOW
argument_list|,
literal|"GimpDisplayShell"
argument_list|,
operator|&
name|shell_info
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|shell_type
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_class_init (GimpDisplayShellClass * klass)
name|gimp_display_shell_class_init
parameter_list|(
name|GimpDisplayShellClass
modifier|*
name|klass
parameter_list|)
block|{
name|GtkObjectClass
modifier|*
name|object_class
decl_stmt|;
name|GtkWidgetClass
modifier|*
name|widget_class
decl_stmt|;
name|object_class
operator|=
name|GTK_OBJECT_CLASS
argument_list|(
name|klass
argument_list|)
expr_stmt|;
name|widget_class
operator|=
name|GTK_WIDGET_CLASS
argument_list|(
name|klass
argument_list|)
expr_stmt|;
name|parent_class
operator|=
name|g_type_class_peek_parent
argument_list|(
name|klass
argument_list|)
expr_stmt|;
name|object_class
operator|->
name|destroy
operator|=
name|gimp_display_shell_destroy
expr_stmt|;
name|widget_class
operator|->
name|delete_event
operator|=
name|gimp_display_shell_delete_event
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_init (GimpDisplayShell * shell)
name|gimp_display_shell_init
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|shell
operator|->
name|gdisp
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|ifactory
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|offset_x
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|offset_y
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|disp_width
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|disp_height
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|disp_xoffset
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|disp_yoffset
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|proximity
operator|=
name|FALSE
expr_stmt|;
name|shell
operator|->
name|display_areas
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|hsbdata
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|vsbdata
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|canvas
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|hsb
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|vsb
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|qmaskoff
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|qmaskon
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|hrule
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|vrule
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|origin
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|statusarea
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|progressbar
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|progressid
operator|=
name|FALSE
expr_stmt|;
name|shell
operator|->
name|cursor_label
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|cursor_format_str
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|shell
operator|->
name|cancelbutton
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|scroll_gc
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|icon
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|iconmask
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|iconsize
operator|=
literal|32
expr_stmt|;
name|shell
operator|->
name|icon_needs_update
operator|=
name|FALSE
expr_stmt|;
name|shell
operator|->
name|icon_timeout_id
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|icon_idle_id
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|current_cursor
operator|=
operator|(
name|GdkCursorType
operator|)
operator|-
literal|1
expr_stmt|;
name|shell
operator|->
name|tool_cursor
operator|=
name|GIMP_TOOL_CURSOR_NONE
expr_stmt|;
name|shell
operator|->
name|cursor_modifier
operator|=
name|GIMP_CURSOR_MODIFIER_NONE
expr_stmt|;
name|shell
operator|->
name|override_cursor
operator|=
operator|(
name|GdkCursorType
operator|)
operator|-
literal|1
expr_stmt|;
name|shell
operator|->
name|using_override_cursor
operator|=
name|FALSE
expr_stmt|;
name|shell
operator|->
name|draw_cursor
operator|=
name|FALSE
expr_stmt|;
name|shell
operator|->
name|have_cursor
operator|=
name|FALSE
expr_stmt|;
name|shell
operator|->
name|cursor_x
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|cursor_y
operator|=
literal|0
expr_stmt|;
name|shell
operator|->
name|warning_dialog
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|info_dialog
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|nav_dialog
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|nav_popup
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|DISPLAY_FILTERS
name|shell
operator|->
name|cd_list
operator|=
name|NULL
expr_stmt|;
name|shell
operator|->
name|cd_ui
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* DISPLAY_FILTERS */
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_destroy (GtkObject * object)
name|gimp_display_shell_destroy
parameter_list|(
name|GtkObject
modifier|*
name|object
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|shell
operator|=
name|GIMP_DISPLAY_SHELL
argument_list|(
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|shell
operator|->
name|gdisp
condition|)
block|{
name|gimp_display_shell_disconnect
argument_list|(
name|shell
argument_list|)
expr_stmt|;
block|}
name|shell
operator|->
name|display_areas
operator|=
name|gimp_display_area_list_free
argument_list|(
name|shell
operator|->
name|display_areas
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DISPLAY_FILTERS
comment|/* detach any color displays */
name|gdisplay_color_detach_all
argument_list|(
name|gdisp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DISPLAY_FILTERS */
if|if
condition|(
name|shell
operator|->
name|scroll_gc
condition|)
block|{
name|gdk_gc_unref
argument_list|(
name|shell
operator|->
name|scroll_gc
argument_list|)
expr_stmt|;
name|shell
operator|->
name|scroll_gc
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|shell
operator|->
name|icon_timeout_id
condition|)
block|{
name|g_source_remove
argument_list|(
name|shell
operator|->
name|icon_timeout_id
argument_list|)
expr_stmt|;
name|shell
operator|->
name|icon_timeout_id
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|shell
operator|->
name|icon_idle_id
condition|)
block|{
name|g_source_remove
argument_list|(
name|shell
operator|->
name|icon_idle_id
argument_list|)
expr_stmt|;
name|shell
operator|->
name|icon_idle_id
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|shell
operator|->
name|icon
condition|)
block|{
name|gdk_drawable_unref
argument_list|(
name|shell
operator|->
name|icon
argument_list|)
expr_stmt|;
name|shell
operator|->
name|icon
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|shell
operator|->
name|iconmask
condition|)
block|{
name|gdk_drawable_unref
argument_list|(
name|shell
operator|->
name|iconmask
argument_list|)
expr_stmt|;
name|shell
operator|->
name|iconmask
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|shell
operator|->
name|info_dialog
condition|)
block|{
name|info_window_free
argument_list|(
name|shell
operator|->
name|info_dialog
argument_list|)
expr_stmt|;
name|shell
operator|->
name|info_dialog
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|shell
operator|->
name|nav_dialog
condition|)
block|{
name|nav_dialog_free
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|shell
operator|->
name|nav_dialog
argument_list|)
expr_stmt|;
name|shell
operator|->
name|nav_dialog
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|shell
operator|->
name|nav_popup
condition|)
block|{
name|nav_dialog_free
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|shell
operator|->
name|nav_popup
argument_list|)
expr_stmt|;
name|shell
operator|->
name|nav_popup
operator|=
name|NULL
expr_stmt|;
block|}
name|shell
operator|->
name|gdisp
operator|=
name|NULL
expr_stmt|;
name|GTK_OBJECT_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|destroy
argument_list|(
name|object
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_display_shell_delete_event (GtkWidget * widget,GdkEventAny * aevent)
name|gimp_display_shell_delete_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventAny
modifier|*
name|aevent
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|shell
operator|=
name|GIMP_DISPLAY_SHELL
argument_list|(
name|widget
argument_list|)
expr_stmt|;
name|gimp_display_shell_close
argument_list|(
name|shell
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|GtkWidget
modifier|*
DECL|function|gimp_display_shell_new (GimpDisplay * gdisp)
name|gimp_display_shell_new
parameter_list|(
name|GimpDisplay
modifier|*
name|gdisp
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|GtkWidget
modifier|*
name|main_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|disp_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|upper_hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|lower_hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|inner_table
decl_stmt|;
name|GtkWidget
modifier|*
name|status_hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|arrow
decl_stmt|;
name|GtkWidget
modifier|*
name|image
decl_stmt|;
name|GtkWidget
modifier|*
name|label_frame
decl_stmt|;
name|GtkWidget
modifier|*
name|nav_ebox
decl_stmt|;
name|GSList
modifier|*
name|group
init|=
name|NULL
decl_stmt|;
name|gint
name|image_width
decl_stmt|,
name|image_height
decl_stmt|;
name|gint
name|n_width
decl_stmt|,
name|n_height
decl_stmt|;
name|gint
name|s_width
decl_stmt|,
name|s_height
decl_stmt|;
name|gint
name|scalesrc
decl_stmt|,
name|scaledest
decl_stmt|;
name|gint
name|contextid
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|GIMP_IS_DISPLAY
argument_list|(
name|gdisp
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|image_width
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|width
expr_stmt|;
name|image_height
operator|=
name|gdisp
operator|->
name|gimage
operator|->
name|height
expr_stmt|;
comment|/*  adjust the initial scale -- so that window fits on screen    *  the 75% value is the same as in gdisplay_shrink_wrap. It    *  probably should be a user-configurable option.    */
name|s_width
operator|=
name|gdk_screen_width
argument_list|()
operator|*
literal|0.75
expr_stmt|;
name|s_height
operator|=
name|gdk_screen_height
argument_list|()
operator|*
literal|0.75
expr_stmt|;
name|scalesrc
operator|=
name|SCALESRC
argument_list|(
name|gdisp
argument_list|)
expr_stmt|;
name|scaledest
operator|=
name|SCALEDEST
argument_list|(
name|gdisp
argument_list|)
expr_stmt|;
name|n_width
operator|=
name|SCALEX
argument_list|(
name|gdisp
argument_list|,
name|image_width
argument_list|)
expr_stmt|;
name|n_height
operator|=
name|SCALEX
argument_list|(
name|gdisp
argument_list|,
name|image_height
argument_list|)
expr_stmt|;
comment|/*  Limit to the size of the screen...  */
while|while
condition|(
name|n_width
operator|>
name|s_width
operator|||
name|n_height
operator|>
name|s_height
condition|)
block|{
if|if
condition|(
name|scaledest
operator|>
literal|1
condition|)
name|scaledest
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|scalesrc
operator|<
literal|0xff
condition|)
name|scalesrc
operator|++
expr_stmt|;
name|n_width
operator|=
name|image_width
operator|*
operator|(
name|scaledest
operator|*
name|SCREEN_XRES
argument_list|(
name|gdisp
argument_list|)
operator|)
operator|/
operator|(
name|scalesrc
operator|*
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
operator|)
expr_stmt|;
name|n_height
operator|=
name|image_height
operator|*
operator|(
name|scaledest
operator|*
name|SCREEN_XRES
argument_list|(
name|gdisp
argument_list|)
operator|)
operator|/
operator|(
name|scalesrc
operator|*
name|gdisp
operator|->
name|gimage
operator|->
name|xresolution
operator|)
expr_stmt|;
block|}
name|gdisp
operator|->
name|scale
operator|=
operator|(
name|scaledest
operator|<<
literal|8
operator|)
operator|+
name|scalesrc
expr_stmt|;
comment|/*  the toplevel shell */
name|shell
operator|=
name|g_object_new
argument_list|(
name|GIMP_TYPE_DISPLAY_SHELL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|shell
operator|->
name|gdisp
operator|=
name|gdisp
expr_stmt|;
name|gtk_window_set_wmclass
argument_list|(
name|GTK_WINDOW
argument_list|(
name|shell
argument_list|)
argument_list|,
literal|"image_window"
argument_list|,
literal|"Gimp"
argument_list|)
expr_stmt|;
name|gtk_window_set_policy
argument_list|(
name|GTK_WINDOW
argument_list|(
name|shell
argument_list|)
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
operator|(
name|GDK_POINTER_MOTION_MASK
operator||
name|GDK_POINTER_MOTION_HINT_MASK
operator||
name|GDK_BUTTON_PRESS_MASK
operator||
name|GDK_KEY_PRESS_MASK
operator||
name|GDK_KEY_RELEASE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/*  the popup menu  */
name|shell
operator|->
name|ifactory
operator|=
name|menus_get_image_factory
argument_list|()
expr_stmt|;
comment|/*  The accelerator table for images  */
name|gimp_window_add_accel_group
argument_list|(
name|GTK_WINDOW
argument_list|(
name|shell
argument_list|)
argument_list|,
name|shell
operator|->
name|ifactory
argument_list|,
name|gimp_display_shell_get_accel_context
argument_list|,
name|shell
argument_list|)
expr_stmt|;
comment|/*  active display callback  */
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_events
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
argument_list|)
argument_list|,
literal|"key_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_events
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
comment|/*  dnd stuff  */
name|gtk_drag_dest_set
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|GTK_DEST_DEFAULT_ALL
argument_list|,
name|display_target_table
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|display_target_table
argument_list|)
argument_list|,
name|GDK_ACTION_COPY
argument_list|)
expr_stmt|;
name|gimp_dnd_viewable_dest_set
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|GIMP_TYPE_LAYER
argument_list|,
name|gimp_display_shell_drop_drawable
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_dnd_viewable_dest_set
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|GIMP_TYPE_LAYER_MASK
argument_list|,
name|gimp_display_shell_drop_drawable
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_dnd_viewable_dest_set
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|GIMP_TYPE_CHANNEL
argument_list|,
name|gimp_display_shell_drop_drawable
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_dnd_viewable_dest_set
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|GIMP_TYPE_PATTERN
argument_list|,
name|gimp_display_shell_drop_pattern
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_dnd_viewable_dest_set
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|GIMP_TYPE_BUFFER
argument_list|,
name|gimp_display_shell_drop_buffer
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_dnd_color_dest_set
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|gimp_display_shell_drop_color
argument_list|,
name|shell
argument_list|)
expr_stmt|;
comment|/*  connect the "F1" help key  */
name|gimp_help_connect
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"image/image_window.html"
argument_list|)
expr_stmt|;
comment|/*  GtkTable widgets are not able to shrink a row/column correctly if    *  widgets are attached with GTK_EXPAND even if those widgets have    *  other rows/columns in their rowspan/colspan where they could    *  nicely expand without disturbing the row/column which is supposed    *  to shrink. --Mitch    *    *  Changed the packing to use hboxes and vboxes which behave nicer:    *    *  main_vbox    *     |    *     +-- disp_vbox    *     |      |    *     |      +-- upper_hbox    *     |      |      |    *     |      |      +-- inner_table    *     |      |      |      |    *     |      |      |      +-- origin    *     |      |      |      +-- hruler    *     |      |      |      +-- vruler    *     |      |      |      +-- canvas    *     |      |      |         *     |      |      +-- vscrollbar    *     |      |        *     |      +-- lower_hbox    *     |             |    *     |             +-- qmaskoff    *     |             +-- qmaskon    *     |             +-- hscrollbar    *     |             +-- navbutton    *     |    *     +-- statusarea    *            |    *            +-- cursorlabel    *            +-- statusbar    *            +-- progressbar    *            +-- cancelbutton    */
comment|/*  first, set up the container hierarchy  *********************************/
comment|/*  the vbox containing all widgets  */
name|main_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|shell
argument_list|)
argument_list|,
name|main_vbox
argument_list|)
expr_stmt|;
comment|/*  another vbox for everything except the statusbar  */
name|disp_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|disp_vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|disp_vbox
argument_list|)
expr_stmt|;
comment|/*  a hbox for the inner_table and the vertical scrollbar  */
name|upper_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|disp_vbox
argument_list|)
argument_list|,
name|upper_hbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|upper_hbox
argument_list|)
expr_stmt|;
comment|/*  the table containing origin, rulers and the canvas  */
name|inner_table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|inner_table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|inner_table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|upper_hbox
argument_list|)
argument_list|,
name|inner_table
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|inner_table
argument_list|)
expr_stmt|;
comment|/*  the hbox containing qmask buttons, vertical scrollbar and nav button  */
name|lower_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|disp_vbox
argument_list|)
argument_list|,
name|lower_hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|lower_hbox
argument_list|)
expr_stmt|;
comment|/*  eventbox and hbox for status area  */
name|shell
operator|->
name|statusarea
operator|=
name|gtk_event_box_new
argument_list|()
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|shell
operator|->
name|statusarea
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|shell
operator|->
name|statusarea
argument_list|,
name|NULL
argument_list|,
literal|"#status_area"
argument_list|)
expr_stmt|;
name|status_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|shell
operator|->
name|statusarea
argument_list|)
argument_list|,
name|status_hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|status_hbox
argument_list|)
expr_stmt|;
name|gtk_container_set_resize_mode
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|status_hbox
argument_list|)
argument_list|,
name|GTK_RESIZE_QUEUE
argument_list|)
expr_stmt|;
comment|/*  create the scrollbars  *************************************************/
comment|/*  the horizontal scrollbar  */
name|shell
operator|->
name|hsbdata
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|gtk_adjustment_new
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|image_width
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|image_width
argument_list|)
argument_list|)
expr_stmt|;
name|shell
operator|->
name|hsb
operator|=
name|gtk_hscrollbar_new
argument_list|(
name|shell
operator|->
name|hsbdata
argument_list|)
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|shell
operator|->
name|hsb
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
comment|/*  the vertical scrollbar  */
name|shell
operator|->
name|vsbdata
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|gtk_adjustment_new
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|image_height
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|image_height
argument_list|)
argument_list|)
expr_stmt|;
name|shell
operator|->
name|vsb
operator|=
name|gtk_vscrollbar_new
argument_list|(
name|shell
operator|->
name|vsbdata
argument_list|)
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|shell
operator|->
name|vsb
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
comment|/*  create the contents of the inner_table  ********************************/
comment|/*  the menu popup button  */
name|shell
operator|->
name|origin
operator|=
name|gtk_button_new
argument_list|()
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|shell
operator|->
name|origin
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
operator|->
name|origin
argument_list|)
argument_list|,
name|GDK_BUTTON_PRESS_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|origin
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_origin_button_press
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|shell
operator|->
name|origin
argument_list|,
name|NULL
argument_list|,
literal|"#origin_button"
argument_list|)
expr_stmt|;
name|arrow
operator|=
name|gtk_arrow_new
argument_list|(
name|GTK_ARROW_RIGHT
argument_list|,
name|GTK_SHADOW_OUT
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|shell
operator|->
name|origin
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|shell
operator|->
name|origin
argument_list|)
argument_list|,
name|arrow
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|arrow
argument_list|)
expr_stmt|;
comment|/*  the horizontal ruler  */
name|shell
operator|->
name|hrule
operator|=
name|gtk_hruler_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
operator|->
name|hrule
argument_list|)
argument_list|,
name|GDK_BUTTON_PRESS_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
argument_list|)
argument_list|,
literal|"motion_notify_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|GTK_WIDGET_GET_CLASS
argument_list|(
name|shell
operator|->
name|hrule
argument_list|)
operator|->
name|motion_notify_event
argument_list|)
argument_list|,
name|shell
operator|->
name|hrule
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|hrule
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_hruler_button_press
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|shell
operator|->
name|hrule
argument_list|,
name|NULL
argument_list|,
literal|"#ruler"
argument_list|)
expr_stmt|;
comment|/*  the vertical ruler  */
name|shell
operator|->
name|vrule
operator|=
name|gtk_vruler_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
operator|->
name|vrule
argument_list|)
argument_list|,
name|GDK_BUTTON_PRESS_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
argument_list|)
argument_list|,
literal|"motion_notify_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|GTK_WIDGET_GET_CLASS
argument_list|(
name|shell
operator|->
name|vrule
argument_list|)
operator|->
name|motion_notify_event
argument_list|)
argument_list|,
name|shell
operator|->
name|vrule
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|vrule
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_vruler_button_press
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|shell
operator|->
name|vrule
argument_list|,
name|NULL
argument_list|,
literal|"#ruler"
argument_list|)
expr_stmt|;
comment|/*  the canvas  */
name|shell
operator|->
name|canvas
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_name
argument_list|(
name|shell
operator|->
name|canvas
argument_list|,
literal|"gimp-canvas"
argument_list|)
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|,
name|n_width
argument_list|,
name|n_height
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|shell
operator|->
name|canvas
argument_list|,
name|GIMP_DISPLAY_SHELL_CANVAS_EVENT_MASK
argument_list|)
expr_stmt|;
name|gtk_widget_set_extension_events
argument_list|(
name|shell
operator|->
name|canvas
argument_list|,
name|GDK_EXTENSION_EVENTS_ALL
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|shell
operator|->
name|canvas
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|,
literal|"realize"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_canvas_realize
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
comment|/*  set the active display before doing any other canvas event processing  */
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|,
literal|"event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_events
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|,
literal|"event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_canvas_events
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
comment|/*  create the contents of the lower_hbox  *********************************/
comment|/*  the qmask buttons  */
name|shell
operator|->
name|qmaskoff
operator|=
name|gtk_radio_button_new
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|group
operator|=
name|gtk_radio_button_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|)
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_mode
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
name|image
operator|=
name|gtk_image_new_from_stock
argument_list|(
name|GIMP_STOCK_QMASK_OFF
argument_list|,
name|GTK_ICON_SIZE_MENU
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|,
name|NULL
argument_list|,
literal|"#qmask_off_button"
argument_list|)
expr_stmt|;
name|shell
operator|->
name|qmaskon
operator|=
name|gtk_radio_button_new
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|group
operator|=
name|gtk_radio_button_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|)
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_mode
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|GTK_WIDGET_UNSET_FLAGS
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|,
name|GTK_CAN_FOCUS
argument_list|)
expr_stmt|;
name|image
operator|=
name|gtk_image_new_from_stock
argument_list|(
name|GIMP_STOCK_QMASK_ON
argument_list|,
name|GTK_ICON_SIZE_MENU
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
name|gdisp
operator|->
name|gimage
operator|->
name|qmask_state
condition|)
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_qmask_off_toggled
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_qmask_button_press
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_qmask_on_toggled
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_qmask_button_press
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|,
name|NULL
argument_list|,
literal|"#qmask_on_button"
argument_list|)
expr_stmt|;
comment|/*  the navigation window button  */
name|nav_ebox
operator|=
name|gtk_event_box_new
argument_list|()
expr_stmt|;
name|image
operator|=
name|gtk_image_new_from_stock
argument_list|(
name|GIMP_STOCK_NAVIGATION
argument_list|,
name|GTK_ICON_SIZE_MENU
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|nav_ebox
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|nav_ebox
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|nav_popup_click_handler
argument_list|)
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|nav_ebox
argument_list|,
name|NULL
argument_list|,
literal|"#nav_window_button"
argument_list|)
expr_stmt|;
comment|/*  Icon stuff  */
name|g_signal_connect
argument_list|(
name|G_OBJECT
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|,
literal|"invalidate_preview"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_display_shell_update_icon_scheduler
argument_list|)
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gimp_display_shell_update_icon_scheduler
argument_list|(
name|gdisp
operator|->
name|gimage
argument_list|,
name|shell
argument_list|)
expr_stmt|;
comment|/*  create the contents of the status area *********************************/
comment|/*  the cursor label  */
name|label_frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|label_frame
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|shell
operator|->
name|cursor_label
operator|=
name|gtk_label_new
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|label_frame
argument_list|)
argument_list|,
name|shell
operator|->
name|cursor_label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|cursor_label
argument_list|)
expr_stmt|;
comment|/*  the statusbar  */
name|shell
operator|->
name|statusbar
operator|=
name|gtk_statusbar_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|shell
operator|->
name|statusbar
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_container_set_resize_mode
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|shell
operator|->
name|statusbar
argument_list|)
argument_list|,
name|GTK_RESIZE_QUEUE
argument_list|)
expr_stmt|;
name|contextid
operator|=
name|gtk_statusbar_get_context_id
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|shell
operator|->
name|statusbar
argument_list|)
argument_list|,
literal|"title"
argument_list|)
expr_stmt|;
name|gtk_statusbar_push
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|shell
operator|->
name|statusbar
argument_list|)
argument_list|,
name|contextid
argument_list|,
literal|"FooBar"
argument_list|)
expr_stmt|;
comment|/*  the progress bar  */
name|shell
operator|->
name|progressbar
operator|=
name|gtk_progress_bar_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|shell
operator|->
name|progressbar
argument_list|,
literal|80
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*  the cancel button  */
name|shell
operator|->
name|cancelbutton
operator|=
name|gtk_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|shell
operator|->
name|cancelbutton
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  pack all the widgets  **************************************************/
comment|/*  fill the upper_hbox  */
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|upper_hbox
argument_list|)
argument_list|,
name|shell
operator|->
name|vsb
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  fill the inner_table  */
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|inner_table
argument_list|)
argument_list|,
name|shell
operator|->
name|origin
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|inner_table
argument_list|)
argument_list|,
name|shell
operator|->
name|hrule
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|inner_table
argument_list|)
argument_list|,
name|shell
operator|->
name|vrule
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|inner_table
argument_list|)
argument_list|,
name|shell
operator|->
name|canvas
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  fill the lower_hbox  */
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|lower_hbox
argument_list|)
argument_list|,
name|shell
operator|->
name|qmaskoff
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|lower_hbox
argument_list|)
argument_list|,
name|shell
operator|->
name|qmaskon
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|lower_hbox
argument_list|)
argument_list|,
name|shell
operator|->
name|hsb
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|lower_hbox
argument_list|)
argument_list|,
name|nav_ebox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  fill the status area  */
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|status_hbox
argument_list|)
argument_list|,
name|label_frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|status_hbox
argument_list|)
argument_list|,
name|shell
operator|->
name|statusbar
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|status_hbox
argument_list|)
argument_list|,
name|shell
operator|->
name|progressbar
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|status_hbox
argument_list|)
argument_list|,
name|shell
operator|->
name|cancelbutton
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  show everything  *******************************************************/
if|if
condition|(
name|gimprc
operator|.
name|show_rulers
condition|)
block|{
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|origin
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|hrule
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|vrule
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|vsb
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|hsb
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|qmaskoff
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|qmaskon
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|nav_ebox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label_frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|statusbar
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|progressbar
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|cancelbutton
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimprc
operator|.
name|show_statusbar
condition|)
block|{
name|gtk_widget_show
argument_list|(
name|shell
operator|->
name|statusarea
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_show
argument_list|(
name|main_vbox
argument_list|)
expr_stmt|;
name|gimp_display_shell_connect
argument_list|(
name|shell
argument_list|)
expr_stmt|;
return|return
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
return|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_close (GimpDisplayShell * shell,gboolean kill_it)
name|gimp_display_shell_close
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gboolean
name|kill_it
parameter_list|)
block|{
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
name|gimage
operator|=
name|shell
operator|->
name|gdisp
operator|->
name|gimage
expr_stmt|;
comment|/*  FIXME: gimp_busy HACK not really appropriate here because we only    *  want to prevent the busy image and display to be closed.  --Mitch    */
if|if
condition|(
name|gimage
operator|->
name|gimp
operator|->
name|busy
condition|)
return|return;
comment|/*  If the image has been modified, give the user a chance to save    *  it before nuking it--this only applies if its the last view    *  to an image canvas.  (a gimage with disp_count = 1)    */
if|if
condition|(
operator|!
name|kill_it
operator|&&
operator|(
name|gimage
operator|->
name|disp_count
operator|==
literal|1
operator|)
operator|&&
name|gimage
operator|->
name|dirty
operator|&&
name|gimprc
operator|.
name|confirm_on_close
condition|)
block|{
name|gchar
modifier|*
name|basename
decl_stmt|;
name|basename
operator|=
name|g_path_get_basename
argument_list|(
name|gimp_image_filename
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_display_shell_close_warning_dialog
argument_list|(
name|shell
argument_list|,
name|basename
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|basename
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gdisplay_delete
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_transform_coords (GimpDisplayShell * shell,GimpCoords * image_coords,GimpCoords * display_coords)
name|gimp_display_shell_transform_coords
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|GimpCoords
modifier|*
name|image_coords
parameter_list|,
name|GimpCoords
modifier|*
name|display_coords
parameter_list|)
block|{
name|gdouble
name|scalex
decl_stmt|;
name|gdouble
name|scaley
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|image_coords
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|display_coords
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|scalex
operator|=
name|SCALEFACTOR_X
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
name|scaley
operator|=
name|SCALEFACTOR_Y
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
name|display_coords
operator|->
name|x
operator|=
name|scalex
operator|*
name|image_coords
operator|->
name|x
expr_stmt|;
name|display_coords
operator|->
name|y
operator|=
name|scaley
operator|*
name|image_coords
operator|->
name|y
expr_stmt|;
name|display_coords
operator|->
name|x
operator|+=
operator|-
name|shell
operator|->
name|offset_x
operator|+
name|shell
operator|->
name|disp_xoffset
expr_stmt|;
name|display_coords
operator|->
name|y
operator|+=
operator|-
name|shell
operator|->
name|offset_y
operator|+
name|shell
operator|->
name|disp_yoffset
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_untransform_coords (GimpDisplayShell * shell,GimpCoords * display_coords,GimpCoords * image_coords)
name|gimp_display_shell_untransform_coords
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|GimpCoords
modifier|*
name|display_coords
parameter_list|,
name|GimpCoords
modifier|*
name|image_coords
parameter_list|)
block|{
name|gdouble
name|scalex
decl_stmt|;
name|gdouble
name|scaley
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|display_coords
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|image_coords
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|scalex
operator|=
name|SCALEFACTOR_X
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
name|scaley
operator|=
name|SCALEFACTOR_Y
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
name|image_coords
operator|->
name|x
operator|=
name|display_coords
operator|->
name|x
operator|-
name|shell
operator|->
name|disp_xoffset
operator|+
name|shell
operator|->
name|offset_x
expr_stmt|;
name|image_coords
operator|->
name|y
operator|=
name|display_coords
operator|->
name|y
operator|-
name|shell
operator|->
name|disp_yoffset
operator|+
name|shell
operator|->
name|offset_y
expr_stmt|;
name|image_coords
operator|->
name|x
operator|/=
name|scalex
expr_stmt|;
name|image_coords
operator|->
name|y
operator|/=
name|scaley
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_set_menu_sensitivity (GimpDisplayShell * shell)
name|gimp_display_shell_set_menu_sensitivity
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|GimpDisplay
modifier|*
name|gdisp
init|=
name|NULL
decl_stmt|;
name|GimpImage
modifier|*
name|gimage
init|=
name|NULL
decl_stmt|;
name|GimpImageBaseType
name|base_type
init|=
literal|0
decl_stmt|;
name|GimpImageType
name|type
init|=
operator|-
literal|1
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
init|=
name|NULL
decl_stmt|;
name|GimpLayer
modifier|*
name|layer
init|=
name|NULL
decl_stmt|;
name|gboolean
name|fs
init|=
name|FALSE
decl_stmt|;
name|gboolean
name|aux
init|=
name|FALSE
decl_stmt|;
name|gboolean
name|lm
init|=
name|FALSE
decl_stmt|;
name|gboolean
name|lp
init|=
name|FALSE
decl_stmt|;
name|gboolean
name|alpha
init|=
name|FALSE
decl_stmt|;
name|gint
name|lind
init|=
operator|-
literal|1
decl_stmt|;
name|gint
name|lnum
init|=
operator|-
literal|1
decl_stmt|;
name|g_return_if_fail
argument_list|(
operator|!
name|shell
operator|||
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shell
condition|)
name|gdisp
operator|=
name|shell
operator|->
name|gdisp
expr_stmt|;
if|if
condition|(
name|gdisp
condition|)
block|{
name|gimage
operator|=
name|gdisp
operator|->
name|gimage
expr_stmt|;
name|base_type
operator|=
name|gimp_image_base_type
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|fs
operator|=
operator|(
name|gimp_image_floating_sel
argument_list|(
name|gimage
argument_list|)
operator|!=
name|NULL
operator|)
expr_stmt|;
name|aux
operator|=
operator|(
name|gimp_image_get_active_channel
argument_list|(
name|gimage
argument_list|)
operator|!=
name|NULL
operator|)
expr_stmt|;
name|lp
operator|=
operator|!
name|gimp_image_is_empty
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
name|drawable
operator|=
name|gimp_image_active_drawable
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
name|drawable
condition|)
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp
condition|)
block|{
name|layer
operator|=
name|gimp_image_get_active_layer
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer
condition|)
block|{
name|lm
operator|=
name|gimp_layer_get_mask
argument_list|(
name|layer
argument_list|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
name|alpha
operator|=
name|gimp_layer_has_alpha
argument_list|(
name|layer
argument_list|)
expr_stmt|;
name|lind
operator|=
name|gimp_image_get_layer_index
argument_list|(
name|gimage
argument_list|,
name|layer
argument_list|)
expr_stmt|;
block|}
name|lnum
operator|=
name|gimp_container_num_children
argument_list|(
name|gimage
operator|->
name|layers
argument_list|)
expr_stmt|;
block|}
block|}
DECL|macro|SET_SENSITIVE (menu,condition)
define|#
directive|define
name|SET_SENSITIVE
parameter_list|(
name|menu
parameter_list|,
name|condition
parameter_list|)
define|\
value|menus_set_sensitive ("<Image>/" menu, (condition) != 0)
DECL|macro|SET_STATE (menu,condition)
define|#
directive|define
name|SET_STATE
parameter_list|(
name|menu
parameter_list|,
name|condition
parameter_list|)
define|\
value|menus_set_state ("<Image>/" menu, (condition) != 0)
name|SET_SENSITIVE
argument_list|(
literal|"File/Save"
argument_list|,
name|gdisp
operator|&&
name|drawable
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"File/Save as..."
argument_list|,
name|gdisp
operator|&&
name|drawable
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"File/Save a Copy as..."
argument_list|,
name|gdisp
operator|&&
name|drawable
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"File/Revert..."
argument_list|,
name|gdisp
operator|&&
name|GIMP_OBJECT
argument_list|(
name|gimage
argument_list|)
operator|->
name|name
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"File/Close"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Buffer"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
if|if
condition|(
name|gdisp
condition|)
block|{
comment|/* Interactive tools such as CURVES, COLOR_BALANCE, LEVELS disable */
comment|/* undo to fake some kind of atomic behaviour. G. R. Osgood #14072  */
if|if
condition|(
name|gimp_image_undo_is_enabled
argument_list|(
name|gimage
argument_list|)
condition|)
block|{
comment|/* If undo/redo stacks are empty, disable respective menu */
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Undo"
argument_list|,
name|undo_get_undo_name
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Redo"
argument_list|,
name|undo_get_redo_name
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Undo"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Redo"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Cut"
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Copy"
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Buffer/Cut Named..."
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Buffer/Copy Named..."
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Clear"
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Fill with FG Color"
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Fill with BG Color"
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Edit/Stroke"
argument_list|,
name|lp
argument_list|)
expr_stmt|;
block|}
name|SET_SENSITIVE
argument_list|(
literal|"Select"
argument_list|,
name|gdisp
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Select/Save to Channel"
argument_list|,
operator|!
name|fs
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"View"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"View/Zoom"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
if|if
condition|(
name|gdisp
condition|)
block|{
name|SET_STATE
argument_list|(
literal|"View/Toggle Selection"
argument_list|,
operator|!
name|gdisp
operator|->
name|select
operator|->
name|hidden
argument_list|)
expr_stmt|;
name|SET_STATE
argument_list|(
literal|"View/Toggle Rulers"
argument_list|,
name|GTK_WIDGET_VISIBLE
argument_list|(
name|shell
operator|->
name|origin
argument_list|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|SET_STATE
argument_list|(
literal|"View/Toggle Guides"
argument_list|,
name|gdisp
operator|->
name|draw_guides
argument_list|)
expr_stmt|;
name|SET_STATE
argument_list|(
literal|"View/Snap to Guides"
argument_list|,
name|gdisp
operator|->
name|snap_to_guides
argument_list|)
expr_stmt|;
name|SET_STATE
argument_list|(
literal|"View/Toggle Statusbar"
argument_list|,
name|GTK_WIDGET_VISIBLE
argument_list|(
name|shell
operator|->
name|statusarea
argument_list|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|SET_STATE
argument_list|(
literal|"View/Dot for Dot"
argument_list|,
name|gdisp
operator|->
name|dot_for_dot
argument_list|)
expr_stmt|;
block|}
name|SET_SENSITIVE
argument_list|(
literal|"Image"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Mode"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Auto"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Alpha"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Transforms"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Transforms/Rotate"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
if|if
condition|(
name|gdisp
condition|)
block|{
name|SET_SENSITIVE
argument_list|(
literal|"Image/Mode/RGB"
argument_list|,
operator|(
name|base_type
operator|!=
name|RGB
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Mode/Grayscale"
argument_list|,
operator|(
name|base_type
operator|!=
name|GRAY
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Mode/Indexed..."
argument_list|,
operator|(
name|base_type
operator|!=
name|INDEXED
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Histogram..."
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors"
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Color Balance..."
argument_list|,
operator|(
name|base_type
operator|==
name|RGB
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Hue-Saturation..."
argument_list|,
operator|(
name|base_type
operator|==
name|RGB
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Brightness-Contrast..."
argument_list|,
operator|(
name|base_type
operator|!=
name|INDEXED
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Threshold..."
argument_list|,
operator|(
name|base_type
operator|!=
name|INDEXED
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Levels..."
argument_list|,
operator|(
name|base_type
operator|!=
name|INDEXED
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Curves..."
argument_list|,
operator|(
name|base_type
operator|!=
name|INDEXED
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Desaturate"
argument_list|,
operator|(
name|base_type
operator|==
name|RGB
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Posterize..."
argument_list|,
operator|(
name|base_type
operator|!=
name|INDEXED
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Invert"
argument_list|,
operator|(
name|base_type
operator|!=
name|INDEXED
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Colors/Auto/Equalize"
argument_list|,
operator|(
name|base_type
operator|!=
name|INDEXED
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Alpha/Add Alpha Channel"
argument_list|,
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
operator|!
name|lm
operator|&&
operator|!
name|alpha
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Image/Transforms/Offset..."
argument_list|,
name|lp
argument_list|)
expr_stmt|;
block|}
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Stack"
argument_list|,
name|gdisp
argument_list|)
expr_stmt|;
if|if
condition|(
name|gdisp
condition|)
block|{
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Stack/Previous Layer"
argument_list|,
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
name|lind
operator|>
literal|0
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Stack/Next Layer"
argument_list|,
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
name|lind
operator|<
operator|(
name|lnum
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Stack/Raise Layer"
argument_list|,
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
name|alpha
operator|&&
name|lind
operator|>
literal|0
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Stack/Lower Layer"
argument_list|,
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
name|alpha
operator|&&
name|lind
operator|<
operator|(
name|lnum
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Stack/Layer to Top"
argument_list|,
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
name|alpha
operator|&&
name|lind
operator|>
literal|0
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Stack/Layer to Bottom"
argument_list|,
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
name|alpha
operator|&&
name|lind
operator|<
operator|(
name|lnum
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Rotate"
argument_list|,
name|gdisp
operator|&&
operator|!
name|aux
operator|&&
operator|!
name|lm
operator|&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Layer to Imagesize"
argument_list|,
name|gdisp
operator|&&
operator|!
name|aux
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Anchor Layer"
argument_list|,
name|gdisp
operator|&&
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Merge Visible Layers..."
argument_list|,
name|gdisp
operator|&&
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Flatten Image"
argument_list|,
name|gdisp
operator|&&
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Alpha to Selection"
argument_list|,
name|gdisp
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
name|alpha
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Mask to Selection"
argument_list|,
name|gdisp
operator|&&
operator|!
name|aux
operator|&&
name|lm
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Layers/Add Alpha Channel"
argument_list|,
name|gdisp
operator|&&
operator|!
name|fs
operator|&&
operator|!
name|aux
operator|&&
name|lp
operator|&&
operator|!
name|lm
operator|&&
operator|!
name|alpha
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Filters"
argument_list|,
name|gdisp
operator|&&
name|lp
argument_list|)
expr_stmt|;
name|SET_SENSITIVE
argument_list|(
literal|"Script-Fu"
argument_list|,
name|gdisp
operator|&&
name|lp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SET_STATE
undef|#
directive|undef
name|SET_SENSITIVE
name|plug_in_set_menu_sensitivity
argument_list|(
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GimpGuide
modifier|*
DECL|function|gimp_display_shell_find_guide (GimpDisplayShell * shell,gdouble x,gdouble y)
name|gimp_display_shell_find_guide
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
block|{
name|g_return_val_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|shell
operator|->
name|gdisp
operator|->
name|draw_guides
condition|)
block|{
name|gdouble
name|image_x
decl_stmt|,
name|image_y
decl_stmt|;
name|gdisplay_untransform_coords_f
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|image_x
argument_list|,
operator|&
name|image_y
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|gimp_image_find_guide
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|,
operator|(
name|gint
operator|)
name|image_x
argument_list|,
operator|(
name|gint
operator|)
name|image_y
argument_list|)
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|gboolean
DECL|function|gimp_display_shell_snap_point (GimpDisplayShell * shell,gdouble x,gdouble y,gdouble * tx,gdouble * ty)
name|gimp_display_shell_snap_point
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|gdouble
modifier|*
name|tx
parameter_list|,
name|gdouble
modifier|*
name|ty
parameter_list|)
block|{
name|gboolean
name|snapped
init|=
name|FALSE
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|tx
operator|!=
name|NULL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|ty
operator|!=
name|NULL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
operator|*
name|tx
operator|=
name|x
expr_stmt|;
operator|*
name|ty
operator|=
name|y
expr_stmt|;
if|if
condition|(
name|shell
operator|->
name|gdisp
operator|->
name|draw_guides
operator|&&
name|shell
operator|->
name|gdisp
operator|->
name|snap_to_guides
operator|&&
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|guides
condition|)
block|{
name|gdouble
name|image_x
decl_stmt|,
name|image_y
decl_stmt|;
name|gint
name|image_tx
decl_stmt|,
name|image_ty
decl_stmt|;
name|gdisplay_untransform_coords_f
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|image_x
argument_list|,
operator|&
name|image_y
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|snapped
operator|=
name|gimp_image_snap_point
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|,
operator|(
name|gint
operator|)
name|image_x
argument_list|,
operator|(
name|gint
operator|)
name|image_y
argument_list|,
operator|&
name|image_tx
argument_list|,
operator|&
name|image_ty
argument_list|)
expr_stmt|;
if|if
condition|(
name|snapped
condition|)
block|{
name|gdisplay_transform_coords_f
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
operator|(
name|gdouble
operator|)
name|image_tx
argument_list|,
operator|(
name|gdouble
operator|)
name|image_ty
argument_list|,
name|tx
argument_list|,
name|ty
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|snapped
return|;
block|}
end_function

begin_function
name|gboolean
DECL|function|gimp_display_shell_snap_rectangle (GimpDisplayShell * shell,gdouble x1,gdouble y1,gdouble x2,gdouble y2,gdouble * tx1,gdouble * ty1)
name|gimp_display_shell_snap_rectangle
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gdouble
name|x1
parameter_list|,
name|gdouble
name|y1
parameter_list|,
name|gdouble
name|x2
parameter_list|,
name|gdouble
name|y2
parameter_list|,
name|gdouble
modifier|*
name|tx1
parameter_list|,
name|gdouble
modifier|*
name|ty1
parameter_list|)
block|{
name|gdouble
name|nx1
decl_stmt|,
name|ny1
decl_stmt|;
name|gdouble
name|nx2
decl_stmt|,
name|ny2
decl_stmt|;
name|gboolean
name|snap1
decl_stmt|,
name|snap2
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|tx1
operator|!=
name|NULL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|ty1
operator|!=
name|NULL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
operator|*
name|tx1
operator|=
name|x1
expr_stmt|;
operator|*
name|ty1
operator|=
name|y1
expr_stmt|;
name|snap1
operator|=
name|gimp_display_shell_snap_point
argument_list|(
name|shell
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|&
name|nx1
argument_list|,
operator|&
name|ny1
argument_list|)
expr_stmt|;
name|snap2
operator|=
name|gimp_display_shell_snap_point
argument_list|(
name|shell
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|,
operator|&
name|nx2
argument_list|,
operator|&
name|ny2
argument_list|)
expr_stmt|;
if|if
condition|(
name|snap1
operator|||
name|snap2
condition|)
block|{
if|if
condition|(
name|x1
operator|!=
name|nx1
condition|)
operator|*
name|tx1
operator|=
name|nx1
expr_stmt|;
elseif|else
if|if
condition|(
name|x2
operator|!=
name|nx2
condition|)
operator|*
name|tx1
operator|=
name|x1
operator|+
operator|(
name|nx2
operator|-
name|x2
operator|)
expr_stmt|;
if|if
condition|(
name|y1
operator|!=
name|ny1
condition|)
operator|*
name|ty1
operator|=
name|ny1
expr_stmt|;
elseif|else
if|if
condition|(
name|y2
operator|!=
name|ny2
condition|)
operator|*
name|ty1
operator|=
name|y1
operator|+
operator|(
name|ny2
operator|-
name|y2
operator|)
expr_stmt|;
block|}
return|return
name|snap1
operator|||
name|snap2
return|;
block|}
end_function

begin_function
name|gint
DECL|function|gimp_display_shell_mask_value (GimpDisplayShell * shell,gint x,gint y)
name|gimp_display_shell_mask_value
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
name|g_return_val_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  move the coordinates from screen space to image space  */
name|gdisplay_untransform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|gimage_mask_value
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
return|;
block|}
end_function

begin_function
name|gboolean
DECL|function|gimp_display_shell_mask_bounds (GimpDisplayShell * shell,gint * x1,gint * y1,gint * x2,gint * y2)
name|gimp_display_shell_mask_bounds
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
modifier|*
name|x1
parameter_list|,
name|gint
modifier|*
name|y1
parameter_list|,
name|gint
modifier|*
name|x2
parameter_list|,
name|gint
modifier|*
name|y2
parameter_list|)
block|{
name|GimpLayer
modifier|*
name|layer
decl_stmt|;
name|gint
name|off_x
decl_stmt|;
name|gint
name|off_y
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|x1
operator|!=
name|NULL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|y1
operator|!=
name|NULL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|x2
operator|!=
name|NULL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|y2
operator|!=
name|NULL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  If there is a floating selection, handle things differently  */
if|if
condition|(
operator|(
name|layer
operator|=
name|gimp_image_floating_sel
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|)
operator|)
condition|)
block|{
name|gimp_drawable_offsets
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|,
operator|&
name|off_x
argument_list|,
operator|&
name|off_y
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gimp_channel_bounds
argument_list|(
name|gimp_image_get_mask
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
condition|)
block|{
operator|*
name|x1
operator|=
name|off_x
expr_stmt|;
operator|*
name|y1
operator|=
name|off_y
expr_stmt|;
operator|*
name|x2
operator|=
name|off_x
operator|+
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|y2
operator|=
name|off_y
operator|+
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|x1
operator|=
name|MIN
argument_list|(
name|off_x
argument_list|,
operator|*
name|x1
argument_list|)
expr_stmt|;
operator|*
name|y1
operator|=
name|MIN
argument_list|(
name|off_y
argument_list|,
operator|*
name|y1
argument_list|)
expr_stmt|;
operator|*
name|x2
operator|=
name|MAX
argument_list|(
name|off_x
operator|+
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
argument_list|,
operator|*
name|x2
argument_list|)
expr_stmt|;
operator|*
name|y2
operator|=
name|MAX
argument_list|(
name|off_y
operator|+
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|layer
argument_list|)
argument_list|)
argument_list|,
operator|*
name|y2
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|gimp_channel_bounds
argument_list|(
name|gimp_image_get_mask
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
condition|)
block|{
return|return
name|FALSE
return|;
block|}
name|gdisplay_transform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
operator|*
name|x1
argument_list|,
operator|*
name|y1
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gdisplay_transform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
operator|*
name|x2
argument_list|,
operator|*
name|y2
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  Make sure the extents are within bounds  */
operator|*
name|x1
operator|=
name|CLAMP
argument_list|(
operator|*
name|x1
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_width
argument_list|)
expr_stmt|;
operator|*
name|y1
operator|=
name|CLAMP
argument_list|(
operator|*
name|y1
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_height
argument_list|)
expr_stmt|;
operator|*
name|x2
operator|=
name|CLAMP
argument_list|(
operator|*
name|x2
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_width
argument_list|)
expr_stmt|;
operator|*
name|y2
operator|=
name|CLAMP
argument_list|(
operator|*
name|y2
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_height
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_add_expose_area (GimpDisplayShell * shell,gint x,gint y,gint w,gint h)
name|gimp_display_shell_add_expose_area
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|)
block|{
name|GimpArea
modifier|*
name|area
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|area
operator|=
name|g_new
argument_list|(
name|GimpArea
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|area
operator|->
name|x1
operator|=
name|CLAMP
argument_list|(
name|x
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_width
argument_list|)
expr_stmt|;
name|area
operator|->
name|y1
operator|=
name|CLAMP
argument_list|(
name|y
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_height
argument_list|)
expr_stmt|;
name|area
operator|->
name|x2
operator|=
name|CLAMP
argument_list|(
name|x
operator|+
name|w
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_width
argument_list|)
expr_stmt|;
name|area
operator|->
name|y2
operator|=
name|CLAMP
argument_list|(
name|y
operator|+
name|h
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_height
argument_list|)
expr_stmt|;
name|shell
operator|->
name|display_areas
operator|=
name|gimp_display_area_list_process
argument_list|(
name|shell
operator|->
name|display_areas
argument_list|,
name|area
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_expose_guide (GimpDisplayShell * shell,GimpGuide * guide)
name|gimp_display_shell_expose_guide
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|GimpGuide
modifier|*
name|guide
parameter_list|)
block|{
name|gint
name|x
decl_stmt|;
name|gint
name|y
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|guide
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|guide
operator|->
name|position
operator|<
literal|0
condition|)
return|return;
name|gdisplay_transform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|guide
operator|->
name|position
argument_list|,
name|guide
operator|->
name|position
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|guide
operator|->
name|orientation
condition|)
block|{
case|case
name|ORIENTATION_HORIZONTAL
case|:
name|gimp_display_shell_add_expose_area
argument_list|(
name|shell
argument_list|,
literal|0
argument_list|,
name|y
argument_list|,
name|shell
operator|->
name|disp_width
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|ORIENTATION_VERTICAL
case|:
name|gimp_display_shell_add_expose_area
argument_list|(
name|shell
argument_list|,
name|x
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|shell
operator|->
name|disp_height
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_expose_full (GimpDisplayShell * shell)
name|gimp_display_shell_expose_full
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_display_shell_add_expose_area
argument_list|(
name|shell
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_width
argument_list|,
name|shell
operator|->
name|disp_height
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_flush (GimpDisplayShell * shell)
name|gimp_display_shell_flush
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shell
operator|->
name|display_areas
condition|)
block|{
name|GSList
modifier|*
name|list
decl_stmt|;
name|GimpArea
modifier|*
name|ga
decl_stmt|;
comment|/*  stop the currently active tool  */
name|tool_manager_control_active
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|gimp
argument_list|,
name|PAUSE
argument_list|,
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
for|for
control|(
name|list
operator|=
name|shell
operator|->
name|display_areas
init|;
name|list
condition|;
name|list
operator|=
name|g_slist_next
argument_list|(
name|list
argument_list|)
control|)
block|{
comment|/*  Paint the area specified by the GimpArea  */
name|ga
operator|=
operator|(
name|GimpArea
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|gimp_display_shell_display_area
argument_list|(
name|shell
argument_list|,
name|ga
operator|->
name|x1
argument_list|,
name|ga
operator|->
name|y1
argument_list|,
operator|(
name|ga
operator|->
name|x2
operator|-
name|ga
operator|->
name|x1
operator|)
argument_list|,
operator|(
name|ga
operator|->
name|y2
operator|-
name|ga
operator|->
name|y1
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*  Free the update lists  */
name|shell
operator|->
name|display_areas
operator|=
name|gimp_display_area_list_free
argument_list|(
name|shell
operator|->
name|display_areas
argument_list|)
expr_stmt|;
comment|/* draw the guides */
name|gimp_display_shell_draw_guides
argument_list|(
name|shell
argument_list|)
expr_stmt|;
comment|/* and the cursor (if we have a software cursor */
if|if
condition|(
name|shell
operator|->
name|have_cursor
condition|)
name|gimp_display_shell_draw_cursor
argument_list|(
name|shell
argument_list|)
expr_stmt|;
comment|/* restart (and recalculate) the selection boundaries */
name|selection_start
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|select
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* start the currently active tool */
name|tool_manager_control_active
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|gimp
argument_list|,
name|RESUME
argument_list|,
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_real_install_tool_cursor (GimpDisplayShell * shell,GdkCursorType cursor_type,GimpToolCursorType tool_cursor,GimpCursorModifier modifier,gboolean always_install)
name|gimp_display_shell_real_install_tool_cursor
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|GdkCursorType
name|cursor_type
parameter_list|,
name|GimpToolCursorType
name|tool_cursor
parameter_list|,
name|GimpCursorModifier
name|modifier
parameter_list|,
name|gboolean
name|always_install
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cursor_type
operator|!=
name|GIMP_BAD_CURSOR
condition|)
block|{
switch|switch
condition|(
name|gimprc
operator|.
name|cursor_mode
condition|)
block|{
case|case
name|CURSOR_MODE_TOOL_ICON
case|:
break|break;
case|case
name|CURSOR_MODE_TOOL_CROSSHAIR
case|:
name|cursor_type
operator|=
name|GIMP_CROSSHAIR_SMALL_CURSOR
expr_stmt|;
break|break;
case|case
name|CURSOR_MODE_CROSSHAIR
case|:
name|cursor_type
operator|=
name|GIMP_CROSSHAIR_CURSOR
expr_stmt|;
name|tool_cursor
operator|=
name|GIMP_TOOL_CURSOR_NONE
expr_stmt|;
name|modifier
operator|=
name|GIMP_CURSOR_MODIFIER_NONE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|shell
operator|->
name|current_cursor
operator|!=
name|cursor_type
operator|||
name|shell
operator|->
name|tool_cursor
operator|!=
name|tool_cursor
operator|||
name|shell
operator|->
name|cursor_modifier
operator|!=
name|modifier
operator|||
name|always_install
condition|)
block|{
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
name|shell
operator|->
name|current_cursor
operator|=
name|cursor_type
expr_stmt|;
name|shell
operator|->
name|tool_cursor
operator|=
name|tool_cursor
expr_stmt|;
name|shell
operator|->
name|cursor_modifier
operator|=
name|modifier
expr_stmt|;
name|cursor
operator|=
name|gimp_cursor_new
argument_list|(
name|cursor_type
argument_list|,
name|tool_cursor
argument_list|,
name|modifier
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_unref
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_install_tool_cursor (GimpDisplayShell * shell,GdkCursorType cursor_type,GimpToolCursorType tool_cursor,GimpCursorModifier modifier)
name|gimp_display_shell_install_tool_cursor
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|GdkCursorType
name|cursor_type
parameter_list|,
name|GimpToolCursorType
name|tool_cursor
parameter_list|,
name|GimpCursorModifier
name|modifier
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|shell
operator|->
name|using_override_cursor
condition|)
block|{
name|gimp_display_shell_real_install_tool_cursor
argument_list|(
name|shell
argument_list|,
name|cursor_type
argument_list|,
name|tool_cursor
argument_list|,
name|modifier
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_remove_tool_cursor (GimpDisplayShell * shell)
name|gimp_display_shell_remove_tool_cursor
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_install_override_cursor (GimpDisplayShell * shell,GdkCursorType cursor_type)
name|gimp_display_shell_install_override_cursor
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|GdkCursorType
name|cursor_type
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|shell
operator|->
name|using_override_cursor
operator|||
operator|(
name|shell
operator|->
name|using_override_cursor
operator|&&
name|shell
operator|->
name|override_cursor
operator|!=
name|cursor_type
operator|)
condition|)
block|{
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
name|shell
operator|->
name|override_cursor
operator|=
name|cursor_type
expr_stmt|;
name|shell
operator|->
name|using_override_cursor
operator|=
name|TRUE
expr_stmt|;
name|cursor
operator|=
name|gimp_cursor_new
argument_list|(
name|cursor_type
argument_list|,
name|GIMP_TOOL_CURSOR_NONE
argument_list|,
name|GIMP_CURSOR_MODIFIER_NONE
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_unref
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_remove_override_cursor (GimpDisplayShell * shell)
name|gimp_display_shell_remove_override_cursor
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shell
operator|->
name|using_override_cursor
condition|)
block|{
name|shell
operator|->
name|using_override_cursor
operator|=
name|FALSE
expr_stmt|;
name|gimp_display_shell_real_install_tool_cursor
argument_list|(
name|shell
argument_list|,
name|shell
operator|->
name|current_cursor
argument_list|,
name|shell
operator|->
name|tool_cursor
argument_list|,
name|shell
operator|->
name|cursor_modifier
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_update_cursor (GimpDisplayShell * shell,gint x,gint y)
name|gimp_display_shell_update_cursor
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
name|gboolean
name|new_cursor
decl_stmt|;
name|gboolean
name|flush
init|=
name|FALSE
decl_stmt|;
name|gchar
name|buffer
index|[
name|CURSOR_STR_LENGTH
index|]
decl_stmt|;
name|gint
name|t_x
init|=
operator|-
literal|1
decl_stmt|;
name|gint
name|t_y
init|=
operator|-
literal|1
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|gimage
operator|=
name|shell
operator|->
name|gdisp
operator|->
name|gimage
expr_stmt|;
name|new_cursor
operator|=
operator|(
name|shell
operator|->
name|draw_cursor
operator|&&
name|shell
operator|->
name|proximity
operator|&&
name|x
operator|>
literal|0
operator|&&
name|y
operator|>
literal|0
operator|)
expr_stmt|;
comment|/* Erase old cursor, if necessary */
if|if
condition|(
name|shell
operator|->
name|have_cursor
operator|&&
operator|(
operator|!
name|new_cursor
operator|||
name|x
operator|!=
name|shell
operator|->
name|cursor_x
operator|||
name|y
operator|!=
name|shell
operator|->
name|cursor_y
operator|)
condition|)
block|{
name|gimp_display_shell_add_expose_area
argument_list|(
name|shell
argument_list|,
name|shell
operator|->
name|cursor_x
operator|-
literal|7
argument_list|,
name|shell
operator|->
name|cursor_y
operator|-
literal|7
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_cursor
condition|)
block|{
name|shell
operator|->
name|have_cursor
operator|=
name|FALSE
expr_stmt|;
name|flush
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
name|shell
operator|->
name|have_cursor
operator|=
name|new_cursor
expr_stmt|;
name|shell
operator|->
name|cursor_x
operator|=
name|x
expr_stmt|;
name|shell
operator|->
name|cursor_y
operator|=
name|y
expr_stmt|;
if|if
condition|(
name|new_cursor
operator|||
name|flush
condition|)
block|{
name|gdisplay_flush
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|>
literal|0
operator|&&
name|y
operator|>
literal|0
condition|)
block|{
name|gdisplay_untransform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|t_x
argument_list|,
operator|&
name|t_y
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t_x
operator|<
literal|0
operator|||
name|t_y
operator|<
literal|0
operator|||
name|t_x
operator|>=
name|gimage
operator|->
name|width
operator|||
name|t_y
operator|>=
name|gimage
operator|->
name|height
condition|)
block|{
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|shell
operator|->
name|cursor_label
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|info_window_update_extended
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|shell
operator|->
name|gdisp
operator|->
name|dot_for_dot
condition|)
block|{
name|g_snprintf
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|shell
operator|->
name|cursor_format_str
argument_list|,
literal|""
argument_list|,
name|t_x
argument_list|,
literal|", "
argument_list|,
name|t_y
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* show real world units */
block|{
name|gdouble
name|unit_factor
init|=
name|gimp_unit_get_factor
argument_list|(
name|gimage
operator|->
name|unit
argument_list|)
decl_stmt|;
name|g_snprintf
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|shell
operator|->
name|cursor_format_str
argument_list|,
literal|""
argument_list|,
operator|(
name|gdouble
operator|)
name|t_x
operator|*
name|unit_factor
operator|/
name|gimage
operator|->
name|xresolution
argument_list|,
literal|", "
argument_list|,
operator|(
name|gdouble
operator|)
name|t_y
operator|*
name|unit_factor
operator|/
name|gimage
operator|->
name|yresolution
argument_list|)
expr_stmt|;
block|}
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|shell
operator|->
name|cursor_label
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|info_window_update_extended
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|t_x
argument_list|,
name|t_y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_resize_cursor_label (GimpDisplayShell * shell)
name|gimp_display_shell_resize_cursor_label
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
specifier|static
name|PangoLayout
modifier|*
name|layout
init|=
name|NULL
decl_stmt|;
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
name|gchar
name|buffer
index|[
name|CURSOR_STR_LENGTH
index|]
decl_stmt|;
name|gint
name|cursor_label_width
decl_stmt|;
name|gint
name|label_frame_size_difference
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|gimage
operator|=
name|shell
operator|->
name|gdisp
operator|->
name|gimage
expr_stmt|;
if|if
condition|(
name|shell
operator|->
name|gdisp
operator|->
name|dot_for_dot
condition|)
block|{
name|g_snprintf
argument_list|(
name|shell
operator|->
name|cursor_format_str
argument_list|,
sizeof|sizeof
argument_list|(
name|shell
operator|->
name|cursor_format_str
argument_list|)
argument_list|,
literal|"%%s%%d%%s%%d"
argument_list|)
expr_stmt|;
name|g_snprintf
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|shell
operator|->
name|cursor_format_str
argument_list|,
literal|""
argument_list|,
name|gimage
operator|->
name|width
argument_list|,
literal|", "
argument_list|,
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* show real world units */
block|{
name|gdouble
name|unit_factor
init|=
name|gimp_unit_get_factor
argument_list|(
name|gimage
operator|->
name|unit
argument_list|)
decl_stmt|;
name|g_snprintf
argument_list|(
name|shell
operator|->
name|cursor_format_str
argument_list|,
sizeof|sizeof
argument_list|(
name|shell
operator|->
name|cursor_format_str
argument_list|)
argument_list|,
literal|"%%s%%.%df%%s%%.%df %s"
argument_list|,
name|gimp_unit_get_digits
argument_list|(
name|gimage
operator|->
name|unit
argument_list|)
argument_list|,
name|gimp_unit_get_digits
argument_list|(
name|gimage
operator|->
name|unit
argument_list|)
argument_list|,
name|gimp_unit_get_symbol
argument_list|(
name|gimage
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
name|g_snprintf
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|shell
operator|->
name|cursor_format_str
argument_list|,
literal|""
argument_list|,
operator|(
name|gdouble
operator|)
name|gimage
operator|->
name|width
operator|*
name|unit_factor
operator|/
name|gimage
operator|->
name|xresolution
argument_list|,
literal|", "
argument_list|,
operator|(
name|gdouble
operator|)
name|gimage
operator|->
name|height
operator|*
name|unit_factor
operator|/
name|gimage
operator|->
name|yresolution
argument_list|)
expr_stmt|;
block|}
comment|/* one static layout for all displays should be fine */
if|if
condition|(
operator|!
name|layout
condition|)
name|layout
operator|=
name|gtk_widget_create_pango_layout
argument_list|(
name|shell
operator|->
name|cursor_label
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
else|else
name|pango_layout_set_text
argument_list|(
name|layout
argument_list|,
name|buffer
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|pango_layout_get_pixel_size
argument_list|(
name|layout
argument_list|,
operator|&
name|cursor_label_width
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  find out how many pixels the label's parent frame is bigger than    *  the label itself    */
name|label_frame_size_difference
operator|=
name|shell
operator|->
name|cursor_label
operator|->
name|parent
operator|->
name|allocation
operator|.
name|width
operator|-
name|shell
operator|->
name|cursor_label
operator|->
name|allocation
operator|.
name|width
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|shell
operator|->
name|cursor_label
argument_list|,
name|cursor_label_width
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* don't resize if this is a new display */
if|if
condition|(
name|label_frame_size_difference
condition|)
name|gtk_widget_set_usize
argument_list|(
name|shell
operator|->
name|cursor_label
operator|->
name|parent
argument_list|,
name|cursor_label_width
operator|+
name|label_frame_size_difference
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gimp_display_shell_update_cursor
argument_list|(
name|shell
argument_list|,
name|shell
operator|->
name|cursor_x
argument_list|,
name|shell
operator|->
name|cursor_y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_update_title (GimpDisplayShell * shell)
name|gimp_display_shell_update_title
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|gchar
name|title
index|[
name|MAX_TITLE_BUF
index|]
decl_stmt|;
name|guint
name|context_id
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
comment|/* format the title */
name|gimp_display_shell_format_title
argument_list|(
name|shell
argument_list|,
name|title
argument_list|,
name|MAX_TITLE_BUF
argument_list|)
expr_stmt|;
name|gdk_window_set_title
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
name|title
argument_list|)
expr_stmt|;
comment|/* update the statusbar */
name|context_id
operator|=
name|gtk_statusbar_get_context_id
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|shell
operator|->
name|statusbar
argument_list|)
argument_list|,
literal|"title"
argument_list|)
expr_stmt|;
name|gtk_statusbar_pop
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|shell
operator|->
name|statusbar
argument_list|)
argument_list|,
name|context_id
argument_list|)
expr_stmt|;
name|gtk_statusbar_push
argument_list|(
name|GTK_STATUSBAR
argument_list|(
name|shell
operator|->
name|statusbar
argument_list|)
argument_list|,
name|context_id
argument_list|,
name|title
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_draw_guide (GimpDisplayShell * shell,GimpGuide * guide,gboolean active)
name|gimp_display_shell_draw_guide
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|GimpGuide
modifier|*
name|guide
parameter_list|,
name|gboolean
name|active
parameter_list|)
block|{
specifier|static
name|GdkGC
modifier|*
name|normal_hgc
init|=
name|NULL
decl_stmt|;
specifier|static
name|GdkGC
modifier|*
name|active_hgc
init|=
name|NULL
decl_stmt|;
specifier|static
name|GdkGC
modifier|*
name|normal_vgc
init|=
name|NULL
decl_stmt|;
specifier|static
name|GdkGC
modifier|*
name|active_vgc
init|=
name|NULL
decl_stmt|;
specifier|static
name|gboolean
name|initialize
init|=
name|TRUE
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|x2
decl_stmt|;
name|gint
name|y1
decl_stmt|,
name|y2
decl_stmt|;
name|gint
name|w
decl_stmt|,
name|h
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|guide
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|guide
operator|->
name|position
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
name|initialize
condition|)
block|{
name|GdkGCValues
name|values
decl_stmt|;
specifier|const
name|char
name|stipple
index|[]
init|=
block|{
literal|0xF0
block|,
comment|/*  ####----  */
literal|0xE1
block|,
comment|/*  ###----#  */
literal|0xC3
block|,
comment|/*  ##----##  */
literal|0x87
block|,
comment|/*  #----###  */
literal|0x0F
block|,
comment|/*  ----####  */
literal|0x1E
block|,
comment|/*  ---####-  */
literal|0x3C
block|,
comment|/*  --####--  */
literal|0x78
block|,
comment|/*  -####---  */
block|}
decl_stmt|;
name|initialize
operator|=
name|FALSE
expr_stmt|;
name|values
operator|.
name|foreground
operator|.
name|pixel
operator|=
name|g_black_pixel
expr_stmt|;
name|values
operator|.
name|background
operator|.
name|pixel
operator|=
name|g_normal_guide_pixel
expr_stmt|;
name|values
operator|.
name|fill
operator|=
name|GDK_OPAQUE_STIPPLED
expr_stmt|;
name|values
operator|.
name|stipple
operator|=
name|gdk_bitmap_create_from_data
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
operator|(
name|gchar
operator|*
operator|)
name|stipple
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|normal_hgc
operator|=
name|gdk_gc_new_with_values
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
operator|&
name|values
argument_list|,
name|GDK_GC_FOREGROUND
operator||
name|GDK_GC_BACKGROUND
operator||
name|GDK_GC_FILL
operator||
name|GDK_GC_STIPPLE
argument_list|)
expr_stmt|;
name|values
operator|.
name|background
operator|.
name|pixel
operator|=
name|g_active_guide_pixel
expr_stmt|;
name|active_hgc
operator|=
name|gdk_gc_new_with_values
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
operator|&
name|values
argument_list|,
name|GDK_GC_FOREGROUND
operator||
name|GDK_GC_BACKGROUND
operator||
name|GDK_GC_FILL
operator||
name|GDK_GC_STIPPLE
argument_list|)
expr_stmt|;
name|values
operator|.
name|foreground
operator|.
name|pixel
operator|=
name|g_black_pixel
expr_stmt|;
name|values
operator|.
name|background
operator|.
name|pixel
operator|=
name|g_normal_guide_pixel
expr_stmt|;
name|values
operator|.
name|fill
operator|=
name|GDK_OPAQUE_STIPPLED
expr_stmt|;
name|values
operator|.
name|stipple
operator|=
name|gdk_bitmap_create_from_data
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
operator|(
name|gchar
operator|*
operator|)
name|stipple
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|normal_vgc
operator|=
name|gdk_gc_new_with_values
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
operator|&
name|values
argument_list|,
name|GDK_GC_FOREGROUND
operator||
name|GDK_GC_BACKGROUND
operator||
name|GDK_GC_FILL
operator||
name|GDK_GC_STIPPLE
argument_list|)
expr_stmt|;
name|values
operator|.
name|background
operator|.
name|pixel
operator|=
name|g_active_guide_pixel
expr_stmt|;
name|active_vgc
operator|=
name|gdk_gc_new_with_values
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
operator|&
name|values
argument_list|,
name|GDK_GC_FOREGROUND
operator||
name|GDK_GC_BACKGROUND
operator||
name|GDK_GC_FILL
operator||
name|GDK_GC_STIPPLE
argument_list|)
expr_stmt|;
block|}
name|gdisplay_transform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gdisplay_transform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|,
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gdk_drawable_get_size
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|x1
operator|<
literal|0
condition|)
name|x1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|y1
operator|<
literal|0
condition|)
name|y1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|x2
operator|>
name|w
condition|)
name|x2
operator|=
name|w
expr_stmt|;
if|if
condition|(
name|y2
operator|>
name|h
condition|)
name|y2
operator|=
name|h
expr_stmt|;
if|if
condition|(
name|guide
operator|->
name|orientation
operator|==
name|ORIENTATION_HORIZONTAL
condition|)
block|{
name|gdisplay_transform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
literal|0
argument_list|,
name|guide
operator|->
name|position
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|active
condition|)
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|active_hgc
argument_list|,
name|x1
argument_list|,
name|y
argument_list|,
name|x2
argument_list|,
name|y
argument_list|)
expr_stmt|;
else|else
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|normal_hgc
argument_list|,
name|x1
argument_list|,
name|y
argument_list|,
name|x2
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|guide
operator|->
name|orientation
operator|==
name|ORIENTATION_VERTICAL
condition|)
block|{
name|gdisplay_transform_coords
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|guide
operator|->
name|position
argument_list|,
literal|0
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|active
condition|)
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|active_vgc
argument_list|,
name|x
argument_list|,
name|y1
argument_list|,
name|x
argument_list|,
name|y2
argument_list|)
expr_stmt|;
else|else
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|normal_vgc
argument_list|,
name|x
argument_list|,
name|y1
argument_list|,
name|x
argument_list|,
name|y2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_draw_guides (GimpDisplayShell * shell)
name|gimp_display_shell_draw_guides
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shell
operator|->
name|gdisp
operator|->
name|draw_guides
condition|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|GimpGuide
modifier|*
name|guide
decl_stmt|;
for|for
control|(
name|list
operator|=
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|guides
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|guide
operator|=
operator|(
name|GimpGuide
operator|*
operator|)
name|list
operator|->
name|data
expr_stmt|;
name|gimp_display_shell_draw_guide
argument_list|(
name|shell
argument_list|,
name|guide
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
DECL|function|gimp_display_shell_shrink_wrap (GimpDisplayShell * shell)
name|gimp_display_shell_shrink_wrap
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
comment|/*     * I'm pretty sure this assumes that the current size is< display size    * Is this a valid assumption?     */
name|GtkAllocation
name|allocation
decl_stmt|;
name|gint
name|disp_width
decl_stmt|,
name|disp_height
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gint
name|shell_x
decl_stmt|,
name|shell_y
decl_stmt|;
name|gint
name|shell_width
decl_stmt|,
name|shell_height
decl_stmt|;
name|gint
name|max_auto_width
decl_stmt|,
name|max_auto_height
decl_stmt|;
name|gint
name|border_x
decl_stmt|,
name|border_y
decl_stmt|;
name|gint
name|s_width
decl_stmt|,
name|s_height
decl_stmt|;
name|gboolean
name|resize
init|=
name|FALSE
decl_stmt|;
name|s_width
operator|=
name|gdk_screen_width
argument_list|()
expr_stmt|;
name|s_height
operator|=
name|gdk_screen_height
argument_list|()
expr_stmt|;
name|width
operator|=
name|SCALEX
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|height
operator|=
name|SCALEY
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
name|disp_width
operator|=
name|shell
operator|->
name|disp_width
expr_stmt|;
name|disp_height
operator|=
name|shell
operator|->
name|disp_height
expr_stmt|;
name|shell_width
operator|=
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|allocation
operator|.
name|width
expr_stmt|;
name|shell_height
operator|=
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|allocation
operator|.
name|height
expr_stmt|;
name|border_x
operator|=
name|shell_width
operator|-
name|disp_width
expr_stmt|;
name|border_y
operator|=
name|shell_height
operator|-
name|disp_height
expr_stmt|;
name|max_auto_width
operator|=
operator|(
name|s_width
operator|-
name|border_x
operator|)
operator|*
literal|0.75
expr_stmt|;
name|max_auto_height
operator|=
operator|(
name|s_height
operator|-
name|border_y
operator|)
operator|*
literal|0.75
expr_stmt|;
name|allocation
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|allocation
operator|.
name|y
operator|=
literal|0
expr_stmt|;
comment|/* If one of the display dimensions has changed and one of the    * dimensions fits inside the screen    */
if|if
condition|(
operator|(
operator|(
name|width
operator|+
name|border_x
operator|)
operator|<
name|s_width
operator|||
operator|(
name|height
operator|+
name|border_y
operator|)
operator|<
name|s_height
operator|)
operator|&&
operator|(
name|width
operator|!=
name|disp_width
operator|||
name|height
operator|!=
name|disp_height
operator|)
condition|)
block|{
name|width
operator|=
operator|(
operator|(
name|width
operator|+
name|border_x
operator|)
operator|<
name|s_width
operator|)
condition|?
name|width
else|:
name|max_auto_width
expr_stmt|;
name|height
operator|=
operator|(
operator|(
name|height
operator|+
name|border_y
operator|)
operator|<
name|s_height
operator|)
condition|?
name|height
else|:
name|max_auto_height
expr_stmt|;
name|resize
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/*  If the projected dimension is greater than current, but less than    *  3/4 of the screen size, expand automagically    */
elseif|else
if|if
condition|(
operator|(
name|width
operator|>
name|disp_width
operator|||
name|height
operator|>
name|disp_height
operator|)
operator|&&
operator|(
name|disp_width
operator|<
name|max_auto_width
operator|||
name|disp_height
operator|<
name|max_auto_height
operator|)
condition|)
block|{
name|width
operator|=
name|MIN
argument_list|(
name|max_auto_width
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|height
operator|=
name|MIN
argument_list|(
name|max_auto_height
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|resize
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|resize
condition|)
block|{
if|if
condition|(
name|width
operator|<
name|shell
operator|->
name|statusarea
operator|->
name|requisition
operator|.
name|width
condition|)
block|{
name|width
operator|=
name|shell
operator|->
name|statusarea
operator|->
name|requisition
operator|.
name|width
expr_stmt|;
block|}
undef|#
directive|undef
name|RESIZE_DEBUG
ifdef|#
directive|ifdef
name|RESIZE_DEBUG
name|g_print
argument_list|(
literal|"1w:%d/%d d:%d/%d s:%d/%d b:%d/%d\n"
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|disp_width
argument_list|,
name|disp_height
argument_list|,
name|shell_width
argument_list|,
name|shell_height
argument_list|,
name|border_x
argument_list|,
name|border_y
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* RESIZE_DEBUG */
name|shell
operator|->
name|disp_width
operator|=
name|width
expr_stmt|;
name|shell
operator|->
name|disp_height
operator|=
name|height
expr_stmt|;
name|allocation
operator|.
name|width
operator|=
name|width
operator|+
name|border_x
expr_stmt|;
name|allocation
operator|.
name|height
operator|=
name|height
operator|+
name|border_y
expr_stmt|;
comment|/*  don't call gdisplay_canvas_events() on any of the following        *  changes because our caller has to do a full display update anyway        */
name|g_signal_handlers_block_by_func
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|,
name|gimp_display_shell_events
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|g_signal_handlers_block_by_func
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|,
name|gimp_display_shell_canvas_events
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|gtk_widget_size_allocate
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|,
operator|&
name|allocation
argument_list|)
expr_stmt|;
name|gdk_window_resize
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
name|allocation
operator|.
name|width
argument_list|,
name|allocation
operator|.
name|height
argument_list|)
expr_stmt|;
comment|/*  let Gtk/X/WM position the window  */
while|while
condition|(
name|gtk_events_pending
argument_list|()
condition|)
name|gtk_main_iteration
argument_list|()
expr_stmt|;
name|gdk_window_get_origin
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
operator|&
name|shell_x
argument_list|,
operator|&
name|shell_y
argument_list|)
expr_stmt|;
comment|/*  if the window is offscreen, center it...  */
if|if
condition|(
name|shell_x
operator|>
name|s_width
operator|||
name|shell_y
operator|>
name|s_height
operator|||
operator|(
name|shell_x
operator|+
name|width
operator|+
name|border_x
operator|)
operator|<
literal|0
operator|||
operator|(
name|shell_y
operator|+
name|height
operator|+
name|border_y
operator|)
operator|<
literal|0
condition|)
block|{
name|shell_x
operator|=
operator|(
name|s_width
operator|-
name|width
operator|-
name|border_x
operator|)
operator|>>
literal|1
expr_stmt|;
name|shell_y
operator|=
operator|(
name|s_height
operator|-
name|height
operator|-
name|border_y
operator|)
operator|>>
literal|1
expr_stmt|;
name|gdk_window_move
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
name|shell_x
argument_list|,
name|shell_y
argument_list|)
expr_stmt|;
block|}
name|g_signal_handlers_unblock_by_func
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|,
name|gimp_display_shell_events
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|g_signal_handlers_unblock_by_func
argument_list|(
name|G_OBJECT
argument_list|(
name|shell
operator|->
name|canvas
argument_list|)
argument_list|,
name|gimp_display_shell_canvas_events
argument_list|,
name|shell
argument_list|)
expr_stmt|;
block|}
comment|/*  If the width or height of the display has changed, recalculate    *  the display offsets...    */
if|if
condition|(
name|disp_width
operator|!=
name|shell
operator|->
name|disp_width
operator|||
name|disp_height
operator|!=
name|shell
operator|->
name|disp_height
condition|)
block|{
name|shell
operator|->
name|offset_x
operator|+=
operator|(
name|disp_width
operator|-
name|shell
operator|->
name|disp_width
operator|)
operator|/
literal|2
expr_stmt|;
name|shell
operator|->
name|offset_y
operator|+=
operator|(
name|disp_height
operator|-
name|shell
operator|->
name|disp_height
operator|)
operator|/
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  private functions  */
end_comment

begin_function
specifier|static
name|gpointer
DECL|function|gimp_display_shell_get_accel_context (gpointer data)
name|gimp_display_shell_get_accel_context
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|shell
operator|=
operator|(
name|GimpDisplayShell
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|shell
condition|)
return|return
name|shell
operator|->
name|gdisp
operator|->
name|gimage
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_display_area (GimpDisplayShell * shell,gint x,gint y,gint w,gint h)
name|gimp_display_shell_display_area
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|)
block|{
name|gint
name|sx
decl_stmt|,
name|sy
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|;
name|gint
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gint
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
ifdef|#
directive|ifdef
name|DISPLAY_FILTERS
name|guchar
modifier|*
name|buf
decl_stmt|;
name|gint
name|bpp
decl_stmt|,
name|bpl
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|buf
operator|=
name|gximage_get_data
argument_list|()
expr_stmt|;
name|bpp
operator|=
name|gximage_get_bpp
argument_list|()
expr_stmt|;
name|bpl
operator|=
name|gximage_get_bpl
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* DISPLAY_FILTERS */
name|sx
operator|=
name|SCALEX
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|width
argument_list|)
expr_stmt|;
name|sy
operator|=
name|SCALEY
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|shell
operator|->
name|gdisp
operator|->
name|gimage
operator|->
name|height
argument_list|)
expr_stmt|;
comment|/*  Bounds check  */
name|x1
operator|=
name|CLAMP
argument_list|(
name|x
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_width
argument_list|)
expr_stmt|;
name|y1
operator|=
name|CLAMP
argument_list|(
name|y
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_height
argument_list|)
expr_stmt|;
name|x2
operator|=
name|CLAMP
argument_list|(
name|x
operator|+
name|w
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_width
argument_list|)
expr_stmt|;
name|y2
operator|=
name|CLAMP
argument_list|(
name|y
operator|+
name|h
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|disp_height
argument_list|)
expr_stmt|;
if|if
condition|(
name|y1
operator|<
name|shell
operator|->
name|disp_yoffset
condition|)
block|{
name|gdk_draw_rectangle
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|TRUE
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|shell
operator|->
name|disp_yoffset
operator|-
name|y
argument_list|)
expr_stmt|;
comment|/* X X X          . # .          . . . */
name|y1
operator|=
name|shell
operator|->
name|disp_yoffset
expr_stmt|;
block|}
if|if
condition|(
name|x1
operator|<
name|shell
operator|->
name|disp_xoffset
condition|)
block|{
name|gdk_draw_rectangle
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|TRUE
argument_list|,
name|x
argument_list|,
name|y1
argument_list|,
name|shell
operator|->
name|disp_xoffset
operator|-
name|x
argument_list|,
name|h
argument_list|)
expr_stmt|;
comment|/* . . .          X # .          X . . */
name|x1
operator|=
name|shell
operator|->
name|disp_xoffset
expr_stmt|;
block|}
if|if
condition|(
name|x2
operator|>
operator|(
name|shell
operator|->
name|disp_xoffset
operator|+
name|sx
operator|)
condition|)
block|{
name|gdk_draw_rectangle
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|TRUE
argument_list|,
name|shell
operator|->
name|disp_xoffset
operator|+
name|sx
argument_list|,
name|y1
argument_list|,
name|x2
operator|-
operator|(
name|shell
operator|->
name|disp_xoffset
operator|+
name|sx
operator|)
argument_list|,
name|h
operator|-
operator|(
name|y1
operator|-
name|y
operator|)
argument_list|)
expr_stmt|;
comment|/* . . .          . # X          . . X */
name|x2
operator|=
name|shell
operator|->
name|disp_xoffset
operator|+
name|sx
expr_stmt|;
block|}
if|if
condition|(
name|y2
operator|>
operator|(
name|shell
operator|->
name|disp_yoffset
operator|+
name|sy
operator|)
condition|)
block|{
name|gdk_draw_rectangle
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|bg_gc
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|TRUE
argument_list|,
name|x1
argument_list|,
name|shell
operator|->
name|disp_yoffset
operator|+
name|sy
argument_list|,
name|x2
operator|-
name|x1
argument_list|,
name|y2
operator|-
operator|(
name|shell
operator|->
name|disp_yoffset
operator|+
name|sy
operator|)
argument_list|)
expr_stmt|;
comment|/* . . .          . # .          . X . */
name|y2
operator|=
name|shell
operator|->
name|disp_yoffset
operator|+
name|sy
expr_stmt|;
block|}
comment|/*  display the image in GXIMAGE_WIDTH x GXIMAGE_HEIGHT sized chunks */
for|for
control|(
name|i
operator|=
name|y1
init|;
name|i
operator|<
name|y2
condition|;
name|i
operator|+=
name|GXIMAGE_HEIGHT
control|)
block|{
for|for
control|(
name|j
operator|=
name|x1
init|;
name|j
operator|<
name|x2
condition|;
name|j
operator|+=
name|GXIMAGE_WIDTH
control|)
block|{
name|dx
operator|=
name|MIN
argument_list|(
name|x2
operator|-
name|j
argument_list|,
name|GXIMAGE_WIDTH
argument_list|)
expr_stmt|;
name|dy
operator|=
name|MIN
argument_list|(
name|y2
operator|-
name|i
argument_list|,
name|GXIMAGE_HEIGHT
argument_list|)
expr_stmt|;
name|render_image
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|,
name|j
operator|-
name|shell
operator|->
name|disp_xoffset
argument_list|,
name|i
operator|-
name|shell
operator|->
name|disp_yoffset
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* Invalidate the projection just after we render it! */
block|gimp_image_invalidate_without_render (shell->gdisp->gimage,                                                 j - shell->disp_xoffset,                                                 i - shell->disp_yoffset,                                                 dx, dy,                                                 0, 0, 0, 0);
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DISPLAY_FILTERS
for|for
control|(
name|list
operator|=
name|shell
operator|->
name|cd_list
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|ColorDisplayNode
modifier|*
name|node
init|=
operator|(
name|ColorDisplayNode
operator|*
operator|)
name|list
operator|->
name|data
decl_stmt|;
name|node
operator|->
name|cd_convert
argument_list|(
name|node
operator|->
name|cd_ID
argument_list|,
name|buf
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|bpp
argument_list|,
name|bpl
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* DISPLAY_FILTERS */
name|gximage_put
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|shell
operator|->
name|offset_x
argument_list|,
name|shell
operator|->
name|offset_y
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_draw_cursor (GimpDisplayShell * shell)
name|gimp_display_shell_draw_cursor
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|x
operator|=
name|shell
operator|->
name|cursor_x
expr_stmt|;
name|y
operator|=
name|shell
operator|->
name|cursor_y
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|white_gc
argument_list|,
name|x
operator|-
literal|7
argument_list|,
name|y
operator|-
literal|1
argument_list|,
name|x
operator|+
literal|7
argument_list|,
name|y
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|x
operator|-
literal|7
argument_list|,
name|y
argument_list|,
name|x
operator|+
literal|7
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|white_gc
argument_list|,
name|x
operator|-
literal|7
argument_list|,
name|y
operator|+
literal|1
argument_list|,
name|x
operator|+
literal|7
argument_list|,
name|y
operator|+
literal|1
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|white_gc
argument_list|,
name|x
operator|-
literal|1
argument_list|,
name|y
operator|-
literal|7
argument_list|,
name|x
operator|-
literal|1
argument_list|,
name|y
operator|+
literal|7
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|x
argument_list|,
name|y
operator|-
literal|7
argument_list|,
name|x
argument_list|,
name|y
operator|+
literal|7
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|shell
operator|->
name|canvas
operator|->
name|window
argument_list|,
name|shell
operator|->
name|canvas
operator|->
name|style
operator|->
name|white_gc
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
operator|-
literal|7
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
operator|+
literal|7
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_update_icon (GimpDisplayShell * shell)
name|gimp_display_shell_update_icon
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|)
block|{
specifier|static
name|GdkPixmap
modifier|*
name|wilber_pixmap
init|=
name|NULL
decl_stmt|;
specifier|static
name|GdkBitmap
modifier|*
name|wilber_mask
init|=
name|NULL
decl_stmt|;
name|GtkStyle
modifier|*
name|style
decl_stmt|;
name|GdkGC
modifier|*
name|icongc
decl_stmt|,
modifier|*
name|iconmaskgc
decl_stmt|;
name|GdkColormap
modifier|*
name|colormap
decl_stmt|;
name|GdkColor
name|black
decl_stmt|,
name|white
decl_stmt|;
name|gboolean
name|success
decl_stmt|;
name|TempBuf
modifier|*
name|icondata
decl_stmt|;
name|guchar
modifier|*
name|data
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gdouble
name|factor
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|shell
operator|->
name|icon
condition|)
block|{
name|shell
operator|->
name|icon
operator|=
name|gdk_pixmap_new
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
name|shell
operator|->
name|iconsize
argument_list|,
name|shell
operator|->
name|iconsize
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|shell
operator|->
name|iconmask
operator|=
name|gdk_pixmap_new
argument_list|(
name|NULL
argument_list|,
name|shell
operator|->
name|iconsize
argument_list|,
name|shell
operator|->
name|iconsize
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|icongc
operator|=
name|gdk_gc_new
argument_list|(
name|shell
operator|->
name|icon
argument_list|)
expr_stmt|;
name|iconmaskgc
operator|=
name|gdk_gc_new
argument_list|(
name|shell
operator|->
name|iconmask
argument_list|)
expr_stmt|;
name|colormap
operator|=
name|gdk_colormap_get_system
argument_list|()
expr_stmt|;
comment|/* or gdk_rgb_get_colormap ()  */
name|white
operator|.
name|red
operator|=
literal|255
expr_stmt|;
name|white
operator|.
name|green
operator|=
literal|255
expr_stmt|;
name|white
operator|.
name|blue
operator|=
literal|255
expr_stmt|;
name|gdk_colormap_alloc_colors
argument_list|(
name|colormap
argument_list|,
operator|&
name|white
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|success
argument_list|)
expr_stmt|;
name|black
operator|.
name|red
operator|=
literal|0
expr_stmt|;
name|black
operator|.
name|green
operator|=
literal|0
expr_stmt|;
name|black
operator|.
name|blue
operator|=
literal|0
expr_stmt|;
name|gdk_colormap_alloc_colors
argument_list|(
name|colormap
argument_list|,
operator|&
name|black
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|success
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|shell
operator|->
name|icon_needs_update
condition|)
return|return;
name|style
operator|=
name|gtk_widget_get_style
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wilber_pixmap
condition|)
block|{
name|wilber_pixmap
operator|=
name|gdk_pixmap_create_from_xpm_d
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
operator|&
name|wilber_mask
argument_list|,
operator|&
name|style
operator|->
name|bg
index|[
name|GTK_STATE_NORMAL
index|]
argument_list|,
name|wilber_xpm
argument_list|)
expr_stmt|;
block|}
name|factor
operator|=
operator|(
operator|(
name|gfloat
operator|)
name|gimp_image_get_height
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|)
operator|)
operator|/
name|gimp_image_get_width
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|)
expr_stmt|;
if|if
condition|(
name|factor
operator|>=
literal|1
condition|)
block|{
name|height
operator|=
name|MAX
argument_list|(
name|shell
operator|->
name|iconsize
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|width
operator|=
name|MAX
argument_list|(
operator|(
operator|(
name|gfloat
operator|)
name|shell
operator|->
name|iconsize
operator|)
operator|/
name|factor
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|height
operator|=
name|MAX
argument_list|(
operator|(
operator|(
name|gfloat
operator|)
name|shell
operator|->
name|iconsize
operator|)
operator|*
name|factor
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|width
operator|=
name|MAX
argument_list|(
name|shell
operator|->
name|iconsize
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|icondata
operator|=
name|gimp_viewable_get_new_preview
argument_list|(
name|GIMP_VIEWABLE
argument_list|(
name|shell
operator|->
name|gdisp
operator|->
name|gimage
argument_list|)
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|data
operator|=
name|temp_buf_data
argument_list|(
name|icondata
argument_list|)
expr_stmt|;
comment|/* Set up an icon mask */
name|gdk_gc_set_foreground
argument_list|(
name|iconmaskgc
argument_list|,
operator|&
name|black
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|shell
operator|->
name|iconmask
argument_list|,
name|iconmaskgc
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|shell
operator|->
name|iconsize
argument_list|,
name|shell
operator|->
name|iconsize
argument_list|)
expr_stmt|;
name|gdk_gc_set_foreground
argument_list|(
name|iconmaskgc
argument_list|,
operator|&
name|white
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|shell
operator|->
name|iconmask
argument_list|,
name|iconmaskgc
argument_list|,
name|TRUE
argument_list|,
operator|(
name|shell
operator|->
name|iconsize
operator|-
name|icondata
operator|->
name|width
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|shell
operator|->
name|iconsize
operator|-
name|icondata
operator|->
name|height
operator|)
operator|/
literal|2
argument_list|,
name|icondata
operator|->
name|width
argument_list|,
name|icondata
operator|->
name|height
argument_list|)
expr_stmt|;
comment|/* This is an ugly bad hack. There should be a clean way to get    * a preview in a specified depth with a nicely rendered    * checkerboard if no alpha channel is requested.    * We ignore the alpha channel for now. Also the aspect ratio is    * incorrect.    *    * Currently the icons are updated when you press the "menu" button in    * the top left corner of the window. Of course this should go in an    * idle routine.    */
if|if
condition|(
name|icondata
operator|->
name|bytes
operator|==
literal|1
condition|)
block|{
name|gdk_draw_gray_image
argument_list|(
name|shell
operator|->
name|icon
argument_list|,
name|icongc
argument_list|,
operator|(
name|shell
operator|->
name|iconsize
operator|-
name|icondata
operator|->
name|width
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|shell
operator|->
name|iconsize
operator|-
name|icondata
operator|->
name|height
operator|)
operator|/
literal|2
argument_list|,
name|icondata
operator|->
name|width
argument_list|,
name|icondata
operator|->
name|height
argument_list|,
name|GDK_RGB_DITHER_MAX
argument_list|,
name|data
argument_list|,
name|icondata
operator|->
name|width
operator|*
name|icondata
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|gdk_window_set_icon
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
name|NULL
argument_list|,
name|shell
operator|->
name|icon
argument_list|,
name|shell
operator|->
name|iconmask
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|icondata
operator|->
name|bytes
operator|==
literal|3
condition|)
block|{
name|gdk_draw_rgb_image
argument_list|(
name|shell
operator|->
name|icon
argument_list|,
name|icongc
argument_list|,
operator|(
name|shell
operator|->
name|iconsize
operator|-
name|icondata
operator|->
name|width
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|shell
operator|->
name|iconsize
operator|-
name|icondata
operator|->
name|height
operator|)
operator|/
literal|2
argument_list|,
name|icondata
operator|->
name|width
argument_list|,
name|icondata
operator|->
name|height
argument_list|,
name|GDK_RGB_DITHER_MAX
argument_list|,
name|data
argument_list|,
name|icondata
operator|->
name|width
operator|*
name|icondata
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|gdk_window_set_icon
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
name|NULL
argument_list|,
name|shell
operator|->
name|icon
argument_list|,
name|shell
operator|->
name|iconmask
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|icondata
operator|->
name|bytes
operator|==
literal|4
condition|)
block|{
name|gdk_draw_rgb_32_image
argument_list|(
name|shell
operator|->
name|icon
argument_list|,
name|icongc
argument_list|,
operator|(
name|shell
operator|->
name|iconsize
operator|-
name|icondata
operator|->
name|width
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|shell
operator|->
name|iconsize
operator|-
name|icondata
operator|->
name|height
operator|)
operator|/
literal|2
argument_list|,
name|icondata
operator|->
name|width
argument_list|,
name|icondata
operator|->
name|height
argument_list|,
name|GDK_RGB_DITHER_MAX
argument_list|,
name|data
argument_list|,
name|icondata
operator|->
name|width
operator|*
name|icondata
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|gdk_window_set_icon
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
name|NULL
argument_list|,
name|shell
operator|->
name|icon
argument_list|,
name|shell
operator|->
name|iconmask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|g_printerr
argument_list|(
literal|"gimp_display_shell_update_icon: falling back to default\n"
argument_list|)
expr_stmt|;
name|gdk_window_set_icon
argument_list|(
name|GTK_WIDGET
argument_list|(
name|shell
argument_list|)
operator|->
name|window
argument_list|,
name|NULL
argument_list|,
name|wilber_pixmap
argument_list|,
name|wilber_mask
argument_list|)
expr_stmt|;
block|}
name|shell
operator|->
name|icon_needs_update
operator|=
name|FALSE
expr_stmt|;
name|gdk_gc_unref
argument_list|(
name|icongc
argument_list|)
expr_stmt|;
name|gdk_gc_unref
argument_list|(
name|iconmaskgc
argument_list|)
expr_stmt|;
name|temp_buf_free
argument_list|(
name|icondata
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* this timer is necessary to check if the icon is invalid and if yes  * adds the update function to the idle loop  */
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|gimp_display_shell_update_icon_timer (gpointer data)
name|gimp_display_shell_update_icon_timer
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|shell
operator|=
name|GIMP_DISPLAY_SHELL
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|shell
operator|->
name|icon_needs_update
operator|&&
operator|!
name|shell
operator|->
name|icon_idle_id
condition|)
name|shell
operator|->
name|icon_idle_id
operator|=
name|g_idle_add
argument_list|(
name|gimp_display_shell_update_icon_invoker
argument_list|,
name|shell
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Just a dumb invoker for gdisplay_update_icon ()  */
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|gimp_display_shell_update_icon_invoker (gpointer data)
name|gimp_display_shell_update_icon_invoker
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|shell
operator|=
name|GIMP_DISPLAY_SHELL
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|gimp_display_shell_update_icon
argument_list|(
name|shell
argument_list|)
expr_stmt|;
name|shell
operator|->
name|icon_idle_id
operator|=
literal|0
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/* This function marks the icon as invalid and sets up the infrastructure  * to check every 8 seconds if an update is necessary.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_update_icon_scheduler (GimpImage * gimage,gpointer data)
name|gimp_display_shell_update_icon_scheduler
parameter_list|(
name|GimpImage
modifier|*
name|gimage
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|shell
operator|=
name|GIMP_DISPLAY_SHELL
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|shell
operator|->
name|icon_needs_update
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|shell
operator|->
name|icon_timeout_id
condition|)
block|{
name|shell
operator|->
name|icon_timeout_id
operator|=
name|g_timeout_add
argument_list|(
literal|7500
argument_list|,
name|gimp_display_shell_update_icon_timer
argument_list|,
name|shell
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|shell
operator|->
name|icon_idle_id
condition|)
block|{
name|shell
operator|->
name|icon_idle_id
operator|=
name|g_idle_add
argument_list|(
name|gimp_display_shell_update_icon_invoker
argument_list|,
name|shell
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function_decl
specifier|static
name|int
name|print
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|G_GNUC_PRINTF
parameter_list|(
function_decl|4
operator|,
function_decl|5
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|int
DECL|function|print (char * buf,int len,int start,const char * fmt,...)
name|print
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|start
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|int
name|printed
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|printed
operator|=
name|g_vsnprintf
argument_list|(
name|buf
operator|+
name|start
argument_list|,
name|len
operator|-
name|start
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|printed
operator|<
literal|0
condition|)
name|printed
operator|=
name|len
operator|-
name|start
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
return|return
name|printed
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_format_title (GimpDisplayShell * shell,gchar * title,gint title_len)
name|gimp_display_shell_format_title
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
name|gchar
modifier|*
name|title
parameter_list|,
name|gint
name|title_len
parameter_list|)
block|{
name|GimpImage
modifier|*
name|gimage
decl_stmt|;
name|gchar
modifier|*
name|image_type_str
decl_stmt|;
name|gboolean
name|empty
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gchar
modifier|*
name|format
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|GIMP_IS_DISPLAY_SHELL
argument_list|(
name|shell
argument_list|)
argument_list|)
expr_stmt|;
name|gimage
operator|=
name|shell
operator|->
name|gdisp
operator|->
name|gimage
expr_stmt|;
name|empty
operator|=
name|gimp_image_is_empty
argument_list|(
name|gimage
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|gimp_image_base_type
argument_list|(
name|gimage
argument_list|)
condition|)
block|{
case|case
name|RGB
case|:
name|image_type_str
operator|=
name|empty
condition|?
name|_
argument_list|(
literal|"RGB-empty"
argument_list|)
else|:
name|_
argument_list|(
literal|"RGB"
argument_list|)
expr_stmt|;
break|break;
case|case
name|GRAY
case|:
name|image_type_str
operator|=
name|empty
condition|?
name|_
argument_list|(
literal|"grayscale-empty"
argument_list|)
else|:
name|_
argument_list|(
literal|"grayscale"
argument_list|)
expr_stmt|;
break|break;
case|case
name|INDEXED
case|:
name|image_type_str
operator|=
name|empty
condition|?
name|_
argument_list|(
literal|"indexed-empty"
argument_list|)
else|:
name|_
argument_list|(
literal|"indexed"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|image_type_str
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|format
operator|=
name|gimprc
operator|.
name|image_title_format
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|title_len
operator|&&
operator|*
name|format
condition|)
block|{
switch|switch
condition|(
operator|*
name|format
condition|)
block|{
case|case
literal|'%'
case|:
name|format
operator|++
expr_stmt|;
switch|switch
condition|(
operator|*
name|format
condition|)
block|{
case|case
literal|0
case|:
name|g_warning
argument_list|(
literal|"image-title-format string ended within %%-sequence"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'%'
case|:
name|title
index|[
name|i
operator|++
index|]
operator|=
literal|'%'
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* pruned filename */
block|{
name|gchar
modifier|*
name|basename
decl_stmt|;
name|basename
operator|=
name|g_path_get_basename
argument_list|(
name|gimp_image_filename
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|+=
name|print
argument_list|(
name|title
argument_list|,
name|title_len
argument_list|,
name|i
argument_list|,
literal|"%s"
argument_list|,
name|basename
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|basename
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'F'
case|:
comment|/* full filename */
name|i
operator|+=
name|print
argument_list|(
name|title
argument_list|,
name|title_len
argument_list|,
name|i
argument_list|,
literal|"%s"
argument_list|,
name|gimp_image_filename
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* PDB id */
name|i
operator|+=
name|print
argument_list|(
name|title
argument_list|,
name|title_len
argument_list|,
name|i
argument_list|,
literal|"%d"
argument_list|,
name|gimp_image_get_ID
argument_list|(
name|gimage
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
comment|/* instance */
name|i
operator|+=
name|print
argument_list|(
name|title
argument_list|,
name|title_len
argument_list|,
name|i
argument_list|,
literal|"%d"
argument_list|,
name|shell
operator|->
name|gdisp
operator|->
name|instance
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* type */
name|i
operator|+=
name|print
argument_list|(
name|title
argument_list|,
name|title_len
argument_list|,
name|i
argument_list|,
literal|"%s"
argument_list|,
name|image_type_str
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/* user source zoom factor */
name|i
operator|+=
name|print
argument_list|(
name|title
argument_list|,
name|title_len
argument_list|,
name|i
argument_list|,
literal|"%d"
argument_list|,
name|SCALESRC
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
comment|/* user destination zoom factor */
name|i
operator|+=
name|print
argument_list|(
name|title
argument_list|,
name|title_len
argument_list|,
name|i
argument_list|,
literal|"%d"
argument_list|,
name|SCALEDEST
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
comment|/* user zoom factor (percentage) */
name|i
operator|+=
name|print
argument_list|(
name|title
argument_list|,
name|title_len
argument_list|,
name|i
argument_list|,
literal|"%d"
argument_list|,
literal|100
operator|*
name|SCALEDEST
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
operator|/
name|SCALESRC
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* dirty flag */
if|if
condition|(
name|format
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|g_warning
argument_list|(
literal|"image-title-format string ended within %%D-sequence"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|gimage
operator|->
name|dirty
condition|)
name|title
index|[
name|i
operator|++
index|]
operator|=
name|format
index|[
literal|1
index|]
expr_stmt|;
name|format
operator|++
expr_stmt|;
break|break;
comment|/* Other cool things to be added: 	       * %m = memory used by picture 	       * some kind of resolution / image size thing 	       * people seem to want to know the active layer name 	       */
default|default:
name|g_warning
argument_list|(
literal|"image-title-format contains unknown format sequence '%%%c'"
argument_list|,
operator|*
name|format
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|title
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|format
expr_stmt|;
break|break;
block|}
name|format
operator|++
expr_stmt|;
block|}
name|title
index|[
name|MIN
argument_list|(
name|i
argument_list|,
name|title_len
operator|-
literal|1
argument_list|)
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_close_warning_dialog (GimpDisplayShell * shell,const gchar * image_name)
name|gimp_display_shell_close_warning_dialog
parameter_list|(
name|GimpDisplayShell
modifier|*
name|shell
parameter_list|,
specifier|const
name|gchar
modifier|*
name|image_name
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|mbox
decl_stmt|;
name|gchar
modifier|*
name|warning_buf
decl_stmt|;
if|if
condition|(
name|shell
operator|->
name|warning_dialog
condition|)
block|{
name|gdk_window_raise
argument_list|(
name|shell
operator|->
name|warning_dialog
operator|->
name|window
argument_list|)
expr_stmt|;
return|return;
block|}
name|warning_buf
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Changes were made to %s.\nClose anyway?"
argument_list|)
argument_list|,
name|image_name
argument_list|)
expr_stmt|;
name|shell
operator|->
name|warning_dialog
operator|=
name|mbox
operator|=
name|gimp_query_boolean_box
argument_list|(
name|image_name
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"dialogs/really_close.html"
argument_list|,
name|FALSE
argument_list|,
name|warning_buf
argument_list|,
name|GTK_STOCK_CLOSE
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gimp_display_shell_close_warning_callback
argument_list|,
name|shell
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|warning_buf
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|mbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_display_shell_close_warning_callback (GtkWidget * widget,gboolean close,gpointer data)
name|gimp_display_shell_close_warning_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gboolean
name|close
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpDisplayShell
modifier|*
name|shell
decl_stmt|;
name|shell
operator|=
name|GIMP_DISPLAY_SHELL
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|shell
operator|->
name|warning_dialog
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|close
condition|)
block|{
name|gdisplay_delete
argument_list|(
name|shell
operator|->
name|gdisp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit

