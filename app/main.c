begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<locale.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_WAIT_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"libgimp/gserialize.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|WAIT_ANY
end_ifndef

begin_define
DECL|macro|WAIT_ANY
define|#
directive|define
name|WAIT_ANY
value|-1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  WAIT_ANY  */
end_comment

begin_include
include|#
directive|include
file|"libgimp/gimpfeatures.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpenv.h"
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"app_procs.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"install.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpintl.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|G_OS_WIN32
end_ifndef

begin_function_decl
specifier|static
name|RETSIGTYPE
name|on_signal
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|SIGCHLD
end_ifdef

begin_function_decl
specifier|static
name|RETSIGTYPE
name|on_sig_child
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|test_gserialize
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|on_error
parameter_list|(
specifier|const
name|gchar
modifier|*
name|domain
parameter_list|,
name|GLogLevelFlags
name|flags
parameter_list|,
specifier|const
name|gchar
modifier|*
name|msg
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* GLOBAL data */
end_comment

begin_decl_stmt
DECL|variable|no_interface
name|int
name|no_interface
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|no_data
name|int
name|no_data
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|no_splash
name|int
name|no_splash
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|no_splash_image
name|int
name|no_splash_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|be_verbose
name|int
name|be_verbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|use_shm
name|int
name|use_shm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|use_debug_handler
name|int
name|use_debug_handler
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|console_messages
name|int
name|console_messages
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|restore_session
name|int
name|restore_session
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|image_context
name|GimpSet
modifier|*
name|image_context
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|message_handler
name|MessageHandlerType
name|message_handler
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|prog_name
name|gchar
modifier|*
name|prog_name
decl_stmt|;
end_decl_stmt

begin_comment
DECL|variable|prog_name
comment|/* The path name we are invoked with */
end_comment

begin_decl_stmt
DECL|variable|alternate_gimprc
name|gchar
modifier|*
name|alternate_gimprc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|alternate_system_gimprc
name|gchar
modifier|*
name|alternate_system_gimprc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|batch_cmds
name|gchar
modifier|*
modifier|*
name|batch_cmds
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|ENABLE_NLS
end_ifdef

begin_decl_stmt
DECL|variable|plugin_domains
name|gchar
modifier|*
name|plugin_domains
index|[]
init|=
block|{
literal|"gimp-std-plugins"
block|,
literal|"gimp-perl"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|n_plugin_domains
name|gint
name|n_plugin_domains
init|=
operator|(
sizeof|sizeof
argument_list|(
name|plugin_domains
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|plugin_domains
index|[
literal|0
index|]
argument_list|)
operator|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* LOCAL data */
end_comment

begin_decl_stmt
DECL|variable|gimp_argc
specifier|static
name|gint
name|gimp_argc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gimp_argv
specifier|static
name|gchar
modifier|*
modifier|*
name|gimp_argv
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *  argv processing:   *      Arguments are either switches, their associated  *      values, or image files.  As switches and their  *      associated values are processed, those slots in  *      the argv[] array are NULLed. We do this because  *      unparsed args are treated as images to load on  *      startup.  *  *  *      The GTK switches are processed first (X switches are  *      processed here, not by any X routines).  Then the  *      general GIMP switches are processed.  Any args  *      left are assumed to be image files the GIMP should  *      display.  *  *      The exception is the batch switch.  When this is  *      encountered, all remaining args are treated as batch  *      commands.  */
end_comment

begin_function
name|int
DECL|function|main (int argc,char ** argv)
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|show_version
decl_stmt|;
name|int
name|show_help
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_PUTENV
name|gchar
modifier|*
name|display_name
decl_stmt|,
modifier|*
name|display_env
decl_stmt|;
endif|#
directive|endif
name|g_atexit
argument_list|(
name|g_mem_profile
argument_list|)
expr_stmt|;
comment|/* Initialize variables */
name|prog_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
comment|/* Initialize i18n support */
name|INIT_LOCALE
argument_list|(
literal|"gimp"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_NLS
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n_plugin_domains
condition|;
name|i
operator|++
control|)
name|bindtextdomain
argument_list|(
name|plugin_domains
index|[
name|i
index|]
argument_list|,
name|LOCALEDIR
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|gtk_init
argument_list|(
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|setlocale
argument_list|(
name|LC_NUMERIC
argument_list|,
literal|"C"
argument_list|)
expr_stmt|;
comment|/* gtk seems to zap this during init.. */
ifdef|#
directive|ifdef
name|HAVE_PUTENV
name|display_name
operator|=
name|gdk_get_display
argument_list|()
expr_stmt|;
name|display_env
operator|=
name|g_new
argument_list|(
name|gchar
argument_list|,
name|strlen
argument_list|(
name|display_name
argument_list|)
operator|+
literal|9
argument_list|)
expr_stmt|;
operator|*
name|display_env
operator|=
literal|0
expr_stmt|;
name|strcat
argument_list|(
name|display_env
argument_list|,
literal|"DISPLAY="
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|display_env
argument_list|,
name|display_name
argument_list|)
expr_stmt|;
name|putenv
argument_list|(
name|display_env
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|no_interface
operator|=
name|FALSE
expr_stmt|;
name|no_data
operator|=
name|FALSE
expr_stmt|;
name|no_splash
operator|=
name|FALSE
expr_stmt|;
name|no_splash_image
operator|=
name|FALSE
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SHM_H
argument_list|)
operator|||
name|defined
argument_list|(
name|G_OS_WIN32
argument_list|)
name|use_shm
operator|=
name|TRUE
expr_stmt|;
else|#
directive|else
name|use_shm
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
name|use_debug_handler
operator|=
name|FALSE
expr_stmt|;
name|restore_session
operator|=
name|FALSE
expr_stmt|;
name|console_messages
operator|=
name|FALSE
expr_stmt|;
name|message_handler
operator|=
name|CONSOLE
expr_stmt|;
name|batch_cmds
operator|=
name|g_new
argument_list|(
name|char
operator|*
argument_list|,
name|argc
argument_list|)
expr_stmt|;
name|batch_cmds
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|alternate_gimprc
operator|=
name|NULL
expr_stmt|;
name|alternate_system_gimprc
operator|=
name|NULL
expr_stmt|;
name|show_version
operator|=
name|FALSE
expr_stmt|;
name|show_help
operator|=
name|FALSE
expr_stmt|;
name|test_gserialize
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--no-interface"
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-n"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|no_interface
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--batch"
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-b"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|i
operator|++
init|;
name|i
operator|<
name|argc
condition|;
name|j
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|batch_cmds
index|[
name|j
index|]
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|batch_cmds
index|[
name|j
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|batch_cmds
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
comment|/* We need at least one batch command */
name|show_help
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--system-gimprc"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|argc
operator|<=
operator|++
name|i
condition|)
block|{
name|show_help
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|alternate_system_gimprc
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--gimprc"
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-g"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|argc
operator|<=
operator|++
name|i
condition|)
block|{
name|show_help
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|alternate_gimprc
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--help"
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-h"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|show_help
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--version"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-v"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|show_version
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--no-data"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_data
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--no-splash"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_splash
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--no-splash-image"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_splash_image
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--verbose"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|be_verbose
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--no-shm"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|use_shm
operator|=
name|FALSE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--debug-handlers"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|use_debug_handler
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--console-messages"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|console_messages
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--restore-session"
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-r"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|restore_session
operator|=
name|TRUE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
comment|/*  *    ANYTHING ELSE starting with a '-' is an error.  */
elseif|else
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|show_help
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|show_version
condition|)
name|g_print
argument_list|(
literal|"%s %s\n"
argument_list|,
name|_
argument_list|(
literal|"GIMP version"
argument_list|)
argument_list|,
name|GIMP_VERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|show_help
condition|)
block|{
name|g_print
argument_list|(
name|_
argument_list|(
literal|"Usage: %s [option ...] [files ...]\n"
argument_list|)
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"Valid options are:\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  -h --help                Output this help.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  -v --version             Output version info.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  -b --batch<commands>    Run in batch mode.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  -g --gimprc<gimprc>     Use an alternate gimprc file.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  -n --no-interface        Run without a user interface.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  -r --restore-session     Try to restore saved session.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --no-data                Do not load patterns, gradients, palettes, brushes.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --verbose                Show startup messages.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --no-splash              Do not show the startup window.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --no-splash-image        Do not add an image to the startup window.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --no-shm                 Do not use shared memory between GIMP and its plugins.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --no-xshm                Do not use the X Shared Memory extension.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --console-messages       Display warnings to console instead of a dialog box.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --debug-handlers         Enable debugging signal handlers.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --display<display>      Use the designated X display.\n\n"
argument_list|)
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
name|_
argument_list|(
literal|"  --system-gimprc<gimprc> Use an alternate system gimprc file.\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|show_version
operator|||
name|show_help
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|g_set_message_handler
argument_list|(
operator|(
name|GPrintFunc
operator|)
name|gimp_message_func
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|G_OS_WIN32
comment|/* No use catching these on Win32, the user won't get any     * stack trace from glib anyhow. It's better to let Windows inform    * about the program error, and offer debugging (if the use    * has installed MSVC or some other compiler that knows how to    * install itself as a handler for program errors).    */
comment|/* Handle some signals */
ifdef|#
directive|ifdef
name|SIGHUP
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGINT
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGQUIT
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGABRT
name|signal
argument_list|(
name|SIGABRT
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGBUS
name|signal
argument_list|(
name|SIGBUS
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGSEGV
name|signal
argument_list|(
name|SIGSEGV
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGPIPE
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGTERM
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGFPE
name|signal
argument_list|(
name|SIGFPE
argument_list|,
name|on_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGCHLD
comment|/* Handle child exits */
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|on_sig_child
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|g_log_set_handler
argument_list|(
name|NULL
argument_list|,
name|G_LOG_LEVEL_ERROR
operator||
name|G_LOG_FLAG_FATAL
argument_list|,
name|on_error
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Keep the command line arguments--for use in gimp_init */
name|gimp_argc
operator|=
name|argc
operator|-
literal|1
expr_stmt|;
name|gimp_argv
operator|=
name|argv
operator|+
literal|1
expr_stmt|;
comment|/* Check the installation */
name|install_verify
argument_list|(
name|init
argument_list|)
expr_stmt|;
comment|/* Main application loop */
if|if
condition|(
operator|!
name|app_exit_finish_done
argument_list|()
condition|)
name|gtk_main
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|G_OS_WIN32
end_ifdef

begin_comment
comment|/* In case we build this as a windowed application */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_define
DECL|macro|_stdcall
define|#
directive|define
name|_stdcall
value|__attribute__((stdcall))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|_stdcall
DECL|function|WinMain (int hInstance,int hPrevInstance,char * lpszCmdLine,int nCmdShow)
name|WinMain
parameter_list|(
name|int
name|hInstance
parameter_list|,
name|int
name|hPrevInstance
parameter_list|,
name|char
modifier|*
name|lpszCmdLine
parameter_list|,
name|int
name|nCmdShow
parameter_list|)
block|{
return|return
name|main
argument_list|(
name|__argc
argument_list|,
name|__argv
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
DECL|function|init (void)
name|init
parameter_list|(
name|void
parameter_list|)
block|{
comment|/*  Continue initializing  */
name|gimp_init
argument_list|(
name|gimp_argc
argument_list|,
name|gimp_argv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|on_error (const gchar * domain,GLogLevelFlags flags,const gchar * msg,gpointer user_data)
name|on_error
parameter_list|(
specifier|const
name|gchar
modifier|*
name|domain
parameter_list|,
name|GLogLevelFlags
name|flags
parameter_list|,
specifier|const
name|gchar
modifier|*
name|msg
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|gimp_fatal_error
argument_list|(
literal|"%s"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
DECL|variable|caught_fatal_sig
specifier|static
name|int
name|caught_fatal_sig
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|G_OS_WIN32
end_ifndef

begin_function
specifier|static
name|RETSIGTYPE
DECL|function|on_signal (int sig_num)
name|on_signal
parameter_list|(
name|int
name|sig_num
parameter_list|)
block|{
if|if
condition|(
name|caught_fatal_sig
condition|)
ifdef|#
directive|ifdef
name|G_OS_WIN32
name|raise
argument_list|(
name|sig_num
argument_list|)
expr_stmt|;
else|#
directive|else
name|kill
argument_list|(
name|getpid
argument_list|()
argument_list|,
name|sig_num
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|caught_fatal_sig
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|sig_num
condition|)
block|{
ifdef|#
directive|ifdef
name|SIGHUP
case|case
name|SIGHUP
case|:
name|gimp_terminate
argument_list|(
name|_
argument_list|(
literal|"sighup caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGINT
case|case
name|SIGINT
case|:
name|gimp_terminate
argument_list|(
name|_
argument_list|(
literal|"sigint caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGQUIT
case|case
name|SIGQUIT
case|:
name|gimp_terminate
argument_list|(
name|_
argument_list|(
literal|"sigquit caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGABRT
case|case
name|SIGABRT
case|:
name|gimp_terminate
argument_list|(
name|_
argument_list|(
literal|"sigabrt caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGBUS
case|case
name|SIGBUS
case|:
name|gimp_fatal_error
argument_list|(
name|_
argument_list|(
literal|"sigbus caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGSEGV
case|case
name|SIGSEGV
case|:
name|gimp_fatal_error
argument_list|(
name|_
argument_list|(
literal|"sigsegv caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGPIPE
case|case
name|SIGPIPE
case|:
name|gimp_terminate
argument_list|(
name|_
argument_list|(
literal|"sigpipe caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGTERM
case|case
name|SIGTERM
case|:
name|gimp_terminate
argument_list|(
name|_
argument_list|(
literal|"sigterm caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGFPE
case|case
name|SIGFPE
case|:
name|gimp_fatal_error
argument_list|(
name|_
argument_list|(
literal|"sigfpe caught"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|gimp_fatal_error
argument_list|(
name|_
argument_list|(
literal|"unknown signal"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SIGCHLD
end_ifdef

begin_function
specifier|static
name|RETSIGTYPE
DECL|function|on_sig_child (int sig_num)
name|on_sig_child
parameter_list|(
name|int
name|sig_num
parameter_list|)
block|{
name|int
name|pid
decl_stmt|;
name|int
name|status
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|pid
operator|=
name|waitpid
argument_list|(
name|WAIT_ANY
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|<=
literal|0
condition|)
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2975a4150108
block|{
DECL|member|test_gint32
name|gint32
name|test_gint32
decl_stmt|;
DECL|member|test_float
name|float
name|test_float
decl_stmt|;
DECL|member|test_string
name|char
modifier|*
name|test_string
decl_stmt|;
DECL|member|test_length
name|guint32
name|test_length
decl_stmt|;
DECL|member|test_array
name|guint16
modifier|*
name|test_array
decl_stmt|;
DECL|typedef|test_struct
block|}
name|test_struct
typedef|;
end_typedef

begin_function
specifier|static
name|void
DECL|function|test_gserialize (void)
name|test_gserialize
parameter_list|(
name|void
parameter_list|)
block|{
name|GSerialDescription
modifier|*
name|test_struct_descript
decl_stmt|;
name|test_struct
modifier|*
name|ts
decl_stmt|,
modifier|*
name|to
decl_stmt|;
name|char
name|ser_1
index|[]
init|=
block|{
literal|3
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|64
block|,
literal|83
block|,
literal|51
block|,
literal|51
block|,
literal|101
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|4
block|,
literal|102
block|,
literal|111
block|,
literal|111
block|,
literal|0
block|,
literal|103
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|}
decl_stmt|;
name|ts
operator|=
name|g_new
argument_list|(
name|test_struct
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|to
operator|=
name|g_new
argument_list|(
name|test_struct
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|test_struct_descript
operator|=
name|g_new_serial_description
argument_list|(
literal|"test_struct"
argument_list|,
name|g_serial_item
argument_list|(
name|GSERIAL_INT32
argument_list|,
name|test_struct
argument_list|,
name|test_gint32
argument_list|)
argument_list|,
name|g_serial_item
argument_list|(
name|GSERIAL_FLOAT
argument_list|,
name|test_struct
argument_list|,
name|test_float
argument_list|)
argument_list|,
name|g_serial_item
argument_list|(
name|GSERIAL_STRING
argument_list|,
name|test_struct
argument_list|,
name|test_string
argument_list|)
argument_list|,
name|g_serial_vlen_array
argument_list|(
name|GSERIAL_INT16ARRAY
argument_list|,
name|test_struct
argument_list|,
name|test_array
argument_list|,
name|test_length
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ts
operator|->
name|test_gint32
operator|=
literal|0x01020304
expr_stmt|;
name|ts
operator|->
name|test_float
operator|=
literal|3.3f
expr_stmt|;
name|ts
operator|->
name|test_string
operator|=
literal|"foo"
expr_stmt|;
name|ts
operator|->
name|test_length
operator|=
literal|2
expr_stmt|;
name|ts
operator|->
name|test_array
operator|=
name|g_new
argument_list|(
name|guint16
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ts
operator|->
name|test_array
index|[
literal|0
index|]
operator|=
literal|0x0506
expr_stmt|;
name|ts
operator|->
name|test_array
index|[
literal|1
index|]
operator|=
literal|0x0708
expr_stmt|;
name|g_deserialize
argument_list|(
name|test_struct_descript
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|to
argument_list|,
name|ser_1
argument_list|)
expr_stmt|;
DECL|macro|EPSILON
define|#
directive|define
name|EPSILON
value|.0001
if|if
condition|(
name|to
operator|->
name|test_gint32
operator|!=
name|ts
operator|->
name|test_gint32
condition|)
name|g_message
argument_list|(
literal|"gint32 test failed (please email your system configuration to jaycox@earthlink.net): %d\n"
argument_list|,
name|to
operator|->
name|test_gint32
argument_list|)
expr_stmt|;
if|if
condition|(
name|to
operator|->
name|test_float
operator|+
name|EPSILON
operator|<
name|ts
operator|->
name|test_float
operator|||
name|to
operator|->
name|test_float
operator|-
name|EPSILON
operator|>
name|ts
operator|->
name|test_float
condition|)
name|g_message
argument_list|(
literal|"float test failed (please email your system configuration to jaycox@earthlink.net): %f\n"
argument_list|,
name|to
operator|->
name|test_float
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|to
operator|->
name|test_string
argument_list|,
name|ts
operator|->
name|test_string
argument_list|)
operator|!=
literal|0
condition|)
name|g_message
argument_list|(
literal|"string test failed (please email your system configuration to jaycox@earthlink.net): %s\n"
argument_list|,
name|to
operator|->
name|test_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|to
operator|->
name|test_length
operator|!=
name|ts
operator|->
name|test_length
condition|)
name|g_message
argument_list|(
literal|"array length test failed(please email your system configuration to jaycox@earthlink.net): %d\n"
argument_list|,
name|to
operator|->
name|test_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|to
operator|->
name|test_array
index|[
literal|0
index|]
operator|!=
name|ts
operator|->
name|test_array
index|[
literal|0
index|]
condition|)
name|g_message
argument_list|(
literal|"int16array value 0 test failed(please email your system configuration to jaycox@earthlink.net): %d\n"
argument_list|,
name|to
operator|->
name|test_array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|to
operator|->
name|test_array
index|[
literal|1
index|]
operator|==
name|ts
operator|->
name|test_array
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|to
operator|->
name|test_array
index|[
literal|1
index|]
operator|!=
name|ts
operator|->
name|test_array
index|[
literal|1
index|]
condition|)
name|g_message
argument_list|(
literal|"int16array value 1 test failed(please email your system configuration to jaycox@earthlink.net): %d\n"
argument_list|,
name|to
operator|->
name|test_array
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|G_OS_WIN32
name|g_message
argument_list|(
literal|"Passed serialization test\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*  free the memory  */
name|g_free
argument_list|(
name|ts
operator|->
name|test_array
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|ts
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|to
operator|->
name|test_array
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|to
operator|->
name|test_string
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|to
argument_list|)
expr_stmt|;
name|g_free_serial_description
argument_list|(
name|test_struct_descript
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

