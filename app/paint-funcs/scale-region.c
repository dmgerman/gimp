begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<glib-object.h>
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"paint-funcs-types.h"
end_include

begin_include
include|#
directive|include
file|"base/tile.h"
end_include

begin_include
include|#
directive|include
file|"base/tile-manager.h"
end_include

begin_include
include|#
directive|include
file|"base/pixel-region.h"
end_include

begin_include
include|#
directive|include
file|"base/pixel-surround.h"
end_include

begin_include
include|#
directive|include
file|"paint-funcs.h"
end_include

begin_include
include|#
directive|include
file|"scale-region.h"
end_include

begin_include
include|#
directive|include
file|"gimp-log.h"
end_include

begin_define
DECL|macro|NUM_TILES (w,h)
define|#
directive|define
name|NUM_TILES
parameter_list|(
name|w
parameter_list|,
name|h
parameter_list|)
value|((((w) + (TILE_WIDTH - 1)) / TILE_WIDTH) *  \                         (((h) + (TILE_HEIGHT - 1)) / TILE_HEIGHT))
end_define

begin_function_decl
specifier|static
name|void
name|scale_determine_levels
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|,
name|gint
modifier|*
name|levelx
parameter_list|,
name|gint
modifier|*
name|levely
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|scale_determine_progress
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|,
name|gint
name|levelx
parameter_list|,
name|gint
name|levely
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scale_region_buffer
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scale_region_tile
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scale
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
name|TileManager
modifier|*
name|dstTM
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|decimate_xy
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
name|TileManager
modifier|*
name|dstTM
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|decimate_x
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
name|TileManager
modifier|*
name|dstTM
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|decimate_y
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
name|TileManager
modifier|*
name|dstTM
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|decimate_average_xy
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|decimate_average_y
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|decimate_average_x
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|interpolate_nearest
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|interpolate_bilinear
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|interpolate_cubic
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gfloat
modifier|*
name|create_lanczos3_lookup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|interpolate_lanczos3
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|,
specifier|const
name|gfloat
modifier|*
name|kernel_lookup
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|interpolate_bilinear_pr
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gint
name|x1
parameter_list|,
specifier|const
name|gint
name|y1
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|gdouble
name|cubic_spline_fit
parameter_list|(
specifier|const
name|gdouble
name|dx
parameter_list|,
specifier|const
name|gdouble
name|x1
parameter_list|,
specifier|const
name|gdouble
name|y1
parameter_list|,
specifier|const
name|gdouble
name|x2
parameter_list|,
specifier|const
name|gdouble
name|y2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|gdouble
name|weighted_sum
parameter_list|(
specifier|const
name|gdouble
name|dx
parameter_list|,
specifier|const
name|gdouble
name|dy
parameter_list|,
specifier|const
name|gint
name|s00
parameter_list|,
specifier|const
name|gint
name|s10
parameter_list|,
specifier|const
name|gint
name|s01
parameter_list|,
specifier|const
name|gint
name|s11
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|gdouble
name|sinc
parameter_list|(
specifier|const
name|gdouble
name|x
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|gdouble
name|lanczos3_mul_alpha
parameter_list|(
specifier|const
name|guchar
modifier|*
name|pixels
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|x_kernel
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|y_kernel
parameter_list|,
specifier|const
name|gint
name|stride
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
specifier|const
name|gint
name|byte
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|gdouble
name|lanczos3_mul
parameter_list|(
specifier|const
name|guchar
modifier|*
name|pixels
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|x_kernel
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|y_kernel
parameter_list|,
specifier|const
name|gint
name|stride
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
specifier|const
name|gint
name|byte
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
DECL|function|scale_region (PixelRegion * srcPR,PixelRegion * dstPR,GimpInterpolationType interpolation,GimpProgressFunc progress_callback,gpointer progress_data)
name|scale_region
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|)
block|{
comment|/* Copy and return if scale = 1.0 */
if|if
condition|(
name|srcPR
operator|->
name|h
operator|==
name|dstPR
operator|->
name|h
operator|&&
name|srcPR
operator|->
name|w
operator|==
name|dstPR
operator|->
name|w
condition|)
block|{
name|copy_region
argument_list|(
name|srcPR
argument_list|,
name|dstPR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|srcPR
operator|->
name|tiles
operator|==
name|NULL
operator|&&
name|srcPR
operator|->
name|data
operator|!=
name|NULL
condition|)
block|{
name|g_return_if_fail
argument_list|(
name|interpolation
operator|==
name|GIMP_INTERPOLATION_LINEAR
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|progress_callback
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|scale_region_buffer
argument_list|(
name|srcPR
argument_list|,
name|dstPR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|srcPR
operator|->
name|tiles
operator|!=
name|NULL
operator|&&
name|srcPR
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|scale_region_tile
argument_list|(
name|srcPR
argument_list|,
name|dstPR
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|)
expr_stmt|;
return|return;
block|}
name|g_assert_not_reached
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|scale_determine_levels (PixelRegion * srcPR,PixelRegion * dstPR,gint * levelx,gint * levely)
name|scale_determine_levels
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|,
name|gint
modifier|*
name|levelx
parameter_list|,
name|gint
modifier|*
name|levely
parameter_list|)
block|{
name|gdouble
name|scalex
init|=
operator|(
name|gdouble
operator|)
name|dstPR
operator|->
name|w
operator|/
operator|(
name|gdouble
operator|)
name|srcPR
operator|->
name|w
decl_stmt|;
name|gdouble
name|scaley
init|=
operator|(
name|gdouble
operator|)
name|dstPR
operator|->
name|h
operator|/
operator|(
name|gdouble
operator|)
name|srcPR
operator|->
name|h
decl_stmt|;
name|gint
name|width
init|=
name|srcPR
operator|->
name|w
decl_stmt|;
name|gint
name|height
init|=
name|srcPR
operator|->
name|h
decl_stmt|;
comment|/* downscaling is done in multiple steps */
while|while
condition|(
name|scalex
operator|<
literal|0.5
operator|&&
name|width
operator|>
literal|1
condition|)
block|{
name|scalex
operator|*=
literal|2
expr_stmt|;
name|width
operator|/=
literal|2
expr_stmt|;
operator|*
name|levelx
operator|+=
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|scaley
operator|<
literal|0.5
operator|&&
name|height
operator|>
literal|1
condition|)
block|{
name|scaley
operator|*=
literal|2
expr_stmt|;
name|height
operator|*=
literal|2
expr_stmt|;
operator|*
name|levely
operator|+=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* This function calculates the number of tiles that are written in  * one scale operation. This number is used as the max_progress  * parameter in calls to GimpProgressFunc.  */
end_comment

begin_function
specifier|static
name|gint
DECL|function|scale_determine_progress (PixelRegion * srcPR,PixelRegion * dstPR,gint levelx,gint levely)
name|scale_determine_progress
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|,
name|gint
name|levelx
parameter_list|,
name|gint
name|levely
parameter_list|)
block|{
name|gint
name|width
init|=
name|srcPR
operator|->
name|w
decl_stmt|;
name|gint
name|height
init|=
name|srcPR
operator|->
name|h
decl_stmt|;
name|gint
name|tiles
init|=
literal|0
decl_stmt|;
comment|/*  The logic here should be kept in sync with scale_region_tile().  */
while|while
condition|(
name|levelx
operator|<
literal|0
operator|&&
name|levely
operator|<
literal|0
condition|)
block|{
name|width
operator|<<=
literal|1
expr_stmt|;
name|height
operator|<<=
literal|1
expr_stmt|;
name|levelx
operator|++
expr_stmt|;
name|levely
operator|++
expr_stmt|;
name|tiles
operator|+=
name|NUM_TILES
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|levelx
operator|<
literal|0
condition|)
block|{
name|width
operator|<<=
literal|1
expr_stmt|;
name|levelx
operator|++
expr_stmt|;
name|tiles
operator|+=
name|NUM_TILES
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|levely
operator|<
literal|0
condition|)
block|{
name|height
operator|<<=
literal|1
expr_stmt|;
name|levely
operator|++
expr_stmt|;
name|tiles
operator|+=
name|NUM_TILES
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|levelx
operator|>
literal|0
operator|&&
name|levely
operator|>
literal|0
condition|)
block|{
name|width
operator|>>=
literal|1
expr_stmt|;
name|height
operator|>>=
literal|1
expr_stmt|;
name|levelx
operator|--
expr_stmt|;
name|levely
operator|--
expr_stmt|;
name|tiles
operator|+=
name|NUM_TILES
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|levelx
operator|>
literal|0
condition|)
block|{
name|width
operator|>>=
literal|1
expr_stmt|;
name|levelx
operator|--
expr_stmt|;
name|tiles
operator|+=
name|NUM_TILES
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|levely
operator|>
literal|0
condition|)
block|{
name|height
operator|>>=
literal|1
expr_stmt|;
name|levely
operator|--
expr_stmt|;
name|tiles
operator|+=
name|NUM_TILES
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
name|tiles
operator|+=
name|NUM_TILES
argument_list|(
name|dstPR
operator|->
name|w
argument_list|,
name|dstPR
operator|->
name|h
argument_list|)
expr_stmt|;
return|return
name|tiles
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|scale_region_tile (PixelRegion * srcPR,PixelRegion * dstPR,GimpInterpolationType interpolation,GimpProgressFunc progress_callback,gpointer progress_data)
name|scale_region_tile
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|)
block|{
name|TileManager
modifier|*
name|tmpTM
init|=
name|NULL
decl_stmt|;
name|TileManager
modifier|*
name|srcTM
init|=
name|srcPR
operator|->
name|tiles
decl_stmt|;
name|TileManager
modifier|*
name|dstTM
init|=
name|dstPR
operator|->
name|tiles
decl_stmt|;
name|gint
name|width
init|=
name|srcPR
operator|->
name|w
decl_stmt|;
name|gint
name|height
init|=
name|srcPR
operator|->
name|h
decl_stmt|;
name|gint
name|bytes
init|=
name|srcPR
operator|->
name|bytes
decl_stmt|;
name|gint
name|max_progress
init|=
literal|0
decl_stmt|;
name|gint
name|progress
init|=
literal|0
decl_stmt|;
name|gint
name|levelx
init|=
literal|0
decl_stmt|;
name|gint
name|levely
init|=
literal|0
decl_stmt|;
comment|/* determine scaling levels */
if|if
condition|(
name|interpolation
operator|!=
name|GIMP_INTERPOLATION_NONE
condition|)
block|{
name|scale_determine_levels
argument_list|(
name|srcPR
argument_list|,
name|dstPR
argument_list|,
operator|&
name|levelx
argument_list|,
operator|&
name|levely
argument_list|)
expr_stmt|;
block|}
name|max_progress
operator|=
name|scale_determine_progress
argument_list|(
name|srcPR
argument_list|,
name|dstPR
argument_list|,
name|levelx
argument_list|,
name|levely
argument_list|)
expr_stmt|;
if|if
condition|(
name|levelx
operator|==
literal|0
operator|&&
name|levely
operator|==
literal|0
condition|)
block|{
name|scale
argument_list|(
name|srcTM
argument_list|,
name|dstTM
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|levelx
operator|<
literal|0
operator|&&
name|levely
operator|<
literal|0
condition|)
block|{
name|width
operator|<<=
literal|1
expr_stmt|;
name|height
operator|<<=
literal|1
expr_stmt|;
name|tmpTM
operator|=
name|tile_manager_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|scale
argument_list|(
name|srcTM
argument_list|,
name|tmpTM
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcTM
operator|!=
name|srcPR
operator|->
name|tiles
condition|)
name|tile_manager_unref
argument_list|(
name|srcTM
argument_list|)
expr_stmt|;
name|srcTM
operator|=
name|tmpTM
expr_stmt|;
name|levelx
operator|++
expr_stmt|;
name|levely
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|levelx
operator|<
literal|0
condition|)
block|{
name|width
operator|<<=
literal|1
expr_stmt|;
name|tmpTM
operator|=
name|tile_manager_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|scale
argument_list|(
name|srcTM
argument_list|,
name|tmpTM
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcTM
operator|!=
name|srcPR
operator|->
name|tiles
condition|)
name|tile_manager_unref
argument_list|(
name|srcTM
argument_list|)
expr_stmt|;
name|srcTM
operator|=
name|tmpTM
expr_stmt|;
name|levelx
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|levely
operator|<
literal|0
condition|)
block|{
name|height
operator|<<=
literal|1
expr_stmt|;
name|tmpTM
operator|=
name|tile_manager_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|scale
argument_list|(
name|srcTM
argument_list|,
name|tmpTM
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcTM
operator|!=
name|srcPR
operator|->
name|tiles
condition|)
name|tile_manager_unref
argument_list|(
name|srcTM
argument_list|)
expr_stmt|;
name|srcTM
operator|=
name|tmpTM
expr_stmt|;
name|levely
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|levelx
operator|>
literal|0
operator|&&
name|levely
operator|>
literal|0
condition|)
block|{
name|width
operator|>>=
literal|1
expr_stmt|;
name|height
operator|>>=
literal|1
expr_stmt|;
name|tmpTM
operator|=
name|tile_manager_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|decimate_xy
argument_list|(
name|srcTM
argument_list|,
name|tmpTM
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcTM
operator|!=
name|srcPR
operator|->
name|tiles
condition|)
name|tile_manager_unref
argument_list|(
name|srcTM
argument_list|)
expr_stmt|;
name|srcTM
operator|=
name|tmpTM
expr_stmt|;
name|levelx
operator|--
expr_stmt|;
name|levely
operator|--
expr_stmt|;
block|}
while|while
condition|(
name|levelx
operator|>
literal|0
condition|)
block|{
name|width
operator|>>=
literal|1
expr_stmt|;
name|tmpTM
operator|=
name|tile_manager_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|decimate_x
argument_list|(
name|srcTM
argument_list|,
name|tmpTM
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcTM
operator|!=
name|srcPR
operator|->
name|tiles
condition|)
name|tile_manager_unref
argument_list|(
name|srcTM
argument_list|)
expr_stmt|;
name|srcTM
operator|=
name|tmpTM
expr_stmt|;
name|levelx
operator|--
expr_stmt|;
block|}
while|while
condition|(
name|levely
operator|>
literal|0
condition|)
block|{
name|height
operator|>>=
literal|1
expr_stmt|;
name|tmpTM
operator|=
name|tile_manager_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|decimate_y
argument_list|(
name|srcTM
argument_list|,
name|tmpTM
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcTM
operator|!=
name|srcPR
operator|->
name|tiles
condition|)
name|tile_manager_unref
argument_list|(
name|srcTM
argument_list|)
expr_stmt|;
name|srcTM
operator|=
name|tmpTM
expr_stmt|;
name|levely
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|tmpTM
operator|!=
name|NULL
condition|)
block|{
name|scale
argument_list|(
name|tmpTM
argument_list|,
name|dstTM
argument_list|,
name|interpolation
argument_list|,
name|progress_callback
argument_list|,
name|progress_data
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
name|tile_manager_unref
argument_list|(
name|tmpTM
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|progress_callback
condition|)
name|progress_callback
argument_list|(
literal|0
argument_list|,
name|max_progress
argument_list|,
name|max_progress
argument_list|,
name|progress_data
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|scale (TileManager * srcTM,TileManager * dstTM,GimpInterpolationType interpolation,GimpProgressFunc progress_callback,gpointer progress_data,gint * progress,gint max_progress)
name|scale
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
name|TileManager
modifier|*
name|dstTM
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
block|{
name|PixelRegion
name|region
decl_stmt|;
name|PixelSurround
modifier|*
name|surround
init|=
name|NULL
decl_stmt|;
specifier|const
name|guint
name|src_width
init|=
name|tile_manager_width
argument_list|(
name|srcTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|src_height
init|=
name|tile_manager_height
argument_list|(
name|srcTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|bytes
init|=
name|tile_manager_bpp
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|dst_width
init|=
name|tile_manager_width
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|dst_height
init|=
name|tile_manager_height
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|gdouble
name|scaley
init|=
operator|(
name|gdouble
operator|)
name|src_height
operator|/
operator|(
name|gdouble
operator|)
name|dst_height
decl_stmt|;
specifier|const
name|gdouble
name|scalex
init|=
operator|(
name|gdouble
operator|)
name|src_width
operator|/
operator|(
name|gdouble
operator|)
name|dst_width
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
name|gfloat
modifier|*
name|kernel_lookup
init|=
name|NULL
decl_stmt|;
name|GIMP_LOG
argument_list|(
name|SCALE
argument_list|,
literal|"scale: %dx%d -> %dx%d"
argument_list|,
name|src_width
argument_list|,
name|src_height
argument_list|,
name|dst_width
argument_list|,
name|dst_height
argument_list|)
expr_stmt|;
comment|/* fall back if not enough pixels available */
if|if
condition|(
name|interpolation
operator|!=
name|GIMP_INTERPOLATION_NONE
condition|)
block|{
if|if
condition|(
name|src_width
operator|<
literal|2
operator|||
name|src_height
operator|<
literal|2
operator|||
name|dst_width
operator|<
literal|2
operator|||
name|dst_height
operator|<
literal|2
condition|)
block|{
name|interpolation
operator|=
name|GIMP_INTERPOLATION_NONE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|src_width
operator|<
literal|3
operator|||
name|src_height
operator|<
literal|3
operator|||
name|dst_width
operator|<
literal|3
operator|||
name|dst_height
operator|<
literal|3
condition|)
block|{
name|interpolation
operator|=
name|GIMP_INTERPOLATION_LINEAR
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|interpolation
condition|)
block|{
case|case
name|GIMP_INTERPOLATION_NONE
case|:
break|break;
case|case
name|GIMP_INTERPOLATION_LINEAR
case|:
name|surround
operator|=
name|pixel_surround_new
argument_list|(
name|srcTM
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
name|PIXEL_SURROUND_SMEAR
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_INTERPOLATION_CUBIC
case|:
name|surround
operator|=
name|pixel_surround_new
argument_list|(
name|srcTM
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|,
name|PIXEL_SURROUND_SMEAR
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_INTERPOLATION_LANCZOS
case|:
name|surround
operator|=
name|pixel_surround_new
argument_list|(
name|srcTM
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|,
name|PIXEL_SURROUND_SMEAR
argument_list|)
expr_stmt|;
name|kernel_lookup
operator|=
name|create_lanczos3_lookup
argument_list|()
expr_stmt|;
break|break;
block|}
name|pixel_region_init
argument_list|(
operator|&
name|region
argument_list|,
name|dstTM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dst_width
argument_list|,
name|dst_height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|1
argument_list|,
operator|&
name|region
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
specifier|const
name|gint
name|x1
init|=
name|region
operator|.
name|x
operator|+
name|region
operator|.
name|w
decl_stmt|;
specifier|const
name|gint
name|y1
init|=
name|region
operator|.
name|y
operator|+
name|region
operator|.
name|h
decl_stmt|;
name|guchar
modifier|*
name|row
init|=
name|region
operator|.
name|data
decl_stmt|;
name|gint
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
name|region
operator|.
name|y
init|;
name|y
operator|<
name|y1
condition|;
name|y
operator|++
control|)
block|{
name|guchar
modifier|*
name|pixel
init|=
name|row
decl_stmt|;
name|gdouble
name|yfrac
init|=
operator|(
name|y
operator|+
literal|0.5
operator|)
operator|*
name|scaley
operator|-
literal|0.5
decl_stmt|;
name|gint
name|sy
init|=
operator|(
name|gint
operator|)
name|yfrac
decl_stmt|;
name|gint
name|x
decl_stmt|;
name|yfrac
operator|=
name|yfrac
operator|-
name|sy
expr_stmt|;
for|for
control|(
name|x
operator|=
name|region
operator|.
name|x
init|;
name|x
operator|<
name|x1
condition|;
name|x
operator|++
control|)
block|{
name|gdouble
name|xfrac
init|=
operator|(
name|x
operator|+
literal|0.5
operator|)
operator|*
name|scalex
operator|-
literal|0.5
decl_stmt|;
name|gint
name|sx
init|=
operator|(
name|gint
operator|)
name|xfrac
decl_stmt|;
name|xfrac
operator|=
name|xfrac
operator|-
name|sx
expr_stmt|;
switch|switch
condition|(
name|interpolation
condition|)
block|{
case|case
name|GIMP_INTERPOLATION_NONE
case|:
name|interpolate_nearest
argument_list|(
name|srcTM
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|,
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_INTERPOLATION_LINEAR
case|:
name|interpolate_bilinear
argument_list|(
name|surround
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|,
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|bytes
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_INTERPOLATION_CUBIC
case|:
name|interpolate_cubic
argument_list|(
name|surround
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|,
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|bytes
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
break|break;
case|case
name|GIMP_INTERPOLATION_LANCZOS
case|:
name|interpolate_lanczos3
argument_list|(
name|surround
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|,
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|bytes
argument_list|,
name|pixel
argument_list|,
name|kernel_lookup
argument_list|)
expr_stmt|;
break|break;
block|}
name|pixel
operator|+=
name|region
operator|.
name|bytes
expr_stmt|;
block|}
name|row
operator|+=
name|region
operator|.
name|rowstride
expr_stmt|;
block|}
if|if
condition|(
name|progress_callback
condition|)
block|{
operator|(
operator|*
name|progress
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|progress
operator|%
literal|8
operator|==
literal|0
condition|)
name|progress_callback
argument_list|(
literal|0
argument_list|,
name|max_progress
argument_list|,
operator|*
name|progress
argument_list|,
name|progress_data
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|kernel_lookup
condition|)
name|g_free
argument_list|(
name|kernel_lookup
argument_list|)
expr_stmt|;
if|if
condition|(
name|surround
condition|)
name|pixel_surround_destroy
argument_list|(
name|surround
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|decimate_xy (TileManager * srcTM,TileManager * dstTM,GimpInterpolationType interpolation,GimpProgressFunc progress_callback,gpointer progress_data,gint * progress,gint max_progress)
name|decimate_xy
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
name|TileManager
modifier|*
name|dstTM
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
block|{
name|PixelRegion
name|region
decl_stmt|;
name|PixelSurround
modifier|*
name|surround
init|=
name|NULL
decl_stmt|;
specifier|const
name|guint
name|bytes
init|=
name|tile_manager_bpp
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|dst_width
init|=
name|tile_manager_width
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|dst_height
init|=
name|tile_manager_height
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
name|GIMP_LOG
argument_list|(
name|SCALE
argument_list|,
literal|"decimate_xy: %dx%d -> %dx%d\n"
argument_list|,
name|tile_manager_width
argument_list|(
name|srcTM
argument_list|)
argument_list|,
name|tile_manager_height
argument_list|(
name|srcTM
argument_list|)
argument_list|,
name|dst_width
argument_list|,
name|dst_height
argument_list|)
expr_stmt|;
name|surround
operator|=
name|pixel_surround_new
argument_list|(
name|srcTM
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
name|PIXEL_SURROUND_SMEAR
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|region
argument_list|,
name|dstTM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dst_width
argument_list|,
name|dst_height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|1
argument_list|,
operator|&
name|region
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
specifier|const
name|gint
name|x1
init|=
name|region
operator|.
name|x
operator|+
name|region
operator|.
name|w
decl_stmt|;
specifier|const
name|gint
name|y1
init|=
name|region
operator|.
name|y
operator|+
name|region
operator|.
name|h
decl_stmt|;
name|guchar
modifier|*
name|row
init|=
name|region
operator|.
name|data
decl_stmt|;
name|gint
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
name|region
operator|.
name|y
init|;
name|y
operator|<
name|y1
condition|;
name|y
operator|++
control|)
block|{
specifier|const
name|gint
name|sy
init|=
name|y
operator|*
literal|2
decl_stmt|;
name|guchar
modifier|*
name|pixel
init|=
name|row
decl_stmt|;
name|gint
name|x
decl_stmt|;
for|for
control|(
name|x
operator|=
name|region
operator|.
name|x
init|;
name|x
operator|<
name|x1
condition|;
name|x
operator|++
control|)
block|{
name|decimate_average_xy
argument_list|(
name|surround
argument_list|,
name|x
operator|*
literal|2
argument_list|,
name|sy
argument_list|,
name|bytes
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
name|pixel
operator|+=
name|region
operator|.
name|bytes
expr_stmt|;
block|}
name|row
operator|+=
name|region
operator|.
name|rowstride
expr_stmt|;
block|}
if|if
condition|(
name|progress_callback
condition|)
block|{
operator|(
operator|*
name|progress
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|progress
operator|%
literal|16
operator|==
literal|0
condition|)
name|progress_callback
argument_list|(
literal|0
argument_list|,
name|max_progress
argument_list|,
operator|*
name|progress
argument_list|,
name|progress_data
argument_list|)
expr_stmt|;
block|}
block|}
name|pixel_surround_destroy
argument_list|(
name|surround
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|decimate_x (TileManager * srcTM,TileManager * dstTM,GimpInterpolationType interpolation,GimpProgressFunc progress_callback,gpointer progress_data,gint * progress,gint max_progress)
name|decimate_x
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
name|TileManager
modifier|*
name|dstTM
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
block|{
name|PixelRegion
name|region
decl_stmt|;
name|PixelSurround
modifier|*
name|surround
init|=
name|NULL
decl_stmt|;
specifier|const
name|guint
name|bytes
init|=
name|tile_manager_bpp
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|dst_width
init|=
name|tile_manager_width
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|dst_height
init|=
name|tile_manager_height
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
name|GIMP_LOG
argument_list|(
name|SCALE
argument_list|,
literal|"decimate_x: %dx%d -> %dx%d\n"
argument_list|,
name|tile_manager_width
argument_list|(
name|srcTM
argument_list|)
argument_list|,
name|tile_manager_height
argument_list|(
name|srcTM
argument_list|)
argument_list|,
name|dst_width
argument_list|,
name|dst_height
argument_list|)
expr_stmt|;
name|surround
operator|=
name|pixel_surround_new
argument_list|(
name|srcTM
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|PIXEL_SURROUND_SMEAR
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|region
argument_list|,
name|dstTM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dst_width
argument_list|,
name|dst_height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|1
argument_list|,
operator|&
name|region
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
specifier|const
name|gint
name|x1
init|=
name|region
operator|.
name|x
operator|+
name|region
operator|.
name|w
decl_stmt|;
specifier|const
name|gint
name|y1
init|=
name|region
operator|.
name|y
operator|+
name|region
operator|.
name|h
decl_stmt|;
name|guchar
modifier|*
name|row
init|=
name|region
operator|.
name|data
decl_stmt|;
name|gint
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
name|region
operator|.
name|y
init|;
name|y
operator|<
name|y1
condition|;
name|y
operator|++
control|)
block|{
name|guchar
modifier|*
name|pixel
init|=
name|row
decl_stmt|;
name|gint
name|x
decl_stmt|;
for|for
control|(
name|x
operator|=
name|region
operator|.
name|x
init|;
name|x
operator|<
name|x1
condition|;
name|x
operator|++
control|)
block|{
name|decimate_average_x
argument_list|(
name|surround
argument_list|,
name|x
operator|*
literal|2
argument_list|,
name|y
argument_list|,
name|bytes
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
name|pixel
operator|+=
name|region
operator|.
name|bytes
expr_stmt|;
block|}
name|row
operator|+=
name|region
operator|.
name|rowstride
expr_stmt|;
block|}
if|if
condition|(
name|progress_callback
condition|)
block|{
operator|(
operator|*
name|progress
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|progress
operator|%
literal|32
operator|==
literal|0
condition|)
name|progress_callback
argument_list|(
literal|0
argument_list|,
name|max_progress
argument_list|,
operator|*
name|progress
argument_list|,
name|progress_data
argument_list|)
expr_stmt|;
block|}
block|}
name|pixel_surround_destroy
argument_list|(
name|surround
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|decimate_y (TileManager * srcTM,TileManager * dstTM,GimpInterpolationType interpolation,GimpProgressFunc progress_callback,gpointer progress_data,gint * progress,gint max_progress)
name|decimate_y
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
name|TileManager
modifier|*
name|dstTM
parameter_list|,
name|GimpInterpolationType
name|interpolation
parameter_list|,
name|GimpProgressFunc
name|progress_callback
parameter_list|,
name|gpointer
name|progress_data
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
block|{
name|PixelRegion
name|region
decl_stmt|;
name|PixelSurround
modifier|*
name|surround
init|=
name|NULL
decl_stmt|;
specifier|const
name|guint
name|bytes
init|=
name|tile_manager_bpp
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|dst_width
init|=
name|tile_manager_width
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
specifier|const
name|guint
name|dst_height
init|=
name|tile_manager_height
argument_list|(
name|dstTM
argument_list|)
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
name|GIMP_LOG
argument_list|(
name|SCALE
argument_list|,
literal|"decimate_y: %dx%d -> %dx%d\n"
argument_list|,
name|tile_manager_width
argument_list|(
name|srcTM
argument_list|)
argument_list|,
name|tile_manager_height
argument_list|(
name|srcTM
argument_list|)
argument_list|,
name|dst_width
argument_list|,
name|dst_height
argument_list|)
expr_stmt|;
name|surround
operator|=
name|pixel_surround_new
argument_list|(
name|srcTM
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|PIXEL_SURROUND_SMEAR
argument_list|)
expr_stmt|;
name|pixel_region_init
argument_list|(
operator|&
name|region
argument_list|,
name|dstTM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dst_width
argument_list|,
name|dst_height
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|pixel_regions_register
argument_list|(
literal|1
argument_list|,
operator|&
name|region
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|pixel_regions_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
specifier|const
name|gint
name|x1
init|=
name|region
operator|.
name|x
operator|+
name|region
operator|.
name|w
decl_stmt|;
specifier|const
name|gint
name|y1
init|=
name|region
operator|.
name|y
operator|+
name|region
operator|.
name|h
decl_stmt|;
name|guchar
modifier|*
name|row
init|=
name|region
operator|.
name|data
decl_stmt|;
name|gint
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
name|region
operator|.
name|y
init|;
name|y
operator|<
name|y1
condition|;
name|y
operator|++
control|)
block|{
specifier|const
name|gint
name|sy
init|=
name|y
operator|*
literal|2
decl_stmt|;
name|guchar
modifier|*
name|pixel
init|=
name|row
decl_stmt|;
name|gint
name|x
decl_stmt|;
for|for
control|(
name|x
operator|=
name|region
operator|.
name|x
init|;
name|x
operator|<
name|x1
condition|;
name|x
operator|++
control|)
block|{
name|decimate_average_y
argument_list|(
name|surround
argument_list|,
name|x
argument_list|,
name|sy
argument_list|,
name|bytes
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
name|pixel
operator|+=
name|region
operator|.
name|bytes
expr_stmt|;
block|}
name|row
operator|+=
name|region
operator|.
name|rowstride
expr_stmt|;
block|}
if|if
condition|(
name|progress_callback
condition|)
block|{
operator|(
operator|*
name|progress
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|progress
operator|%
literal|32
operator|==
literal|0
condition|)
name|progress_callback
argument_list|(
literal|0
argument_list|,
name|max_progress
argument_list|,
operator|*
name|progress
argument_list|,
name|progress_data
argument_list|)
expr_stmt|;
block|}
block|}
name|pixel_surround_destroy
argument_list|(
name|surround
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
specifier|inline
DECL|function|pixel_average4 (const guchar * p1,const guchar * p2,const guchar * p3,const guchar * p4,guchar * p,const gint bytes)
name|pixel_average4
parameter_list|(
specifier|const
name|guchar
modifier|*
name|p1
parameter_list|,
specifier|const
name|guchar
modifier|*
name|p2
parameter_list|,
specifier|const
name|guchar
modifier|*
name|p3
parameter_list|,
specifier|const
name|guchar
modifier|*
name|p4
parameter_list|,
name|guchar
modifier|*
name|p
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|)
block|{
switch|switch
condition|(
name|bytes
condition|)
block|{
case|case
literal|1
case|:
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|p1
index|[
literal|0
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|+
name|p3
index|[
literal|0
index|]
operator|+
name|p4
index|[
literal|0
index|]
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
block|{
name|guint
name|a
init|=
name|p1
index|[
literal|1
index|]
operator|+
name|p2
index|[
literal|1
index|]
operator|+
name|p3
index|[
literal|1
index|]
operator|+
name|p4
index|[
literal|1
index|]
decl_stmt|;
switch|switch
condition|(
name|a
condition|)
block|{
case|case
literal|0
case|:
comment|/* all transparent */
name|p
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1020
case|:
comment|/* all opaque */
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|p1
index|[
literal|0
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|+
name|p3
index|[
literal|0
index|]
operator|+
name|p4
index|[
literal|0
index|]
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
literal|255
expr_stmt|;
break|break;
default|default:
name|p
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|p1
index|[
literal|0
index|]
operator|*
name|p1
index|[
literal|1
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|*
name|p2
index|[
literal|1
index|]
operator|+
name|p3
index|[
literal|0
index|]
operator|*
name|p3
index|[
literal|1
index|]
operator|+
name|p4
index|[
literal|0
index|]
operator|*
name|p4
index|[
literal|1
index|]
operator|+
operator|(
name|a
operator|>>
literal|1
operator|)
operator|)
operator|/
name|a
operator|)
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
operator|(
name|a
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
literal|3
case|:
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|p1
index|[
literal|0
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|+
name|p3
index|[
literal|0
index|]
operator|+
name|p4
index|[
literal|0
index|]
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
operator|(
name|p1
index|[
literal|1
index|]
operator|+
name|p2
index|[
literal|1
index|]
operator|+
name|p3
index|[
literal|1
index|]
operator|+
name|p4
index|[
literal|1
index|]
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
name|p
index|[
literal|2
index|]
operator|=
operator|(
name|p1
index|[
literal|2
index|]
operator|+
name|p2
index|[
literal|2
index|]
operator|+
name|p3
index|[
literal|2
index|]
operator|+
name|p4
index|[
literal|2
index|]
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
break|break;
case|case
literal|4
case|:
block|{
name|guint
name|a
init|=
name|p1
index|[
literal|3
index|]
operator|+
name|p2
index|[
literal|3
index|]
operator|+
name|p3
index|[
literal|3
index|]
operator|+
name|p4
index|[
literal|3
index|]
decl_stmt|;
switch|switch
condition|(
name|a
condition|)
block|{
case|case
literal|0
case|:
comment|/* all transparent */
name|p
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
operator|=
name|p
index|[
literal|2
index|]
operator|=
name|p
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1020
case|:
comment|/* all opaque */
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|p1
index|[
literal|0
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|+
name|p3
index|[
literal|0
index|]
operator|+
name|p4
index|[
literal|0
index|]
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
operator|(
name|p1
index|[
literal|1
index|]
operator|+
name|p2
index|[
literal|1
index|]
operator|+
name|p3
index|[
literal|1
index|]
operator|+
name|p4
index|[
literal|1
index|]
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
name|p
index|[
literal|2
index|]
operator|=
operator|(
name|p1
index|[
literal|2
index|]
operator|+
name|p2
index|[
literal|2
index|]
operator|+
name|p3
index|[
literal|2
index|]
operator|+
name|p4
index|[
literal|2
index|]
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
name|p
index|[
literal|3
index|]
operator|=
literal|255
expr_stmt|;
break|break;
default|default:
name|p
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|p1
index|[
literal|0
index|]
operator|*
name|p1
index|[
literal|3
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|*
name|p2
index|[
literal|3
index|]
operator|+
name|p3
index|[
literal|0
index|]
operator|*
name|p3
index|[
literal|3
index|]
operator|+
name|p4
index|[
literal|0
index|]
operator|*
name|p4
index|[
literal|3
index|]
operator|+
operator|(
name|a
operator|>>
literal|1
operator|)
operator|)
operator|/
name|a
operator|)
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|p1
index|[
literal|1
index|]
operator|*
name|p1
index|[
literal|3
index|]
operator|+
name|p2
index|[
literal|1
index|]
operator|*
name|p2
index|[
literal|3
index|]
operator|+
name|p3
index|[
literal|1
index|]
operator|*
name|p3
index|[
literal|3
index|]
operator|+
name|p4
index|[
literal|1
index|]
operator|*
name|p4
index|[
literal|3
index|]
operator|+
operator|(
name|a
operator|>>
literal|1
operator|)
operator|)
operator|/
name|a
operator|)
expr_stmt|;
name|p
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|p1
index|[
literal|2
index|]
operator|*
name|p1
index|[
literal|3
index|]
operator|+
name|p2
index|[
literal|2
index|]
operator|*
name|p2
index|[
literal|3
index|]
operator|+
name|p3
index|[
literal|2
index|]
operator|*
name|p3
index|[
literal|3
index|]
operator|+
name|p4
index|[
literal|2
index|]
operator|*
name|p4
index|[
literal|3
index|]
operator|+
operator|(
name|a
operator|>>
literal|1
operator|)
operator|)
operator|/
name|a
operator|)
expr_stmt|;
name|p
index|[
literal|3
index|]
operator|=
operator|(
name|a
operator|+
literal|2
operator|)
operator|>>
literal|2
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
specifier|inline
DECL|function|pixel_average2 (const guchar * p1,const guchar * p2,guchar * p,const gint bytes)
name|pixel_average2
parameter_list|(
specifier|const
name|guchar
modifier|*
name|p1
parameter_list|,
specifier|const
name|guchar
modifier|*
name|p2
parameter_list|,
name|guchar
modifier|*
name|p
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|)
block|{
switch|switch
condition|(
name|bytes
condition|)
block|{
case|case
literal|1
case|:
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|p1
index|[
literal|0
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
break|break;
case|case
literal|2
case|:
block|{
name|guint
name|a
init|=
name|p1
index|[
literal|1
index|]
operator|+
name|p2
index|[
literal|1
index|]
decl_stmt|;
switch|switch
condition|(
name|a
condition|)
block|{
case|case
literal|0
case|:
comment|/* all transparent */
name|p
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|510
case|:
comment|/* all opaque */
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|p1
index|[
literal|0
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
literal|255
expr_stmt|;
break|break;
default|default:
name|p
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|p1
index|[
literal|0
index|]
operator|*
name|p1
index|[
literal|1
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|*
name|p2
index|[
literal|1
index|]
operator|+
operator|(
name|a
operator|>>
literal|1
operator|)
operator|)
operator|/
name|a
operator|)
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
operator|(
name|a
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
literal|3
case|:
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|p1
index|[
literal|0
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
operator|(
name|p1
index|[
literal|1
index|]
operator|+
name|p2
index|[
literal|1
index|]
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
name|p
index|[
literal|2
index|]
operator|=
operator|(
name|p1
index|[
literal|2
index|]
operator|+
name|p2
index|[
literal|2
index|]
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
break|break;
case|case
literal|4
case|:
block|{
name|guint
name|a
init|=
name|p1
index|[
literal|3
index|]
operator|+
name|p2
index|[
literal|3
index|]
decl_stmt|;
switch|switch
condition|(
name|a
condition|)
block|{
case|case
literal|0
case|:
comment|/* all transparent */
name|p
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
operator|=
name|p
index|[
literal|2
index|]
operator|=
name|p
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|510
case|:
comment|/* all opaque */
name|p
index|[
literal|0
index|]
operator|=
operator|(
name|p1
index|[
literal|0
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
operator|(
name|p1
index|[
literal|1
index|]
operator|+
name|p2
index|[
literal|1
index|]
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
name|p
index|[
literal|2
index|]
operator|=
operator|(
name|p1
index|[
literal|2
index|]
operator|+
name|p2
index|[
literal|2
index|]
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
name|p
index|[
literal|3
index|]
operator|=
literal|255
expr_stmt|;
break|break;
default|default:
name|p
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|p1
index|[
literal|0
index|]
operator|*
name|p1
index|[
literal|3
index|]
operator|+
name|p2
index|[
literal|0
index|]
operator|*
name|p2
index|[
literal|3
index|]
operator|+
operator|(
name|a
operator|>>
literal|1
operator|)
operator|)
operator|/
name|a
operator|)
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|p1
index|[
literal|1
index|]
operator|*
name|p1
index|[
literal|3
index|]
operator|+
name|p2
index|[
literal|1
index|]
operator|*
name|p2
index|[
literal|3
index|]
operator|+
operator|(
name|a
operator|>>
literal|1
operator|)
operator|)
operator|/
name|a
operator|)
expr_stmt|;
name|p
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|p1
index|[
literal|2
index|]
operator|*
name|p1
index|[
literal|3
index|]
operator|+
name|p2
index|[
literal|2
index|]
operator|*
name|p2
index|[
literal|3
index|]
operator|+
operator|(
name|a
operator|>>
literal|1
operator|)
operator|)
operator|/
name|a
operator|)
expr_stmt|;
name|p
index|[
literal|3
index|]
operator|=
operator|(
name|a
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|decimate_average_xy (PixelSurround * surround,const gint x0,const gint y0,const gint bytes,guchar * pixel)
name|decimate_average_xy
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
block|{
name|gint
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|src
init|=
name|pixel_surround_lock
argument_list|(
name|surround
argument_list|,
name|x0
argument_list|,
name|y0
argument_list|,
operator|&
name|stride
argument_list|)
decl_stmt|;
name|pixel_average4
argument_list|(
name|src
argument_list|,
name|src
operator|+
name|bytes
argument_list|,
name|src
operator|+
name|stride
argument_list|,
name|src
operator|+
name|stride
operator|+
name|bytes
argument_list|,
name|pixel
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|decimate_average_x (PixelSurround * surround,const gint x0,const gint y0,const gint bytes,guchar * pixel)
name|decimate_average_x
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
block|{
name|gint
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|src
init|=
name|pixel_surround_lock
argument_list|(
name|surround
argument_list|,
name|x0
argument_list|,
name|y0
argument_list|,
operator|&
name|stride
argument_list|)
decl_stmt|;
name|pixel_average2
argument_list|(
name|src
argument_list|,
name|src
operator|+
name|bytes
argument_list|,
name|pixel
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|decimate_average_y (PixelSurround * surround,const gint x0,const gint y0,const gint bytes,guchar * pixel)
name|decimate_average_y
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
block|{
name|gint
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|src
init|=
name|pixel_surround_lock
argument_list|(
name|surround
argument_list|,
name|x0
argument_list|,
name|y0
argument_list|,
operator|&
name|stride
argument_list|)
decl_stmt|;
name|pixel_average2
argument_list|(
name|src
argument_list|,
name|src
operator|+
name|stride
argument_list|,
name|pixel
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|gdouble
DECL|function|sinc (const gdouble x)
name|sinc
parameter_list|(
specifier|const
name|gdouble
name|x
parameter_list|)
block|{
name|gdouble
name|y
init|=
name|x
operator|*
name|G_PI
decl_stmt|;
if|if
condition|(
name|ABS
argument_list|(
name|x
argument_list|)
operator|<
name|LANCZOS_MIN
condition|)
return|return
literal|1.0
return|;
return|return
name|sin
argument_list|(
name|y
argument_list|)
operator|/
name|y
return|;
block|}
end_function

begin_comment
comment|/*  * allocate and fill lookup table of Lanczos windowed sinc function  * use gfloat since errors due to granularity of array far exceed  * data precision  */
end_comment

begin_function
name|gfloat
modifier|*
DECL|function|create_lanczos_lookup (void)
name|create_lanczos_lookup
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|gdouble
name|dx
init|=
name|LANCZOS_WIDTH
operator|/
call|(
name|gdouble
call|)
argument_list|(
name|LANCZOS_SAMPLES
operator|-
literal|1
argument_list|)
decl_stmt|;
name|gfloat
modifier|*
name|lookup
init|=
name|g_new
argument_list|(
name|gfloat
argument_list|,
name|LANCZOS_SAMPLES
argument_list|)
decl_stmt|;
name|gdouble
name|x
init|=
literal|0.0
decl_stmt|;
name|gint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LANCZOS_SAMPLES
condition|;
name|i
operator|++
control|)
block|{
name|lookup
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|ABS
argument_list|(
name|x
argument_list|)
operator|<
name|LANCZOS_WIDTH
operator|)
condition|?
operator|(
name|sinc
argument_list|(
name|x
argument_list|)
operator|*
name|sinc
argument_list|(
name|x
operator|/
name|LANCZOS_WIDTH
argument_list|)
operator|)
else|:
literal|0.0
operator|)
expr_stmt|;
name|x
operator|+=
name|dx
expr_stmt|;
block|}
return|return
name|lookup
return|;
block|}
end_function

begin_function
specifier|static
name|gfloat
modifier|*
DECL|function|create_lanczos3_lookup (void)
name|create_lanczos3_lookup
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|gdouble
name|dx
init|=
literal|3.0
operator|/
call|(
name|gdouble
call|)
argument_list|(
name|LANCZOS_SAMPLES
operator|-
literal|1
argument_list|)
decl_stmt|;
name|gfloat
modifier|*
name|lookup
init|=
name|g_new
argument_list|(
name|gfloat
argument_list|,
name|LANCZOS_SAMPLES
argument_list|)
decl_stmt|;
name|gdouble
name|x
init|=
literal|0.0
decl_stmt|;
name|gint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LANCZOS_SAMPLES
condition|;
name|i
operator|++
control|)
block|{
name|lookup
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|ABS
argument_list|(
name|x
argument_list|)
operator|<
literal|3.0
operator|)
condition|?
operator|(
name|sinc
argument_list|(
name|x
argument_list|)
operator|*
name|sinc
argument_list|(
name|x
operator|/
literal|3.0
argument_list|)
operator|)
else|:
literal|0.0
operator|)
expr_stmt|;
name|x
operator|+=
name|dx
expr_stmt|;
block|}
return|return
name|lookup
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|interpolate_nearest (TileManager * srcTM,const gint x0,const gint y0,const gdouble xfrac,const gdouble yfrac,guchar * pixel)
name|interpolate_nearest
parameter_list|(
name|TileManager
modifier|*
name|srcTM
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
block|{
specifier|const
name|gint
name|w
init|=
name|tile_manager_width
argument_list|(
name|srcTM
argument_list|)
operator|-
literal|1
decl_stmt|;
specifier|const
name|gint
name|h
init|=
name|tile_manager_height
argument_list|(
name|srcTM
argument_list|)
operator|-
literal|1
decl_stmt|;
specifier|const
name|gint
name|x
init|=
operator|(
name|xfrac
operator|<=
literal|0.5
operator|)
condition|?
name|x0
else|:
name|x0
operator|+
literal|1
decl_stmt|;
specifier|const
name|gint
name|y
init|=
operator|(
name|yfrac
operator|<=
literal|0.5
operator|)
condition|?
name|y0
else|:
name|y0
operator|+
literal|1
decl_stmt|;
name|tile_manager_read_pixel_data_1
argument_list|(
name|srcTM
argument_list|,
name|CLAMP
argument_list|(
name|x
argument_list|,
literal|0
argument_list|,
name|w
argument_list|)
argument_list|,
name|CLAMP
argument_list|(
name|y
argument_list|,
literal|0
argument_list|,
name|h
argument_list|)
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|gdouble
DECL|function|weighted_sum (const gdouble dx,const gdouble dy,const gint s00,const gint s10,const gint s01,const gint s11)
name|weighted_sum
parameter_list|(
specifier|const
name|gdouble
name|dx
parameter_list|,
specifier|const
name|gdouble
name|dy
parameter_list|,
specifier|const
name|gint
name|s00
parameter_list|,
specifier|const
name|gint
name|s10
parameter_list|,
specifier|const
name|gint
name|s01
parameter_list|,
specifier|const
name|gint
name|s11
parameter_list|)
block|{
return|return
operator|(
operator|(
literal|1
operator|-
name|dy
operator|)
operator|*
operator|(
operator|(
literal|1
operator|-
name|dx
operator|)
operator|*
name|s00
operator|+
name|dx
operator|*
name|s10
operator|)
operator|+
name|dy
operator|*
operator|(
operator|(
literal|1
operator|-
name|dx
operator|)
operator|*
name|s01
operator|+
name|dx
operator|*
name|s11
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|interpolate_bilinear (PixelSurround * surround,const gint x0,const gint y0,const gdouble xfrac,const gdouble yfrac,const gint bytes,guchar * pixel)
name|interpolate_bilinear
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
block|{
name|gint
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|src
init|=
name|pixel_surround_lock
argument_list|(
name|surround
argument_list|,
name|x0
argument_list|,
name|y0
argument_list|,
operator|&
name|stride
argument_list|)
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|p1
init|=
name|src
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|p2
init|=
name|p1
operator|+
name|bytes
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|p3
init|=
name|src
operator|+
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|p4
init|=
name|p3
operator|+
name|bytes
decl_stmt|;
name|gdouble
name|sum
decl_stmt|;
name|gdouble
name|alphasum
decl_stmt|;
name|gint
name|b
decl_stmt|;
switch|switch
condition|(
name|bytes
condition|)
block|{
case|case
literal|1
case|:
name|sum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
literal|0
index|]
argument_list|,
name|p2
index|[
literal|0
index|]
argument_list|,
name|p3
index|[
literal|0
index|]
argument_list|,
name|p4
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|pixel
index|[
literal|0
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|alphasum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
literal|1
index|]
argument_list|,
name|p2
index|[
literal|1
index|]
argument_list|,
name|p3
index|[
literal|1
index|]
argument_list|,
name|p4
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|alphasum
operator|>
literal|0
condition|)
block|{
name|sum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
literal|0
index|]
operator|*
name|p1
index|[
literal|1
index|]
argument_list|,
name|p2
index|[
literal|0
index|]
operator|*
name|p2
index|[
literal|1
index|]
argument_list|,
name|p3
index|[
literal|0
index|]
operator|*
name|p3
index|[
literal|1
index|]
argument_list|,
name|p4
index|[
literal|0
index|]
operator|*
name|p4
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|sum
operator|/=
name|alphasum
expr_stmt|;
name|pixel
index|[
literal|0
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|pixel
index|[
literal|1
index|]
operator|=
name|CLAMP
argument_list|(
name|alphasum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
block|{
name|sum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
name|b
index|]
argument_list|,
name|p2
index|[
name|b
index|]
argument_list|,
name|p3
index|[
name|b
index|]
argument_list|,
name|p4
index|[
name|b
index|]
argument_list|)
expr_stmt|;
name|pixel
index|[
name|b
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
name|alphasum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
literal|3
index|]
argument_list|,
name|p2
index|[
literal|3
index|]
argument_list|,
name|p3
index|[
literal|3
index|]
argument_list|,
name|p4
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|alphasum
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
block|{
name|sum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
name|b
index|]
operator|*
name|p1
index|[
literal|3
index|]
argument_list|,
name|p2
index|[
name|b
index|]
operator|*
name|p2
index|[
literal|3
index|]
argument_list|,
name|p3
index|[
name|b
index|]
operator|*
name|p3
index|[
literal|3
index|]
argument_list|,
name|p4
index|[
name|b
index|]
operator|*
name|p4
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|sum
operator|/=
name|alphasum
expr_stmt|;
name|pixel
index|[
name|b
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
name|pixel
index|[
literal|3
index|]
operator|=
name|CLAMP
argument_list|(
name|alphasum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
name|pixel
index|[
literal|2
index|]
operator|=
name|pixel
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Catmull-Rom spline - not bad   * basic intro http://www.mvps.org/directx/articles/catmull/   * This formula will calculate an interpolated point between pt1 and pt2   * dx=0 returns pt1; dx=1 returns pt2   */
end_comment

begin_function
specifier|static
specifier|inline
name|gdouble
DECL|function|cubic_spline_fit (const gdouble dx,const gdouble pt0,const gdouble pt1,const gdouble pt2,const gdouble pt3)
name|cubic_spline_fit
parameter_list|(
specifier|const
name|gdouble
name|dx
parameter_list|,
specifier|const
name|gdouble
name|pt0
parameter_list|,
specifier|const
name|gdouble
name|pt1
parameter_list|,
specifier|const
name|gdouble
name|pt2
parameter_list|,
specifier|const
name|gdouble
name|pt3
parameter_list|)
block|{
return|return
call|(
name|gdouble
call|)
argument_list|(
operator|(
operator|(
operator|(
operator|-
name|pt0
operator|+
literal|3
operator|*
name|pt1
operator|-
literal|3
operator|*
name|pt2
operator|+
name|pt3
operator|)
operator|*
name|dx
operator|+
operator|(
literal|2
operator|*
name|pt0
operator|-
literal|5
operator|*
name|pt1
operator|+
literal|4
operator|*
name|pt2
operator|-
name|pt3
operator|)
operator|)
operator|*
name|dx
operator|+
operator|(
operator|-
name|pt0
operator|+
name|pt2
operator|)
operator|)
operator|*
name|dx
operator|+
operator|(
name|pt1
operator|+
name|pt1
operator|)
argument_list|)
operator|/
literal|2.0
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|interpolate_cubic (PixelSurround * surround,const gint x0,const gint y0,const gdouble xfrac,const gdouble yfrac,const gint bytes,guchar * pixel)
name|interpolate_cubic
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
block|{
name|gint
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|src
init|=
name|pixel_surround_lock
argument_list|(
name|surround
argument_list|,
name|x0
operator|-
literal|1
argument_list|,
name|y0
operator|-
literal|1
argument_list|,
operator|&
name|stride
argument_list|)
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|s0
init|=
name|src
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|s1
init|=
name|s0
operator|+
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|s2
init|=
name|s1
operator|+
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|s3
init|=
name|s2
operator|+
name|stride
decl_stmt|;
name|gint
name|b
decl_stmt|;
name|gdouble
name|p0
decl_stmt|,
name|p1
decl_stmt|,
name|p2
decl_stmt|,
name|p3
decl_stmt|;
name|gdouble
name|sum
decl_stmt|,
name|alphasum
decl_stmt|;
switch|switch
condition|(
name|bytes
condition|)
block|{
case|case
literal|1
case|:
name|p0
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s0
index|[
literal|0
index|]
argument_list|,
name|s0
index|[
literal|1
index|]
argument_list|,
name|s0
index|[
literal|2
index|]
argument_list|,
name|s0
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|p1
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s1
index|[
literal|0
index|]
argument_list|,
name|s1
index|[
literal|1
index|]
argument_list|,
name|s1
index|[
literal|2
index|]
argument_list|,
name|s1
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|p2
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s2
index|[
literal|0
index|]
argument_list|,
name|s2
index|[
literal|1
index|]
argument_list|,
name|s2
index|[
literal|2
index|]
argument_list|,
name|s2
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|p3
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s3
index|[
literal|0
index|]
argument_list|,
name|s3
index|[
literal|1
index|]
argument_list|,
name|s3
index|[
literal|2
index|]
argument_list|,
name|s3
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|sum
operator|=
name|cubic_spline_fit
argument_list|(
name|yfrac
argument_list|,
name|p0
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
name|p3
argument_list|)
expr_stmt|;
name|pixel
index|[
literal|0
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|p0
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s0
index|[
literal|1
index|]
argument_list|,
name|s0
index|[
literal|3
index|]
argument_list|,
name|s0
index|[
literal|5
index|]
argument_list|,
name|s0
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|p1
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s1
index|[
literal|1
index|]
argument_list|,
name|s1
index|[
literal|3
index|]
argument_list|,
name|s1
index|[
literal|5
index|]
argument_list|,
name|s1
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|p2
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s2
index|[
literal|1
index|]
argument_list|,
name|s2
index|[
literal|3
index|]
argument_list|,
name|s2
index|[
literal|5
index|]
argument_list|,
name|s2
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|p3
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s3
index|[
literal|1
index|]
argument_list|,
name|s3
index|[
literal|3
index|]
argument_list|,
name|s3
index|[
literal|5
index|]
argument_list|,
name|s3
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|alphasum
operator|=
name|cubic_spline_fit
argument_list|(
name|yfrac
argument_list|,
name|p0
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
name|p3
argument_list|)
expr_stmt|;
if|if
condition|(
name|alphasum
operator|>
literal|0
condition|)
block|{
name|p0
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s0
index|[
literal|0
index|]
operator|*
name|s0
index|[
literal|1
index|]
argument_list|,
name|s0
index|[
literal|2
index|]
operator|*
name|s0
index|[
literal|3
index|]
argument_list|,
name|s0
index|[
literal|4
index|]
operator|*
name|s0
index|[
literal|5
index|]
argument_list|,
name|s0
index|[
literal|6
index|]
operator|*
name|s0
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|p1
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s1
index|[
literal|0
index|]
operator|*
name|s1
index|[
literal|1
index|]
argument_list|,
name|s1
index|[
literal|2
index|]
operator|*
name|s1
index|[
literal|3
index|]
argument_list|,
name|s1
index|[
literal|4
index|]
operator|*
name|s1
index|[
literal|5
index|]
argument_list|,
name|s1
index|[
literal|6
index|]
operator|*
name|s1
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|p2
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s2
index|[
literal|0
index|]
operator|*
name|s2
index|[
literal|1
index|]
argument_list|,
name|s2
index|[
literal|2
index|]
operator|*
name|s2
index|[
literal|3
index|]
argument_list|,
name|s2
index|[
literal|4
index|]
operator|*
name|s2
index|[
literal|5
index|]
argument_list|,
name|s2
index|[
literal|6
index|]
operator|*
name|s2
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|p3
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s3
index|[
literal|0
index|]
operator|*
name|s3
index|[
literal|1
index|]
argument_list|,
name|s3
index|[
literal|2
index|]
operator|*
name|s3
index|[
literal|3
index|]
argument_list|,
name|s3
index|[
literal|4
index|]
operator|*
name|s3
index|[
literal|5
index|]
argument_list|,
name|s3
index|[
literal|6
index|]
operator|*
name|s3
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|sum
operator|=
name|cubic_spline_fit
argument_list|(
name|yfrac
argument_list|,
name|p0
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
name|p3
argument_list|)
expr_stmt|;
name|sum
operator|/=
name|alphasum
expr_stmt|;
name|pixel
index|[
literal|0
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|pixel
index|[
literal|1
index|]
operator|=
name|CLAMP
argument_list|(
name|alphasum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
block|{
name|p0
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s0
index|[
name|b
index|]
argument_list|,
name|s0
index|[
literal|3
operator|+
name|b
index|]
argument_list|,
name|s0
index|[
literal|6
operator|+
name|b
index|]
argument_list|,
name|s0
index|[
literal|9
operator|+
name|b
index|]
argument_list|)
expr_stmt|;
name|p1
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s1
index|[
name|b
index|]
argument_list|,
name|s1
index|[
literal|3
operator|+
name|b
index|]
argument_list|,
name|s1
index|[
literal|6
operator|+
name|b
index|]
argument_list|,
name|s1
index|[
literal|9
operator|+
name|b
index|]
argument_list|)
expr_stmt|;
name|p2
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s2
index|[
name|b
index|]
argument_list|,
name|s2
index|[
literal|3
operator|+
name|b
index|]
argument_list|,
name|s2
index|[
literal|6
operator|+
name|b
index|]
argument_list|,
name|s2
index|[
literal|9
operator|+
name|b
index|]
argument_list|)
expr_stmt|;
name|p3
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s3
index|[
name|b
index|]
argument_list|,
name|s3
index|[
literal|3
operator|+
name|b
index|]
argument_list|,
name|s3
index|[
literal|6
operator|+
name|b
index|]
argument_list|,
name|s3
index|[
literal|9
operator|+
name|b
index|]
argument_list|)
expr_stmt|;
name|sum
operator|=
name|cubic_spline_fit
argument_list|(
name|yfrac
argument_list|,
name|p0
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
name|p3
argument_list|)
expr_stmt|;
name|pixel
index|[
name|b
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
name|p0
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s0
index|[
literal|3
index|]
argument_list|,
name|s0
index|[
literal|7
index|]
argument_list|,
name|s0
index|[
literal|11
index|]
argument_list|,
name|s0
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|p1
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s1
index|[
literal|3
index|]
argument_list|,
name|s1
index|[
literal|7
index|]
argument_list|,
name|s1
index|[
literal|11
index|]
argument_list|,
name|s1
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|p2
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s2
index|[
literal|3
index|]
argument_list|,
name|s2
index|[
literal|7
index|]
argument_list|,
name|s2
index|[
literal|11
index|]
argument_list|,
name|s2
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|p3
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s3
index|[
literal|3
index|]
argument_list|,
name|s3
index|[
literal|7
index|]
argument_list|,
name|s3
index|[
literal|11
index|]
argument_list|,
name|s3
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|alphasum
operator|=
name|cubic_spline_fit
argument_list|(
name|yfrac
argument_list|,
name|p0
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
name|p3
argument_list|)
expr_stmt|;
if|if
condition|(
name|alphasum
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
block|{
name|p0
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s0
index|[
literal|0
operator|+
name|b
index|]
operator|*
name|s0
index|[
literal|3
index|]
argument_list|,
name|s0
index|[
literal|4
operator|+
name|b
index|]
operator|*
name|s0
index|[
literal|7
index|]
argument_list|,
name|s0
index|[
literal|8
operator|+
name|b
index|]
operator|*
name|s0
index|[
literal|11
index|]
argument_list|,
name|s0
index|[
literal|12
operator|+
name|b
index|]
operator|*
name|s0
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|p1
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s1
index|[
literal|0
operator|+
name|b
index|]
operator|*
name|s1
index|[
literal|3
index|]
argument_list|,
name|s1
index|[
literal|4
operator|+
name|b
index|]
operator|*
name|s1
index|[
literal|7
index|]
argument_list|,
name|s1
index|[
literal|8
operator|+
name|b
index|]
operator|*
name|s1
index|[
literal|11
index|]
argument_list|,
name|s1
index|[
literal|12
operator|+
name|b
index|]
operator|*
name|s1
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|p2
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s2
index|[
literal|0
operator|+
name|b
index|]
operator|*
name|s2
index|[
literal|3
index|]
argument_list|,
name|s2
index|[
literal|4
operator|+
name|b
index|]
operator|*
name|s2
index|[
literal|7
index|]
argument_list|,
name|s2
index|[
literal|8
operator|+
name|b
index|]
operator|*
name|s2
index|[
literal|11
index|]
argument_list|,
name|s2
index|[
literal|12
operator|+
name|b
index|]
operator|*
name|s2
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|p3
operator|=
name|cubic_spline_fit
argument_list|(
name|xfrac
argument_list|,
name|s3
index|[
literal|0
operator|+
name|b
index|]
operator|*
name|s3
index|[
literal|3
index|]
argument_list|,
name|s3
index|[
literal|4
operator|+
name|b
index|]
operator|*
name|s3
index|[
literal|7
index|]
argument_list|,
name|s3
index|[
literal|8
operator|+
name|b
index|]
operator|*
name|s3
index|[
literal|11
index|]
argument_list|,
name|s3
index|[
literal|12
operator|+
name|b
index|]
operator|*
name|s3
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|sum
operator|=
name|cubic_spline_fit
argument_list|(
name|yfrac
argument_list|,
name|p0
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
name|p3
argument_list|)
expr_stmt|;
name|sum
operator|/=
name|alphasum
expr_stmt|;
name|pixel
index|[
name|b
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
name|pixel
index|[
literal|3
index|]
operator|=
name|CLAMP
argument_list|(
name|alphasum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
name|pixel
index|[
literal|2
index|]
operator|=
name|pixel
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|gdouble
specifier|inline
DECL|function|lanczos3_mul_alpha (const guchar * pixels,const gdouble * x_kernel,const gdouble * y_kernel,const gint stride,const gint bytes,const gint byte)
name|lanczos3_mul_alpha
parameter_list|(
specifier|const
name|guchar
modifier|*
name|pixels
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|x_kernel
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|y_kernel
parameter_list|,
specifier|const
name|gint
name|stride
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
specifier|const
name|gint
name|byte
parameter_list|)
block|{
specifier|const
name|guchar
modifier|*
name|row
init|=
name|pixels
decl_stmt|;
specifier|const
name|guchar
name|alpha
init|=
name|bytes
operator|-
literal|1
decl_stmt|;
name|gdouble
name|sum
init|=
literal|0.0
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
literal|6
condition|;
name|y
operator|++
operator|,
name|row
operator|+=
name|stride
control|)
block|{
specifier|const
name|guchar
modifier|*
name|p
init|=
name|row
decl_stmt|;
name|gdouble
name|tmpsum
init|=
literal|0.0
decl_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
literal|6
condition|;
name|x
operator|++
operator|,
name|p
operator|+=
name|bytes
control|)
block|{
name|tmpsum
operator|+=
name|x_kernel
index|[
name|x
index|]
operator|*
name|p
index|[
name|byte
index|]
operator|*
name|p
index|[
name|alpha
index|]
expr_stmt|;
block|}
name|tmpsum
operator|*=
name|y_kernel
index|[
name|y
index|]
expr_stmt|;
name|sum
operator|+=
name|tmpsum
expr_stmt|;
block|}
return|return
name|sum
return|;
block|}
end_function

begin_function
specifier|static
name|gdouble
specifier|inline
DECL|function|lanczos3_mul (const guchar * pixels,const gdouble * x_kernel,const gdouble * y_kernel,const gint stride,const gint bytes,const gint byte)
name|lanczos3_mul
parameter_list|(
specifier|const
name|guchar
modifier|*
name|pixels
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|x_kernel
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|y_kernel
parameter_list|,
specifier|const
name|gint
name|stride
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
specifier|const
name|gint
name|byte
parameter_list|)
block|{
specifier|const
name|guchar
modifier|*
name|row
init|=
name|pixels
decl_stmt|;
name|gdouble
name|sum
init|=
literal|0.0
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
literal|6
condition|;
name|y
operator|++
operator|,
name|row
operator|+=
name|stride
control|)
block|{
specifier|const
name|guchar
modifier|*
name|p
init|=
name|row
decl_stmt|;
name|gdouble
name|tmpsum
init|=
literal|0.0
decl_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
literal|6
condition|;
name|x
operator|++
operator|,
name|p
operator|+=
name|bytes
control|)
block|{
name|tmpsum
operator|+=
name|x_kernel
index|[
name|x
index|]
operator|*
name|p
index|[
name|byte
index|]
expr_stmt|;
block|}
name|tmpsum
operator|*=
name|y_kernel
index|[
name|y
index|]
expr_stmt|;
name|sum
operator|+=
name|tmpsum
expr_stmt|;
block|}
return|return
name|sum
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|interpolate_lanczos3 (PixelSurround * surround,const gint x0,const gint y0,const gdouble xfrac,const gdouble yfrac,const gint bytes,guchar * pixel,const gfloat * kernel_lookup)
name|interpolate_lanczos3
parameter_list|(
name|PixelSurround
modifier|*
name|surround
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
specifier|const
name|gint
name|bytes
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|,
specifier|const
name|gfloat
modifier|*
name|kernel_lookup
parameter_list|)
block|{
name|gint
name|stride
decl_stmt|;
specifier|const
name|guchar
modifier|*
name|src
init|=
name|pixel_surround_lock
argument_list|(
name|surround
argument_list|,
name|x0
operator|-
literal|2
argument_list|,
name|y0
operator|-
literal|2
argument_list|,
operator|&
name|stride
argument_list|)
decl_stmt|;
specifier|const
name|gint
name|x_shift
init|=
call|(
name|gint
call|)
argument_list|(
name|xfrac
operator|*
name|LANCZOS_SPP
operator|+
literal|0.5
argument_list|)
decl_stmt|;
specifier|const
name|gint
name|y_shift
init|=
call|(
name|gint
call|)
argument_list|(
name|yfrac
operator|*
name|LANCZOS_SPP
operator|+
literal|0.5
argument_list|)
decl_stmt|;
name|gint
name|b
decl_stmt|,
name|i
decl_stmt|;
name|gdouble
name|kx_sum
decl_stmt|,
name|ky_sum
decl_stmt|;
name|gdouble
name|x_kernel
index|[
literal|6
index|]
decl_stmt|;
name|gdouble
name|y_kernel
index|[
literal|6
index|]
decl_stmt|;
name|gdouble
name|sum
decl_stmt|,
name|alphasum
decl_stmt|;
name|kx_sum
operator|=
name|ky_sum
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|>=
operator|-
literal|2
condition|;
name|i
operator|--
control|)
block|{
name|gint
name|pos
init|=
name|i
operator|*
name|LANCZOS_SPP
decl_stmt|;
name|kx_sum
operator|+=
name|x_kernel
index|[
literal|2
operator|+
name|i
index|]
operator|=
name|kernel_lookup
index|[
name|ABS
argument_list|(
name|x_shift
operator|-
name|pos
argument_list|)
index|]
expr_stmt|;
name|ky_sum
operator|+=
name|y_kernel
index|[
literal|2
operator|+
name|i
index|]
operator|=
name|kernel_lookup
index|[
name|ABS
argument_list|(
name|y_shift
operator|-
name|pos
argument_list|)
index|]
expr_stmt|;
block|}
comment|/* normalise the kernel arrays */
for|for
control|(
name|i
operator|=
operator|-
literal|2
init|;
name|i
operator|<=
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|x_kernel
index|[
literal|2
operator|+
name|i
index|]
operator|/=
name|kx_sum
expr_stmt|;
name|y_kernel
index|[
literal|2
operator|+
name|i
index|]
operator|/=
name|ky_sum
expr_stmt|;
block|}
switch|switch
condition|(
name|bytes
condition|)
block|{
case|case
literal|1
case|:
name|sum
operator|=
name|lanczos3_mul
argument_list|(
name|src
argument_list|,
name|x_kernel
argument_list|,
name|y_kernel
argument_list|,
name|stride
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pixel
index|[
literal|0
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|alphasum
operator|=
name|lanczos3_mul
argument_list|(
name|src
argument_list|,
name|x_kernel
argument_list|,
name|y_kernel
argument_list|,
name|stride
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|alphasum
operator|>
literal|0
condition|)
block|{
name|sum
operator|=
name|lanczos3_mul_alpha
argument_list|(
name|src
argument_list|,
name|x_kernel
argument_list|,
name|y_kernel
argument_list|,
name|stride
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sum
operator|/=
name|alphasum
expr_stmt|;
name|pixel
index|[
literal|0
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|pixel
index|[
literal|1
index|]
operator|=
name|CLAMP
argument_list|(
name|alphasum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
block|{
name|sum
operator|=
name|lanczos3_mul
argument_list|(
name|src
argument_list|,
name|x_kernel
argument_list|,
name|y_kernel
argument_list|,
name|stride
argument_list|,
literal|3
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|pixel
index|[
name|b
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
name|alphasum
operator|=
name|lanczos3_mul
argument_list|(
name|src
argument_list|,
name|x_kernel
argument_list|,
name|y_kernel
argument_list|,
name|stride
argument_list|,
literal|4
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|alphasum
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
block|{
name|sum
operator|=
name|lanczos3_mul_alpha
argument_list|(
name|src
argument_list|,
name|x_kernel
argument_list|,
name|y_kernel
argument_list|,
name|stride
argument_list|,
literal|4
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|sum
operator|/=
name|alphasum
expr_stmt|;
name|pixel
index|[
name|b
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
name|pixel
index|[
literal|3
index|]
operator|=
name|CLAMP
argument_list|(
name|alphasum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
name|pixel
index|[
literal|2
index|]
operator|=
name|pixel
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|scale_region_buffer (PixelRegion * srcPR,PixelRegion * dstPR)
name|scale_region_buffer
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
name|PixelRegion
modifier|*
name|dstPR
parameter_list|)
block|{
specifier|const
name|gdouble
name|scalex
init|=
operator|(
name|gdouble
operator|)
name|dstPR
operator|->
name|w
operator|/
operator|(
name|gdouble
operator|)
name|srcPR
operator|->
name|w
decl_stmt|;
specifier|const
name|gdouble
name|scaley
init|=
operator|(
name|gdouble
operator|)
name|dstPR
operator|->
name|h
operator|/
operator|(
name|gdouble
operator|)
name|srcPR
operator|->
name|h
decl_stmt|;
specifier|const
name|gint
name|src_width
init|=
name|srcPR
operator|->
name|w
decl_stmt|;
specifier|const
name|gint
name|src_height
init|=
name|srcPR
operator|->
name|h
decl_stmt|;
specifier|const
name|gint
name|bytes
init|=
name|srcPR
operator|->
name|bytes
decl_stmt|;
specifier|const
name|gint
name|dst_width
init|=
name|dstPR
operator|->
name|w
decl_stmt|;
specifier|const
name|gint
name|dst_height
init|=
name|dstPR
operator|->
name|h
decl_stmt|;
name|guchar
modifier|*
name|pixel
init|=
name|dstPR
operator|->
name|data
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|dst_height
condition|;
name|y
operator|++
control|)
block|{
name|gdouble
name|yfrac
init|=
operator|(
name|y
operator|/
name|scaley
operator|)
decl_stmt|;
name|gint
name|sy0
init|=
operator|(
name|gint
operator|)
name|yfrac
decl_stmt|;
name|gint
name|sy1
init|=
name|sy0
operator|+
literal|1
decl_stmt|;
name|sy1
operator|=
operator|(
name|sy1
operator|<
name|src_height
operator|-
literal|1
operator|)
condition|?
name|sy1
else|:
name|src_height
operator|-
literal|1
expr_stmt|;
name|yfrac
operator|=
name|yfrac
operator|-
name|sy0
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|dst_width
condition|;
name|x
operator|++
control|)
block|{
name|gdouble
name|xfrac
init|=
operator|(
name|x
operator|/
name|scalex
operator|)
decl_stmt|;
name|gint
name|sx0
init|=
operator|(
name|gint
operator|)
name|xfrac
decl_stmt|;
name|gint
name|sx1
init|=
name|sx0
operator|+
literal|1
decl_stmt|;
name|sx1
operator|=
operator|(
name|sx1
operator|<
name|src_width
operator|-
literal|1
operator|)
condition|?
name|sx1
else|:
name|src_width
operator|-
literal|1
expr_stmt|;
name|xfrac
operator|=
name|xfrac
operator|-
name|sx0
expr_stmt|;
name|interpolate_bilinear_pr
argument_list|(
name|srcPR
argument_list|,
name|sx0
argument_list|,
name|sy0
argument_list|,
name|sx1
argument_list|,
name|sy1
argument_list|,
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|pixel
argument_list|)
expr_stmt|;
name|pixel
operator|+=
name|bytes
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|interpolate_bilinear_pr (PixelRegion * srcPR,const gint x0,const gint y0,const gint x1,const gint y1,const gdouble xfrac,const gdouble yfrac,guchar * pixel)
name|interpolate_bilinear_pr
parameter_list|(
name|PixelRegion
modifier|*
name|srcPR
parameter_list|,
specifier|const
name|gint
name|x0
parameter_list|,
specifier|const
name|gint
name|y0
parameter_list|,
specifier|const
name|gint
name|x1
parameter_list|,
specifier|const
name|gint
name|y1
parameter_list|,
specifier|const
name|gdouble
name|xfrac
parameter_list|,
specifier|const
name|gdouble
name|yfrac
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
block|{
specifier|const
name|gint
name|bytes
init|=
name|srcPR
operator|->
name|bytes
decl_stmt|;
specifier|const
name|gint
name|width
init|=
name|srcPR
operator|->
name|w
decl_stmt|;
name|guchar
modifier|*
name|p1
init|=
name|srcPR
operator|->
name|data
operator|+
operator|(
name|y0
operator|*
name|width
operator|+
name|x0
operator|)
operator|*
name|bytes
decl_stmt|;
name|guchar
modifier|*
name|p2
init|=
name|srcPR
operator|->
name|data
operator|+
operator|(
name|y0
operator|*
name|width
operator|+
name|x1
operator|)
operator|*
name|bytes
decl_stmt|;
name|guchar
modifier|*
name|p3
init|=
name|srcPR
operator|->
name|data
operator|+
operator|(
name|y1
operator|*
name|width
operator|+
name|x0
operator|)
operator|*
name|bytes
decl_stmt|;
name|guchar
modifier|*
name|p4
init|=
name|srcPR
operator|->
name|data
operator|+
operator|(
name|y1
operator|*
name|width
operator|+
name|x1
operator|)
operator|*
name|bytes
decl_stmt|;
name|gint
name|b
decl_stmt|;
name|gdouble
name|sum
decl_stmt|,
name|alphasum
decl_stmt|;
switch|switch
condition|(
name|bytes
condition|)
block|{
case|case
literal|1
case|:
name|sum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
literal|0
index|]
argument_list|,
name|p2
index|[
literal|0
index|]
argument_list|,
name|p3
index|[
literal|0
index|]
argument_list|,
name|p4
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|pixel
index|[
literal|0
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|alphasum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
literal|1
index|]
argument_list|,
name|p2
index|[
literal|1
index|]
argument_list|,
name|p3
index|[
literal|1
index|]
argument_list|,
name|p4
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|alphasum
operator|>
literal|0
condition|)
block|{
name|sum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
literal|0
index|]
operator|*
name|p1
index|[
literal|1
index|]
argument_list|,
name|p2
index|[
literal|0
index|]
operator|*
name|p2
index|[
literal|1
index|]
argument_list|,
name|p3
index|[
literal|0
index|]
operator|*
name|p3
index|[
literal|1
index|]
argument_list|,
name|p4
index|[
literal|0
index|]
operator|*
name|p4
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|sum
operator|/=
name|alphasum
expr_stmt|;
name|pixel
index|[
literal|0
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|pixel
index|[
literal|1
index|]
operator|=
name|CLAMP
argument_list|(
name|alphasum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
block|{
name|sum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
name|b
index|]
argument_list|,
name|p2
index|[
name|b
index|]
argument_list|,
name|p3
index|[
name|b
index|]
argument_list|,
name|p4
index|[
name|b
index|]
argument_list|)
expr_stmt|;
name|pixel
index|[
name|b
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
name|alphasum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
literal|3
index|]
argument_list|,
name|p2
index|[
literal|3
index|]
argument_list|,
name|p3
index|[
literal|3
index|]
argument_list|,
name|p4
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|alphasum
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
block|{
name|sum
operator|=
name|weighted_sum
argument_list|(
name|xfrac
argument_list|,
name|yfrac
argument_list|,
name|p1
index|[
name|b
index|]
operator|*
name|p1
index|[
literal|3
index|]
argument_list|,
name|p2
index|[
name|b
index|]
operator|*
name|p2
index|[
literal|3
index|]
argument_list|,
name|p3
index|[
name|b
index|]
operator|*
name|p3
index|[
literal|3
index|]
argument_list|,
name|p4
index|[
name|b
index|]
operator|*
name|p4
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|sum
operator|/=
name|alphasum
expr_stmt|;
name|pixel
index|[
name|b
index|]
operator|=
name|CLAMP
argument_list|(
name|sum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
name|pixel
index|[
literal|3
index|]
operator|=
name|CLAMP
argument_list|(
name|alphasum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
name|pixel
index|[
literal|2
index|]
operator|=
name|pixel
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

end_unit

