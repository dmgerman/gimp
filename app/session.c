begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* Session-managment stuff   Copyright (C) 1998 Sven Neumann<sven@gimp.org>     I include a short description here on what is done and what problems     are left:     Since everything saved in sessionrc changes often (with each session?)     the whole file is rewritten each time the gimp exits. I don't see any    use in implementing a more flexible scheme like it is used for gimprc.     Right now session-managment is limited to window geometry. Restoring     openend images is planned, but I'm still not sure how to deal with dirty    images.     Dialogs are now reopened if the gimp is called with the command-line-option    --restore-session or if the related entry is set in gimprc.    Probably there should alternatively be a list of dialogs in the preferences     that should always be opened on start-up.      Please point me into the right direction to make this work with Gnome-SM.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|"apptypes.h"
end_include

begin_include
include|#
directive|include
file|"app_procs.h"
end_include

begin_include
include|#
directive|include
file|"appenv.h"
end_include

begin_include
include|#
directive|include
file|"color_notebook.h"
end_include

begin_include
include|#
directive|include
file|"commands.h"
end_include

begin_include
include|#
directive|include
file|"gimprc.h"
end_include

begin_include
include|#
directive|include
file|"session.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpenv.h"
end_include

begin_define
DECL|macro|LEFT_OFFSET
define|#
directive|define
name|LEFT_OFFSET
value|60
end_define

begin_define
DECL|macro|TOP_OFFSET
define|#
directive|define
name|TOP_OFFSET
value|60
end_define

begin_function_decl
specifier|static
name|void
name|sessionrc_write_info
parameter_list|(
name|SessionInfo
modifier|*
name|info
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|session_open_dialog
parameter_list|(
name|SessionInfo
modifier|*
name|info
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|session_reset_open_state
parameter_list|(
name|SessionInfo
modifier|*
name|info
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|session_info_updates
name|GList
modifier|*
name|session_info_updates
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* global session variables */
end_comment

begin_decl_stmt
DECL|variable|toolbox_session_info
name|SessionInfo
name|toolbox_session_info
init|=
block|{
literal|"toolbox"
block|,
name|NULL
block|,
name|LEFT_OFFSET
block|,
name|TOP_OFFSET
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|lc_dialog_session_info
name|SessionInfo
name|lc_dialog_session_info
init|=
block|{
literal|"lc-dialog"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_lc_cmd_callback
block|,
name|LEFT_OFFSET
block|,
name|TOP_OFFSET
operator|+
literal|300
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tool_options_session_info
name|SessionInfo
name|tool_options_session_info
init|=
block|{
literal|"tool-options"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_tool_options_cmd_callback
block|,
name|LEFT_OFFSET
operator|+
literal|150
block|,
name|TOP_OFFSET
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|device_status_session_info
name|SessionInfo
name|device_status_session_info
init|=
block|{
literal|"device-status"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_device_status_cmd_callback
block|,
name|LEFT_OFFSET
operator|+
literal|150
block|,
name|TOP_OFFSET
operator|+
literal|250
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|brush_select_session_info
name|SessionInfo
name|brush_select_session_info
init|=
block|{
literal|"brush-select"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_brushes_cmd_callback
block|,
name|LEFT_OFFSET
operator|+
literal|350
block|,
name|TOP_OFFSET
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|pattern_select_session_info
name|SessionInfo
name|pattern_select_session_info
init|=
block|{
literal|"pattern-select"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_patterns_cmd_callback
block|,
name|LEFT_OFFSET
operator|+
literal|400
block|,
name|TOP_OFFSET
operator|+
literal|50
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gradient_select_session_info
name|SessionInfo
name|gradient_select_session_info
init|=
block|{
literal|"gradient-select"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_gradients_cmd_callback
block|,
name|LEFT_OFFSET
operator|+
literal|450
block|,
name|TOP_OFFSET
operator|+
literal|100
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|palette_session_info
name|SessionInfo
name|palette_session_info
init|=
block|{
literal|"palette"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_palette_cmd_callback
block|,
name|LEFT_OFFSET
operator|+
literal|500
block|,
name|TOP_OFFSET
operator|+
literal|150
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|info_dialog_session_info
name|SessionInfo
name|info_dialog_session_info
init|=
block|{
literal|"info-dialog"
block|,
name|NULL
block|,
name|LEFT_OFFSET
operator|+
literal|350
block|,
name|TOP_OFFSET
operator|+
literal|250
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|error_console_session_info
name|SessionInfo
name|error_console_session_info
init|=
block|{
literal|"error-console"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_error_console_cmd_callback
block|,
name|LEFT_OFFSET
block|,
name|TOP_OFFSET
operator|+
literal|250
block|,
literal|400
block|,
literal|150
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|document_index_session_info
name|SessionInfo
name|document_index_session_info
init|=
block|{
literal|"document-index"
block|,
operator|(
name|GtkItemFactoryCallback
operator|)
name|dialogs_document_index_cmd_callback
block|,
name|LEFT_OFFSET
block|,
name|TOP_OFFSET
operator|+
literal|300
block|,
literal|400
block|,
literal|150
block|,
literal|0
block|,
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  public functions  */
end_comment

begin_function
name|void
DECL|function|session_get_window_info (GtkWidget * window,SessionInfo * info)
name|session_get_window_info
parameter_list|(
name|GtkWidget
modifier|*
name|window
parameter_list|,
name|SessionInfo
modifier|*
name|info
parameter_list|)
block|{
if|if
condition|(
name|info
operator|==
name|NULL
operator|||
name|window
operator|==
name|NULL
operator|||
name|window
operator|->
name|window
operator|==
name|NULL
condition|)
return|return;
name|gdk_window_get_root_origin
argument_list|(
name|window
operator|->
name|window
argument_list|,
operator|&
name|info
operator|->
name|x
argument_list|,
operator|&
name|info
operator|->
name|y
argument_list|)
expr_stmt|;
name|gdk_window_get_size
argument_list|(
name|window
operator|->
name|window
argument_list|,
operator|&
name|info
operator|->
name|width
argument_list|,
operator|&
name|info
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|we_are_exiting
condition|)
name|info
operator|->
name|open
operator|=
name|GTK_WIDGET_VISIBLE
argument_list|(
name|window
argument_list|)
expr_stmt|;
comment|/*  this place is free for a new window, reset the counter  */
name|info
operator|->
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|save_session_info
operator|&&
name|g_list_find
argument_list|(
name|session_info_updates
argument_list|,
name|info
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|session_info_updates
operator|=
name|g_list_append
argument_list|(
name|session_info_updates
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|session_set_window_geometry (GtkWidget * window,SessionInfo * info,gboolean set_size)
name|session_set_window_geometry
parameter_list|(
name|GtkWidget
modifier|*
name|window
parameter_list|,
name|SessionInfo
modifier|*
name|info
parameter_list|,
name|gboolean
name|set_size
parameter_list|)
block|{
specifier|static
name|gint
name|screen_width
init|=
literal|0
decl_stmt|;
specifier|static
name|gint
name|screen_height
init|=
literal|0
decl_stmt|;
name|gint
name|x
decl_stmt|;
name|gint
name|y
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|window
operator|!=
name|NULL
operator|&&
name|info
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen_width
operator|==
literal|0
operator|||
name|screen_height
operator|==
literal|0
condition|)
block|{
name|screen_width
operator|=
name|gdk_screen_width
argument_list|()
expr_stmt|;
name|screen_height
operator|=
name|gdk_screen_height
argument_list|()
expr_stmt|;
block|}
comment|/*  cascade multiple windows of same type (e.g. info_dialogs)  */
name|x
operator|=
name|info
operator|->
name|x
operator|+
name|info
operator|->
name|count
operator|*
literal|32
expr_stmt|;
name|y
operator|=
name|info
operator|->
name|y
operator|+
name|info
operator|->
name|count
operator|*
literal|32
expr_stmt|;
name|info
operator|->
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|set_size
condition|)
block|{
if|if
condition|(
name|x
operator|>=
literal|0
operator|&&
name|x
operator|+
name|info
operator|->
name|width
operator|<
name|screen_width
operator|&&
name|y
operator|>=
literal|0
operator|&&
name|y
operator|+
name|info
operator|->
name|height
operator|<
name|screen_height
condition|)
block|{
name|gtk_widget_set_uposition
argument_list|(
name|window
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|gtk_window_set_default_size
argument_list|(
name|GTK_WINDOW
argument_list|(
name|window
argument_list|)
argument_list|,
name|info
operator|->
name|width
argument_list|,
name|info
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|x
operator|>=
literal|0
operator|&&
name|x
operator|+
literal|32
operator|<
name|screen_width
operator|&&
name|y
operator|>=
literal|0
operator|&&
name|y
operator|+
literal|32
operator|<
name|screen_height
condition|)
name|gtk_widget_set_uposition
argument_list|(
name|window
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|save_sessionrc (void)
name|save_sessionrc
parameter_list|(
name|void
parameter_list|)
block|{
name|gchar
modifier|*
name|filename
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|filename
operator|=
name|gimp_personal_rc_file
argument_list|(
literal|"sessionrc"
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"wt"
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
return|return;
name|fprintf
argument_list|(
name|fp
argument_list|,
operator|(
literal|"# GIMP sessionrc\n"
literal|"# This file takes session-specific info (that is info,\n"
literal|"# you want to keep between two gimp-sessions). You are\n"
literal|"# not supposed to edit it manually, but of course you\n"
literal|"# can do. This file will be entirely rewritten every time\n"
literal|"# you quit the gimp. If this file isn't found, defaults\n"
literal|"# are used.\n\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* save window geometries */
name|g_list_foreach
argument_list|(
name|session_info_updates
argument_list|,
operator|(
name|GFunc
operator|)
name|sessionrc_write_info
argument_list|,
name|fp
argument_list|)
expr_stmt|;
comment|/* save last tip shown */
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(last-tip-shown %d)\n\n"
argument_list|,
name|last_tip
operator|+
literal|1
argument_list|)
expr_stmt|;
name|color_history_write
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|session_init (void)
name|session_init
parameter_list|(
name|void
parameter_list|)
block|{
name|gchar
modifier|*
name|filename
decl_stmt|;
name|filename
operator|=
name|gimp_personal_rc_file
argument_list|(
literal|"sessionrc"
argument_list|)
expr_stmt|;
name|app_init_update_status
argument_list|(
name|NULL
argument_list|,
name|filename
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*  always show L&C&P, Tool Options and Brushes on first invocation  */
if|if
condition|(
operator|!
name|parse_gimprc_file
argument_list|(
name|filename
argument_list|)
condition|)
block|{
name|lc_dialog_session_info
operator|.
name|open
operator|=
name|TRUE
expr_stmt|;
name|session_info_updates
operator|=
name|g_list_append
argument_list|(
name|session_info_updates
argument_list|,
operator|&
name|lc_dialog_session_info
argument_list|)
expr_stmt|;
name|tool_options_session_info
operator|.
name|open
operator|=
name|TRUE
expr_stmt|;
name|session_info_updates
operator|=
name|g_list_append
argument_list|(
name|session_info_updates
argument_list|,
operator|&
name|tool_options_session_info
argument_list|)
expr_stmt|;
name|brush_select_session_info
operator|.
name|open
operator|=
name|TRUE
expr_stmt|;
name|session_info_updates
operator|=
name|g_list_append
argument_list|(
name|session_info_updates
argument_list|,
operator|&
name|brush_select_session_info
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|session_restore (void)
name|session_restore
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* open dialogs */
if|if
condition|(
name|restore_session
condition|)
name|g_list_foreach
argument_list|(
name|session_info_updates
argument_list|,
operator|(
name|GFunc
operator|)
name|session_open_dialog
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* reset the open state in the session_infos */
name|g_list_foreach
argument_list|(
name|session_info_updates
argument_list|,
operator|(
name|GFunc
operator|)
name|session_reset_open_state
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* internal function */
end_comment

begin_function
specifier|static
name|void
DECL|function|sessionrc_write_info (SessionInfo * info,FILE * fp)
name|sessionrc_write_info
parameter_list|(
name|SessionInfo
modifier|*
name|info
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
if|if
condition|(
name|fp
operator|==
name|NULL
operator|||
name|info
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(session-info \"%s\"\n"
argument_list|,
name|info
operator|->
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"   (position %d %d)\n"
argument_list|,
name|info
operator|->
name|x
argument_list|,
name|info
operator|->
name|y
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"   (size %d %d)"
argument_list|,
name|info
operator|->
name|width
argument_list|,
name|info
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|open
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n   (open-on-exit)"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|")\n\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|session_open_dialog (SessionInfo * info)
name|session_open_dialog
parameter_list|(
name|SessionInfo
modifier|*
name|info
parameter_list|)
block|{
if|if
condition|(
name|info
operator|==
name|NULL
operator|||
name|info
operator|->
name|open
operator|==
name|FALSE
operator|||
name|info
operator|->
name|open_callback
operator|==
name|NULL
condition|)
return|return;
call|(
name|info
operator|->
name|open_callback
call|)
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|session_reset_open_state (SessionInfo * info)
name|session_reset_open_state
parameter_list|(
name|SessionInfo
modifier|*
name|info
parameter_list|)
block|{
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
return|return;
name|info
operator|->
name|open
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

end_unit

