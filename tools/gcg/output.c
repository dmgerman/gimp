begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"output.h"
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_function
DECL|function|pr_param (File * s,Param * p,ParamOptions * opt)
name|void
name|pr_param
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|Param
modifier|*
name|p
parameter_list|,
name|ParamOptions
modifier|*
name|opt
parameter_list|)
block|{
name|pr
argument_list|(
name|s
argument_list|,
literal|"%?s%?1%?s%?s"
argument_list|,
operator|!
operator|(
operator|*
name|opt
operator|&
name|PARAMS_FIRST
operator|)
argument_list|,
literal|", "
argument_list|,
operator|!
operator|!
operator|(
operator|*
name|opt
operator|&
name|PARAMS_TYPES
operator|)
argument_list|,
name|pr_type
argument_list|,
operator|&
name|p
operator|->
name|type
argument_list|,
operator|(
operator|*
name|opt
operator|&
name|PARAMS_TYPES
operator|)
operator|&&
operator|(
operator|*
name|opt
operator|&
name|PARAMS_NAMES
operator|)
argument_list|,
literal|" "
argument_list|,
operator|!
operator|!
operator|(
operator|*
name|opt
operator|&
name|PARAMS_NAMES
operator|)
argument_list|,
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_params (File * s,GSList * args,ParamOptions * opt)
name|void
name|pr_params
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|GSList
modifier|*
name|args
parameter_list|,
name|ParamOptions
modifier|*
name|opt
parameter_list|)
block|{
name|ParamOptions
name|o
init|=
operator|*
name|opt
decl_stmt|;
if|if
condition|(
name|args
condition|)
if|if
condition|(
name|o
operator|&
name|PARAMS_FIRST
condition|)
block|{
name|pr_param
argument_list|(
name|s
argument_list|,
name|args
operator|->
name|data
argument_list|,
operator|&
name|o
argument_list|)
expr_stmt|;
name|o
operator|&=
operator|~
name|PARAMS_FIRST
expr_stmt|;
name|pr_list_foreach
argument_list|(
name|s
argument_list|,
name|args
operator|->
name|next
argument_list|,
name|pr_param
argument_list|,
operator|&
name|o
argument_list|)
expr_stmt|;
block|}
else|else
name|pr_list_foreach
argument_list|(
name|s
argument_list|,
name|args
argument_list|,
name|pr_param
argument_list|,
operator|&
name|o
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|o
operator|&
name|PARAMS_FIRST
condition|)
name|pr
argument_list|(
name|s
argument_list|,
literal|"void"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_primtype (File * s,PrimType * t)
name|void
name|pr_primtype
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|PrimType
modifier|*
name|t
parameter_list|)
block|{
name|pr
argument_list|(
name|s
argument_list|,
literal|"%s%s"
argument_list|,
name|t
operator|->
name|name
operator|.
name|module
argument_list|,
name|t
operator|->
name|name
operator|.
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_type (File * s,Type * t)
name|void
name|pr_type
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|Type
modifier|*
name|t
parameter_list|)
block|{
if|if
condition|(
name|t
operator|&&
name|t
operator|->
name|prim
condition|)
block|{
name|gint
name|i
init|=
name|t
operator|->
name|indirection
decl_stmt|;
name|pr
argument_list|(
name|s
argument_list|,
literal|"%?s%1"
argument_list|,
name|t
operator|->
name|is_const
argument_list|,
literal|"const "
argument_list|,
name|pr_primtype
argument_list|,
name|t
operator|->
name|prim
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
name|pr_c
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|indirection
condition|)
name|file_add_dep
argument_list|(
name|s
argument_list|,
name|t
operator|->
name|prim
operator|->
name|decl_header
argument_list|)
expr_stmt|;
else|else
name|file_add_dep
argument_list|(
name|s
argument_list|,
name|t
operator|->
name|prim
operator|->
name|def_header
argument_list|)
expr_stmt|;
block|}
else|else
name|pr
argument_list|(
name|s
argument_list|,
literal|"void"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_self_type (File * s,ObjectDef * o,PBool const_self)
name|void
name|pr_self_type
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|ObjectDef
modifier|*
name|o
parameter_list|,
name|PBool
name|const_self
parameter_list|)
block|{
name|pr
argument_list|(
name|s
argument_list|,
literal|"%?s%2*"
argument_list|,
operator|!
operator|!
name|const_self
argument_list|,
literal|"const "
argument_list|,
name|pr_primtype
argument_list|,
name|DEF
argument_list|(
name|o
argument_list|)
operator|->
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_varname (File * s,PrimType * t,Id name)
name|void
name|pr_varname
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|PrimType
modifier|*
name|t
parameter_list|,
name|Id
name|name
parameter_list|)
block|{
name|pr
argument_list|(
name|s
argument_list|,
literal|"%1_%1_%1"
argument_list|,
name|pr_low
argument_list|,
name|t
operator|->
name|name
operator|.
name|module
argument_list|,
name|pr_low
argument_list|,
name|t
operator|->
name|name
operator|.
name|type
argument_list|,
name|pr_low
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_internal_varname (File * s,PrimType * t,Id name)
name|void
name|pr_internal_varname
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|PrimType
modifier|*
name|t
parameter_list|,
name|Id
name|name
parameter_list|)
block|{
name|pr
argument_list|(
name|s
argument_list|,
literal|"_%2"
argument_list|,
name|pr_varname
argument_list|,
name|t
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_prototype (File * s,PrimType * type,Id funcname,GSList * params,Type * rettype,gboolean internal)
name|void
name|pr_prototype
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|PrimType
modifier|*
name|type
parameter_list|,
name|Id
name|funcname
parameter_list|,
name|GSList
modifier|*
name|params
parameter_list|,
name|Type
modifier|*
name|rettype
parameter_list|,
name|gboolean
name|internal
parameter_list|)
block|{
name|ParamOptions
name|o
init|=
name|PARAMS_NAMES
operator||
name|PARAMS_TYPES
operator||
name|PARAMS_FIRST
decl_stmt|;
name|pr
argument_list|(
name|s
argument_list|,
literal|"%1 %2 (%2)"
argument_list|,
name|pr_type
argument_list|,
name|rettype
argument_list|,
operator|(
name|internal
condition|?
name|pr_internal_varname
else|:
name|pr_varname
operator|)
argument_list|,
name|type
argument_list|,
name|funcname
argument_list|,
name|pr_params
argument_list|,
name|params
argument_list|,
operator|&
name|o
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_gtype (File * s,Type * t)
name|void
name|pr_gtype
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|Type
modifier|*
name|t
parameter_list|)
block|{
if|if
condition|(
operator|(
name|t
operator|->
name|indirection
operator|==
literal|0
operator|&&
name|t
operator|->
name|prim
operator|->
name|kind
operator|==
name|TYPE_TRANSPARENT
operator|)
operator|||
operator|(
name|t
operator|->
name|indirection
operator|==
literal|1
operator|&&
name|t
operator|->
name|prim
operator|->
name|kind
operator|==
name|TYPE_CLASS
operator|)
condition|)
name|pr_macro_name
argument_list|(
name|s
argument_list|,
name|t
operator|->
name|prim
argument_list|,
literal|"TYPE"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|t
operator|->
name|indirection
condition|)
name|pr
argument_list|(
name|s
argument_list|,
literal|"GTK_TYPE_POINTER"
argument_list|)
expr_stmt|;
else|else
name|g_error
argument_list|(
literal|"Illegal non-pointer type %s%s\n"
argument_list|,
name|t
operator|->
name|prim
operator|->
name|name
operator|.
name|module
argument_list|,
name|t
operator|->
name|prim
operator|->
name|name
operator|.
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_type_guard (File * s,Param * p)
name|void
name|pr_type_guard
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|Param
modifier|*
name|p
parameter_list|)
block|{
name|Type
modifier|*
name|t
init|=
operator|&
name|p
operator|->
name|type
decl_stmt|;
if|if
condition|(
name|t
operator|->
name|indirection
operator|==
literal|1
operator|&&
name|t
operator|->
name|prim
operator|->
name|kind
operator|==
name|TYPE_CLASS
condition|)
comment|/* A direct object pointer is checked for its type */
name|pr
argument_list|(
name|s
argument_list|,
literal|"\tg_assert(%?2%3(%s));\n"
argument_list|,
operator|!
name|t
operator|->
name|notnull
argument_list|,
name|pr
argument_list|,
literal|"!%s || "
argument_list|,
name|p
operator|->
name|name
argument_list|,
name|pr_macro_name
argument_list|,
name|t
operator|->
name|prim
argument_list|,
literal|"IS"
argument_list|,
name|NULL
argument_list|,
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|t
operator|->
name|indirection
operator|&&
name|t
operator|->
name|notnull
condition|)
comment|/* Other pointers are just possibly checked for nullness */
name|pr
argument_list|(
name|s
argument_list|,
literal|"\tg_assert(%s);\n"
argument_list|,
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* todo (low priority): range checks for enums */
block|}
end_function

begin_function
DECL|function|output_func (PrimType * type,Id funcname,GSList * params,Type * rettype,File * hdr,ObjectDef * self,gboolean self_const,gboolean internal,const gchar * body,...)
name|void
name|output_func
parameter_list|(
name|PrimType
modifier|*
name|type
parameter_list|,
name|Id
name|funcname
parameter_list|,
name|GSList
modifier|*
name|params
parameter_list|,
name|Type
modifier|*
name|rettype
parameter_list|,
name|File
modifier|*
name|hdr
parameter_list|,
name|ObjectDef
modifier|*
name|self
parameter_list|,
name|gboolean
name|self_const
parameter_list|,
name|gboolean
name|internal
parameter_list|,
specifier|const
name|gchar
modifier|*
name|body
parameter_list|,
modifier|...
parameter_list|)
block|{
name|GSList
name|l
decl_stmt|;
name|Param
name|p
decl_stmt|;
name|va_list
name|args
decl_stmt|;
if|if
condition|(
name|self
condition|)
block|{
name|p
operator|.
name|type
operator|.
name|prim
operator|=
name|DEF
argument_list|(
name|self
argument_list|)
operator|->
name|type
expr_stmt|;
name|p
operator|.
name|type
operator|.
name|indirection
operator|=
literal|1
expr_stmt|;
name|p
operator|.
name|type
operator|.
name|is_const
operator|=
name|self_const
expr_stmt|;
name|p
operator|.
name|type
operator|.
name|notnull
operator|=
name|TRUE
expr_stmt|;
name|p
operator|.
name|name
operator|=
literal|"self"
expr_stmt|;
name|l
operator|.
name|data
operator|=
operator|&
name|p
expr_stmt|;
name|l
operator|.
name|next
operator|=
name|params
expr_stmt|;
name|params
operator|=
operator|&
name|l
expr_stmt|;
block|}
name|va_start
argument_list|(
name|args
argument_list|,
name|body
argument_list|)
expr_stmt|;
name|pr
argument_list|(
operator|(
name|hdr
condition|?
name|hdr
else|:
name|source_head
operator|)
argument_list|,
literal|"%?s%5;\n"
argument_list|,
operator|!
name|hdr
argument_list|,
literal|"static "
argument_list|,
name|pr_prototype
argument_list|,
name|type
argument_list|,
name|funcname
argument_list|,
name|params
argument_list|,
name|rettype
argument_list|,
name|internal
argument_list|)
expr_stmt|;
name|pr
argument_list|(
name|source
argument_list|,
literal|"%?s%5{\n"
literal|"%3"
literal|"%v"
literal|"}\n"
argument_list|,
operator|!
name|hdr
argument_list|,
literal|"static "
argument_list|,
name|pr_prototype
argument_list|,
name|type
argument_list|,
name|funcname
argument_list|,
name|params
argument_list|,
name|rettype
argument_list|,
name|internal
argument_list|,
name|pr_list_foreach
argument_list|,
name|params
argument_list|,
name|pr_type_guard
argument_list|,
name|no_data
argument_list|,
name|body
argument_list|,
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|pr_macro_name (File * s,PrimType * t,Id mid,Id post)
name|void
name|pr_macro_name
parameter_list|(
name|File
modifier|*
name|s
parameter_list|,
name|PrimType
modifier|*
name|t
parameter_list|,
name|Id
name|mid
parameter_list|,
name|Id
name|post
parameter_list|)
block|{
name|pr
argument_list|(
name|s
argument_list|,
literal|"%1%?s%?1_%1%?s%?1"
argument_list|,
name|pr_up
argument_list|,
name|t
operator|->
name|name
operator|.
name|module
argument_list|,
operator|!
operator|!
name|mid
argument_list|,
literal|"_"
argument_list|,
operator|!
operator|!
name|mid
argument_list|,
name|pr_up
argument_list|,
name|mid
argument_list|,
name|pr_up
argument_list|,
name|t
operator|->
name|name
operator|.
name|type
argument_list|,
operator|!
operator|!
name|post
argument_list|,
literal|"_"
argument_list|,
operator|!
operator|!
name|post
argument_list|,
name|pr_up
argument_list|,
name|post
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|output_var (Def * d,Type * t,Id varname,File * hdr,gboolean internal)
name|void
name|output_var
parameter_list|(
name|Def
modifier|*
name|d
parameter_list|,
name|Type
modifier|*
name|t
parameter_list|,
name|Id
name|varname
parameter_list|,
name|File
modifier|*
name|hdr
parameter_list|,
name|gboolean
name|internal
parameter_list|)
block|{
if|if
condition|(
name|hdr
condition|)
name|pr
argument_list|(
name|hdr
argument_list|,
literal|"extern %1 %2;\n"
argument_list|,
name|pr_type
argument_list|,
name|t
argument_list|,
operator|(
name|internal
condition|?
name|pr_internal_varname
else|:
name|pr_varname
operator|)
argument_list|,
operator|&
name|d
operator|->
name|type
operator|->
name|name
argument_list|,
name|varname
argument_list|)
expr_stmt|;
name|pr
argument_list|(
name|source_head
argument_list|,
literal|"%?s%1 %2;\n"
argument_list|,
operator|!
name|hdr
argument_list|,
literal|"static "
argument_list|,
name|pr_type
argument_list|,
name|t
argument_list|,
operator|(
name|internal
condition|?
name|pr_internal_varname
else|:
name|pr_varname
operator|)
argument_list|,
operator|&
name|d
operator|->
name|type
operator|->
name|name
argument_list|,
name|varname
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

