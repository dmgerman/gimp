begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"output.h"
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_function
DECL|function|p_c_ident (Id id)
name|PNode
modifier|*
name|p_c_ident
parameter_list|(
name|Id
name|id
parameter_list|)
block|{
name|PNode
modifier|*
name|n
decl_stmt|;
name|gchar
modifier|*
name|c
decl_stmt|;
name|gchar
modifier|*
name|s
decl_stmt|;
name|c
operator|=
name|s
operator|=
name|g_strdup
argument_list|(
name|id
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|c
condition|)
block|{
operator|*
name|c
operator|=
name|tolower
argument_list|(
operator|*
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isalnum
argument_list|(
operator|*
name|c
argument_list|)
condition|)
operator|*
name|c
operator|=
literal|'_'
expr_stmt|;
name|c
operator|++
expr_stmt|;
block|}
name|n
operator|=
name|p_str
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
DECL|function|p_c_macro (Id id)
name|PNode
modifier|*
name|p_c_macro
parameter_list|(
name|Id
name|id
parameter_list|)
block|{
name|PNode
modifier|*
name|n
decl_stmt|;
name|gchar
modifier|*
name|c
decl_stmt|;
name|gchar
modifier|*
name|s
decl_stmt|;
name|c
operator|=
name|s
operator|=
name|g_strdup
argument_list|(
name|id
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|c
condition|)
block|{
operator|*
name|c
operator|=
name|toupper
argument_list|(
operator|*
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isalnum
argument_list|(
operator|*
name|c
argument_list|)
condition|)
operator|*
name|c
operator|=
literal|'_'
expr_stmt|;
name|c
operator|++
expr_stmt|;
block|}
name|n
operator|=
name|p_str
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
DECL|function|p_param (Param * p,ParamOptions * opt)
name|PNode
modifier|*
name|p_param
parameter_list|(
name|Param
modifier|*
name|p
parameter_list|,
name|ParamOptions
modifier|*
name|opt
parameter_list|)
block|{
return|return
name|p_lst
argument_list|(
name|opt
operator|->
name|first
condition|?
name|p_nil
else|:
name|p_str
argument_list|(
literal|", "
argument_list|)
argument_list|,
name|opt
operator|->
name|types
condition|?
name|p_type
argument_list|(
operator|&
name|p
operator|->
name|type
argument_list|)
else|:
name|p_nil
argument_list|,
name|opt
operator|->
name|types
operator|&&
name|opt
operator|->
name|names
condition|?
name|p_str
argument_list|(
literal|" "
argument_list|)
else|:
name|p_nil
argument_list|,
name|opt
operator|->
name|names
condition|?
name|p_c_ident
argument_list|(
name|p
operator|->
name|name
argument_list|)
else|:
name|p_nil
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|p_params (GSList * args,ParamOptions * opt)
name|PNode
modifier|*
name|p_params
parameter_list|(
name|GSList
modifier|*
name|args
parameter_list|,
name|ParamOptions
modifier|*
name|opt
parameter_list|)
block|{
name|ParamOptions
name|o
init|=
operator|*
name|opt
decl_stmt|;
return|return
operator|(
name|args
condition|?
operator|(
name|o
operator|.
name|first
condition|?
name|p_lst
argument_list|(
name|p_param
argument_list|(
name|args
operator|->
name|data
argument_list|,
name|opt
argument_list|)
argument_list|,
operator|(
name|o
operator|.
name|first
operator|=
name|FALSE
operator|,
name|p_for
argument_list|(
name|args
operator|->
name|next
argument_list|,
name|p_param
argument_list|,
operator|&
name|o
argument_list|)
operator|)
argument_list|,
name|NULL
argument_list|)
else|:
name|p_for
argument_list|(
name|args
argument_list|,
name|p_param
argument_list|,
operator|&
name|o
argument_list|)
operator|)
else|:
operator|(
name|o
operator|.
name|first
condition|?
name|p_str
argument_list|(
literal|"void"
argument_list|)
else|:
name|p_nil
operator|)
operator|)
return|;
block|}
end_function

begin_function
DECL|function|p_primtype (PrimType * t)
name|PNode
modifier|*
name|p_primtype
parameter_list|(
name|PrimType
modifier|*
name|t
parameter_list|)
block|{
return|return
name|p_lst
argument_list|(
name|p_str
argument_list|(
name|t
operator|->
name|name
operator|.
name|module
argument_list|)
argument_list|,
name|p_str
argument_list|(
name|t
operator|->
name|name
operator|.
name|type
argument_list|)
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|p_type (Type * t)
name|PNode
modifier|*
name|p_type
parameter_list|(
name|Type
modifier|*
name|t
parameter_list|)
block|{
if|if
condition|(
name|t
operator|&&
name|t
operator|->
name|prim
condition|)
block|{
name|PNode
modifier|*
name|node
decl_stmt|;
name|gint
name|i
init|=
name|t
operator|->
name|indirection
decl_stmt|;
name|node
operator|=
name|p_fmt
argument_list|(
literal|"~~"
argument_list|,
name|t
operator|->
name|is_const
condition|?
name|p_str
argument_list|(
literal|"const "
argument_list|)
else|:
name|p_nil
argument_list|,
name|p_primtype
argument_list|(
name|t
operator|->
name|prim
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
name|node
operator|=
name|p_lst
argument_list|(
name|node
argument_list|,
name|p_str
argument_list|(
literal|"*"
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* file_add_dep(s, t->prim->decl_header);*/
return|return
name|node
return|;
block|}
else|else
return|return
name|p_str
argument_list|(
literal|"void"
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|p_self_type (ObjectDef * o,PBool const_self)
name|PNode
modifier|*
name|p_self_type
parameter_list|(
name|ObjectDef
modifier|*
name|o
parameter_list|,
name|PBool
name|const_self
parameter_list|)
block|{
return|return
name|p_fmt
argument_list|(
literal|"~~*"
argument_list|,
operator|(
name|const_self
condition|?
name|p_str
argument_list|(
literal|"const "
argument_list|)
else|:
name|p_nil
operator|)
argument_list|,
name|p_primtype
argument_list|(
name|DEF
argument_list|(
name|o
argument_list|)
operator|->
name|type
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|p_varname (PrimType * t,Id name)
name|PNode
modifier|*
name|p_varname
parameter_list|(
name|PrimType
modifier|*
name|t
parameter_list|,
name|Id
name|name
parameter_list|)
block|{
return|return
name|p_fmt
argument_list|(
literal|"~_~_~"
argument_list|,
name|p_c_ident
argument_list|(
name|t
operator|->
name|name
operator|.
name|module
argument_list|)
argument_list|,
name|p_c_ident
argument_list|(
name|t
operator|->
name|name
operator|.
name|type
argument_list|)
argument_list|,
name|p_c_ident
argument_list|(
name|name
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|p_internal_varname (PrimType * t,Id name)
name|PNode
modifier|*
name|p_internal_varname
parameter_list|(
name|PrimType
modifier|*
name|t
parameter_list|,
name|Id
name|name
parameter_list|)
block|{
return|return
name|p_fmt
argument_list|(
literal|"_~"
argument_list|,
name|p_varname
argument_list|(
name|t
argument_list|,
name|name
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|p_prototype (PrimType * type,Id funcname,GSList * params,Type * rettype,gboolean internal)
name|PNode
modifier|*
name|p_prototype
parameter_list|(
name|PrimType
modifier|*
name|type
parameter_list|,
name|Id
name|funcname
parameter_list|,
name|GSList
modifier|*
name|params
parameter_list|,
name|Type
modifier|*
name|rettype
parameter_list|,
name|gboolean
name|internal
parameter_list|)
block|{
name|ParamOptions
name|o
init|=
block|{
name|TRUE
block|,
name|TRUE
block|,
name|TRUE
block|}
decl_stmt|;
return|return
name|p_fmt
argument_list|(
literal|"~ ~ (~)"
argument_list|,
name|p_type
argument_list|(
name|rettype
argument_list|)
argument_list|,
operator|(
name|internal
condition|?
name|p_internal_varname
else|:
name|p_varname
operator|)
operator|(
name|type
operator|,
name|funcname
operator|)
argument_list|,
name|p_params
argument_list|(
name|params
argument_list|,
operator|&
name|o
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|p_type_guard (Param * p)
name|PNode
modifier|*
name|p_type_guard
parameter_list|(
name|Param
modifier|*
name|p
parameter_list|)
block|{
name|Type
modifier|*
name|t
init|=
operator|&
name|p
operator|->
name|type
decl_stmt|;
return|return
name|p_lst
argument_list|(
operator|(
name|t
operator|->
name|indirection
operator|&&
name|t
operator|->
name|notnull
condition|?
name|p_fmt
argument_list|(
literal|"\tg_assert (%s);\n"
argument_list|,
name|p
operator|->
name|name
argument_list|)
else|:
name|p_nil
operator|)
argument_list|,
operator|(
operator|(
name|t
operator|->
name|indirection
operator|==
literal|1
operator|&&
name|t
operator|->
name|prim
operator|->
name|kind
operator|==
name|GTK_TYPE_OBJECT
operator|)
condition|?
operator|(
name|t
operator|->
name|notnull
condition|?
name|p_fmt
argument_list|(
literal|"\tg_assert (%3(%1));\n"
argument_list|,
name|p_macro_name
argument_list|(
name|t
operator|->
name|prim
argument_list|,
literal|"IS"
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|p_c_ident
argument_list|(
name|p
operator|->
name|name
argument_list|)
argument_list|)
else|:
name|p_fmt
argument_list|(
literal|"\tg_assert (!%1 || %3(%s));\n"
argument_list|,
name|p_c_ident
argument_list|(
name|p
operator|->
name|name
argument_list|)
argument_list|,
name|p_macro_name
argument_list|(
name|t
operator|->
name|prim
argument_list|,
literal|"IS"
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|p_c_ident
argument_list|(
name|p
operator|->
name|name
argument_list|)
argument_list|)
operator|)
else|:
operator|(
name|t
operator|->
name|indirection
operator|==
literal|0
condition|?
operator|(
operator|(
name|t
operator|->
name|prim
operator|->
name|kind
operator|==
name|GTK_TYPE_ENUM
operator|)
condition|?
name|p_fmt
argument_list|(
literal|"\tg_assert (%1<= %3);\n"
argument_list|,
name|p_c_ident
argument_list|(
name|p
operator|->
name|name
argument_list|)
argument_list|,
name|p_macro_name
argument_list|(
name|t
operator|->
name|prim
argument_list|,
name|NULL
argument_list|,
literal|"LAST"
argument_list|)
argument_list|)
else|:
operator|(
operator|(
name|t
operator|->
name|prim
operator|->
name|kind
operator|==
name|GTK_TYPE_FLAGS
operator|)
condition|?
name|p_fmt
argument_list|(
literal|"\tg_assert ((%s<< 1)< %3);\n"
argument_list|,
name|p_c_ident
argument_list|(
name|p
operator|->
name|name
argument_list|)
argument_list|,
name|p_macro_name
argument_list|(
name|t
operator|->
name|prim
argument_list|,
name|NULL
argument_list|,
literal|"LAST"
argument_list|)
argument_list|)
else|:
name|p_nil
operator|)
operator|)
else|:
name|p_nil
operator|)
operator|)
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|output_func (OutCtx * ctx,PrimType * type,Id funcname,GSList * params,Type * rettype,Visibility scope,ObjectDef * self,gboolean self_const,gboolean internal,PNode * body)
name|void
name|output_func
parameter_list|(
name|OutCtx
modifier|*
name|ctx
parameter_list|,
name|PrimType
modifier|*
name|type
parameter_list|,
name|Id
name|funcname
parameter_list|,
name|GSList
modifier|*
name|params
parameter_list|,
name|Type
modifier|*
name|rettype
parameter_list|,
name|Visibility
name|scope
parameter_list|,
name|ObjectDef
modifier|*
name|self
parameter_list|,
name|gboolean
name|self_const
parameter_list|,
name|gboolean
name|internal
parameter_list|,
name|PNode
modifier|*
name|body
parameter_list|)
block|{
name|GSList
name|l
decl_stmt|;
name|Param
name|p
decl_stmt|;
name|PRoot
modifier|*
name|root
decl_stmt|;
if|if
condition|(
name|self
condition|)
block|{
name|p
operator|.
name|type
operator|.
name|prim
operator|=
name|DEF
argument_list|(
name|self
argument_list|)
operator|->
name|type
expr_stmt|;
name|p
operator|.
name|type
operator|.
name|indirection
operator|=
literal|1
expr_stmt|;
name|p
operator|.
name|type
operator|.
name|is_const
operator|=
name|self_const
expr_stmt|;
name|p
operator|.
name|type
operator|.
name|notnull
operator|=
name|TRUE
expr_stmt|;
name|p
operator|.
name|name
operator|=
literal|"self"
expr_stmt|;
name|l
operator|.
name|data
operator|=
operator|&
name|p
expr_stmt|;
name|l
operator|.
name|next
operator|=
name|params
expr_stmt|;
name|params
operator|=
operator|&
name|l
expr_stmt|;
block|}
switch|switch
condition|(
name|scope
condition|)
block|{
case|case
name|VIS_PUBLIC
case|:
name|root
operator|=
name|ctx
operator|->
name|func_hdr
expr_stmt|;
break|break;
case|case
name|VIS_PROTECTED
case|:
name|root
operator|=
name|ctx
operator|->
name|prot_hdr
expr_stmt|;
break|break;
case|case
name|VIS_PRIVATE
case|:
name|root
operator|=
name|ctx
operator|->
name|pvt_hdr
expr_stmt|;
break|break;
block|}
name|pr_add
argument_list|(
name|root
argument_list|,
name|p_fmt
argument_list|(
literal|"~~;\n"
argument_list|,
name|scope
operator|==
name|VIS_PRIVATE
condition|?
name|p_str
argument_list|(
literal|"static "
argument_list|)
else|:
name|p_nil
argument_list|,
name|p_prototype
argument_list|(
name|type
argument_list|,
name|funcname
argument_list|,
name|params
argument_list|,
name|rettype
argument_list|,
name|internal
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|pr_add
argument_list|(
name|ctx
operator|->
name|src
argument_list|,
name|p_fmt
argument_list|(
literal|"~~{\n"
literal|"~"
literal|"~"
literal|"}\n\n"
argument_list|,
name|scope
operator|!=
name|VIS_PRIVATE
condition|?
name|p_nil
else|:
name|p_str
argument_list|(
literal|"static "
argument_list|)
argument_list|,
name|p_prototype
argument_list|(
name|type
argument_list|,
name|funcname
argument_list|,
name|params
argument_list|,
name|rettype
argument_list|,
name|internal
argument_list|)
argument_list|,
name|p_for
argument_list|(
name|params
argument_list|,
name|p_type_guard
argument_list|,
name|p_nil
argument_list|)
argument_list|,
name|body
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|p_macro_name (PrimType * t,Id mid,Id post)
name|PNode
modifier|*
name|p_macro_name
parameter_list|(
name|PrimType
modifier|*
name|t
parameter_list|,
name|Id
name|mid
parameter_list|,
name|Id
name|post
parameter_list|)
block|{
return|return
name|p_fmt
argument_list|(
literal|"~~_~~"
argument_list|,
name|p_c_macro
argument_list|(
name|t
operator|->
name|name
operator|.
name|module
argument_list|)
argument_list|,
name|mid
condition|?
name|p_lst
argument_list|(
name|p_str
argument_list|(
literal|"_"
argument_list|)
argument_list|,
name|p_c_macro
argument_list|(
name|mid
argument_list|)
argument_list|,
name|NULL
argument_list|)
else|:
name|p_nil
argument_list|,
name|p_c_macro
argument_list|(
name|t
operator|->
name|name
operator|.
name|type
argument_list|)
argument_list|,
name|post
condition|?
name|p_lst
argument_list|(
name|p_str
argument_list|(
literal|"_"
argument_list|)
argument_list|,
name|p_c_macro
argument_list|(
name|post
argument_list|)
argument_list|,
name|NULL
argument_list|)
else|:
name|p_nil
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|output_var (OutCtx * ctx,Def * d,Type * t,Id varname,Visibility scope,gboolean internal)
name|void
name|output_var
parameter_list|(
name|OutCtx
modifier|*
name|ctx
parameter_list|,
name|Def
modifier|*
name|d
parameter_list|,
name|Type
modifier|*
name|t
parameter_list|,
name|Id
name|varname
parameter_list|,
name|Visibility
name|scope
parameter_list|,
name|gboolean
name|internal
parameter_list|)
block|{
name|PRoot
modifier|*
name|root
decl_stmt|;
switch|switch
condition|(
name|scope
condition|)
block|{
case|case
name|VIS_PUBLIC
case|:
name|root
operator|=
name|ctx
operator|->
name|func_hdr
expr_stmt|;
break|break;
case|case
name|VIS_PROTECTED
case|:
name|root
operator|=
name|ctx
operator|->
name|prot_hdr
expr_stmt|;
break|break;
case|case
name|VIS_PRIVATE
case|:
name|root
operator|=
name|ctx
operator|->
name|pvt_hdr
expr_stmt|;
break|break;
block|}
name|pr_add
argument_list|(
name|root
argument_list|,
name|p_fmt
argument_list|(
literal|"extern ~ ~;\n"
argument_list|,
name|p_type
argument_list|(
name|t
argument_list|)
argument_list|,
operator|(
name|internal
condition|?
name|p_internal_varname
else|:
name|p_varname
operator|)
operator|(
name|d
operator|->
name|type
operator|,
name|varname
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|pr_add
argument_list|(
name|ctx
operator|->
name|src
argument_list|,
name|p_fmt
argument_list|(
literal|"~~ ~;\n"
argument_list|,
name|scope
operator|==
name|VIS_PRIVATE
condition|?
name|p_nil
else|:
name|p_str
argument_list|(
literal|"static "
argument_list|)
argument_list|,
name|p_type
argument_list|(
name|t
argument_list|)
argument_list|,
operator|(
name|internal
condition|?
name|p_internal_varname
else|:
name|p_varname
operator|)
operator|(
name|d
operator|->
name|type
operator|,
name|varname
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|output_def (OutCtx * ctx,Def * d)
name|void
name|output_def
parameter_list|(
name|OutCtx
modifier|*
name|ctx
parameter_list|,
name|Def
modifier|*
name|d
parameter_list|)
block|{
name|PrimType
modifier|*
name|t
init|=
name|d
operator|->
name|type
decl_stmt|;
comment|/* GTK_TYPE_FOO macro */
name|pr_add
argument_list|(
name|ctx
operator|->
name|type_hdr
argument_list|,
name|p_str
argument_list|(
literal|"\n\n"
argument_list|)
argument_list|)
expr_stmt|;
name|pr_add
argument_list|(
name|ctx
operator|->
name|src
argument_list|,
name|p_str
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|pr_add
argument_list|(
name|ctx
operator|->
name|prot_hdr
argument_list|,
name|p_str
argument_list|(
literal|"\n\n"
argument_list|)
argument_list|)
expr_stmt|;
name|pr_add
argument_list|(
name|ctx
operator|->
name|pvt_hdr
argument_list|,
name|p_str
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|pr_add
argument_list|(
name|ctx
operator|->
name|type_hdr
argument_list|,
name|p_fmt
argument_list|(
literal|"#define ~ \\\n"
literal|" (~ ? ~ : ~())\n"
argument_list|,
name|p_macro_name
argument_list|(
name|t
argument_list|,
literal|"TYPE"
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|p_internal_varname
argument_list|(
name|t
argument_list|,
literal|"type"
argument_list|)
argument_list|,
name|p_internal_varname
argument_list|(
name|t
argument_list|,
literal|"type"
argument_list|)
argument_list|,
name|p_internal_varname
argument_list|(
name|t
argument_list|,
literal|"init_type"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|output_var
argument_list|(
name|ctx
argument_list|,
name|d
argument_list|,
name|type_gtk_type
argument_list|,
literal|"type"
argument_list|,
name|VIS_PUBLIC
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|d
operator|->
name|type
operator|->
name|kind
condition|)
block|{
case|case
name|GTK_TYPE_OBJECT
case|:
name|output_object
argument_list|(
name|ctx
argument_list|,
name|d
argument_list|)
expr_stmt|;
break|break;
case|case
name|GTK_TYPE_ENUM
case|:
name|output_enum
argument_list|(
name|ctx
argument_list|,
name|d
argument_list|)
expr_stmt|;
break|break;
case|case
name|GTK_TYPE_FLAGS
case|:
name|output_flags
argument_list|(
name|ctx
argument_list|,
name|d
argument_list|)
expr_stmt|;
break|break;
default|default:
empty_stmt|;
block|}
block|}
end_function

end_unit

