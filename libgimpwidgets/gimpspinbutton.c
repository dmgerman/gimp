begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* LIBGIMP - The GIMP Library  * Copyright (C) 1995-1997 Peter Mattis and Spencer Kimball  *  * gimpspinbutton.c  * Copyright (C) 2018 Ell  *  * This library is free software: you can redistribute it and/or  * modify it under the terms of the GNU Lesser General Public  * License as published by the Free Software Foundation; either  * version 3 of the License, or (at your option) any later version.  *  * This library is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * Lesser General Public License for more details.  *  * You should have received a copy of the GNU Lesser General Public  * License along with this library.  If not, see  *<https://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<gegl.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"gimpwidgetstypes.h"
end_include

begin_include
include|#
directive|include
file|"gimpspinbutton.h"
end_include

begin_comment
comment|/**  * SECTION: gimpspinbutton  * @title: GimpSpinButton  * @short_description: A #GtkSpinButton with a some tweaked functionality.  *  * #GimpSpinButton is a drop-in replacement for #GtkSpinButton, with the  * following changes:  *  *   - When the spin-button loses focus, its adjustment value is only  *     updated if the entry text has been changed.  *  *   - When the spin-button's "wrap" property is TRUE, values input through the  *     entry are wrapped around.  **/
end_comment

begin_define
DECL|macro|MAX_DIGITS
define|#
directive|define
name|MAX_DIGITS
value|20
end_define

begin_struct
DECL|struct|_GimpSpinButtonPrivate
struct|struct
name|_GimpSpinButtonPrivate
block|{
DECL|member|changed
name|gboolean
name|changed
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|gboolean
name|gimp_spin_button_focus_in
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventFocus
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|gimp_spin_button_focus_out
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventFocus
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|gimp_spin_button_input
parameter_list|(
name|GtkSpinButton
modifier|*
name|spin_button
parameter_list|,
name|gdouble
modifier|*
name|new_value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gimp_spin_button_changed
parameter_list|(
name|GtkEditable
modifier|*
name|editable
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_macro
DECL|function|G_DEFINE_TYPE_WITH_PRIVATE (GimpSpinButton,gimp_spin_button,GTK_TYPE_SPIN_BUTTON)
name|G_DEFINE_TYPE_WITH_PRIVATE
argument_list|(
argument|GimpSpinButton
argument_list|,
argument|gimp_spin_button
argument_list|,
argument|GTK_TYPE_SPIN_BUTTON
argument_list|)
end_macro

begin_define
DECL|macro|parent_class
define|#
directive|define
name|parent_class
value|gimp_spin_button_parent_class
end_define

begin_comment
comment|/*  private functions  */
end_comment

begin_function
specifier|static
name|void
name|gimp_spin_button_class_init
parameter_list|(
name|GimpSpinButtonClass
modifier|*
name|klass
parameter_list|)
block|{
name|GtkWidgetClass
modifier|*
name|widget_class
init|=
name|GTK_WIDGET_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|GtkSpinButtonClass
modifier|*
name|spin_button_class
init|=
name|GTK_SPIN_BUTTON_CLASS
argument_list|(
name|klass
argument_list|)
decl_stmt|;
name|widget_class
operator|->
name|focus_in_event
operator|=
name|gimp_spin_button_focus_in
expr_stmt|;
name|widget_class
operator|->
name|focus_out_event
operator|=
name|gimp_spin_button_focus_out
expr_stmt|;
name|spin_button_class
operator|->
name|input
operator|=
name|gimp_spin_button_input
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_spin_button_init (GimpSpinButton * spin_button)
name|gimp_spin_button_init
parameter_list|(
name|GimpSpinButton
modifier|*
name|spin_button
parameter_list|)
block|{
name|spin_button
operator|->
name|priv
operator|=
name|gimp_spin_button_get_instance_private
argument_list|(
name|spin_button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|spin_button
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_spin_button_changed
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_spin_button_focus_in (GtkWidget * widget,GdkEventFocus * event)
name|gimp_spin_button_focus_in
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventFocus
modifier|*
name|event
parameter_list|)
block|{
name|GimpSpinButton
modifier|*
name|spin_button
init|=
name|GIMP_SPIN_BUTTON
argument_list|(
name|widget
argument_list|)
decl_stmt|;
name|spin_button
operator|->
name|priv
operator|->
name|changed
operator|=
name|FALSE
expr_stmt|;
return|return
name|GTK_WIDGET_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|focus_in_event
argument_list|(
name|widget
argument_list|,
name|event
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|gimp_spin_button_focus_out (GtkWidget * widget,GdkEventFocus * event)
name|gimp_spin_button_focus_out
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventFocus
modifier|*
name|event
parameter_list|)
block|{
name|GimpSpinButton
modifier|*
name|spin_button
init|=
name|GIMP_SPIN_BUTTON
argument_list|(
name|widget
argument_list|)
decl_stmt|;
name|gboolean
name|editable
decl_stmt|;
name|gboolean
name|result
decl_stmt|;
name|editable
operator|=
name|gtk_editable_get_editable
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|spin_button
operator|->
name|priv
operator|->
name|changed
condition|)
name|gtk_editable_set_editable
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|widget
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|GTK_WIDGET_CLASS
argument_list|(
name|parent_class
argument_list|)
operator|->
name|focus_out_event
argument_list|(
name|widget
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|spin_button
operator|->
name|priv
operator|->
name|changed
condition|)
name|gtk_editable_set_editable
argument_list|(
name|GTK_EDITABLE
argument_list|(
name|widget
argument_list|)
argument_list|,
name|editable
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|gimp_spin_button_input (GtkSpinButton * spin_button,gdouble * new_value)
name|gimp_spin_button_input
parameter_list|(
name|GtkSpinButton
modifier|*
name|spin_button
parameter_list|,
name|gdouble
modifier|*
name|new_value
parameter_list|)
block|{
if|if
condition|(
name|gtk_spin_button_get_wrap
argument_list|(
name|spin_button
argument_list|)
condition|)
block|{
name|gdouble
name|value
decl_stmt|;
name|gdouble
name|min
decl_stmt|;
name|gdouble
name|max
decl_stmt|;
name|gchar
modifier|*
name|endptr
decl_stmt|;
name|value
operator|=
name|g_strtod
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|spin_button
argument_list|)
argument_list|)
argument_list|,
operator|&
name|endptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endptr
condition|)
return|return
name|FALSE
return|;
name|gtk_spin_button_get_range
argument_list|(
name|spin_button
argument_list|,
operator|&
name|min
argument_list|,
operator|&
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
name|min
operator|<
name|max
condition|)
block|{
name|gdouble
name|rem
decl_stmt|;
name|rem
operator|=
name|fmod
argument_list|(
name|value
operator|-
name|min
argument_list|,
name|max
operator|-
name|min
argument_list|)
expr_stmt|;
if|if
condition|(
name|rem
operator|<
literal|0.0
condition|)
name|rem
operator|+=
name|max
operator|-
name|min
expr_stmt|;
if|if
condition|(
name|rem
operator|==
literal|0.0
condition|)
name|value
operator|=
name|CLAMP
argument_list|(
name|value
argument_list|,
name|min
argument_list|,
name|max
argument_list|)
expr_stmt|;
else|else
name|value
operator|=
name|min
operator|+
name|rem
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
name|min
expr_stmt|;
block|}
operator|*
name|new_value
operator|=
name|value
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gimp_spin_button_changed (GtkEditable * editable,gpointer data)
name|gimp_spin_button_changed
parameter_list|(
name|GtkEditable
modifier|*
name|editable
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpSpinButton
modifier|*
name|spin_button
init|=
name|GIMP_SPIN_BUTTON
argument_list|(
name|editable
argument_list|)
decl_stmt|;
name|spin_button
operator|->
name|priv
operator|->
name|changed
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  public functions  */
end_comment

begin_comment
comment|/**  * gimp_spin_button_new:  * @adjustment: (allow-none): the #GtkAdjustment object that this spin  *                            button should use, or %NULL  * @climb_rate:               specifies by how much the rate of change in the  *                            value will accelerate if you continue to hold  *                            down an up/down button or arrow key  * @digits:                   the number of decimal places to display  *  * Creates a new #GimpSpinButton.  *  * Returns: The new spin button as a #GtkWidget  *  * Since: 2.10.10  */
end_comment

begin_function
name|GtkWidget
modifier|*
DECL|function|gimp_spin_button_new (GtkAdjustment * adjustment,gdouble climb_rate,guint digits)
name|gimp_spin_button_new
parameter_list|(
name|GtkAdjustment
modifier|*
name|adjustment
parameter_list|,
name|gdouble
name|climb_rate
parameter_list|,
name|guint
name|digits
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|spin_button
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|adjustment
operator|==
name|NULL
operator|||
name|GTK_IS_ADJUSTMENT
argument_list|(
name|adjustment
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|spin_button
operator|=
name|g_object_new
argument_list|(
name|GIMP_TYPE_SPIN_BUTTON
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_spin_button_configure
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spin_button
argument_list|)
argument_list|,
name|adjustment
argument_list|,
name|climb_rate
argument_list|,
name|digits
argument_list|)
expr_stmt|;
return|return
name|spin_button
return|;
block|}
end_function

begin_comment
comment|/**  * gimp_spin_button_new_with_range:  * @min:  Minimum allowable value  * @max:  Maximum allowable value  * @step: Increment added or subtracted by spinning the widget  *  * This is a convenience constructor that allows creation of a numeric  * #GimpSpinButton without manually creating an adjustment.  The value is  * initially set to the minimum value and a page increment of 10 * @step  * is the default.  The precision of the spin button is equivalent to the  * precision of @step.  *  * Note that the way in which the precision is derived works best if @step  * is a power of ten. If the resulting precision is not suitable for your  * needs, use gtk_spin_button_set_digits() to correct it.  *  * Returns: The new spin button as a #GtkWidget  *  * Since: 2.10.10  */
end_comment

begin_function
name|GtkWidget
modifier|*
DECL|function|gimp_spin_button_new_with_range (gdouble min,gdouble max,gdouble step)
name|gimp_spin_button_new_with_range
parameter_list|(
name|gdouble
name|min
parameter_list|,
name|gdouble
name|max
parameter_list|,
name|gdouble
name|step
parameter_list|)
block|{
name|GtkAdjustment
modifier|*
name|adjustment
decl_stmt|;
name|GtkWidget
modifier|*
name|spin_button
decl_stmt|;
name|gint
name|digits
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|min
operator|<=
name|max
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_return_val_if_fail
argument_list|(
name|step
operator|!=
literal|0.0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|spin_button
operator|=
name|g_object_new
argument_list|(
name|GIMP_TYPE_SPIN_BUTTON
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adjustment
operator|=
name|gtk_adjustment_new
argument_list|(
name|min
argument_list|,
name|min
argument_list|,
name|max
argument_list|,
name|step
argument_list|,
literal|10.0
operator|*
name|step
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|step
argument_list|)
operator|>=
literal|1.0
operator|||
name|step
operator|==
literal|0.0
condition|)
block|{
name|digits
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|digits
operator|=
name|abs
argument_list|(
operator|(
name|gint
operator|)
name|floor
argument_list|(
name|log10
argument_list|(
name|fabs
argument_list|(
name|step
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digits
operator|>
name|MAX_DIGITS
condition|)
name|digits
operator|=
name|MAX_DIGITS
expr_stmt|;
block|}
name|gtk_spin_button_configure
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spin_button
argument_list|)
argument_list|,
name|adjustment
argument_list|,
name|step
argument_list|,
name|digits
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_numeric
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spin_button
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|spin_button
return|;
block|}
end_function

end_unit

