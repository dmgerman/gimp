#!/usr/bin/perl

# a lame attempt at xgettext for scheme

# adapted from pxgettext as found in the plug-ins/perl directory

# 5.005_02 in particular seems to have a BIG BUG
# resulting in an endless loop and a memory leak in the 
# regex machinery :(
exit 1 unless $] > 5.005_02;

undef $/;

my $line;
my $file = "";
my $fileposition;
my $e;
my $s;

while (<>) {
    $file = $ARGV;
    $file =~ s/\.\.\///;
    $line = 0;

    while (/_\(?"((?:[^"\\]+|\\.)*)"\)?/sg) {
       $line++;
       my $s = $1;
       if ($s =~ /\n/) {
          $e = "msgid \"\"\n";
          for (split /\n/, $s) {
             $e .= "\"$_\\n\"\n";
          }
       } else {
          $e = "msgid \"$s\"\n";
       }
       $e .= "msgstr \"\"\n";

       $fileposition = "#: $file:$line\n";

       push @{$entry{$e}}, $fileposition;
    }
}

foreach $e (sort keys %entry) {
    print @{$entry{$e}};
    print $e;
    print "\n";
}

