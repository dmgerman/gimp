begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Compute a preview image and preview wireframe */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"map-object-main.h"
end_include

begin_include
include|#
directive|include
file|"map-object-ui.h"
end_include

begin_include
include|#
directive|include
file|"map-object-image.h"
end_include

begin_include
include|#
directive|include
file|"map-object-apply.h"
end_include

begin_include
include|#
directive|include
file|"map-object-shade.h"
end_include

begin_include
include|#
directive|include
file|"map-object-preview.h"
end_include

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2c2fd2c70108
block|{
DECL|member|x
DECL|member|y
DECL|member|w
DECL|member|h
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
DECL|member|image
name|cairo_surface_t
modifier|*
name|image
decl_stmt|;
DECL|typedef|BackBuffer
block|}
name|BackBuffer
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|mat
name|gdouble
name|mat
index|[
literal|3
index|]
index|[
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|lightx
DECL|variable|lighty
name|gint
name|lightx
decl_stmt|,
name|lighty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|backbuf
specifier|static
name|BackBuffer
name|backbuf
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Protos */
end_comment

begin_comment
comment|/* ====== */
end_comment

begin_function_decl
specifier|static
name|void
name|compute_preview
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_light_marker
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**************************************************************/
end_comment

begin_comment
comment|/* Computes a preview of the rectangle starting at (x,y) with */
end_comment

begin_comment
comment|/* dimensions (w,h), placing the result in preview_RGB_data.  */
end_comment

begin_comment
comment|/**************************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|compute_preview (gint x,gint y,gint w,gint h,gint pw,gint ph)
name|compute_preview
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|gdouble
name|xpostab
index|[
name|PREVIEW_WIDTH
index|]
decl_stmt|;
name|gdouble
name|ypostab
index|[
name|PREVIEW_HEIGHT
index|]
decl_stmt|;
name|gdouble
name|realw
decl_stmt|;
name|gdouble
name|realh
decl_stmt|;
name|GimpVector3
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|GimpRGB
name|color
decl_stmt|;
name|GimpRGB
name|lightcheck
decl_stmt|,
name|darkcheck
decl_stmt|;
name|gint
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|f1
decl_stmt|,
name|f2
decl_stmt|;
name|guchar
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|glong
name|index
init|=
literal|0
decl_stmt|;
name|init_compute
argument_list|()
expr_stmt|;
name|p1
operator|=
name|int_to_pos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|p2
operator|=
name|int_to_pos
argument_list|(
name|x
operator|+
name|w
argument_list|,
name|y
operator|+
name|h
argument_list|)
expr_stmt|;
comment|/* First, compute the linear mapping (x,y,x+w,y+h) to (0,0,pw,ph) */
comment|/* ============================================================== */
name|realw
operator|=
operator|(
name|p2
operator|.
name|x
operator|-
name|p1
operator|.
name|x
operator|)
expr_stmt|;
name|realh
operator|=
operator|(
name|p2
operator|.
name|y
operator|-
name|p1
operator|.
name|y
operator|)
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|pw
condition|;
name|xcnt
operator|++
control|)
name|xpostab
index|[
name|xcnt
index|]
operator|=
name|p1
operator|.
name|x
operator|+
name|realw
operator|*
operator|(
operator|(
name|gdouble
operator|)
name|xcnt
operator|/
operator|(
name|gdouble
operator|)
name|pw
operator|)
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|ph
condition|;
name|ycnt
operator|++
control|)
name|ypostab
index|[
name|ycnt
index|]
operator|=
name|p1
operator|.
name|y
operator|+
name|realh
operator|*
operator|(
operator|(
name|gdouble
operator|)
name|ycnt
operator|/
operator|(
name|gdouble
operator|)
name|ph
operator|)
expr_stmt|;
comment|/* Compute preview using the offset tables */
comment|/* ======================================= */
if|if
condition|(
name|mapvals
operator|.
name|transparent_background
operator|==
name|TRUE
condition|)
block|{
name|gimp_rgba_set
argument_list|(
operator|&
name|background
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_context_get_background
argument_list|(
operator|&
name|background
argument_list|)
expr_stmt|;
name|gimp_rgb_set_alpha
argument_list|(
operator|&
name|background
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
block|}
name|gimp_rgba_set
argument_list|(
operator|&
name|lightcheck
argument_list|,
name|GIMP_CHECK_LIGHT
argument_list|,
name|GIMP_CHECK_LIGHT
argument_list|,
name|GIMP_CHECK_LIGHT
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|gimp_rgba_set
argument_list|(
operator|&
name|darkcheck
argument_list|,
name|GIMP_CHECK_DARK
argument_list|,
name|GIMP_CHECK_DARK
argument_list|,
name|GIMP_CHECK_DARK
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p2
argument_list|,
operator|-
literal|1.0
argument_list|,
operator|-
literal|1.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|cairo_surface_flush
argument_list|(
name|preview_surface
argument_list|)
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|ph
condition|;
name|ycnt
operator|++
control|)
block|{
name|index
operator|=
name|ycnt
operator|*
name|preview_rgb_stride
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|pw
condition|;
name|xcnt
operator|++
control|)
block|{
name|p1
operator|.
name|x
operator|=
name|xpostab
index|[
name|xcnt
index|]
expr_stmt|;
name|p1
operator|.
name|y
operator|=
name|ypostab
index|[
name|ycnt
index|]
expr_stmt|;
name|p2
operator|=
name|p1
expr_stmt|;
name|color
operator|=
call|(
modifier|*
name|get_ray_color
call|)
argument_list|(
operator|&
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|color
operator|.
name|a
operator|<
literal|1.0
condition|)
block|{
name|f1
operator|=
operator|(
operator|(
name|xcnt
operator|%
literal|32
operator|)
operator|<
literal|16
operator|)
expr_stmt|;
name|f2
operator|=
operator|(
operator|(
name|ycnt
operator|%
literal|32
operator|)
operator|<
literal|16
operator|)
expr_stmt|;
name|f1
operator|=
name|f1
operator|^
name|f2
expr_stmt|;
if|if
condition|(
name|f1
condition|)
block|{
if|if
condition|(
name|color
operator|.
name|a
operator|==
literal|0.0
condition|)
name|color
operator|=
name|lightcheck
expr_stmt|;
else|else
name|gimp_rgb_composite
argument_list|(
operator|&
name|color
argument_list|,
operator|&
name|lightcheck
argument_list|,
name|GIMP_RGB_COMPOSITE_BEHIND
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|color
operator|.
name|a
operator|==
literal|0.0
condition|)
name|color
operator|=
name|darkcheck
expr_stmt|;
else|else
name|gimp_rgb_composite
argument_list|(
operator|&
name|color
argument_list|,
operator|&
name|darkcheck
argument_list|,
name|GIMP_RGB_COMPOSITE_BEHIND
argument_list|)
expr_stmt|;
block|}
block|}
name|gimp_rgb_get_uchar
argument_list|(
operator|&
name|color
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|GIMP_CAIRO_RGB24_SET_PIXEL
argument_list|(
operator|(
name|preview_rgb_data
operator|+
name|index
operator|)
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
block|}
block|}
name|cairo_surface_mark_dirty
argument_list|(
name|preview_surface
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Check if the given position is within the     */
end_comment

begin_comment
comment|/* light marker. Return TRUE if so, FALSE if not */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
name|gint
DECL|function|check_light_hit (gint xpos,gint ypos)
name|check_light_hit
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|r
decl_stmt|;
if|if
condition|(
name|mapvals
operator|.
name|lightsource
operator|.
name|type
operator|==
name|POINT_LIGHT
condition|)
block|{
name|dx
operator|=
operator|(
name|gdouble
operator|)
name|lightx
operator|-
name|xpos
expr_stmt|;
name|dy
operator|=
operator|(
name|gdouble
operator|)
name|lighty
operator|-
name|ypos
expr_stmt|;
name|r
operator|=
name|sqrt
argument_list|(
name|dx
operator|*
name|dx
operator|+
name|dy
operator|*
name|dy
argument_list|)
operator|+
literal|0.5
expr_stmt|;
if|if
condition|(
operator|(
name|gint
operator|)
name|r
operator|>
literal|7
condition|)
return|return
name|FALSE
return|;
else|else
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/* Draw a marker to show light position */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|draw_light_marker (gint xpos,gint ypos)
name|draw_light_marker
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|GdkColor
name|color
decl_stmt|;
name|cairo_t
modifier|*
name|cr
decl_stmt|,
modifier|*
name|cr_p
decl_stmt|;
name|gint
name|pw
decl_stmt|,
name|ph
decl_stmt|,
name|startx
decl_stmt|,
name|starty
decl_stmt|;
if|if
condition|(
name|mapvals
operator|.
name|lightsource
operator|.
name|type
operator|!=
name|POINT_LIGHT
condition|)
return|return;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|/
literal|2
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|/
literal|2
expr_stmt|;
name|cr
operator|=
name|gdk_cairo_create
argument_list|(
name|gtk_widget_get_window
argument_list|(
name|previewarea
argument_list|)
argument_list|)
expr_stmt|;
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
literal|0x0
expr_stmt|;
name|color
operator|.
name|green
operator|=
literal|0x4000
expr_stmt|;
name|color
operator|.
name|blue
operator|=
literal|0xFFFF
expr_stmt|;
name|gdk_cairo_set_source_color
argument_list|(
name|cr
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|lightx
operator|=
name|xpos
expr_stmt|;
name|lighty
operator|=
name|ypos
expr_stmt|;
comment|/* Save background */
comment|/* =============== */
name|backbuf
operator|.
name|x
operator|=
name|lightx
operator|-
literal|7
expr_stmt|;
name|backbuf
operator|.
name|y
operator|=
name|lighty
operator|-
literal|7
expr_stmt|;
name|backbuf
operator|.
name|w
operator|=
literal|14
expr_stmt|;
name|backbuf
operator|.
name|h
operator|=
literal|14
expr_stmt|;
comment|/* X doesn't like images that's outside a window, make sure */
comment|/* we get the backbuffer image from within the boundaries   */
comment|/* ======================================================== */
if|if
condition|(
name|backbuf
operator|.
name|x
operator|<
name|startx
condition|)
name|backbuf
operator|.
name|x
operator|=
name|startx
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|backbuf
operator|.
name|x
operator|+
name|backbuf
operator|.
name|w
operator|)
operator|>
name|startx
operator|+
name|pw
condition|)
name|backbuf
operator|.
name|w
operator|=
name|MAX
argument_list|(
name|startx
operator|+
name|pw
operator|-
name|backbuf
operator|.
name|x
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|backbuf
operator|.
name|y
operator|<
name|starty
condition|)
name|backbuf
operator|.
name|y
operator|=
name|starty
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|backbuf
operator|.
name|y
operator|+
name|backbuf
operator|.
name|h
operator|)
operator|>
name|starty
operator|+
name|ph
condition|)
name|backbuf
operator|.
name|h
operator|=
name|MAX
argument_list|(
name|starty
operator|+
name|ph
operator|-
name|backbuf
operator|.
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|backbuf
operator|.
name|image
condition|)
name|cairo_surface_destroy
argument_list|(
name|backbuf
operator|.
name|image
argument_list|)
expr_stmt|;
name|backbuf
operator|.
name|image
operator|=
name|cairo_surface_create_similar
argument_list|(
name|preview_surface
argument_list|,
name|CAIRO_CONTENT_COLOR
argument_list|,
name|PREVIEW_WIDTH
argument_list|,
name|PREVIEW_HEIGHT
argument_list|)
expr_stmt|;
name|cr_p
operator|=
name|cairo_create
argument_list|(
name|backbuf
operator|.
name|image
argument_list|)
expr_stmt|;
name|cairo_rectangle
argument_list|(
name|cr_p
argument_list|,
name|backbuf
operator|.
name|x
argument_list|,
name|backbuf
operator|.
name|y
argument_list|,
name|backbuf
operator|.
name|w
argument_list|,
name|backbuf
operator|.
name|h
argument_list|)
expr_stmt|;
name|cairo_clip
argument_list|(
name|cr_p
argument_list|)
expr_stmt|;
name|cairo_set_source_surface
argument_list|(
name|cr_p
argument_list|,
name|preview_surface
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|)
expr_stmt|;
name|cairo_paint
argument_list|(
name|cr_p
argument_list|)
expr_stmt|;
name|cairo_destroy
argument_list|(
name|cr_p
argument_list|)
expr_stmt|;
name|cairo_arc
argument_list|(
name|cr
argument_list|,
name|lightx
argument_list|,
name|lighty
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|2
operator|*
name|M_PI
argument_list|)
expr_stmt|;
name|cairo_fill
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_destroy
argument_list|(
name|cr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|draw_lights (gint startx,gint starty,gint pw,gint ph)
name|draw_lights
parameter_list|(
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|gdouble
name|dxpos
decl_stmt|,
name|dypos
decl_stmt|;
name|gint
name|xpos
decl_stmt|,
name|ypos
decl_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|dxpos
argument_list|,
operator|&
name|dypos
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|mapvals
operator|.
name|lightsource
operator|.
name|position
argument_list|)
expr_stmt|;
name|xpos
operator|=
name|RINT
argument_list|(
name|dxpos
argument_list|)
expr_stmt|;
name|ypos
operator|=
name|RINT
argument_list|(
name|dypos
argument_list|)
expr_stmt|;
if|if
condition|(
name|xpos
operator|>=
literal|0
operator|&&
name|xpos
operator|<=
name|PREVIEW_WIDTH
operator|&&
name|ypos
operator|>=
literal|0
operator|&&
name|ypos
operator|<=
name|PREVIEW_HEIGHT
condition|)
block|{
name|draw_light_marker
argument_list|(
name|xpos
argument_list|,
name|ypos
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Update light position given new screen coords */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
name|void
DECL|function|update_light (gint xpos,gint ypos)
name|update_light
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|/
literal|2
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|/
literal|2
expr_stmt|;
name|gimp_vector_2d_to_3d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|xpos
argument_list|,
name|ypos
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|mapvals
operator|.
name|lightsource
operator|.
name|position
argument_list|)
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|previewarea
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************/
end_comment

begin_comment
comment|/* Draw preview image. if DoCompute is TRUE then recompute image. */
end_comment

begin_comment
comment|/******************************************************************/
end_comment

begin_function
name|void
DECL|function|compute_preview_image (void)
name|compute_preview_image
parameter_list|(
name|void
parameter_list|)
block|{
name|GdkDisplay
modifier|*
name|display
init|=
name|gtk_widget_get_display
argument_list|(
name|previewarea
argument_list|)
decl_stmt|;
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|/
literal|2
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|/
literal|2
expr_stmt|;
name|cursor
operator|=
name|gdk_cursor_new_for_display
argument_list|(
name|display
argument_list|,
name|GDK_WATCH
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|gtk_widget_get_window
argument_list|(
name|previewarea
argument_list|)
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_unref
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
name|compute_preview
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|width
operator|-
literal|1
argument_list|,
name|height
operator|-
literal|1
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|gdk_cursor_new_for_display
argument_list|(
name|display
argument_list|,
name|GDK_HAND2
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|gtk_widget_get_window
argument_list|(
name|previewarea
argument_list|)
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_unref
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|gboolean
DECL|function|preview_expose (GtkWidget * widget,GdkEventExpose * eevent)
name|preview_expose
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventExpose
modifier|*
name|eevent
parameter_list|)
block|{
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|GdkColor
name|color
decl_stmt|;
name|cairo_t
modifier|*
name|cr
decl_stmt|;
name|cr
operator|=
name|gdk_cairo_create
argument_list|(
name|eevent
operator|->
name|window
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
literal|0xFFFF
expr_stmt|;
name|color
operator|.
name|green
operator|=
literal|0xFFFF
expr_stmt|;
name|color
operator|.
name|blue
operator|=
literal|0xFFFF
expr_stmt|;
name|gdk_cairo_set_source_color
argument_list|(
name|cr
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|/
literal|2
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|/
literal|2
expr_stmt|;
name|cairo_set_source_surface
argument_list|(
name|cr
argument_list|,
name|preview_surface
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|)
expr_stmt|;
name|cairo_rectangle
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cairo_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_paint
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|draw_lights
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cairo_destroy
argument_list|(
name|cr
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

end_unit

