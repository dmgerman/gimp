begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Compute a preview image and preview wireframe */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"map-object-main.h"
end_include

begin_include
include|#
directive|include
file|"map-object-ui.h"
end_include

begin_include
include|#
directive|include
file|"map-object-image.h"
end_include

begin_include
include|#
directive|include
file|"map-object-apply.h"
end_include

begin_include
include|#
directive|include
file|"map-object-shade.h"
end_include

begin_include
include|#
directive|include
file|"map-object-preview.h"
end_include

begin_decl_stmt
DECL|variable|mat
name|gdouble
name|mat
index|[
literal|3
index|]
index|[
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|lightx
DECL|variable|lighty
name|gint
name|lightx
decl_stmt|,
name|lighty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Protos */
end_comment

begin_comment
comment|/* ====== */
end_comment

begin_function_decl
specifier|static
name|void
name|compute_preview
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_light_marker
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_line
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|,
name|gdouble
name|cx1
parameter_list|,
name|gdouble
name|cy1
parameter_list|,
name|gdouble
name|cx2
parameter_list|,
name|gdouble
name|cy2
parameter_list|,
name|GimpVector3
name|a
parameter_list|,
name|GimpVector3
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_wireframe
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_preview_wireframe
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_wireframe_plane
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_wireframe_sphere
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_wireframe_box
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|draw_wireframe_cylinder
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**************************************************************/
end_comment

begin_comment
comment|/* Computes a preview of the rectangle starting at (x,y) with */
end_comment

begin_comment
comment|/* dimensions (w,h), placing the result in preview_RGB_data.  */
end_comment

begin_comment
comment|/**************************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|compute_preview (gint x,gint y,gint w,gint h,gint pw,gint ph)
name|compute_preview
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|gdouble
name|xpostab
index|[
name|PREVIEW_WIDTH
index|]
decl_stmt|;
name|gdouble
name|ypostab
index|[
name|PREVIEW_HEIGHT
index|]
decl_stmt|;
name|gdouble
name|realw
decl_stmt|;
name|gdouble
name|realh
decl_stmt|;
name|GimpVector3
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|GimpRGB
name|color
decl_stmt|;
name|GimpRGB
name|lightcheck
decl_stmt|,
name|darkcheck
decl_stmt|;
name|gint
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|f1
decl_stmt|,
name|f2
decl_stmt|;
name|guchar
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|glong
name|index
init|=
literal|0
decl_stmt|;
name|init_compute
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|preview_surface
condition|)
return|return;
name|p1
operator|=
name|int_to_pos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|p2
operator|=
name|int_to_pos
argument_list|(
name|x
operator|+
name|w
argument_list|,
name|y
operator|+
name|h
argument_list|)
expr_stmt|;
comment|/* First, compute the linear mapping (x,y,x+w,y+h) to (0,0,pw,ph) */
comment|/* ============================================================== */
name|realw
operator|=
operator|(
name|p2
operator|.
name|x
operator|-
name|p1
operator|.
name|x
operator|)
expr_stmt|;
name|realh
operator|=
operator|(
name|p2
operator|.
name|y
operator|-
name|p1
operator|.
name|y
operator|)
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|pw
condition|;
name|xcnt
operator|++
control|)
name|xpostab
index|[
name|xcnt
index|]
operator|=
name|p1
operator|.
name|x
operator|+
name|realw
operator|*
operator|(
operator|(
name|gdouble
operator|)
name|xcnt
operator|/
operator|(
name|gdouble
operator|)
name|pw
operator|)
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|ph
condition|;
name|ycnt
operator|++
control|)
name|ypostab
index|[
name|ycnt
index|]
operator|=
name|p1
operator|.
name|y
operator|+
name|realh
operator|*
operator|(
operator|(
name|gdouble
operator|)
name|ycnt
operator|/
operator|(
name|gdouble
operator|)
name|ph
operator|)
expr_stmt|;
comment|/* Compute preview using the offset tables */
comment|/* ======================================= */
if|if
condition|(
name|mapvals
operator|.
name|transparent_background
operator|==
name|TRUE
condition|)
block|{
name|gimp_rgba_set
argument_list|(
operator|&
name|background
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_context_get_background
argument_list|(
operator|&
name|background
argument_list|)
expr_stmt|;
name|gimp_rgb_set_alpha
argument_list|(
operator|&
name|background
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
block|}
name|gimp_rgba_set
argument_list|(
operator|&
name|lightcheck
argument_list|,
name|GIMP_CHECK_LIGHT
argument_list|,
name|GIMP_CHECK_LIGHT
argument_list|,
name|GIMP_CHECK_LIGHT
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|gimp_rgba_set
argument_list|(
operator|&
name|darkcheck
argument_list|,
name|GIMP_CHECK_DARK
argument_list|,
name|GIMP_CHECK_DARK
argument_list|,
name|GIMP_CHECK_DARK
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p2
argument_list|,
operator|-
literal|1.0
argument_list|,
operator|-
literal|1.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|cairo_surface_flush
argument_list|(
name|preview_surface
argument_list|)
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|ph
condition|;
name|ycnt
operator|++
control|)
block|{
name|index
operator|=
name|ycnt
operator|*
name|preview_rgb_stride
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|pw
condition|;
name|xcnt
operator|++
control|)
block|{
name|p1
operator|.
name|x
operator|=
name|xpostab
index|[
name|xcnt
index|]
expr_stmt|;
name|p1
operator|.
name|y
operator|=
name|ypostab
index|[
name|ycnt
index|]
expr_stmt|;
name|p2
operator|=
name|p1
expr_stmt|;
name|color
operator|=
call|(
modifier|*
name|get_ray_color
call|)
argument_list|(
operator|&
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|color
operator|.
name|a
operator|<
literal|1.0
condition|)
block|{
name|f1
operator|=
operator|(
operator|(
name|xcnt
operator|%
literal|32
operator|)
operator|<
literal|16
operator|)
expr_stmt|;
name|f2
operator|=
operator|(
operator|(
name|ycnt
operator|%
literal|32
operator|)
operator|<
literal|16
operator|)
expr_stmt|;
name|f1
operator|=
name|f1
operator|^
name|f2
expr_stmt|;
if|if
condition|(
name|f1
condition|)
block|{
if|if
condition|(
name|color
operator|.
name|a
operator|==
literal|0.0
condition|)
name|color
operator|=
name|lightcheck
expr_stmt|;
else|else
name|gimp_rgb_composite
argument_list|(
operator|&
name|color
argument_list|,
operator|&
name|lightcheck
argument_list|,
name|GIMP_RGB_COMPOSITE_BEHIND
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|color
operator|.
name|a
operator|==
literal|0.0
condition|)
name|color
operator|=
name|darkcheck
expr_stmt|;
else|else
name|gimp_rgb_composite
argument_list|(
operator|&
name|color
argument_list|,
operator|&
name|darkcheck
argument_list|,
name|GIMP_RGB_COMPOSITE_BEHIND
argument_list|)
expr_stmt|;
block|}
block|}
name|gimp_rgb_get_uchar
argument_list|(
operator|&
name|color
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|GIMP_CAIRO_RGB24_SET_PIXEL
argument_list|(
operator|(
name|preview_rgb_data
operator|+
name|index
operator|)
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
block|}
block|}
name|cairo_surface_mark_dirty
argument_list|(
name|preview_surface
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Check if the given position is within the     */
end_comment

begin_comment
comment|/* light marker. Return TRUE if so, FALSE if not */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
name|gint
DECL|function|check_light_hit (gint xpos,gint ypos)
name|check_light_hit
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|r
decl_stmt|;
if|if
condition|(
name|mapvals
operator|.
name|lightsource
operator|.
name|type
operator|==
name|POINT_LIGHT
condition|)
block|{
name|dx
operator|=
operator|(
name|gdouble
operator|)
name|lightx
operator|-
name|xpos
expr_stmt|;
name|dy
operator|=
operator|(
name|gdouble
operator|)
name|lighty
operator|-
name|ypos
expr_stmt|;
name|r
operator|=
name|sqrt
argument_list|(
name|dx
operator|*
name|dx
operator|+
name|dy
operator|*
name|dy
argument_list|)
operator|+
literal|0.5
expr_stmt|;
if|if
condition|(
operator|(
name|gint
operator|)
name|r
operator|>
literal|7
condition|)
return|return
name|FALSE
return|;
else|else
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/* Draw a marker to show light position */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|draw_light_marker (cairo_t * cr,gint xpos,gint ypos)
name|draw_light_marker
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|GdkColor
name|color
decl_stmt|;
if|if
condition|(
name|mapvals
operator|.
name|lightsource
operator|.
name|type
operator|!=
name|POINT_LIGHT
condition|)
return|return;
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
literal|0x0
expr_stmt|;
name|color
operator|.
name|green
operator|=
literal|0x4000
expr_stmt|;
name|color
operator|.
name|blue
operator|=
literal|0xFFFF
expr_stmt|;
name|gdk_cairo_set_source_color
argument_list|(
name|cr
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|lightx
operator|=
name|xpos
expr_stmt|;
name|lighty
operator|=
name|ypos
expr_stmt|;
name|cairo_arc
argument_list|(
name|cr
argument_list|,
name|lightx
argument_list|,
name|lighty
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|2
operator|*
name|G_PI
argument_list|)
expr_stmt|;
name|cairo_fill
argument_list|(
name|cr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|draw_lights (cairo_t * cr,gint startx,gint starty,gint pw,gint ph)
name|draw_lights
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|gdouble
name|dxpos
decl_stmt|,
name|dypos
decl_stmt|;
name|gint
name|xpos
decl_stmt|,
name|ypos
decl_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|dxpos
argument_list|,
operator|&
name|dypos
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|mapvals
operator|.
name|lightsource
operator|.
name|position
argument_list|)
expr_stmt|;
name|xpos
operator|=
name|RINT
argument_list|(
name|dxpos
argument_list|)
expr_stmt|;
name|ypos
operator|=
name|RINT
argument_list|(
name|dypos
argument_list|)
expr_stmt|;
if|if
condition|(
name|xpos
operator|>=
literal|0
operator|&&
name|xpos
operator|<=
name|PREVIEW_WIDTH
operator|&&
name|ypos
operator|>=
literal|0
operator|&&
name|ypos
operator|<=
name|PREVIEW_HEIGHT
condition|)
block|{
name|draw_light_marker
argument_list|(
name|cr
argument_list|,
name|xpos
argument_list|,
name|ypos
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Update light position given new screen coords */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
name|void
DECL|function|update_light (gint xpos,gint ypos)
name|update_light
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|/
literal|2
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|/
literal|2
expr_stmt|;
name|gimp_vector_2d_to_3d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|xpos
argument_list|,
name|ypos
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|mapvals
operator|.
name|lightsource
operator|.
name|position
argument_list|)
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|previewarea
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************/
end_comment

begin_comment
comment|/* Compute preview image. */
end_comment

begin_comment
comment|/**************************/
end_comment

begin_function
name|void
DECL|function|compute_preview_image (void)
name|compute_preview_image
parameter_list|(
name|void
parameter_list|)
block|{
name|GdkDisplay
modifier|*
name|display
init|=
name|gtk_widget_get_display
argument_list|(
name|previewarea
argument_list|)
decl_stmt|;
name|GdkCursor
modifier|*
name|cursor
decl_stmt|;
name|gint
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|cursor
operator|=
name|gdk_cursor_new_for_display
argument_list|(
name|display
argument_list|,
name|GDK_WATCH
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|gtk_widget_get_window
argument_list|(
name|previewarea
argument_list|)
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_unref
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
name|compute_preview
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|width
operator|-
literal|1
argument_list|,
name|height
operator|-
literal|1
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|gdk_cursor_new_for_display
argument_list|(
name|display
argument_list|,
name|GDK_HAND2
argument_list|)
expr_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|gtk_widget_get_window
argument_list|(
name|previewarea
argument_list|)
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_unref
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|gboolean
DECL|function|preview_expose (GtkWidget * widget,GdkEventExpose * eevent)
name|preview_expose
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventExpose
modifier|*
name|eevent
parameter_list|)
block|{
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|cairo_t
modifier|*
name|cr
decl_stmt|;
name|cr
operator|=
name|gdk_cairo_create
argument_list|(
name|eevent
operator|->
name|window
argument_list|)
expr_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|/
literal|2
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|/
literal|2
expr_stmt|;
name|cairo_set_source_surface
argument_list|(
name|cr
argument_list|,
name|preview_surface
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|)
expr_stmt|;
name|cairo_rectangle
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cairo_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_paint
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_reset_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mapvals
operator|.
name|showgrid
condition|)
name|draw_preview_wireframe
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_reset_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|draw_lights
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cairo_destroy
argument_list|(
name|cr
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**************************/
end_comment

begin_comment
comment|/* Draw preview wireframe */
end_comment

begin_comment
comment|/**************************/
end_comment

begin_function
name|void
DECL|function|draw_preview_wireframe (cairo_t * cr)
name|draw_preview_wireframe
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|)
block|{
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|*
name|mapvals
operator|.
name|zoom
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|/
literal|2
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|/
literal|2
expr_stmt|;
name|draw_wireframe
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/* Draw a wireframe preview */
end_comment

begin_comment
comment|/****************************/
end_comment

begin_function
name|void
DECL|function|draw_wireframe (cairo_t * cr,gint startx,gint starty,gint pw,gint ph)
name|draw_wireframe
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|cairo_set_source_rgb
argument_list|(
name|cr
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mapvals
operator|.
name|maptype
condition|)
block|{
case|case
name|MAP_PLANE
case|:
name|draw_wireframe_plane
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
break|break;
case|case
name|MAP_SPHERE
case|:
name|draw_wireframe_sphere
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
break|break;
case|case
name|MAP_BOX
case|:
name|draw_wireframe_box
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
break|break;
case|case
name|MAP_CYLINDER
case|:
name|draw_wireframe_cylinder
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|draw_wireframe_plane (cairo_t * cr,gint startx,gint starty,gint pw,gint ph)
name|draw_wireframe_plane
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|GimpVector3
name|v1
decl_stmt|,
name|v2
decl_stmt|,
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|dir1
decl_stmt|,
name|dir2
decl_stmt|;
name|gint
name|cnt
decl_stmt|;
name|gdouble
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|fac
decl_stmt|;
name|cairo_rectangle
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cairo_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
comment|/* Find rotated box corners */
comment|/* ======================== */
name|gimp_vector3_set
argument_list|(
operator|&
name|v1
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|v2
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gimp_vector3_rotate
argument_list|(
operator|&
name|v1
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_vector3_rotate
argument_list|(
operator|&
name|v2
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|dir1
operator|=
name|v1
expr_stmt|;
name|gimp_vector3_normalize
argument_list|(
operator|&
name|dir1
argument_list|)
expr_stmt|;
name|dir2
operator|=
name|v2
expr_stmt|;
name|gimp_vector3_normalize
argument_list|(
operator|&
name|dir2
argument_list|)
expr_stmt|;
name|fac
operator|=
literal|1.0
operator|/
operator|(
name|gdouble
operator|)
name|WIRESIZE
expr_stmt|;
name|gimp_vector3_mul
argument_list|(
operator|&
name|dir1
argument_list|,
name|fac
argument_list|)
expr_stmt|;
name|gimp_vector3_mul
argument_list|(
operator|&
name|dir2
argument_list|,
name|fac
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|,
operator|&
name|v1
argument_list|)
expr_stmt|;
name|gimp_vector3_sub
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|v2
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|v2
argument_list|)
expr_stmt|;
name|gimp_vector3_sub
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|,
operator|&
name|v1
argument_list|)
expr_stmt|;
name|gimp_vector3_sub
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|v2
argument_list|)
expr_stmt|;
name|c
operator|=
name|b
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<=
name|WIRESIZE
condition|;
name|cnt
operator|++
control|)
block|{
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|cairo_move_to
argument_list|(
name|cr
argument_list|,
name|RINT
argument_list|(
name|x1
argument_list|)
operator|+
literal|0.5
argument_list|,
name|RINT
argument_list|(
name|y1
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|cairo_line_to
argument_list|(
name|cr
argument_list|,
name|RINT
argument_list|(
name|x2
argument_list|)
operator|+
literal|0.5
argument_list|,
name|RINT
argument_list|(
name|y2
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
name|cairo_move_to
argument_list|(
name|cr
argument_list|,
name|RINT
argument_list|(
name|x1
argument_list|)
operator|+
literal|0.5
argument_list|,
name|RINT
argument_list|(
name|y1
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|cairo_line_to
argument_list|(
name|cr
argument_list|,
name|RINT
argument_list|(
name|x2
argument_list|)
operator|+
literal|0.5
argument_list|,
name|RINT
argument_list|(
name|y2
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|gimp_vector3_sub
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|dir1
argument_list|)
expr_stmt|;
name|gimp_vector3_sub
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|dir1
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|dir2
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|dir2
argument_list|)
expr_stmt|;
block|}
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|3.0
argument_list|)
expr_stmt|;
name|cairo_stroke_preserve
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|cairo_set_source_rgb
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|cairo_stroke
argument_list|(
name|cr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|draw_wireframe_sphere (cairo_t * cr,gint startx,gint starty,gint pw,gint ph)
name|draw_wireframe_sphere
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|GimpVector3
name|p
index|[
literal|2
operator|*
operator|(
name|WIRESIZE
operator|+
literal|5
operator|)
index|]
decl_stmt|;
name|gint
name|cnt
decl_stmt|,
name|cnt2
decl_stmt|;
name|gdouble
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|twopifac
decl_stmt|;
name|cairo_rectangle
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cairo_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
comment|/* Compute wireframe points */
comment|/* ======================== */
name|twopifac
operator|=
operator|(
literal|2.0
operator|*
name|G_PI
operator|)
operator|/
name|WIRESIZE
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
name|WIRESIZE
condition|;
name|cnt
operator|++
control|)
block|{
name|p
index|[
name|cnt
index|]
operator|.
name|x
operator|=
name|mapvals
operator|.
name|radius
operator|*
name|cos
argument_list|(
operator|(
name|gdouble
operator|)
name|cnt
operator|*
name|twopifac
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
index|]
operator|.
name|y
operator|=
literal|0.0
expr_stmt|;
name|p
index|[
name|cnt
index|]
operator|.
name|z
operator|=
name|mapvals
operator|.
name|radius
operator|*
name|sin
argument_list|(
operator|(
name|gdouble
operator|)
name|cnt
operator|*
name|twopifac
argument_list|)
expr_stmt|;
name|gimp_vector3_rotate
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
block|}
name|p
index|[
name|cnt
index|]
operator|=
name|p
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|cnt
operator|=
name|WIRESIZE
operator|+
literal|1
init|;
name|cnt
operator|<
literal|2
operator|*
name|WIRESIZE
operator|+
literal|1
condition|;
name|cnt
operator|++
control|)
block|{
name|p
index|[
name|cnt
index|]
operator|.
name|x
operator|=
name|mapvals
operator|.
name|radius
operator|*
name|cos
argument_list|(
call|(
name|gdouble
call|)
argument_list|(
name|cnt
operator|-
operator|(
name|WIRESIZE
operator|+
literal|1
operator|)
argument_list|)
operator|*
name|twopifac
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
index|]
operator|.
name|y
operator|=
name|mapvals
operator|.
name|radius
operator|*
name|sin
argument_list|(
call|(
name|gdouble
call|)
argument_list|(
name|cnt
operator|-
operator|(
name|WIRESIZE
operator|+
literal|1
operator|)
argument_list|)
operator|*
name|twopifac
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
index|]
operator|.
name|z
operator|=
literal|0.0
expr_stmt|;
name|gimp_vector3_rotate
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
block|}
name|p
index|[
name|cnt
index|]
operator|=
name|p
index|[
name|WIRESIZE
operator|+
literal|1
index|]
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
name|cnt2
operator|=
name|cnt
expr_stmt|;
comment|/* Find rotated axis */
comment|/* ================= */
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
literal|0.0
argument_list|,
operator|-
literal|0.35
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gimp_vector3_rotate
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
operator|+
literal|1
index|]
operator|=
name|mapvals
operator|.
name|position
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|2
index|]
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|-
literal|0.35
argument_list|)
expr_stmt|;
name|gimp_vector3_rotate
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|2
index|]
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gimp_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
operator|+
literal|3
index|]
operator|=
name|mapvals
operator|.
name|position
expr_stmt|;
name|p
index|[
name|cnt
operator|+
literal|4
index|]
operator|=
name|p
index|[
name|cnt
index|]
expr_stmt|;
name|gimp_vector3_mul
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|4
index|]
argument_list|,
operator|-
literal|1.0
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
operator|+
literal|5
index|]
operator|=
name|p
index|[
name|cnt
operator|+
literal|1
index|]
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|2
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
operator|+
literal|2
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|4
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
operator|+
literal|4
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
comment|/* Draw the circles (equator and zero meridian) */
comment|/* ============================================ */
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
name|cnt2
operator|-
literal|1
condition|;
name|cnt
operator|++
control|)
block|{
if|if
condition|(
name|p
index|[
name|cnt
index|]
operator|.
name|z
operator|>
name|mapvals
operator|.
name|position
operator|.
name|z
operator|&&
name|p
index|[
name|cnt
operator|+
literal|1
index|]
operator|.
name|z
operator|>
name|mapvals
operator|.
name|position
operator|.
name|z
condition|)
block|{
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|p
index|[
name|cnt
index|]
argument_list|)
expr_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|p
index|[
name|cnt
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|cairo_move_to
argument_list|(
name|cr
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|x1
operator|+
literal|0.5
argument_list|)
operator|+
literal|0.5
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|y1
operator|+
literal|0.5
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|cairo_line_to
argument_list|(
name|cr
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|x2
operator|+
literal|0.5
argument_list|)
operator|+
literal|0.5
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|y2
operator|+
literal|0.5
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Draw the axis (pole to pole and center to zero meridian) */
comment|/* ======================================================== */
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|3
condition|;
name|cnt
operator|++
control|)
block|{
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|p
index|[
name|cnt2
index|]
argument_list|)
expr_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|p
index|[
name|cnt2
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|cairo_move_to
argument_list|(
name|cr
argument_list|,
name|RINT
argument_list|(
name|x1
argument_list|)
operator|+
literal|0.5
argument_list|,
name|RINT
argument_list|(
name|y1
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|cairo_line_to
argument_list|(
name|cr
argument_list|,
name|RINT
argument_list|(
name|x2
argument_list|)
operator|+
literal|0.5
argument_list|,
name|RINT
argument_list|(
name|y2
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|cnt2
operator|+=
literal|2
expr_stmt|;
block|}
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|3.0
argument_list|)
expr_stmt|;
name|cairo_stroke_preserve
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|cairo_set_source_rgb
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|cairo_stroke
argument_list|(
name|cr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|draw_line (cairo_t * cr,gint startx,gint starty,gint pw,gint ph,gdouble cx1,gdouble cy1,gdouble cx2,gdouble cy2,GimpVector3 a,GimpVector3 b)
name|draw_line
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|,
name|gdouble
name|cx1
parameter_list|,
name|gdouble
name|cy1
parameter_list|,
name|gdouble
name|cx2
parameter_list|,
name|gdouble
name|cy2
parameter_list|,
name|GimpVector3
name|a
parameter_list|,
name|GimpVector3
name|b
parameter_list|)
block|{
name|gdouble
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
name|gimp_vector_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|cairo_move_to
argument_list|(
name|cr
argument_list|,
name|RINT
argument_list|(
name|x1
argument_list|)
operator|+
literal|0.5
argument_list|,
name|RINT
argument_list|(
name|y1
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|cairo_line_to
argument_list|(
name|cr
argument_list|,
name|RINT
argument_list|(
name|x2
argument_list|)
operator|+
literal|0.5
argument_list|,
name|RINT
argument_list|(
name|y2
argument_list|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|draw_wireframe_box (cairo_t * cr,gint startx,gint starty,gint pw,gint ph)
name|draw_wireframe_box
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|GimpVector3
name|p
index|[
literal|8
index|]
decl_stmt|,
name|tmp
decl_stmt|,
name|scale
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gdouble
name|cx1
decl_stmt|,
name|cy1
decl_stmt|,
name|cx2
decl_stmt|,
name|cy2
decl_stmt|;
name|cairo_rectangle
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cairo_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
comment|/* Compute wireframe points */
comment|/* ======================== */
name|init_compute
argument_list|()
expr_stmt|;
name|scale
operator|=
name|mapvals
operator|.
name|scale
expr_stmt|;
name|gimp_vector3_mul
argument_list|(
operator|&
name|scale
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
literal|0
index|]
argument_list|,
operator|-
name|scale
operator|.
name|x
argument_list|,
operator|-
name|scale
operator|.
name|y
argument_list|,
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
literal|1
index|]
argument_list|,
name|scale
operator|.
name|x
argument_list|,
operator|-
name|scale
operator|.
name|y
argument_list|,
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
name|scale
operator|.
name|x
argument_list|,
name|scale
operator|.
name|y
argument_list|,
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
literal|3
index|]
argument_list|,
operator|-
name|scale
operator|.
name|x
argument_list|,
name|scale
operator|.
name|y
argument_list|,
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
literal|4
index|]
argument_list|,
operator|-
name|scale
operator|.
name|x
argument_list|,
operator|-
name|scale
operator|.
name|y
argument_list|,
operator|-
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
literal|5
index|]
argument_list|,
name|scale
operator|.
name|x
argument_list|,
operator|-
name|scale
operator|.
name|y
argument_list|,
operator|-
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
literal|6
index|]
argument_list|,
name|scale
operator|.
name|x
argument_list|,
name|scale
operator|.
name|y
argument_list|,
operator|-
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|p
index|[
literal|7
index|]
argument_list|,
operator|-
name|scale
operator|.
name|x
argument_list|,
name|scale
operator|.
name|y
argument_list|,
operator|-
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
comment|/* Rotate and translate points */
comment|/* =========================== */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|vecmulmat
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|p
index|[
name|i
index|]
argument_list|,
name|rotmat
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|p
index|[
name|i
index|]
argument_list|,
operator|&
name|tmp
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
block|}
comment|/* Draw the box */
comment|/* ============ */
name|cx1
operator|=
operator|(
name|gdouble
operator|)
name|startx
expr_stmt|;
name|cy1
operator|=
operator|(
name|gdouble
operator|)
name|starty
expr_stmt|;
name|cx2
operator|=
name|cx1
operator|+
operator|(
name|gdouble
operator|)
name|pw
expr_stmt|;
name|cy2
operator|=
name|cy1
operator|+
operator|(
name|gdouble
operator|)
name|ph
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|,
name|p
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|2
index|]
argument_list|,
name|p
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|3
index|]
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|,
name|p
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|5
index|]
argument_list|,
name|p
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|6
index|]
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|,
name|p
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|2
index|]
argument_list|,
name|p
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|3
index|]
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|3.0
argument_list|)
expr_stmt|;
name|cairo_stroke_preserve
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|cairo_set_source_rgb
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|cairo_stroke
argument_list|(
name|cr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|draw_wireframe_cylinder (cairo_t * cr,gint startx,gint starty,gint pw,gint ph)
name|draw_wireframe_cylinder
parameter_list|(
name|cairo_t
modifier|*
name|cr
parameter_list|,
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|GimpVector3
name|p
index|[
literal|2
operator|*
literal|8
index|]
decl_stmt|,
name|a
decl_stmt|,
name|axis
decl_stmt|,
name|scale
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gdouble
name|cx1
decl_stmt|,
name|cy1
decl_stmt|,
name|cx2
decl_stmt|,
name|cy2
decl_stmt|;
name|gfloat
name|m
index|[
literal|16
index|]
decl_stmt|,
name|l
decl_stmt|,
name|angle
decl_stmt|;
name|cairo_rectangle
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|cairo_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
comment|/* Compute wireframe points */
comment|/* ======================== */
name|init_compute
argument_list|()
expr_stmt|;
name|scale
operator|=
name|mapvals
operator|.
name|scale
expr_stmt|;
name|gimp_vector3_mul
argument_list|(
operator|&
name|scale
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|l
operator|=
name|mapvals
operator|.
name|cylinder_length
operator|/
literal|2.0
expr_stmt|;
name|angle
operator|=
literal|0
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|axis
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|rotatemat
argument_list|(
name|angle
argument_list|,
operator|&
name|axis
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|gimp_vector3_set
argument_list|(
operator|&
name|a
argument_list|,
name|mapvals
operator|.
name|cylinder_radius
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|vecmulmat
argument_list|(
operator|&
name|p
index|[
name|i
index|]
argument_list|,
operator|&
name|a
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|p
index|[
name|i
operator|+
literal|8
index|]
operator|=
name|p
index|[
name|i
index|]
expr_stmt|;
name|p
index|[
name|i
index|]
operator|.
name|y
operator|+=
name|l
expr_stmt|;
name|p
index|[
name|i
operator|+
literal|8
index|]
operator|.
name|y
operator|-=
name|l
expr_stmt|;
name|angle
operator|+=
literal|360.0
operator|/
literal|8.0
expr_stmt|;
block|}
comment|/* Rotate and translate points */
comment|/* =========================== */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|vecmulmat
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|p
index|[
name|i
index|]
argument_list|,
name|rotmat
argument_list|)
expr_stmt|;
name|gimp_vector3_add
argument_list|(
operator|&
name|p
index|[
name|i
index|]
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
block|}
comment|/* Draw the box */
comment|/* ============ */
name|cx1
operator|=
operator|(
name|gdouble
operator|)
name|startx
expr_stmt|;
name|cy1
operator|=
operator|(
name|gdouble
operator|)
name|starty
expr_stmt|;
name|cx2
operator|=
name|cx1
operator|+
operator|(
name|gdouble
operator|)
name|pw
expr_stmt|;
name|cy2
operator|=
name|cy1
operator|+
operator|(
name|gdouble
operator|)
name|ph
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
block|{
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
name|i
index|]
argument_list|,
name|p
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
name|i
operator|+
literal|8
index|]
argument_list|,
name|p
index|[
name|i
operator|+
literal|9
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
name|i
index|]
argument_list|,
name|p
index|[
name|i
operator|+
literal|8
index|]
argument_list|)
expr_stmt|;
block|}
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|draw_line
argument_list|(
name|cr
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|,
name|p
index|[
literal|15
index|]
argument_list|,
name|p
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|3.0
argument_list|)
expr_stmt|;
name|cairo_stroke_preserve
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_set_line_width
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|cairo_set_source_rgb
argument_list|(
name|cr
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|cairo_stroke
argument_list|(
name|cr
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

