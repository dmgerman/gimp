begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_empty
empty|#ident "@(#)run_tbl.c	3.1 95/08/30 Copyright (c) 1994 Gert Doering"
end_empty

begin_comment
comment|/* run_tbl.c  *  * this file is part of the mgetty+sendfax distribution  *  * compute a set of arrays that will speed up finding the run length  * of black or white bits in a byte enourmously  * (I do not include the array as it is larger than the source and  * computation is fast enough - 0.005 secs on my machine...)  */
end_comment

begin_decl_stmt
DECL|variable|tab
specifier|static
name|unsigned
name|char
name|tab
index|[
literal|9
index|]
init|=
block|{
literal|0x00
block|,
literal|0x01
block|,
literal|0x03
block|,
literal|0x07
block|,
literal|0x0f
block|,
literal|0x1f
block|,
literal|0x3f
block|,
literal|0x7f
block|,
literal|0xff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|w_rtab
name|char
name|w_rtab
index|[
literal|8
index|]
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|b_rtab
name|char
name|b_rtab
index|[
literal|8
index|]
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_function
DECL|function|make_run_tables (void)
name|void
name|make_run_tables
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|m
decl_stmt|;
comment|/* byte = kkkjjjmm, "j" starts at bit "i" */
name|int
name|mask
decl_stmt|;
comment|/* black mask (all ones), start bit i, j bits wide */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
comment|/* for (all starting bits) */
block|{
for|for
control|(
name|j
operator|=
name|i
operator|+
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
comment|/* for (all possible run lengths) */
block|{
name|mask
operator|=
name|tab
index|[
name|j
index|]
operator|<<
operator|(
operator|(
name|i
operator|-
name|j
operator|)
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|7
condition|)
comment|/* no fill bits to the left */
block|{
if|if
condition|(
name|j
operator|==
name|i
operator|+
literal|1
condition|)
comment|/* no fill bits to the right */
block|{
name|w_rtab
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|j
expr_stmt|;
name|b_rtab
index|[
name|i
index|]
index|[
name|mask
index|]
operator|=
name|j
expr_stmt|;
block|}
else|else
comment|/* fill bits to the right */
for|for
control|(
name|m
operator|=
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
name|j
operator|)
operator|)
operator|-
literal|1
init|;
name|m
operator|>=
literal|0
condition|;
name|m
operator|--
control|)
block|{
name|w_rtab
index|[
name|i
index|]
index|[
literal|0
operator|+
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
name|j
operator|)
operator|)
operator|+
name|m
index|]
operator|=
name|j
expr_stmt|;
name|b_rtab
index|[
name|i
index|]
index|[
name|mask
operator|+
literal|0
operator|+
name|m
index|]
operator|=
name|j
expr_stmt|;
block|}
block|}
else|else
comment|/* i != 7 -> fill higher bits */
for|for
control|(
name|k
operator|=
operator|(
literal|0x80
operator|>>
name|i
operator|)
operator|-
literal|1
init|;
name|k
operator|>=
literal|0
condition|;
name|k
operator|--
control|)
block|{
if|if
condition|(
name|j
operator|==
name|i
operator|+
literal|1
condition|)
comment|/* no noise to the right */
block|{
name|w_rtab
index|[
name|i
index|]
index|[
operator|(
name|k
operator|<<
operator|(
name|i
operator|+
literal|1
operator|)
operator|)
operator|+
literal|0
index|]
operator|=
name|j
expr_stmt|;
name|b_rtab
index|[
name|i
index|]
index|[
operator|(
name|k
operator|<<
operator|(
name|i
operator|+
literal|1
operator|)
operator|)
operator|+
name|mask
index|]
operator|=
name|j
expr_stmt|;
block|}
else|else
comment|/* fill bits to left + right */
for|for
control|(
name|m
operator|=
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
name|j
operator|)
operator|)
operator|-
literal|1
init|;
name|m
operator|>=
literal|0
condition|;
name|m
operator|--
control|)
block|{
name|w_rtab
index|[
name|i
index|]
index|[
operator|(
name|k
operator|<<
operator|(
name|i
operator|+
literal|1
operator|)
operator|)
operator|+
literal|0
operator|+
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
name|j
operator|)
operator|)
operator|+
name|m
index|]
operator|=
name|j
expr_stmt|;
name|b_rtab
index|[
name|i
index|]
index|[
operator|(
name|k
operator|<<
operator|(
name|i
operator|+
literal|1
operator|)
operator|)
operator|+
name|mask
operator|+
literal|0
operator|+
name|m
index|]
operator|=
name|j
expr_stmt|;
block|}
block|}
comment|/* end for (k) [noise left of top bit] */
block|}
comment|/* end for (j) [span] */
block|}
comment|/* end for (i) [top bit] */
block|}
end_function

end_unit

