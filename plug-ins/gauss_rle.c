begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"gtk/gtk.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimp.h"
end_include

begin_define
DECL|macro|ENTRY_WIDTH
define|#
directive|define
name|ENTRY_WIDTH
value|100
end_define

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon27a813280108
block|{
DECL|member|radius
name|gdouble
name|radius
decl_stmt|;
DECL|member|horizontal
name|gint
name|horizontal
decl_stmt|;
DECL|member|vertical
name|gint
name|vertical
decl_stmt|;
DECL|typedef|BlurValues
block|}
name|BlurValues
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon27a813280208
block|{
DECL|member|run
name|gint
name|run
decl_stmt|;
DECL|typedef|BlurInterface
block|}
name|BlurInterface
typedef|;
end_typedef

begin_comment
comment|/* Declare local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gauss_rle
parameter_list|(
name|GDrawable
modifier|*
name|drawable
parameter_list|,
name|gint
name|horizontal
parameter_list|,
name|gint
name|vertical
parameter_list|,
name|gdouble
name|std_dev
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Gaussian blur interface  */
end_comment

begin_function_decl
specifier|static
name|gint
name|gauss_rle_dialog
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Gaussian blur helper functions  */
end_comment

begin_function_decl
specifier|static
name|gint
modifier|*
name|make_curve
parameter_list|(
name|gdouble
name|sigma
parameter_list|,
name|gint
modifier|*
name|length
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_length_encode
parameter_list|(
name|guchar
modifier|*
name|src
parameter_list|,
name|gint
modifier|*
name|dest
parameter_list|,
name|gint
name|bytes
parameter_list|,
name|gint
name|width
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gauss_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gauss_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gauss_toggle_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gauss_entry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc */
name|NULL
block|,
comment|/* quit_proc */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|bvals
specifier|static
name|BlurValues
name|bvals
init|=
block|{
literal|5.0
block|,
comment|/*  radius  */
name|TRUE
block|,
comment|/*  horizontal blur  */
name|TRUE
comment|/*  vertical blur  */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|bint
specifier|static
name|BlurInterface
name|bint
init|=
block|{
name|FALSE
comment|/*  run  */
block|}
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|()
block|{
specifier|static
name|GParamDef
name|args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Input image (unused)"
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Input drawable"
block|}
block|,
block|{
name|PARAM_FLOAT
block|,
literal|"radius"
block|,
literal|"Radius of gaussian blur (in pixels> 1.0)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"horizontal"
block|,
literal|"Blur in horizontal direction"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"vertical"
block|,
literal|"Blur in vertical direction"
block|}
block|,   }
decl_stmt|;
specifier|static
name|GParamDef
modifier|*
name|return_vals
init|=
name|NULL
decl_stmt|;
specifier|static
name|gint
name|nargs
init|=
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|gint
name|nreturn_vals
init|=
literal|0
decl_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"plug_in_gauss_rle"
argument_list|,
literal|"Applies a gaussian blur to the specified drawable."
argument_list|,
literal|"Applies a gaussian blur to the drawable, with specified radius of affect.  The standard deviation of the normal distribution used to modify pixel values is calculated based on the supplied radius.  Horizontal and vertical blurring can be independently invoked by specifying only one to run.  The RLE gaussian blurring performs most efficiently on computer-generated images or images with large areas of constant intensity.  Values for radii less than 1.0 are invalid as they will generate spurious results."
argument_list|,
literal|"Spencer Kimball& Peter Mattis"
argument_list|,
literal|"Spencer Kimball& Peter Mattis"
argument_list|,
literal|"1995-1996"
argument_list|,
literal|"<Image>/Filters/Blur/Gaussian Blur (RLE)"
argument_list|,
literal|"RGB*, GRAY*"
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nargs
argument_list|,
name|nreturn_vals
argument_list|,
name|args
argument_list|,
name|return_vals
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (gchar * name,gint nparams,GParam * param,gint * nreturn_vals,GParam ** return_vals)
name|run
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GParam
name|values
index|[
literal|1
index|]
decl_stmt|;
name|GDrawable
modifier|*
name|drawable
decl_stmt|;
name|GRunModeType
name|run_mode
decl_stmt|;
name|GStatusType
name|status
init|=
name|STATUS_SUCCESS
decl_stmt|;
name|gdouble
name|radius
decl_stmt|,
name|std_dev
decl_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|PARAM_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|RUN_INTERACTIVE
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
literal|"plug_in_gauss_rle"
argument_list|,
operator|&
name|bvals
argument_list|)
expr_stmt|;
comment|/*  First acquire information with a dialog  */
if|if
condition|(
operator|!
name|gauss_rle_dialog
argument_list|()
condition|)
return|return;
break|break;
case|case
name|RUN_NONINTERACTIVE
case|:
comment|/*  Make sure all the arguments are there!  */
if|if
condition|(
name|nparams
operator|!=
literal|6
condition|)
name|status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|STATUS_SUCCESS
condition|)
block|{
name|bvals
operator|.
name|radius
operator|=
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
name|bvals
operator|.
name|horizontal
operator|=
operator|(
name|param
index|[
literal|4
index|]
operator|.
name|data
operator|.
name|d_int32
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
name|bvals
operator|.
name|vertical
operator|=
operator|(
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|STATUS_SUCCESS
operator|&&
operator|(
name|bvals
operator|.
name|radius
operator|<
literal|1.0
operator|)
condition|)
name|status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
break|break;
case|case
name|RUN_WITH_LAST_VALS
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
literal|"plug_in_gauss_rle"
argument_list|,
operator|&
name|bvals
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/*  Get the specified drawable  */
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
argument_list|)
expr_stmt|;
comment|/*  Make sure that the drawable is gray or RGB color  */
if|if
condition|(
name|gimp_drawable_color
argument_list|(
name|drawable
operator|->
name|id
argument_list|)
operator|||
name|gimp_drawable_gray
argument_list|(
name|drawable
operator|->
name|id
argument_list|)
condition|)
block|{
name|gimp_progress_init
argument_list|(
literal|"RLE Gaussian Blur"
argument_list|)
expr_stmt|;
comment|/*  set the tile cache size so that the gaussian blur works well  */
name|gimp_tile_cache_ntiles
argument_list|(
literal|2
operator|*
operator|(
name|MAX
argument_list|(
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|)
operator|/
name|gimp_tile_width
argument_list|()
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|radius
operator|=
name|fabs
argument_list|(
name|bvals
operator|.
name|radius
argument_list|)
operator|+
literal|1.0
expr_stmt|;
name|std_dev
operator|=
name|sqrt
argument_list|(
operator|-
operator|(
name|radius
operator|*
name|radius
operator|)
operator|/
operator|(
literal|2
operator|*
name|log
argument_list|(
literal|1.0
operator|/
literal|255.0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/*  run the gaussian blur  */
name|gauss_rle
argument_list|(
name|drawable
argument_list|,
name|bvals
operator|.
name|horizontal
argument_list|,
name|bvals
operator|.
name|vertical
argument_list|,
name|std_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|run_mode
operator|!=
name|RUN_NONINTERACTIVE
condition|)
name|gimp_displays_flush
argument_list|()
expr_stmt|;
comment|/*  Store data  */
if|if
condition|(
name|run_mode
operator|==
name|RUN_INTERACTIVE
condition|)
name|gimp_set_data
argument_list|(
literal|"plug_in_gauss_rle"
argument_list|,
operator|&
name|bvals
argument_list|,
sizeof|sizeof
argument_list|(
name|BlurValues
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* gimp_message ("gauss_rle: cannot operate on indexed color images"); */
name|status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|gauss_rle_dialog ()
name|gauss_rle_dialog
parameter_list|()
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|entry
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|gchar
name|buffer
index|[
literal|12
index|]
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|argv
decl_stmt|;
name|gint
name|argc
decl_stmt|;
name|argc
operator|=
literal|1
expr_stmt|;
name|argv
operator|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
name|g_strdup
argument_list|(
literal|"gauss"
argument_list|)
expr_stmt|;
name|gtk_init
argument_list|(
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|gtk_rc_parse
argument_list|(
name|gimp_gtkrc
argument_list|()
argument_list|)
expr_stmt|;
name|dlg
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"RLE Gaussian Blur"
argument_list|)
expr_stmt|;
name|gtk_window_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gauss_close_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  Action area  */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"OK"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gauss_ok_callback
argument_list|,
name|dlg
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Cancel"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect_object
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gtk_widget_destroy
argument_list|,
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
comment|/*  parameter settings  */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
literal|"Parameter Settings"
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
literal|"Blur Horizontally"
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gauss_toggle_update
argument_list|,
operator|&
name|bvals
operator|.
name|horizontal
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_state
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|bvals
operator|.
name|horizontal
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
literal|"Blur Vertically"
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gauss_toggle_update
argument_list|,
operator|&
name|bvals
operator|.
name|vertical
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_state
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|bvals
operator|.
name|vertical
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Blur Radius: "
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|entry
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|entry
argument_list|,
name|ENTRY_WIDTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%f"
argument_list|,
name|bvals
operator|.
name|radius
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|entry
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gauss_entry_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
return|return
name|bint
operator|.
name|run
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gauss_rle (GDrawable * drawable,gint horz,gint vert,gdouble std_dev)
name|gauss_rle
parameter_list|(
name|GDrawable
modifier|*
name|drawable
parameter_list|,
name|gint
name|horz
parameter_list|,
name|gint
name|vert
parameter_list|,
name|gdouble
name|std_dev
parameter_list|)
block|{
name|GPixelRgn
name|src_rgn
decl_stmt|,
name|dest_rgn
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gint
name|bytes
decl_stmt|;
name|guchar
modifier|*
name|dest
decl_stmt|,
modifier|*
name|dp
decl_stmt|;
name|guchar
modifier|*
name|src
decl_stmt|,
modifier|*
name|sp
decl_stmt|;
name|gint
modifier|*
name|buf
decl_stmt|,
modifier|*
name|bb
decl_stmt|;
name|gint
name|pixels
decl_stmt|;
name|gint
name|total
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|row
decl_stmt|,
name|col
decl_stmt|,
name|b
decl_stmt|;
name|gint
name|start
decl_stmt|,
name|end
decl_stmt|;
name|gint
name|progress
decl_stmt|,
name|max_progress
decl_stmt|;
name|gint
modifier|*
name|curve
decl_stmt|;
name|gint
modifier|*
name|sum
decl_stmt|;
name|gint
name|val
decl_stmt|;
name|gint
name|length
decl_stmt|;
name|gint
name|initial_p
decl_stmt|,
name|initial_m
decl_stmt|;
name|curve
operator|=
name|make_curve
argument_list|(
name|std_dev
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
name|sum
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
operator|(
literal|2
operator|*
name|length
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|sum
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|length
operator|*
literal|2
condition|;
name|i
operator|++
control|)
name|sum
index|[
name|i
index|]
operator|=
name|curve
index|[
name|i
operator|-
name|length
operator|-
literal|1
index|]
operator|+
name|sum
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|sum
operator|+=
name|length
expr_stmt|;
name|gimp_drawable_mask_bounds
argument_list|(
name|drawable
operator|->
name|id
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|)
expr_stmt|;
name|width
operator|=
operator|(
name|x2
operator|-
name|x1
operator|)
expr_stmt|;
name|height
operator|=
operator|(
name|y2
operator|-
name|y1
operator|)
expr_stmt|;
name|bytes
operator|=
name|drawable
operator|->
name|bpp
expr_stmt|;
name|buf
operator|=
operator|(
name|gint
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
name|MAX
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
operator|*
literal|2
argument_list|)
expr_stmt|;
name|total
operator|=
name|sum
index|[
name|length
index|]
operator|-
name|sum
index|[
operator|-
name|length
index|]
expr_stmt|;
comment|/*  allocate buffers for source and destination pixels  */
name|src
operator|=
operator|(
name|guchar
operator|*
operator|)
name|malloc
argument_list|(
name|MAX
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
operator|*
name|bytes
argument_list|)
expr_stmt|;
name|dest
operator|=
operator|(
name|guchar
operator|*
operator|)
name|malloc
argument_list|(
name|MAX
argument_list|(
name|width
argument_list|,
name|height
argument_list|)
operator|*
name|bytes
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|dest_rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|progress
operator|=
literal|0
expr_stmt|;
name|max_progress
operator|=
operator|(
name|horz
operator|)
condition|?
name|width
operator|*
name|height
else|:
literal|0
expr_stmt|;
name|max_progress
operator|+=
operator|(
name|vert
operator|)
condition|?
name|width
operator|*
name|height
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|vert
condition|)
block|{
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|width
condition|;
name|col
operator|++
control|)
block|{
name|gimp_pixel_rgn_get_col
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|src
argument_list|,
name|col
operator|+
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|=
name|src
expr_stmt|;
name|dp
operator|=
name|dest
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bytes
condition|;
name|b
operator|++
control|)
block|{
name|initial_p
operator|=
name|sp
index|[
name|b
index|]
expr_stmt|;
name|initial_m
operator|=
name|sp
index|[
operator|(
name|height
operator|-
literal|1
operator|)
operator|*
name|bytes
operator|+
name|b
index|]
expr_stmt|;
comment|/*  Determine a run-length encoded version of the row  */
name|run_length_encode
argument_list|(
name|sp
operator|+
name|b
argument_list|,
name|buf
argument_list|,
name|bytes
argument_list|,
name|height
argument_list|)
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|height
condition|;
name|row
operator|++
control|)
block|{
name|start
operator|=
operator|(
name|row
operator|<
name|length
operator|)
condition|?
operator|-
name|row
else|:
operator|-
name|length
expr_stmt|;
name|end
operator|=
operator|(
name|height
operator|<=
operator|(
name|row
operator|+
name|length
operator|)
operator|)
condition|?
operator|(
name|height
operator|-
name|row
operator|-
literal|1
operator|)
else|:
name|length
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|start
expr_stmt|;
name|bb
operator|=
name|buf
operator|+
operator|(
name|row
operator|+
name|i
operator|)
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|start
operator|!=
operator|-
name|length
condition|)
name|val
operator|+=
name|initial_p
operator|*
operator|(
name|sum
index|[
name|start
index|]
operator|-
name|sum
index|[
operator|-
name|length
index|]
operator|)
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|end
condition|)
block|{
name|pixels
operator|=
name|bb
index|[
literal|0
index|]
expr_stmt|;
name|i
operator|+=
name|pixels
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|end
condition|)
name|i
operator|=
name|end
expr_stmt|;
name|val
operator|+=
name|bb
index|[
literal|1
index|]
operator|*
operator|(
name|sum
index|[
name|i
index|]
operator|-
name|sum
index|[
name|start
index|]
operator|)
expr_stmt|;
name|bb
operator|+=
operator|(
name|pixels
operator|*
literal|2
operator|)
expr_stmt|;
name|start
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|end
operator|!=
name|length
condition|)
name|val
operator|+=
name|initial_m
operator|*
operator|(
name|sum
index|[
name|length
index|]
operator|-
name|sum
index|[
name|end
index|]
operator|)
expr_stmt|;
name|dp
index|[
name|row
operator|*
name|bytes
operator|+
name|b
index|]
operator|=
name|val
operator|/
name|total
expr_stmt|;
block|}
block|}
name|gimp_pixel_rgn_set_col
argument_list|(
operator|&
name|dest_rgn
argument_list|,
name|dest
argument_list|,
name|col
operator|+
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|)
expr_stmt|;
name|progress
operator|+=
name|height
expr_stmt|;
if|if
condition|(
operator|(
name|col
operator|%
literal|5
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
comment|/*  prepare for the horizontal pass  */
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|horz
condition|)
block|{
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|height
condition|;
name|row
operator|++
control|)
block|{
name|gimp_pixel_rgn_get_row
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|src
argument_list|,
name|x1
argument_list|,
name|row
operator|+
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|)
expr_stmt|;
name|sp
operator|=
name|src
expr_stmt|;
name|dp
operator|=
name|dest
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bytes
condition|;
name|b
operator|++
control|)
block|{
name|initial_p
operator|=
name|sp
index|[
name|b
index|]
expr_stmt|;
name|initial_m
operator|=
name|sp
index|[
operator|(
name|width
operator|-
literal|1
operator|)
operator|*
name|bytes
operator|+
name|b
index|]
expr_stmt|;
comment|/*  Determine a run-length encoded version of the row  */
name|run_length_encode
argument_list|(
name|sp
operator|+
name|b
argument_list|,
name|buf
argument_list|,
name|bytes
argument_list|,
name|width
argument_list|)
expr_stmt|;
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|width
condition|;
name|col
operator|++
control|)
block|{
name|start
operator|=
operator|(
name|col
operator|<
name|length
operator|)
condition|?
operator|-
name|col
else|:
operator|-
name|length
expr_stmt|;
name|end
operator|=
operator|(
name|width
operator|<=
operator|(
name|col
operator|+
name|length
operator|)
operator|)
condition|?
operator|(
name|width
operator|-
name|col
operator|-
literal|1
operator|)
else|:
name|length
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|start
expr_stmt|;
name|bb
operator|=
name|buf
operator|+
operator|(
name|col
operator|+
name|i
operator|)
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|start
operator|!=
operator|-
name|length
condition|)
name|val
operator|+=
name|initial_p
operator|*
operator|(
name|sum
index|[
name|start
index|]
operator|-
name|sum
index|[
operator|-
name|length
index|]
operator|)
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|end
condition|)
block|{
name|pixels
operator|=
name|bb
index|[
literal|0
index|]
expr_stmt|;
name|i
operator|+=
name|pixels
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|end
condition|)
name|i
operator|=
name|end
expr_stmt|;
name|val
operator|+=
name|bb
index|[
literal|1
index|]
operator|*
operator|(
name|sum
index|[
name|i
index|]
operator|-
name|sum
index|[
name|start
index|]
operator|)
expr_stmt|;
name|bb
operator|+=
operator|(
name|pixels
operator|*
literal|2
operator|)
expr_stmt|;
name|start
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|end
operator|!=
name|length
condition|)
name|val
operator|+=
name|initial_m
operator|*
operator|(
name|sum
index|[
name|length
index|]
operator|-
name|sum
index|[
name|end
index|]
operator|)
expr_stmt|;
name|dp
index|[
name|col
operator|*
name|bytes
operator|+
name|b
index|]
operator|=
name|val
operator|/
name|total
expr_stmt|;
block|}
block|}
name|gimp_pixel_rgn_set_row
argument_list|(
operator|&
name|dest_rgn
argument_list|,
name|dest
argument_list|,
name|x1
argument_list|,
name|row
operator|+
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|)
expr_stmt|;
name|progress
operator|+=
name|width
expr_stmt|;
if|if
condition|(
operator|(
name|row
operator|%
literal|5
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  merge the shadow, update the drawable  */
name|gimp_drawable_flush
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_merge_shadow
argument_list|(
name|drawable
operator|->
name|id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_update
argument_list|(
name|drawable
operator|->
name|id
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|)
expr_stmt|;
comment|/*  free buffers  */
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * The equations: g(r) = exp (- r^2 / (2 * sigma^2))  *                   r = sqrt (x^2 + y ^2)  */
end_comment

begin_function
specifier|static
name|gint
modifier|*
DECL|function|make_curve (gdouble sigma,gint * length)
name|make_curve
parameter_list|(
name|gdouble
name|sigma
parameter_list|,
name|gint
modifier|*
name|length
parameter_list|)
block|{
name|gint
modifier|*
name|curve
decl_stmt|;
name|gdouble
name|sigma2
decl_stmt|;
name|gdouble
name|l
decl_stmt|;
name|gint
name|temp
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|n
decl_stmt|;
name|sigma2
operator|=
literal|2
operator|*
name|sigma
operator|*
name|sigma
expr_stmt|;
name|l
operator|=
name|sqrt
argument_list|(
operator|-
name|sigma2
operator|*
name|log
argument_list|(
literal|1.0
operator|/
literal|255.0
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|=
name|ceil
argument_list|(
name|l
argument_list|)
operator|*
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|%
literal|2
operator|)
operator|==
literal|0
condition|)
name|n
operator|+=
literal|1
expr_stmt|;
name|curve
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
name|n
argument_list|)
expr_stmt|;
operator|*
name|length
operator|=
name|n
operator|/
literal|2
expr_stmt|;
name|curve
operator|+=
operator|*
name|length
expr_stmt|;
name|curve
index|[
literal|0
index|]
operator|=
literal|255
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
operator|*
name|length
condition|;
name|i
operator|++
control|)
block|{
name|temp
operator|=
call|(
name|gint
call|)
argument_list|(
name|exp
argument_list|(
operator|-
operator|(
name|i
operator|*
name|i
operator|)
operator|/
name|sigma2
argument_list|)
operator|*
literal|255
argument_list|)
expr_stmt|;
name|curve
index|[
operator|-
name|i
index|]
operator|=
name|temp
expr_stmt|;
name|curve
index|[
name|i
index|]
operator|=
name|temp
expr_stmt|;
block|}
return|return
name|curve
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run_length_encode (guchar * src,gint * dest,gint bytes,gint width)
name|run_length_encode
parameter_list|(
name|guchar
modifier|*
name|src
parameter_list|,
name|gint
modifier|*
name|dest
parameter_list|,
name|gint
name|bytes
parameter_list|,
name|gint
name|width
parameter_list|)
block|{
name|gint
name|start
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|j
decl_stmt|;
name|guchar
name|last
decl_stmt|;
name|last
operator|=
operator|*
name|src
expr_stmt|;
name|src
operator|+=
name|bytes
expr_stmt|;
name|start
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|src
operator|!=
name|last
condition|)
block|{
for|for
control|(
name|j
operator|=
name|start
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
block|{
operator|*
name|dest
operator|++
operator|=
operator|(
name|i
operator|-
name|j
operator|)
expr_stmt|;
operator|*
name|dest
operator|++
operator|=
name|last
expr_stmt|;
block|}
name|start
operator|=
name|i
expr_stmt|;
name|last
operator|=
operator|*
name|src
expr_stmt|;
block|}
name|src
operator|+=
name|bytes
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
name|start
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
block|{
operator|*
name|dest
operator|++
operator|=
operator|(
name|i
operator|-
name|j
operator|)
expr_stmt|;
operator|*
name|dest
operator|++
operator|=
name|last
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  Gauss interface functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gauss_close_callback (GtkWidget * widget,gpointer data)
name|gauss_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gtk_main_quit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gauss_ok_callback (GtkWidget * widget,gpointer data)
name|gauss_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|bint
operator|.
name|run
operator|=
name|TRUE
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|GTK_WIDGET
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gauss_toggle_update (GtkWidget * widget,gpointer data)
name|gauss_toggle_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
modifier|*
name|toggle_val
decl_stmt|;
name|toggle_val
operator|=
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
operator|->
name|active
condition|)
operator|*
name|toggle_val
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|toggle_val
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gauss_entry_callback (GtkWidget * widget,gpointer data)
name|gauss_entry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|bvals
operator|.
name|radius
operator|=
name|atof
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bvals
operator|.
name|radius
operator|<
literal|1.0
condition|)
name|bvals
operator|.
name|radius
operator|=
literal|1.0
expr_stmt|;
block|}
end_function

end_unit

