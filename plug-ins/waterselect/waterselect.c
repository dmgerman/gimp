begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Watercolor color selector, Raph Levien<raph@acm.org>, February 1998  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_comment
comment|/* This simple plug-in does an automatic contrast stretch.  For each    channel in the image, it finds the minimum and maximum values... it    uses those values to stretch the individual histograms to the full    contrast range.  For some images it may do just what you want; for    others it may be total crap :) */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/gimp.h"
end_include

begin_comment
comment|/* Declare local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc */
name|NULL
block|,
comment|/* quit_proc */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc */
block|}
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|()
block|{
specifier|static
name|GParamDef
name|args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, [non-interactive]"
block|}
block|}
decl_stmt|;
specifier|static
name|GParamDef
modifier|*
name|return_vals
init|=
name|NULL
decl_stmt|;
specifier|static
name|int
name|nargs
init|=
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|int
name|nreturn_vals
init|=
literal|0
decl_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"extension_waterselect"
argument_list|,
literal|"Bring up an interactive color selector inspired by watercolors."
argument_list|,
literal|"This extension is a prototype of an interactive colorselector that imitates the feel of watercolors."
argument_list|,
literal|"Raph Levien"
argument_list|,
literal|"Raph Levien"
argument_list|,
literal|"1998"
argument_list|,
literal|"<Toolbox>/Xtns/Waterselect"
argument_list|,
name|NULL
argument_list|,
name|PROC_EXTENSION
argument_list|,
name|nargs
argument_list|,
name|nreturn_vals
argument_list|,
name|args
argument_list|,
name|return_vals
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|init_input (void)
name|init_input
parameter_list|(
name|void
parameter_list|)
block|{
name|GList
modifier|*
name|tmp_list
decl_stmt|;
name|GdkDeviceInfo
modifier|*
name|info
decl_stmt|;
name|tmp_list
operator|=
name|gdk_input_list_devices
argument_list|()
expr_stmt|;
name|info
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|tmp_list
condition|)
block|{
name|info
operator|=
operator|(
name|GdkDeviceInfo
operator|*
operator|)
name|tmp_list
operator|->
name|data
expr_stmt|;
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"device: %s\n"
argument_list|,
name|info
operator|->
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|g_strcasecmp
argument_list|(
name|info
operator|->
name|name
argument_list|,
literal|"wacom"
argument_list|)
operator|||
operator|!
name|g_strcasecmp
argument_list|(
name|info
operator|->
name|name
argument_list|,
literal|"stylus"
argument_list|)
operator|||
operator|!
name|g_strcasecmp
argument_list|(
name|info
operator|->
name|name
argument_list|,
literal|"eraser"
argument_list|)
condition|)
block|{
name|gdk_input_set_mode
argument_list|(
name|info
operator|->
name|deviceid
argument_list|,
name|GDK_MODE_SCREEN
argument_list|)
expr_stmt|;
block|}
name|tmp_list
operator|=
name|tmp_list
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|info
condition|)
return|return;
block|}
end_function

begin_define
DECL|macro|BUCKET_SIZE
define|#
directive|define
name|BUCKET_SIZE
value|20
end_define

begin_define
DECL|macro|N_BUCKETS
define|#
directive|define
name|N_BUCKETS
value|10
end_define

begin_define
DECL|macro|LAST_BUCKET
define|#
directive|define
name|LAST_BUCKET
value|(N_BUCKETS-1)
end_define

begin_define
DECL|macro|IMAGE_SIZE
define|#
directive|define
name|IMAGE_SIZE
value|200
end_define

begin_decl_stmt
DECL|variable|bucket
name|gdouble
name|bucket
index|[
name|N_BUCKETS
index|]
index|[
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|need_shift
name|gboolean
name|need_shift
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|in_bucket
name|gboolean
name|in_bucket
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|set_bucket (gint i,gdouble r,gdouble g,gdouble b)
name|set_bucket
parameter_list|(
name|gint
name|i
parameter_list|,
name|gdouble
name|r
parameter_list|,
name|gdouble
name|g
parameter_list|,
name|gdouble
name|b
parameter_list|)
block|{
if|if
condition|(
name|i
operator|>=
literal|0
operator|&&
name|i
operator|<
name|N_BUCKETS
condition|)
block|{
name|bucket
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|r
expr_stmt|;
name|bucket
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|bucket
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|b
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|calc (gdouble x,gdouble y,gdouble angle)
name|calc
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|gdouble
name|angle
parameter_list|)
block|{
name|gdouble
name|s
decl_stmt|,
name|c
decl_stmt|;
name|s
operator|=
literal|1.6
operator|*
name|sin
argument_list|(
name|angle
operator|*
name|M_PI
operator|/
literal|180
argument_list|)
operator|*
literal|256.0
operator|/
name|IMAGE_SIZE
expr_stmt|;
name|c
operator|=
literal|1.6
operator|*
name|cos
argument_list|(
name|angle
operator|*
name|M_PI
operator|/
literal|180
argument_list|)
operator|*
literal|256.0
operator|/
name|IMAGE_SIZE
expr_stmt|;
return|return
literal|128
operator|+
operator|(
name|x
operator|-
operator|(
name|IMAGE_SIZE
operator|>>
literal|1
operator|)
operator|)
operator|*
name|c
operator|-
operator|(
name|y
operator|-
operator|(
name|IMAGE_SIZE
operator|>>
literal|1
operator|)
operator|)
operator|*
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|guchar
DECL|function|bucket_to_byte (gdouble val)
name|bucket_to_byte
parameter_list|(
name|gdouble
name|val
parameter_list|)
block|{
return|return
name|CLAMP
argument_list|(
call|(
name|gint
call|)
argument_list|(
name|val
operator|*
literal|280
operator|-
literal|25
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
DECL|variable|preview
name|GtkWidget
modifier|*
name|preview
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|draw_buckets (GtkWidget * preview,gint start,gint end)
name|draw_buckets
parameter_list|(
name|GtkWidget
modifier|*
name|preview
parameter_list|,
name|gint
name|start
parameter_list|,
name|gint
name|end
parameter_list|)
block|{
name|guchar
name|buf
index|[
literal|3
operator|*
name|IMAGE_SIZE
index|]
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|guchar
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|1
init|;
name|y
operator|<
name|BUCKET_SIZE
operator|-
literal|1
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|end
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|bucket_to_byte
argument_list|(
name|bucket
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|g
operator|=
name|bucket_to_byte
argument_list|(
name|bucket
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|b
operator|=
name|bucket_to_byte
argument_list|(
name|bucket
index|[
name|i
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|buf
index|[
name|i
operator|*
name|BUCKET_SIZE
operator|*
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
name|i
operator|*
name|BUCKET_SIZE
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
name|i
operator|*
name|BUCKET_SIZE
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
operator|(
name|i
operator|*
name|BUCKET_SIZE
operator|+
name|BUCKET_SIZE
operator|-
literal|1
operator|)
operator|*
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
operator|(
name|i
operator|*
name|BUCKET_SIZE
operator|+
name|BUCKET_SIZE
operator|-
literal|1
operator|)
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
operator|(
name|i
operator|*
name|BUCKET_SIZE
operator|+
name|BUCKET_SIZE
operator|-
literal|1
operator|)
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|1
init|;
name|x
operator|<
name|BUCKET_SIZE
operator|-
literal|1
condition|;
name|x
operator|++
control|)
block|{
name|buf
index|[
operator|(
name|i
operator|*
name|BUCKET_SIZE
operator|+
name|x
operator|)
operator|*
literal|3
index|]
operator|=
name|r
expr_stmt|;
name|buf
index|[
operator|(
name|i
operator|*
name|BUCKET_SIZE
operator|+
name|x
operator|)
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|buf
index|[
operator|(
name|i
operator|*
name|BUCKET_SIZE
operator|+
name|x
operator|)
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|b
expr_stmt|;
block|}
block|}
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|preview
argument_list|)
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|y
argument_list|,
name|IMAGE_SIZE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|update_buckets (gint start,gint end)
name|update_buckets
parameter_list|(
name|gint
name|start
parameter_list|,
name|gint
name|end
parameter_list|)
block|{
name|draw_buckets
argument_list|(
name|preview
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|gtk_widget_draw
argument_list|(
name|preview
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|update_gimp_color (void)
name|update_gimp_color
parameter_list|(
name|void
parameter_list|)
block|{
name|gimp_palette_set_foreground
argument_list|(
name|bucket_to_byte
argument_list|(
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|bucket_to_byte
argument_list|(
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|bucket_to_byte
argument_list|(
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|pick_up_bucket (gint i)
name|pick_up_bucket
parameter_list|(
name|gint
name|i
parameter_list|)
block|{
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|0
index|]
operator|=
name|bucket
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|1
index|]
operator|=
name|bucket
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|2
index|]
operator|=
name|bucket
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|shift_buckets ()
name|shift_buckets
parameter_list|()
block|{
name|gint
name|i
decl_stmt|;
comment|/* to avoid duplication, do nothing if last bucket is already present */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LAST_BUCKET
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bucket
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|0
index|]
operator|&&
name|bucket
index|[
name|i
index|]
index|[
literal|1
index|]
operator|==
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|1
index|]
operator|&&
name|bucket
index|[
name|i
index|]
index|[
literal|2
index|]
operator|==
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|2
index|]
condition|)
return|return;
block|}
comment|/* don't bother storing pure white in buckets */
if|if
condition|(
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|1
index|]
operator|==
literal|1
operator|&&
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|2
index|]
operator|==
literal|1
condition|)
return|return;
comment|/* shift all buckets one to the left */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LAST_BUCKET
condition|;
name|i
operator|++
control|)
block|{
name|bucket
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|bucket
index|[
name|i
operator|+
literal|1
index|]
index|[
literal|0
index|]
expr_stmt|;
name|bucket
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|bucket
index|[
name|i
operator|+
literal|1
index|]
index|[
literal|1
index|]
expr_stmt|;
name|bucket
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|bucket
index|[
name|i
operator|+
literal|1
index|]
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Initialize the preview */
end_comment

begin_function
specifier|static
name|void
DECL|function|preview_init (GtkWidget * preview)
name|preview_init
parameter_list|(
name|GtkWidget
modifier|*
name|preview
parameter_list|)
block|{
name|guchar
name|buf
index|[
literal|3
operator|*
name|IMAGE_SIZE
index|]
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gdouble
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|gdouble
name|dr
decl_stmt|,
name|dg
decl_stmt|,
name|db
decl_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|IMAGE_SIZE
condition|;
name|y
operator|++
control|)
block|{
name|r
operator|=
name|calc
argument_list|(
literal|0
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g
operator|=
name|calc
argument_list|(
literal|0
argument_list|,
name|y
argument_list|,
literal|120
argument_list|)
expr_stmt|;
name|b
operator|=
name|calc
argument_list|(
literal|0
argument_list|,
name|y
argument_list|,
literal|240
argument_list|)
expr_stmt|;
name|dr
operator|=
name|calc
argument_list|(
literal|1
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
operator|-
name|r
expr_stmt|;
name|dg
operator|=
name|calc
argument_list|(
literal|1
argument_list|,
name|y
argument_list|,
literal|120
argument_list|)
operator|-
name|g
expr_stmt|;
name|db
operator|=
name|calc
argument_list|(
literal|1
argument_list|,
name|y
argument_list|,
literal|240
argument_list|)
operator|-
name|b
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|IMAGE_SIZE
condition|;
name|x
operator|++
control|)
block|{
name|buf
index|[
name|x
operator|*
literal|3
index|]
operator|=
name|CLAMP
argument_list|(
operator|(
name|gint
operator|)
name|r
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|buf
index|[
name|x
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|CLAMP
argument_list|(
operator|(
name|gint
operator|)
name|g
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|buf
index|[
name|x
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|CLAMP
argument_list|(
operator|(
name|gint
operator|)
name|b
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|r
operator|+=
name|dr
expr_stmt|;
name|g
operator|+=
name|dg
expr_stmt|;
name|b
operator|+=
name|db
expr_stmt|;
block|}
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|preview
argument_list|)
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|BUCKET_SIZE
operator|+
name|y
argument_list|,
name|IMAGE_SIZE
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N_BUCKETS
condition|;
name|i
operator|++
control|)
name|set_bucket
argument_list|(
name|i
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|draw_buckets
argument_list|(
name|preview
argument_list|,
literal|0
argument_list|,
name|N_BUCKETS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|waterselect_destroy_callback (GtkWidget * widget,void * dummy)
name|waterselect_destroy_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|void
modifier|*
name|dummy
parameter_list|)
block|{
name|gtk_main_quit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|waterselect_delete_callback (GtkWidget * widget,void * dummy)
name|waterselect_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|void
modifier|*
name|dummy
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|waterselect_ok_callback (GtkWidget * widget,gpointer data)
name|waterselect_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gtk_widget_destroy
argument_list|(
name|GTK_WIDGET
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* todo: cancel callback with appropriate logic */
end_comment

begin_decl_stmt
DECL|variable|pixmap
specifier|static
name|GdkPixmap
modifier|*
name|pixmap
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Create a new backing pixmap of the appropriate size - obsolete */
end_comment

begin_function
specifier|static
name|gint
DECL|function|configure_event (GtkWidget * widget,GdkEventConfigure * event)
name|configure_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventConfigure
modifier|*
name|event
parameter_list|)
block|{
if|if
condition|(
name|pixmap
condition|)
name|gdk_pixmap_unref
argument_list|(
name|pixmap
argument_list|)
expr_stmt|;
name|pixmap
operator|=
name|gdk_pixmap_new
argument_list|(
name|widget
operator|->
name|window
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|width
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|height
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|white_gc
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|width
argument_list|,
name|widget
operator|->
name|allocation
operator|.
name|height
argument_list|)
expr_stmt|;
name|gdk_draw_rectangle
argument_list|(
name|pixmap
argument_list|,
name|widget
operator|->
name|style
operator|->
name|black_gc
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
DECL|function|add_pigment (gboolean erase,gdouble x,gdouble y,gdouble much)
specifier|static
name|void
name|add_pigment
parameter_list|(
name|gboolean
name|erase
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|gdouble
name|much
parameter_list|)
block|{
name|gdouble
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|y
operator|-=
name|BUCKET_SIZE
expr_stmt|;
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"%g->%g %g->%g %g->%g => %g\n"
argument_list|,
name|last_x
argument_list|,
name|x
argument_list|,
name|last_y
argument_list|,
name|y
argument_list|,
name|last_pressure
argument_list|,
name|pressure
argument_list|,
name|much
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|erase
condition|)
block|{
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|0
index|]
operator|=
literal|1
operator|-
operator|(
literal|1
operator|-
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|0
index|]
operator|)
operator|*
operator|(
literal|1
operator|-
name|much
operator|)
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|1
index|]
operator|=
literal|1
operator|-
operator|(
literal|1
operator|-
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|1
index|]
operator|)
operator|*
operator|(
literal|1
operator|-
name|much
operator|)
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|2
index|]
operator|=
literal|1
operator|-
operator|(
literal|1
operator|-
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|2
index|]
operator|)
operator|*
operator|(
literal|1
operator|-
name|much
operator|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|calc
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
operator|/
literal|255.0
expr_stmt|;
if|if
condition|(
name|r
operator|<
literal|0
condition|)
name|r
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|r
operator|>
literal|1
condition|)
name|r
operator|=
literal|1
expr_stmt|;
name|g
operator|=
name|calc
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
literal|120
argument_list|)
operator|/
literal|255.0
expr_stmt|;
if|if
condition|(
name|g
operator|<
literal|0
condition|)
name|g
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|g
operator|>
literal|1
condition|)
name|g
operator|=
literal|1
expr_stmt|;
name|b
operator|=
name|calc
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
literal|240
argument_list|)
operator|/
literal|255.0
expr_stmt|;
if|if
condition|(
name|b
operator|<
literal|0
condition|)
name|b
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|b
operator|>
literal|1
condition|)
name|b
operator|=
literal|1
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|0
index|]
operator|*=
operator|(
literal|1
operator|-
operator|(
literal|1
operator|-
name|r
operator|)
operator|*
name|much
operator|)
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|1
index|]
operator|*=
operator|(
literal|1
operator|-
operator|(
literal|1
operator|-
name|g
operator|)
operator|*
name|much
operator|)
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|2
index|]
operator|*=
operator|(
literal|1
operator|-
operator|(
literal|1
operator|-
name|b
operator|)
operator|*
name|much
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
DECL|variable|last_x
DECL|variable|last_y
DECL|variable|last_pressure
specifier|static
name|gdouble
name|last_x
decl_stmt|,
name|last_y
decl_stmt|,
name|last_pressure
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|draw_brush (GtkWidget * widget,gboolean erase,gdouble x,gdouble y,gdouble pressure)
name|draw_brush
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gboolean
name|erase
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|gdouble
name|pressure
parameter_list|)
block|{
name|gdouble
name|much
decl_stmt|;
comment|/* how much pigment to mix in */
name|much
operator|=
name|sqrt
argument_list|(
operator|(
name|x
operator|-
name|last_x
operator|)
operator|*
operator|(
name|x
operator|-
name|last_x
operator|)
operator|+
operator|(
name|y
operator|-
name|last_y
operator|)
operator|*
operator|(
name|y
operator|-
name|last_y
operator|)
operator|+
literal|1000
operator|*
operator|(
name|pressure
operator|-
name|last_pressure
operator|)
operator|*
operator|(
name|pressure
operator|-
name|last_pressure
operator|)
argument_list|)
expr_stmt|;
name|much
operator|*=
name|pressure
operator|*
literal|0.05
expr_stmt|;
name|add_pigment
argument_list|(
name|erase
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|much
argument_list|)
expr_stmt|;
name|last_x
operator|=
name|x
expr_stmt|;
name|last_y
operator|=
name|y
expr_stmt|;
name|last_pressure
operator|=
name|pressure
expr_stmt|;
block|}
end_function

begin_decl_stmt
DECL|variable|motion_time
specifier|static
name|guint32
name|motion_time
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|button_state
specifier|static
name|gint
name|button_state
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|gint
DECL|function|button_press_event (GtkWidget * widget,GdkEventButton * event)
name|button_press_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|)
block|{
name|gboolean
name|erase
decl_stmt|;
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"button press\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|last_x
operator|=
name|event
operator|->
name|x
expr_stmt|;
name|last_y
operator|=
name|event
operator|->
name|y
expr_stmt|;
name|last_pressure
operator|=
name|event
operator|->
name|pressure
expr_stmt|;
name|button_state
operator||=
literal|1
operator|<<
name|event
operator|->
name|button
expr_stmt|;
if|if
condition|(
name|event
operator|->
name|y
operator|<
name|BUCKET_SIZE
condition|)
block|{
name|in_bucket
operator|=
name|TRUE
expr_stmt|;
name|pick_up_bucket
argument_list|(
name|event
operator|->
name|x
operator|/
name|BUCKET_SIZE
argument_list|)
expr_stmt|;
name|update_buckets
argument_list|(
name|LAST_BUCKET
argument_list|,
name|N_BUCKETS
argument_list|)
expr_stmt|;
name|update_gimp_color
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|in_bucket
operator|=
name|FALSE
expr_stmt|;
name|erase
operator|=
operator|(
name|event
operator|->
name|button
operator|!=
literal|1
operator|)
operator|||
operator|(
name|event
operator|->
name|source
operator|==
name|GDK_SOURCE_ERASER
operator|)
expr_stmt|;
name|add_pigment
argument_list|(
name|erase
argument_list|,
name|event
operator|->
name|x
argument_list|,
name|event
operator|->
name|y
argument_list|,
literal|0.05
argument_list|)
expr_stmt|;
name|update_buckets
argument_list|(
name|LAST_BUCKET
argument_list|,
name|N_BUCKETS
argument_list|)
expr_stmt|;
name|update_gimp_color
argument_list|()
expr_stmt|;
block|}
name|motion_time
operator|=
name|event
operator|->
name|time
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|button_release_event (GtkWidget * widget,GdkEventButton * event)
name|button_release_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventButton
modifier|*
name|event
parameter_list|)
block|{
name|button_state
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|event
operator|->
name|button
operator|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|key_press_event (GtkWidget * widget,GdkEventKey * event)
name|key_press_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventKey
modifier|*
name|event
parameter_list|)
block|{
if|if
condition|(
operator|(
name|event
operator|->
name|keyval
operator|>=
literal|0x20
operator|)
operator|&&
operator|(
name|event
operator|->
name|keyval
operator|<=
literal|0xFF
operator|)
condition|)
name|printf
argument_list|(
literal|"I got a %c\n"
argument_list|,
name|event
operator|->
name|keyval
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"I got some other key\n"
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|motion_notify_event (GtkWidget * widget,GdkEventMotion * event)
name|motion_notify_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventMotion
modifier|*
name|event
parameter_list|)
block|{
name|GdkTimeCoord
modifier|*
name|coords
decl_stmt|;
name|int
name|nevents
decl_stmt|;
name|int
name|i
decl_stmt|;
name|gboolean
name|erase
decl_stmt|;
if|if
condition|(
name|event
operator|->
name|state
operator|&
operator|(
name|GDK_BUTTON1_MASK
operator||
name|GDK_BUTTON3_MASK
operator||
name|GDK_BUTTON4_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|in_bucket
condition|)
return|return
name|FALSE
return|;
name|coords
operator|=
name|gdk_input_motion_events
argument_list|(
name|event
operator|->
name|window
argument_list|,
name|event
operator|->
name|deviceid
argument_list|,
name|motion_time
argument_list|,
name|event
operator|->
name|time
argument_list|,
operator|&
name|nevents
argument_list|)
expr_stmt|;
name|erase
operator|=
operator|(
operator|!
operator|(
name|event
operator|->
name|state
operator|&
name|GDK_BUTTON1_MASK
operator|)
operator|)
operator|||
operator|(
name|event
operator|->
name|source
operator|==
name|GDK_SOURCE_ERASER
operator|)
expr_stmt|;
name|motion_time
operator|=
name|event
operator|->
name|time
expr_stmt|;
if|if
condition|(
name|coords
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nevents
condition|;
name|i
operator|++
control|)
name|draw_brush
argument_list|(
name|widget
argument_list|,
name|erase
argument_list|,
name|coords
index|[
name|i
index|]
operator|.
name|x
argument_list|,
name|coords
index|[
name|i
index|]
operator|.
name|y
argument_list|,
name|coords
index|[
name|i
index|]
operator|.
name|pressure
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|coords
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|event
operator|->
name|is_hint
condition|)
name|gdk_input_window_get_pointer
argument_list|(
name|event
operator|->
name|window
argument_list|,
name|event
operator|->
name|deviceid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|draw_brush
argument_list|(
name|widget
argument_list|,
name|erase
argument_list|,
name|event
operator|->
name|x
argument_list|,
name|event
operator|->
name|y
argument_list|,
name|event
operator|->
name|pressure
argument_list|)
expr_stmt|;
block|}
name|update_buckets
argument_list|(
name|LAST_BUCKET
argument_list|,
name|N_BUCKETS
argument_list|)
expr_stmt|;
name|update_gimp_color
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|gdk_input_window_get_pointer
argument_list|(
name|event
operator|->
name|window
argument_list|,
name|event
operator|->
name|deviceid
argument_list|,
operator|&
name|event
operator|->
name|x
argument_list|,
operator|&
name|event
operator|->
name|y
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* We track the next two events to know when we need to draw a    cursor */
end_comment

begin_function
specifier|static
name|gint
DECL|function|proximity_out_event (GtkWidget * widget,GdkEventProximity * event)
name|proximity_out_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventProximity
modifier|*
name|event
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"proximity out\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|VERBOSE
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|enter_notify_event (GtkWidget * widget,GdkEventCrossing * event)
name|enter_notify_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventCrossing
modifier|*
name|event
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"enter\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|need_shift
condition|)
block|{
name|shift_buckets
argument_list|()
expr_stmt|;
comment|/* last bucket becomes white */
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|bucket
index|[
name|LAST_BUCKET
index|]
index|[
literal|2
index|]
operator|=
literal|1
expr_stmt|;
name|update_buckets
argument_list|(
literal|0
argument_list|,
name|N_BUCKETS
argument_list|)
expr_stmt|;
comment|/* don't update gimp color here... */
name|need_shift
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|leave_notify_event (GtkWidget * widget,GdkEventCrossing * event)
name|leave_notify_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventCrossing
modifier|*
name|event
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|VERBOSE
name|g_print
argument_list|(
literal|"leave\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* The goal is to detect the mouse leaving the eventbox window with      the button not pressed. It seems to work, but is a bit of a hack. */
if|if
condition|(
name|button_state
operator|==
literal|0
operator|&&
name|event
operator|->
name|detail
operator|!=
name|GDK_NOTIFY_INFERIOR
condition|)
name|need_shift
operator|=
name|TRUE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|waterselect_dialog (void)
name|waterselect_dialog
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|event_box
decl_stmt|;
name|guchar
modifier|*
name|color_cube
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|argv
decl_stmt|;
name|gint
name|argc
decl_stmt|;
name|argc
operator|=
literal|1
expr_stmt|;
name|argv
operator|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
name|g_strdup
argument_list|(
literal|"Film"
argument_list|)
expr_stmt|;
name|gtk_init
argument_list|(
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|gtk_rc_parse
argument_list|(
name|gimp_gtkrc
argument_list|()
argument_list|)
expr_stmt|;
name|gdk_set_use_xshm
argument_list|(
name|gimp_use_xshm
argument_list|()
argument_list|)
expr_stmt|;
name|gtk_preview_set_gamma
argument_list|(
name|gimp_gamma
argument_list|()
argument_list|)
expr_stmt|;
name|gtk_preview_set_install_cmap
argument_list|(
name|gimp_install_cmap
argument_list|()
argument_list|)
expr_stmt|;
name|color_cube
operator|=
name|gimp_color_cube
argument_list|()
expr_stmt|;
name|gtk_preview_set_color_cube
argument_list|(
name|color_cube
index|[
literal|0
index|]
argument_list|,
name|color_cube
index|[
literal|1
index|]
argument_list|,
name|color_cube
index|[
literal|2
index|]
argument_list|,
name|color_cube
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|gtk_widget_set_default_visual
argument_list|(
name|gtk_preview_get_visual
argument_list|()
argument_list|)
expr_stmt|;
name|gtk_widget_set_default_colormap
argument_list|(
name|gtk_preview_get_cmap
argument_list|()
argument_list|)
expr_stmt|;
name|init_input
argument_list|()
expr_stmt|;
name|dlg
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"Waterselect"
argument_list|)
expr_stmt|;
comment|/* set window position to mouse? */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"delete_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|waterselect_delete_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|waterselect_destroy_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"OK"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|waterselect_ok_callback
argument_list|,
name|dlg
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Cancel"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect_object
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gtk_widget_destroy
argument_list|,
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|event_box
operator|=
name|gtk_event_box_new
argument_list|()
expr_stmt|;
name|preview
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_COLOR
argument_list|)
expr_stmt|;
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|preview
argument_list|)
argument_list|,
name|IMAGE_SIZE
argument_list|,
name|BUCKET_SIZE
operator|+
name|IMAGE_SIZE
argument_list|)
expr_stmt|;
name|preview_init
argument_list|(
name|preview
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|event_box
argument_list|)
argument_list|,
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|preview
argument_list|)
expr_stmt|;
comment|/* Signals used to handle backing pixmap */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_box
argument_list|)
argument_list|,
literal|"configure_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|configure_event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Event signals */
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_box
argument_list|)
argument_list|,
literal|"motion_notify_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|motion_notify_event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_box
argument_list|)
argument_list|,
literal|"button_press_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|button_press_event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_box
argument_list|)
argument_list|,
literal|"button_release_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|button_release_event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_box
argument_list|)
argument_list|,
literal|"key_press_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|key_press_event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_box
argument_list|)
argument_list|,
literal|"enter_notify_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|enter_notify_event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_box
argument_list|)
argument_list|,
literal|"leave_notify_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|leave_notify_event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|event_box
argument_list|)
argument_list|,
literal|"proximity_out_event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|proximity_out_event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|event_box
argument_list|,
name|GDK_EXPOSURE_MASK
operator||
name|GDK_LEAVE_NOTIFY_MASK
operator||
name|GDK_BUTTON_PRESS_MASK
operator||
name|GDK_KEY_PRESS_MASK
operator||
name|GDK_POINTER_MOTION_MASK
operator||
name|GDK_POINTER_MOTION_HINT_MASK
operator||
name|GDK_PROXIMITY_OUT_MASK
argument_list|)
expr_stmt|;
comment|/* The following call enables tracking and processing of extension      events for the drawing area */
name|gtk_widget_set_extension_events
argument_list|(
name|event_box
argument_list|,
name|GDK_EXTENSION_EVENTS_ALL
argument_list|)
expr_stmt|;
name|gtk_widget_grab_focus
argument_list|(
name|event_box
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|event_box
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|event_box
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (char * name,int nparams,GParam * param,int * nreturn_vals,GParam ** return_vals)
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GParam
name|values
index|[
literal|1
index|]
decl_stmt|;
name|GRunModeType
name|run_mode
decl_stmt|;
name|GStatusType
name|status
init|=
name|STATUS_SUCCESS
decl_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|PARAM_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|RUN_INTERACTIVE
case|:
if|if
condition|(
operator|!
name|waterselect_dialog
argument_list|()
condition|)
return|return;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"waterselect allows only interactive invocation"
argument_list|)
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit

