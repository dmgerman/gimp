begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Written 1998 Jens Ch. Restemeier<jchrr@hrz.uni-bielefeld.de>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  *  */
end_comment

begin_comment
comment|/*  * This code can be used to read and write FLI movies. It is currently  * only used for the GIMP fli plug-in, but it can be used for other  * programs, too.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"fli.h"
end_include

begin_comment
comment|/*  * To avoid endian-problems I wrote these functions:  */
end_comment

begin_function
DECL|function|fli_read_char (FILE * f)
specifier|static
name|unsigned
name|char
name|fli_read_char
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|)
block|{
name|unsigned
name|char
name|b
decl_stmt|;
name|fread
argument_list|(
operator|&
name|b
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_function
DECL|function|fli_read_short (FILE * f)
specifier|static
name|unsigned
name|short
name|fli_read_short
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|)
block|{
name|unsigned
name|char
name|b
index|[
literal|2
index|]
decl_stmt|;
name|fread
argument_list|(
operator|&
name|b
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|f
argument_list|)
expr_stmt|;
return|return
call|(
name|unsigned
name|short
call|)
argument_list|(
name|b
index|[
literal|1
index|]
operator|<<
literal|8
argument_list|)
operator||
name|b
index|[
literal|0
index|]
return|;
block|}
end_function

begin_function
DECL|function|fli_read_long (FILE * f)
specifier|static
name|unsigned
name|long
name|fli_read_long
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|)
block|{
name|unsigned
name|char
name|b
index|[
literal|4
index|]
decl_stmt|;
name|fread
argument_list|(
operator|&
name|b
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
name|f
argument_list|)
expr_stmt|;
return|return
call|(
name|unsigned
name|long
call|)
argument_list|(
name|b
index|[
literal|3
index|]
operator|<<
literal|24
argument_list|)
operator||
operator|(
name|b
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|b
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|b
index|[
literal|0
index|]
return|;
block|}
end_function

begin_function
DECL|function|fli_write_char (FILE * f,unsigned char b)
specifier|static
name|void
name|fli_write_char
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|unsigned
name|char
name|b
parameter_list|)
block|{
name|fwrite
argument_list|(
operator|&
name|b
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|fli_write_short (FILE * f,unsigned short w)
specifier|static
name|void
name|fli_write_short
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|unsigned
name|short
name|w
parameter_list|)
block|{
name|unsigned
name|char
name|b
index|[
literal|2
index|]
decl_stmt|;
name|b
index|[
literal|0
index|]
operator|=
name|w
operator|&
literal|255
expr_stmt|;
name|b
index|[
literal|1
index|]
operator|=
operator|(
name|w
operator|>>
literal|8
operator|)
operator|&
literal|255
expr_stmt|;
name|fwrite
argument_list|(
operator|&
name|b
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|fli_write_long (FILE * f,unsigned long l)
specifier|static
name|void
name|fli_write_long
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|unsigned
name|long
name|l
parameter_list|)
block|{
name|unsigned
name|char
name|b
index|[
literal|4
index|]
decl_stmt|;
name|b
index|[
literal|0
index|]
operator|=
name|l
operator|&
literal|255
expr_stmt|;
name|b
index|[
literal|1
index|]
operator|=
operator|(
name|l
operator|>>
literal|8
operator|)
operator|&
literal|255
expr_stmt|;
name|b
index|[
literal|2
index|]
operator|=
operator|(
name|l
operator|>>
literal|16
operator|)
operator|&
literal|255
expr_stmt|;
name|b
index|[
literal|3
index|]
operator|=
operator|(
name|l
operator|>>
literal|24
operator|)
operator|&
literal|255
expr_stmt|;
name|fwrite
argument_list|(
operator|&
name|b
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|fli_read_header (FILE * f,s_fli_header * fli_header)
name|void
name|fli_read_header
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|)
block|{
name|fli_header
operator|->
name|filesize
operator|=
name|fli_read_long
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* 0 */
name|fli_header
operator|->
name|magic
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* 4 */
name|fli_header
operator|->
name|frames
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* 6 */
name|fli_header
operator|->
name|width
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* 8 */
name|fli_header
operator|->
name|height
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* 10 */
name|fli_header
operator|->
name|depth
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* 12 */
name|fli_header
operator|->
name|flags
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* 14 */
if|if
condition|(
name|fli_header
operator|->
name|magic
operator|==
name|HEADER_FLI
condition|)
block|{
comment|/* FLI saves speed in 1/70s */
name|fli_header
operator|->
name|speed
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
operator|*
literal|14
expr_stmt|;
comment|/* 16 */
block|}
else|else
block|{
if|if
condition|(
name|fli_header
operator|->
name|magic
operator|==
name|HEADER_FLC
condition|)
block|{
comment|/* FLC saves speed in 1/1000s */
name|fli_header
operator|->
name|speed
operator|=
name|fli_read_long
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* 16 */
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error: magic number is wrong !\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
DECL|function|fli_write_header (FILE * f,s_fli_header * fli_header)
name|void
name|fli_write_header
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|)
block|{
name|fli_header
operator|->
name|filesize
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|filesize
argument_list|)
expr_stmt|;
comment|/* 0 */
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|magic
argument_list|)
expr_stmt|;
comment|/* 4 */
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|frames
argument_list|)
expr_stmt|;
comment|/* 6 */
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|width
argument_list|)
expr_stmt|;
comment|/* 8 */
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|height
argument_list|)
expr_stmt|;
comment|/* 10 */
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|depth
argument_list|)
expr_stmt|;
comment|/* 12 */
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|flags
argument_list|)
expr_stmt|;
comment|/* 14 */
if|if
condition|(
name|fli_header
operator|->
name|magic
operator|==
name|HEADER_FLI
condition|)
block|{
comment|/* FLI saves speed in 1/70s */
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|speed
operator|/
literal|14
argument_list|)
expr_stmt|;
comment|/* 16 */
block|}
else|else
block|{
if|if
condition|(
name|fli_header
operator|->
name|magic
operator|==
name|HEADER_FLC
condition|)
block|{
comment|/* FLC saves speed in 1/1000s */
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|speed
argument_list|)
expr_stmt|;
comment|/* 16 */
name|fseek
argument_list|(
name|f
argument_list|,
literal|80
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|oframe1
argument_list|)
expr_stmt|;
comment|/* 80 */
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|fli_header
operator|->
name|oframe2
argument_list|)
expr_stmt|;
comment|/* 84 */
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error: magic number in header is wrong !\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
DECL|function|fli_read_frame (FILE * f,s_fli_header * fli_header,unsigned char * old_framebuf,unsigned char * old_cmap,unsigned char * framebuf,unsigned char * cmap)
name|void
name|fli_read_frame
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_framebuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_cmap
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|cmap
parameter_list|)
block|{
name|s_fli_frame
name|fli_frame
decl_stmt|;
name|unsigned
name|long
name|framepos
decl_stmt|;
name|int
name|c
decl_stmt|;
name|framepos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fli_frame
operator|.
name|size
operator|=
name|fli_read_long
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fli_frame
operator|.
name|magic
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fli_frame
operator|.
name|chunks
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|fli_frame
operator|.
name|magic
operator|==
name|FRAME
condition|)
block|{
name|fseek
argument_list|(
name|f
argument_list|,
name|framepos
operator|+
literal|16
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|fli_frame
operator|.
name|chunks
condition|;
name|c
operator|++
control|)
block|{
name|s_fli_chunk
name|chunk
decl_stmt|;
name|unsigned
name|long
name|chunkpos
decl_stmt|;
name|chunkpos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|chunk
operator|.
name|size
operator|=
name|fli_read_long
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|chunk
operator|.
name|magic
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|chunk
operator|.
name|magic
condition|)
block|{
case|case
name|FLI_COLOR
case|:
name|fli_read_color
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|old_cmap
argument_list|,
name|cmap
argument_list|)
expr_stmt|;
break|break;
case|case
name|FLI_COLOR_2
case|:
name|fli_read_color_2
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|old_cmap
argument_list|,
name|cmap
argument_list|)
expr_stmt|;
break|break;
case|case
name|FLI_BLACK
case|:
name|fli_read_black
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|framebuf
argument_list|)
expr_stmt|;
break|break;
case|case
name|FLI_BRUN
case|:
name|fli_read_brun
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|framebuf
argument_list|)
expr_stmt|;
break|break;
case|case
name|FLI_COPY
case|:
name|fli_read_copy
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|framebuf
argument_list|)
expr_stmt|;
break|break;
case|case
name|FLI_LC
case|:
name|fli_read_lc
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|old_framebuf
argument_list|,
name|framebuf
argument_list|)
expr_stmt|;
break|break;
case|case
name|FLI_LC_2
case|:
name|fli_read_lc_2
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|old_framebuf
argument_list|,
name|framebuf
argument_list|)
expr_stmt|;
break|break;
case|case
name|FLI_MINI
case|:
comment|/* unused, skip */
break|break;
default|default:
comment|/* unknown, skip */
break|break;
block|}
if|if
condition|(
name|chunk
operator|.
name|size
operator|&
literal|1
condition|)
name|chunk
operator|.
name|size
operator|++
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
name|chunk
operator|.
name|size
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else: unknown, skip */
name|fseek
argument_list|(
name|f
argument_list|,
name|framepos
operator|+
name|fli_frame
operator|.
name|size
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|fli_write_frame (FILE * f,s_fli_header * fli_header,unsigned char * old_framebuf,unsigned char * old_cmap,unsigned char * framebuf,unsigned char * cmap,unsigned short codec_mask)
name|void
name|fli_write_frame
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_framebuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_cmap
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|cmap
parameter_list|,
name|unsigned
name|short
name|codec_mask
parameter_list|)
block|{
name|s_fli_frame
name|fli_frame
decl_stmt|;
name|unsigned
name|long
name|framepos
decl_stmt|,
name|frameend
decl_stmt|;
name|framepos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|framepos
operator|+
literal|16
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fli_header
operator|->
name|frames
condition|)
block|{
case|case
literal|0
case|:
name|fli_header
operator|->
name|oframe1
operator|=
name|framepos
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|fli_header
operator|->
name|oframe2
operator|=
name|framepos
expr_stmt|;
break|break;
block|}
name|fli_frame
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|fli_frame
operator|.
name|magic
operator|=
name|FRAME
expr_stmt|;
name|fli_frame
operator|.
name|chunks
operator|=
literal|0
expr_stmt|;
comment|/*  	 * create color chunk  	 */
if|if
condition|(
name|fli_header
operator|->
name|magic
operator|==
name|HEADER_FLI
condition|)
block|{
if|if
condition|(
name|fli_write_color
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|old_cmap
argument_list|,
name|cmap
argument_list|)
condition|)
name|fli_frame
operator|.
name|chunks
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fli_header
operator|->
name|magic
operator|==
name|HEADER_FLC
condition|)
block|{
if|if
condition|(
name|fli_write_color_2
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|old_cmap
argument_list|,
name|cmap
argument_list|)
condition|)
name|fli_frame
operator|.
name|chunks
operator|++
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error: magic number in header is wrong !\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
literal|0
block|if (codec_mask& W_COLOR) { 		if (fli_write_color(f, fli_header, old_cmap, cmap)) fli_frame.chunks++; 	} 	if (codec_mask& W_COLOR_2) { 		if (fli_write_color_2(f, fli_header, old_cmap, cmap)) fli_frame.chunks++; 	}
endif|#
directive|endif
comment|/* create bitmap chunk */
if|if
condition|(
name|old_framebuf
operator|==
name|NULL
condition|)
block|{
name|fli_write_brun
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|framebuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fli_write_lc
argument_list|(
name|f
argument_list|,
name|fli_header
argument_list|,
name|old_framebuf
argument_list|,
name|framebuf
argument_list|)
expr_stmt|;
block|}
name|fli_frame
operator|.
name|chunks
operator|++
expr_stmt|;
name|frameend
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fli_frame
operator|.
name|size
operator|=
name|frameend
operator|-
name|framepos
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|framepos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|fli_frame
operator|.
name|size
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_frame
operator|.
name|magic
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|fli_frame
operator|.
name|chunks
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|frameend
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_header
operator|->
name|frames
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * palette chunks from the classical Autodesk Animator.  */
end_comment

begin_function
DECL|function|fli_read_color (FILE * f,s_fli_header * fli_header,unsigned char * old_cmap,unsigned char * cmap)
name|void
name|fli_read_color
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_cmap
parameter_list|,
name|unsigned
name|char
modifier|*
name|cmap
parameter_list|)
block|{
name|unsigned
name|short
name|num_packets
decl_stmt|,
name|cnt_packets
decl_stmt|,
name|col_pos
decl_stmt|;
name|col_pos
operator|=
literal|0
expr_stmt|;
name|num_packets
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
for|for
control|(
name|cnt_packets
operator|=
name|num_packets
init|;
name|cnt_packets
operator|>
literal|0
condition|;
name|cnt_packets
operator|--
control|)
block|{
name|unsigned
name|short
name|skip_col
decl_stmt|,
name|num_col
decl_stmt|,
name|col_cnt
decl_stmt|;
name|skip_col
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|num_col
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_col
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|col_pos
operator|=
literal|0
init|;
name|col_pos
operator|<
literal|768
condition|;
name|col_pos
operator|++
control|)
block|{
name|cmap
index|[
name|col_pos
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
operator|<<
literal|2
expr_stmt|;
block|}
return|return;
block|}
for|for
control|(
name|col_cnt
operator|=
name|skip_col
init|;
operator|(
name|col_cnt
operator|>
literal|0
operator|)
operator|&&
operator|(
name|col_pos
operator|<
literal|768
operator|)
condition|;
name|col_cnt
operator|--
control|)
block|{
name|cmap
index|[
name|col_pos
index|]
operator|=
name|old_cmap
index|[
name|col_pos
index|]
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
name|cmap
index|[
name|col_pos
index|]
operator|=
name|old_cmap
index|[
name|col_pos
index|]
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
name|cmap
index|[
name|col_pos
index|]
operator|=
name|old_cmap
index|[
name|col_pos
index|]
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
block|}
for|for
control|(
name|col_cnt
operator|=
name|num_col
init|;
operator|(
name|col_cnt
operator|>
literal|0
operator|)
operator|&&
operator|(
name|col_pos
operator|<
literal|768
operator|)
condition|;
name|col_cnt
operator|--
control|)
block|{
name|cmap
index|[
name|col_pos
operator|++
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|cmap
index|[
name|col_pos
operator|++
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|cmap
index|[
name|col_pos
operator|++
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
operator|<<
literal|2
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
DECL|function|fli_write_color (FILE * f,s_fli_header * fli_header,unsigned char * old_cmap,unsigned char * cmap)
name|int
name|fli_write_color
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_cmap
parameter_list|,
name|unsigned
name|char
modifier|*
name|cmap
parameter_list|)
block|{
name|unsigned
name|long
name|chunkpos
decl_stmt|;
name|unsigned
name|short
name|num_packets
decl_stmt|;
name|s_fli_chunk
name|chunk
decl_stmt|;
name|chunkpos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|num_packets
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|old_cmap
operator|==
name|NULL
condition|)
block|{
name|unsigned
name|short
name|col_pos
decl_stmt|;
name|num_packets
operator|=
literal|1
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* skip no color */
name|fli_write_char
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 256 color */
for|for
control|(
name|col_pos
operator|=
literal|0
init|;
name|col_pos
operator|<
literal|768
condition|;
name|col_pos
operator|++
control|)
block|{
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cmap
index|[
name|col_pos
index|]
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|unsigned
name|short
name|num_packets
decl_stmt|,
name|cnt_skip
decl_stmt|,
name|cnt_col
decl_stmt|,
name|col_pos
decl_stmt|,
name|col_start
decl_stmt|;
name|num_packets
operator|=
literal|0
expr_stmt|;
name|col_pos
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|cnt_skip
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|col_pos
operator|<
literal|256
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|0
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|0
index|]
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|1
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|1
index|]
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|2
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|2
index|]
operator|)
condition|)
block|{
name|cnt_skip
operator|++
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
block|}
name|col_start
operator|=
name|col_pos
expr_stmt|;
name|cnt_col
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|col_pos
operator|<
literal|256
operator|)
operator|&&
operator|!
operator|(
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|0
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|0
index|]
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|1
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|1
index|]
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|2
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|2
index|]
operator|)
operator|)
condition|)
block|{
name|cnt_col
operator|++
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cnt_col
operator|>
literal|0
condition|)
block|{
name|num_packets
operator|++
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cnt_skip
operator|&
literal|255
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cnt_col
operator|&
literal|255
argument_list|)
expr_stmt|;
while|while
condition|(
name|cnt_col
operator|>
literal|0
condition|)
block|{
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cmap
index|[
name|col_start
operator|++
index|]
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cmap
index|[
name|col_start
operator|++
index|]
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cmap
index|[
name|col_start
operator|++
index|]
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|cnt_col
operator|--
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
name|col_pos
operator|<
literal|256
condition|)
do|;
block|}
if|if
condition|(
name|num_packets
operator|>
literal|0
condition|)
block|{
name|chunk
operator|.
name|size
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
operator|-
name|chunkpos
expr_stmt|;
name|chunk
operator|.
name|magic
operator|=
name|FLI_COLOR
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|size
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|magic
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|num_packets
argument_list|)
expr_stmt|;
if|if
condition|(
name|chunk
operator|.
name|size
operator|&
literal|1
condition|)
name|chunk
operator|.
name|size
operator|++
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
name|chunk
operator|.
name|size
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * palette chunks from Autodesk Animator pro  */
end_comment

begin_function
DECL|function|fli_read_color_2 (FILE * f,s_fli_header * fli_header,unsigned char * old_cmap,unsigned char * cmap)
name|void
name|fli_read_color_2
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_cmap
parameter_list|,
name|unsigned
name|char
modifier|*
name|cmap
parameter_list|)
block|{
name|unsigned
name|short
name|num_packets
decl_stmt|,
name|cnt_packets
decl_stmt|,
name|col_pos
decl_stmt|;
name|num_packets
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|col_pos
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cnt_packets
operator|=
name|num_packets
init|;
name|cnt_packets
operator|>
literal|0
condition|;
name|cnt_packets
operator|--
control|)
block|{
name|unsigned
name|short
name|skip_col
decl_stmt|,
name|num_col
decl_stmt|,
name|col_cnt
decl_stmt|;
name|skip_col
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|num_col
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_col
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|col_pos
operator|=
literal|0
init|;
name|col_pos
operator|<
literal|768
condition|;
name|col_pos
operator|++
control|)
block|{
name|cmap
index|[
name|col_pos
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
for|for
control|(
name|col_cnt
operator|=
name|skip_col
init|;
operator|(
name|col_cnt
operator|>
literal|0
operator|)
operator|&&
operator|(
name|col_pos
operator|<
literal|768
operator|)
condition|;
name|col_cnt
operator|--
control|)
block|{
name|cmap
index|[
name|col_pos
index|]
operator|=
name|old_cmap
index|[
name|col_pos
index|]
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
name|cmap
index|[
name|col_pos
index|]
operator|=
name|old_cmap
index|[
name|col_pos
index|]
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
name|cmap
index|[
name|col_pos
index|]
operator|=
name|old_cmap
index|[
name|col_pos
index|]
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
block|}
for|for
control|(
name|col_cnt
operator|=
name|num_col
init|;
operator|(
name|col_cnt
operator|>
literal|0
operator|)
operator|&&
operator|(
name|col_pos
operator|<
literal|768
operator|)
condition|;
name|col_cnt
operator|--
control|)
block|{
name|cmap
index|[
name|col_pos
operator|++
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|cmap
index|[
name|col_pos
operator|++
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|cmap
index|[
name|col_pos
operator|++
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
DECL|function|fli_write_color_2 (FILE * f,s_fli_header * fli_header,unsigned char * old_cmap,unsigned char * cmap)
name|int
name|fli_write_color_2
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_cmap
parameter_list|,
name|unsigned
name|char
modifier|*
name|cmap
parameter_list|)
block|{
name|unsigned
name|long
name|chunkpos
decl_stmt|;
name|unsigned
name|short
name|num_packets
decl_stmt|;
name|s_fli_chunk
name|chunk
decl_stmt|;
name|chunkpos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|num_packets
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|old_cmap
operator|==
name|NULL
condition|)
block|{
name|unsigned
name|short
name|col_pos
decl_stmt|;
name|num_packets
operator|=
literal|1
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* skip no color */
name|fli_write_char
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 256 color */
for|for
control|(
name|col_pos
operator|=
literal|0
init|;
name|col_pos
operator|<
literal|768
condition|;
name|col_pos
operator|++
control|)
block|{
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cmap
index|[
name|col_pos
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|unsigned
name|short
name|num_packets
decl_stmt|,
name|cnt_skip
decl_stmt|,
name|cnt_col
decl_stmt|,
name|col_pos
decl_stmt|,
name|col_start
decl_stmt|;
name|num_packets
operator|=
literal|0
expr_stmt|;
name|col_pos
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|cnt_skip
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|col_pos
operator|<
literal|256
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|0
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|0
index|]
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|1
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|1
index|]
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|2
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|2
index|]
operator|)
condition|)
block|{
name|cnt_skip
operator|++
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
block|}
name|col_start
operator|=
name|col_pos
expr_stmt|;
name|cnt_col
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|col_pos
operator|<
literal|256
operator|)
operator|&&
operator|!
operator|(
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|0
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|0
index|]
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|1
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|1
index|]
operator|)
operator|&&
operator|(
name|old_cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|2
index|]
operator|==
name|cmap
index|[
name|col_pos
operator|*
literal|3
operator|+
literal|2
index|]
operator|)
operator|)
condition|)
block|{
name|cnt_col
operator|++
expr_stmt|;
name|col_pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cnt_col
operator|>
literal|0
condition|)
block|{
name|num_packets
operator|++
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cnt_skip
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cnt_col
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|cnt_col
operator|>
literal|0
condition|;
name|cnt_col
operator|--
control|)
block|{
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cmap
index|[
name|col_start
operator|++
index|]
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cmap
index|[
name|col_start
operator|++
index|]
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|cmap
index|[
name|col_start
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
name|col_pos
operator|<
literal|256
condition|)
do|;
block|}
if|if
condition|(
name|num_packets
operator|>
literal|0
condition|)
block|{
name|chunk
operator|.
name|size
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
operator|-
name|chunkpos
expr_stmt|;
name|chunk
operator|.
name|magic
operator|=
name|FLI_COLOR_2
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|size
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|magic
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|num_packets
argument_list|)
expr_stmt|;
if|if
condition|(
name|chunk
operator|.
name|size
operator|&
literal|1
condition|)
name|chunk
operator|.
name|size
operator|++
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
name|chunk
operator|.
name|size
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * completely black frame  */
end_comment

begin_function
DECL|function|fli_read_black (FILE * f,s_fli_header * fli_header,unsigned char * framebuf)
name|void
name|fli_read_black
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|memset
argument_list|(
name|framebuf
argument_list|,
literal|0
argument_list|,
name|fli_header
operator|->
name|width
operator|*
name|fli_header
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|fli_write_black (FILE * f,s_fli_header * fli_header,unsigned char * framebuf)
name|void
name|fli_write_black
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|s_fli_chunk
name|chunk
decl_stmt|;
name|chunk
operator|.
name|size
operator|=
literal|6
expr_stmt|;
name|chunk
operator|.
name|magic
operator|=
name|FLI_BLACK
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|size
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|magic
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Uncompressed frame  */
end_comment

begin_function
DECL|function|fli_read_copy (FILE * f,s_fli_header * fli_header,unsigned char * framebuf)
name|void
name|fli_read_copy
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|fread
argument_list|(
name|framebuf
argument_list|,
name|fli_header
operator|->
name|width
argument_list|,
name|fli_header
operator|->
name|height
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|fli_write_copy (FILE * f,s_fli_header * fli_header,unsigned char * framebuf)
name|void
name|fli_write_copy
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|unsigned
name|long
name|chunkpos
decl_stmt|;
name|s_fli_chunk
name|chunk
decl_stmt|;
name|chunkpos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
literal|6
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|framebuf
argument_list|,
name|fli_header
operator|->
name|width
argument_list|,
name|fli_header
operator|->
name|height
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|chunk
operator|.
name|size
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
operator|-
name|chunkpos
expr_stmt|;
name|chunk
operator|.
name|magic
operator|=
name|FLI_COPY
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|size
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|magic
argument_list|)
expr_stmt|;
if|if
condition|(
name|chunk
operator|.
name|size
operator|&
literal|1
condition|)
name|chunk
operator|.
name|size
operator|++
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
name|chunk
operator|.
name|size
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This is a RLE algorithm, used for the first image of an animation  */
end_comment

begin_function
DECL|function|fli_read_brun (FILE * f,s_fli_header * fli_header,unsigned char * framebuf)
name|void
name|fli_read_brun
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|unsigned
name|short
name|yc
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pos
decl_stmt|;
for|for
control|(
name|yc
operator|=
literal|0
init|;
name|yc
operator|<
name|fli_header
operator|->
name|height
condition|;
name|yc
operator|++
control|)
block|{
name|unsigned
name|short
name|xc
decl_stmt|,
name|pc
decl_stmt|,
name|pcnt
decl_stmt|;
name|pc
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|xc
operator|=
literal|0
expr_stmt|;
name|pos
operator|=
name|framebuf
operator|+
operator|(
name|fli_header
operator|->
name|width
operator|*
name|yc
operator|)
expr_stmt|;
for|for
control|(
name|pcnt
operator|=
name|pc
init|;
name|pcnt
operator|>
literal|0
condition|;
name|pcnt
operator|--
control|)
block|{
name|unsigned
name|short
name|ps
decl_stmt|;
name|ps
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|&
literal|0x80
condition|)
block|{
name|unsigned
name|short
name|len
decl_stmt|;
for|for
control|(
name|len
operator|=
operator|-
operator|(
name|signed
name|char
operator|)
name|ps
init|;
name|len
operator|>
literal|0
condition|;
name|len
operator|--
control|)
block|{
name|pos
index|[
name|xc
operator|++
index|]
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|unsigned
name|char
name|val
decl_stmt|;
name|val
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
operator|(
name|pos
index|[
name|xc
index|]
operator|)
argument_list|,
name|val
argument_list|,
name|ps
argument_list|)
expr_stmt|;
name|xc
operator|+=
name|ps
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
DECL|function|fli_write_brun (FILE * f,s_fli_header * fli_header,unsigned char * framebuf)
name|void
name|fli_write_brun
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|unsigned
name|long
name|chunkpos
decl_stmt|;
name|s_fli_chunk
name|chunk
decl_stmt|;
name|unsigned
name|short
name|yc
decl_stmt|;
name|unsigned
name|char
modifier|*
name|linebuf
decl_stmt|;
name|chunkpos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
literal|6
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
for|for
control|(
name|yc
operator|=
literal|0
init|;
name|yc
operator|<
name|fli_header
operator|->
name|height
condition|;
name|yc
operator|++
control|)
block|{
name|unsigned
name|short
name|xc
decl_stmt|,
name|t1
decl_stmt|,
name|pc
decl_stmt|,
name|tc
decl_stmt|;
name|unsigned
name|long
name|linepos
decl_stmt|,
name|lineend
decl_stmt|,
name|bc
decl_stmt|;
name|linepos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|bc
operator|=
literal|0
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
literal|1
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
name|linebuf
operator|=
name|framebuf
operator|+
operator|(
name|yc
operator|*
name|fli_header
operator|->
name|width
operator|)
expr_stmt|;
name|xc
operator|=
literal|0
expr_stmt|;
name|tc
operator|=
literal|0
expr_stmt|;
name|t1
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|xc
operator|<
name|fli_header
operator|->
name|width
condition|)
block|{
name|pc
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|pc
operator|<
literal|120
operator|)
operator|&&
operator|(
operator|(
name|xc
operator|+
name|pc
operator|)
operator|<
name|fli_header
operator|->
name|width
operator|)
operator|&&
operator|(
name|linebuf
index|[
name|xc
operator|+
name|pc
index|]
operator|==
name|linebuf
index|[
name|xc
index|]
operator|)
condition|)
block|{
name|pc
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pc
operator|>
literal|2
condition|)
block|{
if|if
condition|(
name|tc
operator|>
literal|0
condition|)
block|{
name|bc
operator|++
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
operator|(
name|tc
operator|-
literal|1
operator|)
operator|^
literal|0xFF
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|linebuf
operator|+
name|t1
argument_list|,
literal|1
argument_list|,
name|tc
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|tc
operator|=
literal|0
expr_stmt|;
block|}
name|bc
operator|++
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|pc
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|linebuf
index|[
name|xc
index|]
argument_list|)
expr_stmt|;
name|t1
operator|=
name|xc
operator|+
name|pc
expr_stmt|;
block|}
else|else
block|{
name|tc
operator|+=
name|pc
expr_stmt|;
if|if
condition|(
name|tc
operator|>
literal|120
condition|)
block|{
name|bc
operator|++
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
operator|(
name|tc
operator|-
literal|1
operator|)
operator|^
literal|0xFF
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|linebuf
operator|+
name|t1
argument_list|,
literal|1
argument_list|,
name|tc
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|tc
operator|=
literal|0
expr_stmt|;
name|t1
operator|=
name|xc
operator|+
name|pc
expr_stmt|;
block|}
block|}
name|xc
operator|+=
name|pc
expr_stmt|;
block|}
if|if
condition|(
name|tc
operator|>
literal|0
condition|)
block|{
name|bc
operator|++
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
operator|(
name|tc
operator|-
literal|1
operator|)
operator|^
literal|0xFF
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|linebuf
operator|+
name|t1
argument_list|,
literal|1
argument_list|,
name|tc
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|tc
operator|=
literal|0
expr_stmt|;
block|}
name|lineend
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|linepos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|bc
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|lineend
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
name|chunk
operator|.
name|size
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
operator|-
name|chunkpos
expr_stmt|;
name|chunk
operator|.
name|magic
operator|=
name|FLI_BRUN
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|size
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|magic
argument_list|)
expr_stmt|;
if|if
condition|(
name|chunk
operator|.
name|size
operator|&
literal|1
condition|)
name|chunk
operator|.
name|size
operator|++
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
name|chunk
operator|.
name|size
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This is the delta-compression method from the classic Autodesk Animator.   * It's basically the RLE method from above, but it allows to skip unchanged  * lines at the beginning and end of an image, and unchanged pixels in a line  * This chunk is used in FLI files.  */
end_comment

begin_function
DECL|function|fli_read_lc (FILE * f,s_fli_header * fli_header,unsigned char * old_framebuf,unsigned char * framebuf)
name|void
name|fli_read_lc
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_framebuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|unsigned
name|short
name|yc
decl_stmt|,
name|firstline
decl_stmt|,
name|numline
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pos
decl_stmt|;
name|memcpy
argument_list|(
name|framebuf
argument_list|,
name|old_framebuf
argument_list|,
name|fli_header
operator|->
name|width
operator|*
name|fli_header
operator|->
name|height
argument_list|)
expr_stmt|;
name|firstline
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|numline
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
for|for
control|(
name|yc
operator|=
literal|0
init|;
name|yc
operator|<
name|numline
condition|;
name|yc
operator|++
control|)
block|{
name|unsigned
name|short
name|xc
decl_stmt|,
name|pc
decl_stmt|,
name|pcnt
decl_stmt|;
name|pc
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|xc
operator|=
literal|0
expr_stmt|;
name|pos
operator|=
name|framebuf
operator|+
operator|(
name|fli_header
operator|->
name|width
operator|*
operator|(
name|firstline
operator|+
name|yc
operator|)
operator|)
expr_stmt|;
for|for
control|(
name|pcnt
operator|=
name|pc
init|;
name|pcnt
operator|>
literal|0
condition|;
name|pcnt
operator|--
control|)
block|{
name|unsigned
name|short
name|ps
decl_stmt|,
name|skip
decl_stmt|;
name|skip
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|ps
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|xc
operator|+=
name|skip
expr_stmt|;
if|if
condition|(
name|ps
operator|&
literal|0x80
condition|)
block|{
name|unsigned
name|char
name|val
decl_stmt|;
name|ps
operator|=
operator|-
operator|(
name|signed
name|char
operator|)
name|ps
expr_stmt|;
name|val
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
operator|(
name|pos
index|[
name|xc
index|]
operator|)
argument_list|,
name|val
argument_list|,
name|ps
argument_list|)
expr_stmt|;
name|xc
operator|+=
name|ps
expr_stmt|;
block|}
else|else
block|{
name|fread
argument_list|(
operator|&
operator|(
name|pos
index|[
name|xc
index|]
operator|)
argument_list|,
name|ps
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|xc
operator|+=
name|ps
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
DECL|function|fli_write_lc (FILE * f,s_fli_header * fli_header,unsigned char * old_framebuf,unsigned char * framebuf)
name|void
name|fli_write_lc
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_framebuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|unsigned
name|long
name|chunkpos
decl_stmt|;
name|s_fli_chunk
name|chunk
decl_stmt|;
name|unsigned
name|short
name|yc
decl_stmt|,
name|firstline
decl_stmt|,
name|numline
decl_stmt|,
name|lastline
decl_stmt|;
name|unsigned
name|char
modifier|*
name|linebuf
decl_stmt|,
modifier|*
name|old_linebuf
decl_stmt|;
name|chunkpos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
literal|6
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
comment|/* first check, how many lines are unchanged at the beginning */
name|firstline
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|memcmp
argument_list|(
name|old_framebuf
operator|+
operator|(
name|firstline
operator|*
name|fli_header
operator|->
name|width
operator|)
argument_list|,
name|framebuf
operator|+
operator|(
name|firstline
operator|*
name|fli_header
operator|->
name|width
operator|)
argument_list|,
name|fli_header
operator|->
name|width
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|firstline
operator|<
name|fli_header
operator|->
name|height
operator|)
condition|)
name|firstline
operator|++
expr_stmt|;
comment|/* then check from the end, how many lines are unchanged */
if|if
condition|(
name|firstline
operator|<
name|fli_header
operator|->
name|height
condition|)
block|{
name|lastline
operator|=
name|fli_header
operator|->
name|height
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|memcmp
argument_list|(
name|old_framebuf
operator|+
operator|(
name|lastline
operator|*
name|fli_header
operator|->
name|width
operator|)
argument_list|,
name|framebuf
operator|+
operator|(
name|lastline
operator|*
name|fli_header
operator|->
name|width
operator|)
argument_list|,
name|fli_header
operator|->
name|width
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|lastline
operator|>
name|firstline
operator|)
condition|)
name|lastline
operator|--
expr_stmt|;
name|numline
operator|=
operator|(
name|lastline
operator|-
name|firstline
operator|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|numline
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|numline
operator|==
literal|0
condition|)
name|firstline
operator|=
literal|0
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|firstline
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|numline
argument_list|)
expr_stmt|;
for|for
control|(
name|yc
operator|=
literal|0
init|;
name|yc
operator|<
name|numline
condition|;
name|yc
operator|++
control|)
block|{
name|unsigned
name|short
name|xc
decl_stmt|,
name|sc
decl_stmt|,
name|cc
decl_stmt|,
name|tc
decl_stmt|;
name|unsigned
name|long
name|linepos
decl_stmt|,
name|lineend
decl_stmt|,
name|bc
decl_stmt|;
name|linepos
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|bc
operator|=
literal|0
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
literal|1
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
name|linebuf
operator|=
name|framebuf
operator|+
operator|(
operator|(
name|firstline
operator|+
name|yc
operator|)
operator|*
name|fli_header
operator|->
name|width
operator|)
expr_stmt|;
name|old_linebuf
operator|=
name|old_framebuf
operator|+
operator|(
operator|(
name|firstline
operator|+
name|yc
operator|)
operator|*
name|fli_header
operator|->
name|width
operator|)
expr_stmt|;
name|xc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|xc
operator|<
name|fli_header
operator|->
name|width
condition|)
block|{
name|sc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|linebuf
index|[
name|xc
index|]
operator|==
name|old_linebuf
index|[
name|xc
index|]
operator|)
operator|&&
operator|(
name|xc
operator|<
name|fli_header
operator|->
name|width
operator|)
operator|&&
operator|(
name|sc
operator|<
literal|255
operator|)
condition|)
block|{
name|xc
operator|++
expr_stmt|;
name|sc
operator|++
expr_stmt|;
block|}
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|cc
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|linebuf
index|[
name|xc
index|]
operator|==
name|linebuf
index|[
name|xc
operator|+
name|cc
index|]
operator|)
operator|&&
operator|(
operator|(
name|xc
operator|+
name|cc
operator|)
operator|<
name|fli_header
operator|->
name|width
operator|)
operator|&&
operator|(
name|cc
operator|<
literal|120
operator|)
condition|)
block|{
name|cc
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cc
operator|>
literal|2
condition|)
block|{
name|bc
operator|++
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
operator|(
name|cc
operator|-
literal|1
operator|)
operator|^
literal|0xFF
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|linebuf
index|[
name|xc
index|]
argument_list|)
expr_stmt|;
name|xc
operator|+=
name|cc
expr_stmt|;
block|}
else|else
block|{
name|tc
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|sc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|linebuf
index|[
name|tc
operator|+
name|xc
operator|+
name|sc
index|]
operator|==
name|old_linebuf
index|[
name|tc
operator|+
name|xc
operator|+
name|sc
index|]
operator|)
operator|&&
operator|(
operator|(
name|tc
operator|+
name|xc
operator|+
name|sc
operator|)
operator|<
name|fli_header
operator|->
name|width
operator|)
operator|&&
operator|(
name|sc
operator|<
literal|5
operator|)
condition|)
block|{
name|sc
operator|++
expr_stmt|;
block|}
name|cc
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|linebuf
index|[
name|tc
operator|+
name|xc
index|]
operator|==
name|linebuf
index|[
name|tc
operator|+
name|xc
operator|+
name|cc
index|]
operator|)
operator|&&
operator|(
operator|(
name|tc
operator|+
name|xc
operator|+
name|cc
operator|)
operator|<
name|fli_header
operator|->
name|width
operator|)
operator|&&
operator|(
name|cc
operator|<
literal|10
operator|)
condition|)
block|{
name|cc
operator|++
expr_stmt|;
block|}
name|tc
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|tc
operator|<
literal|120
operator|)
operator|&&
operator|(
name|cc
operator|<
literal|9
operator|)
operator|&&
operator|(
name|sc
operator|<
literal|4
operator|)
operator|&&
operator|(
operator|(
name|xc
operator|+
name|tc
operator|)
operator|<
name|fli_header
operator|->
name|width
operator|)
condition|)
do|;
name|bc
operator|++
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|linebuf
operator|+
name|xc
argument_list|,
name|tc
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|xc
operator|+=
name|tc
expr_stmt|;
block|}
block|}
name|lineend
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|linepos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_char
argument_list|(
name|f
argument_list|,
name|bc
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|lineend
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
name|chunk
operator|.
name|size
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
operator|-
name|chunkpos
expr_stmt|;
name|chunk
operator|.
name|magic
operator|=
name|FLI_LC
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|fli_write_long
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|size
argument_list|)
expr_stmt|;
name|fli_write_short
argument_list|(
name|f
argument_list|,
name|chunk
operator|.
name|magic
argument_list|)
expr_stmt|;
if|if
condition|(
name|chunk
operator|.
name|size
operator|&
literal|1
condition|)
name|chunk
operator|.
name|size
operator|++
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
name|chunkpos
operator|+
name|chunk
operator|.
name|size
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This is an enhanced version of the old delta-compression used by  * the autodesk animator pro. It's word-oriented, and allows to skip  * larger parts of the image. This chunk is used in FLC files.  */
end_comment

begin_function
DECL|function|fli_read_lc_2 (FILE * f,s_fli_header * fli_header,unsigned char * old_framebuf,unsigned char * framebuf)
name|void
name|fli_read_lc_2
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|s_fli_header
modifier|*
name|fli_header
parameter_list|,
name|unsigned
name|char
modifier|*
name|old_framebuf
parameter_list|,
name|unsigned
name|char
modifier|*
name|framebuf
parameter_list|)
block|{
name|unsigned
name|short
name|yc
decl_stmt|,
name|lc
decl_stmt|,
name|numline
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pos
decl_stmt|;
name|memcpy
argument_list|(
name|framebuf
argument_list|,
name|old_framebuf
argument_list|,
name|fli_header
operator|->
name|width
operator|*
name|fli_header
operator|->
name|height
argument_list|)
expr_stmt|;
name|yc
operator|=
literal|0
expr_stmt|;
name|numline
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
for|for
control|(
name|lc
operator|=
literal|0
init|;
name|lc
operator|<
name|numline
condition|;
name|lc
operator|++
control|)
block|{
name|unsigned
name|short
name|xc
decl_stmt|,
name|pc
decl_stmt|,
name|pcnt
decl_stmt|,
name|lpf
decl_stmt|,
name|lpn
decl_stmt|;
name|pc
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|lpf
operator|=
literal|0
expr_stmt|;
name|lpn
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pc
operator|&
literal|0x8000
condition|)
block|{
if|if
condition|(
name|pc
operator|&
literal|0x4000
condition|)
block|{
name|yc
operator|+=
operator|-
operator|(
name|signed
name|short
operator|)
name|pc
expr_stmt|;
block|}
else|else
block|{
name|lpf
operator|=
literal|1
expr_stmt|;
name|lpn
operator|=
name|pc
operator|&
literal|0xFF
expr_stmt|;
block|}
name|pc
operator|=
name|fli_read_short
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
name|xc
operator|=
literal|0
expr_stmt|;
name|pos
operator|=
name|framebuf
operator|+
operator|(
name|fli_header
operator|->
name|width
operator|*
name|yc
operator|)
expr_stmt|;
for|for
control|(
name|pcnt
operator|=
name|pc
init|;
name|pcnt
operator|>
literal|0
condition|;
name|pcnt
operator|--
control|)
block|{
name|unsigned
name|short
name|ps
decl_stmt|,
name|skip
decl_stmt|;
name|skip
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|ps
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|xc
operator|+=
name|skip
expr_stmt|;
if|if
condition|(
name|ps
operator|&
literal|0x80
condition|)
block|{
name|unsigned
name|char
name|v1
decl_stmt|,
name|v2
decl_stmt|;
name|ps
operator|=
operator|-
operator|(
name|signed
name|char
operator|)
name|ps
expr_stmt|;
name|v1
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|v2
operator|=
name|fli_read_char
argument_list|(
name|f
argument_list|)
expr_stmt|;
while|while
condition|(
name|ps
operator|>
literal|0
condition|)
block|{
name|pos
index|[
name|xc
operator|++
index|]
operator|=
name|v1
expr_stmt|;
name|pos
index|[
name|xc
operator|++
index|]
operator|=
name|v2
expr_stmt|;
name|ps
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
name|fread
argument_list|(
operator|&
operator|(
name|pos
index|[
name|xc
index|]
operator|)
argument_list|,
name|ps
argument_list|,
literal|2
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|xc
operator|+=
name|ps
operator|<<
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|lpf
condition|)
name|pos
index|[
name|xc
index|]
operator|=
name|lpn
expr_stmt|;
name|yc
operator|++
expr_stmt|;
block|}
block|}
end_function

end_unit

