begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***************************************************************************/
end_comment

begin_comment
comment|/* GCK - The General Convenience Kit. Generally useful conveniece routines */
end_comment

begin_comment
comment|/* for GIMP plug-in writers and users of the GDK/GTK libraries.            */
end_comment

begin_comment
comment|/* Copyright (C) 1996 Tom Bech                                             */
end_comment

begin_comment
comment|/*                                                                         */
end_comment

begin_comment
comment|/* This program is free software; you can redistribute it and/or modify    */
end_comment

begin_comment
comment|/* it under the terms of the GNU General Public License as published by    */
end_comment

begin_comment
comment|/* the Free Software Foundation; either version 2 of the License, or       */
end_comment

begin_comment
comment|/* (at your option) any later version.                                     */
end_comment

begin_comment
comment|/*                                                                         */
end_comment

begin_comment
comment|/* This program is distributed in the hope that it will be useful,         */
end_comment

begin_comment
comment|/* but WITHOUT ANY WARRANTY; without even the implied warranty of          */
end_comment

begin_comment
comment|/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           */
end_comment

begin_comment
comment|/* GNU General Public License for more details.                            */
end_comment

begin_comment
comment|/*                                                                         */
end_comment

begin_comment
comment|/* You should have received a copy of the GNU General Public License       */
end_comment

begin_comment
comment|/* along with this program; if not, write to the Free Software             */
end_comment

begin_comment
comment|/* Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307,   */
end_comment

begin_comment
comment|/* USA.                                                                    */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_comment
comment|/*************************************************************/
end_comment

begin_comment
comment|/* This file contains routines for creating and setting up   */
end_comment

begin_comment
comment|/* visuals. There's also routines for converting RGB(A) data */
end_comment

begin_comment
comment|/* to whatever format the current visual is.                 */
end_comment

begin_comment
comment|/*************************************************************/
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_warning
warning|#
directive|warning
warning|GDK_DISABLE_DEPRECATED
end_warning

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|GDK_DISABLE_DEPRECATED
end_undef

begin_include
include|#
directive|include
file|<glib.h>
end_include

begin_include
include|#
directive|include
file|"libgimpcolor/gimpcolor.h"
end_include

begin_include
include|#
directive|include
file|"libgimpmath/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"gck.h"
end_include

begin_define
DECL|macro|RESERVED_COLORS
define|#
directive|define
name|RESERVED_COLORS
value|2
end_define

begin_define
DECL|macro|ROUND_TO_INT (val)
define|#
directive|define
name|ROUND_TO_INT
parameter_list|(
name|val
parameter_list|)
value|((val) + 0.5)
end_define

begin_comment
comment|/* returns a static storage */
end_comment

begin_function_decl
specifier|static
name|GdkColor
modifier|*
name|gck_rgb_to_gdkcolor
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************/
end_comment

begin_comment
comment|/* Implementation */
end_comment

begin_comment
comment|/******************/
end_comment

begin_comment
comment|/********************************************************/
end_comment

begin_comment
comment|/* This routine tries to allocate a biggest possible    */
end_comment

begin_comment
comment|/* color cube (used only on 8 bit pseudo color visuals) */
end_comment

begin_comment
comment|/* Shamelessly ripped from colormaps.c by S&P.          */
end_comment

begin_comment
comment|/* I'm not sure if I'm going to use this or not.        */
end_comment

begin_comment
comment|/********************************************************/
end_comment

begin_function
DECL|function|gck_allocate_color_cube (GckVisualInfo * visinfo,int red,int green,int blue)
name|int
name|gck_allocate_color_cube
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|int
name|red
parameter_list|,
name|int
name|green
parameter_list|,
name|int
name|blue
parameter_list|)
block|{
name|int
name|init_r
decl_stmt|,
name|init_g
decl_stmt|,
name|init_b
decl_stmt|;
name|int
name|total
decl_stmt|;
name|int
name|success
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|init_r
operator|=
name|red
expr_stmt|;
name|init_g
operator|=
name|green
expr_stmt|;
name|init_b
operator|=
name|blue
expr_stmt|;
comment|/* First, reduce number of total colors to fit a 8 bit LUT */
comment|/* ======================================================= */
name|total
operator|=
name|red
operator|*
name|green
operator|*
name|blue
operator|+
name|RESERVED_COLORS
expr_stmt|;
while|while
condition|(
name|total
operator|>
literal|256
condition|)
block|{
if|if
condition|(
name|blue
operator|>=
name|red
operator|&&
name|blue
operator|>=
name|green
condition|)
name|blue
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|red
operator|>=
name|green
operator|&&
name|red
operator|>=
name|blue
condition|)
name|red
operator|--
expr_stmt|;
else|else
name|green
operator|--
expr_stmt|;
name|total
operator|=
name|red
operator|*
name|green
operator|*
name|blue
operator|+
name|RESERVED_COLORS
expr_stmt|;
block|}
comment|/* Now, attempt to allocate the colors. If no success, reduce the */
comment|/* color cube resolution and try again.                           */
comment|/* ============================================================== */
name|success
operator|=
name|gdk_colors_alloc
argument_list|(
name|visinfo
operator|->
name|colormap
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|visinfo
operator|->
name|allocedpixels
argument_list|,
name|total
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|success
condition|)
block|{
if|if
condition|(
name|blue
operator|>=
name|red
operator|&&
name|blue
operator|>=
name|green
condition|)
name|blue
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|red
operator|>=
name|green
operator|&&
name|red
operator|>=
name|blue
condition|)
name|red
operator|--
expr_stmt|;
else|else
name|green
operator|--
expr_stmt|;
name|total
operator|=
name|red
operator|*
name|green
operator|*
name|blue
operator|+
name|RESERVED_COLORS
expr_stmt|;
if|if
condition|(
name|red
operator|<=
literal|2
operator|||
name|green
operator|<=
literal|2
operator|||
name|blue
operator|<=
literal|2
condition|)
name|success
operator|=
literal|1
expr_stmt|;
else|else
name|success
operator|=
name|gdk_colors_alloc
argument_list|(
name|visinfo
operator|->
name|colormap
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|visinfo
operator|->
name|allocedpixels
argument_list|,
name|total
argument_list|)
expr_stmt|;
block|}
comment|/* If any shades value has been reduced to nothing, return error flag */
comment|/* ================================================================== */
if|if
condition|(
name|red
operator|>
literal|1
operator|&&
name|green
operator|>
literal|1
operator|&&
name|blue
operator|>
literal|1
condition|)
block|{
name|success
operator|=
name|TRUE
expr_stmt|;
name|visinfo
operator|->
name|shades_r
operator|=
name|red
expr_stmt|;
name|visinfo
operator|->
name|shades_g
operator|=
name|green
expr_stmt|;
name|visinfo
operator|->
name|shades_b
operator|=
name|blue
expr_stmt|;
name|visinfo
operator|->
name|numcolors
operator|=
name|total
expr_stmt|;
block|}
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
return|return
operator|(
name|success
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************/
end_comment

begin_comment
comment|/* Create 8 bit RGB color cube. Also more or less */
end_comment

begin_comment
comment|/* ripped from colormaps.c by S&P.                */
end_comment

begin_comment
comment|/**************************************************/
end_comment

begin_function
DECL|function|gck_create_8bit_rgb (GckVisualInfo * visinfo)
name|void
name|gck_create_8bit_rgb
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|)
block|{
name|unsigned
name|int
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|unsigned
name|int
name|dr
decl_stmt|,
name|dg
decl_stmt|,
name|db
decl_stmt|;
name|int
name|i
init|=
name|RESERVED_COLORS
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dr
operator|=
operator|(
name|visinfo
operator|->
name|shades_r
operator|>
literal|1
operator|)
condition|?
operator|(
name|visinfo
operator|->
name|shades_r
operator|-
literal|1
operator|)
else|:
operator|(
literal|1
operator|)
expr_stmt|;
name|dg
operator|=
operator|(
name|visinfo
operator|->
name|shades_g
operator|>
literal|1
operator|)
condition|?
operator|(
name|visinfo
operator|->
name|shades_g
operator|-
literal|1
operator|)
else|:
operator|(
literal|1
operator|)
expr_stmt|;
name|db
operator|=
operator|(
name|visinfo
operator|->
name|shades_b
operator|>
literal|1
operator|)
condition|?
operator|(
name|visinfo
operator|->
name|shades_b
operator|-
literal|1
operator|)
else|:
operator|(
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|r
operator|=
literal|0
init|;
name|r
operator|<
name|visinfo
operator|->
name|shades_r
condition|;
name|r
operator|++
control|)
for|for
control|(
name|g
operator|=
literal|0
init|;
name|g
operator|<
name|visinfo
operator|->
name|shades_g
condition|;
name|g
operator|++
control|)
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|visinfo
operator|->
name|shades_b
condition|;
name|b
operator|++
control|)
block|{
name|visinfo
operator|->
name|colorcube
index|[
name|i
index|]
operator|=
name|visinfo
operator|->
name|allocedpixels
index|[
name|i
index|]
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
name|i
index|]
operator|.
name|red
operator|=
operator|(
name|guint
operator|)
name|ROUND_TO_INT
argument_list|(
literal|255.0
operator|*
call|(
name|double
call|)
argument_list|(
name|r
operator|*
name|visinfo
operator|->
name|visual
operator|->
name|colormap_size
argument_list|)
operator|/
operator|(
name|double
operator|)
name|dr
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
name|i
index|]
operator|.
name|green
operator|=
operator|(
name|guint
operator|)
name|ROUND_TO_INT
argument_list|(
literal|255.0
operator|*
call|(
name|double
call|)
argument_list|(
name|g
operator|*
name|visinfo
operator|->
name|visual
operator|->
name|colormap_size
argument_list|)
operator|/
operator|(
name|double
operator|)
name|dg
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
name|i
index|]
operator|.
name|blue
operator|=
operator|(
name|guint
operator|)
name|ROUND_TO_INT
argument_list|(
literal|255.0
operator|*
call|(
name|double
call|)
argument_list|(
name|b
operator|*
name|visinfo
operator|->
name|visual
operator|->
name|colormap_size
argument_list|)
operator|/
operator|(
name|double
operator|)
name|db
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
name|i
index|]
operator|.
name|pixel
operator|=
name|visinfo
operator|->
name|allocedpixels
index|[
name|i
index|]
expr_stmt|;
name|visinfo
operator|->
name|indextab
index|[
name|r
index|]
index|[
name|g
index|]
index|[
name|b
index|]
operator|=
operator|(
name|guchar
operator|)
name|visinfo
operator|->
name|allocedpixels
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
comment|/* Set up mapping tables */
comment|/* ===================== */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|visinfo
operator|->
name|map_r
index|[
name|i
index|]
operator|=
operator|(
name|int
operator|)
name|ROUND_TO_INT
argument_list|(
operator|(
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_r
operator|-
literal|1
argument_list|)
operator|*
operator|(
operator|(
name|double
operator|)
name|i
operator|/
literal|255.0
operator|)
operator|)
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|map_g
index|[
name|i
index|]
operator|=
operator|(
name|int
operator|)
name|ROUND_TO_INT
argument_list|(
operator|(
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_g
operator|-
literal|1
argument_list|)
operator|*
operator|(
operator|(
name|double
operator|)
name|i
operator|/
literal|255.0
operator|)
operator|)
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|map_b
index|[
name|i
index|]
operator|=
operator|(
name|int
operator|)
name|ROUND_TO_INT
argument_list|(
operator|(
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_b
operator|-
literal|1
argument_list|)
operator|*
operator|(
operator|(
name|double
operator|)
name|i
operator|/
literal|255.0
operator|)
operator|)
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|invmap_r
index|[
name|i
index|]
operator|=
operator|(
name|double
operator|)
name|visinfo
operator|->
name|map_r
index|[
name|i
index|]
operator|*
operator|(
literal|255.0
operator|/
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_r
operator|-
literal|1
argument_list|)
operator|)
expr_stmt|;
name|visinfo
operator|->
name|invmap_g
index|[
name|i
index|]
operator|=
operator|(
name|double
operator|)
name|visinfo
operator|->
name|map_g
index|[
name|i
index|]
operator|*
operator|(
literal|255.0
operator|/
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_g
operator|-
literal|1
argument_list|)
operator|)
expr_stmt|;
name|visinfo
operator|->
name|invmap_b
index|[
name|i
index|]
operator|=
operator|(
name|double
operator|)
name|visinfo
operator|->
name|map_b
index|[
name|i
index|]
operator|*
operator|(
literal|255.0
operator|/
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_b
operator|-
literal|1
argument_list|)
operator|)
expr_stmt|;
block|}
comment|/* Create reserved colors */
comment|/* ====================== */
name|visinfo
operator|->
name|rgbpalette
index|[
literal|0
index|]
operator|.
name|red
operator|=
literal|0
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|0
index|]
operator|.
name|green
operator|=
literal|0
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|0
index|]
operator|.
name|blue
operator|=
literal|0
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|0
index|]
operator|.
name|pixel
operator|=
name|visinfo
operator|->
name|allocedpixels
index|[
literal|0
index|]
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|1
index|]
operator|.
name|red
operator|=
literal|65535
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|1
index|]
operator|.
name|green
operator|=
literal|65535
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|1
index|]
operator|.
name|blue
operator|=
literal|65535
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|1
index|]
operator|.
name|pixel
operator|=
name|visinfo
operator|->
name|allocedpixels
index|[
literal|1
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************/
end_comment

begin_comment
comment|/* Get visual and create colormap */
end_comment

begin_comment
comment|/**********************************/
end_comment

begin_function
DECL|function|gck_visualinfo_new (void)
name|GckVisualInfo
modifier|*
name|gck_visualinfo_new
parameter_list|(
name|void
parameter_list|)
block|{
name|GckVisualInfo
modifier|*
name|visinfo
decl_stmt|;
name|visinfo
operator|=
operator|(
name|GckVisualInfo
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|GckVisualInfo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|visinfo
operator|!=
name|NULL
condition|)
block|{
name|visinfo
operator|->
name|visual
operator|=
name|gdk_visual_get_best
argument_list|()
expr_stmt|;
name|visinfo
operator|->
name|colormap
operator|=
name|gdk_colormap_new
argument_list|(
name|visinfo
operator|->
name|visual
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|dithermethod
operator|=
name|DITHER_FLOYD_STEINBERG
expr_stmt|;
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_PSEUDO_COLOR
condition|)
block|{
comment|/* Allocate colormap and create RGB map */
comment|/* ==================================== */
if|if
condition|(
name|gck_allocate_color_cube
argument_list|(
name|visinfo
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|gck_create_8bit_rgb
argument_list|(
name|visinfo
argument_list|)
expr_stmt|;
name|gdk_colors_store
argument_list|(
name|visinfo
operator|->
name|colormap
argument_list|,
name|visinfo
operator|->
name|rgbpalette
argument_list|,
name|visinfo
operator|->
name|numcolors
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|g_free
argument_list|(
name|visinfo
argument_list|)
expr_stmt|;
name|visinfo
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|visinfo
operator|)
return|;
block|}
end_function

begin_comment
comment|/***********************************************************/
end_comment

begin_comment
comment|/* Free memory associated with the GckVisualInfo structure */
end_comment

begin_comment
comment|/***********************************************************/
end_comment

begin_function
DECL|function|gck_visualinfo_destroy (GckVisualInfo * visinfo)
name|void
name|gck_visualinfo_destroy
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|visinfo
operator|->
name|colormap
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|visinfo
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* This converts from TrueColor RGB (24bpp) to   */
end_comment

begin_comment
comment|/* whatever format the visual of our image uses. */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
DECL|function|gck_visualinfo_get_dither (GckVisualInfo * visinfo)
name|GckDitherType
name|gck_visualinfo_get_dither
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|visinfo
operator|->
name|dithermethod
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_visualinfo_set_dither (GckVisualInfo * visinfo,GckDitherType method)
name|void
name|gck_visualinfo_set_dither
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|GckDitherType
name|method
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|dithermethod
operator|=
name|method
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************/
end_comment

begin_comment
comment|/* GdkGC functions */
end_comment

begin_comment
comment|/*******************/
end_comment

begin_function
DECL|function|gck_gc_set_foreground (GckVisualInfo * visinfo,GdkGC * gc,guchar r,guchar g,guchar b)
name|void
name|gck_gc_set_foreground
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|GdkGC
modifier|*
name|gc
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|gc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|gdk_gc_set_foreground
argument_list|(
name|gc
argument_list|,
name|gck_rgb_to_gdkcolor
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_gc_set_background (GckVisualInfo * visinfo,GdkGC * gc,guchar r,guchar g,guchar b)
name|void
name|gck_gc_set_background
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|GdkGC
modifier|*
name|gc
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|gc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|gdk_gc_set_background
argument_list|(
name|gc
argument_list|,
name|gck_rgb_to_gdkcolor
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* RGB to 8 bpp pseudocolor (indexed) functions. */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color8 (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color8
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
specifier|static
name|GdkColor
name|color
decl_stmt|;
name|gint
name|index
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|r
operator|=
name|visinfo
operator|->
name|map_r
index|[
name|r
index|]
expr_stmt|;
name|g
operator|=
name|visinfo
operator|->
name|map_g
index|[
name|g
index|]
expr_stmt|;
name|b
operator|=
name|visinfo
operator|->
name|map_b
index|[
name|b
index|]
expr_stmt|;
name|index
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|r
index|]
index|[
name|g
index|]
index|[
name|b
index|]
expr_stmt|;
name|color
operator|=
name|visinfo
operator|->
name|rgbpalette
index|[
name|index
index|]
expr_stmt|;
return|return
operator|(
operator|&
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************/
end_comment

begin_comment
comment|/* RGB to 8 bpp pseudocolor using error-diffusion  */
end_comment

begin_comment
comment|/* dithering using the weights proposed by Floyd   */
end_comment

begin_comment
comment|/* and Steinberg (aka "Floyd-Steinberg dithering") */
end_comment

begin_comment
comment|/***************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image8_fs_dither (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image8_fs_dither
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guchar
modifier|*
name|imagedata
decl_stmt|;
name|gint
name|or
decl_stmt|,
name|og
decl_stmt|,
name|ob
decl_stmt|,
name|mr
decl_stmt|,
name|mg
decl_stmt|,
name|mb
decl_stmt|,
name|dr
decl_stmt|,
name|dg
decl_stmt|,
name|db
decl_stmt|;
name|gint
modifier|*
name|row1
decl_stmt|,
modifier|*
name|row2
decl_stmt|,
modifier|*
name|temp
decl_stmt|,
name|rowcnt
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|,
name|rowsize
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Allocate memory for FS errors */
comment|/* ============================= */
name|rowsize
operator|=
literal|3
operator|*
name|width
expr_stmt|;
name|row1
operator|=
operator|(
name|gint
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
operator|(
name|size_t
operator|)
name|rowsize
argument_list|)
expr_stmt|;
name|row2
operator|=
operator|(
name|gint
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
operator|(
name|size_t
operator|)
name|rowsize
argument_list|)
expr_stmt|;
comment|/* Initialize to zero */
comment|/* ================== */
name|memset
argument_list|(
name|row1
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|row2
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|width
operator|<
name|width
condition|)
name|width
operator|=
name|image
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|height
operator|<
name|height
condition|)
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guchar
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
comment|/* It's rec. to move from left to right on even  */
comment|/* rows and right to left on odd rows, so we do. */
comment|/* ============================================= */
if|if
condition|(
operator|(
name|ycnt
operator|%
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|rowcnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
comment|/* Get exact (original) value */
comment|/* ========================== */
name|or
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
index|]
expr_stmt|;
name|og
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|1
index|]
expr_stmt|;
name|ob
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|2
index|]
expr_stmt|;
comment|/* Extract and add the accumulated error for this pixel */
comment|/* ==================================================== */
name|or
operator|=
name|or
operator|+
operator|(
name|row1
index|[
name|rowcnt
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
comment|/* Make sure we don't run into an under- or overflow */
comment|/* ================================================= */
if|if
condition|(
name|or
operator|>
literal|255
condition|)
name|or
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|or
operator|<
literal|0
condition|)
name|or
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|og
operator|>
literal|255
condition|)
name|og
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|og
operator|<
literal|0
condition|)
name|og
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ob
operator|>
literal|255
condition|)
name|ob
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|ob
operator|<
literal|0
condition|)
name|ob
operator|=
literal|0
expr_stmt|;
comment|/* Compute difference */
comment|/* ================== */
name|dr
operator|=
name|or
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_r
index|[
name|or
index|]
expr_stmt|;
name|dg
operator|=
name|og
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_g
index|[
name|og
index|]
expr_stmt|;
name|db
operator|=
name|ob
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_b
index|[
name|ob
index|]
expr_stmt|;
comment|/* Spread the error to the neighboring pixels.    */
comment|/* We use the weights proposed by Floyd-Steinberg */
comment|/* for 3x3 neighborhoods (1*, 3*, 5* and 7*1/16). */
comment|/* ============================================== */
if|if
condition|(
name|xcnt
operator|<
name|width
operator|-
literal|1
condition|)
block|{
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
if|if
condition|(
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xcnt
operator|>
literal|0
operator|&&
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
name|row2
index|[
name|rowcnt
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
comment|/* Clear the errorvalues of the processed row */
comment|/* ========================================== */
name|row1
index|[
name|rowcnt
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Map RGB values to color cube and write pixel */
comment|/* ============================================ */
name|mr
operator|=
name|visinfo
operator|->
name|map_r
index|[
operator|(
name|guchar
operator|)
name|or
index|]
expr_stmt|;
name|mg
operator|=
name|visinfo
operator|->
name|map_g
index|[
operator|(
name|guchar
operator|)
name|og
index|]
expr_stmt|;
name|mb
operator|=
name|visinfo
operator|->
name|map_b
index|[
operator|(
name|guchar
operator|)
name|ob
index|]
expr_stmt|;
name|imagedata
index|[
name|xcnt
index|]
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|mr
index|]
index|[
name|mg
index|]
index|[
name|mb
index|]
expr_stmt|;
name|rowcnt
operator|+=
literal|3
expr_stmt|;
block|}
block|}
else|else
block|{
name|rowcnt
operator|=
name|rowsize
operator|-
literal|3
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
name|width
operator|-
literal|1
init|;
name|xcnt
operator|>=
literal|0
condition|;
name|xcnt
operator|--
control|)
block|{
comment|/* Same as above but in the other direction */
comment|/* ======================================== */
name|or
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
index|]
expr_stmt|;
name|og
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|1
index|]
expr_stmt|;
name|ob
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|2
index|]
expr_stmt|;
name|or
operator|=
name|or
operator|+
operator|(
name|row1
index|[
name|rowcnt
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|or
operator|>
literal|255
condition|)
name|or
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|or
operator|<
literal|0
condition|)
name|or
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|og
operator|>
literal|255
condition|)
name|og
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|og
operator|<
literal|0
condition|)
name|og
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ob
operator|>
literal|255
condition|)
name|ob
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|ob
operator|<
literal|0
condition|)
name|ob
operator|=
literal|0
expr_stmt|;
name|dr
operator|=
name|or
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_r
index|[
name|or
index|]
expr_stmt|;
name|dg
operator|=
name|og
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_g
index|[
name|og
index|]
expr_stmt|;
name|db
operator|=
name|ob
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_b
index|[
name|ob
index|]
expr_stmt|;
if|if
condition|(
name|xcnt
operator|>
literal|0
condition|)
block|{
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
if|if
condition|(
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xcnt
operator|<
name|width
operator|-
literal|1
operator|&&
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
name|row2
index|[
name|rowcnt
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
name|row1
index|[
name|rowcnt
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|mr
operator|=
name|visinfo
operator|->
name|map_r
index|[
operator|(
name|guchar
operator|)
name|or
index|]
expr_stmt|;
name|mg
operator|=
name|visinfo
operator|->
name|map_g
index|[
operator|(
name|guchar
operator|)
name|og
index|]
expr_stmt|;
name|mb
operator|=
name|visinfo
operator|->
name|map_b
index|[
operator|(
name|guchar
operator|)
name|ob
index|]
expr_stmt|;
name|imagedata
index|[
name|xcnt
index|]
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|mr
index|]
index|[
name|mg
index|]
index|[
name|mb
index|]
expr_stmt|;
name|rowcnt
operator|-=
literal|3
expr_stmt|;
block|}
block|}
comment|/* We're finished with this row, swap row-pointers */
comment|/* =============================================== */
name|temp
operator|=
name|row1
expr_stmt|;
name|row1
operator|=
name|row2
expr_stmt|;
name|row2
operator|=
name|temp
expr_stmt|;
name|imagedata
operator|+=
name|width
operator|+
name|diffx
expr_stmt|;
name|count
operator|+=
name|rowsize
expr_stmt|;
block|}
name|g_free
argument_list|(
name|row1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|row2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***********************************************************/
end_comment

begin_comment
comment|/* Plain (no dithering) RGB to 8 bpp pseudocolor (indexed) */
end_comment

begin_comment
comment|/***********************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image8 (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image8
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guchar
modifier|*
name|imagedata
decl_stmt|,
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guchar
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
if|if
condition|(
name|xcnt
operator|<
name|image
operator|->
name|width
operator|&&
name|ycnt
operator|<
name|image
operator|->
name|height
condition|)
block|{
name|r
operator|=
name|RGB_data
index|[
name|count
index|]
expr_stmt|;
name|g
operator|=
name|RGB_data
index|[
name|count
operator|+
literal|1
index|]
expr_stmt|;
name|b
operator|=
name|RGB_data
index|[
name|count
operator|+
literal|2
index|]
expr_stmt|;
name|r
operator|=
name|visinfo
operator|->
name|map_r
index|[
name|r
index|]
expr_stmt|;
name|g
operator|=
name|visinfo
operator|->
name|map_g
index|[
name|g
index|]
expr_stmt|;
name|b
operator|=
name|visinfo
operator|->
name|map_b
index|[
name|b
index|]
expr_stmt|;
operator|*
name|imagedata
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|r
index|]
index|[
name|g
index|]
index|[
name|b
index|]
expr_stmt|;
name|imagedata
operator|++
expr_stmt|;
block|}
name|count
operator|+=
literal|3
expr_stmt|;
block|}
name|imagedata
operator|+=
name|diffx
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/************************************/
end_comment

begin_comment
comment|/* RGB to 16/15 bpp RGB ("HiColor") */
end_comment

begin_comment
comment|/************************************/
end_comment

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color16 (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color16
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
specifier|static
name|GdkColor
name|color
decl_stmt|;
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|red
operator|=
name|red
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|green
operator|=
name|green
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|blue
operator|=
name|blue
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|color
operator|.
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
operator|&
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************/
end_comment

begin_comment
comment|/* RGB to 16 bpp truecolor using error-diffusion   */
end_comment

begin_comment
comment|/* dithering using the weights proposed by Floyd   */
end_comment

begin_comment
comment|/* and Steinberg (aka "Floyd-Steinberg dithering") */
end_comment

begin_comment
comment|/***************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image16_fs_dither (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image16_fs_dither
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guint16
modifier|*
name|imagedata
decl_stmt|,
name|pixel
decl_stmt|;
name|gint16
name|or
decl_stmt|,
name|og
decl_stmt|,
name|ob
decl_stmt|,
name|dr
decl_stmt|,
name|dg
decl_stmt|,
name|db
decl_stmt|;
name|gint16
modifier|*
name|row1
decl_stmt|,
modifier|*
name|row2
decl_stmt|,
modifier|*
name|temp
decl_stmt|,
name|rowcnt
decl_stmt|,
name|rmask
decl_stmt|,
name|gmask
decl_stmt|,
name|bmask
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|,
name|rowsize
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Allocate memory for FS errors */
comment|/* ============================= */
name|rowsize
operator|=
literal|3
operator|*
name|width
expr_stmt|;
name|row1
operator|=
operator|(
name|gint16
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint16
argument_list|)
operator|*
operator|(
name|size_t
operator|)
name|rowsize
argument_list|)
expr_stmt|;
name|row2
operator|=
operator|(
name|gint16
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint16
argument_list|)
operator|*
operator|(
name|size_t
operator|)
name|rowsize
argument_list|)
expr_stmt|;
comment|/* Initialize to zero */
comment|/* ================== */
name|memset
argument_list|(
name|row1
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|gint16
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|row2
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|gint16
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|width
operator|<
name|width
condition|)
name|width
operator|=
name|image
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|height
operator|<
name|height
condition|)
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|rmask
operator|=
operator|(
literal|0xff
operator|<<
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
name|gmask
operator|=
operator|(
literal|0xff
operator|<<
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bmask
operator|=
operator|(
literal|0xff
operator|<<
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guint16
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
comment|/* It is rec. to move from left to right on even */
comment|/* rows and right to left on odd rows, so we do. */
comment|/* ============================================= */
if|if
condition|(
operator|(
name|ycnt
operator|%
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|rowcnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
comment|/* Get exact (original) value */
comment|/* ========================== */
name|pixel
operator|=
literal|0
expr_stmt|;
name|or
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
index|]
expr_stmt|;
name|og
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|1
index|]
expr_stmt|;
name|ob
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|2
index|]
expr_stmt|;
comment|/* Extract and add the accumulated error for this pixel */
comment|/* ==================================================== */
name|or
operator|=
name|or
operator|+
operator|(
name|row1
index|[
name|rowcnt
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
comment|/* Make sure we don't run into an under- or overflow */
comment|/* ================================================= */
if|if
condition|(
name|or
operator|>
literal|255
condition|)
name|or
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|or
operator|<
literal|0
condition|)
name|or
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|og
operator|>
literal|255
condition|)
name|og
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|og
operator|<
literal|0
condition|)
name|og
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ob
operator|>
literal|255
condition|)
name|ob
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|ob
operator|<
literal|0
condition|)
name|ob
operator|=
literal|0
expr_stmt|;
comment|/* Compute difference */
comment|/* ================== */
name|dr
operator|=
name|or
operator|-
operator|(
name|or
operator|&
name|rmask
operator|)
expr_stmt|;
name|dg
operator|=
name|og
operator|-
operator|(
name|og
operator|&
name|gmask
operator|)
expr_stmt|;
name|db
operator|=
name|ob
operator|-
operator|(
name|ob
operator|&
name|bmask
operator|)
expr_stmt|;
comment|/* Spread the error to the neighboring pixels.    */
comment|/* We use the weights proposed by Floyd-Steinberg */
comment|/* for 3x3 neighborhoods (1*, 3*, 5* and 7*1/16). */
comment|/* ============================================== */
if|if
condition|(
name|xcnt
operator|<
name|width
operator|-
literal|1
condition|)
block|{
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
if|if
condition|(
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xcnt
operator|>
literal|0
operator|&&
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
name|row2
index|[
name|rowcnt
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
comment|/* Clear the errorvalues of the processed row */
comment|/* ========================================== */
name|row1
index|[
name|rowcnt
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|or
operator|=
name|or
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|or
operator|=
name|or
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|og
operator|=
name|og
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|ob
operator|=
name|ob
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|pixel
operator|=
name|pixel
operator||
name|or
operator||
name|og
operator||
name|ob
expr_stmt|;
name|imagedata
index|[
name|xcnt
index|]
operator|=
name|pixel
expr_stmt|;
name|rowcnt
operator|+=
literal|3
expr_stmt|;
block|}
block|}
else|else
block|{
name|rowcnt
operator|=
name|rowsize
operator|-
literal|3
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
name|width
operator|-
literal|1
init|;
name|xcnt
operator|>=
literal|0
condition|;
name|xcnt
operator|--
control|)
block|{
comment|/* Same as above but in the other direction */
comment|/* ======================================== */
name|or
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
index|]
expr_stmt|;
name|og
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|1
index|]
expr_stmt|;
name|ob
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|2
index|]
expr_stmt|;
name|or
operator|=
name|or
operator|+
operator|(
name|row1
index|[
name|rowcnt
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|or
operator|>
literal|255
condition|)
name|or
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|or
operator|<
literal|0
condition|)
name|or
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|og
operator|>
literal|255
condition|)
name|og
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|og
operator|<
literal|0
condition|)
name|og
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ob
operator|>
literal|255
condition|)
name|ob
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|ob
operator|<
literal|0
condition|)
name|ob
operator|=
literal|0
expr_stmt|;
name|dr
operator|=
name|or
operator|-
operator|(
name|or
operator|&
name|rmask
operator|)
expr_stmt|;
name|dg
operator|=
name|og
operator|-
operator|(
name|og
operator|&
name|gmask
operator|)
expr_stmt|;
name|db
operator|=
name|ob
operator|-
operator|(
name|ob
operator|&
name|bmask
operator|)
expr_stmt|;
if|if
condition|(
name|xcnt
operator|>
literal|0
condition|)
block|{
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
if|if
condition|(
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xcnt
operator|<
name|width
operator|-
literal|1
operator|&&
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
name|row2
index|[
name|rowcnt
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
name|row1
index|[
name|rowcnt
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|or
operator|=
name|or
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|or
operator|=
name|or
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|og
operator|=
name|og
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|ob
operator|=
name|ob
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|pixel
operator|=
name|pixel
operator||
name|or
operator||
name|og
operator||
name|ob
expr_stmt|;
name|imagedata
index|[
name|xcnt
index|]
operator|=
name|pixel
expr_stmt|;
name|rowcnt
operator|-=
literal|3
expr_stmt|;
block|}
block|}
comment|/* We're finished with this row, swap row-pointers */
comment|/* =============================================== */
name|temp
operator|=
name|row1
expr_stmt|;
name|row1
operator|=
name|row2
expr_stmt|;
name|row2
operator|=
name|temp
expr_stmt|;
name|imagedata
operator|+=
name|width
operator|+
name|diffx
expr_stmt|;
name|count
operator|+=
name|rowsize
expr_stmt|;
block|}
name|g_free
argument_list|(
name|row1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|row2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image16 (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image16
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guint16
modifier|*
name|imagedata
decl_stmt|,
name|pixel
decl_stmt|,
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guint16
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
if|if
condition|(
name|xcnt
operator|<=
name|image
operator|->
name|width
operator|&&
name|ycnt
operator|<=
name|image
operator|->
name|height
condition|)
block|{
name|pixel
operator|=
literal|0
expr_stmt|;
name|r
operator|=
operator|(
operator|(
name|guint16
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|g
operator|=
operator|(
operator|(
name|guint16
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|b
operator|=
operator|(
operator|(
name|guint16
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|r
operator|=
name|r
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|g
operator|=
name|g
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|b
operator|=
name|b
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|pixel
operator|=
name|pixel
operator||
name|r
operator||
name|g
operator||
name|b
expr_stmt|;
operator|*
name|imagedata
operator|=
name|pixel
expr_stmt|;
name|imagedata
operator|++
expr_stmt|;
block|}
block|}
name|imagedata
operator|+=
name|diffx
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/************************/
end_comment

begin_comment
comment|/* RGB to RGB (sic!) :) */
end_comment

begin_comment
comment|/************************/
end_comment

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color24 (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color24
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
specifier|static
name|GdkColor
name|color
decl_stmt|;
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|<<
literal|16
operator|)
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
expr_stmt|;
name|color
operator|.
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
operator|&
name|color
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image24 (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image24
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guchar
modifier|*
name|imagedata
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|,
name|count2
init|=
literal|0
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
literal|3
operator|*
operator|(
name|image
operator|->
name|width
operator|-
name|width
operator|)
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guchar
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|height
condition|;
name|xcnt
operator|++
control|)
block|{
if|if
condition|(
name|xcnt
operator|<
name|image
operator|->
name|width
operator|&&
name|ycnt
operator|<
name|image
operator|->
name|height
condition|)
block|{
name|imagedata
index|[
name|count2
operator|++
index|]
operator|=
name|RGB_data
index|[
name|count
operator|+
literal|2
index|]
expr_stmt|;
name|imagedata
index|[
name|count2
operator|++
index|]
operator|=
name|RGB_data
index|[
name|count
operator|+
literal|1
index|]
expr_stmt|;
name|imagedata
index|[
name|count2
operator|++
index|]
operator|=
name|RGB_data
index|[
name|count
index|]
expr_stmt|;
block|}
name|count
operator|+=
literal|3
expr_stmt|;
block|}
name|count2
operator|+=
name|diffx
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************/
end_comment

begin_comment
comment|/* RGB to RGBX */
end_comment

begin_comment
comment|/***************/
end_comment

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color32 (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color32
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
specifier|static
name|GdkColor
name|color
decl_stmt|;
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|<<
literal|16
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
operator|<<
literal|24
expr_stmt|;
name|color
operator|.
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
operator|&
name|color
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image32 (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image32
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guint32
modifier|*
name|imagedata
decl_stmt|,
name|pixel
decl_stmt|,
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
init|=
literal|0
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guint32
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
if|if
condition|(
name|xcnt
operator|<
name|image
operator|->
name|width
operator|&&
name|ycnt
operator|<
name|image
operator|->
name|height
condition|)
block|{
name|r
operator|=
operator|(
name|guint32
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
expr_stmt|;
name|g
operator|=
operator|(
name|guint32
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
expr_stmt|;
name|b
operator|=
operator|(
name|guint32
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
expr_stmt|;
comment|/* changed to work on 32 bit displays */
name|r
operator|=
name|r
operator|<<
literal|16
expr_stmt|;
name|g
operator|=
name|g
operator|<<
literal|8
expr_stmt|;
name|b
operator|=
name|b
expr_stmt|;
name|pixel
operator|=
name|r
operator||
name|g
operator||
name|b
expr_stmt|;
operator|*
name|imagedata
operator|=
name|pixel
expr_stmt|;
name|imagedata
operator|++
expr_stmt|;
block|}
block|}
name|imagedata
operator|+=
name|diffx
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**************************/
end_comment

begin_comment
comment|/* Conversion dispatchers */
end_comment

begin_comment
comment|/**************************/
end_comment

begin_function
DECL|function|gck_rgb_to_gdkimage (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|void
name|gck_rgb_to_gdkimage
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_PSEUDO_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|8
condition|)
block|{
comment|/* Standard 256 color display */
comment|/* ========================== */
if|if
condition|(
name|visinfo
operator|->
name|dithermethod
operator|==
name|DITHER_NONE
condition|)
name|gck_rgb_to_image8
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|dithermethod
operator|==
name|DITHER_FLOYD_STEINBERG
condition|)
name|gck_rgb_to_image8_fs_dither
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_TRUE_COLOR
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_DIRECT_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|15
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|16
condition|)
block|{
comment|/* HiColor modes */
comment|/* ============= */
if|if
condition|(
name|visinfo
operator|->
name|dithermethod
operator|==
name|DITHER_NONE
condition|)
name|gck_rgb_to_image16
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|dithermethod
operator|==
name|DITHER_FLOYD_STEINBERG
condition|)
name|gck_rgb_to_image16_fs_dither
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|24
operator|&&
name|image
operator|->
name|bpp
operator|==
literal|3
condition|)
block|{
comment|/* Packed 24 bit mode */
comment|/* ================== */
name|gck_rgb_to_image24
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|32
operator|||
operator|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|24
operator|&&
name|image
operator|->
name|bpp
operator|==
literal|4
operator|)
condition|)
block|{
comment|/* 32 bpp mode */
comment|/* =========== */
name|gck_rgb_to_image32
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_gdkcolor (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_gdkcolor
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|GdkColor
modifier|*
name|color
init|=
name|NULL
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_PSEUDO_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|8
condition|)
block|{
comment|/* Standard 256 color display */
comment|/* ========================== */
name|color
operator|=
name|gck_rgb_to_color8
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_TRUE_COLOR
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_DIRECT_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|15
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|16
condition|)
block|{
comment|/* HiColor modes */
comment|/* ============= */
name|color
operator|=
name|gck_rgb_to_color16
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|24
condition|)
block|{
comment|/* Normal 24 bit mode */
comment|/* ================== */
name|color
operator|=
name|gck_rgb_to_color24
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|32
condition|)
block|{
comment|/* 32 bpp mode */
comment|/* =========== */
name|color
operator|=
name|gck_rgb_to_color32
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|color
operator|)
return|;
block|}
end_function

end_unit

