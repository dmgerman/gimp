begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***************************************************************************/
end_comment

begin_comment
comment|/* GCK - The General Convenience Kit. Generally useful conveniece routines */
end_comment

begin_comment
comment|/* for GIMP plug-in writers and users of the GDK/GTK libraries.            */
end_comment

begin_comment
comment|/* Copyright (C) 1996 Tom Bech                                             */
end_comment

begin_comment
comment|/*                                                                         */
end_comment

begin_comment
comment|/* This program is free software; you can redistribute it and/or modify    */
end_comment

begin_comment
comment|/* it under the terms of the GNU General Public License as published by    */
end_comment

begin_comment
comment|/* the Free Software Foundation; either version 2 of the License, or       */
end_comment

begin_comment
comment|/* (at your option) any later version.                                     */
end_comment

begin_comment
comment|/*                                                                         */
end_comment

begin_comment
comment|/* This program is distributed in the hope that it will be useful,         */
end_comment

begin_comment
comment|/* but WITHOUT ANY WARRANTY; without even the implied warranty of          */
end_comment

begin_comment
comment|/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           */
end_comment

begin_comment
comment|/* GNU General Public License for more details.                            */
end_comment

begin_comment
comment|/*                                                                         */
end_comment

begin_comment
comment|/* You should have received a copy of the GNU General Public License       */
end_comment

begin_comment
comment|/* along with this program; if not, write to the Free Software             */
end_comment

begin_comment
comment|/* Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307,   */
end_comment

begin_comment
comment|/* USA.                                                                    */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_comment
comment|/*************************************************************/
end_comment

begin_comment
comment|/* This file contains routines for creating and setting up   */
end_comment

begin_comment
comment|/* visuals. There's also routines for converting RGB(A) data */
end_comment

begin_comment
comment|/* to whatever format the current visual is.                 */
end_comment

begin_comment
comment|/*************************************************************/
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<glib.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpmath.h"
end_include

begin_include
include|#
directive|include
file|"gck.h"
end_include

begin_define
DECL|macro|RESERVED_COLORS
define|#
directive|define
name|RESERVED_COLORS
value|2
end_define

begin_define
DECL|macro|ROUND_TO_INT (val)
define|#
directive|define
name|ROUND_TO_INT
parameter_list|(
name|val
parameter_list|)
value|((val) + 0.5)
end_define

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9518ca0108
block|{
DECL|member|ready
name|guchar
name|ready
decl_stmt|;
DECL|member|color
name|GckRGB
name|color
decl_stmt|;
DECL|typedef|_GckSampleType
block|}
name|_GckSampleType
typedef|;
end_typedef

begin_comment
comment|/* returns a static storage */
end_comment

begin_function_decl
specifier|static
name|GdkColor
modifier|*
name|gck_rgb_to_gdkcolor
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* returns a malloc'ed area */
end_comment

begin_function_decl
specifier|static
name|GdkColor
modifier|*
name|gck_rgb_to_gdkcolor_r
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************/
end_comment

begin_comment
comment|/* Implementation */
end_comment

begin_comment
comment|/******************/
end_comment

begin_comment
comment|/********************************************************/
end_comment

begin_comment
comment|/* This routine tries to allocate a biggest possible    */
end_comment

begin_comment
comment|/* color cube (used only on 8 bit pseudo color visuals) */
end_comment

begin_comment
comment|/* Shamelessly ripped from colormaps.c by S&P.          */
end_comment

begin_comment
comment|/* I'm not sure if I'm going to use this or not.        */
end_comment

begin_comment
comment|/********************************************************/
end_comment

begin_function
DECL|function|gck_allocate_color_cube (GckVisualInfo * visinfo,int red,int green,int blue)
name|int
name|gck_allocate_color_cube
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|int
name|red
parameter_list|,
name|int
name|green
parameter_list|,
name|int
name|blue
parameter_list|)
block|{
name|int
name|init_r
decl_stmt|,
name|init_g
decl_stmt|,
name|init_b
decl_stmt|;
name|int
name|total
decl_stmt|;
name|int
name|success
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|init_r
operator|=
name|red
expr_stmt|;
name|init_g
operator|=
name|green
expr_stmt|;
name|init_b
operator|=
name|blue
expr_stmt|;
comment|/* First, reduce number of total colors to fit a 8 bit LUT */
comment|/* ======================================================= */
name|total
operator|=
name|red
operator|*
name|green
operator|*
name|blue
operator|+
name|RESERVED_COLORS
expr_stmt|;
while|while
condition|(
name|total
operator|>
literal|256
condition|)
block|{
if|if
condition|(
name|blue
operator|>=
name|red
operator|&&
name|blue
operator|>=
name|green
condition|)
name|blue
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|red
operator|>=
name|green
operator|&&
name|red
operator|>=
name|blue
condition|)
name|red
operator|--
expr_stmt|;
else|else
name|green
operator|--
expr_stmt|;
name|total
operator|=
name|red
operator|*
name|green
operator|*
name|blue
operator|+
name|RESERVED_COLORS
expr_stmt|;
block|}
comment|/* Now, attempt to allocate the colors. If no success, reduce the */
comment|/* color cube resolution and try again.                           */
comment|/* ============================================================== */
name|success
operator|=
name|gdk_colors_alloc
argument_list|(
name|visinfo
operator|->
name|colormap
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|visinfo
operator|->
name|allocedpixels
argument_list|,
name|total
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|success
condition|)
block|{
if|if
condition|(
name|blue
operator|>=
name|red
operator|&&
name|blue
operator|>=
name|green
condition|)
name|blue
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|red
operator|>=
name|green
operator|&&
name|red
operator|>=
name|blue
condition|)
name|red
operator|--
expr_stmt|;
else|else
name|green
operator|--
expr_stmt|;
name|total
operator|=
name|red
operator|*
name|green
operator|*
name|blue
operator|+
name|RESERVED_COLORS
expr_stmt|;
if|if
condition|(
name|red
operator|<=
literal|2
operator|||
name|green
operator|<=
literal|2
operator|||
name|blue
operator|<=
literal|2
condition|)
name|success
operator|=
literal|1
expr_stmt|;
else|else
name|success
operator|=
name|gdk_colors_alloc
argument_list|(
name|visinfo
operator|->
name|colormap
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|visinfo
operator|->
name|allocedpixels
argument_list|,
name|total
argument_list|)
expr_stmt|;
block|}
comment|/* If any shades value has been reduced to nothing, return error flag */
comment|/* ================================================================== */
if|if
condition|(
name|red
operator|>
literal|1
operator|&&
name|green
operator|>
literal|1
operator|&&
name|blue
operator|>
literal|1
condition|)
block|{
name|success
operator|=
name|TRUE
expr_stmt|;
name|visinfo
operator|->
name|shades_r
operator|=
name|red
expr_stmt|;
name|visinfo
operator|->
name|shades_g
operator|=
name|green
expr_stmt|;
name|visinfo
operator|->
name|shades_b
operator|=
name|blue
expr_stmt|;
name|visinfo
operator|->
name|numcolors
operator|=
name|total
expr_stmt|;
block|}
else|else
name|success
operator|=
name|FALSE
expr_stmt|;
return|return
operator|(
name|success
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************/
end_comment

begin_comment
comment|/* Create 8 bit RGB color cube. Also more or less */
end_comment

begin_comment
comment|/* ripped from colormaps.c by S&P.                */
end_comment

begin_comment
comment|/**************************************************/
end_comment

begin_function
DECL|function|gck_create_8bit_rgb (GckVisualInfo * visinfo)
name|void
name|gck_create_8bit_rgb
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|)
block|{
name|unsigned
name|int
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|unsigned
name|int
name|dr
decl_stmt|,
name|dg
decl_stmt|,
name|db
decl_stmt|;
name|int
name|i
init|=
name|RESERVED_COLORS
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dr
operator|=
operator|(
name|visinfo
operator|->
name|shades_r
operator|>
literal|1
operator|)
condition|?
operator|(
name|visinfo
operator|->
name|shades_r
operator|-
literal|1
operator|)
else|:
operator|(
literal|1
operator|)
expr_stmt|;
name|dg
operator|=
operator|(
name|visinfo
operator|->
name|shades_g
operator|>
literal|1
operator|)
condition|?
operator|(
name|visinfo
operator|->
name|shades_g
operator|-
literal|1
operator|)
else|:
operator|(
literal|1
operator|)
expr_stmt|;
name|db
operator|=
operator|(
name|visinfo
operator|->
name|shades_b
operator|>
literal|1
operator|)
condition|?
operator|(
name|visinfo
operator|->
name|shades_b
operator|-
literal|1
operator|)
else|:
operator|(
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|r
operator|=
literal|0
init|;
name|r
operator|<
name|visinfo
operator|->
name|shades_r
condition|;
name|r
operator|++
control|)
for|for
control|(
name|g
operator|=
literal|0
init|;
name|g
operator|<
name|visinfo
operator|->
name|shades_g
condition|;
name|g
operator|++
control|)
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|visinfo
operator|->
name|shades_b
condition|;
name|b
operator|++
control|)
block|{
name|visinfo
operator|->
name|colorcube
index|[
name|i
index|]
operator|=
name|visinfo
operator|->
name|allocedpixels
index|[
name|i
index|]
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
name|i
index|]
operator|.
name|red
operator|=
operator|(
name|guint
operator|)
name|ROUND_TO_INT
argument_list|(
literal|255.0
operator|*
call|(
name|double
call|)
argument_list|(
name|r
operator|*
name|visinfo
operator|->
name|visual
operator|->
name|colormap_size
argument_list|)
operator|/
operator|(
name|double
operator|)
name|dr
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
name|i
index|]
operator|.
name|green
operator|=
operator|(
name|guint
operator|)
name|ROUND_TO_INT
argument_list|(
literal|255.0
operator|*
call|(
name|double
call|)
argument_list|(
name|g
operator|*
name|visinfo
operator|->
name|visual
operator|->
name|colormap_size
argument_list|)
operator|/
operator|(
name|double
operator|)
name|dg
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
name|i
index|]
operator|.
name|blue
operator|=
operator|(
name|guint
operator|)
name|ROUND_TO_INT
argument_list|(
literal|255.0
operator|*
call|(
name|double
call|)
argument_list|(
name|b
operator|*
name|visinfo
operator|->
name|visual
operator|->
name|colormap_size
argument_list|)
operator|/
operator|(
name|double
operator|)
name|db
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
name|i
index|]
operator|.
name|pixel
operator|=
name|visinfo
operator|->
name|allocedpixels
index|[
name|i
index|]
expr_stmt|;
name|visinfo
operator|->
name|indextab
index|[
name|r
index|]
index|[
name|g
index|]
index|[
name|b
index|]
operator|=
operator|(
name|guchar
operator|)
name|visinfo
operator|->
name|allocedpixels
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
comment|/* Set up mapping tables */
comment|/* ===================== */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|visinfo
operator|->
name|map_r
index|[
name|i
index|]
operator|=
operator|(
name|int
operator|)
name|ROUND_TO_INT
argument_list|(
operator|(
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_r
operator|-
literal|1
argument_list|)
operator|*
operator|(
operator|(
name|double
operator|)
name|i
operator|/
literal|255.0
operator|)
operator|)
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|map_g
index|[
name|i
index|]
operator|=
operator|(
name|int
operator|)
name|ROUND_TO_INT
argument_list|(
operator|(
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_g
operator|-
literal|1
argument_list|)
operator|*
operator|(
operator|(
name|double
operator|)
name|i
operator|/
literal|255.0
operator|)
operator|)
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|map_b
index|[
name|i
index|]
operator|=
operator|(
name|int
operator|)
name|ROUND_TO_INT
argument_list|(
operator|(
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_b
operator|-
literal|1
argument_list|)
operator|*
operator|(
operator|(
name|double
operator|)
name|i
operator|/
literal|255.0
operator|)
operator|)
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|invmap_r
index|[
name|i
index|]
operator|=
operator|(
name|double
operator|)
name|visinfo
operator|->
name|map_r
index|[
name|i
index|]
operator|*
operator|(
literal|255.0
operator|/
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_r
operator|-
literal|1
argument_list|)
operator|)
expr_stmt|;
name|visinfo
operator|->
name|invmap_g
index|[
name|i
index|]
operator|=
operator|(
name|double
operator|)
name|visinfo
operator|->
name|map_g
index|[
name|i
index|]
operator|*
operator|(
literal|255.0
operator|/
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_g
operator|-
literal|1
argument_list|)
operator|)
expr_stmt|;
name|visinfo
operator|->
name|invmap_b
index|[
name|i
index|]
operator|=
operator|(
name|double
operator|)
name|visinfo
operator|->
name|map_b
index|[
name|i
index|]
operator|*
operator|(
literal|255.0
operator|/
call|(
name|double
call|)
argument_list|(
name|visinfo
operator|->
name|shades_b
operator|-
literal|1
argument_list|)
operator|)
expr_stmt|;
block|}
comment|/* Create reserved colors */
comment|/* ====================== */
name|visinfo
operator|->
name|rgbpalette
index|[
literal|0
index|]
operator|.
name|red
operator|=
literal|0
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|0
index|]
operator|.
name|green
operator|=
literal|0
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|0
index|]
operator|.
name|blue
operator|=
literal|0
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|0
index|]
operator|.
name|pixel
operator|=
name|visinfo
operator|->
name|allocedpixels
index|[
literal|0
index|]
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|1
index|]
operator|.
name|red
operator|=
literal|65535
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|1
index|]
operator|.
name|green
operator|=
literal|65535
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|1
index|]
operator|.
name|blue
operator|=
literal|65535
expr_stmt|;
name|visinfo
operator|->
name|rgbpalette
index|[
literal|1
index|]
operator|.
name|pixel
operator|=
name|visinfo
operator|->
name|allocedpixels
index|[
literal|1
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************/
end_comment

begin_comment
comment|/* Get visual and create colormap */
end_comment

begin_comment
comment|/**********************************/
end_comment

begin_function
DECL|function|gck_visualinfo_new (void)
name|GckVisualInfo
modifier|*
name|gck_visualinfo_new
parameter_list|(
name|void
parameter_list|)
block|{
name|GckVisualInfo
modifier|*
name|visinfo
decl_stmt|;
name|visinfo
operator|=
operator|(
name|GckVisualInfo
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|GckVisualInfo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|visinfo
operator|!=
name|NULL
condition|)
block|{
name|visinfo
operator|->
name|visual
operator|=
name|gdk_visual_get_best
argument_list|()
expr_stmt|;
name|visinfo
operator|->
name|colormap
operator|=
name|gdk_colormap_new
argument_list|(
name|visinfo
operator|->
name|visual
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|dithermethod
operator|=
name|DITHER_FLOYD_STEINBERG
expr_stmt|;
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_PSEUDO_COLOR
condition|)
block|{
comment|/* Allocate colormap and create RGB map */
comment|/* ==================================== */
if|if
condition|(
name|gck_allocate_color_cube
argument_list|(
name|visinfo
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|gck_create_8bit_rgb
argument_list|(
name|visinfo
argument_list|)
expr_stmt|;
name|gdk_colors_store
argument_list|(
name|visinfo
operator|->
name|colormap
argument_list|,
name|visinfo
operator|->
name|rgbpalette
argument_list|,
name|visinfo
operator|->
name|numcolors
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|g_free
argument_list|(
name|visinfo
argument_list|)
expr_stmt|;
name|visinfo
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|visinfo
operator|)
return|;
block|}
end_function

begin_comment
comment|/***********************************************************/
end_comment

begin_comment
comment|/* Free memory associated with the GckVisualInfo structure */
end_comment

begin_comment
comment|/***********************************************************/
end_comment

begin_function
DECL|function|gck_visualinfo_destroy (GckVisualInfo * visinfo)
name|void
name|gck_visualinfo_destroy
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|gdk_colormap_unref
argument_list|(
name|visinfo
operator|->
name|colormap
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|visinfo
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* This converts from TrueColor RGB (24bpp) to   */
end_comment

begin_comment
comment|/* whatever format the visual of our image uses. */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
DECL|function|gck_visualinfo_get_dither (GckVisualInfo * visinfo)
name|GckDitherType
name|gck_visualinfo_get_dither
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|visinfo
operator|->
name|dithermethod
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_visualinfo_set_dither (GckVisualInfo * visinfo,GckDitherType method)
name|void
name|gck_visualinfo_set_dither
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|GckDitherType
name|method
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|visinfo
operator|->
name|dithermethod
operator|=
name|method
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************/
end_comment

begin_comment
comment|/* GdkGC functions */
end_comment

begin_comment
comment|/*******************/
end_comment

begin_function
DECL|function|gck_gc_set_foreground (GckVisualInfo * visinfo,GdkGC * gc,guchar r,guchar g,guchar b)
name|void
name|gck_gc_set_foreground
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|GdkGC
modifier|*
name|gc
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|gc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|gdk_gc_set_foreground
argument_list|(
name|gc
argument_list|,
name|gck_rgb_to_gdkcolor
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_gc_set_background (GckVisualInfo * visinfo,GdkGC * gc,guchar r,guchar g,guchar b)
name|void
name|gck_gc_set_background
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|GdkGC
modifier|*
name|gc
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|gc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|gdk_gc_set_background
argument_list|(
name|gc
argument_list|,
name|gck_rgb_to_gdkcolor
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* RGB to 8 bpp pseudocolor (indexed) functions. */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color8 (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color8
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
specifier|static
name|GdkColor
name|color
decl_stmt|;
name|gint
name|index
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|r
operator|=
name|visinfo
operator|->
name|map_r
index|[
name|r
index|]
expr_stmt|;
name|g
operator|=
name|visinfo
operator|->
name|map_g
index|[
name|g
index|]
expr_stmt|;
name|b
operator|=
name|visinfo
operator|->
name|map_b
index|[
name|b
index|]
expr_stmt|;
name|index
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|r
index|]
index|[
name|g
index|]
index|[
name|b
index|]
expr_stmt|;
name|color
operator|=
name|visinfo
operator|->
name|rgbpalette
index|[
name|index
index|]
expr_stmt|;
return|return
operator|(
operator|&
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reentrant function - GdkColor will be malloc'ed  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color8_r (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color8_r
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|gint
name|index
decl_stmt|;
name|GdkColor
modifier|*
name|color
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|=
operator|(
name|GdkColor
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|GdkColor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|color
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|r
operator|=
name|visinfo
operator|->
name|map_r
index|[
name|r
index|]
expr_stmt|;
name|g
operator|=
name|visinfo
operator|->
name|map_g
index|[
name|g
index|]
expr_stmt|;
name|b
operator|=
name|visinfo
operator|->
name|map_b
index|[
name|b
index|]
expr_stmt|;
name|index
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|r
index|]
index|[
name|g
index|]
index|[
name|b
index|]
expr_stmt|;
operator|*
name|color
operator|=
name|visinfo
operator|->
name|rgbpalette
index|[
name|index
index|]
expr_stmt|;
return|return
operator|(
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************/
end_comment

begin_comment
comment|/* RGB to 8 bpp pseudocolor using error-diffusion  */
end_comment

begin_comment
comment|/* dithering using the weights proposed by Floyd   */
end_comment

begin_comment
comment|/* and Steinberg (aka "Floyd-Steinberg dithering") */
end_comment

begin_comment
comment|/***************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image8_fs_dither (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image8_fs_dither
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guchar
modifier|*
name|imagedata
decl_stmt|;
name|gint
name|or
decl_stmt|,
name|og
decl_stmt|,
name|ob
decl_stmt|,
name|mr
decl_stmt|,
name|mg
decl_stmt|,
name|mb
decl_stmt|,
name|dr
decl_stmt|,
name|dg
decl_stmt|,
name|db
decl_stmt|;
name|gint
modifier|*
name|row1
decl_stmt|,
modifier|*
name|row2
decl_stmt|,
modifier|*
name|temp
decl_stmt|,
name|rowcnt
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|,
name|rowsize
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Allocate memory for FS errors */
comment|/* ============================= */
name|rowsize
operator|=
literal|3
operator|*
name|width
expr_stmt|;
name|row1
operator|=
operator|(
name|gint
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
operator|(
name|size_t
operator|)
name|rowsize
argument_list|)
expr_stmt|;
name|row2
operator|=
operator|(
name|gint
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
operator|(
name|size_t
operator|)
name|rowsize
argument_list|)
expr_stmt|;
comment|/* Initialize to zero */
comment|/* ================== */
name|memset
argument_list|(
name|row1
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|row2
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|gint
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|width
operator|<
name|width
condition|)
name|width
operator|=
name|image
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|height
operator|<
name|height
condition|)
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guchar
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
comment|/* It's rec. to move from left to right on even  */
comment|/* rows and right to left on odd rows, so we do. */
comment|/* ============================================= */
if|if
condition|(
operator|(
name|ycnt
operator|%
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|rowcnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
comment|/* Get exact (original) value */
comment|/* ========================== */
name|or
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
index|]
expr_stmt|;
name|og
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|1
index|]
expr_stmt|;
name|ob
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|2
index|]
expr_stmt|;
comment|/* Extract and add the accumulated error for this pixel */
comment|/* ==================================================== */
name|or
operator|=
name|or
operator|+
operator|(
name|row1
index|[
name|rowcnt
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
comment|/* Make sure we don't run into an under- or overflow */
comment|/* ================================================= */
if|if
condition|(
name|or
operator|>
literal|255
condition|)
name|or
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|or
operator|<
literal|0
condition|)
name|or
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|og
operator|>
literal|255
condition|)
name|og
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|og
operator|<
literal|0
condition|)
name|og
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ob
operator|>
literal|255
condition|)
name|ob
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|ob
operator|<
literal|0
condition|)
name|ob
operator|=
literal|0
expr_stmt|;
comment|/* Compute difference */
comment|/* ================== */
name|dr
operator|=
name|or
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_r
index|[
name|or
index|]
expr_stmt|;
name|dg
operator|=
name|og
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_g
index|[
name|og
index|]
expr_stmt|;
name|db
operator|=
name|ob
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_b
index|[
name|ob
index|]
expr_stmt|;
comment|/* Spread the error to the neighboring pixels.    */
comment|/* We use the weights proposed by Floyd-Steinberg */
comment|/* for 3x3 neighborhoods (1*, 3*, 5* and 7*1/16). */
comment|/* ============================================== */
if|if
condition|(
name|xcnt
operator|<
name|width
operator|-
literal|1
condition|)
block|{
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
if|if
condition|(
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xcnt
operator|>
literal|0
operator|&&
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
name|row2
index|[
name|rowcnt
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
comment|/* Clear the errorvalues of the processed row */
comment|/* ========================================== */
name|row1
index|[
name|rowcnt
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Map RGB values to color cube and write pixel */
comment|/* ============================================ */
name|mr
operator|=
name|visinfo
operator|->
name|map_r
index|[
operator|(
name|guchar
operator|)
name|or
index|]
expr_stmt|;
name|mg
operator|=
name|visinfo
operator|->
name|map_g
index|[
operator|(
name|guchar
operator|)
name|og
index|]
expr_stmt|;
name|mb
operator|=
name|visinfo
operator|->
name|map_b
index|[
operator|(
name|guchar
operator|)
name|ob
index|]
expr_stmt|;
name|imagedata
index|[
name|xcnt
index|]
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|mr
index|]
index|[
name|mg
index|]
index|[
name|mb
index|]
expr_stmt|;
name|rowcnt
operator|+=
literal|3
expr_stmt|;
block|}
block|}
else|else
block|{
name|rowcnt
operator|=
name|rowsize
operator|-
literal|3
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
name|width
operator|-
literal|1
init|;
name|xcnt
operator|>=
literal|0
condition|;
name|xcnt
operator|--
control|)
block|{
comment|/* Same as above but in the other direction */
comment|/* ======================================== */
name|or
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
index|]
expr_stmt|;
name|og
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|1
index|]
expr_stmt|;
name|ob
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|2
index|]
expr_stmt|;
name|or
operator|=
name|or
operator|+
operator|(
name|row1
index|[
name|rowcnt
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|or
operator|>
literal|255
condition|)
name|or
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|or
operator|<
literal|0
condition|)
name|or
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|og
operator|>
literal|255
condition|)
name|og
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|og
operator|<
literal|0
condition|)
name|og
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ob
operator|>
literal|255
condition|)
name|ob
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|ob
operator|<
literal|0
condition|)
name|ob
operator|=
literal|0
expr_stmt|;
name|dr
operator|=
name|or
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_r
index|[
name|or
index|]
expr_stmt|;
name|dg
operator|=
name|og
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_g
index|[
name|og
index|]
expr_stmt|;
name|db
operator|=
name|ob
operator|-
operator|(
name|gint
operator|)
name|visinfo
operator|->
name|invmap_b
index|[
name|ob
index|]
expr_stmt|;
if|if
condition|(
name|xcnt
operator|>
literal|0
condition|)
block|{
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
if|if
condition|(
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xcnt
operator|<
name|width
operator|-
literal|1
operator|&&
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
name|row2
index|[
name|rowcnt
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
name|row1
index|[
name|rowcnt
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|mr
operator|=
name|visinfo
operator|->
name|map_r
index|[
operator|(
name|guchar
operator|)
name|or
index|]
expr_stmt|;
name|mg
operator|=
name|visinfo
operator|->
name|map_g
index|[
operator|(
name|guchar
operator|)
name|og
index|]
expr_stmt|;
name|mb
operator|=
name|visinfo
operator|->
name|map_b
index|[
operator|(
name|guchar
operator|)
name|ob
index|]
expr_stmt|;
name|imagedata
index|[
name|xcnt
index|]
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|mr
index|]
index|[
name|mg
index|]
index|[
name|mb
index|]
expr_stmt|;
name|rowcnt
operator|-=
literal|3
expr_stmt|;
block|}
block|}
comment|/* We're finished with this row, swap row-pointers */
comment|/* =============================================== */
name|temp
operator|=
name|row1
expr_stmt|;
name|row1
operator|=
name|row2
expr_stmt|;
name|row2
operator|=
name|temp
expr_stmt|;
name|imagedata
operator|+=
name|width
operator|+
name|diffx
expr_stmt|;
name|count
operator|+=
name|rowsize
expr_stmt|;
block|}
name|g_free
argument_list|(
name|row1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|row2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***********************************************************/
end_comment

begin_comment
comment|/* Plain (no dithering) RGB to 8 bpp pseudocolor (indexed) */
end_comment

begin_comment
comment|/***********************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image8 (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image8
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guchar
modifier|*
name|imagedata
decl_stmt|,
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guchar
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
if|if
condition|(
name|xcnt
operator|<
name|image
operator|->
name|width
operator|&&
name|ycnt
operator|<
name|image
operator|->
name|height
condition|)
block|{
name|r
operator|=
name|RGB_data
index|[
name|count
index|]
expr_stmt|;
name|g
operator|=
name|RGB_data
index|[
name|count
operator|+
literal|1
index|]
expr_stmt|;
name|b
operator|=
name|RGB_data
index|[
name|count
operator|+
literal|2
index|]
expr_stmt|;
name|r
operator|=
name|visinfo
operator|->
name|map_r
index|[
name|r
index|]
expr_stmt|;
name|g
operator|=
name|visinfo
operator|->
name|map_g
index|[
name|g
index|]
expr_stmt|;
name|b
operator|=
name|visinfo
operator|->
name|map_b
index|[
name|b
index|]
expr_stmt|;
operator|*
name|imagedata
operator|=
name|visinfo
operator|->
name|indextab
index|[
name|r
index|]
index|[
name|g
index|]
index|[
name|b
index|]
expr_stmt|;
name|imagedata
operator|++
expr_stmt|;
block|}
name|count
operator|+=
literal|3
expr_stmt|;
block|}
name|imagedata
operator|+=
name|diffx
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/************************************/
end_comment

begin_comment
comment|/* RGB to 16/15 bpp RGB ("HiColor") */
end_comment

begin_comment
comment|/************************************/
end_comment

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color16 (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color16
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
specifier|static
name|GdkColor
name|color
decl_stmt|;
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|red
operator|=
name|red
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|green
operator|=
name|green
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|blue
operator|=
name|blue
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|color
operator|.
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
operator|&
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reentrant function - GdkColor will be malloc'ed  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color16_r (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color16_r
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|GdkColor
modifier|*
name|color
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|=
operator|(
name|GdkColor
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|GdkColor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|color
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|color
operator|->
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|->
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|->
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|red
operator|=
name|red
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|green
operator|=
name|green
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|blue
operator|=
name|blue
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|color
operator|->
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************/
end_comment

begin_comment
comment|/* RGB to 16 bpp truecolor using error-diffusion   */
end_comment

begin_comment
comment|/* dithering using the weights proposed by Floyd   */
end_comment

begin_comment
comment|/* and Steinberg (aka "Floyd-Steinberg dithering") */
end_comment

begin_comment
comment|/***************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image16_fs_dither (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image16_fs_dither
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guint16
modifier|*
name|imagedata
decl_stmt|,
name|pixel
decl_stmt|;
name|gint16
name|or
decl_stmt|,
name|og
decl_stmt|,
name|ob
decl_stmt|,
name|dr
decl_stmt|,
name|dg
decl_stmt|,
name|db
decl_stmt|;
name|gint16
modifier|*
name|row1
decl_stmt|,
modifier|*
name|row2
decl_stmt|,
modifier|*
name|temp
decl_stmt|,
name|rowcnt
decl_stmt|,
name|rmask
decl_stmt|,
name|gmask
decl_stmt|,
name|bmask
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|,
name|rowsize
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Allocate memory for FS errors */
comment|/* ============================= */
name|rowsize
operator|=
literal|3
operator|*
name|width
expr_stmt|;
name|row1
operator|=
operator|(
name|gint16
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint16
argument_list|)
operator|*
operator|(
name|size_t
operator|)
name|rowsize
argument_list|)
expr_stmt|;
name|row2
operator|=
operator|(
name|gint16
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gint16
argument_list|)
operator|*
operator|(
name|size_t
operator|)
name|rowsize
argument_list|)
expr_stmt|;
comment|/* Initialize to zero */
comment|/* ================== */
name|memset
argument_list|(
name|row1
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|gint16
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|row2
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|gint16
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|width
operator|<
name|width
condition|)
name|width
operator|=
name|image
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|height
operator|<
name|height
condition|)
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|rmask
operator|=
operator|(
literal|0xff
operator|<<
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
name|gmask
operator|=
operator|(
literal|0xff
operator|<<
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bmask
operator|=
operator|(
literal|0xff
operator|<<
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guint16
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
comment|/* It is rec. to move from left to right on even */
comment|/* rows and right to left on odd rows, so we do. */
comment|/* ============================================= */
if|if
condition|(
operator|(
name|ycnt
operator|%
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|rowcnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
comment|/* Get exact (original) value */
comment|/* ========================== */
name|pixel
operator|=
literal|0
expr_stmt|;
name|or
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
index|]
expr_stmt|;
name|og
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|1
index|]
expr_stmt|;
name|ob
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|2
index|]
expr_stmt|;
comment|/* Extract and add the accumulated error for this pixel */
comment|/* ==================================================== */
name|or
operator|=
name|or
operator|+
operator|(
name|row1
index|[
name|rowcnt
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
comment|/* Make sure we don't run into an under- or overflow */
comment|/* ================================================= */
if|if
condition|(
name|or
operator|>
literal|255
condition|)
name|or
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|or
operator|<
literal|0
condition|)
name|or
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|og
operator|>
literal|255
condition|)
name|og
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|og
operator|<
literal|0
condition|)
name|og
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ob
operator|>
literal|255
condition|)
name|ob
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|ob
operator|<
literal|0
condition|)
name|ob
operator|=
literal|0
expr_stmt|;
comment|/* Compute difference */
comment|/* ================== */
name|dr
operator|=
name|or
operator|-
operator|(
name|or
operator|&
name|rmask
operator|)
expr_stmt|;
name|dg
operator|=
name|og
operator|-
operator|(
name|og
operator|&
name|gmask
operator|)
expr_stmt|;
name|db
operator|=
name|ob
operator|-
operator|(
name|ob
operator|&
name|bmask
operator|)
expr_stmt|;
comment|/* Spread the error to the neighboring pixels.    */
comment|/* We use the weights proposed by Floyd-Steinberg */
comment|/* for 3x3 neighborhoods (1*, 3*, 5* and 7*1/16). */
comment|/* ============================================== */
if|if
condition|(
name|xcnt
operator|<
name|width
operator|-
literal|1
condition|)
block|{
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
if|if
condition|(
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xcnt
operator|>
literal|0
operator|&&
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
name|row2
index|[
name|rowcnt
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
comment|/* Clear the errorvalues of the processed row */
comment|/* ========================================== */
name|row1
index|[
name|rowcnt
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|or
operator|=
name|or
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|or
operator|=
name|or
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|og
operator|=
name|og
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|ob
operator|=
name|ob
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|pixel
operator|=
name|pixel
operator||
name|or
operator||
name|og
operator||
name|ob
expr_stmt|;
name|imagedata
index|[
name|xcnt
index|]
operator|=
name|pixel
expr_stmt|;
name|rowcnt
operator|+=
literal|3
expr_stmt|;
block|}
block|}
else|else
block|{
name|rowcnt
operator|=
name|rowsize
operator|-
literal|3
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
name|width
operator|-
literal|1
init|;
name|xcnt
operator|>=
literal|0
condition|;
name|xcnt
operator|--
control|)
block|{
comment|/* Same as above but in the other direction */
comment|/* ======================================== */
name|or
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
index|]
expr_stmt|;
name|og
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|1
index|]
expr_stmt|;
name|ob
operator|=
operator|(
name|gint
operator|)
name|RGB_data
index|[
name|count
operator|+
name|rowcnt
operator|+
literal|2
index|]
expr_stmt|;
name|or
operator|=
name|or
operator|+
operator|(
name|row1
index|[
name|rowcnt
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|+
operator|(
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|or
operator|>
literal|255
condition|)
name|or
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|or
operator|<
literal|0
condition|)
name|or
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|og
operator|>
literal|255
condition|)
name|og
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|og
operator|<
literal|0
condition|)
name|og
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ob
operator|>
literal|255
condition|)
name|ob
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|ob
operator|<
literal|0
condition|)
name|ob
operator|=
literal|0
expr_stmt|;
name|dr
operator|=
name|or
operator|-
operator|(
name|or
operator|&
name|rmask
operator|)
expr_stmt|;
name|dg
operator|=
name|og
operator|-
operator|(
name|og
operator|&
name|gmask
operator|)
expr_stmt|;
name|db
operator|=
name|ob
operator|-
operator|(
name|ob
operator|&
name|bmask
operator|)
expr_stmt|;
if|if
condition|(
name|xcnt
operator|>
literal|0
condition|)
block|{
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row1
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|7
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
if|if
condition|(
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
index|]
operator|+=
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|-
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xcnt
operator|<
name|width
operator|-
literal|1
operator|&&
name|ycnt
operator|<
name|height
operator|-
literal|1
condition|)
block|{
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|1
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
operator|(
name|rowcnt
operator|+
literal|3
operator|)
operator|+
literal|2
index|]
operator|+=
literal|3
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
name|row2
index|[
name|rowcnt
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dr
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|dg
expr_stmt|;
name|row2
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|+=
literal|5
operator|*
operator|(
name|gint
operator|)
name|db
expr_stmt|;
block|}
name|row1
index|[
name|rowcnt
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|1
index|]
operator|=
name|row1
index|[
name|rowcnt
operator|+
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|or
operator|=
name|or
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|og
operator|=
name|og
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|ob
operator|=
name|ob
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|or
operator|=
name|or
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|og
operator|=
name|og
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|ob
operator|=
name|ob
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|pixel
operator|=
name|pixel
operator||
name|or
operator||
name|og
operator||
name|ob
expr_stmt|;
name|imagedata
index|[
name|xcnt
index|]
operator|=
name|pixel
expr_stmt|;
name|rowcnt
operator|-=
literal|3
expr_stmt|;
block|}
block|}
comment|/* We're finished with this row, swap row-pointers */
comment|/* =============================================== */
name|temp
operator|=
name|row1
expr_stmt|;
name|row1
operator|=
name|row2
expr_stmt|;
name|row2
operator|=
name|temp
expr_stmt|;
name|imagedata
operator|+=
name|width
operator|+
name|diffx
expr_stmt|;
name|count
operator|+=
name|rowsize
expr_stmt|;
block|}
name|g_free
argument_list|(
name|row1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|row2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image16 (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image16
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guint16
modifier|*
name|imagedata
decl_stmt|,
name|pixel
decl_stmt|,
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guint16
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
if|if
condition|(
name|xcnt
operator|<=
name|image
operator|->
name|width
operator|&&
name|ycnt
operator|<=
name|image
operator|->
name|height
condition|)
block|{
name|pixel
operator|=
literal|0
expr_stmt|;
name|r
operator|=
operator|(
operator|(
name|guint16
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|red_prec
operator|)
expr_stmt|;
name|g
operator|=
operator|(
operator|(
name|guint16
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|green_prec
operator|)
expr_stmt|;
name|b
operator|=
operator|(
operator|(
name|guint16
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
operator|)
operator|>>
operator|(
literal|8
operator|-
name|visinfo
operator|->
name|visual
operator|->
name|blue_prec
operator|)
expr_stmt|;
name|r
operator|=
name|r
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|red_shift
expr_stmt|;
name|g
operator|=
name|g
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|green_shift
expr_stmt|;
name|b
operator|=
name|b
operator|<<
name|visinfo
operator|->
name|visual
operator|->
name|blue_shift
expr_stmt|;
name|pixel
operator|=
name|pixel
operator||
name|r
operator||
name|g
operator||
name|b
expr_stmt|;
operator|*
name|imagedata
operator|=
name|pixel
expr_stmt|;
name|imagedata
operator|++
expr_stmt|;
block|}
block|}
name|imagedata
operator|+=
name|diffx
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/************************/
end_comment

begin_comment
comment|/* RGB to RGB (sic!) :) */
end_comment

begin_comment
comment|/************************/
end_comment

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color24 (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color24
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
specifier|static
name|GdkColor
name|color
decl_stmt|;
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|<<
literal|16
operator|)
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
expr_stmt|;
name|color
operator|.
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
operator|&
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reentrant function - GdkColor will be malloc'ed  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color24_r (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color24_r
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|GdkColor
modifier|*
name|color
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|=
operator|(
name|GdkColor
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|GdkColor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|color
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|color
operator|->
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|->
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|->
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|<<
literal|16
operator|)
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
expr_stmt|;
name|color
operator|->
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
name|color
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image24 (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image24
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guchar
modifier|*
name|imagedata
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|,
name|count2
init|=
literal|0
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
literal|3
operator|*
operator|(
name|image
operator|->
name|width
operator|-
name|width
operator|)
expr_stmt|;
else|else
name|diffx
operator|=
literal|0
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guchar
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|height
condition|;
name|xcnt
operator|++
control|)
block|{
if|if
condition|(
name|xcnt
operator|<
name|image
operator|->
name|width
operator|&&
name|ycnt
operator|<
name|image
operator|->
name|height
condition|)
block|{
name|imagedata
index|[
name|count2
operator|++
index|]
operator|=
name|RGB_data
index|[
name|count
operator|+
literal|2
index|]
expr_stmt|;
name|imagedata
index|[
name|count2
operator|++
index|]
operator|=
name|RGB_data
index|[
name|count
operator|+
literal|1
index|]
expr_stmt|;
name|imagedata
index|[
name|count2
operator|++
index|]
operator|=
name|RGB_data
index|[
name|count
index|]
expr_stmt|;
block|}
name|count
operator|+=
literal|3
expr_stmt|;
block|}
name|count2
operator|+=
name|diffx
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************/
end_comment

begin_comment
comment|/* RGB to RGBX */
end_comment

begin_comment
comment|/***************/
end_comment

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color32 (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color32
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
specifier|static
name|GdkColor
name|color
decl_stmt|;
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|.
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|.
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|<<
literal|16
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
operator|<<
literal|24
expr_stmt|;
name|color
operator|.
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
operator|&
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reentrant function - GdkColor will be malloc'ed  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_color32_r (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_color32_r
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|guint32
name|red
decl_stmt|,
name|green
decl_stmt|,
name|blue
decl_stmt|;
name|GdkColor
modifier|*
name|color
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|color
operator|=
operator|(
name|GdkColor
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|GdkColor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|color
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|color
operator|->
name|red
operator|=
operator|(
operator|(
name|guint16
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|->
name|green
operator|=
operator|(
operator|(
name|guint16
operator|)
name|g
operator|)
operator|<<
literal|8
expr_stmt|;
name|color
operator|->
name|blue
operator|=
operator|(
operator|(
name|guint16
operator|)
name|b
operator|)
operator|<<
literal|8
expr_stmt|;
name|red
operator|=
operator|(
operator|(
name|guint32
operator|)
name|r
operator|)
operator|<<
literal|8
expr_stmt|;
name|green
operator|=
operator|(
operator|(
name|guint32
operator|)
name|g
operator|)
operator|<<
literal|16
expr_stmt|;
name|blue
operator|=
operator|(
operator|(
name|guint32
operator|)
name|b
operator|)
operator|<<
literal|24
expr_stmt|;
name|color
operator|->
name|pixel
operator|=
name|red
operator||
name|green
operator||
name|blue
expr_stmt|;
return|return
operator|(
name|color
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gck_rgb_to_image32 (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|gck_rgb_to_image32
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guint32
modifier|*
name|imagedata
decl_stmt|,
name|pixel
decl_stmt|,
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|int
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|diffx
init|=
literal|0
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|<
name|image
operator|->
name|width
condition|)
name|diffx
operator|=
name|image
operator|->
name|width
operator|-
name|width
expr_stmt|;
name|imagedata
operator|=
operator|(
name|guint32
operator|*
operator|)
name|image
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|height
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|width
condition|;
name|xcnt
operator|++
control|)
block|{
if|if
condition|(
name|xcnt
operator|<
name|image
operator|->
name|width
operator|&&
name|ycnt
operator|<
name|image
operator|->
name|height
condition|)
block|{
name|r
operator|=
operator|(
name|guint32
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
expr_stmt|;
name|g
operator|=
operator|(
name|guint32
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
expr_stmt|;
name|b
operator|=
operator|(
name|guint32
operator|)
name|RGB_data
index|[
name|count
operator|++
index|]
expr_stmt|;
comment|/* changed to work on 32 bit displays */
name|r
operator|=
name|r
operator|<<
literal|16
expr_stmt|;
name|g
operator|=
name|g
operator|<<
literal|8
expr_stmt|;
name|b
operator|=
name|b
expr_stmt|;
name|pixel
operator|=
name|r
operator||
name|g
operator||
name|b
expr_stmt|;
operator|*
name|imagedata
operator|=
name|pixel
expr_stmt|;
name|imagedata
operator|++
expr_stmt|;
block|}
block|}
name|imagedata
operator|+=
name|diffx
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**************************/
end_comment

begin_comment
comment|/* Conversion dispatchers */
end_comment

begin_comment
comment|/**************************/
end_comment

begin_function
DECL|function|gck_rgb_to_gdkimage (GckVisualInfo * visinfo,guchar * RGB_data,GdkImage * image,int width,int height)
name|void
name|gck_rgb_to_gdkimage
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
modifier|*
name|RGB_data
parameter_list|,
name|GdkImage
modifier|*
name|image
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|RGB_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|image
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_PSEUDO_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|8
condition|)
block|{
comment|/* Standard 256 color display */
comment|/* ========================== */
if|if
condition|(
name|visinfo
operator|->
name|dithermethod
operator|==
name|DITHER_NONE
condition|)
name|gck_rgb_to_image8
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|dithermethod
operator|==
name|DITHER_FLOYD_STEINBERG
condition|)
name|gck_rgb_to_image8_fs_dither
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_TRUE_COLOR
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_DIRECT_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|15
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|16
condition|)
block|{
comment|/* HiColor modes */
comment|/* ============= */
if|if
condition|(
name|visinfo
operator|->
name|dithermethod
operator|==
name|DITHER_NONE
condition|)
name|gck_rgb_to_image16
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|dithermethod
operator|==
name|DITHER_FLOYD_STEINBERG
condition|)
name|gck_rgb_to_image16_fs_dither
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|24
operator|&&
name|image
operator|->
name|bpp
operator|==
literal|3
condition|)
block|{
comment|/* Packed 24 bit mode */
comment|/* ================== */
name|gck_rgb_to_image24
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|32
operator|||
operator|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|24
operator|&&
name|image
operator|->
name|bpp
operator|==
literal|4
operator|)
condition|)
block|{
comment|/* 32 bpp mode */
comment|/* =========== */
name|gck_rgb_to_image32
argument_list|(
name|visinfo
argument_list|,
name|RGB_data
argument_list|,
name|image
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Non-reentrant function - GdkColor is a static storage  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_gdkcolor (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_gdkcolor
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|GdkColor
modifier|*
name|color
init|=
name|NULL
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_PSEUDO_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|8
condition|)
block|{
comment|/* Standard 256 color display */
comment|/* ========================== */
name|color
operator|=
name|gck_rgb_to_color8
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_TRUE_COLOR
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_DIRECT_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|15
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|16
condition|)
block|{
comment|/* HiColor modes */
comment|/* ============= */
name|color
operator|=
name|gck_rgb_to_color16
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|24
condition|)
block|{
comment|/* Normal 24 bit mode */
comment|/* ================== */
name|color
operator|=
name|gck_rgb_to_color24
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|32
condition|)
block|{
comment|/* 32 bpp mode */
comment|/* =========== */
name|color
operator|=
name|gck_rgb_to_color32
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reentrant function - GdkColor will be malloc'ed  */
end_comment

begin_function
specifier|static
name|GdkColor
modifier|*
DECL|function|gck_rgb_to_gdkcolor_r (GckVisualInfo * visinfo,guchar r,guchar g,guchar b)
name|gck_rgb_to_gdkcolor_r
parameter_list|(
name|GckVisualInfo
modifier|*
name|visinfo
parameter_list|,
name|guchar
name|r
parameter_list|,
name|guchar
name|g
parameter_list|,
name|guchar
name|b
parameter_list|)
block|{
name|GdkColor
modifier|*
name|color
init|=
name|NULL
decl_stmt|;
name|g_assert
argument_list|(
name|visinfo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_PSEUDO_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|8
condition|)
block|{
comment|/* Standard 256 color display */
comment|/* ========================== */
name|color
operator|=
name|gck_rgb_to_color8_r
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_TRUE_COLOR
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|type
operator|==
name|GDK_VISUAL_DIRECT_COLOR
condition|)
block|{
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|15
operator|||
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|16
condition|)
block|{
comment|/* HiColor modes */
comment|/* ============= */
name|color
operator|=
name|gck_rgb_to_color16_r
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|24
condition|)
block|{
comment|/* Normal 24 bit mode */
comment|/* ================== */
name|color
operator|=
name|gck_rgb_to_color24_r
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|visinfo
operator|->
name|visual
operator|->
name|depth
operator|==
literal|32
condition|)
block|{
comment|/* 32 bpp mode */
comment|/* =========== */
name|color
operator|=
name|gck_rgb_to_color32_r
argument_list|(
name|visinfo
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|color
operator|)
return|;
block|}
end_function

begin_comment
comment|/********************/
end_comment

begin_comment
comment|/* Color operations */
end_comment

begin_comment
comment|/********************/
end_comment

begin_comment
comment|/******************************************/
end_comment

begin_comment
comment|/* Bilinear interpolation stuff (Quartic) */
end_comment

begin_comment
comment|/******************************************/
end_comment

begin_function
DECL|function|gck_bilinear (double x,double y,double * values)
name|double
name|gck_bilinear
parameter_list|(
name|double
name|x
parameter_list|,
name|double
name|y
parameter_list|,
name|double
modifier|*
name|values
parameter_list|)
block|{
name|double
name|xx
decl_stmt|,
name|yy
decl_stmt|,
name|m0
decl_stmt|,
name|m1
decl_stmt|;
name|g_assert
argument_list|(
name|values
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|xx
operator|=
name|fmod
argument_list|(
name|x
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|yy
operator|=
name|fmod
argument_list|(
name|y
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0.0
condition|)
name|x
operator|+=
literal|1.0
expr_stmt|;
if|if
condition|(
name|y
operator|<
literal|0.0
condition|)
name|y
operator|+=
literal|1.0
expr_stmt|;
name|m0
operator|=
operator|(
literal|1.0
operator|-
name|xx
operator|)
operator|*
name|values
index|[
literal|0
index|]
operator|+
name|xx
operator|*
name|values
index|[
literal|1
index|]
expr_stmt|;
name|m1
operator|=
operator|(
literal|1.0
operator|-
name|xx
operator|)
operator|*
name|values
index|[
literal|2
index|]
operator|+
name|xx
operator|*
name|values
index|[
literal|3
index|]
expr_stmt|;
return|return
operator|(
operator|(
literal|1.0
operator|-
name|yy
operator|)
operator|*
name|m0
operator|+
name|yy
operator|*
name|m1
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_bilinear_8 (double x,double y,guchar * values)
name|guchar
name|gck_bilinear_8
parameter_list|(
name|double
name|x
parameter_list|,
name|double
name|y
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|)
block|{
name|double
name|xx
decl_stmt|,
name|yy
decl_stmt|,
name|m0
decl_stmt|,
name|m1
decl_stmt|;
name|g_assert
argument_list|(
name|values
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|xx
operator|=
name|fmod
argument_list|(
name|x
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|yy
operator|=
name|fmod
argument_list|(
name|y
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0.0
condition|)
name|x
operator|+=
literal|1.0
expr_stmt|;
if|if
condition|(
name|y
operator|<
literal|0.0
condition|)
name|y
operator|+=
literal|1.0
expr_stmt|;
name|m0
operator|=
operator|(
literal|1.0
operator|-
name|xx
operator|)
operator|*
name|values
index|[
literal|0
index|]
operator|+
name|xx
operator|*
name|values
index|[
literal|1
index|]
expr_stmt|;
name|m1
operator|=
operator|(
literal|1.0
operator|-
name|xx
operator|)
operator|*
name|values
index|[
literal|2
index|]
operator|+
name|xx
operator|*
name|values
index|[
literal|3
index|]
expr_stmt|;
return|return
operator|(
call|(
name|guchar
call|)
argument_list|(
operator|(
literal|1.0
operator|-
name|yy
operator|)
operator|*
name|m0
operator|+
name|yy
operator|*
name|m1
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_bilinear_16 (double x,double y,guint16 * values)
name|guint16
name|gck_bilinear_16
parameter_list|(
name|double
name|x
parameter_list|,
name|double
name|y
parameter_list|,
name|guint16
modifier|*
name|values
parameter_list|)
block|{
name|double
name|xx
decl_stmt|,
name|yy
decl_stmt|,
name|m0
decl_stmt|,
name|m1
decl_stmt|;
name|g_assert
argument_list|(
name|values
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|xx
operator|=
name|fmod
argument_list|(
name|x
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|yy
operator|=
name|fmod
argument_list|(
name|y
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0.0
condition|)
name|x
operator|+=
literal|1.0
expr_stmt|;
if|if
condition|(
name|y
operator|<
literal|0.0
condition|)
name|y
operator|+=
literal|1.0
expr_stmt|;
name|m0
operator|=
operator|(
literal|1.0
operator|-
name|xx
operator|)
operator|*
name|values
index|[
literal|0
index|]
operator|+
name|xx
operator|*
name|values
index|[
literal|1
index|]
expr_stmt|;
name|m1
operator|=
operator|(
literal|1.0
operator|-
name|xx
operator|)
operator|*
name|values
index|[
literal|2
index|]
operator|+
name|xx
operator|*
name|values
index|[
literal|3
index|]
expr_stmt|;
return|return
operator|(
call|(
name|guint16
call|)
argument_list|(
operator|(
literal|1.0
operator|-
name|yy
operator|)
operator|*
name|m0
operator|+
name|yy
operator|*
name|m1
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_bilinear_32 (double x,double y,guint32 * values)
name|guint32
name|gck_bilinear_32
parameter_list|(
name|double
name|x
parameter_list|,
name|double
name|y
parameter_list|,
name|guint32
modifier|*
name|values
parameter_list|)
block|{
name|double
name|xx
decl_stmt|,
name|yy
decl_stmt|,
name|m0
decl_stmt|,
name|m1
decl_stmt|;
name|g_assert
argument_list|(
name|values
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|xx
operator|=
name|fmod
argument_list|(
name|x
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|yy
operator|=
name|fmod
argument_list|(
name|y
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0.0
condition|)
name|x
operator|+=
literal|1.0
expr_stmt|;
if|if
condition|(
name|y
operator|<
literal|0.0
condition|)
name|y
operator|+=
literal|1.0
expr_stmt|;
name|m0
operator|=
operator|(
literal|1.0
operator|-
name|xx
operator|)
operator|*
name|values
index|[
literal|0
index|]
operator|+
name|xx
operator|*
name|values
index|[
literal|1
index|]
expr_stmt|;
name|m1
operator|=
operator|(
literal|1.0
operator|-
name|xx
operator|)
operator|*
name|values
index|[
literal|2
index|]
operator|+
name|xx
operator|*
name|values
index|[
literal|3
index|]
expr_stmt|;
return|return
operator|(
call|(
name|guint32
call|)
argument_list|(
operator|(
literal|1.0
operator|-
name|yy
operator|)
operator|*
name|m0
operator|+
name|yy
operator|*
name|m1
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_bilinear_rgb (double x,double y,GckRGB * values)
name|GckRGB
name|gck_bilinear_rgb
parameter_list|(
name|double
name|x
parameter_list|,
name|double
name|y
parameter_list|,
name|GckRGB
modifier|*
name|values
parameter_list|)
block|{
name|double
name|m0
decl_stmt|,
name|m1
decl_stmt|;
name|double
name|ix
decl_stmt|,
name|iy
decl_stmt|;
name|GckRGB
name|v
decl_stmt|;
name|g_assert
argument_list|(
name|values
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|x
operator|=
name|fmod
argument_list|(
name|x
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|y
operator|=
name|fmod
argument_list|(
name|y
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
condition|)
name|x
operator|+=
literal|1.0
expr_stmt|;
if|if
condition|(
name|y
operator|<
literal|0
condition|)
name|y
operator|+=
literal|1.0
expr_stmt|;
name|ix
operator|=
literal|1.0
operator|-
name|x
expr_stmt|;
name|iy
operator|=
literal|1.0
operator|-
name|y
expr_stmt|;
comment|/* Red */
comment|/* === */
name|m0
operator|=
name|ix
operator|*
name|values
index|[
literal|0
index|]
operator|.
name|r
operator|+
name|x
operator|*
name|values
index|[
literal|1
index|]
operator|.
name|r
expr_stmt|;
name|m1
operator|=
name|ix
operator|*
name|values
index|[
literal|2
index|]
operator|.
name|r
operator|+
name|x
operator|*
name|values
index|[
literal|3
index|]
operator|.
name|r
expr_stmt|;
name|v
operator|.
name|r
operator|=
name|iy
operator|*
name|m0
operator|+
name|y
operator|*
name|m1
expr_stmt|;
comment|/* Green */
comment|/* ===== */
name|m0
operator|=
name|ix
operator|*
name|values
index|[
literal|0
index|]
operator|.
name|g
operator|+
name|x
operator|*
name|values
index|[
literal|1
index|]
operator|.
name|g
expr_stmt|;
name|m1
operator|=
name|ix
operator|*
name|values
index|[
literal|2
index|]
operator|.
name|g
operator|+
name|x
operator|*
name|values
index|[
literal|3
index|]
operator|.
name|g
expr_stmt|;
name|v
operator|.
name|g
operator|=
name|iy
operator|*
name|m0
operator|+
name|y
operator|*
name|m1
expr_stmt|;
comment|/* Blue */
comment|/* ==== */
name|m0
operator|=
name|ix
operator|*
name|values
index|[
literal|0
index|]
operator|.
name|b
operator|+
name|x
operator|*
name|values
index|[
literal|1
index|]
operator|.
name|b
expr_stmt|;
name|m1
operator|=
name|ix
operator|*
name|values
index|[
literal|2
index|]
operator|.
name|b
operator|+
name|x
operator|*
name|values
index|[
literal|3
index|]
operator|.
name|b
expr_stmt|;
name|v
operator|.
name|b
operator|=
name|iy
operator|*
name|m0
operator|+
name|y
operator|*
name|m1
expr_stmt|;
return|return
operator|(
name|v
operator|)
return|;
block|}
end_function

begin_comment
comment|/* bilinear */
end_comment

begin_function
DECL|function|gck_bilinear_rgba (double x,double y,GckRGB * values)
name|GckRGB
name|gck_bilinear_rgba
parameter_list|(
name|double
name|x
parameter_list|,
name|double
name|y
parameter_list|,
name|GckRGB
modifier|*
name|values
parameter_list|)
block|{
name|double
name|m0
decl_stmt|,
name|m1
decl_stmt|;
name|double
name|ix
decl_stmt|,
name|iy
decl_stmt|;
name|GckRGB
name|v
decl_stmt|;
name|g_assert
argument_list|(
name|values
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|x
operator|=
name|fmod
argument_list|(
name|x
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|y
operator|=
name|fmod
argument_list|(
name|y
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
condition|)
name|x
operator|+=
literal|1.0
expr_stmt|;
if|if
condition|(
name|y
operator|<
literal|0
condition|)
name|y
operator|+=
literal|1.0
expr_stmt|;
name|ix
operator|=
literal|1.0
operator|-
name|x
expr_stmt|;
name|iy
operator|=
literal|1.0
operator|-
name|y
expr_stmt|;
comment|/* Red */
comment|/* === */
name|m0
operator|=
name|ix
operator|*
name|values
index|[
literal|0
index|]
operator|.
name|r
operator|+
name|x
operator|*
name|values
index|[
literal|1
index|]
operator|.
name|r
expr_stmt|;
name|m1
operator|=
name|ix
operator|*
name|values
index|[
literal|2
index|]
operator|.
name|r
operator|+
name|x
operator|*
name|values
index|[
literal|3
index|]
operator|.
name|r
expr_stmt|;
name|v
operator|.
name|r
operator|=
name|iy
operator|*
name|m0
operator|+
name|y
operator|*
name|m1
expr_stmt|;
comment|/* Green */
comment|/* ===== */
name|m0
operator|=
name|ix
operator|*
name|values
index|[
literal|0
index|]
operator|.
name|g
operator|+
name|x
operator|*
name|values
index|[
literal|1
index|]
operator|.
name|g
expr_stmt|;
name|m1
operator|=
name|ix
operator|*
name|values
index|[
literal|2
index|]
operator|.
name|g
operator|+
name|x
operator|*
name|values
index|[
literal|3
index|]
operator|.
name|g
expr_stmt|;
name|v
operator|.
name|g
operator|=
name|iy
operator|*
name|m0
operator|+
name|y
operator|*
name|m1
expr_stmt|;
comment|/* Blue */
comment|/* ==== */
name|m0
operator|=
name|ix
operator|*
name|values
index|[
literal|0
index|]
operator|.
name|b
operator|+
name|x
operator|*
name|values
index|[
literal|1
index|]
operator|.
name|b
expr_stmt|;
name|m1
operator|=
name|ix
operator|*
name|values
index|[
literal|2
index|]
operator|.
name|b
operator|+
name|x
operator|*
name|values
index|[
literal|3
index|]
operator|.
name|b
expr_stmt|;
name|v
operator|.
name|b
operator|=
name|iy
operator|*
name|m0
operator|+
name|y
operator|*
name|m1
expr_stmt|;
comment|/* Alpha */
comment|/* ===== */
name|m0
operator|=
name|ix
operator|*
name|values
index|[
literal|0
index|]
operator|.
name|a
operator|+
name|x
operator|*
name|values
index|[
literal|1
index|]
operator|.
name|a
expr_stmt|;
name|m1
operator|=
name|ix
operator|*
name|values
index|[
literal|2
index|]
operator|.
name|a
operator|+
name|x
operator|*
name|values
index|[
literal|3
index|]
operator|.
name|a
expr_stmt|;
name|v
operator|.
name|a
operator|=
name|iy
operator|*
name|m0
operator|+
name|y
operator|*
name|m1
expr_stmt|;
return|return
operator|(
name|v
operator|)
return|;
block|}
end_function

begin_comment
comment|/* bilinear */
end_comment

begin_comment
comment|/********************************/
end_comment

begin_comment
comment|/* Multiple channels operations */
end_comment

begin_comment
comment|/********************************/
end_comment

begin_function
DECL|function|gck_rgb_add (GckRGB * p,GckRGB * q)
name|void
name|gck_rgb_add
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|GckRGB
modifier|*
name|q
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|q
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|p
operator|->
name|r
operator|+
name|q
operator|->
name|r
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|p
operator|->
name|g
operator|+
name|q
operator|->
name|g
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|p
operator|->
name|b
operator|+
name|q
operator|->
name|b
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgb_sub (GckRGB * p,GckRGB * q)
name|void
name|gck_rgb_sub
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|GckRGB
modifier|*
name|q
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|q
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|p
operator|->
name|r
operator|-
name|q
operator|->
name|r
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|p
operator|->
name|g
operator|-
name|q
operator|->
name|g
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|p
operator|->
name|b
operator|-
name|q
operator|->
name|b
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgb_mul (GckRGB * p,double b)
name|void
name|gck_rgb_mul
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|double
name|b
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|p
operator|->
name|r
operator|*
name|b
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|p
operator|->
name|g
operator|*
name|b
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|p
operator|->
name|b
operator|*
name|b
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgb_dist (GckRGB * p,GckRGB * q)
name|double
name|gck_rgb_dist
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|GckRGB
modifier|*
name|q
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|q
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|fabs
argument_list|(
name|p
operator|->
name|r
operator|-
name|q
operator|->
name|r
argument_list|)
operator|+
name|fabs
argument_list|(
name|p
operator|->
name|g
operator|-
name|q
operator|->
name|g
argument_list|)
operator|+
name|fabs
argument_list|(
name|p
operator|->
name|b
operator|-
name|q
operator|->
name|b
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_rgb_max (GckRGB * p)
name|double
name|gck_rgb_max
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|)
block|{
name|double
name|max
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|max
operator|=
name|p
operator|->
name|r
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|g
operator|>
name|max
condition|)
name|max
operator|=
name|p
operator|->
name|g
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|b
operator|>
name|max
condition|)
name|max
operator|=
name|p
operator|->
name|b
expr_stmt|;
return|return
operator|(
name|max
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_rgb_min (GckRGB * p)
name|double
name|gck_rgb_min
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|)
block|{
name|double
name|min
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|min
operator|=
name|p
operator|->
name|r
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|g
operator|<
name|min
condition|)
name|min
operator|=
name|p
operator|->
name|g
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|b
operator|<
name|min
condition|)
name|min
operator|=
name|p
operator|->
name|b
expr_stmt|;
return|return
operator|(
name|min
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_rgb_clamp (GckRGB * p)
name|void
name|gck_rgb_clamp
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|r
operator|>
literal|1.0
condition|)
name|p
operator|->
name|r
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|g
operator|>
literal|1.0
condition|)
name|p
operator|->
name|g
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|b
operator|>
literal|1.0
condition|)
name|p
operator|->
name|b
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|r
operator|<
literal|0.0
condition|)
name|p
operator|->
name|r
operator|=
literal|0.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|g
operator|<
literal|0.0
condition|)
name|p
operator|->
name|g
operator|=
literal|0.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|b
operator|<
literal|0.0
condition|)
name|p
operator|->
name|b
operator|=
literal|0.0
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgb_set (GckRGB * p,double r,double g,double b)
name|void
name|gck_rgb_set
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|double
name|r
parameter_list|,
name|double
name|g
parameter_list|,
name|double
name|b
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|r
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|g
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|b
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgb_gamma (GckRGB * p,double gamma)
name|void
name|gck_rgb_gamma
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|double
name|gamma
parameter_list|)
block|{
name|double
name|ig
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|gamma
operator|!=
literal|0.0
condition|)
name|ig
operator|=
literal|1.0
operator|/
name|gamma
expr_stmt|;
else|else
operator|(
name|ig
operator|=
literal|0.0
operator|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|pow
argument_list|(
name|p
operator|->
name|r
argument_list|,
name|ig
argument_list|)
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|pow
argument_list|(
name|p
operator|->
name|g
argument_list|,
name|ig
argument_list|)
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|pow
argument_list|(
name|p
operator|->
name|b
argument_list|,
name|ig
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgba_add (GckRGB * p,GckRGB * q)
name|void
name|gck_rgba_add
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|GckRGB
modifier|*
name|q
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|q
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|p
operator|->
name|r
operator|+
name|q
operator|->
name|r
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|p
operator|->
name|g
operator|+
name|q
operator|->
name|g
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|p
operator|->
name|b
operator|+
name|q
operator|->
name|b
expr_stmt|;
name|p
operator|->
name|a
operator|=
name|p
operator|->
name|a
operator|+
name|q
operator|->
name|a
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgba_sub (GckRGB * p,GckRGB * q)
name|void
name|gck_rgba_sub
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|GckRGB
modifier|*
name|q
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|q
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|p
operator|->
name|r
operator|-
name|q
operator|->
name|r
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|p
operator|->
name|g
operator|-
name|q
operator|->
name|g
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|p
operator|->
name|b
operator|-
name|q
operator|->
name|b
expr_stmt|;
name|p
operator|->
name|a
operator|=
name|p
operator|->
name|a
operator|-
name|q
operator|->
name|a
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgba_mul (GckRGB * p,double b)
name|void
name|gck_rgba_mul
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|double
name|b
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|p
operator|->
name|r
operator|*
name|b
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|p
operator|->
name|g
operator|*
name|b
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|p
operator|->
name|b
operator|*
name|b
expr_stmt|;
name|p
operator|->
name|a
operator|=
name|p
operator|->
name|a
operator|*
name|b
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgba_dist (GckRGB * p,GckRGB * q)
name|double
name|gck_rgba_dist
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|GckRGB
modifier|*
name|q
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|q
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|fabs
argument_list|(
name|p
operator|->
name|r
operator|-
name|q
operator|->
name|r
argument_list|)
operator|+
name|fabs
argument_list|(
name|p
operator|->
name|g
operator|-
name|q
operator|->
name|g
argument_list|)
operator|+
name|fabs
argument_list|(
name|p
operator|->
name|b
operator|-
name|q
operator|->
name|b
argument_list|)
operator|+
name|fabs
argument_list|(
name|p
operator|->
name|a
operator|-
name|q
operator|->
name|a
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* These two are probably not needed */
end_comment

begin_function
DECL|function|gck_rgba_max (GckRGB * p)
name|double
name|gck_rgba_max
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|)
block|{
name|double
name|max
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|max
operator|=
name|p
operator|->
name|r
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|g
operator|>
name|max
condition|)
name|max
operator|=
name|p
operator|->
name|g
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|b
operator|>
name|max
condition|)
name|max
operator|=
name|p
operator|->
name|b
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|a
operator|>
name|max
condition|)
name|max
operator|=
name|p
operator|->
name|a
expr_stmt|;
return|return
operator|(
name|max
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_rgba_min (GckRGB * p)
name|double
name|gck_rgba_min
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|)
block|{
name|double
name|min
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|min
operator|=
name|p
operator|->
name|r
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|g
operator|<
name|min
condition|)
name|min
operator|=
name|p
operator|->
name|g
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|b
operator|<
name|min
condition|)
name|min
operator|=
name|p
operator|->
name|b
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|a
operator|<
name|min
condition|)
name|min
operator|=
name|p
operator|->
name|a
expr_stmt|;
return|return
operator|(
name|min
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_rgba_clamp (GckRGB * p)
name|void
name|gck_rgba_clamp
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|r
operator|>
literal|1.0
condition|)
name|p
operator|->
name|r
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|g
operator|>
literal|1.0
condition|)
name|p
operator|->
name|g
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|b
operator|>
literal|1.0
condition|)
name|p
operator|->
name|b
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|a
operator|>
literal|1.0
condition|)
name|p
operator|->
name|a
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|r
operator|<
literal|0.0
condition|)
name|p
operator|->
name|r
operator|=
literal|0.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|g
operator|<
literal|0.0
condition|)
name|p
operator|->
name|g
operator|=
literal|0.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|b
operator|<
literal|0.0
condition|)
name|p
operator|->
name|b
operator|=
literal|0.0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|a
operator|<
literal|0.0
condition|)
name|p
operator|->
name|a
operator|=
literal|0.0
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gck_rgba_set (GckRGB * p,double r,double g,double b,double a)
name|void
name|gck_rgba_set
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|double
name|r
parameter_list|,
name|double
name|g
parameter_list|,
name|double
name|b
parameter_list|,
name|double
name|a
parameter_list|)
block|{
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|r
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|g
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|b
expr_stmt|;
name|p
operator|->
name|a
operator|=
name|a
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This one is also not needed */
end_comment

begin_function
DECL|function|gck_rgba_gamma (GckRGB * p,double gamma)
name|void
name|gck_rgba_gamma
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|double
name|gamma
parameter_list|)
block|{
name|double
name|ig
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|gamma
operator|!=
literal|0.0
condition|)
name|ig
operator|=
literal|1.0
operator|/
name|gamma
expr_stmt|;
else|else
operator|(
name|ig
operator|=
literal|0.0
operator|)
expr_stmt|;
name|p
operator|->
name|r
operator|=
name|pow
argument_list|(
name|p
operator|->
name|r
argument_list|,
name|ig
argument_list|)
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|pow
argument_list|(
name|p
operator|->
name|g
argument_list|,
name|ig
argument_list|)
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|pow
argument_list|(
name|p
operator|->
name|b
argument_list|,
name|ig
argument_list|)
expr_stmt|;
name|p
operator|->
name|a
operator|=
name|pow
argument_list|(
name|p
operator|->
name|a
argument_list|,
name|ig
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************/
end_comment

begin_comment
comment|/* Colorspace conversions */
end_comment

begin_comment
comment|/**************************/
end_comment

begin_comment
comment|/***********************************************/
end_comment

begin_comment
comment|/* (Red,Green,Blue)<-> (Hue,Saturation,Value) */
end_comment

begin_comment
comment|/***********************************************/
end_comment

begin_function
DECL|function|gck_rgb_to_hsv (GckRGB * p,double * h,double * s,double * v)
name|void
name|gck_rgb_to_hsv
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|double
modifier|*
name|h
parameter_list|,
name|double
modifier|*
name|s
parameter_list|,
name|double
modifier|*
name|v
parameter_list|)
block|{
name|double
name|max
decl_stmt|,
name|min
decl_stmt|,
name|delta
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|h
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|s
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|v
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|max
operator|=
name|gck_rgb_max
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|min
operator|=
name|gck_rgb_min
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|*
name|v
operator|=
name|max
expr_stmt|;
if|if
condition|(
name|max
operator|!=
literal|0.0
condition|)
block|{
operator|*
name|s
operator|=
operator|(
name|max
operator|-
name|min
operator|)
operator|/
name|max
expr_stmt|;
block|}
else|else
operator|*
name|s
operator|=
literal|0.0
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|0.0
condition|)
operator|*
name|h
operator|=
name|GCK_HSV_UNDEFINED
expr_stmt|;
else|else
block|{
name|delta
operator|=
name|max
operator|-
name|min
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|r
operator|==
name|max
condition|)
block|{
operator|*
name|h
operator|=
operator|(
name|p
operator|->
name|g
operator|-
name|p
operator|->
name|b
operator|)
operator|/
name|delta
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|g
operator|==
name|max
condition|)
block|{
operator|*
name|h
operator|=
literal|2.0
operator|+
operator|(
name|p
operator|->
name|b
operator|-
name|p
operator|->
name|r
operator|)
operator|/
name|delta
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|b
operator|==
name|max
condition|)
block|{
operator|*
name|h
operator|=
literal|4.0
operator|+
operator|(
name|p
operator|->
name|r
operator|-
name|p
operator|->
name|g
operator|)
operator|/
name|delta
expr_stmt|;
block|}
operator|*
name|h
operator|=
operator|*
name|h
operator|*
literal|60.0
expr_stmt|;
if|if
condition|(
operator|*
name|h
operator|<
literal|0.0
condition|)
operator|*
name|h
operator|=
operator|*
name|h
operator|+
literal|360
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|gck_hsv_to_rgb (double h,double s,double v,GckRGB * p)
name|void
name|gck_hsv_to_rgb
parameter_list|(
name|double
name|h
parameter_list|,
name|double
name|s
parameter_list|,
name|double
name|v
parameter_list|,
name|GckRGB
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|double
name|f
decl_stmt|,
name|w
decl_stmt|,
name|q
decl_stmt|,
name|t
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
literal|0.0
condition|)
block|{
if|if
condition|(
name|h
operator|==
name|GCK_HSV_UNDEFINED
condition|)
block|{
name|p
operator|->
name|r
operator|=
name|v
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|v
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|v
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|h
operator|==
literal|360.0
condition|)
name|h
operator|=
literal|0.0
expr_stmt|;
name|h
operator|=
name|h
operator|/
literal|60.0
expr_stmt|;
name|i
operator|=
operator|(
name|int
operator|)
name|h
expr_stmt|;
name|f
operator|=
name|h
operator|-
name|i
expr_stmt|;
name|w
operator|=
name|v
operator|*
operator|(
literal|1.0
operator|-
name|s
operator|)
expr_stmt|;
name|q
operator|=
name|v
operator|*
operator|(
literal|1.0
operator|-
operator|(
name|s
operator|*
name|f
operator|)
operator|)
expr_stmt|;
name|t
operator|=
name|v
operator|*
operator|(
literal|1.0
operator|-
operator|(
name|s
operator|*
operator|(
literal|1.0
operator|-
name|f
operator|)
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|0
case|:
name|p
operator|->
name|r
operator|=
name|v
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|t
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|w
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|p
operator|->
name|r
operator|=
name|q
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|v
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|w
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|p
operator|->
name|r
operator|=
name|w
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|v
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|t
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|p
operator|->
name|r
operator|=
name|w
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|q
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|v
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|p
operator|->
name|r
operator|=
name|t
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|w
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|v
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|p
operator|->
name|r
operator|=
name|v
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|w
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|q
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/***************************************************/
end_comment

begin_comment
comment|/* (Red,Green,Blue)<-> (Hue,Saturation,Lightness) */
end_comment

begin_comment
comment|/***************************************************/
end_comment

begin_function
DECL|function|gck_rgb_to_hsl (GckRGB * p,double * h,double * s,double * l)
name|void
name|gck_rgb_to_hsl
parameter_list|(
name|GckRGB
modifier|*
name|p
parameter_list|,
name|double
modifier|*
name|h
parameter_list|,
name|double
modifier|*
name|s
parameter_list|,
name|double
modifier|*
name|l
parameter_list|)
block|{
name|double
name|max
decl_stmt|,
name|min
decl_stmt|,
name|delta
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|h
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|s
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|l
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|max
operator|=
name|gck_rgb_max
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|min
operator|=
name|gck_rgb_min
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|*
name|l
operator|=
operator|(
name|max
operator|+
name|min
operator|)
operator|/
literal|2.0
expr_stmt|;
if|if
condition|(
name|max
operator|==
name|min
condition|)
block|{
operator|*
name|s
operator|=
literal|0.0
expr_stmt|;
operator|*
name|h
operator|=
name|GCK_HSL_UNDEFINED
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|l
operator|<=
literal|0.5
condition|)
operator|*
name|s
operator|=
operator|(
name|max
operator|-
name|min
operator|)
operator|/
operator|(
name|max
operator|+
name|min
operator|)
expr_stmt|;
else|else
operator|*
name|s
operator|=
operator|(
name|max
operator|-
name|min
operator|)
operator|/
operator|(
literal|2.0
operator|-
name|max
operator|-
name|min
operator|)
expr_stmt|;
name|delta
operator|=
name|max
operator|-
name|min
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|r
operator|==
name|max
condition|)
block|{
operator|*
name|h
operator|=
operator|(
name|p
operator|->
name|g
operator|-
name|p
operator|->
name|b
operator|)
operator|/
name|delta
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|g
operator|==
name|max
condition|)
block|{
operator|*
name|h
operator|=
literal|2.0
operator|+
operator|(
name|p
operator|->
name|b
operator|-
name|p
operator|->
name|r
operator|)
operator|/
name|delta
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|b
operator|==
name|max
condition|)
block|{
operator|*
name|h
operator|=
literal|4.0
operator|+
operator|(
name|p
operator|->
name|r
operator|-
name|p
operator|->
name|g
operator|)
operator|/
name|delta
expr_stmt|;
block|}
operator|*
name|h
operator|=
operator|*
name|h
operator|*
literal|60.0
expr_stmt|;
if|if
condition|(
operator|*
name|h
operator|<
literal|0.0
condition|)
operator|*
name|h
operator|=
operator|*
name|h
operator|+
literal|360.0
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|_gck_value (double n1,double n2,double hue)
name|double
name|_gck_value
parameter_list|(
name|double
name|n1
parameter_list|,
name|double
name|n2
parameter_list|,
name|double
name|hue
parameter_list|)
block|{
name|double
name|val
decl_stmt|;
if|if
condition|(
name|hue
operator|>
literal|360.0
condition|)
name|hue
operator|=
name|hue
operator|-
literal|360.0
expr_stmt|;
elseif|else
if|if
condition|(
name|hue
operator|<
literal|0.0
condition|)
name|hue
operator|=
name|hue
operator|+
literal|360.0
expr_stmt|;
if|if
condition|(
name|hue
operator|<
literal|60.0
condition|)
name|val
operator|=
name|n1
operator|+
operator|(
name|n2
operator|-
name|n1
operator|)
operator|*
name|hue
operator|/
literal|60.0
expr_stmt|;
elseif|else
if|if
condition|(
name|hue
operator|<
literal|180.0
condition|)
name|val
operator|=
name|n2
expr_stmt|;
elseif|else
if|if
condition|(
name|hue
operator|<
literal|240.0
condition|)
name|val
operator|=
name|n1
operator|+
operator|(
name|n2
operator|-
name|n1
operator|)
operator|*
operator|(
literal|240.0
operator|-
name|hue
operator|)
operator|/
literal|60.0
expr_stmt|;
else|else
name|val
operator|=
name|n1
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
DECL|function|gck_hsl_to_rgb (double h,double s,double l,GckRGB * p)
name|void
name|gck_hsl_to_rgb
parameter_list|(
name|double
name|h
parameter_list|,
name|double
name|s
parameter_list|,
name|double
name|l
parameter_list|,
name|GckRGB
modifier|*
name|p
parameter_list|)
block|{
name|double
name|m1
decl_stmt|,
name|m2
decl_stmt|;
name|g_assert
argument_list|(
name|p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|<=
literal|0.5
condition|)
name|m2
operator|=
name|l
operator|*
operator|(
name|l
operator|+
name|s
operator|)
expr_stmt|;
else|else
name|m2
operator|=
name|l
operator|+
name|s
operator|+
name|l
operator|*
name|s
expr_stmt|;
name|m1
operator|=
literal|2.0
operator|*
name|l
operator|-
name|m2
expr_stmt|;
if|if
condition|(
name|s
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|h
operator|==
name|GCK_HSV_UNDEFINED
condition|)
name|p
operator|->
name|r
operator|=
name|p
operator|->
name|g
operator|=
name|p
operator|->
name|b
operator|=
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|r
operator|=
name|_gck_value
argument_list|(
name|m1
argument_list|,
name|m2
argument_list|,
name|h
operator|+
literal|120.0
argument_list|)
expr_stmt|;
name|p
operator|->
name|g
operator|=
name|_gck_value
argument_list|(
name|m1
argument_list|,
name|m2
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|p
operator|->
name|b
operator|=
name|_gck_value
argument_list|(
name|m1
argument_list|,
name|m2
argument_list|,
name|h
operator|-
literal|120.0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
DECL|macro|GCK_RETURN_RGB (x,y,z)
define|#
directive|define
name|GCK_RETURN_RGB
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|{rgb->r = x; rgb->g = y; rgb->b = z; return; }
end_define

begin_comment
comment|/***********************************************************************************/
end_comment

begin_comment
comment|/* Theoretically, hue 0 (pure red) is identical to hue 6 in these transforms. Pure */
end_comment

begin_comment
comment|/* red always maps to 6 in this implementation. Therefore UNDEFINED can be         */
end_comment

begin_comment
comment|/* defined as 0 in situations where only unsigned numbers are desired.             */
end_comment

begin_comment
comment|/***********************************************************************************/
end_comment

begin_function
DECL|function|gck_rgb_to_hwb (GckRGB * rgb,gdouble * hue,gdouble * whiteness,gdouble * blackness)
name|void
name|gck_rgb_to_hwb
parameter_list|(
name|GckRGB
modifier|*
name|rgb
parameter_list|,
name|gdouble
modifier|*
name|hue
parameter_list|,
name|gdouble
modifier|*
name|whiteness
parameter_list|,
name|gdouble
modifier|*
name|blackness
parameter_list|)
block|{
comment|/* RGB are each on [0, 1]. W and B are returned on [0, 1] and H is        */
comment|/* returned on [0, 6]. Exception: H is returned UNDEFINED if W ==  1 - B. */
comment|/* ====================================================================== */
name|gdouble
name|R
init|=
name|rgb
operator|->
name|r
decl_stmt|,
name|G
init|=
name|rgb
operator|->
name|g
decl_stmt|,
name|B
init|=
name|rgb
operator|->
name|b
decl_stmt|,
name|w
decl_stmt|,
name|v
decl_stmt|,
name|b
decl_stmt|,
name|f
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|w
operator|=
name|gck_rgb_min
argument_list|(
name|rgb
argument_list|)
expr_stmt|;
name|v
operator|=
name|gck_rgb_max
argument_list|(
name|rgb
argument_list|)
expr_stmt|;
name|b
operator|=
literal|1.0
operator|-
name|v
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|w
condition|)
block|{
operator|*
name|hue
operator|=
name|GCK_HSV_UNDEFINED
expr_stmt|;
operator|*
name|whiteness
operator|=
name|w
expr_stmt|;
operator|*
name|blackness
operator|=
name|b
expr_stmt|;
block|}
else|else
block|{
name|f
operator|=
operator|(
name|R
operator|==
name|w
operator|)
condition|?
name|G
operator|-
name|B
else|:
operator|(
operator|(
name|G
operator|==
name|w
operator|)
condition|?
name|B
operator|-
name|R
else|:
name|R
operator|-
name|G
operator|)
expr_stmt|;
name|i
operator|=
operator|(
name|R
operator|==
name|w
operator|)
condition|?
literal|3.0
else|:
operator|(
operator|(
name|G
operator|==
name|w
operator|)
condition|?
literal|5.0
else|:
literal|1.0
operator|)
expr_stmt|;
operator|*
name|hue
operator|=
operator|(
literal|360.0
operator|/
literal|6.0
operator|)
operator|*
operator|(
name|i
operator|-
name|f
operator|/
operator|(
name|v
operator|-
name|w
operator|)
operator|)
expr_stmt|;
operator|*
name|whiteness
operator|=
name|w
expr_stmt|;
operator|*
name|blackness
operator|=
name|b
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|gck_hwb_to_rgb (gdouble H,gdouble W,gdouble B,GckRGB * rgb)
name|void
name|gck_hwb_to_rgb
parameter_list|(
name|gdouble
name|H
parameter_list|,
name|gdouble
name|W
parameter_list|,
name|gdouble
name|B
parameter_list|,
name|GckRGB
modifier|*
name|rgb
parameter_list|)
block|{
comment|/* H is given on [0, 6] or UNDEFINED. W and B are given on [0, 1]. */
comment|/* RGB are each returned on [0, 1].                                */
comment|/* =============================================================== */
name|gdouble
name|h
init|=
name|H
decl_stmt|,
name|w
init|=
name|W
decl_stmt|,
name|b
init|=
name|B
decl_stmt|,
name|v
decl_stmt|,
name|n
decl_stmt|,
name|f
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|h
operator|=
literal|6.0
operator|*
name|h
operator|/
literal|360.0
expr_stmt|;
name|v
operator|=
literal|1.0
operator|-
name|b
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|GCK_HSV_UNDEFINED
condition|)
block|{
name|rgb
operator|->
name|r
operator|=
name|v
expr_stmt|;
name|rgb
operator|->
name|g
operator|=
name|v
expr_stmt|;
name|rgb
operator|->
name|b
operator|=
name|v
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|floor
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|f
operator|=
name|h
operator|-
name|i
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|1
condition|)
name|f
operator|=
literal|1.0
operator|-
name|f
expr_stmt|;
comment|/* if i is odd */
name|n
operator|=
name|w
operator|+
name|f
operator|*
operator|(
name|v
operator|-
name|w
operator|)
expr_stmt|;
comment|/* linear interpolation between w and v */
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|6
case|:
case|case
literal|0
case|:
name|GCK_RETURN_RGB
argument_list|(
name|v
argument_list|,
name|n
argument_list|,
name|w
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|GCK_RETURN_RGB
argument_list|(
name|n
argument_list|,
name|v
argument_list|,
name|w
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|GCK_RETURN_RGB
argument_list|(
name|w
argument_list|,
name|v
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|GCK_RETURN_RGB
argument_list|(
name|w
argument_list|,
name|n
argument_list|,
name|v
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|GCK_RETURN_RGB
argument_list|(
name|n
argument_list|,
name|w
argument_list|,
name|v
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|GCK_RETURN_RGB
argument_list|(
name|v
argument_list|,
name|w
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*********************************************************************/
end_comment

begin_comment
comment|/* Sumpersampling code (Quartic)                                     */
end_comment

begin_comment
comment|/* This code is *largely* based on the sources for POV-Ray 3.0. I am */
end_comment

begin_comment
comment|/* grateful to the POV-Team for such a great program and for making  */
end_comment

begin_comment
comment|/* their sources available.  All comments / bug reports /            */
end_comment

begin_comment
comment|/* etc. regarding this code should be addressed to me, not to the    */
end_comment

begin_comment
comment|/* POV-Ray team.  Any bugs are my responsibility, not theirs.        */
end_comment

begin_comment
comment|/*********************************************************************/
end_comment

begin_function
DECL|function|gck_render_sub_pixel (int max_depth,int depth,_GckSampleType ** block,int x,int y,int x1,int y1,int x3,int y3,double threshold,int sub_pixel_size,GckRenderFunction render_func,GckRGB * color)
name|gulong
name|gck_render_sub_pixel
parameter_list|(
name|int
name|max_depth
parameter_list|,
name|int
name|depth
parameter_list|,
name|_GckSampleType
modifier|*
modifier|*
name|block
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|x1
parameter_list|,
name|int
name|y1
parameter_list|,
name|int
name|x3
parameter_list|,
name|int
name|y3
parameter_list|,
name|double
name|threshold
parameter_list|,
name|int
name|sub_pixel_size
parameter_list|,
name|GckRenderFunction
name|render_func
parameter_list|,
name|GckRGB
modifier|*
name|color
parameter_list|)
block|{
name|int
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|cnt
decl_stmt|;
comment|/* Coords of center sample */
name|double
name|dx1
decl_stmt|,
name|dy1
decl_stmt|;
comment|/* Delta to upper left sample */
name|double
name|dx3
decl_stmt|,
name|dy3
decl_stmt|,
name|weight
decl_stmt|;
comment|/* Delta to lower right sample */
name|GckRGB
name|c
index|[
literal|4
index|]
decl_stmt|,
name|tmpcol
decl_stmt|;
name|unsigned
name|long
name|num_samples
init|=
literal|0
decl_stmt|;
comment|/* Get offsets for corners */
comment|/* ======================= */
name|dx1
operator|=
call|(
name|double
call|)
argument_list|(
name|x1
operator|-
name|sub_pixel_size
operator|/
literal|2
argument_list|)
operator|/
name|sub_pixel_size
expr_stmt|;
name|dx3
operator|=
call|(
name|double
call|)
argument_list|(
name|x3
operator|-
name|sub_pixel_size
operator|/
literal|2
argument_list|)
operator|/
name|sub_pixel_size
expr_stmt|;
name|dy1
operator|=
call|(
name|double
call|)
argument_list|(
name|y1
operator|-
name|sub_pixel_size
operator|/
literal|2
argument_list|)
operator|/
name|sub_pixel_size
expr_stmt|;
name|dy3
operator|=
call|(
name|double
call|)
argument_list|(
name|y3
operator|-
name|sub_pixel_size
operator|/
literal|2
argument_list|)
operator|/
name|sub_pixel_size
expr_stmt|;
comment|/* Render upper left sample */
comment|/* ======================== */
if|if
condition|(
operator|!
name|block
index|[
name|y1
index|]
index|[
name|x1
index|]
operator|.
name|ready
condition|)
block|{
name|num_samples
operator|++
expr_stmt|;
call|(
modifier|*
name|render_func
call|)
argument_list|(
name|x
operator|+
name|dx1
argument_list|,
name|y
operator|+
name|dy1
argument_list|,
operator|&
name|c
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|block
index|[
name|y1
index|]
index|[
name|x1
index|]
operator|.
name|ready
operator|=
literal|1
expr_stmt|;
name|block
index|[
name|y1
index|]
index|[
name|x1
index|]
operator|.
name|color
operator|=
name|c
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
name|c
index|[
literal|0
index|]
operator|=
name|block
index|[
name|y1
index|]
index|[
name|x1
index|]
operator|.
name|color
expr_stmt|;
comment|/* Render upper right sample */
comment|/* ========================= */
if|if
condition|(
operator|!
name|block
index|[
name|y1
index|]
index|[
name|x3
index|]
operator|.
name|ready
condition|)
block|{
name|num_samples
operator|++
expr_stmt|;
call|(
modifier|*
name|render_func
call|)
argument_list|(
name|x
operator|+
name|dx3
argument_list|,
name|y
operator|+
name|dy1
argument_list|,
operator|&
name|c
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|block
index|[
name|y1
index|]
index|[
name|x3
index|]
operator|.
name|ready
operator|=
literal|1
expr_stmt|;
name|block
index|[
name|y1
index|]
index|[
name|x3
index|]
operator|.
name|color
operator|=
name|c
index|[
literal|1
index|]
expr_stmt|;
block|}
else|else
name|c
index|[
literal|1
index|]
operator|=
name|block
index|[
name|y1
index|]
index|[
name|x3
index|]
operator|.
name|color
expr_stmt|;
comment|/* Render lower left sample */
comment|/* ======================== */
if|if
condition|(
operator|!
name|block
index|[
name|y3
index|]
index|[
name|x1
index|]
operator|.
name|ready
condition|)
block|{
name|num_samples
operator|++
expr_stmt|;
call|(
modifier|*
name|render_func
call|)
argument_list|(
name|x
operator|+
name|dx1
argument_list|,
name|y
operator|+
name|dy3
argument_list|,
operator|&
name|c
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|block
index|[
name|y3
index|]
index|[
name|x1
index|]
operator|.
name|ready
operator|=
literal|1
expr_stmt|;
name|block
index|[
name|y3
index|]
index|[
name|x1
index|]
operator|.
name|color
operator|=
name|c
index|[
literal|2
index|]
expr_stmt|;
block|}
else|else
name|c
index|[
literal|2
index|]
operator|=
name|block
index|[
name|y3
index|]
index|[
name|x1
index|]
operator|.
name|color
expr_stmt|;
comment|/* Render lower right sample */
comment|/* ========================= */
if|if
condition|(
operator|!
name|block
index|[
name|y3
index|]
index|[
name|x3
index|]
operator|.
name|ready
condition|)
block|{
name|num_samples
operator|++
expr_stmt|;
call|(
modifier|*
name|render_func
call|)
argument_list|(
name|x
operator|+
name|dx3
argument_list|,
name|y
operator|+
name|dy3
argument_list|,
operator|&
name|c
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|block
index|[
name|y3
index|]
index|[
name|x3
index|]
operator|.
name|ready
operator|=
literal|1
expr_stmt|;
name|block
index|[
name|y3
index|]
index|[
name|x3
index|]
operator|.
name|color
operator|=
name|c
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
name|c
index|[
literal|3
index|]
operator|=
name|block
index|[
name|y3
index|]
index|[
name|x3
index|]
operator|.
name|color
expr_stmt|;
comment|/* Check for supersampling */
comment|/* ======================= */
if|if
condition|(
name|depth
operator|<=
name|max_depth
condition|)
block|{
comment|/* Check whether we have to supersample */
comment|/* ==================================== */
if|if
condition|(
operator|(
name|gck_rgba_dist
argument_list|(
operator|&
name|c
index|[
literal|0
index|]
argument_list|,
operator|&
name|c
index|[
literal|1
index|]
argument_list|)
operator|>=
name|threshold
operator|)
operator|||
operator|(
name|gck_rgba_dist
argument_list|(
operator|&
name|c
index|[
literal|0
index|]
argument_list|,
operator|&
name|c
index|[
literal|2
index|]
argument_list|)
operator|>=
name|threshold
operator|)
operator|||
operator|(
name|gck_rgba_dist
argument_list|(
operator|&
name|c
index|[
literal|0
index|]
argument_list|,
operator|&
name|c
index|[
literal|3
index|]
argument_list|)
operator|>=
name|threshold
operator|)
operator|||
operator|(
name|gck_rgba_dist
argument_list|(
operator|&
name|c
index|[
literal|1
index|]
argument_list|,
operator|&
name|c
index|[
literal|2
index|]
argument_list|)
operator|>=
name|threshold
operator|)
operator|||
operator|(
name|gck_rgba_dist
argument_list|(
operator|&
name|c
index|[
literal|1
index|]
argument_list|,
operator|&
name|c
index|[
literal|3
index|]
argument_list|)
operator|>=
name|threshold
operator|)
operator|||
operator|(
name|gck_rgba_dist
argument_list|(
operator|&
name|c
index|[
literal|2
index|]
argument_list|,
operator|&
name|c
index|[
literal|3
index|]
argument_list|)
operator|>=
name|threshold
operator|)
condition|)
block|{
comment|/* Calc coordinates of center subsample */
comment|/* ==================================== */
name|x2
operator|=
operator|(
name|x1
operator|+
name|x3
operator|)
operator|/
literal|2
expr_stmt|;
name|y2
operator|=
operator|(
name|y1
operator|+
name|y3
operator|)
operator|/
literal|2
expr_stmt|;
comment|/* Render sub-blocks */
comment|/* ================= */
name|num_samples
operator|+=
name|gck_render_sub_pixel
argument_list|(
name|max_depth
argument_list|,
name|depth
operator|+
literal|1
argument_list|,
name|block
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|,
name|threshold
argument_list|,
name|sub_pixel_size
argument_list|,
name|render_func
argument_list|,
operator|&
name|c
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|num_samples
operator|+=
name|gck_render_sub_pixel
argument_list|(
name|max_depth
argument_list|,
name|depth
operator|+
literal|1
argument_list|,
name|block
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x2
argument_list|,
name|y1
argument_list|,
name|x3
argument_list|,
name|y2
argument_list|,
name|threshold
argument_list|,
name|sub_pixel_size
argument_list|,
name|render_func
argument_list|,
operator|&
name|c
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|num_samples
operator|+=
name|gck_render_sub_pixel
argument_list|(
name|max_depth
argument_list|,
name|depth
operator|+
literal|1
argument_list|,
name|block
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x1
argument_list|,
name|y2
argument_list|,
name|x2
argument_list|,
name|y3
argument_list|,
name|threshold
argument_list|,
name|sub_pixel_size
argument_list|,
name|render_func
argument_list|,
operator|&
name|c
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|num_samples
operator|+=
name|gck_render_sub_pixel
argument_list|(
name|max_depth
argument_list|,
name|depth
operator|+
literal|1
argument_list|,
name|block
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|,
name|x3
argument_list|,
name|y3
argument_list|,
name|threshold
argument_list|,
name|sub_pixel_size
argument_list|,
name|render_func
argument_list|,
operator|&
name|c
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|c
index|[
literal|0
index|]
operator|.
name|a
operator|==
literal|0.0
operator|||
name|c
index|[
literal|1
index|]
operator|.
name|a
operator|==
literal|0.0
operator|||
name|c
index|[
literal|2
index|]
operator|.
name|a
operator|==
literal|0.0
operator|||
name|c
index|[
literal|3
index|]
operator|.
name|a
operator|==
literal|0.0
condition|)
block|{
name|tmpcol
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
name|tmpcol
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|tmpcol
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|weight
operator|=
literal|2.0
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|4
condition|;
name|cnt
operator|++
control|)
block|{
if|if
condition|(
name|c
index|[
name|cnt
index|]
operator|.
name|a
operator|!=
literal|0.0
condition|)
block|{
name|tmpcol
operator|.
name|r
operator|+=
name|c
index|[
name|cnt
index|]
operator|.
name|r
expr_stmt|;
name|tmpcol
operator|.
name|g
operator|+=
name|c
index|[
name|cnt
index|]
operator|.
name|g
expr_stmt|;
name|tmpcol
operator|.
name|b
operator|+=
name|c
index|[
name|cnt
index|]
operator|.
name|b
expr_stmt|;
name|weight
operator|/=
literal|2.0
expr_stmt|;
block|}
block|}
name|color
operator|->
name|r
operator|=
name|weight
operator|*
name|tmpcol
operator|.
name|r
expr_stmt|;
name|color
operator|->
name|g
operator|=
name|weight
operator|*
name|tmpcol
operator|.
name|g
expr_stmt|;
name|color
operator|->
name|b
operator|=
name|weight
operator|*
name|tmpcol
operator|.
name|b
expr_stmt|;
block|}
else|else
block|{
name|color
operator|->
name|r
operator|=
literal|0.25
operator|*
operator|(
name|c
index|[
literal|0
index|]
operator|.
name|r
operator|+
name|c
index|[
literal|1
index|]
operator|.
name|r
operator|+
name|c
index|[
literal|2
index|]
operator|.
name|r
operator|+
name|c
index|[
literal|3
index|]
operator|.
name|r
operator|)
expr_stmt|;
name|color
operator|->
name|g
operator|=
literal|0.25
operator|*
operator|(
name|c
index|[
literal|0
index|]
operator|.
name|g
operator|+
name|c
index|[
literal|1
index|]
operator|.
name|g
operator|+
name|c
index|[
literal|2
index|]
operator|.
name|g
operator|+
name|c
index|[
literal|3
index|]
operator|.
name|g
operator|)
expr_stmt|;
name|color
operator|->
name|b
operator|=
literal|0.25
operator|*
operator|(
name|c
index|[
literal|0
index|]
operator|.
name|b
operator|+
name|c
index|[
literal|1
index|]
operator|.
name|b
operator|+
name|c
index|[
literal|2
index|]
operator|.
name|b
operator|+
name|c
index|[
literal|3
index|]
operator|.
name|b
operator|)
expr_stmt|;
block|}
name|color
operator|->
name|a
operator|=
literal|0.25
operator|*
operator|(
name|c
index|[
literal|0
index|]
operator|.
name|a
operator|+
name|c
index|[
literal|1
index|]
operator|.
name|a
operator|+
name|c
index|[
literal|2
index|]
operator|.
name|a
operator|+
name|c
index|[
literal|3
index|]
operator|.
name|a
operator|)
expr_stmt|;
return|return
operator|(
name|num_samples
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Render_Sub_Pixel */
end_comment

begin_function
DECL|function|gck_adaptive_supersample_area (int x1,int y1,int x2,int y2,int max_depth,double threshold,GckRenderFunction render_func,GckPutPixelFunction put_pixel_func,GckProgressFunction progress_func)
name|gulong
name|gck_adaptive_supersample_area
parameter_list|(
name|int
name|x1
parameter_list|,
name|int
name|y1
parameter_list|,
name|int
name|x2
parameter_list|,
name|int
name|y2
parameter_list|,
name|int
name|max_depth
parameter_list|,
name|double
name|threshold
parameter_list|,
name|GckRenderFunction
name|render_func
parameter_list|,
name|GckPutPixelFunction
name|put_pixel_func
parameter_list|,
name|GckProgressFunction
name|progress_func
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|width
decl_stmt|;
comment|/* Counters, width of region */
name|int
name|xt
decl_stmt|,
name|xtt
decl_stmt|,
name|yt
decl_stmt|;
comment|/* Temporary counters */
name|int
name|sub_pixel_size
decl_stmt|;
comment|/* Numbe of samples per pixel (1D) */
name|size_t
name|row_size
decl_stmt|;
comment|/* Memory needed for one row */
name|GckRGB
name|color
decl_stmt|;
comment|/* Rendered pixel's color */
name|_GckSampleType
name|tmp_sample
decl_stmt|;
comment|/* For swapping samples */
name|_GckSampleType
modifier|*
name|top_row
decl_stmt|,
modifier|*
name|bot_row
decl_stmt|,
modifier|*
name|tmp_row
decl_stmt|;
comment|/* Sample rows */
name|_GckSampleType
modifier|*
modifier|*
name|block
decl_stmt|;
comment|/* Sample block matrix */
name|unsigned
name|long
name|num_samples
decl_stmt|;
comment|/* Initialize color */
comment|/* ================ */
name|color
operator|.
name|r
operator|=
name|color
operator|.
name|b
operator|=
name|color
operator|.
name|g
operator|=
name|color
operator|.
name|a
operator|=
literal|0.0
expr_stmt|;
comment|/* Calculate sub-pixel size */
comment|/* ======================== */
name|sub_pixel_size
operator|=
literal|1
operator|<<
name|max_depth
expr_stmt|;
comment|/* Create row arrays */
comment|/* ================= */
name|width
operator|=
name|x2
operator|-
name|x1
operator|+
literal|1
expr_stmt|;
name|row_size
operator|=
operator|(
name|sub_pixel_size
operator|*
name|width
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|_GckSampleType
argument_list|)
expr_stmt|;
name|top_row
operator|=
operator|(
name|_GckSampleType
operator|*
operator|)
name|g_malloc
argument_list|(
name|row_size
argument_list|)
expr_stmt|;
name|bot_row
operator|=
operator|(
name|_GckSampleType
operator|*
operator|)
name|g_malloc
argument_list|(
name|row_size
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
operator|(
name|sub_pixel_size
operator|*
name|width
operator|+
literal|1
operator|)
condition|;
name|x
operator|++
control|)
block|{
name|top_row
index|[
name|x
index|]
operator|.
name|ready
operator|=
literal|0
expr_stmt|;
name|top_row
index|[
name|x
index|]
operator|.
name|color
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
name|top_row
index|[
name|x
index|]
operator|.
name|color
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|top_row
index|[
name|x
index|]
operator|.
name|color
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|top_row
index|[
name|x
index|]
operator|.
name|color
operator|.
name|a
operator|=
literal|0.0
expr_stmt|;
name|bot_row
index|[
name|x
index|]
operator|.
name|ready
operator|=
literal|0
expr_stmt|;
name|bot_row
index|[
name|x
index|]
operator|.
name|color
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
name|bot_row
index|[
name|x
index|]
operator|.
name|color
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|bot_row
index|[
name|x
index|]
operator|.
name|color
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|bot_row
index|[
name|x
index|]
operator|.
name|color
operator|.
name|a
operator|=
literal|0.0
expr_stmt|;
block|}
comment|/* Allocate block matrix */
comment|/* ===================== */
name|block
operator|=
name|g_malloc
argument_list|(
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|_GckSampleType
operator|*
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Rows */
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|y
operator|++
control|)
name|block
index|[
name|y
index|]
operator|=
name|g_malloc
argument_list|(
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|_GckSampleType
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|y
operator|++
control|)
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|x
operator|++
control|)
block|{
name|block
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|ready
operator|=
literal|0
expr_stmt|;
name|block
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
operator|.
name|r
operator|=
literal|0.0
expr_stmt|;
name|block
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
operator|.
name|g
operator|=
literal|0.0
expr_stmt|;
name|block
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
operator|.
name|b
operator|=
literal|0.0
expr_stmt|;
name|block
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
operator|.
name|a
operator|=
literal|0.0
expr_stmt|;
block|}
comment|/* Render region */
comment|/* ============= */
name|num_samples
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|y
operator|=
name|y1
init|;
name|y
operator|<=
name|y2
condition|;
name|y
operator|++
control|)
block|{
comment|/* Clear the bottom row */
comment|/* ==================== */
for|for
control|(
name|xt
operator|=
literal|0
init|;
name|xt
operator|<
operator|(
name|sub_pixel_size
operator|*
name|width
operator|+
literal|1
operator|)
condition|;
name|xt
operator|++
control|)
name|bot_row
index|[
name|xt
index|]
operator|.
name|ready
operator|=
literal|0
expr_stmt|;
comment|/* Clear first column */
comment|/* ================== */
for|for
control|(
name|yt
operator|=
literal|0
init|;
name|yt
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|yt
operator|++
control|)
name|block
index|[
name|yt
index|]
index|[
literal|0
index|]
operator|.
name|ready
operator|=
literal|0
expr_stmt|;
comment|/* Render row */
comment|/* ========== */
for|for
control|(
name|x
operator|=
name|x1
init|;
name|x
operator|<=
name|x2
condition|;
name|x
operator|++
control|)
block|{
comment|/* Initialize block by clearing all but first row/column */
comment|/* ===================================================== */
for|for
control|(
name|yt
operator|=
literal|1
init|;
name|yt
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|yt
operator|++
control|)
for|for
control|(
name|xt
operator|=
literal|1
init|;
name|xt
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|xt
operator|++
control|)
name|block
index|[
name|yt
index|]
index|[
name|xt
index|]
operator|.
name|ready
operator|=
literal|0
expr_stmt|;
comment|/* Copy samples from top row to block */
comment|/* ================================== */
for|for
control|(
name|xtt
operator|=
literal|0
operator|,
name|xt
operator|=
operator|(
name|x
operator|-
name|x1
operator|)
operator|*
name|sub_pixel_size
init|;
name|xtt
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|xtt
operator|++
operator|,
name|xt
operator|++
control|)
name|block
index|[
literal|0
index|]
index|[
name|xtt
index|]
operator|=
name|top_row
index|[
name|xt
index|]
expr_stmt|;
comment|/* Render pixel on (x, y) */
comment|/* ====================== */
name|num_samples
operator|+=
name|gck_render_sub_pixel
argument_list|(
name|max_depth
argument_list|,
literal|1
argument_list|,
name|block
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|sub_pixel_size
argument_list|,
name|sub_pixel_size
argument_list|,
name|threshold
argument_list|,
name|sub_pixel_size
argument_list|,
name|render_func
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
call|(
modifier|*
name|put_pixel_func
call|)
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
comment|/* Copy block information to rows */
comment|/* ============================== */
name|top_row
index|[
operator|(
name|x
operator|-
name|x1
operator|+
literal|1
operator|)
operator|*
name|sub_pixel_size
index|]
operator|=
name|block
index|[
literal|0
index|]
index|[
name|sub_pixel_size
index|]
expr_stmt|;
for|for
control|(
name|xtt
operator|=
literal|0
operator|,
name|xt
operator|=
operator|(
name|x
operator|-
name|x1
operator|)
operator|*
name|sub_pixel_size
init|;
name|xtt
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|xtt
operator|++
operator|,
name|xt
operator|++
control|)
name|bot_row
index|[
name|xt
index|]
operator|=
name|block
index|[
name|sub_pixel_size
index|]
index|[
name|xtt
index|]
expr_stmt|;
comment|/* Swap first and last columns */
comment|/* =========================== */
for|for
control|(
name|yt
operator|=
literal|0
init|;
name|yt
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|yt
operator|++
control|)
block|{
name|tmp_sample
operator|=
name|block
index|[
name|yt
index|]
index|[
literal|0
index|]
expr_stmt|;
name|block
index|[
name|yt
index|]
index|[
literal|0
index|]
operator|=
name|block
index|[
name|yt
index|]
index|[
name|sub_pixel_size
index|]
expr_stmt|;
name|block
index|[
name|yt
index|]
index|[
name|sub_pixel_size
index|]
operator|=
name|tmp_sample
expr_stmt|;
block|}
block|}
comment|/* Swap rows */
comment|/* ========= */
name|tmp_row
operator|=
name|top_row
expr_stmt|;
name|top_row
operator|=
name|bot_row
expr_stmt|;
name|bot_row
operator|=
name|tmp_row
expr_stmt|;
comment|/* Call progress display function (if any) */
comment|/* ======================================= */
if|if
condition|(
name|progress_func
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|progress_func
call|)
argument_list|(
name|y1
argument_list|,
name|y2
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
comment|/* for */
comment|/* Free memory */
comment|/* =========== */
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
operator|(
name|sub_pixel_size
operator|+
literal|1
operator|)
condition|;
name|y
operator|++
control|)
name|g_free
argument_list|(
name|block
index|[
name|y
index|]
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|block
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|top_row
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|bot_row
argument_list|)
expr_stmt|;
return|return
operator|(
name|num_samples
operator|)
return|;
block|}
end_function

end_unit

