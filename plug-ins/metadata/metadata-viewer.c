begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * metadata.c  * Copyright (C) 2013 Hartmut Kuhse  * Copyright (C) 2016 Ben Touchette  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<gegl.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<gexiv2/gexiv2.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_define
DECL|macro|PLUG_IN_PROC
define|#
directive|define
name|PLUG_IN_PROC
value|"plug-in-metadata-viewer"
end_define

begin_define
DECL|macro|PLUG_IN_BINARY
define|#
directive|define
name|PLUG_IN_BINARY
value|"metadata-viewer"
end_define

begin_define
DECL|macro|PLUG_IN_ROLE
define|#
directive|define
name|PLUG_IN_ROLE
value|"gimp-metadata"
end_define

begin_define
DECL|macro|EXIF_PREFIX
define|#
directive|define
name|EXIF_PREFIX
value|"Exif."
end_define

begin_define
DECL|macro|IPTC_PREFIX
define|#
directive|define
name|IPTC_PREFIX
value|"Iptc."
end_define

begin_define
DECL|macro|XMP_PREFIX
define|#
directive|define
name|XMP_PREFIX
value|"Xmp."
end_define

begin_enum
enum|enum
DECL|enum|__anon2b2e903e0103
block|{
DECL|enumerator|C_XMP_TAG
name|C_XMP_TAG
init|=
literal|0
block|,
DECL|enumerator|C_XMP_VALUE
name|C_XMP_VALUE
block|,
DECL|enumerator|NUM_XMP_COLS
name|NUM_XMP_COLS
block|}
enum|;
end_enum

begin_enum
enum|enum
DECL|enum|__anon2b2e903e0203
block|{
DECL|enumerator|C_EXIF_TAG
name|C_EXIF_TAG
init|=
literal|0
block|,
DECL|enumerator|C_EXIF_VALUE
name|C_EXIF_VALUE
block|,
DECL|enumerator|NUM_EXIF_COLS
name|NUM_EXIF_COLS
block|}
enum|;
end_enum

begin_enum
enum|enum
DECL|enum|__anon2b2e903e0303
block|{
DECL|enumerator|C_IPTC_TAG
name|C_IPTC_TAG
init|=
literal|0
block|,
DECL|enumerator|C_IPTC_VALUE
name|C_IPTC_VALUE
block|,
DECL|enumerator|NUM_IPTC_COLS
name|NUM_IPTC_COLS
block|}
enum|;
end_enum

begin_comment
comment|/*  local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|metadata_viewer_dialog
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|GExiv2Metadata
modifier|*
name|metadata
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|metadata_dialog_set_metadata
parameter_list|(
name|GExiv2Metadata
modifier|*
name|metadata
parameter_list|,
name|GtkBuilder
modifier|*
name|builder
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* local variables */
end_comment

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
specifier|const
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc  */
name|NULL
block|,
comment|/* quit_proc  */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc   */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  functions  */
end_comment

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
specifier|const
name|GimpParamDef
name|metadata_args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run-mode"
block|,
literal|"Run mode { RUN-INTERACTIVE (0) }"
block|}
block|,
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Input image"
block|}
block|}
decl_stmt|;
name|gimp_install_procedure
argument_list|(
name|PLUG_IN_PROC
argument_list|,
name|N_
argument_list|(
literal|"View metadata (Exif, IPTC, XMP)"
argument_list|)
argument_list|,
literal|"View metadata information attached to the "
literal|"current image.  This can include Exif, IPTC and/or "
literal|"XMP information."
argument_list|,
literal|"Hartmut Kuhse, Michael Natterer, Ben Touchette"
argument_list|,
literal|"Hartmut Kuhse, Michael Natterer, Ben Touchette"
argument_list|,
literal|"2013, 2016"
argument_list|,
name|N_
argument_list|(
literal|"View Metadata"
argument_list|)
argument_list|,
literal|"*"
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|metadata_args
argument_list|)
argument_list|,
literal|0
argument_list|,
name|metadata_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_plugin_menu_register
argument_list|(
name|PLUG_IN_PROC
argument_list|,
literal|"<Image>/Image/Metadata"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GimpParam
name|values
index|[
literal|1
index|]
decl_stmt|;
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
name|gimp_ui_init
argument_list|(
name|PLUG_IN_BINARY
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
name|PLUG_IN_PROC
argument_list|)
condition|)
block|{
name|GimpMetadata
modifier|*
name|metadata
decl_stmt|;
name|gint32
name|image_ID
init|=
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
decl_stmt|;
name|metadata
operator|=
name|gimp_image_get_metadata
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
comment|/* Always show metadata dialog so we can add          appropriate iptc data as needed. Sometimes          license data needs to be added after the          fact and the image may not contain metadata          but should have it added as needed. */
if|if
condition|(
operator|!
name|metadata
condition|)
block|{
name|metadata
operator|=
name|gimp_metadata_new
argument_list|()
expr_stmt|;
name|gimp_image_set_metadata
argument_list|(
name|image_ID
argument_list|,
name|metadata
argument_list|)
expr_stmt|;
block|}
name|metadata_viewer_dialog
argument_list|(
name|image_ID
argument_list|,
name|GEXIV2_METADATA
argument_list|(
name|metadata
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|GIMP_PDB_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|metadata_viewer_dialog (gint32 image_id,GExiv2Metadata * metadata)
name|metadata_viewer_dialog
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|GExiv2Metadata
modifier|*
name|metadata
parameter_list|)
block|{
name|GtkBuilder
modifier|*
name|builder
decl_stmt|;
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|GtkWidget
modifier|*
name|metadata_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|content_area
decl_stmt|;
name|gchar
modifier|*
name|ui_file
decl_stmt|;
name|gchar
modifier|*
name|title
decl_stmt|;
name|gchar
modifier|*
name|name
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
name|builder
operator|=
name|gtk_builder_new
argument_list|()
expr_stmt|;
name|ui_file
operator|=
name|g_build_filename
argument_list|(
name|gimp_data_directory
argument_list|()
argument_list|,
literal|"ui"
argument_list|,
literal|"plug-ins"
argument_list|,
literal|"plug-in-metadata-viewer.ui"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gtk_builder_add_from_file
argument_list|(
name|builder
argument_list|,
name|ui_file
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|g_printerr
argument_list|(
literal|"Error occured while loading UI file!\n"
argument_list|)
expr_stmt|;
name|g_printerr
argument_list|(
literal|"Message: %s\n"
argument_list|,
name|error
operator|->
name|message
argument_list|)
expr_stmt|;
name|g_clear_error
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|ui_file
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|builder
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|g_free
argument_list|(
name|ui_file
argument_list|)
expr_stmt|;
name|name
operator|=
name|gimp_image_get_name
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|title
operator|=
name|g_strdup_printf
argument_list|(
literal|"Metadata Viewer: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|dialog
operator|=
name|gimp_dialog_new
argument_list|(
name|title
argument_list|,
literal|"gimp-metadata-viewer-dialog"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PLUG_IN_PROC
argument_list|,
name|GTK_STOCK_CLOSE
argument_list|,
name|GTK_RESPONSE_CLOSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|dialog
argument_list|,
literal|460
argument_list|,
literal|340
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|title
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_CLOSE
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|content_area
operator|=
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|)
expr_stmt|;
name|metadata_vbox
operator|=
name|GTK_WIDGET
argument_list|(
name|gtk_builder_get_object
argument_list|(
name|builder
argument_list|,
literal|"metadata-vbox"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|metadata_vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|content_area
argument_list|)
argument_list|,
name|metadata_vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|metadata_dialog_set_metadata
argument_list|(
name|metadata
argument_list|,
name|builder
argument_list|)
expr_stmt|;
name|gtk_dialog_run
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/*  private functions  */
end_comment

begin_function
specifier|static
name|void
DECL|function|metadata_dialog_set_metadata (GExiv2Metadata * metadata,GtkBuilder * builder)
name|metadata_dialog_set_metadata
parameter_list|(
name|GExiv2Metadata
modifier|*
name|metadata
parameter_list|,
name|GtkBuilder
modifier|*
name|builder
parameter_list|)
block|{
name|GtkListStore
modifier|*
name|exif_store
decl_stmt|;
name|GtkListStore
modifier|*
name|xmp_store
decl_stmt|;
name|GtkListStore
modifier|*
name|iptc_store
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|exif_data
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|iptc_data
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|xmp_data
decl_stmt|;
name|gchar
modifier|*
name|value
decl_stmt|;
name|gchar
modifier|*
name|value_utf
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|exif_store
operator|=
name|GTK_LIST_STORE
argument_list|(
name|gtk_builder_get_object
argument_list|(
name|builder
argument_list|,
literal|"exif-liststore"
argument_list|)
argument_list|)
expr_stmt|;
name|xmp_store
operator|=
name|GTK_LIST_STORE
argument_list|(
name|gtk_builder_get_object
argument_list|(
name|builder
argument_list|,
literal|"xmp-liststore"
argument_list|)
argument_list|)
expr_stmt|;
name|iptc_store
operator|=
name|GTK_LIST_STORE
argument_list|(
name|gtk_builder_get_object
argument_list|(
name|builder
argument_list|,
literal|"iptc-liststore"
argument_list|)
argument_list|)
expr_stmt|;
name|exif_data
operator|=
name|gexiv2_metadata_get_exif_tags
argument_list|(
name|metadata
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|exif_data
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|gtk_list_store_append
argument_list|(
name|exif_store
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|value
operator|=
name|gexiv2_metadata_get_tag_interpreted_string
argument_list|(
name|metadata
argument_list|,
name|exif_data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|value_utf
operator|=
name|g_locale_to_utf8
argument_list|(
name|value
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|exif_store
argument_list|,
operator|&
name|iter
argument_list|,
name|C_EXIF_TAG
argument_list|,
name|exif_data
index|[
name|i
index|]
argument_list|,
name|C_EXIF_VALUE
argument_list|,
name|value_utf
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|xmp_data
operator|=
name|gexiv2_metadata_get_xmp_tags
argument_list|(
name|metadata
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|xmp_data
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|gtk_list_store_append
argument_list|(
name|xmp_store
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|value
operator|=
name|gexiv2_metadata_get_tag_interpreted_string
argument_list|(
name|metadata
argument_list|,
name|xmp_data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|value_utf
operator|=
name|g_locale_to_utf8
argument_list|(
name|value
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|xmp_store
argument_list|,
operator|&
name|iter
argument_list|,
name|C_XMP_TAG
argument_list|,
name|xmp_data
index|[
name|i
index|]
argument_list|,
name|C_XMP_VALUE
argument_list|,
name|value_utf
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|iptc_data
operator|=
name|gexiv2_metadata_get_iptc_tags
argument_list|(
name|metadata
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|iptc_data
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|gtk_list_store_append
argument_list|(
name|iptc_store
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|value
operator|=
name|gexiv2_metadata_get_tag_interpreted_string
argument_list|(
name|metadata
argument_list|,
name|iptc_data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|value_utf
operator|=
name|g_locale_to_utf8
argument_list|(
name|value
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|iptc_store
argument_list|,
operator|&
name|iter
argument_list|,
name|C_IPTC_TAG
argument_list|,
name|iptc_data
index|[
name|i
index|]
argument_list|,
name|C_IPTC_VALUE
argument_list|,
name|value_utf
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit

