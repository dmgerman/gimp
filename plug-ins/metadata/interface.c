begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* interface.c - user interface for the metadata editor  *  * Copyright (C) 2004-2005, RaphaÃ«l Quinet<raphael@gimp.org>  *  * This library is free software: you can redistribute it and/or  * modify it under the terms of the GNU Lesser General Public  * License as published by the Free Software Foundation; either  * version 3 of the License, or (at your option) any later version.  *  * This library is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * Lesser General Public License for more details.  *  * You should have received a copy of the GNU Lesser General Public  * License along with this library.  If not, see  *<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<glib.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|G_OS_WIN32
end_ifdef

begin_include
include|#
directive|include
file|<io.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|_O_BINARY
end_ifndef

begin_define
DECL|macro|_O_BINARY
define|#
directive|define
name|_O_BINARY
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_include
include|#
directive|include
file|"xmp-schemas.h"
end_include

begin_include
include|#
directive|include
file|"xmp-model.h"
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"metadata.h"
end_include

begin_include
include|#
directive|include
file|"xmp-encode.h"
end_include

begin_include
include|#
directive|include
file|"gimpxmpmodelentry.h"
end_include

begin_define
DECL|macro|RESPONSE_IMPORT
define|#
directive|define
name|RESPONSE_IMPORT
value|1
end_define

begin_define
DECL|macro|RESPONSE_EXPORT
define|#
directive|define
name|RESPONSE_EXPORT
value|2
end_define

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon29c530f00108
block|{
DECL|member|dlg
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
DECL|member|xmp_model
name|XMPModel
modifier|*
name|xmp_model
decl_stmt|;
DECL|member|edit_icon
name|GdkPixbuf
modifier|*
name|edit_icon
decl_stmt|;
DECL|member|auto_icon
name|GdkPixbuf
modifier|*
name|auto_icon
decl_stmt|;
DECL|member|run_ok
name|gboolean
name|run_ok
decl_stmt|;
DECL|typedef|MetadataGui
block|}
name|MetadataGui
typedef|;
end_typedef

begin_function
specifier|static
name|void
DECL|function|tree_value_edited (GtkCellRendererText * cell,const gchar * path_string,const gchar * new_text,gpointer data)
name|tree_value_edited
parameter_list|(
name|GtkCellRendererText
modifier|*
name|cell
parameter_list|,
specifier|const
name|gchar
modifier|*
name|path_string
parameter_list|,
specifier|const
name|gchar
modifier|*
name|new_text
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkTreeModel
modifier|*
name|model
init|=
name|data
decl_stmt|;
name|GtkTreePath
modifier|*
name|path
init|=
name|gtk_tree_path_new_from_string
argument_list|(
name|path_string
argument_list|)
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|gchar
modifier|*
name|old_text
decl_stmt|;
name|gtk_tree_model_get_iter
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|COL_XMP_VALUE
argument_list|,
operator|&
name|old_text
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|old_text
argument_list|)
expr_stmt|;
comment|/* FIXME: update value[] array */
comment|/* FIXME: check widget xref and update other widget if not NULL */
name|gtk_tree_store_set
argument_list|(
name|GTK_TREE_STORE
argument_list|(
name|model
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|,
name|COL_XMP_VALUE
argument_list|,
name|new_text
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_tree_path_free
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_view_columns (GtkTreeView * treeview)
name|add_view_columns
parameter_list|(
name|GtkTreeView
modifier|*
name|treeview
parameter_list|)
block|{
name|gint
name|col_offset
decl_stmt|;
name|GtkCellRenderer
modifier|*
name|renderer
decl_stmt|;
name|GtkTreeViewColumn
modifier|*
name|column
decl_stmt|;
name|GtkTreeModel
modifier|*
name|model
init|=
name|gtk_tree_view_get_model
argument_list|(
name|treeview
argument_list|)
decl_stmt|;
comment|/* Property Name */
name|renderer
operator|=
name|gtk_cell_renderer_text_new
argument_list|()
expr_stmt|;
name|g_object_set
argument_list|(
name|renderer
argument_list|,
literal|"xalign"
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|col_offset
operator|=
name|gtk_tree_view_insert_column_with_attributes
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|treeview
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
name|_
argument_list|(
literal|"Property"
argument_list|)
argument_list|,
name|renderer
argument_list|,
literal|"text"
argument_list|,
name|COL_XMP_NAME
argument_list|,
literal|"weight"
argument_list|,
name|COL_XMP_WEIGHT
argument_list|,
literal|"weight-set"
argument_list|,
name|COL_XMP_WEIGHT_SET
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|column
operator|=
name|gtk_tree_view_get_column
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|treeview
argument_list|)
argument_list|,
name|col_offset
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_tree_view_column_set_clickable
argument_list|(
name|GTK_TREE_VIEW_COLUMN
argument_list|(
name|column
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* Icon */
name|renderer
operator|=
name|gtk_cell_renderer_pixbuf_new
argument_list|()
expr_stmt|;
name|col_offset
operator|=
name|gtk_tree_view_insert_column_with_attributes
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|treeview
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
literal|""
argument_list|,
name|renderer
argument_list|,
literal|"pixbuf"
argument_list|,
name|COL_XMP_EDIT_ICON
argument_list|,
literal|"visible"
argument_list|,
name|COL_XMP_VISIBLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|column
operator|=
name|gtk_tree_view_get_column
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|treeview
argument_list|)
argument_list|,
name|col_offset
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_tree_view_column_set_clickable
argument_list|(
name|GTK_TREE_VIEW_COLUMN
argument_list|(
name|column
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* Value */
name|renderer
operator|=
name|gtk_cell_renderer_text_new
argument_list|()
expr_stmt|;
name|g_object_set
argument_list|(
name|renderer
argument_list|,
literal|"xalign"
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|renderer
argument_list|,
literal|"edited"
argument_list|,
name|G_CALLBACK
argument_list|(
name|tree_value_edited
argument_list|)
argument_list|,
name|model
argument_list|)
expr_stmt|;
name|col_offset
operator|=
name|gtk_tree_view_insert_column_with_attributes
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|treeview
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
name|_
argument_list|(
literal|"Value"
argument_list|)
argument_list|,
name|renderer
argument_list|,
literal|"text"
argument_list|,
name|COL_XMP_VALUE
argument_list|,
literal|"editable"
argument_list|,
name|COL_XMP_EDITABLE
argument_list|,
literal|"visible"
argument_list|,
name|COL_XMP_VISIBLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|column
operator|=
name|gtk_tree_view_get_column
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|treeview
argument_list|)
argument_list|,
name|col_offset
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_tree_view_column_set_clickable
argument_list|(
name|GTK_TREE_VIEW_COLUMN
argument_list|(
name|column
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|icon_foreach_func (GtkTreeModel * model,GtkTreePath * path,GtkTreeIter * iter,gpointer user_data)
name|icon_foreach_func
parameter_list|(
name|GtkTreeModel
modifier|*
name|model
parameter_list|,
name|GtkTreePath
modifier|*
name|path
parameter_list|,
name|GtkTreeIter
modifier|*
name|iter
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|gboolean
name|editable
decl_stmt|;
name|MetadataGui
modifier|*
name|mgui
init|=
name|user_data
decl_stmt|;
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
name|iter
argument_list|,
name|COL_XMP_EDITABLE
argument_list|,
operator|&
name|editable
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|editable
operator|==
name|XMP_AUTO_UPDATE
condition|)
name|gtk_tree_store_set
argument_list|(
name|GTK_TREE_STORE
argument_list|(
name|model
argument_list|)
argument_list|,
name|iter
argument_list|,
name|COL_XMP_EDIT_ICON
argument_list|,
name|mgui
operator|->
name|auto_icon
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|editable
operator|==
name|TRUE
condition|)
name|gtk_tree_store_set
argument_list|(
name|GTK_TREE_STORE
argument_list|(
name|model
argument_list|)
argument_list|,
name|iter
argument_list|,
name|COL_XMP_EDIT_ICON
argument_list|,
name|mgui
operator|->
name|edit_icon
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|gtk_tree_store_set
argument_list|(
name|GTK_TREE_STORE
argument_list|(
name|model
argument_list|)
argument_list|,
name|iter
argument_list|,
name|COL_XMP_EDIT_ICON
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|update_icons (MetadataGui * mgui)
name|update_icons
parameter_list|(
name|MetadataGui
modifier|*
name|mgui
parameter_list|)
block|{
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
comment|/* add the edit icon to the rows that are editable */
name|model
operator|=
name|xmp_model_get_tree_model
argument_list|(
name|mgui
operator|->
name|xmp_model
argument_list|)
expr_stmt|;
name|gtk_tree_model_foreach
argument_list|(
name|model
argument_list|,
name|icon_foreach_func
argument_list|,
name|mgui
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* FIXME: temporary data structure for testing */
end_comment

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon29c530f00208
block|{
DECL|member|schema
specifier|const
name|gchar
modifier|*
name|schema
decl_stmt|;
DECL|member|property_name
specifier|const
name|gchar
modifier|*
name|property_name
decl_stmt|;
DECL|member|widget_list
name|GSList
modifier|*
name|widget_list
decl_stmt|;
DECL|member|mgui
name|MetadataGui
modifier|*
name|mgui
decl_stmt|;
DECL|typedef|WidgetXRef
block|}
name|WidgetXRef
typedef|;
end_typedef

begin_function
specifier|static
name|void
DECL|function|entry_changed (GtkEntry * entry,gpointer user_data)
name|entry_changed
parameter_list|(
name|GtkEntry
modifier|*
name|entry
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|WidgetXRef
modifier|*
name|xref
init|=
name|user_data
decl_stmt|;
name|xmp_model_set_scalar_property
argument_list|(
name|xref
operator|->
name|mgui
operator|->
name|xmp_model
argument_list|,
name|xref
operator|->
name|schema
argument_list|,
name|xref
operator|->
name|property_name
argument_list|,
name|gtk_entry_get_text
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|update_icons
argument_list|(
name|xref
operator|->
name|mgui
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|register_entry_xref (GtkWidget * entry,const gchar * schema,const gchar * property_name,MetadataGui * mgui)
name|register_entry_xref
parameter_list|(
name|GtkWidget
modifier|*
name|entry
parameter_list|,
specifier|const
name|gchar
modifier|*
name|schema
parameter_list|,
specifier|const
name|gchar
modifier|*
name|property_name
parameter_list|,
name|MetadataGui
modifier|*
name|mgui
parameter_list|)
block|{
name|WidgetXRef
modifier|*
name|xref
decl_stmt|;
name|xref
operator|=
name|g_new
argument_list|(
name|WidgetXRef
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|xref
operator|->
name|schema
operator|=
name|schema
expr_stmt|;
name|xref
operator|->
name|property_name
operator|=
name|property_name
expr_stmt|;
name|xref
operator|->
name|widget_list
operator|=
name|g_slist_prepend
argument_list|(
name|NULL
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|xref
operator|->
name|mgui
operator|=
name|mgui
expr_stmt|;
name|g_signal_connect
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|entry_changed
argument_list|)
argument_list|,
name|xref
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|text_changed (GtkTextBuffer * text_buffer,gpointer user_data)
name|text_changed
parameter_list|(
name|GtkTextBuffer
modifier|*
name|text_buffer
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|WidgetXRef
modifier|*
name|xref
init|=
name|user_data
decl_stmt|;
name|GtkTextIter
name|start
decl_stmt|;
name|GtkTextIter
name|end
decl_stmt|;
name|gtk_text_buffer_get_bounds
argument_list|(
name|text_buffer
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"XMP: %s %p %p %s\n"
argument_list|,
name|xref
operator|->
name|property_name
argument_list|,
name|text_buffer
argument_list|,
name|user_data
argument_list|,
name|gtk_text_buffer_get_text
argument_list|(
name|text_buffer
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FIXME */
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|register_text_xref (GtkTextBuffer * text_buffer,const gchar * schema,const gchar * property_name)
name|register_text_xref
parameter_list|(
name|GtkTextBuffer
modifier|*
name|text_buffer
parameter_list|,
specifier|const
name|gchar
modifier|*
name|schema
parameter_list|,
specifier|const
name|gchar
modifier|*
name|property_name
parameter_list|)
block|{
name|WidgetXRef
modifier|*
name|xref
decl_stmt|;
name|xref
operator|=
name|g_new
argument_list|(
name|WidgetXRef
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|xref
operator|->
name|schema
operator|=
name|schema
expr_stmt|;
name|xref
operator|->
name|property_name
operator|=
name|property_name
expr_stmt|;
name|xref
operator|->
name|widget_list
operator|=
name|g_slist_prepend
argument_list|(
name|NULL
argument_list|,
name|text_buffer
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|GTK_TEXT_BUFFER
argument_list|(
name|text_buffer
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|text_changed
argument_list|)
argument_list|,
name|xref
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_description_tab (GtkWidget * notebook,MetadataGui * mgui)
name|add_description_tab
parameter_list|(
name|GtkWidget
modifier|*
name|notebook
parameter_list|,
name|MetadataGui
modifier|*
name|mgui
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|entry
decl_stmt|;
name|GtkWidget
modifier|*
name|scrolled_window
decl_stmt|;
name|GtkWidget
modifier|*
name|text_view
decl_stmt|;
name|GtkTextBuffer
modifier|*
name|text_buffer
decl_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Description"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|frame
argument_list|,
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Description"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|5
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
comment|/* gtk_widget_show (table); */
name|entry
operator|=
name|gimp_xmp_model_entry_new
argument_list|(
name|XMP_SCHEMA_DUBLIN_CORE
argument_list|,
literal|"title"
argument_list|,
name|mgui
operator|->
name|xmp_model
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Image _title:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|entry
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|entry
operator|=
name|gimp_xmp_model_entry_new
argument_list|(
name|XMP_SCHEMA_DUBLIN_CORE
argument_list|,
literal|"creator"
argument_list|,
name|mgui
operator|->
name|xmp_model
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"_Author:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|entry
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|scrolled_window
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_shadow_type
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|)
expr_stmt|;
name|text_view
operator|=
name|gtk_text_view_new
argument_list|()
expr_stmt|;
name|text_buffer
operator|=
name|gtk_text_view_get_buffer
argument_list|(
name|GTK_TEXT_VIEW
argument_list|(
name|text_view
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_text_buffer_set_text
argument_list|(
name|text_buffer
argument_list|,
literal|"FIXME:\n"
literal|"These widgets are currently disconnected from the XMP model.\n"
literal|"Please use the Advanced tab."
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|register_text_xref
argument_list|(
name|text_buffer
argument_list|,
name|XMP_SCHEMA_DUBLIN_CORE
argument_list|,
literal|"description"
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|text_view
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|_
argument_list|(
literal|"_Description:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|scrolled_window
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|entry
operator|=
name|gimp_xmp_model_entry_new
argument_list|(
name|XMP_SCHEMA_PHOTOSHOP
argument_list|,
literal|"CaptionWriter"
argument_list|,
name|mgui
operator|->
name|xmp_model
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|_
argument_list|(
literal|"Description _writer:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|entry
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|scrolled_window
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_shadow_type
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|)
expr_stmt|;
name|text_view
operator|=
name|gtk_text_view_new
argument_list|()
expr_stmt|;
name|text_buffer
operator|=
name|gtk_text_view_get_buffer
argument_list|(
name|GTK_TEXT_VIEW
argument_list|(
name|text_view
argument_list|)
argument_list|)
expr_stmt|;
name|register_text_xref
argument_list|(
name|text_buffer
argument_list|,
name|XMP_SCHEMA_PDF
argument_list|,
literal|"Keywords"
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|text_view
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
name|_
argument_list|(
literal|"_Keywords:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|scrolled_window
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_widget_show_all
argument_list|(
name|frame
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_copyright_tab (GtkWidget * notebook)
name|add_copyright_tab
parameter_list|(
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|label
decl_stmt|;
comment|/* FIXME: add entries, cross-link with XMP model */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Empty"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|label
argument_list|,
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Copyright"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_origin_tab (GtkWidget * notebook)
name|add_origin_tab
parameter_list|(
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|label
decl_stmt|;
comment|/* FIXME: add entries, cross-link with XMP model */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Empty"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|label
argument_list|,
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Origin"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_camera1_tab (GtkWidget * notebook)
name|add_camera1_tab
parameter_list|(
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|label
decl_stmt|;
comment|/* FIXME: add entries, cross-link with XMP model */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Empty"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|label
argument_list|,
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Camera 1"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_camera2_tab (GtkWidget * notebook)
name|add_camera2_tab
parameter_list|(
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|label
decl_stmt|;
comment|/* FIXME: add entries, cross-link with XMP model */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Empty"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|label
argument_list|,
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Camera 2"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_thumbnail_tab (GtkWidget * notebook)
name|add_thumbnail_tab
parameter_list|(
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GdkPixbuf
modifier|*
name|default_thumb
decl_stmt|;
name|GtkWidget
modifier|*
name|image
decl_stmt|;
comment|/* FIXME: link thumbnail with XMP model */
name|default_thumb
operator|=
name|gtk_widget_render_icon
argument_list|(
name|notebook
argument_list|,
name|GIMP_STOCK_QUESTION
argument_list|,
operator|(
name|GtkIconSize
operator|)
operator|-
literal|1
argument_list|,
literal|"thumbnail"
argument_list|)
expr_stmt|;
name|image
operator|=
name|gtk_image_new_from_pixbuf
argument_list|(
name|default_thumb
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|image
argument_list|,
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Thumbnail"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|image
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|add_advanced_tab (GtkWidget * notebook,GtkTreeModel * model)
name|add_advanced_tab
parameter_list|(
name|GtkWidget
modifier|*
name|notebook
parameter_list|,
name|GtkTreeModel
modifier|*
name|model
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|sw
decl_stmt|;
name|GtkWidget
modifier|*
name|treeview
decl_stmt|;
comment|/* Advanced tab */
name|sw
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_shadow_type
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|sw
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|sw
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|sw
argument_list|,
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Advanced"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* create tree view - model will be unref'ed in xmp_model_free() */
name|treeview
operator|=
name|gtk_tree_view_new_with_model
argument_list|(
name|model
argument_list|)
expr_stmt|;
name|gtk_tree_view_set_rules_hint
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|treeview
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|add_view_columns
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|treeview
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|sw
argument_list|)
argument_list|,
name|treeview
argument_list|)
expr_stmt|;
comment|/* expand all rows after the treeview widget has been realized */
name|g_signal_connect
argument_list|(
name|treeview
argument_list|,
literal|"realize"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_tree_view_expand_all
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|treeview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|sw
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* show a transient message dialog */
end_comment

begin_function
specifier|static
name|void
DECL|function|metadata_message_dialog (GtkMessageType type,GtkWindow * parent,const gchar * title,const gchar * message)
name|metadata_message_dialog
parameter_list|(
name|GtkMessageType
name|type
parameter_list|,
name|GtkWindow
modifier|*
name|parent
parameter_list|,
specifier|const
name|gchar
modifier|*
name|title
parameter_list|,
specifier|const
name|gchar
modifier|*
name|message
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|dlg
operator|=
name|gtk_message_dialog_new
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
name|type
argument_list|,
name|GTK_BUTTONS_OK
argument_list|,
literal|"%s"
argument_list|,
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|title
condition|)
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|gtk_window_set_role
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"metadata-message"
argument_list|)
expr_stmt|;
name|gtk_dialog_run
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* load XMP metadata from a file (the file may contain other data) */
end_comment

begin_function
specifier|static
name|void
DECL|function|import_dialog_response (GtkWidget * dlg,gint response_id,gpointer data)
name|import_dialog_response
parameter_list|(
name|GtkWidget
modifier|*
name|dlg
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|MetadataGui
modifier|*
name|mgui
init|=
name|data
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|mgui
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|response_id
operator|==
name|GTK_RESPONSE_OK
condition|)
block|{
name|gchar
modifier|*
name|filename
decl_stmt|;
name|gchar
modifier|*
name|buffer
decl_stmt|;
name|gsize
name|buffer_length
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
name|filename
operator|=
name|gtk_file_chooser_get_filename
argument_list|(
name|GTK_FILE_CHOOSER
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|g_file_get_contents
argument_list|(
name|filename
argument_list|,
operator|&
name|buffer
argument_list|,
operator|&
name|buffer_length
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|metadata_message_dialog
argument_list|(
name|GTK_MESSAGE_ERROR
argument_list|,
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Open failed"
argument_list|)
argument_list|,
name|error
operator|->
name|message
argument_list|)
expr_stmt|;
name|g_error_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|xmp_model_parse_buffer
argument_list|(
name|mgui
operator|->
name|xmp_model
argument_list|,
name|buffer
argument_list|,
name|buffer_length
argument_list|,
name|TRUE
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|metadata_message_dialog
argument_list|(
name|GTK_MESSAGE_ERROR
argument_list|,
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Open failed"
argument_list|)
argument_list|,
name|error
operator|->
name|message
argument_list|)
expr_stmt|;
name|g_error_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
name|update_icons
argument_list|(
name|mgui
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_destroy
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
comment|/* FIXME: destroy or unmap? */
block|}
end_function

begin_comment
comment|/* select file to import */
end_comment

begin_function
specifier|static
name|void
DECL|function|file_import_dialog (GtkWidget * parent,MetadataGui * mgui)
name|file_import_dialog
parameter_list|(
name|GtkWidget
modifier|*
name|parent
parameter_list|,
name|MetadataGui
modifier|*
name|mgui
parameter_list|)
block|{
specifier|static
name|GtkWidget
modifier|*
name|dlg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|dlg
condition|)
block|{
name|dlg
operator|=
name|gtk_file_chooser_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Import XMP from File"
argument_list|)
argument_list|,
name|GTK_WINDOW
argument_list|(
name|parent
argument_list|)
argument_list|,
name|GTK_FILE_CHOOSER_ACTION_OPEN
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|GTK_STOCK_OPEN
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_dialog_set_default_response
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_widget_destroyed
argument_list|)
argument_list|,
operator|&
name|dlg
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|import_dialog_response
argument_list|)
argument_list|,
name|mgui
argument_list|)
expr_stmt|;
block|}
name|gtk_window_present
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* save XMP metadata to a file (only XMP, nothing else) */
end_comment

begin_function
specifier|static
name|void
DECL|function|export_dialog_response (GtkWidget * dlg,gint response_id,gpointer data)
name|export_dialog_response
parameter_list|(
name|GtkWidget
modifier|*
name|dlg
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|MetadataGui
modifier|*
name|mgui
init|=
name|data
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|mgui
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|response_id
operator|==
name|GTK_RESPONSE_OK
condition|)
block|{
name|GString
modifier|*
name|buffer
decl_stmt|;
name|gchar
modifier|*
name|filename
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|buffer
operator|=
name|g_string_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|xmp_generate_packet
argument_list|(
name|mgui
operator|->
name|xmp_model
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|filename
operator|=
name|gtk_file_chooser_get_filename
argument_list|(
name|GTK_FILE_CHOOSER
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|fd
operator|=
name|g_open
argument_list|(
name|filename
argument_list|,
name|O_CREAT
operator||
name|O_TRUNC
operator||
name|O_WRONLY
operator||
name|_O_BINARY
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|metadata_message_dialog
argument_list|(
name|GTK_MESSAGE_ERROR
argument_list|,
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Open failed"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Cannot create file"
argument_list|)
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|buffer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|buffer
operator|->
name|str
argument_list|,
name|buffer
operator|->
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|metadata_message_dialog
argument_list|(
name|GTK_MESSAGE_ERROR
argument_list|,
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Save failed"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Some error occurred while saving"
argument_list|)
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|buffer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|close
argument_list|(
name|fd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|metadata_message_dialog
argument_list|(
name|GTK_MESSAGE_ERROR
argument_list|,
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Save failed"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Could not close the file"
argument_list|)
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|buffer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
name|g_string_free
argument_list|(
name|buffer
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_destroy
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
comment|/* FIXME: destroy or unmap? */
block|}
end_function

begin_comment
comment|/* select file to export */
end_comment

begin_function
specifier|static
name|void
DECL|function|file_export_dialog (GtkWidget * parent,MetadataGui * mgui)
name|file_export_dialog
parameter_list|(
name|GtkWidget
modifier|*
name|parent
parameter_list|,
name|MetadataGui
modifier|*
name|mgui
parameter_list|)
block|{
specifier|static
name|GtkWidget
modifier|*
name|dlg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|dlg
condition|)
block|{
name|dlg
operator|=
name|gtk_file_chooser_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Export XMP to File"
argument_list|)
argument_list|,
name|GTK_WINDOW
argument_list|(
name|parent
argument_list|)
argument_list|,
name|GTK_FILE_CHOOSER_ACTION_SAVE
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|GTK_STOCK_SAVE
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_dialog_set_default_response
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|)
expr_stmt|;
name|gtk_file_chooser_set_do_overwrite_confirmation
argument_list|(
name|GTK_FILE_CHOOSER
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_widget_destroyed
argument_list|)
argument_list|,
operator|&
name|dlg
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|export_dialog_response
argument_list|)
argument_list|,
name|mgui
argument_list|)
expr_stmt|;
block|}
name|gtk_window_present
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|metadata_dialog_response (GtkWidget * widget,gint response_id,gpointer data)
name|metadata_dialog_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|MetadataGui
modifier|*
name|mgui
init|=
name|data
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|mgui
operator|!=
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|response_id
condition|)
block|{
case|case
name|RESPONSE_IMPORT
case|:
name|file_import_dialog
argument_list|(
name|widget
argument_list|,
name|mgui
argument_list|)
expr_stmt|;
break|break;
case|case
name|RESPONSE_EXPORT
case|:
name|file_export_dialog
argument_list|(
name|widget
argument_list|,
name|mgui
argument_list|)
expr_stmt|;
break|break;
case|case
name|GTK_RESPONSE_OK
case|:
name|mgui
operator|->
name|run_ok
operator|=
name|TRUE
expr_stmt|;
comment|/*fallthrough*/
default|default:
name|gtk_widget_destroy
argument_list|(
name|widget
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|gboolean
DECL|function|metadata_dialog (gint32 image_ID,XMPModel * xmp_model)
name|metadata_dialog
parameter_list|(
name|gint32
name|image_ID
parameter_list|,
name|XMPModel
modifier|*
name|xmp_model
parameter_list|)
block|{
name|MetadataGui
name|mgui
decl_stmt|;
name|GtkWidget
modifier|*
name|notebook
decl_stmt|;
name|gimp_ui_init
argument_list|(
name|PLUG_IN_BINARY
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|mgui
operator|.
name|dlg
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Image Properties"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|EDITOR_PROC
argument_list|,
name|_
argument_list|(
literal|"_Import XMP..."
argument_list|)
argument_list|,
name|RESPONSE_IMPORT
argument_list|,
name|_
argument_list|(
literal|"_Export XMP..."
argument_list|)
argument_list|,
name|RESPONSE_EXPORT
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|GTK_STOCK_OK
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|)
argument_list|,
name|RESPONSE_IMPORT
argument_list|,
name|RESPONSE_EXPORT
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gimp_window_set_transient
argument_list|(
name|GTK_WINDOW
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|metadata_dialog_response
argument_list|)
argument_list|,
operator|&
name|mgui
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_main_quit
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|notebook
operator|=
name|gtk_notebook_new
argument_list|()
expr_stmt|;
name|gtk_notebook_set_tab_pos
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|notebook
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|notebook
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|mgui
operator|.
name|xmp_model
operator|=
name|xmp_model
expr_stmt|;
name|mgui
operator|.
name|edit_icon
operator|=
name|gtk_widget_render_icon
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|,
name|GTK_STOCK_EDIT
argument_list|,
name|GTK_ICON_SIZE_MENU
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mgui
operator|.
name|auto_icon
operator|=
name|gtk_widget_render_icon
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|,
name|GIMP_STOCK_WILBER
argument_list|,
name|GTK_ICON_SIZE_MENU
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|update_icons
argument_list|(
operator|&
name|mgui
argument_list|)
expr_stmt|;
name|mgui
operator|.
name|run_ok
operator|=
name|FALSE
expr_stmt|;
comment|/* add the tabs to the notebook */
name|add_description_tab
argument_list|(
name|notebook
argument_list|,
operator|&
name|mgui
argument_list|)
expr_stmt|;
name|add_copyright_tab
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|add_origin_tab
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|add_camera1_tab
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|add_camera2_tab
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|add_thumbnail_tab
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|add_advanced_tab
argument_list|(
name|notebook
argument_list|,
name|xmp_model_get_tree_model
argument_list|(
name|mgui
operator|.
name|xmp_model
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_window_set_default_size
argument_list|(
name|GTK_WINDOW
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|)
argument_list|,
literal|400
argument_list|,
literal|500
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|mgui
operator|.
name|dlg
argument_list|)
expr_stmt|;
comment|/* run, baby, run! */
name|gtk_main
argument_list|()
expr_stmt|;
comment|/* clean up and return */
name|g_object_unref
argument_list|(
name|mgui
operator|.
name|auto_icon
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|mgui
operator|.
name|edit_icon
argument_list|)
expr_stmt|;
return|return
name|mgui
operator|.
name|run_ok
return|;
block|}
end_function

end_unit

