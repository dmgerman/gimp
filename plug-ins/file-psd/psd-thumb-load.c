begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * GIMP PSD Plug-in  * Copyright 2007 by John Marshall  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<https://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|"psd.h"
end_include

begin_include
include|#
directive|include
file|"psd-util.h"
end_include

begin_include
include|#
directive|include
file|"psd-image-res-load.h"
end_include

begin_include
include|#
directive|include
file|"psd-thumb-load.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_comment
comment|/*  Local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|gint
name|read_header_block
parameter_list|(
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|read_color_mode_block
parameter_list|(
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|read_image_resource_block
parameter_list|(
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GimpImage
modifier|*
name|create_gimp_image
parameter_list|(
name|PSDimage
modifier|*
name|img_a
parameter_list|,
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|add_image_resources
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Main file load function */
end_comment

begin_function
name|GimpImage
modifier|*
DECL|function|load_thumbnail_image (const gchar * filename,gint * width,gint * height,GError ** load_error)
name|load_thumbnail_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint
modifier|*
name|width
parameter_list|,
name|gint
modifier|*
name|height
parameter_list|,
name|GError
modifier|*
modifier|*
name|load_error
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|PSDimage
name|img_a
decl_stmt|;
name|GimpImage
modifier|*
name|image
init|=
name|NULL
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
comment|/* ----- Open PSD file ----- */
if|if
condition|(
name|g_stat
argument_list|(
name|filename
argument_list|,
operator|&
name|st
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|NULL
return|;
name|gimp_progress_init_printf
argument_list|(
name|_
argument_list|(
literal|"Opening thumbnail for '%s'"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Open file %s"
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|g_set_error
argument_list|(
name|load_error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|g_file_error_from_errno
argument_list|(
name|errno
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Could not open '%s' for reading: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* ----- Read the PSD file Header block ----- */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Read header block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_header_block
argument_list|(
operator|&
name|img_a
argument_list|,
name|f
argument_list|,
operator|&
name|error
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|load_error
goto|;
name|gimp_progress_update
argument_list|(
literal|0.2
argument_list|)
expr_stmt|;
comment|/* ----- Read the PSD file Color Mode block ----- */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Read color mode block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_color_mode_block
argument_list|(
operator|&
name|img_a
argument_list|,
name|f
argument_list|,
operator|&
name|error
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|load_error
goto|;
name|gimp_progress_update
argument_list|(
literal|0.4
argument_list|)
expr_stmt|;
comment|/* ----- Read the PSD file Image Resource block ----- */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Read image resource block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_image_resource_block
argument_list|(
operator|&
name|img_a
argument_list|,
name|f
argument_list|,
operator|&
name|error
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|load_error
goto|;
name|gimp_progress_update
argument_list|(
literal|0.6
argument_list|)
expr_stmt|;
comment|/* ----- Create GIMP image ----- */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Create GIMP image"
argument_list|)
expr_stmt|;
name|image
operator|=
name|create_gimp_image
argument_list|(
operator|&
name|img_a
argument_list|,
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|image
condition|)
goto|goto
name|load_error
goto|;
comment|/* ----- Add image resources ----- */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Add image resources"
argument_list|)
expr_stmt|;
if|if
condition|(
name|add_image_resources
argument_list|(
name|image
argument_list|,
operator|&
name|img_a
argument_list|,
name|f
argument_list|,
operator|&
name|error
argument_list|)
operator|<
literal|1
condition|)
goto|goto
name|load_error
goto|;
name|gimp_progress_update
argument_list|(
literal|1.0
argument_list|)
expr_stmt|;
name|gimp_image_clean_all
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|gimp_image_undo_enable
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
operator|*
name|width
operator|=
name|img_a
operator|.
name|columns
expr_stmt|;
operator|*
name|height
operator|=
name|img_a
operator|.
name|rows
expr_stmt|;
return|return
name|image
return|;
comment|/* ----- Process load errors ----- */
name|load_error
label|:
if|if
condition|(
name|error
condition|)
block|{
name|g_set_error
argument_list|(
name|load_error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error loading PSD file: %s"
argument_list|)
argument_list|,
name|error
operator|->
name|message
argument_list|)
expr_stmt|;
name|g_error_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
block|}
comment|/* Delete partially loaded image */
if|if
condition|(
name|image
condition|)
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
comment|/* Close file if Open */
if|if
condition|(
operator|!
operator|(
name|f
operator|==
name|NULL
operator|)
condition|)
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* Local functions */
end_comment

begin_function
specifier|static
name|gint
DECL|function|read_header_block (PSDimage * img_a,FILE * f,GError ** error)
name|read_header_block
parameter_list|(
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|guint16
name|version
decl_stmt|;
name|gchar
name|sig
index|[
literal|4
index|]
decl_stmt|;
name|gchar
name|buf
index|[
literal|6
index|]
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|sig
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|version
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|buf
argument_list|,
literal|6
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|img_a
operator|->
name|channels
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|img_a
operator|->
name|rows
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|img_a
operator|->
name|columns
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|img_a
operator|->
name|bps
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|img_a
operator|->
name|color_mode
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|version
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|channels
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|img_a
operator|->
name|channels
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|rows
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|img_a
operator|->
name|rows
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|columns
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|img_a
operator|->
name|columns
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|bps
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|img_a
operator|->
name|bps
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|color_mode
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|img_a
operator|->
name|color_mode
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"\n\n\tSig: %.4s\n\tVer: %d\n\tChannels: "
literal|"%d\n\tSize: %dx%d\n\tBPS: %d\n\tMode: %d\n"
argument_list|,
name|sig
argument_list|,
name|version
argument_list|,
name|img_a
operator|->
name|channels
argument_list|,
name|img_a
operator|->
name|columns
argument_list|,
name|img_a
operator|->
name|rows
argument_list|,
name|img_a
operator|->
name|bps
argument_list|,
name|img_a
operator|->
name|color_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|sig
argument_list|,
literal|"8BPS"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|version
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|img_a
operator|->
name|channels
operator|>
name|MAX_CHANNELS
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|img_a
operator|->
name|rows
operator|<
literal|1
operator|||
name|img_a
operator|->
name|rows
operator|>
name|GIMP_MAX_IMAGE_SIZE
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|img_a
operator|->
name|columns
operator|<
literal|1
operator|||
name|img_a
operator|->
name|columns
operator|>
name|GIMP_MAX_IMAGE_SIZE
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|read_color_mode_block (PSDimage * img_a,FILE * f,GError ** error)
name|read_color_mode_block
parameter_list|(
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|guint32
name|block_len
decl_stmt|;
name|guint32
name|block_start
decl_stmt|;
name|guint32
name|block_end
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|block_len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|block_len
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|block_len
argument_list|)
expr_stmt|;
name|block_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|block_end
operator|=
name|block_start
operator|+
name|block_len
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|block_end
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|read_image_resource_block (PSDimage * img_a,FILE * f,GError ** error)
name|read_image_resource_block
parameter_list|(
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|guint32
name|block_len
decl_stmt|;
name|guint32
name|block_end
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|block_len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|img_a
operator|->
name|image_res_len
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|block_len
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Image resource block size = %d"
argument_list|,
operator|(
name|int
operator|)
name|img_a
operator|->
name|image_res_len
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|image_res_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|block_end
operator|=
name|img_a
operator|->
name|image_res_start
operator|+
name|img_a
operator|->
name|image_res_len
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|block_end
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|GimpImage
modifier|*
DECL|function|create_gimp_image (PSDimage * img_a,const gchar * filename)
name|create_gimp_image
parameter_list|(
name|PSDimage
modifier|*
name|img_a
parameter_list|,
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|)
block|{
name|GimpImage
modifier|*
name|image
init|=
name|NULL
decl_stmt|;
name|img_a
operator|->
name|base_type
operator|=
name|GIMP_RGB
expr_stmt|;
comment|/* Create gimp image */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Create image"
argument_list|)
expr_stmt|;
name|image
operator|=
name|gimp_image_new
argument_list|(
name|img_a
operator|->
name|columns
argument_list|,
name|img_a
operator|->
name|rows
argument_list|,
name|img_a
operator|->
name|base_type
argument_list|)
expr_stmt|;
name|gimp_image_set_filename
argument_list|(
name|image
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gimp_image_undo_disable
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
name|image
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|add_image_resources (GimpImage * image,PSDimage * img_a,FILE * f,GError ** error)
name|add_image_resources
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|PSDimageres
name|res_a
decl_stmt|;
name|gint
name|status
decl_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|img_a
operator|->
name|image_res_start
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|ftell
argument_list|(
name|f
argument_list|)
operator|<
name|img_a
operator|->
name|image_res_start
operator|+
name|img_a
operator|->
name|image_res_len
condition|)
block|{
if|if
condition|(
name|get_image_resource_header
argument_list|(
operator|&
name|res_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|res_a
operator|.
name|data_start
operator|+
name|res_a
operator|.
name|data_len
operator|>
name|img_a
operator|->
name|image_res_start
operator|+
name|img_a
operator|->
name|image_res_len
condition|)
return|return
literal|0
return|;
name|status
operator|=
name|load_thumbnail_resource
argument_list|(
operator|&
name|res_a
argument_list|,
name|image
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
comment|/* Error */
if|if
condition|(
name|status
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Thumbnail Loaded */
if|if
condition|(
name|status
operator|>
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit

