begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * GIMP PSD Plug-in  * Copyright 2007 by John Marshall  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_comment
comment|/* ----- Known Layer Resource Block Types -----   All layer resources not otherwise handled, including unknown types   are dropped with a warning.   * Adjustment layer IDs *   PSD_LADJ_LEVEL          "levl"    Drop Layer  * Adjustment layer - levels (PS4) *   PSD_LADJ_CURVE          "curv"    Drop Layer  * Adjustment layer - curves (PS4) *   PSD_LADJ_BRIGHTNESS     "brit"    Drop Layer  * Adjustment layer - brightness contrast (PS4) *   PSD_LADJ_BALANCE        "blnc"    Drop Layer  * Adjustment layer - color balance (PS4) *   PSD_LADJ_BLACK_WHITE    "blwh"    Drop Layer  * Adjustment layer - black& white (PS10) *   PSD_LADJ_HUE            "hue "    Drop Layer  * Adjustment layer - old hue saturation (PS4) *   PSD_LADJ_HUE2           "hue2"    Drop Layer  * Adjustment layer - hue saturation (PS5) *   PSD_LADJ_SELECTIVE      "selc"    Drop Layer  * Adjustment layer - selective color (PS4) *   PSD_LADJ_MIXER          "mixr"    Drop Layer  * Adjustment layer - channel mixer (PS9) *   PSD_LADJ_GRAD_MAP       "grdm"    Drop Layer  * Adjustment layer - gradient map (PS9) *   PSD_LADJ_PHOTO_FILT     "phfl"    Drop Layer  * Adjustment layer - photo filter (PS9) *   PSD_LADJ_EXPOSURE       "expA"    Drop Layer  * Adjustment layer - exposure (PS10) *   PSD_LADJ_INVERT         "nvrt"    Drop Layer  * Adjustment layer - invert (PS4) *   PSD_LADJ_THRESHOLD      "thrs"    Drop Layer  * Adjustment layer - threshold (PS4) *   PSD_LADJ_POSTERIZE      "post"    Drop Layer  * Adjustment layer - posterize (PS4) *   * Fill Layer IDs *   PSD_LFIL_SOLID          "SoCo"        -       * Solid color sheet setting (PS6) *   PSD_LFIL_PATTERN        "PtFl"        -       * Pattern fill setting (PS6) *   PSD_LFIL_GRADIENT       "GdFl"        -       * Gradient fill setting (PS6) *   * Effects Layer IDs *   PSD_LFX_FX              "lrFX"        -       * Effects layer info (PS5) *   PSD_LFX_FX2             "lfx2"        -       * Object based effects layer info (PS6) *   * Type Tool Layers *   PSD_LTYP_TYPE           "tySh"        -       * Type tool layer (PS5) *   PSD_LTYP_TYPE2          "TySh"        -       * Type tool object setting (PS6) *   * Layer Properties *   PSD_LPRP_UNICODE        "luni"     Loaded     * Unicode layer name (PS5) *   PSD_LPRP_SOURCE         "lnsr"     Loaded     * Layer name source setting (PS6) *   PSD_LPRP_ID             "lyid"     Loaded     * Layer ID (PS5) *   PSD_LPRP_BLEND_CLIP     "clbl"        -       * Blend clipping elements (PS6) *   PSD_LPRP_BLEND_INT      "infx"        -       * Blend interior elements (PS6) *   PSD_LPRP_KNOCKOUT       "knko"        -       * Knockout setting (PS6) *   PSD_LPRP_PROTECT        "lspf"        -       * Protected setting (PS6) *   PSD_LPRP_COLOR          "lclr"        -       * Sheet color setting (PS6) *   PSD_LPRP_REF_POINT      "fxrp"        -       * Reference point (PS6) *   * Vector mask *   PSD_LMSK_VMASK          "vmsk"        -       * Vector mask setting (PS6) *   * Parasites *   PSD_LPAR_ANNOTATE       "Anno"        -       * Annotation (PS6) *   * Other *   PSD_LOTH_PATTERN        "Patt"        -       * Patterns (PS6) *   PSD_LOTH_GRADIENT       "grdm"        -       * Gradient settings (PS6) *   PSD_LOTH_SECTION        "lsct"     Loaded     * Section divider setting (PS6) (Layer Groups) *   PSD_LOTH_RESTRICT       "brst"        -       * Channel blending restriction setting (PS6) *   PSD_LOTH_FOREIGN_FX     "ffxi"        -       * Foreign effect ID (PS6) *   PSD_LOTH_PATT_DATA      "shpa"        -       * Pattern data (PS6) *   PSD_LOTH_META_DATA      "shmd"        -       * Meta data setting (PS6) *   PSD_LOTH_LAYER_DATA     "layr"        -       * Layer data (PS6) *   * Effects layer resource IDs *   PSD_LFX_COMMON          "cmnS"        -       * Effects layer - common state (PS5) *   PSD_LFX_DROP_SDW        "dsdw"        -       * Effects layer - drop shadow (PS5) *   PSD_LFX_INNER_SDW       "isdw"        -       * Effects layer - inner shadow (PS5) *   PSD_LFX_OUTER_GLW       "oglw"        -       * Effects layer - outer glow (PS5) *   PSD_LFX_INNER_GLW       "iglw"        -       * Effects layer - inner glow (PS5) *   PSD_LFX_BEVEL           "bevl"        -       * Effects layer - bevel (PS5) * */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|"psd.h"
end_include

begin_include
include|#
directive|include
file|"psd-util.h"
end_include

begin_include
include|#
directive|include
file|"psd-layer-res-load.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_comment
comment|/*  Local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|gint
name|load_resource_unknown
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_ladj
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lfil
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lfx
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_ltyp
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_luni
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lyid
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lsct
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Public Functions */
end_comment

begin_function
name|gint
DECL|function|get_layer_resource_header (PSDlayerres * res_a,FILE * f,GError ** error)
name|get_layer_resource_header
parameter_list|(
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
if|if
condition|(
name|fread
argument_list|(
name|res_a
operator|->
name|sig
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res_a
operator|->
name|data_len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res_a
operator|->
name|data_len
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
name|res_a
operator|->
name|data_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Sig: %.4s, key: %.4s, start: %d, len: %d"
argument_list|,
name|res_a
operator|->
name|sig
argument_list|,
name|res_a
operator|->
name|key
argument_list|,
name|res_a
operator|->
name|data_start
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|gint
DECL|function|load_layer_resource (PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_layer_resource
parameter_list|(
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Set file position to start of layer resource data block */
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|res_a
operator|->
name|data_start
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Process layer resource blocks */
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|sig
argument_list|,
literal|"8BIM"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Unknown layer resource signature %.4s"
argument_list|,
name|res_a
operator|->
name|sig
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_LEVEL
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_CURVE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_BRIGHTNESS
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_BALANCE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_BLACK_WHITE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_HUE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_HUE2
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_SELECTIVE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_MIXER
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_GRAD_MAP
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_PHOTO_FILT
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_EXPOSURE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_THRESHOLD
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_INVERT
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_POSTERIZE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_ladj
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFIL_SOLID
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFIL_PATTERN
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFIL_GRADIENT
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lfil
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFX_FX
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFX_FX2
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lfx
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LTYP_TYPE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LTYP_TYPE2
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_ltyp
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LPRP_UNICODE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_luni
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LPRP_ID
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lyid
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LOTH_SECTION
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lsct
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
else|else
name|load_resource_unknown
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
comment|/* Set file position to end of layer resource block */
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|res_a
operator|->
name|data_start
operator|+
name|res_a
operator|->
name|data_len
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Private Functions */
end_comment

begin_function
specifier|static
name|gint
DECL|function|load_resource_unknown (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_unknown
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process unknown layer resource block: %.4s"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_ladj (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_ladj
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load adjustment layer */
specifier|static
name|gboolean
name|msg_flag
init|=
name|FALSE
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Adjustment layer"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
name|lyr_a
operator|->
name|drop
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|msg_flag
operator|&&
name|CONVERSION_WARNINGS
condition|)
block|{
name|g_message
argument_list|(
literal|"Warning:\n"
literal|"The image file contains adjustment layers. "
literal|"These are not supported by the GIMP and will "
literal|"be dropped."
argument_list|)
expr_stmt|;
name|msg_flag
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lfil (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lfil
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load fill layer */
specifier|static
name|gboolean
name|msg_flag
init|=
name|FALSE
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Fill layer"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg_flag
operator|&&
name|CONVERSION_WARNINGS
condition|)
block|{
name|g_message
argument_list|(
literal|"Warning:\n"
literal|"The image file contains fill layers. "
literal|"These are not supported by the GIMP and will "
literal|"be rasterized."
argument_list|)
expr_stmt|;
name|msg_flag
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lfx (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lfx
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer effects */
specifier|static
name|gboolean
name|msg_flag
init|=
name|FALSE
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Layer effects"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg_flag
operator|&&
name|CONVERSION_WARNINGS
condition|)
block|{
name|g_message
argument_list|(
literal|"Warning:\n"
literal|"The image file contains layer effects. "
literal|"These are not supported by the GIMP and will "
literal|"be dropped."
argument_list|)
expr_stmt|;
name|msg_flag
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_ltyp (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_ltyp
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load type tool layer */
name|gint16
name|version
decl_stmt|;
name|gint16
name|text_desc_vers
decl_stmt|;
name|gint32
name|desc_version
decl_stmt|;
name|guint64
name|t_xx
decl_stmt|;
name|guint64
name|t_xy
decl_stmt|;
name|guint64
name|t_yx
decl_stmt|;
name|guint64
name|t_yy
decl_stmt|;
name|guint64
name|t_tx
decl_stmt|;
name|guint64
name|t_ty
decl_stmt|;
name|gdouble
name|transform_xx
decl_stmt|;
name|gdouble
name|transform_xy
decl_stmt|;
name|gdouble
name|transform_yx
decl_stmt|;
name|gdouble
name|transform_yy
decl_stmt|;
name|gdouble
name|transform_tx
decl_stmt|;
name|gdouble
name|transform_ty
decl_stmt|;
specifier|static
name|gboolean
name|msg_flag
init|=
name|FALSE
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Type tool layer"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg_flag
operator|&&
name|CONVERSION_WARNINGS
condition|)
block|{
name|g_message
argument_list|(
literal|"Warning:\n"
literal|"The image file contains type tool layers. "
literal|"These are not supported by the GIMP and will "
literal|"be dropped."
argument_list|)
expr_stmt|;
name|msg_flag
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* New style type tool layers (ps6) */
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LTYP_TYPE2
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|version
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_xx
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_xy
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_yx
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_yy
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_tx
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_ty
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|text_desc_vers
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|desc_version
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|version
operator|=
name|GINT16_FROM_BE
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|text_desc_vers
operator|=
name|GINT16_FROM_BE
argument_list|(
name|text_desc_vers
argument_list|)
expr_stmt|;
name|desc_version
operator|=
name|GINT32_FROM_BE
argument_list|(
name|desc_version
argument_list|)
expr_stmt|;
comment|//      t_xx = GUINT64_FROM_BE (t_xx);
comment|//      t_xy = GUINT64_FROM_BE (t_xy);
comment|//      t_yx = GUINT64_FROM_BE (t_yx);
comment|//      t_yy = GUINT64_FROM_BE (t_yy);
comment|//      t_tx = GUINT64_FROM_BE (t_tx);
comment|//      t_ty = GUINT64_FROM_BE (t_ty);
name|transform_xx
operator|=
name|t_xx
operator|>>
literal|11
expr_stmt|;
name|transform_xy
operator|=
name|t_xy
operator|>>
literal|11
expr_stmt|;
name|transform_yx
operator|=
name|t_yx
operator|>>
literal|11
expr_stmt|;
name|transform_yy
operator|=
name|t_yy
operator|>>
literal|11
expr_stmt|;
name|transform_tx
operator|=
name|t_tx
operator|>>
literal|11
expr_stmt|;
name|transform_ty
operator|=
name|t_ty
operator|>>
literal|11
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Version: %d, Text desc. vers.: %d, Desc. vers.: %d"
argument_list|,
name|version
argument_list|,
name|text_desc_vers
argument_list|,
name|desc_version
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Transform\n\txx: %f\n\txy: %f\n\tyx: %f"
literal|"\n\tyy: %f\n\ttx: %f\n\tty: %f"
argument_list|,
name|transform_xx
argument_list|,
name|transform_xy
argument_list|,
name|transform_yx
argument_list|,
name|transform_yy
argument_list|,
name|transform_tx
argument_list|,
name|transform_ty
argument_list|)
expr_stmt|;
comment|//      classID = fread_unicode_string (&read_len,&write_len, 4, f);
comment|//      IFDBG(2) g_debug ("Unicode name: %s", classID);
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_luni (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_luni
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer name in unicode (length padded to multiple of 4 bytes) */
name|gint32
name|read_len
decl_stmt|;
name|gint32
name|write_len
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block luni: Unicode Name"
argument_list|)
expr_stmt|;
if|if
condition|(
name|lyr_a
operator|->
name|name
condition|)
name|g_free
argument_list|(
name|lyr_a
operator|->
name|name
argument_list|)
expr_stmt|;
name|lyr_a
operator|->
name|name
operator|=
name|fread_unicode_string
argument_list|(
operator|&
name|read_len
argument_list|,
operator|&
name|write_len
argument_list|,
literal|4
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|error
condition|)
return|return
operator|-
literal|1
return|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Unicode name: %s"
argument_list|,
name|lyr_a
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lyid (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lyid
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer id (tattoo) */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block lyid: Layer ID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|lyr_a
operator|->
name|id
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|lyr_a
operator|->
name|id
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|lyr_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Layer id: %i"
argument_list|,
name|lyr_a
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lsct (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lsct
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer group& type information    * Type 0: not a group    * Type 1: Open folder    * Type 2: Closed folder    * Type 3: End of most recent group */
name|guint32
name|type
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Section divider"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|type
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Section divider type: %i"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|lyr_a
operator|->
name|group_type
operator|=
name|type
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit

