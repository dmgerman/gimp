begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * GIMP PSD Plug-in  * Copyright 2007 by John Marshall  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_comment
comment|/* ----- Known Layer Resource Block Types -----   All layer resources not otherwise handled, including unknown types   are dropped with a warning.    * Adjustment layer IDs *   PSD_LADJ_LEVEL          "levl"    Drop Layer  * Adjustment layer - levels (PS4) *   PSD_LADJ_CURVE          "curv"    Drop Layer  * Adjustment layer - curves (PS4) *   PSD_LADJ_BRIGHTNESS     "brit"    Drop Layer  * Adjustment layer - brightness contrast (PS4) *   PSD_LADJ_BALANCE        "blnc"    Drop Layer  * Adjustment layer - color balance (PS4) *   PSD_LADJ_BLACK_WHITE    "blwh"    Drop Layer  * Adjustment layer - black& white (PS10) *   PSD_LADJ_HUE            "hue "    Drop Layer  * Adjustment layer - old hue saturation (PS4) *   PSD_LADJ_HUE2           "hue2"    Drop Layer  * Adjustment layer - hue saturation (PS5) *   PSD_LADJ_SELECTIVE      "selc"    Drop Layer  * Adjustment layer - selective color (PS4) *   PSD_LADJ_MIXER          "mixr"    Drop Layer  * Adjustment layer - channel mixer (PS9) *   PSD_LADJ_GRAD_MAP       "grdm"    Drop Layer  * Adjustment layer - gradient map (PS9) *   PSD_LADJ_PHOTO_FILT     "phfl"    Drop Layer  * Adjustment layer - photo filter (PS9) *   PSD_LADJ_EXPOSURE       "expA"    Drop Layer  * Adjustment layer - exposure (PS10) *   PSD_LADJ_INVERT         "nvrt"    Drop Layer  * Adjustment layer - invert (PS4) *   PSD_LADJ_THRESHOLD      "thrs"    Drop Layer  * Adjustment layer - threshold (PS4) *   PSD_LADJ_POSTERIZE      "post"    Drop Layer  * Adjustment layer - posterize (PS4) *   PSD_LADJ_VIBRANCE       "vibA"        -       * Adjustment layer - vibrance (PS10) *   PSD_LADJ_COLOR_LOOKUP   "clrL"        -       * Adjustment layer - color lookup (PS13) *    * Fill Layer IDs *   PSD_LFIL_SOLID          "SoCo"        -       * Solid color sheet setting (PS6) *   PSD_LFIL_PATTERN        "PtFl"        -       * Pattern fill setting (PS6) *   PSD_LFIL_GRADIENT       "GdFl"        -       * Gradient fill setting (PS6) *    * Effects Layer IDs *   PSD_LFX_FX              "lrFX"        -       * Effects layer info (PS5) *   PSD_LFX_FX2             "lfx2"        -       * Object based effects layer info (PS6) *    * Type Tool Layers *   PSD_LTYP_TYPE           "tySh"        -       * Type tool layer (PS5) *   PSD_LTYP_TYPE2          "TySh"        -       * Type tool object setting (PS6) *    * Layer Properties *   PSD_LPRP_UNICODE        "luni"     Loaded     * Unicode layer name (PS5) *   PSD_LPRP_SOURCE         "lnsr"     Loaded     * Layer name source setting (PS6) *   PSD_LPRP_ID             "lyid"     Loaded     * Layer ID (PS5) *   PSD_LPRP_BLEND_CLIP     "clbl"        -       * Blend clipping elements (PS6) *   PSD_LPRP_BLEND_INT      "infx"        -       * Blend interior elements (PS6) *   PSD_LPRP_KNOCKOUT       "knko"        -       * Knockout setting (PS6) *   PSD_LPRP_PROTECT        "lspf"        -       * Protected setting (PS6) *   PSD_LPRP_COLOR          "lclr"        -       * Sheet color setting (PS6) *   PSD_LPRP_REF_POINT      "fxrp"        -       * Reference point (PS6) *   PSD_LPRP_VERSION        "lyvr"     Loaded     * Layer version (PS7) *    * Vector mask *   PSD_LMSK_VMASK          "vmsk"        -       * Vector mask setting (PS6) *    * Parasites *   PSD_LPAR_ANNOTATE       "Anno"        -       * Annotation (PS6) *    * Other *   PSD_LOTH_PATTERN        "Patt"        -       * Patterns (PS6) *   PSD_LOTH_GRADIENT       "grdm"        -       * Gradient settings (PS6) *   PSD_LOTH_SECTION        "lsct"     Loaded     * Section divider setting (PS6) (Layer Groups) *   PSD_LOTH_RESTRICT       "brst"        -       * Channel blending restriction setting (PS6) *   PSD_LOTH_FOREIGN_FX     "ffxi"        -       * Foreign effect ID (PS6) *   PSD_LOTH_PATT_DATA      "shpa"        -       * Pattern data (PS6) *   PSD_LOTH_META_DATA      "shmd"        -       * Meta data setting (PS6) *   PSD_LOTH_LAYER_DATA     "layr"        -       * Layer data (PS6) *   PSD_LOTH_CONTENT_GEN    "CgEd"        -       * Content generator extra data (PS12) *   PSD_LOTH_TEXT_ENGINE    "Txt2"        -       * Text engine data (PS10) *   PSD_LOTH_PATH_NAME      "pths"        -       * Unicode path name (PS13) *   PSD_LOTH_ANIMATION_FX   "anFX"        -       * Animation effects (PS13) *   PSD_LOTH_FILTER_MASK    "FMsk"        -       * Filter mask (PS10) *   PSD_LOTH_VECTOR_STROKE  "vscg"        -       * Vector stroke data (PS13) *   PSD_LOTH_ALIGN_RENDER   "sn2P"        -       * Aligned rendering flag (?) *   PSD_LOTH_USER_MASK      "LMsk"        -       * User mask (?) *    * Effects layer resource IDs *   PSD_LFX_COMMON          "cmnS"        -       * Effects layer - common state (PS5) *   PSD_LFX_DROP_SDW        "dsdw"        -       * Effects layer - drop shadow (PS5) *   PSD_LFX_INNER_SDW       "isdw"        -       * Effects layer - inner shadow (PS5) *   PSD_LFX_OUTER_GLW       "oglw"        -       * Effects layer - outer glow (PS5) *   PSD_LFX_INNER_GLW       "iglw"        -       * Effects layer - inner glow (PS5) *   PSD_LFX_BEVEL           "bevl"        -       * Effects layer - bevel (PS5) *    * New stuff temporarily until I can get them sorted out *    * Placed Layer *  PSD_LPL_PLACE_LAYER      "plLd"        -       * Placed layer (?) *  PSD_LPL_PLACE_LAYER_NEW  "SoLd"        -       * Placed layer (PS10) *   * Linked Layer *  PSD_LLL_LINKED_LAYER     "lnkD"        -       * Linked layer (?) *  PSD_LLL_LINKED_LAYER_2   "lnk2"        -       * Linked layer 2nd key *  PSD_LLL_LINKED_LAYER_3   "lnk3"        -       * Linked layer 3rd key *   * Merged Transparency *  PSD_LMT_MERGE_TRANS      "Mtrn"        -       * Merged transperency save flag (?) *  PSD_LMT_MERGE_TRANS_16   "Mt16"        -       * Merged transperency save flag 2 *  PSD_LMT_MERGE_TRANS_32   "Mt32"        -       * Merged transperency save flag 3 *   * Filter Effects *  PSD_LFFX_FILTER_FX       "FXid"        -       * Filter effects (?) *  PSD_LFFX_FILTER_FX_2     "FEid"        -       * Filter effects 2 * */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|"psd.h"
end_include

begin_include
include|#
directive|include
file|"psd-util.h"
end_include

begin_include
include|#
directive|include
file|"psd-layer-res-load.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_comment
comment|/*  Local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|gint
name|load_resource_unknown
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_ladj
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lfil
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lfx
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_ltyp
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_luni
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lyid
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lclr
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lsct
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lrfx
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lyvr
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_lnsr
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Public Functions */
end_comment

begin_function
name|gint
DECL|function|get_layer_resource_header (PSDlayerres * res_a,FILE * f,GError ** error)
name|get_layer_resource_header
parameter_list|(
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
if|if
condition|(
name|fread
argument_list|(
name|res_a
operator|->
name|sig
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res_a
operator|->
name|data_len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res_a
operator|->
name|data_len
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
name|res_a
operator|->
name|data_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Sig: %.4s, key: %.4s, start: %d, len: %d"
argument_list|,
name|res_a
operator|->
name|sig
argument_list|,
name|res_a
operator|->
name|key
argument_list|,
name|res_a
operator|->
name|data_start
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|gint
DECL|function|load_layer_resource (PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_layer_resource
parameter_list|(
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Set file position to start of layer resource data block */
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|res_a
operator|->
name|data_start
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Process layer resource blocks */
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|sig
argument_list|,
literal|"8BIM"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Unknown layer resource signature %.4s"
argument_list|,
name|res_a
operator|->
name|sig
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_LEVEL
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_CURVE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_BRIGHTNESS
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_BALANCE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_BLACK_WHITE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_HUE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_HUE2
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_SELECTIVE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_MIXER
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_GRAD_MAP
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_PHOTO_FILT
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_EXPOSURE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_THRESHOLD
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_INVERT
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LADJ_POSTERIZE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_ladj
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFIL_SOLID
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFIL_PATTERN
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFIL_GRADIENT
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lfil
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFX_FX
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFX_FX2
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lfx
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LTYP_TYPE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LTYP_TYPE2
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_ltyp
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LPRP_UNICODE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_luni
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LPRP_ID
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lyid
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LPRP_COLOR
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lclr
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LOTH_SECTION
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lsct
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LFX_FX
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lrfx
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LPRP_VERSION
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lyvr
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LPRP_SOURCE
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|load_resource_lnsr
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
else|else
name|load_resource_unknown
argument_list|(
name|res_a
argument_list|,
name|lyr_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
comment|/* Set file position to end of layer resource block */
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|res_a
operator|->
name|data_start
operator|+
name|res_a
operator|->
name|data_len
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Private Functions */
end_comment

begin_function
specifier|static
name|gint
DECL|function|load_resource_unknown (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_unknown
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process unknown layer resource block: %.4s"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_ladj (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_ladj
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load adjustment layer */
specifier|static
name|gboolean
name|msg_flag
init|=
name|FALSE
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Adjustment layer"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
name|lyr_a
operator|->
name|drop
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|msg_flag
operator|&&
name|CONVERSION_WARNINGS
condition|)
block|{
name|g_message
argument_list|(
literal|"Warning:\n"
literal|"The image file contains adjustment layers. "
literal|"These are not supported by the GIMP and will "
literal|"be dropped."
argument_list|)
expr_stmt|;
name|msg_flag
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lfil (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lfil
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load fill layer */
specifier|static
name|gboolean
name|msg_flag
init|=
name|FALSE
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Fill layer"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg_flag
operator|&&
name|CONVERSION_WARNINGS
condition|)
block|{
name|g_message
argument_list|(
literal|"Warning:\n"
literal|"The image file contains fill layers. "
literal|"These are not supported by the GIMP and will "
literal|"be rasterized."
argument_list|)
expr_stmt|;
name|msg_flag
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lfx (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lfx
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer effects */
specifier|static
name|gboolean
name|msg_flag
init|=
name|FALSE
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Layer effects"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg_flag
operator|&&
name|CONVERSION_WARNINGS
condition|)
block|{
name|g_message
argument_list|(
literal|"Warning:\n"
literal|"The image file contains layer effects. "
literal|"These are not supported by the GIMP and will "
literal|"be dropped."
argument_list|)
expr_stmt|;
name|msg_flag
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_ltyp (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_ltyp
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load type tool layer */
name|gint16
name|version
decl_stmt|;
name|gint16
name|text_desc_vers
decl_stmt|;
name|gint32
name|desc_version
decl_stmt|;
name|gint32
name|read_len
decl_stmt|;
name|gint32
name|write_len
decl_stmt|;
name|guint64
name|t_xx
decl_stmt|;
name|guint64
name|t_xy
decl_stmt|;
name|guint64
name|t_yx
decl_stmt|;
name|guint64
name|t_yy
decl_stmt|;
name|guint64
name|t_tx
decl_stmt|;
name|guint64
name|t_ty
decl_stmt|;
name|gchar
modifier|*
name|classID
decl_stmt|;
specifier|static
name|gboolean
name|msg_flag
init|=
name|FALSE
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Type tool layer"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg_flag
operator|&&
name|CONVERSION_WARNINGS
condition|)
block|{
name|g_message
argument_list|(
literal|"Warning:\n"
literal|"The image file contains type tool layers. "
literal|"These are not supported by the GIMP and will "
literal|"be dropped."
argument_list|)
expr_stmt|;
name|msg_flag
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* New style type tool layers (ps6) */
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|key
argument_list|,
name|PSD_LTYP_TYPE2
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|version
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_xx
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_xy
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_yx
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_yy
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_tx
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|t_ty
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|text_desc_vers
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|desc_version
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|version
operator|=
name|GINT16_FROM_BE
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|text_desc_vers
operator|=
name|GINT16_FROM_BE
argument_list|(
name|text_desc_vers
argument_list|)
expr_stmt|;
name|desc_version
operator|=
name|GINT32_FROM_BE
argument_list|(
name|desc_version
argument_list|)
expr_stmt|;
comment|//      t_xx = GUINT64_FROM_BE (t_xx);
comment|//      t_xy = GUINT64_FROM_BE (t_xy);
comment|//      t_yx = GUINT64_FROM_BE (t_yx);
comment|//      t_yy = GUINT64_FROM_BE (t_yy);
comment|//      t_tx = GUINT64_FROM_BE (t_tx);
comment|//      t_ty = GUINT64_FROM_BE (t_ty);
name|lyr_a
operator|->
name|text
operator|.
name|xx
operator|=
name|t_xx
operator|>>
literal|11
expr_stmt|;
name|lyr_a
operator|->
name|text
operator|.
name|xy
operator|=
name|t_xy
operator|>>
literal|11
expr_stmt|;
name|lyr_a
operator|->
name|text
operator|.
name|yx
operator|=
name|t_yx
operator|>>
literal|11
expr_stmt|;
name|lyr_a
operator|->
name|text
operator|.
name|yy
operator|=
name|t_yy
operator|>>
literal|11
expr_stmt|;
name|lyr_a
operator|->
name|text
operator|.
name|tx
operator|=
name|t_tx
operator|>>
literal|11
expr_stmt|;
name|lyr_a
operator|->
name|text
operator|.
name|ty
operator|=
name|t_ty
operator|>>
literal|11
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Version: %d, Text desc. vers.: %d, Desc. vers.: %d"
argument_list|,
name|version
argument_list|,
name|text_desc_vers
argument_list|,
name|desc_version
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Transform\n\txx: %f\n\txy: %f\n\tyx: %f"
literal|"\n\tyy: %f\n\ttx: %f\n\tty: %f"
argument_list|,
name|lyr_a
operator|->
name|text
operator|.
name|xx
argument_list|,
name|lyr_a
operator|->
name|text
operator|.
name|xy
argument_list|,
name|lyr_a
operator|->
name|text
operator|.
name|yx
argument_list|,
name|lyr_a
operator|->
name|text
operator|.
name|yy
argument_list|,
name|lyr_a
operator|->
name|text
operator|.
name|tx
argument_list|,
name|lyr_a
operator|->
name|text
operator|.
name|ty
argument_list|)
expr_stmt|;
name|classID
operator|=
name|fread_unicode_string
argument_list|(
operator|&
name|read_len
argument_list|,
operator|&
name|write_len
argument_list|,
literal|4
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Unicode name: %s"
argument_list|,
name|classID
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_luni (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_luni
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer name in unicode (length padded to multiple of 4 bytes) */
name|gint32
name|read_len
decl_stmt|;
name|gint32
name|write_len
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block luni: Unicode Name"
argument_list|)
expr_stmt|;
if|if
condition|(
name|lyr_a
operator|->
name|name
condition|)
name|g_free
argument_list|(
name|lyr_a
operator|->
name|name
argument_list|)
expr_stmt|;
name|lyr_a
operator|->
name|name
operator|=
name|fread_unicode_string
argument_list|(
operator|&
name|read_len
argument_list|,
operator|&
name|write_len
argument_list|,
literal|4
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|error
condition|)
return|return
operator|-
literal|1
return|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Unicode name: %s"
argument_list|,
name|lyr_a
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lyid (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lyid
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer id (tattoo) */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block lyid: Layer ID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|lyr_a
operator|->
name|id
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|lyr_a
operator|->
name|id
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|lyr_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Layer id: %i"
argument_list|,
name|lyr_a
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lclr (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lclr
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer sheet color code */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Sheet color"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|lyr_a
operator|->
name|color_tag
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Photoshop only uses color_tag[0] to store a color code */
name|lyr_a
operator|->
name|color_tag
index|[
literal|0
index|]
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|lyr_a
operator|->
name|color_tag
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Layer sheet color: %i"
argument_list|,
name|lyr_a
operator|->
name|color_tag
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lsct (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lsct
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load layer group& type information    * Type 0: not a group    * Type 1: Open folder    * Type 2: Closed folder    * Type 3: End of most recent group */
name|guint32
name|type
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Section divider"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|type
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Section divider type: %i"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|lyr_a
operator|->
name|group_type
operator|=
name|type
expr_stmt|;
if|if
condition|(
name|res_a
operator|->
name|data_len
operator|>=
literal|12
condition|)
block|{
name|gchar
name|signature
index|[
literal|4
index|]
decl_stmt|;
name|gchar
name|blend_mode
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|signature
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|blend_mode
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|signature
argument_list|,
literal|"8BIM"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|lyr_a
operator|->
name|blend_mode
argument_list|,
name|blend_mode
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Section divider layer mode sig: %.4s, blend mode: %.4s"
argument_list|,
name|signature
argument_list|,
name|blend_mode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Incorrect layer mode signature %.4s"
argument_list|,
name|signature
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lrfx (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lrfx
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gint16
name|version
decl_stmt|;
name|gint16
name|count
decl_stmt|;
name|gchar
name|signature
index|[
literal|4
index|]
decl_stmt|;
name|gchar
name|effectname
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: Layer effects"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|version
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|count
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|signature
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|effectname
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|signature
argument_list|,
literal|"8BIM"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Unknown layer resource signature %.4s"
argument_list|,
name|signature
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|effectname
argument_list|,
literal|"cmnS"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gint32
name|size
decl_stmt|;
name|gint32
name|ver
decl_stmt|;
name|gchar
name|visible
decl_stmt|;
name|gint16
name|unused
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|size
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ver
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|visible
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|unused
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|effectname
argument_list|,
literal|"dsdw"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|effectname
argument_list|,
literal|"isdw"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gint32
name|size
decl_stmt|;
name|gint32
name|ver
decl_stmt|;
name|gint32
name|blur
decl_stmt|;
name|gint32
name|intensity
decl_stmt|;
name|gint32
name|angle
decl_stmt|;
name|gint32
name|distance
decl_stmt|;
name|gint16
name|color
index|[
literal|5
index|]
decl_stmt|;
name|gint32
name|blendsig
decl_stmt|;
name|gint32
name|effect
decl_stmt|;
name|gchar
name|effecton
decl_stmt|;
name|gchar
name|anglefx
decl_stmt|;
name|gchar
name|opacity
decl_stmt|;
name|gint16
name|natcolor
index|[
literal|5
index|]
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|size
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ver
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blur
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|intensity
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|angle
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|distance
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blendsig
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|effect
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|effecton
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|anglefx
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|opacity
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|effectname
argument_list|,
literal|"oglw"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gint32
name|size
decl_stmt|;
name|gint32
name|ver
decl_stmt|;
name|gint32
name|blur
decl_stmt|;
name|gint32
name|intensity
decl_stmt|;
name|gint16
name|color
index|[
literal|5
index|]
decl_stmt|;
name|gint32
name|blendsig
decl_stmt|;
name|gint32
name|effect
decl_stmt|;
name|gchar
name|effecton
decl_stmt|;
name|gchar
name|opacity
decl_stmt|;
name|gint16
name|natcolor
index|[
literal|5
index|]
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|size
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ver
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blur
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|intensity
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blendsig
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|effect
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|effecton
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|opacity
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|size
operator|==
literal|42
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|effectname
argument_list|,
literal|"iglw"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gint32
name|size
decl_stmt|;
name|gint32
name|ver
decl_stmt|;
name|gint32
name|blur
decl_stmt|;
name|gint32
name|intensity
decl_stmt|;
name|gint32
name|angle
decl_stmt|;
name|gint32
name|distance
decl_stmt|;
name|gint16
name|color
index|[
literal|5
index|]
decl_stmt|;
name|gint32
name|blendsig
decl_stmt|;
name|gint32
name|effect
decl_stmt|;
name|gchar
name|effecton
decl_stmt|;
name|gchar
name|anglefx
decl_stmt|;
name|gchar
name|opacity
decl_stmt|;
name|gchar
name|invert
decl_stmt|;
name|gint16
name|natcolor
index|[
literal|5
index|]
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|size
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ver
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blur
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|intensity
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|angle
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|distance
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blendsig
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|effect
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|effecton
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|anglefx
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|opacity
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|size
operator|==
literal|43
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|invert
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|effectname
argument_list|,
literal|"bevl"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gint32
name|size
decl_stmt|;
name|gint32
name|ver
decl_stmt|;
name|gint32
name|angle
decl_stmt|;
name|gint32
name|strength
decl_stmt|;
name|gint32
name|blur
decl_stmt|;
name|gint32
name|highlightsig
decl_stmt|;
name|gint32
name|highlighteffect
decl_stmt|;
name|gint32
name|shadowsig
decl_stmt|;
name|gint32
name|shadoweffect
decl_stmt|;
name|gint16
name|highlightcolor
index|[
literal|5
index|]
decl_stmt|;
name|gint16
name|shadowcolor
index|[
literal|5
index|]
decl_stmt|;
name|gchar
name|style
decl_stmt|;
name|gchar
name|highlightopacity
decl_stmt|;
name|gchar
name|shadowopacity
decl_stmt|;
name|gchar
name|enabled
decl_stmt|;
name|gchar
name|global
decl_stmt|;
name|gchar
name|direction
decl_stmt|;
name|gint16
name|highlightnatcolor
index|[
literal|5
index|]
decl_stmt|;
name|gint16
name|shadownatcolor
index|[
literal|5
index|]
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|size
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ver
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|angle
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|strength
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blur
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightsig
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlighteffect
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadowsig
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadoweffect
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadowcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadowcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadowcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadowcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadowcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|style
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightopacity
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadowopacity
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|enabled
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|global
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|direction
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|size
operator|==
literal|78
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|highlightnatcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightnatcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightnatcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightnatcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightnatcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|highlightnatcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadownatcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadownatcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadownatcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadownatcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadownatcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|shadownatcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|effectname
argument_list|,
literal|"sofi"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gint32
name|size
decl_stmt|;
name|gint32
name|ver
decl_stmt|;
name|gint32
name|key
decl_stmt|;
name|gint16
name|color
index|[
literal|5
index|]
decl_stmt|;
name|gchar
name|opacity
decl_stmt|;
name|gchar
name|enabled
decl_stmt|;
name|gint16
name|natcolor
index|[
literal|5
index|]
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|size
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ver
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|key
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|color
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|opacity
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|enabled
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|3
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|natcolor
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Unknown layer effect signature %.4s"
argument_list|,
name|effectname
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lyvr (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lyvr
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gint32
name|version
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: layer version"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|version
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|version
operator|=
name|GINT32_FROM_BE
argument_list|(
name|version
argument_list|)
expr_stmt|;
comment|/* minimum value is 70 according to specs but there's no reason to    * stop the loading    */
if|if
condition|(
name|version
operator|<
literal|70
condition|)
block|{
name|g_message
argument_list|(
literal|"Invalid version layer"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_lnsr (const PSDlayerres * res_a,PSDlayer * lyr_a,FILE * f,GError ** error)
name|load_resource_lnsr
parameter_list|(
specifier|const
name|PSDlayerres
modifier|*
name|res_a
parameter_list|,
name|PSDlayer
modifier|*
name|lyr_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gchar
name|layername
index|[
literal|4
index|]
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process layer resource block %.4s: layer source name"
argument_list|,
name|res_a
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|layername
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* nowadays psd files, layer name are encoded in unicode, cf "luni"    * moreover lnsr info is encoded in MacRoman, see    * https://bugzilla.gnome.org/show_bug.cgi?id=753986#c4    */
return|return
literal|0
return|;
block|}
end_function

end_unit

