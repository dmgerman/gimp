begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * GIMP PSD Plug-in  * Copyright 2007 by John Marshall  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_comment
comment|/* ----- Known Image Resource Block Types -----   All image resources not otherwise handled, including unknown types   are added as image parasites.   The data is attached as-is from the file (i.e. in big endian order).    PSD_PS2_IMAGE_INFO    = 1000,    Dropped    * 0x03e8 - Obsolete - ps 2.0 image info *   PSD_MAC_PRINT_INFO    = 1001,    PS Only    * 0x03e9 - Optional - Mac print manager print info record *   PSD_PS2_COLOR_TAB     = 1003,    Dropped    * 0x03eb - Obsolete - ps 2.0 indexed colour table *   PSD_RESN_INFO         = 1005,    Loaded     * 0x03ed - ResolutionInfo structure *   PSD_ALPHA_NAMES       = 1006,    Loaded     * 0x03ee - Alpha channel names *   PSD_DISPLAY_INFO      = 1007,    Loaded     * 0x03ef - DisplayInfo structure *   PSD_CAPTION           = 1008,    Loaded     * 0x03f0 - Optional - Caption string *   PSD_BORDER_INFO       = 1009,               * 0x03f1 - Border info *   PSD_BACKGROUND_COL    = 1010,               * 0x03f2 - Background colour *   PSD_PRINT_FLAGS       = 1011,               * 0x03f3 - Print flags *   PSD_GREY_HALFTONE     = 1012,               * 0x03f4 - Greyscale and multichannel halftoning info *   PSD_COLOR_HALFTONE    = 1013,               * 0x03f5 - Colour halftoning info *   PSD_DUOTONE_HALFTONE  = 1014,               * 0x03f6 - Duotone halftoning info *   PSD_GREY_XFER         = 1015,               * 0x03f7 - Greyscale and multichannel transfer functions *   PSD_COLOR_XFER        = 1016,               * 0x03f8 - Colour transfer functions *   PSD_DUOTONE_XFER      = 1017,               * 0x03f9 - Duotone transfer functions *   PSD_DUOTONE_INFO      = 1018,               * 0x03fa - Duotone image information *   PSD_EFFECTIVE_BW      = 1019,               * 0x03fb - Effective black& white values for dot range *   PSD_OBSOLETE_01       = 1020,    Dropped    * 0x03fc - Obsolete *   PSD_EPS_OPT           = 1021,               * 0x03fd - EPS options *   PSD_QUICK_MASK        = 1022,    Loaded     * 0x03fe - Quick mask info *   PSD_OBSOLETE_02       = 1023,    Dropped    * 0x03ff - Obsolete *   PSD_LAYER_STATE       = 1024,    Loaded     * 0x0400 - Layer state info *   PSD_WORKING_PATH      = 1025,               * 0x0401 - Working path (not saved) *   PSD_LAYER_GROUP       = 1026,               * 0x0402 - Layers group info *   PSD_OBSOLETE_03       = 1027,    Dropped    * 0x0403 - Obsolete *   PSD_IPTC_NAA_DATA     = 1028,    Loaded     * 0x0404 - IPTC-NAA record (IMV4.pdf) *   PSD_IMAGE_MODE_RAW    = 1029,               * 0x0405 - Image mode for raw format files *   PSD_JPEG_QUAL         = 1030,    PS Only    * 0x0406 - JPEG quality *   PSD_GRID_GUIDE        = 1032,    Loaded     * 0x0408 - Grid& guide info *   PSD_THUMB_RES         = 1033,    Special    * 0x0409 - Thumbnail resource *   PSD_COPYRIGHT_FLG     = 1034,               * 0x040a - Copyright flag *   PSD_URL               = 1035,               * 0x040b - URL string *   PSD_THUMB_RES2        = 1036,    Special    * 0x040c - Thumbnail resource *   PSD_GLOBAL_ANGLE      = 1037,               * 0x040d - Global angle *   PSD_COLOR_SAMPLER     = 1038,               * 0x040e - Colour samplers resource *   PSD_ICC_PROFILE       = 1039,    Loaded     * 0x040f - ICC Profile *   PSD_WATERMARK         = 1040,               * 0x0410 - Watermark *   PSD_ICC_UNTAGGED      = 1041,               * 0x0411 - Do not use ICC profile flag *   PSD_EFFECTS_VISIBLE   = 1042,               * 0x0412 - Show   hide all effects layers *   PSD_SPOT_HALFTONE     = 1043,               * 0x0413 - Spot halftone *   PSD_DOC_IDS           = 1044,               * 0x0414 - Document specific IDs *   PSD_ALPHA_NAMES_UNI   = 1045,    Loaded     * 0x0415 - Unicode alpha names *   PSD_IDX_COL_TAB_CNT   = 1046,    Loaded     * 0x0416 - Indexed colour table count *   PSD_IDX_TRANSPARENT   = 1047,               * 0x0417 - Index of transparent colour (if any) *   PSD_GLOBAL_ALT        = 1049,               * 0x0419 - Global altitude *   PSD_SLICES            = 1050,               * 0x041a - Slices *   PSD_WORKFLOW_URL_UNI  = 1051,               * 0x041b - Workflow URL - Unicode string *   PSD_JUMP_TO_XPEP      = 1052,               * 0x041c - Jump to XPEP (?) *   PSD_ALPHA_ID          = 1053,    Loaded     * 0x041d - Alpha IDs *   PSD_URL_LIST_UNI      = 1054,               * 0x041e - URL list - unicode *   PSD_VERSION_INFO      = 1057,               * 0x0421 - Version info *   PSD_EXIF_DATA         = 1058,    Loaded     * 0x0422 - Exif data block *   PSD_XMP_DATA          = 1060,    Loaded     * 0x0424 - XMP data block *   PSD_PATH_INFO_FIRST   = 2000,    Loaded     * 0x07d0 - First path info block *   PSD_PATH_INFO_LAST    = 2998,    Loaded     * 0x0bb6 - Last path info block *   PSD_CLIPPING_PATH     = 2999,               * 0x0bb7 - Name of clipping path *   PSD_PRINT_FLAGS_2     = 10000               * 0x2710 - Print flags * */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<jpeglib.h>
end_include

begin_include
include|#
directive|include
file|<jerror.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_EXIF
end_ifdef

begin_include
include|#
directive|include
file|<libexif/exif-data.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_EXIF */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_IPTCDATA
end_ifdef

begin_include
include|#
directive|include
file|<libiptcdata/iptc-data.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_IPTCDATA */
end_comment

begin_include
include|#
directive|include
file|"psd.h"
end_include

begin_include
include|#
directive|include
file|"psd-util.h"
end_include

begin_include
include|#
directive|include
file|"psd-image-res-load.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_define
DECL|macro|EXIF_HEADER_SIZE
define|#
directive|define
name|EXIF_HEADER_SIZE
value|8
end_define

begin_comment
comment|/*  Local function prototypes  */
end_comment

begin_function_decl
specifier|static
name|gint
name|load_resource_unknown
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_ps_only
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1005
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1006
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1007
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1008
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1022
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1024
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1028
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1032
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1033
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1039
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1045
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1046
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1053
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1058
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_1060
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|load_resource_2000
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Public Functions */
end_comment

begin_function
name|gint
DECL|function|get_image_resource_header (PSDimageres * res_a,FILE * f,GError ** error)
name|get_image_resource_header
parameter_list|(
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gint32
name|read_len
decl_stmt|;
name|gint32
name|write_len
decl_stmt|;
name|gchar
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|res_a
operator|->
name|type
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res_a
operator|->
name|id
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res_a
operator|->
name|id
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|name
operator|=
name|fread_pascal_string
argument_list|(
operator|&
name|read_len
argument_list|,
operator|&
name|write_len
argument_list|,
literal|2
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|error
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
name|g_strlcpy
argument_list|(
name|res_a
operator|->
name|name
argument_list|,
name|name
argument_list|,
name|write_len
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|res_a
operator|->
name|name
index|[
literal|0
index|]
operator|=
literal|0x0
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|res_a
operator|->
name|data_len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res_a
operator|->
name|data_len
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
name|res_a
operator|->
name|data_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Type: %.4s, id: %d, start: %d, len: %d"
argument_list|,
name|res_a
operator|->
name|type
argument_list|,
name|res_a
operator|->
name|id
argument_list|,
name|res_a
operator|->
name|data_start
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|gint
DECL|function|load_image_resource (PSDimageres * res_a,const gint32 image_id,PSDimage * img_a,FILE * f,GError ** error)
name|load_image_resource
parameter_list|(
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gint
name|pad
decl_stmt|;
comment|/* Set file position to start of image resource data block */
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|res_a
operator|->
name|data_start
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Process image resource blocks */
if|if
condition|(
name|memcmp
argument_list|(
name|res_a
operator|->
name|type
argument_list|,
literal|"8BIM"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
operator|&&
name|memcmp
argument_list|(
name|res_a
operator|->
name|type
argument_list|,
literal|"MeSa"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Unknown image resource type signature %.4s"
argument_list|,
name|res_a
operator|->
name|type
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|res_a
operator|->
name|id
condition|)
block|{
case|case
name|PSD_PS2_IMAGE_INFO
case|:
case|case
name|PSD_PS2_COLOR_TAB
case|:
case|case
name|PSD_OBSOLETE_01
case|:
case|case
name|PSD_OBSOLETE_02
case|:
case|case
name|PSD_OBSOLETE_03
case|:
comment|/* Drop obsolete image resource blocks */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Obsolete image resource block: %d"
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_THUMB_RES
case|:
case|case
name|PSD_THUMB_RES2
case|:
comment|/* Drop thumbnails from standard file load */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Thumbnail resource block: %d"
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_MAC_PRINT_INFO
case|:
case|case
name|PSD_JPEG_QUAL
case|:
comment|/* Save photoshop resources with no meaning for GIMP               as image parasites */
name|load_resource_ps_only
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_RESN_INFO
case|:
name|load_resource_1005
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_ALPHA_NAMES
case|:
name|load_resource_1006
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|img_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_DISPLAY_INFO
case|:
name|load_resource_1007
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|img_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_CAPTION
case|:
name|load_resource_1008
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_QUICK_MASK
case|:
name|load_resource_1022
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|img_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_LAYER_STATE
case|:
name|load_resource_1024
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|img_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_IPTC_NAA_DATA
case|:
name|load_resource_1028
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_GRID_GUIDE
case|:
name|load_resource_1032
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_ICC_PROFILE
case|:
name|load_resource_1039
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_ALPHA_NAMES_UNI
case|:
name|load_resource_1045
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|img_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_IDX_COL_TAB_CNT
case|:
name|load_resource_1046
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_ALPHA_ID
case|:
name|load_resource_1053
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|img_a
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_EXIF_DATA
case|:
name|load_resource_1058
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_XMP_DATA
case|:
name|load_resource_1060
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|res_a
operator|->
name|id
operator|>=
literal|2000
operator|&&
name|res_a
operator|->
name|id
operator|<
literal|2999
condition|)
name|load_resource_2000
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
else|else
name|load_resource_unknown
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Image blocks are null padded to even length */
if|if
condition|(
name|res_a
operator|->
name|data_len
operator|%
literal|2
operator|==
literal|0
condition|)
name|pad
operator|=
literal|0
expr_stmt|;
else|else
name|pad
operator|=
literal|1
expr_stmt|;
comment|/* Set file position to end of image resource block */
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|res_a
operator|->
name|data_start
operator|+
name|res_a
operator|->
name|data_len
operator|+
name|pad
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|gint
DECL|function|load_thumbnail_resource (PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_thumbnail_resource
parameter_list|(
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gint
name|rtn
init|=
literal|0
decl_stmt|;
name|gint
name|pad
decl_stmt|;
comment|/* Set file position to start of image resource data block */
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|res_a
operator|->
name|data_start
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Process image resource blocks */
if|if
condition|(
name|res_a
operator|->
name|id
operator|==
name|PSD_THUMB_RES
operator|||
name|res_a
operator|->
name|id
operator|==
name|PSD_THUMB_RES2
condition|)
block|{
comment|/* Load thumbnails from standard file load */
name|load_resource_1033
argument_list|(
name|res_a
argument_list|,
name|image_id
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|rtn
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Image blocks are null padded to even length */
if|if
condition|(
name|res_a
operator|->
name|data_len
operator|%
literal|2
operator|==
literal|0
condition|)
name|pad
operator|=
literal|0
expr_stmt|;
else|else
name|pad
operator|=
literal|1
expr_stmt|;
comment|/* Set file position to end of image resource block */
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|res_a
operator|->
name|data_start
operator|+
name|res_a
operator|->
name|data_len
operator|+
name|pad
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|rtn
return|;
block|}
end_function

begin_comment
comment|/* Private Functions */
end_comment

begin_function
specifier|static
name|gint
DECL|function|load_resource_unknown (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_unknown
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Unknown image resources attached as parasites to re-save later */
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|gchar
modifier|*
name|data
decl_stmt|;
name|gchar
modifier|*
name|name
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process unknown image resource block: %d"
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|data
operator|=
name|g_malloc
argument_list|(
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|data
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|name
operator|=
name|g_strdup_printf
argument_list|(
literal|"psd-image-resource-%.4s-%.4x"
argument_list|,
name|res_a
operator|->
name|type
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Parasite name: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|name
argument_list|,
literal|0
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image_id
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_ps_only (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_ps_only
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Save photoshop resources with no meaning for GIMP as image parasites      to re-save later */
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|gchar
modifier|*
name|data
decl_stmt|;
name|gchar
modifier|*
name|name
decl_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: %d"
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|data
operator|=
name|g_malloc
argument_list|(
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|data
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|name
operator|=
name|g_strdup_printf
argument_list|(
literal|"psd-image-resource-%.4s-%.4x"
argument_list|,
name|res_a
operator|->
name|type
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Parasite name: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|name
argument_list|,
literal|0
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image_id
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1005 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1005
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load image resolution and unit of measure */
comment|/* FIXME  width unit and height unit unused at present */
name|ResolutionInfo
name|res_info
decl_stmt|;
name|GimpUnit
name|image_unit
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block 1005: Resolution Info"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|res_info
operator|.
name|hRes
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res_info
operator|.
name|hResUnit
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res_info
operator|.
name|widthUnit
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res_info
operator|.
name|vRes
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res_info
operator|.
name|vResUnit
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res_info
operator|.
name|heightUnit
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res_info
operator|.
name|hRes
operator|=
name|GINT32_FROM_BE
argument_list|(
name|res_info
operator|.
name|hRes
argument_list|)
expr_stmt|;
name|res_info
operator|.
name|hResUnit
operator|=
name|GINT16_FROM_BE
argument_list|(
name|res_info
operator|.
name|hResUnit
argument_list|)
expr_stmt|;
name|res_info
operator|.
name|widthUnit
operator|=
name|GINT16_FROM_BE
argument_list|(
name|res_info
operator|.
name|widthUnit
argument_list|)
expr_stmt|;
name|res_info
operator|.
name|vRes
operator|=
name|GINT32_FROM_BE
argument_list|(
name|res_info
operator|.
name|vRes
argument_list|)
expr_stmt|;
name|res_info
operator|.
name|vResUnit
operator|=
name|GINT16_FROM_BE
argument_list|(
name|res_info
operator|.
name|vResUnit
argument_list|)
expr_stmt|;
name|res_info
operator|.
name|heightUnit
operator|=
name|GINT16_FROM_BE
argument_list|(
name|res_info
operator|.
name|heightUnit
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Resolution: %d, %d, %d, %d, %d, %d"
argument_list|,
name|res_info
operator|.
name|hRes
argument_list|,
name|res_info
operator|.
name|hResUnit
argument_list|,
name|res_info
operator|.
name|widthUnit
argument_list|,
name|res_info
operator|.
name|vRes
argument_list|,
name|res_info
operator|.
name|vResUnit
argument_list|,
name|res_info
operator|.
name|heightUnit
argument_list|)
expr_stmt|;
comment|/* Resolution always recorded as pixels / inch in a fixed point implied      decimal int32 with 16 bits before point and 16 after (i.e. cast as      double and divide resolution by 2^16 */
name|gimp_image_set_resolution
argument_list|(
name|image_id
argument_list|,
name|res_info
operator|.
name|hRes
operator|/
literal|65536.0
argument_list|,
name|res_info
operator|.
name|vRes
operator|/
literal|65536.0
argument_list|)
expr_stmt|;
comment|/* GIMP only has one display unit so use ps horizontal resolution unit */
switch|switch
condition|(
name|res_info
operator|.
name|hResUnit
condition|)
block|{
case|case
name|PSD_RES_INCH
case|:
name|image_unit
operator|=
name|GIMP_UNIT_INCH
expr_stmt|;
break|break;
case|case
name|PSD_RES_CM
case|:
name|image_unit
operator|=
name|GIMP_UNIT_MM
expr_stmt|;
break|break;
default|default:
name|image_unit
operator|=
name|GIMP_UNIT_INCH
expr_stmt|;
block|}
name|gimp_image_set_unit
argument_list|(
name|image_id
argument_list|,
name|image_unit
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1006 (const PSDimageres * res_a,const gint32 image_id,PSDimage * img_a,FILE * f,GError ** error)
name|load_resource_1006
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load alpha channel names stored as a series of pascal strings      unpadded between strings */
name|gchar
modifier|*
name|str
decl_stmt|;
name|gint32
name|block_rem
decl_stmt|;
name|gint32
name|read_len
decl_stmt|;
name|gint32
name|write_len
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block 1006: Alpha Channel Names"
argument_list|)
expr_stmt|;
if|if
condition|(
name|img_a
operator|->
name|alpha_names
condition|)
block|{
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Alpha names loaded from unicode resource block"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|img_a
operator|->
name|alpha_names
operator|=
name|g_ptr_array_new
argument_list|()
expr_stmt|;
name|block_rem
operator|=
name|res_a
operator|->
name|data_len
expr_stmt|;
while|while
condition|(
name|block_rem
operator|>
literal|1
condition|)
block|{
name|str
operator|=
name|fread_pascal_string
argument_list|(
operator|&
name|read_len
argument_list|,
operator|&
name|write_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|error
condition|)
return|return
operator|-
literal|1
return|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"String: %s, %d, %d"
argument_list|,
name|str
argument_list|,
name|read_len
argument_list|,
name|write_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_len
operator|>=
literal|0
condition|)
block|{
name|g_ptr_array_add
argument_list|(
name|img_a
operator|->
name|alpha_names
argument_list|,
operator|(
name|gpointer
operator|)
name|str
argument_list|)
expr_stmt|;
block|}
name|block_rem
operator|-=
name|read_len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1007 (const PSDimageres * res_a,const gint32 image_id,PSDimage * img_a,FILE * f,GError ** error)
name|load_resource_1007
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load alpha channel display info */
name|DisplayInfo
name|dsp_info
decl_stmt|;
name|CMColor
name|ps_color
decl_stmt|;
name|GimpRGB
name|gimp_rgb
decl_stmt|;
name|GimpHSV
name|gimp_hsv
decl_stmt|;
name|GimpCMYK
name|gimp_cmyk
decl_stmt|;
name|gint16
name|tot_rec
decl_stmt|;
name|gint
name|cidx
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block 1007: Display Info"
argument_list|)
expr_stmt|;
name|tot_rec
operator|=
name|res_a
operator|->
name|data_len
operator|/
literal|14
expr_stmt|;
if|if
condition|(
name|tot_rec
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|img_a
operator|->
name|alpha_display_info
operator|=
name|g_new
argument_list|(
name|PSDchanneldata
operator|*
argument_list|,
name|tot_rec
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|alpha_display_count
operator|=
name|tot_rec
expr_stmt|;
for|for
control|(
name|cidx
operator|=
literal|0
init|;
name|cidx
operator|<
name|tot_rec
condition|;
operator|++
name|cidx
control|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|dsp_info
operator|.
name|colorSpace
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|dsp_info
operator|.
name|color
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|dsp_info
operator|.
name|opacity
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|dsp_info
operator|.
name|kind
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|dsp_info
operator|.
name|padding
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dsp_info
operator|.
name|colorSpace
operator|=
name|GINT16_FROM_BE
argument_list|(
name|dsp_info
operator|.
name|colorSpace
argument_list|)
expr_stmt|;
name|ps_color
operator|.
name|cmyk
operator|.
name|cyan
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|dsp_info
operator|.
name|color
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ps_color
operator|.
name|cmyk
operator|.
name|magenta
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|dsp_info
operator|.
name|color
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ps_color
operator|.
name|cmyk
operator|.
name|yellow
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|dsp_info
operator|.
name|color
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ps_color
operator|.
name|cmyk
operator|.
name|black
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|dsp_info
operator|.
name|color
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|dsp_info
operator|.
name|opacity
operator|=
name|GINT16_FROM_BE
argument_list|(
name|dsp_info
operator|.
name|opacity
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dsp_info
operator|.
name|colorSpace
condition|)
block|{
case|case
name|PSD_CS_RGB
case|:
name|gimp_rgb_set
argument_list|(
operator|&
name|gimp_rgb
argument_list|,
name|ps_color
operator|.
name|rgb
operator|.
name|red
operator|/
literal|65535.0
argument_list|,
name|ps_color
operator|.
name|rgb
operator|.
name|green
operator|/
literal|65535.0
argument_list|,
name|ps_color
operator|.
name|rgb
operator|.
name|blue
operator|/
literal|65535.0
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_CS_HSB
case|:
name|gimp_hsv_set
argument_list|(
operator|&
name|gimp_hsv
argument_list|,
name|ps_color
operator|.
name|hsv
operator|.
name|hue
operator|/
literal|65535.0
argument_list|,
name|ps_color
operator|.
name|hsv
operator|.
name|saturation
operator|/
literal|65535.0
argument_list|,
name|ps_color
operator|.
name|hsv
operator|.
name|value
operator|/
literal|65535.0
argument_list|)
expr_stmt|;
name|gimp_hsv_to_rgb
argument_list|(
operator|&
name|gimp_hsv
argument_list|,
operator|&
name|gimp_rgb
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_CS_CMYK
case|:
name|gimp_cmyk_set
argument_list|(
operator|&
name|gimp_cmyk
argument_list|,
literal|1.0
operator|-
name|ps_color
operator|.
name|cmyk
operator|.
name|cyan
operator|/
literal|65535.0
argument_list|,
literal|1.0
operator|-
name|ps_color
operator|.
name|cmyk
operator|.
name|magenta
operator|/
literal|65535.0
argument_list|,
literal|1.0
operator|-
name|ps_color
operator|.
name|cmyk
operator|.
name|yellow
operator|/
literal|65535.0
argument_list|,
literal|1.0
operator|-
name|ps_color
operator|.
name|cmyk
operator|.
name|black
operator|/
literal|65535.0
argument_list|)
expr_stmt|;
name|gimp_cmyk_to_rgb
argument_list|(
operator|&
name|gimp_cmyk
argument_list|,
operator|&
name|gimp_rgb
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_CS_GRAYSCALE
case|:
name|gimp_rgb_set
argument_list|(
operator|&
name|gimp_rgb
argument_list|,
name|ps_color
operator|.
name|gray
operator|.
name|gray
operator|/
literal|10000.0
argument_list|,
name|ps_color
operator|.
name|gray
operator|.
name|gray
operator|/
literal|10000.0
argument_list|,
name|ps_color
operator|.
name|gray
operator|.
name|gray
operator|/
literal|10000.0
argument_list|)
expr_stmt|;
break|break;
case|case
name|PSD_CS_FOCOLTONE
case|:
case|case
name|PSD_CS_TRUMATCH
case|:
case|case
name|PSD_CS_HKS
case|:
case|case
name|PSD_CS_LAB
case|:
case|case
name|PSD_CS_PANTONE
case|:
case|case
name|PSD_CS_TOYO
case|:
case|case
name|PSD_CS_DIC
case|:
case|case
name|PSD_CS_ANPA
case|:
default|default:
if|if
condition|(
name|CONVERSION_WARNINGS
condition|)
name|g_message
argument_list|(
literal|"Unsupported color space: %d"
argument_list|,
name|dsp_info
operator|.
name|colorSpace
argument_list|)
expr_stmt|;
name|gimp_rgb_set
argument_list|(
operator|&
name|gimp_rgb
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
block|}
name|gimp_rgb_set_alpha
argument_list|(
operator|&
name|gimp_rgb
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"PS cSpace: %d, col: %d %d %d %d, opacity: %d, kind: %d"
argument_list|,
name|dsp_info
operator|.
name|colorSpace
argument_list|,
name|ps_color
operator|.
name|cmyk
operator|.
name|cyan
argument_list|,
name|ps_color
operator|.
name|cmyk
operator|.
name|magenta
argument_list|,
name|ps_color
operator|.
name|cmyk
operator|.
name|yellow
argument_list|,
name|ps_color
operator|.
name|cmyk
operator|.
name|black
argument_list|,
name|dsp_info
operator|.
name|opacity
argument_list|,
name|dsp_info
operator|.
name|kind
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"cSpace: %d, col: %g %g %g, opacity: %d, kind: %d"
argument_list|,
name|dsp_info
operator|.
name|colorSpace
argument_list|,
name|gimp_rgb
operator|.
name|r
operator|*
literal|255
argument_list|,
name|gimp_rgb
operator|.
name|g
operator|*
literal|255
argument_list|,
name|gimp_rgb
operator|.
name|b
operator|*
literal|255
argument_list|,
name|dsp_info
operator|.
name|opacity
argument_list|,
name|dsp_info
operator|.
name|kind
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|alpha_display_info
index|[
name|cidx
index|]
operator|=
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|PSDchanneldata
argument_list|)
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|alpha_display_info
index|[
name|cidx
index|]
operator|->
name|gimp_color
operator|=
name|gimp_rgb
expr_stmt|;
name|img_a
operator|->
name|alpha_display_info
index|[
name|cidx
index|]
operator|->
name|opacity
operator|=
name|dsp_info
operator|.
name|opacity
expr_stmt|;
name|img_a
operator|->
name|alpha_display_info
index|[
name|cidx
index|]
operator|->
name|ps_kind
operator|=
name|dsp_info
operator|.
name|kind
expr_stmt|;
name|img_a
operator|->
name|alpha_display_info
index|[
name|cidx
index|]
operator|->
name|ps_cspace
operator|=
name|dsp_info
operator|.
name|colorSpace
expr_stmt|;
name|img_a
operator|->
name|alpha_display_info
index|[
name|cidx
index|]
operator|->
name|ps_color
operator|=
name|ps_color
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1008 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1008
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load image caption */
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|gchar
modifier|*
name|caption
decl_stmt|;
name|gint32
name|read_len
decl_stmt|;
name|gint32
name|write_len
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1008: Caption"
argument_list|)
expr_stmt|;
name|caption
operator|=
name|fread_pascal_string
argument_list|(
operator|&
name|read_len
argument_list|,
operator|&
name|write_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|error
condition|)
return|return
operator|-
literal|1
return|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Caption: %s"
argument_list|,
name|caption
argument_list|)
expr_stmt|;
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|GIMP_PARASITE_COMMENT
argument_list|,
name|GIMP_PARASITE_PERSISTENT
argument_list|,
name|write_len
argument_list|,
name|caption
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image_id
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|caption
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1022 (const PSDimageres * res_a,const gint32 image_id,PSDimage * img_a,FILE * f,GError ** error)
name|load_resource_1022
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load quick mask info */
name|gboolean
name|quick_mask_empty
decl_stmt|;
comment|/* Quick mask initially empty */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1022: Quick Mask"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|img_a
operator|->
name|quick_mask_id
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|quick_mask_empty
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|img_a
operator|->
name|quick_mask_id
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|img_a
operator|->
name|quick_mask_id
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Quick mask channel: %d, empty: %d"
argument_list|,
name|img_a
operator|->
name|quick_mask_id
argument_list|,
name|quick_mask_empty
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1024 (const PSDimageres * res_a,const gint32 image_id,PSDimage * img_a,FILE * f,GError ** error)
name|load_resource_1024
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load image layer state - current active layer counting from bottom up */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1024: Layer State"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|img_a
operator|->
name|layer_state
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|img_a
operator|->
name|layer_state
operator|=
name|GUINT16_FROM_BE
argument_list|(
name|img_a
operator|->
name|layer_state
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1028 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1028
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load IPTC data block */
ifdef|#
directive|ifdef
name|HAVE_IPTCDATA
name|IptcData
modifier|*
name|iptc_data
decl_stmt|;
name|guchar
modifier|*
name|iptc_buf
decl_stmt|;
name|guint
name|iptc_buf_len
decl_stmt|;
else|#
directive|else
name|gchar
modifier|*
name|name
decl_stmt|;
endif|#
directive|endif
comment|/* HAVE_IPTCDATA */
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|gchar
modifier|*
name|res_data
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1028: IPTC data"
argument_list|)
expr_stmt|;
name|res_data
operator|=
name|g_malloc
argument_list|(
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|res_data
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|res_data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|HAVE_IPTCDATA
comment|/* Load IPTC data structure */
name|iptc_data
operator|=
name|iptc_data_new_from_data
argument_list|(
name|res_data
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|iptc_data_dump
argument_list|(
name|iptc_data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Store resource data as a GIMP IPTC parasite */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Processing IPTC data as GIMP IPTC parasite"
argument_list|)
expr_stmt|;
comment|/* Serialize IPTC data */
name|iptc_data_save
argument_list|(
name|iptc_data
argument_list|,
operator|&
name|iptc_buf
argument_list|,
operator|&
name|iptc_buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|iptc_buf_len
operator|>
literal|0
condition|)
block|{
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|GIMP_PARASITE_IPTC
argument_list|,
name|GIMP_PARASITE_PERSISTENT
argument_list|,
name|iptc_buf_len
argument_list|,
name|iptc_buf
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image_id
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
block|}
name|iptc_data_unref
argument_list|(
name|iptc_data
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|iptc_buf
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* Store resource data as a standard psd parasite */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Processing IPTC data as psd parasite"
argument_list|)
expr_stmt|;
name|name
operator|=
name|g_strdup_printf
argument_list|(
literal|"psd-image-resource-%.4s-%.4x"
argument_list|,
name|res_a
operator|->
name|type
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Parasite name: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|name
argument_list|,
literal|0
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
name|res_data
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image_id
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_IPTCDATA */
name|g_free
argument_list|(
name|res_data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1032 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1032
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load grid and guides */
comment|/* Grid info is not used (CS2 or earlier) */
name|GuideHeader
name|hdr
decl_stmt|;
name|GuideResource
name|guide
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block 1032: Grid and Guide Info"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|hdr
operator|.
name|fVersion
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|hdr
operator|.
name|fGridCycleV
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|hdr
operator|.
name|fGridCycleH
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|hdr
operator|.
name|fGuideCount
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hdr
operator|.
name|fVersion
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|hdr
operator|.
name|fVersion
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|fGridCycleV
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|hdr
operator|.
name|fGridCycleV
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|fGridCycleH
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|hdr
operator|.
name|fGridCycleH
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|fGuideCount
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|hdr
operator|.
name|fGuideCount
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Grids& Guides: %d, %d, %d, %d"
argument_list|,
name|hdr
operator|.
name|fVersion
argument_list|,
name|hdr
operator|.
name|fGridCycleV
argument_list|,
name|hdr
operator|.
name|fGridCycleH
argument_list|,
name|hdr
operator|.
name|fGuideCount
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hdr
operator|.
name|fGuideCount
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|guide
operator|.
name|fLocation
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|guide
operator|.
name|fDirection
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|guide
operator|.
name|fLocation
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|guide
operator|.
name|fLocation
argument_list|)
expr_stmt|;
name|guide
operator|.
name|fLocation
operator|/=
literal|32
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Guide: %d px, %d"
argument_list|,
name|guide
operator|.
name|fLocation
argument_list|,
name|guide
operator|.
name|fDirection
argument_list|)
expr_stmt|;
if|if
condition|(
name|guide
operator|.
name|fDirection
operator|==
name|PSD_VERTICAL
condition|)
name|gimp_image_add_vguide
argument_list|(
name|image_id
argument_list|,
name|guide
operator|.
name|fLocation
argument_list|)
expr_stmt|;
else|else
name|gimp_image_add_hguide
argument_list|(
name|image_id
argument_list|,
name|guide
operator|.
name|fLocation
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1033 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1033
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load thumbnail image */
name|struct
name|jpeg_decompress_struct
name|cinfo
decl_stmt|;
name|struct
name|jpeg_error_mgr
name|jerr
decl_stmt|;
name|ThumbnailInfo
name|thumb_info
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|GimpPixelRgn
name|pixel_rgn
decl_stmt|;
name|gint32
name|layer_id
decl_stmt|;
name|guchar
modifier|*
name|buf
decl_stmt|;
name|guchar
modifier|*
name|rgb_buf
decl_stmt|;
name|guchar
modifier|*
modifier|*
name|rowbuf
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block %d: Thumbnail Image"
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
comment|/* Read thumbnail resource header info */
if|if
condition|(
name|fread
argument_list|(
operator|&
name|thumb_info
operator|.
name|format
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|thumb_info
operator|.
name|width
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|thumb_info
operator|.
name|height
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|thumb_info
operator|.
name|widthbytes
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|thumb_info
operator|.
name|size
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|thumb_info
operator|.
name|compressedsize
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|thumb_info
operator|.
name|bitspixel
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|thumb_info
operator|.
name|planes
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|thumb_info
operator|.
name|format
operator|=
name|GINT32_FROM_BE
argument_list|(
name|thumb_info
operator|.
name|format
argument_list|)
expr_stmt|;
name|thumb_info
operator|.
name|width
operator|=
name|GINT32_FROM_BE
argument_list|(
name|thumb_info
operator|.
name|width
argument_list|)
expr_stmt|;
name|thumb_info
operator|.
name|height
operator|=
name|GINT32_FROM_BE
argument_list|(
name|thumb_info
operator|.
name|height
argument_list|)
expr_stmt|;
name|thumb_info
operator|.
name|widthbytes
operator|=
name|GINT32_FROM_BE
argument_list|(
name|thumb_info
operator|.
name|widthbytes
argument_list|)
expr_stmt|;
name|thumb_info
operator|.
name|size
operator|=
name|GINT32_FROM_BE
argument_list|(
name|thumb_info
operator|.
name|size
argument_list|)
expr_stmt|;
name|thumb_info
operator|.
name|compressedsize
operator|=
name|GINT32_FROM_BE
argument_list|(
name|thumb_info
operator|.
name|compressedsize
argument_list|)
expr_stmt|;
name|thumb_info
operator|.
name|bitspixel
operator|=
name|GINT16_FROM_BE
argument_list|(
name|thumb_info
operator|.
name|bitspixel
argument_list|)
expr_stmt|;
name|thumb_info
operator|.
name|planes
operator|=
name|GINT16_FROM_BE
argument_list|(
name|thumb_info
operator|.
name|planes
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"\nThumbnail:\n"
literal|"\tFormat: %d\n"
literal|"\tDimensions: %d x %d\n"
argument_list|,
name|thumb_info
operator|.
name|format
argument_list|,
name|thumb_info
operator|.
name|width
argument_list|,
name|thumb_info
operator|.
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|thumb_info
operator|.
name|format
operator|!=
literal|1
condition|)
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Unknown thumbnail format %d"
argument_list|,
name|thumb_info
operator|.
name|format
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Load Jpeg RGB thumbnail info */
comment|/* Step 1: Allocate and initialize JPEG decompression object */
name|cinfo
operator|.
name|err
operator|=
name|jpeg_std_error
argument_list|(
operator|&
name|jerr
argument_list|)
expr_stmt|;
name|jpeg_create_decompress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* Step 2: specify data source (eg, a file) */
name|jpeg_stdio_src
argument_list|(
operator|&
name|cinfo
argument_list|,
name|f
argument_list|)
expr_stmt|;
comment|/* Step 3: read file parameters with jpeg_read_header() */
name|jpeg_read_header
argument_list|(
operator|&
name|cinfo
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* Step 4: set parameters for decompression */
comment|/* Step 5: Start decompressor */
name|jpeg_start_decompress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* temporary buffers */
name|buf
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|cinfo
operator|.
name|output_height
operator|*
name|cinfo
operator|.
name|output_width
operator|*
name|cinfo
operator|.
name|output_components
argument_list|)
expr_stmt|;
if|if
condition|(
name|res_a
operator|->
name|id
operator|==
name|PSD_THUMB_RES
condition|)
name|rgb_buf
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|cinfo
operator|.
name|output_height
operator|*
name|cinfo
operator|.
name|output_width
operator|*
name|cinfo
operator|.
name|output_components
argument_list|)
expr_stmt|;
else|else
name|rgb_buf
operator|=
name|NULL
expr_stmt|;
name|rowbuf
operator|=
name|g_new
argument_list|(
name|guchar
operator|*
argument_list|,
name|cinfo
operator|.
name|output_height
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cinfo
operator|.
name|output_height
condition|;
operator|++
name|i
control|)
name|rowbuf
index|[
name|i
index|]
operator|=
name|buf
operator|+
name|cinfo
operator|.
name|output_width
operator|*
name|cinfo
operator|.
name|output_components
operator|*
name|i
expr_stmt|;
comment|/* Create image layer */
name|gimp_image_resize
argument_list|(
name|image_id
argument_list|,
name|cinfo
operator|.
name|output_width
argument_list|,
name|cinfo
operator|.
name|output_height
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|layer_id
operator|=
name|gimp_layer_new
argument_list|(
name|image_id
argument_list|,
name|_
argument_list|(
literal|"Background"
argument_list|)
argument_list|,
name|cinfo
operator|.
name|output_width
argument_list|,
name|cinfo
operator|.
name|output_height
argument_list|,
name|GIMP_RGB_IMAGE
argument_list|,
literal|100
argument_list|,
name|GIMP_NORMAL_MODE
argument_list|)
expr_stmt|;
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|layer_id
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* Step 6: while (scan lines remain to be read) */
comment|/*           jpeg_read_scanlines(...); */
while|while
condition|(
name|cinfo
operator|.
name|output_scanline
operator|<
name|cinfo
operator|.
name|output_height
condition|)
block|{
name|jpeg_read_scanlines
argument_list|(
operator|&
name|cinfo
argument_list|,
operator|(
name|JSAMPARRAY
operator|)
operator|&
name|rowbuf
index|[
name|cinfo
operator|.
name|output_scanline
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|res_a
operator|->
name|id
operator|==
name|PSD_THUMB_RES
condition|)
comment|/* Order is BGR for resource 1033 */
block|{
name|guchar
modifier|*
name|dst
init|=
name|rgb_buf
decl_stmt|;
name|guchar
modifier|*
name|src
init|=
name|buf
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drawable
operator|->
name|width
operator|*
name|drawable
operator|->
name|height
condition|;
operator|++
name|i
control|)
block|{
name|guchar
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|r
operator|=
operator|*
operator|(
name|src
operator|++
operator|)
expr_stmt|;
name|g
operator|=
operator|*
operator|(
name|src
operator|++
operator|)
expr_stmt|;
name|b
operator|=
operator|*
operator|(
name|src
operator|++
operator|)
expr_stmt|;
operator|*
operator|(
name|dst
operator|++
operator|)
operator|=
name|b
expr_stmt|;
operator|*
operator|(
name|dst
operator|++
operator|)
operator|=
name|g
expr_stmt|;
operator|*
operator|(
name|dst
operator|++
operator|)
operator|=
name|r
expr_stmt|;
block|}
block|}
name|gimp_pixel_rgn_set_rect
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|rgb_buf
condition|?
name|rgb_buf
else|:
name|buf
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
comment|/* Step 7: Finish decompression */
name|jpeg_finish_decompress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* We can ignore the return value since suspension is not possible    * with the stdio data source.    */
comment|/* Step 8: Release JPEG decompression object */
name|jpeg_destroy_decompress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* free up the temporary buffers */
name|g_free
argument_list|(
name|rowbuf
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|rgb_buf
argument_list|)
expr_stmt|;
comment|/* At this point you may want to check to see whether any    * corrupt-data warnings occurred (test whether    * jerr.num_warnings is nonzero).    */
name|gimp_image_insert_layer
argument_list|(
name|image_id
argument_list|,
name|layer_id
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1039 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1039
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load ICC profile */
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|gchar
modifier|*
name|icc_profile
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1039: ICC Profile"
argument_list|)
expr_stmt|;
name|icc_profile
operator|=
name|g_malloc
argument_list|(
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|icc_profile
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|icc_profile
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|GIMP_PARASITE_ICC_PROFILE
argument_list|,
name|GIMP_PARASITE_PERSISTENT
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
name|icc_profile
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image_id
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|icc_profile
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1045 (const PSDimageres * res_a,const gint32 image_id,PSDimage * img_a,FILE * f,GError ** error)
name|load_resource_1045
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load alpha channel names stored as a series of unicode strings      in a GPtrArray */
name|gchar
modifier|*
name|str
decl_stmt|;
name|gint32
name|block_rem
decl_stmt|;
name|gint32
name|read_len
decl_stmt|;
name|gint32
name|write_len
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block 1045: Unicode Alpha Channel Names"
argument_list|)
expr_stmt|;
if|if
condition|(
name|img_a
operator|->
name|alpha_names
condition|)
block|{
name|gint
name|i
decl_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Deleting localised alpha channel names"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|img_a
operator|->
name|alpha_names
operator|->
name|len
condition|;
operator|++
name|i
control|)
block|{
name|str
operator|=
name|g_ptr_array_index
argument_list|(
name|img_a
operator|->
name|alpha_names
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
name|g_ptr_array_free
argument_list|(
name|img_a
operator|->
name|alpha_names
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
name|img_a
operator|->
name|alpha_names
operator|=
name|g_ptr_array_new
argument_list|()
expr_stmt|;
name|block_rem
operator|=
name|res_a
operator|->
name|data_len
expr_stmt|;
while|while
condition|(
name|block_rem
operator|>
literal|1
condition|)
block|{
name|str
operator|=
name|fread_unicode_string
argument_list|(
operator|&
name|read_len
argument_list|,
operator|&
name|write_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|error
condition|)
return|return
operator|-
literal|1
return|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"String: %s, %d, %d"
argument_list|,
name|str
argument_list|,
name|read_len
argument_list|,
name|write_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_len
operator|>=
literal|0
condition|)
block|{
name|g_ptr_array_add
argument_list|(
name|img_a
operator|->
name|alpha_names
argument_list|,
operator|(
name|gpointer
operator|)
name|str
argument_list|)
expr_stmt|;
block|}
name|block_rem
operator|-=
name|read_len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1046 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1046
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load indexed color table count */
name|guchar
modifier|*
name|cmap
decl_stmt|;
name|gint32
name|cmap_count
init|=
literal|0
decl_stmt|;
name|gint16
name|index_count
init|=
literal|0
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1046: Indexed Color Table Count"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|index_count
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|index_count
operator|=
name|GINT16_FROM_BE
argument_list|(
name|index_count
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Indexed color table count: %d"
argument_list|,
name|index_count
argument_list|)
expr_stmt|;
comment|/* FIXME - check that we have indexed image */
if|if
condition|(
name|index_count
operator|&&
name|index_count
operator|<
literal|256
condition|)
block|{
name|cmap
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image_id
argument_list|,
operator|&
name|cmap_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmap
operator|&&
name|index_count
operator|<
name|cmap_count
condition|)
name|gimp_image_set_colormap
argument_list|(
name|image_id
argument_list|,
name|cmap
argument_list|,
name|index_count
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|cmap
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1053 (const PSDimageres * res_a,const gint32 image_id,PSDimage * img_a,FILE * f,GError ** error)
name|load_resource_1053
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|PSDimage
modifier|*
name|img_a
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load image alpha channel ids (tattoos) */
name|gint16
name|tot_rec
decl_stmt|;
name|gint16
name|cidx
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1053: Channel ID"
argument_list|)
expr_stmt|;
name|tot_rec
operator|=
name|res_a
operator|->
name|data_len
operator|/
literal|4
expr_stmt|;
if|if
condition|(
name|tot_rec
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|img_a
operator|->
name|alpha_id
operator|=
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|img_a
operator|->
name|alpha_id
argument_list|)
operator|*
name|tot_rec
argument_list|)
expr_stmt|;
name|img_a
operator|->
name|alpha_id_count
operator|=
name|tot_rec
expr_stmt|;
for|for
control|(
name|cidx
operator|=
literal|0
init|;
name|cidx
operator|<
name|tot_rec
condition|;
operator|++
name|cidx
control|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|img_a
operator|->
name|alpha_id
index|[
name|cidx
index|]
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|img_a
operator|->
name|alpha_id
index|[
name|cidx
index|]
operator|=
name|GUINT32_FROM_BE
argument_list|(
name|img_a
operator|->
name|alpha_id
index|[
name|cidx
index|]
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Channel id: %d"
argument_list|,
name|img_a
operator|->
name|alpha_id
index|[
name|cidx
index|]
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1058 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1058
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load EXIF data block */
ifdef|#
directive|ifdef
name|HAVE_EXIF
name|ExifData
modifier|*
name|exif_data
decl_stmt|;
name|ExifEntry
modifier|*
name|exif_entry
decl_stmt|;
name|guchar
modifier|*
name|exif_buf
decl_stmt|;
name|guchar
modifier|*
name|tmp_data
decl_stmt|;
name|guint
name|exif_buf_len
decl_stmt|;
name|gint16
name|jpeg_len
decl_stmt|;
name|gint16
name|jpeg_fill
init|=
literal|0
decl_stmt|;
name|GimpParam
modifier|*
name|return_vals
decl_stmt|;
name|gint
name|nreturn_vals
decl_stmt|;
else|#
directive|else
name|gchar
modifier|*
name|name
decl_stmt|;
endif|#
directive|endif
comment|/* HAVE_EXIF */
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|gchar
modifier|*
name|res_data
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1058: EXIF data"
argument_list|)
expr_stmt|;
name|res_data
operator|=
name|g_malloc
argument_list|(
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|res_data
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|res_data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|HAVE_EXIF
comment|/* Add JPEG header& trailer to the TIFF Exif data held in PSD      resource to allow us to use libexif to serialize the data      in the same manner as the JPEG load.   */
name|jpeg_len
operator|=
name|res_a
operator|->
name|data_len
operator|+
literal|8
expr_stmt|;
name|tmp_data
operator|=
name|g_malloc
argument_list|(
name|res_a
operator|->
name|data_len
operator|+
literal|12
argument_list|)
expr_stmt|;
comment|/* SOI& APP1 markers */
name|memcpy
argument_list|(
name|tmp_data
argument_list|,
literal|"\xFF\xD8\xFF\xE1"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* APP1 block len */
name|memcpy
argument_list|(
name|tmp_data
operator|+
literal|4
argument_list|,
operator|&
name|jpeg_len
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Exif marker */
name|memcpy
argument_list|(
name|tmp_data
operator|+
literal|6
argument_list|,
literal|"Exif"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Filler */
name|memcpy
argument_list|(
name|tmp_data
operator|+
literal|10
argument_list|,
operator|&
name|jpeg_fill
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Exif data */
name|memcpy
argument_list|(
name|tmp_data
operator|+
literal|12
argument_list|,
name|res_data
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|)
expr_stmt|;
comment|/* Create Exif data structure */
name|exif_data
operator|=
name|exif_data_new_from_data
argument_list|(
name|tmp_data
argument_list|,
name|res_a
operator|->
name|data_len
operator|+
literal|12
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmp_data
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|exif_data_dump
argument_list|(
name|exif_data
argument_list|)
expr_stmt|;
comment|/* Check for XMP data block in Exif data - PS7 */
if|if
condition|(
operator|(
name|exif_entry
operator|=
name|exif_content_get_entry
argument_list|(
name|exif_data
operator|->
name|ifd
index|[
name|EXIF_IFD_0
index|]
argument_list|,
name|EXIF_TAG_XML_PACKET
argument_list|)
operator|)
condition|)
block|{
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Processing Exif XMP data block"
argument_list|)
expr_stmt|;
comment|/*Create NULL terminated EXIF data block */
name|tmp_data
operator|=
name|g_malloc
argument_list|(
name|exif_entry
operator|->
name|size
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tmp_data
argument_list|,
name|exif_entry
operator|->
name|data
argument_list|,
name|exif_entry
operator|->
name|size
argument_list|)
expr_stmt|;
name|tmp_data
index|[
name|exif_entry
operator|->
name|size
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Merge with existing XMP data block */
name|return_vals
operator|=
name|gimp_run_procedure
argument_list|(
name|DECODE_XMP_PROC
argument_list|,
operator|&
name|nreturn_vals
argument_list|,
name|GIMP_PDB_IMAGE
argument_list|,
name|image_id
argument_list|,
name|GIMP_PDB_STRING
argument_list|,
name|tmp_data
argument_list|,
name|GIMP_PDB_END
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmp_data
argument_list|)
expr_stmt|;
name|gimp_destroy_params
argument_list|(
name|return_vals
argument_list|,
name|nreturn_vals
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Deleting XMP block from Exif data"
argument_list|)
expr_stmt|;
comment|/* Delete XMP data from Exif block */
name|exif_content_remove_entry
argument_list|(
name|exif_data
operator|->
name|ifd
index|[
name|EXIF_IFD_0
index|]
argument_list|,
name|exif_entry
argument_list|)
expr_stmt|;
block|}
comment|/* Check for Photoshp Image Resource data block in Exif data - PS7 */
if|if
condition|(
operator|(
name|exif_entry
operator|=
name|exif_content_get_entry
argument_list|(
name|exif_data
operator|->
name|ifd
index|[
name|EXIF_IFD_0
index|]
argument_list|,
name|EXIF_TAG_IMAGE_RESOURCES
argument_list|)
operator|)
condition|)
block|{
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Deleting PS Image Resource block from Exif data"
argument_list|)
expr_stmt|;
comment|/* Delete PS Image Resource data from Exif block */
name|exif_content_remove_entry
argument_list|(
name|exif_data
operator|->
name|ifd
index|[
name|EXIF_IFD_0
index|]
argument_list|,
name|exif_entry
argument_list|)
expr_stmt|;
block|}
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|exif_data_dump
argument_list|(
name|exif_data
argument_list|)
expr_stmt|;
comment|/* Store resource data as a GIMP Exif parasite */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Processing exif data as GIMP Exif parasite"
argument_list|)
expr_stmt|;
comment|/* Serialize exif data */
name|exif_data_save_data
argument_list|(
name|exif_data
argument_list|,
operator|&
name|exif_buf
argument_list|,
operator|&
name|exif_buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|exif_buf_len
operator|>
name|EXIF_HEADER_SIZE
condition|)
block|{
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|GIMP_PARASITE_EXIF
argument_list|,
name|GIMP_PARASITE_PERSISTENT
argument_list|,
name|exif_buf_len
argument_list|,
name|exif_buf
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image_id
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
block|}
name|exif_data_unref
argument_list|(
name|exif_data
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|exif_buf
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* Store resource data as a standard psd parasite */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Processing exif data as psd parasite"
argument_list|)
expr_stmt|;
name|name
operator|=
name|g_strdup_printf
argument_list|(
literal|"psd-image-resource-%.4s-%.4x"
argument_list|,
name|res_a
operator|->
name|type
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Parasite name: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|name
argument_list|,
literal|0
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
name|res_data
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image_id
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_EXIF */
name|g_free
argument_list|(
name|res_data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_1060 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_1060
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
comment|/* Load XMP Metadata block */
name|GimpParam
modifier|*
name|return_vals
decl_stmt|;
name|gint
name|nreturn_vals
decl_stmt|;
name|gchar
modifier|*
name|res_data
decl_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: 1060: XMP Data"
argument_list|)
expr_stmt|;
name|res_data
operator|=
name|g_malloc
argument_list|(
name|res_a
operator|->
name|data_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|res_data
argument_list|,
name|res_a
operator|->
name|data_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|res_data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Null terminate metadata block for decode procedure */
name|res_data
index|[
name|res_a
operator|->
name|data_len
index|]
operator|=
literal|0
expr_stmt|;
name|return_vals
operator|=
name|gimp_run_procedure
argument_list|(
name|DECODE_XMP_PROC
argument_list|,
operator|&
name|nreturn_vals
argument_list|,
name|GIMP_PDB_IMAGE
argument_list|,
name|image_id
argument_list|,
name|GIMP_PDB_STRING
argument_list|,
name|res_data
argument_list|,
name|GIMP_PDB_END
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|res_data
argument_list|)
expr_stmt|;
name|gimp_destroy_params
argument_list|(
name|return_vals
argument_list|,
name|nreturn_vals
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|load_resource_2000 (const PSDimageres * res_a,const gint32 image_id,FILE * f,GError ** error)
name|load_resource_2000
parameter_list|(
specifier|const
name|PSDimageres
modifier|*
name|res_a
parameter_list|,
specifier|const
name|gint32
name|image_id
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gdouble
modifier|*
name|controlpoints
decl_stmt|;
name|gint32
name|x
index|[
literal|3
index|]
decl_stmt|;
name|gint32
name|y
index|[
literal|3
index|]
decl_stmt|;
name|gint32
name|vector_id
init|=
operator|-
literal|1
decl_stmt|;
name|gint16
name|type
decl_stmt|;
name|gint16
name|init_fill
decl_stmt|;
name|gint16
name|num_rec
decl_stmt|;
name|gint16
name|path_rec
decl_stmt|;
name|gint16
name|cntr
decl_stmt|;
name|gint
name|image_width
decl_stmt|;
name|gint
name|image_height
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gboolean
name|closed
decl_stmt|;
name|gboolean
name|fill
decl_stmt|;
comment|/* Load path data from image resources 2000-2998 */
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_debug
argument_list|(
literal|"Process image resource block: %d :Path data"
argument_list|,
name|res_a
operator|->
name|id
argument_list|)
expr_stmt|;
name|path_rec
operator|=
name|res_a
operator|->
name|data_len
operator|/
literal|26
expr_stmt|;
if|if
condition|(
name|path_rec
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|type
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|GINT16_FROM_BE
argument_list|(
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|PSD_PATH_FILL_RULE
condition|)
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Unexpected path record type: %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
name|fill
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
literal|24
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|path_rec
operator|--
expr_stmt|;
if|if
condition|(
name|path_rec
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|image_width
operator|=
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|image_height
operator|=
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
comment|/* Create path */
name|vector_id
operator|=
name|gimp_vectors_new
argument_list|(
name|image_id
argument_list|,
name|res_a
operator|->
name|name
argument_list|)
expr_stmt|;
name|gimp_image_insert_vectors
argument_list|(
name|image_id
argument_list|,
name|vector_id
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|path_rec
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|type
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|GINT16_FROM_BE
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Path record type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|PSD_PATH_FILL_RULE
condition|)
block|{
name|fill
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
literal|24
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|PSD_PATH_FILL_INIT
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|init_fill
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|init_fill
operator|!=
literal|0
condition|)
name|fill
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
literal|22
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|PSD_PATH_CL_LEN
operator|||
name|type
operator|==
name|PSD_PATH_OP_LEN
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|num_rec
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|num_rec
operator|=
name|GINT16_FROM_BE
argument_list|(
name|num_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_rec
operator|>
name|path_rec
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Num path records %d"
argument_list|,
name|num_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|PSD_PATH_CL_LEN
condition|)
name|closed
operator|=
name|TRUE
expr_stmt|;
else|else
name|closed
operator|=
name|FALSE
expr_stmt|;
name|cntr
operator|=
literal|0
expr_stmt|;
name|controlpoints
operator|=
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gdouble
argument_list|)
operator|*
name|num_rec
operator|*
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
literal|22
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|controlpoints
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|num_rec
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|type
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|GINT16_FROM_BE
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Path record type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|PSD_PATH_CL_LNK
operator|||
name|type
operator|==
name|PSD_PATH_CL_UNLNK
operator|||
name|type
operator|==
name|PSD_PATH_OP_LNK
operator|||
name|type
operator|==
name|PSD_PATH_OP_UNLNK
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
operator|&
name|y
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|x
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|y
index|[
literal|1
index|]
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|x
index|[
literal|1
index|]
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|y
index|[
literal|2
index|]
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|x
index|[
literal|2
index|]
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
operator|++
name|i
control|)
block|{
name|x
index|[
name|i
index|]
operator|=
name|GINT32_FROM_BE
argument_list|(
name|x
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|controlpoints
index|[
name|cntr
index|]
operator|=
name|x
index|[
name|i
index|]
operator|/
literal|16777216.0
operator|*
name|image_width
expr_stmt|;
name|cntr
operator|++
expr_stmt|;
name|y
index|[
name|i
index|]
operator|=
name|GINT32_FROM_BE
argument_list|(
name|y
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|controlpoints
index|[
name|cntr
index|]
operator|=
name|y
index|[
name|i
index|]
operator|/
literal|16777216.0
operator|*
name|image_height
expr_stmt|;
name|cntr
operator|++
expr_stmt|;
block|}
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_debug
argument_list|(
literal|"Path points (%d,%d), (%d,%d), (%d,%d)"
argument_list|,
name|x
index|[
literal|0
index|]
argument_list|,
name|y
index|[
literal|0
index|]
argument_list|,
name|x
index|[
literal|1
index|]
argument_list|,
name|y
index|[
literal|1
index|]
argument_list|,
name|x
index|[
literal|2
index|]
argument_list|,
name|y
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|IFDBG
argument_list|(
literal|1
argument_list|)
name|g_debug
argument_list|(
literal|"Unexpected path type record %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
literal|24
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|path_rec
operator|--
expr_stmt|;
name|num_rec
operator|--
expr_stmt|;
block|}
comment|/* Add sub-path */
name|gimp_vectors_stroke_new_from_points
argument_list|(
name|vector_id
argument_list|,
name|GIMP_VECTORS_STROKE_TYPE_BEZIER
argument_list|,
name|cntr
argument_list|,
name|controlpoints
argument_list|,
name|closed
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|controlpoints
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
literal|24
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|psd_set_error
argument_list|(
name|feof
argument_list|(
name|f
argument_list|)
argument_list|,
name|errno
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|path_rec
operator|--
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit

