begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"exprtree.h"
end_include

begin_include
include|#
directive|include
file|"builtins.h"
end_include

begin_decl_stmt
specifier|extern
name|double
name|currentX
decl_stmt|,
name|currentY
decl_stmt|,
name|currentR
decl_stmt|,
name|currentA
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|imageWidth
decl_stmt|,
name|imageHeight
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|usesRA
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|intersamplingEnabled
decl_stmt|;
end_decl_stmt

begin_function
name|exprtree
modifier|*
DECL|function|make_number (double num)
name|make_number
parameter_list|(
name|double
name|num
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|EXPR_NUMBER
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|number
operator|=
name|num
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_var (char * name)
name|make_var
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"x"
argument_list|)
operator|==
literal|0
condition|)
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_X
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"y"
argument_list|)
operator|==
literal|0
condition|)
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_Y
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"t"
argument_list|)
operator|==
literal|0
condition|)
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_T
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"r"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_R
expr_stmt|;
name|usesRA
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"a"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_A
expr_stmt|;
name|usesRA
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"W"
argument_list|)
operator|==
literal|0
condition|)
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_W
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"H"
argument_list|)
operator|==
literal|0
condition|)
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_H
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"R"
argument_list|)
operator|==
literal|0
condition|)
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_BIG_R
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"X"
argument_list|)
operator|==
literal|0
condition|)
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_BIG_X
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Y"
argument_list|)
operator|==
literal|0
condition|)
name|tree
operator|->
name|type
operator|=
name|EXPR_VAR_BIG_Y
expr_stmt|;
else|else
block|{
name|tree
operator|->
name|type
operator|=
name|EXPR_VARIABLE
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|var
operator|=
name|register_variable
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_operator (int type,exprtree * left,exprtree * right)
name|make_operator
parameter_list|(
name|int
name|type
parameter_list|,
name|exprtree
modifier|*
name|left
parameter_list|,
name|exprtree
modifier|*
name|right
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
operator|=
name|left
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|=
name|right
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_function (builtin * theBuiltin,exprtree * args)
name|make_function
parameter_list|(
name|builtin
modifier|*
name|theBuiltin
parameter_list|,
name|exprtree
modifier|*
name|args
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|EXPR_FUNC
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|func
operator|.
name|routine
operator|=
name|theBuiltin
operator|->
name|function
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|func
operator|.
name|numArgs
operator|=
name|theBuiltin
operator|->
name|numParams
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|func
operator|.
name|args
operator|=
name|args
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_sequence (exprtree * left,exprtree * right)
name|make_sequence
parameter_list|(
name|exprtree
modifier|*
name|left
parameter_list|,
name|exprtree
modifier|*
name|right
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|EXPR_SEQUENCE
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
operator|=
name|left
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|=
name|right
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_assignment (char * name,exprtree * value)
name|make_assignment
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|exprtree
modifier|*
name|value
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|variable
modifier|*
name|var
init|=
name|register_variable
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|EXPR_ASSIGNMENT
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|assignment
operator|.
name|var
operator|=
name|var
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|assignment
operator|.
name|value
operator|=
name|value
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_if_then (exprtree * condition,exprtree * consequence)
name|make_if_then
parameter_list|(
name|exprtree
modifier|*
name|condition
parameter_list|,
name|exprtree
modifier|*
name|consequence
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|EXPR_IF_THEN
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|condition
operator|=
name|condition
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|consequence
operator|=
name|consequence
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_if_then_else (exprtree * condition,exprtree * consequence,exprtree * alternative)
name|make_if_then_else
parameter_list|(
name|exprtree
modifier|*
name|condition
parameter_list|,
name|exprtree
modifier|*
name|consequence
parameter_list|,
name|exprtree
modifier|*
name|alternative
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|EXPR_IF_THEN_ELSE
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|condition
operator|=
name|condition
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|consequence
operator|=
name|consequence
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|alternative
operator|=
name|alternative
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_while (exprtree * invariant,exprtree * body)
name|make_while
parameter_list|(
name|exprtree
modifier|*
name|invariant
parameter_list|,
name|exprtree
modifier|*
name|body
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|EXPR_WHILE
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|invariant
operator|=
name|invariant
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|body
operator|=
name|body
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|make_do_while (exprtree * body,exprtree * invariant)
name|make_do_while
parameter_list|(
name|exprtree
modifier|*
name|body
parameter_list|,
name|exprtree
modifier|*
name|invariant
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
operator|(
name|exprtree
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|exprtree
argument_list|)
argument_list|)
decl_stmt|;
name|tree
operator|->
name|type
operator|=
name|EXPR_DO_WHILE
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|invariant
operator|=
name|invariant
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|body
operator|=
name|body
expr_stmt|;
name|tree
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|tree
return|;
block|}
end_function

begin_function
name|exprtree
modifier|*
DECL|function|arglist_append (exprtree * list1,exprtree * list2)
name|arglist_append
parameter_list|(
name|exprtree
modifier|*
name|list1
parameter_list|,
name|exprtree
modifier|*
name|list2
parameter_list|)
block|{
name|exprtree
modifier|*
name|tree
init|=
name|list1
decl_stmt|;
while|while
condition|(
name|tree
operator|->
name|next
operator|!=
literal|0
condition|)
name|tree
operator|=
name|tree
operator|->
name|next
expr_stmt|;
name|tree
operator|->
name|next
operator|=
name|list2
expr_stmt|;
return|return
name|list1
return|;
block|}
end_function

end_unit

