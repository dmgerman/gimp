begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"builtins.h"
end_include

begin_include
include|#
directive|include
file|"vars.h"
end_include

begin_include
include|#
directive|include
file|"postfix.h"
end_include

begin_decl_stmt
specifier|extern
name|double
name|currentX
decl_stmt|,
name|currentY
decl_stmt|,
name|currentR
decl_stmt|,
name|currentA
decl_stmt|,
name|imageR
decl_stmt|,
name|imageX
decl_stmt|,
name|imageY
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|imageWidth
decl_stmt|,
name|imageHeight
decl_stmt|;
end_decl_stmt

begin_define
DECL|macro|STACKSIZE
define|#
directive|define
name|STACKSIZE
value|128
end_define

begin_define
DECL|macro|EXPRSIZE
define|#
directive|define
name|EXPRSIZE
value|256
end_define

begin_decl_stmt
DECL|variable|stack
name|double
name|stack
index|[
name|STACKSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|stackp
name|int
name|stackp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|expression
name|postfix
name|expression
index|[
name|EXPRSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|exprp
name|int
name|exprp
decl_stmt|,
DECL|variable|exprlen
name|exprlen
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|stack_push (double * arg)
name|stack_push
parameter_list|(
name|double
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
operator|*
name|arg
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_pop (void * arg)
name|stack_pop
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
operator|--
name|stackp
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_jmp (int * arg)
name|stack_jmp
parameter_list|(
name|int
modifier|*
name|arg
parameter_list|)
block|{
name|exprp
operator|=
operator|*
name|arg
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_jez (int * arg)
name|stack_jez
parameter_list|(
name|int
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|stack
index|[
operator|--
name|stackp
index|]
operator|==
literal|0.0
condition|)
name|exprp
operator|=
operator|*
name|arg
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_jnez (int * arg)
name|stack_jnez
parameter_list|(
name|int
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|stack
index|[
operator|--
name|stackp
index|]
operator|!=
literal|0.0
condition|)
name|exprp
operator|=
operator|*
name|arg
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_add (void * arg)
name|stack_add
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|=
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|+
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
expr_stmt|;
operator|--
name|stackp
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_add_i (double * arg)
name|stack_add_i
parameter_list|(
name|double
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
operator|+=
operator|*
name|arg
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_sub (void * arg)
name|stack_sub
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|=
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|-
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
expr_stmt|;
operator|--
name|stackp
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_sub_i (double * arg)
name|stack_sub_i
parameter_list|(
name|double
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
operator|-=
operator|*
name|arg
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_neg (void * arg)
name|stack_neg
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
operator|=
operator|-
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_mul (void * arg)
name|stack_mul
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|=
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|*
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
expr_stmt|;
operator|--
name|stackp
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_mul_i (double * arg)
name|stack_mul_i
parameter_list|(
name|double
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
operator|*=
operator|*
name|arg
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_div (void * arg)
name|stack_div
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|=
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|/
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
expr_stmt|;
operator|--
name|stackp
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_div_i (double * arg)
name|stack_div_i
parameter_list|(
name|double
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
operator|/=
operator|*
name|arg
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_mod (void * arg)
name|stack_mod
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
operator|=
name|fmod
argument_list|(
name|stack
index|[
name|stackp
operator|-
literal|2
index|]
argument_list|,
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
operator|--
name|stackp
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_mod_i (double * arg)
name|stack_mod_i
parameter_list|(
name|double
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
operator|=
name|fmod
argument_list|(
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
argument_list|,
operator|*
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_x (void * arg)
name|stack_var_x
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|currentX
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_y (void * arg)
name|stack_var_y
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|currentY
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_r (void * arg)
name|stack_var_r
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|currentR
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_a (void * arg)
name|stack_var_a
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|currentA
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_w (void * arg)
name|stack_var_w
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|imageWidth
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_h (void * arg)
name|stack_var_h
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|imageHeight
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_big_r (void * arg)
name|stack_var_big_r
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|imageR
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_big_x (void * arg)
name|stack_var_big_x
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|imageX
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_var_big_y (void * arg)
name|stack_var_big_y
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|imageY
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_variable (variable * var)
name|stack_variable
parameter_list|(
name|variable
modifier|*
name|var
parameter_list|)
block|{
name|stack
index|[
name|stackp
operator|++
index|]
operator|=
name|var
operator|->
name|value
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|stack_assign (variable * var)
name|stack_assign
parameter_list|(
name|variable
modifier|*
name|var
parameter_list|)
block|{
name|var
operator|->
name|value
operator|=
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|make_postfix_recursive (exprtree * tree)
name|make_postfix_recursive
parameter_list|(
name|exprtree
modifier|*
name|tree
parameter_list|)
block|{
specifier|static
name|double
name|theZeroValue
init|=
literal|0.0
decl_stmt|;
switch|switch
condition|(
name|tree
operator|->
name|type
condition|)
block|{
case|case
name|EXPR_NUMBER
case|:
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_push
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|number
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_ADD
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|type
operator|==
name|EXPR_NUMBER
condition|)
block|{
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_add_i
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|val
operator|.
name|number
expr_stmt|;
block|}
else|else
block|{
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
name|stack_add
expr_stmt|;
block|}
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_SUB
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|type
operator|==
name|EXPR_NUMBER
condition|)
block|{
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_sub_i
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|val
operator|.
name|number
expr_stmt|;
block|}
else|else
block|{
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
name|stack_sub
expr_stmt|;
block|}
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_NEG
case|:
comment|/* 	    if (tree->val.operator.left->type == EXPR_NUMBER) 	    { 		expression[exprp].func = (stackfunc)stack_push; 		expression[exprp].arg = -tree->val.operator.left->val.number; 	    } 	    else 	    { */
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
name|stack_neg
expr_stmt|;
comment|/*	    } */
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_MUL
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|type
operator|==
name|EXPR_NUMBER
condition|)
block|{
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_mul_i
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|val
operator|.
name|number
expr_stmt|;
block|}
else|else
block|{
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
name|stack_mul
expr_stmt|;
block|}
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_DIV
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|type
operator|==
name|EXPR_NUMBER
condition|)
block|{
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_div_i
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|val
operator|.
name|number
expr_stmt|;
block|}
else|else
block|{
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
name|stack_div
expr_stmt|;
block|}
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_MOD
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|type
operator|==
name|EXPR_NUMBER
condition|)
block|{
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_mod_i
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
operator|->
name|val
operator|.
name|number
expr_stmt|;
block|}
else|else
block|{
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
name|stack_mod
expr_stmt|;
block|}
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_X
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_x
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_Y
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_y
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_R
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_r
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_A
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_a
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_W
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_w
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_H
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_h
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_BIG_R
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_big_r
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_BIG_X
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_big_x
expr_stmt|;
break|break;
case|case
name|EXPR_VAR_BIG_Y
case|:
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_var_big_y
expr_stmt|;
break|break;
case|case
name|EXPR_FUNC
case|:
block|{
name|exprtree
modifier|*
name|arg
init|=
name|tree
operator|->
name|val
operator|.
name|func
operator|.
name|args
decl_stmt|;
while|while
condition|(
name|arg
operator|!=
literal|0
condition|)
block|{
name|make_postfix_recursive
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|arg
operator|=
name|arg
operator|->
name|next
expr_stmt|;
block|}
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|tree
operator|->
name|val
operator|.
name|func
operator|.
name|routine
expr_stmt|;
break|break;
block|}
case|case
name|EXPR_VARIABLE
case|:
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_variable
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
name|tree
operator|->
name|val
operator|.
name|var
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_ASSIGNMENT
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|assignment
operator|.
name|value
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_assign
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
name|tree
operator|->
name|val
operator|.
name|assignment
operator|.
name|var
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_SEQUENCE
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|left
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_pop
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|operator
operator|.
name|right
argument_list|)
expr_stmt|;
break|break;
case|case
name|EXPR_IF_THEN
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|condition
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_jez
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|label1
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|consequence
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_jmp
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|label2
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|label1
operator|=
name|exprp
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_push
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|theZeroValue
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|label2
operator|=
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_IF_THEN_ELSE
case|:
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|condition
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_jez
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|label1
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|consequence
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_jmp
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|label2
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|label1
operator|=
name|exprp
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|alternative
argument_list|)
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|ifExpr
operator|.
name|label2
operator|=
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_WHILE
case|:
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|label1
operator|=
name|exprp
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|invariant
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_jez
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|label2
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|body
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_pop
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_jmp
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|label1
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|label2
operator|=
name|exprp
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_push
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|theZeroValue
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
break|break;
case|case
name|EXPR_DO_WHILE
case|:
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|label1
operator|=
name|exprp
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|body
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
operator|++
index|]
operator|.
name|func
operator|=
name|stack_pop
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|invariant
argument_list|)
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_jnez
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|tree
operator|->
name|val
operator|.
name|whileExpr
operator|.
name|label1
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|func
operator|=
operator|(
name|stackfunc
operator|)
name|stack_push
expr_stmt|;
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
operator|=
operator|&
name|theZeroValue
expr_stmt|;
operator|++
name|exprp
expr_stmt|;
break|break;
default|default :
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"illegal expr\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|make_postfix (exprtree * tree)
name|make_postfix
parameter_list|(
name|exprtree
modifier|*
name|tree
parameter_list|)
block|{
name|exprp
operator|=
literal|0
expr_stmt|;
name|make_postfix_recursive
argument_list|(
name|tree
argument_list|)
expr_stmt|;
name|exprlen
operator|=
name|exprp
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|output_postfix (void)
name|output_postfix
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"-------------------------\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|exprlen
condition|;
operator|++
name|i
control|)
block|{
name|printf
argument_list|(
literal|"%d   "
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_push
condition|)
name|printf
argument_list|(
literal|"push %f\n"
argument_list|,
operator|*
operator|(
name|double
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_pop
condition|)
name|printf
argument_list|(
literal|"pop\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_jmp
condition|)
name|printf
argument_list|(
literal|"jmp %d\n"
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_jez
condition|)
name|printf
argument_list|(
literal|"jez %d\n"
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_jnez
condition|)
name|printf
argument_list|(
literal|"jnez %d\n"
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_add
condition|)
name|printf
argument_list|(
literal|"add\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_add_i
condition|)
name|printf
argument_list|(
literal|"addi %f\n"
argument_list|,
operator|*
operator|(
name|double
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_sub
condition|)
name|printf
argument_list|(
literal|"sub\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_sub_i
condition|)
name|printf
argument_list|(
literal|"subi %f\n"
argument_list|,
operator|*
operator|(
name|double
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_neg
condition|)
name|printf
argument_list|(
literal|"neg\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_mul
condition|)
name|printf
argument_list|(
literal|"mul\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_mul_i
condition|)
name|printf
argument_list|(
literal|"muli %f\n"
argument_list|,
operator|*
operator|(
name|double
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_div
condition|)
name|printf
argument_list|(
literal|"div\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_div_i
condition|)
name|printf
argument_list|(
literal|"divi %f\n"
argument_list|,
operator|*
operator|(
name|double
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_mod
condition|)
name|printf
argument_list|(
literal|"mod\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_mod_i
condition|)
name|printf
argument_list|(
literal|"modi %f\n"
argument_list|,
operator|*
operator|(
name|double
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_x
condition|)
name|printf
argument_list|(
literal|"push x\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_y
condition|)
name|printf
argument_list|(
literal|"push y\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_r
condition|)
name|printf
argument_list|(
literal|"push r\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_a
condition|)
name|printf
argument_list|(
literal|"push a\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_w
condition|)
name|printf
argument_list|(
literal|"push w\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_h
condition|)
name|printf
argument_list|(
literal|"push h\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_big_r
condition|)
name|printf
argument_list|(
literal|"push R\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_big_x
condition|)
name|printf
argument_list|(
literal|"push X\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|stack_var_big_y
condition|)
name|printf
argument_list|(
literal|"push Y\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_variable
condition|)
name|printf
argument_list|(
literal|"push %s\n"
argument_list|,
operator|(
operator|(
name|variable
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
operator|)
operator|->
name|name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
operator|(
name|stackfunc
operator|)
name|stack_assign
condition|)
name|printf
argument_list|(
literal|"sto %s\n"
argument_list|,
operator|(
operator|(
name|variable
operator|*
operator|)
name|expression
index|[
name|i
index|]
operator|.
name|arg
operator|)
operator|->
name|name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_sin
condition|)
name|printf
argument_list|(
literal|"sin\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_cos
condition|)
name|printf
argument_list|(
literal|"cos\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_tan
condition|)
name|printf
argument_list|(
literal|"tan\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_asin
condition|)
name|printf
argument_list|(
literal|"asin\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_acos
condition|)
name|printf
argument_list|(
literal|"acos\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_atan
condition|)
name|printf
argument_list|(
literal|"atan\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_sign
condition|)
name|printf
argument_list|(
literal|"sign\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_min
condition|)
name|printf
argument_list|(
literal|"min\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_max
condition|)
name|printf
argument_list|(
literal|"max\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_inintv
condition|)
name|printf
argument_list|(
literal|"inintv\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_rand
condition|)
name|printf
argument_list|(
literal|"rand\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_origValXY
condition|)
name|printf
argument_list|(
literal|"origValXY\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_origValXYIntersample
condition|)
name|printf
argument_list|(
literal|"origValXY\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_origValRA
condition|)
name|printf
argument_list|(
literal|"origValRA\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_origValRAIntersample
condition|)
name|printf
argument_list|(
literal|"origValRA\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|expression
index|[
name|i
index|]
operator|.
name|func
operator|==
name|builtin_grayColor
condition|)
name|printf
argument_list|(
literal|"grayColor\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"unknown opcode\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|double
DECL|function|eval_postfix (void)
name|eval_postfix
parameter_list|(
name|void
parameter_list|)
block|{
name|stackp
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|exprp
operator|=
literal|0
init|;
name|exprp
operator|<
name|exprlen
condition|;
operator|++
name|exprp
control|)
name|expression
index|[
name|exprp
index|]
operator|.
name|func
argument_list|(
name|expression
index|[
name|exprp
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
return|return
name|stack
index|[
literal|0
index|]
return|;
block|}
end_function

end_unit

