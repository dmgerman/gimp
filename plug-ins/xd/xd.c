begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  * Copyright (C) 1997 Daniel Risacher  * Copyright (C) 1997 Josh MacDonald  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* XD.C -- Xdelta versioned image plugin.  * Author: Josh MacDonald */
end_comment

begin_comment
comment|/* xd.c loosely based on gz.c by Daniel Risacher */
end_comment

begin_comment
comment|/* gz.c loosley based on url.c by Josh MacDonald */
end_comment

begin_comment
comment|/* gz.c very loosely on hrz.c by Albert Cahalan<acahalan at cs.uml.edu> */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"gtk/gtk.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimp.h"
end_include

begin_include
include|#
directive|include
file|"xdelta.h"
end_include

begin_include
include|#
directive|include
file|"X11/xpm.h"
end_include

begin_define
DECL|macro|PREVIEW_MAX_DIM
define|#
directive|define
name|PREVIEW_MAX_DIM
value|64
end_define

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|load_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|gint32
name|run_mode
parameter_list|,
name|gboolean
name|interactive
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|save_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|gint32
name|run_mode
parameter_list|,
name|gboolean
name|interactive
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|valid_file
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|get_a_version
parameter_list|(
name|XdFile
modifier|*
name|xd
parameter_list|,
name|gchar
modifier|*
name|ext
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|program_name
specifier|const
name|gchar
modifier|*
name|program_name
init|=
literal|"xd"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc */
name|NULL
block|,
comment|/* quit_proc */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc */
block|}
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|()
block|{
specifier|static
name|GParamDef
name|load_args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to load"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"raw_filename"
block|,
literal|"The name entered"
block|}
block|,   }
decl_stmt|;
specifier|static
name|GParamDef
name|load_return_vals
index|[]
init|=
block|{
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Output image"
block|}
block|,   }
decl_stmt|;
specifier|static
name|int
name|nload_args
init|=
sizeof|sizeof
argument_list|(
name|load_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|load_args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|int
name|nload_return_vals
init|=
sizeof|sizeof
argument_list|(
name|load_return_vals
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|load_return_vals
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|GParamDef
name|save_args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Input image"
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Drawable to save"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to save the image in"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"raw_filename"
block|,
literal|"The name of the file to save the image in"
block|}
block|}
decl_stmt|;
specifier|static
name|int
name|nsave_args
init|=
sizeof|sizeof
argument_list|(
name|save_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|save_args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"file_xd_load"
argument_list|,
literal|"extract a file from a XDELTA version file"
argument_list|,
literal|""
argument_list|,
literal|"Josh MacDonald"
argument_list|,
literal|"Josh MacDonald"
argument_list|,
literal|"1997"
argument_list|,
literal|"<Load>/xd"
argument_list|,
name|NULL
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nload_args
argument_list|,
name|nload_return_vals
argument_list|,
name|load_args
argument_list|,
name|load_return_vals
argument_list|)
expr_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"file_xd_save"
argument_list|,
literal|"store a file into an XDELTA version file"
argument_list|,
literal|""
argument_list|,
literal|"Josh MacDonald"
argument_list|,
literal|"Josh MacDonald"
argument_list|,
literal|"1997"
argument_list|,
literal|"<Save>/xd"
argument_list|,
literal|"RGB*, GRAY*, INDEXED*"
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nsave_args
argument_list|,
literal|0
argument_list|,
name|save_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_register_save_handler
argument_list|(
literal|"file_xd_save"
argument_list|,
literal|"xd"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|gimp_register_load_handler
argument_list|(
literal|"file_xd_load"
argument_list|,
literal|"xd"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (char * name,int nparams,GParam * param,int * nreturn_vals,GParam ** return_vals)
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GParam
name|values
index|[
literal|2
index|]
decl_stmt|;
name|GRunModeType
name|run_mode
decl_stmt|;
name|GStatusType
name|status
init|=
name|STATUS_SUCCESS
decl_stmt|;
name|gint32
name|image_ID
decl_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|PARAM_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"file_xd_load"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|image_ID
operator|=
name|load_image
argument_list|(
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|,
name|run_mode
operator|==
name|RUN_INTERACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|image_ID
operator|!=
operator|-
literal|1
condition|)
block|{
operator|*
name|nreturn_vals
operator|=
literal|2
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_SUCCESS
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|PARAM_IMAGE
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
operator|=
name|image_ID
expr_stmt|;
block|}
else|else
block|{
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"file_xd_save"
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|RUN_INTERACTIVE
case|:
break|break;
case|case
name|RUN_NONINTERACTIVE
case|:
comment|/*  Make sure all the arguments are there!  */
if|if
condition|(
name|nparams
operator|!=
literal|4
condition|)
name|status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
case|case
name|RUN_WITH_LAST_VALS
case|:
break|break;
default|default:
break|break;
block|}
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|save_image
argument_list|(
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|,
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|,
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|,
name|run_mode
operator|==
name|RUN_INTERACTIVE
argument_list|)
condition|)
block|{
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_SUCCESS
expr_stmt|;
block|}
else|else
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
block|}
else|else
name|g_assert
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|get_name_ver_and_xd (gchar * filename0,gboolean save_or_n_load,gboolean interactive,gchar ** ext,gint * version,XdFile ** xd)
name|get_name_ver_and_xd
parameter_list|(
name|gchar
modifier|*
name|filename0
parameter_list|,
name|gboolean
name|save_or_n_load
parameter_list|,
name|gboolean
name|interactive
parameter_list|,
name|gchar
modifier|*
modifier|*
name|ext
parameter_list|,
name|gint
modifier|*
name|version
parameter_list|,
name|XdFile
modifier|*
modifier|*
name|xd
parameter_list|)
block|{
name|gchar
modifier|*
name|filename
init|=
name|g_strdup
argument_list|(
name|filename0
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|ext1
init|=
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'.'
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|ext2
decl_stmt|;
name|gchar
modifier|*
name|ext3
decl_stmt|;
operator|*
name|version
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|ext1
operator|||
name|strcmp
argument_list|(
name|ext1
argument_list|,
literal|".xd"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|g_message
argument_list|(
literal|"xd: unrecognized extension %s\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
operator|*
name|ext1
operator|=
literal|0
expr_stmt|;
name|ext2
operator|=
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ext2
condition|)
block|{
name|g_message
argument_list|(
literal|"xd: unrecognized extension %s\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
if|if
condition|(
name|isdigit
argument_list|(
name|ext2
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|gchar
modifier|*
name|end
init|=
name|NULL
decl_stmt|;
operator|*
name|version
operator|=
name|strtol
argument_list|(
name|ext2
operator|+
literal|1
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
operator|*
name|version
operator|<
literal|0
condition|)
block|{
name|g_message
argument_list|(
literal|"xd: illegal version number %s\n"
argument_list|,
name|ext2
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
operator|*
name|ext2
operator|=
literal|0
expr_stmt|;
block|}
name|ext3
operator|=
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ext3
condition|)
block|{
name|g_message
argument_list|(
literal|"xd: unrecognized extension %s\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
operator|*
name|ext
operator|=
name|g_strdup
argument_list|(
name|ext3
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|filename
argument_list|,
literal|".xd"
argument_list|)
expr_stmt|;
if|if
condition|(
name|save_or_n_load
condition|)
block|{
if|if
condition|(
name|valid_file
argument_list|(
name|filename
argument_list|)
condition|)
operator|*
name|xd
operator|=
name|xd_open_write
argument_list|(
name|filename
argument_list|)
expr_stmt|;
else|else
operator|*
name|xd
operator|=
name|xd_create
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|xd
operator|=
name|xd_open_write
argument_list|(
name|filename
argument_list|)
expr_stmt|;
comment|/* !! it's write so it can update preview segments */
if|if
condition|(
operator|!
operator|*
name|xd
condition|)
block|{
name|g_message
argument_list|(
literal|"xd: open failed: %s\n"
argument_list|,
name|gdbm_strerror
argument_list|(
name|gdbm_errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|*
name|version
operator|>
operator|(
operator|(
operator|*
name|xd
operator|)
operator|->
name|versions
operator|+
operator|(
name|save_or_n_load
operator|&&
literal|1
operator|)
operator|)
condition|)
block|{
name|g_message
argument_list|(
literal|"xd: version number too high\n"
argument_list|)
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
if|if
condition|(
operator|*
name|version
operator|<
literal|0
operator|&&
operator|!
name|save_or_n_load
condition|)
block|{
if|if
condition|(
name|interactive
condition|)
block|{
operator|*
name|version
operator|=
name|get_a_version
argument_list|(
operator|*
name|xd
argument_list|,
operator|*
name|ext
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|version
operator|<
literal|0
condition|)
goto|goto
name|bail
goto|;
block|}
else|else
operator|*
name|version
operator|=
operator|(
operator|*
name|xd
operator|)
operator|->
name|versions
operator|-
literal|1
expr_stmt|;
block|}
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
name|bail
label|:
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|image_scale (gint image_id,guint width,guint height)
name|image_scale
parameter_list|(
name|gint
name|image_id
parameter_list|,
name|guint
name|width
parameter_list|,
name|guint
name|height
parameter_list|)
block|{
name|GParam
modifier|*
name|params
decl_stmt|;
name|gint
name|retvals
decl_stmt|;
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_scale"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_IMAGE
argument_list|,
name|image_id
argument_list|,
name|PARAM_DRAWABLE
argument_list|,
name|gimp_image_get_active_layer
argument_list|(
name|image_id
argument_list|)
argument_list|,
name|PARAM_INT32
argument_list|,
name|TRUE
argument_list|,
name|PARAM_FLOAT
argument_list|,
operator|(
name|double
operator|)
literal|0.0
argument_list|,
name|PARAM_FLOAT
argument_list|,
operator|(
name|double
operator|)
literal|0.0
argument_list|,
name|PARAM_FLOAT
argument_list|,
operator|(
name|double
operator|)
name|width
argument_list|,
name|PARAM_FLOAT
argument_list|,
operator|(
name|double
operator|)
name|height
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
return|return
name|params
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|save_image (char * filename,gint32 image_ID,gint32 drawable_ID,gint32 run_mode,gboolean interactive)
name|save_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|gint32
name|run_mode
parameter_list|,
name|gboolean
name|interactive
parameter_list|)
block|{
name|GParam
modifier|*
name|params
decl_stmt|;
name|gint
name|retvals
decl_stmt|;
name|gchar
modifier|*
name|ext
decl_stmt|;
name|gchar
modifier|*
name|tmpname
decl_stmt|;
name|gint
name|ver
decl_stmt|;
name|XdFile
modifier|*
name|xd
decl_stmt|;
if|if
condition|(
operator|!
name|get_name_ver_and_xd
argument_list|(
name|filename
argument_list|,
name|TRUE
argument_list|,
name|interactive
argument_list|,
operator|&
name|ext
argument_list|,
operator|&
name|ver
argument_list|,
operator|&
name|xd
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_temp_name"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_STRING
argument_list|,
name|ext
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
name|tmpname
operator|=
name|params
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
expr_stmt|;
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_file_save"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_INT32
argument_list|,
name|run_mode
argument_list|,
name|PARAM_IMAGE
argument_list|,
name|image_ID
argument_list|,
name|PARAM_DRAWABLE
argument_list|,
name|drawable_ID
argument_list|,
name|PARAM_STRING
argument_list|,
name|tmpname
argument_list|,
name|PARAM_STRING
argument_list|,
name|tmpname
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|==
name|FALSE
operator|||
operator|!
name|valid_file
argument_list|(
name|tmpname
argument_list|)
condition|)
block|{
name|xd_close
argument_list|(
name|xd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tmpname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|xd_checkin
argument_list|(
name|xd
argument_list|,
name|tmpname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|xd_close
argument_list|(
name|xd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tmpname
argument_list|)
expr_stmt|;
name|g_message
argument_list|(
literal|"xd: checkin failed\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|xd_close
argument_list|(
name|xd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tmpname
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gint32
DECL|function|load_image (char * filename,gint32 run_mode,gboolean interactive)
name|load_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|gint32
name|run_mode
parameter_list|,
name|gboolean
name|interactive
parameter_list|)
block|{
name|GParam
modifier|*
name|params
decl_stmt|;
name|gint
name|retvals
decl_stmt|;
name|gchar
modifier|*
name|ext
decl_stmt|;
name|gchar
modifier|*
name|tmpname
decl_stmt|;
name|gint
name|ver
decl_stmt|;
name|XdFile
modifier|*
name|xd
decl_stmt|;
if|if
condition|(
operator|!
name|get_name_ver_and_xd
argument_list|(
name|filename
argument_list|,
name|FALSE
argument_list|,
name|interactive
argument_list|,
operator|&
name|ext
argument_list|,
operator|&
name|ver
argument_list|,
operator|&
name|xd
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_temp_name"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_STRING
argument_list|,
name|ext
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
name|tmpname
operator|=
name|params
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
expr_stmt|;
if|if
condition|(
name|xd_checkout
argument_list|(
name|xd
argument_list|,
name|tmpname
argument_list|,
name|ver
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|g_message
argument_list|(
literal|"xd: checkout failed\n"
argument_list|)
expr_stmt|;
name|xd_close
argument_list|(
name|xd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_file_load"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_INT32
argument_list|,
name|run_mode
argument_list|,
name|PARAM_STRING
argument_list|,
name|tmpname
argument_list|,
name|PARAM_STRING
argument_list|,
name|tmpname
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
name|gimp_image_set_filename
argument_list|(
name|params
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|xd_close
argument_list|(
name|xd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tmpname
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|==
name|FALSE
condition|)
return|return
operator|-
literal|1
return|;
else|else
return|return
name|params
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|valid_file (char * filename)
name|valid_file
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|int
name|stat_res
decl_stmt|;
name|struct
name|stat
name|buf
decl_stmt|;
name|stat_res
operator|=
name|stat
argument_list|(
name|filename
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
literal|0
operator|==
name|stat_res
operator|)
operator|&&
operator|(
name|buf
operator|.
name|st_size
operator|>
literal|0
operator|)
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
DECL|variable|preview_selected_version
specifier|static
name|gint
name|preview_selected_version
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|preview_xd
specifier|static
name|XdFile
modifier|*
name|preview_xd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|xpm_buffers
specifier|static
name|datum
modifier|*
name|xpm_buffers
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|xpm_pixmaps
specifier|static
name|GdkPixmap
modifier|*
modifier|*
name|xpm_pixmaps
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|select_callback (GtkWidget * data)
name|select_callback
parameter_list|(
name|GtkWidget
modifier|*
name|data
parameter_list|)
block|{
name|gtk_main_quit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|cancel_callback (GtkWidget * widget)
name|cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
block|{
name|preview_selected_version
operator|=
operator|-
literal|1
expr_stmt|;
name|gtk_main_quit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|destroy_callback (GtkWidget * widget)
name|destroy_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
block|{
name|gtk_main_quit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|preview_event (GtkWidget * widget,GdkEvent * event)
name|preview_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|gint
name|image_no
init|=
operator|(
name|gint
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
decl_stmt|;
name|gint
name|h
decl_stmt|,
name|w
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_EXPOSE
case|:
name|gdk_window_get_size
argument_list|(
name|xpm_pixmaps
index|[
name|image_no
index|]
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
name|gdk_draw_pixmap
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|widget
argument_list|)
operator|->
name|widget
operator|.
name|window
argument_list|,
name|GTK_DRAWING_AREA
argument_list|(
name|widget
argument_list|)
operator|->
name|widget
operator|.
name|style
operator|->
name|white_gc
argument_list|,
name|xpm_pixmaps
index|[
name|image_no
index|]
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|select_event (GtkWidget * widget,GdkEvent * event)
name|select_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|preview_selected_version
operator|=
operator|(
name|gint
operator|)
name|gtk_object_get_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|datum
DECL|function|get_buffer (XdFile * xd,gchar * ext,gint ver)
name|get_buffer
parameter_list|(
name|XdFile
modifier|*
name|xd
parameter_list|,
name|gchar
modifier|*
name|ext
parameter_list|,
name|gint
name|ver
parameter_list|)
block|{
name|char
name|req
index|[
literal|64
index|]
decl_stmt|;
name|datum
name|dat
decl_stmt|;
name|datum
name|key
decl_stmt|;
name|datum
name|err
decl_stmt|;
name|err
operator|.
name|dptr
operator|=
name|NULL
expr_stmt|;
name|sprintf
argument_list|(
name|req
argument_list|,
literal|"xdelta-xpm-%d-%d"
argument_list|,
name|PREVIEW_MAX_DIM
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|key
operator|.
name|dptr
operator|=
operator|(
name|guchar
operator|*
operator|)
name|req
expr_stmt|;
name|key
operator|.
name|dsize
operator|=
name|strlen
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|dat
operator|=
name|gdbm_fetch
argument_list|(
name|xd
operator|->
name|dbf
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dat
operator|.
name|dptr
condition|)
block|{
name|GParam
modifier|*
name|params
decl_stmt|;
name|gchar
modifier|*
name|tmpname
decl_stmt|;
name|gint
name|retvals
decl_stmt|;
name|gint
name|image_id
decl_stmt|,
name|drawable_id
decl_stmt|;
name|guint
name|neww
decl_stmt|,
name|newh
decl_stmt|;
name|MappedFile
modifier|*
name|map
decl_stmt|;
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_temp_name"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_STRING
argument_list|,
name|ext
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
name|tmpname
operator|=
name|params
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
expr_stmt|;
if|if
condition|(
name|xd_checkout
argument_list|(
name|xd
argument_list|,
name|tmpname
argument_list|,
name|ver
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|g_message
argument_list|(
literal|"xd: checkout failed\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_file_load"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_INT32
argument_list|,
name|RUN_NONINTERACTIVE
argument_list|,
name|PARAM_STRING
argument_list|,
name|tmpname
argument_list|,
name|PARAM_STRING
argument_list|,
name|tmpname
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|==
name|FALSE
condition|)
goto|goto
name|bail
goto|;
name|image_id
operator|=
name|params
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|gimp_image_flatten
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
operator|>
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
condition|)
block|{
name|neww
operator|=
name|PREVIEW_MAX_DIM
expr_stmt|;
name|newh
operator|=
operator|(
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
operator|*
name|PREVIEW_MAX_DIM
operator|)
operator|/
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|newh
operator|=
name|PREVIEW_MAX_DIM
expr_stmt|;
name|neww
operator|=
operator|(
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
operator|*
name|PREVIEW_MAX_DIM
operator|)
operator|/
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
block|}
name|drawable_id
operator|=
name|image_scale
argument_list|(
name|image_id
argument_list|,
name|neww
argument_list|,
name|newh
argument_list|)
expr_stmt|;
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_temp_name"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_STRING
argument_list|,
literal|"xpm"
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
name|tmpname
operator|=
name|params
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
expr_stmt|;
name|params
operator|=
name|gimp_run_procedure
argument_list|(
literal|"gimp_file_save"
argument_list|,
operator|&
name|retvals
argument_list|,
name|PARAM_INT32
argument_list|,
name|RUN_NONINTERACTIVE
argument_list|,
name|PARAM_IMAGE
argument_list|,
name|image_id
argument_list|,
name|PARAM_DRAWABLE
argument_list|,
name|drawable_id
argument_list|,
name|PARAM_STRING
argument_list|,
name|tmpname
argument_list|,
name|PARAM_STRING
argument_list|,
name|tmpname
argument_list|,
name|PARAM_END
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|==
name|FALSE
operator|||
operator|!
name|valid_file
argument_list|(
name|tmpname
argument_list|)
condition|)
goto|goto
name|bail
goto|;
name|map
operator|=
name|map_file
argument_list|(
name|tmpname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|map
condition|)
goto|goto
name|bail
goto|;
name|dat
operator|.
name|dptr
operator|=
name|map
operator|->
name|seg
expr_stmt|;
name|dat
operator|.
name|dsize
operator|=
name|map
operator|->
name|len
expr_stmt|;
if|if
condition|(
name|gdbm_store
argument_list|(
name|xd
operator|->
name|dbf
argument_list|,
name|key
argument_list|,
name|dat
argument_list|,
name|GDBM_REPLACE
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|bail
goto|;
block|}
return|return
name|dat
return|;
name|bail
label|:
name|g_message
argument_list|(
literal|"xd: save failed in preview generation\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|GdkPixmap
modifier|*
DECL|function|gdk_pixmap_create_from_xpm_b (GdkWindow * window,GdkBitmap ** mask,GdkColor * transparent_color,guint8 * segment,gint len)
name|gdk_pixmap_create_from_xpm_b
parameter_list|(
name|GdkWindow
modifier|*
name|window
parameter_list|,
name|GdkBitmap
modifier|*
modifier|*
name|mask
parameter_list|,
name|GdkColor
modifier|*
name|transparent_color
parameter_list|,
name|guint8
modifier|*
name|segment
parameter_list|,
name|gint
name|len
parameter_list|)
block|{
name|gchar
modifier|*
name|foo
init|=
literal|"/tmp/foo.xpm"
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|g_print
argument_list|(
literal|"gdk_pixmap_create_from_xpm: this proceedure is slow because Peter is a wuss.  it should be rewritten."
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|foo
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|segment
argument_list|,
name|len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
return|return
name|gdk_pixmap_create_from_xpm
argument_list|(
name|window
argument_list|,
name|mask
argument_list|,
name|transparent_color
argument_list|,
name|foo
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|get_a_version (XdFile * xd,gchar * ext)
name|get_a_version
parameter_list|(
name|XdFile
modifier|*
name|xd
parameter_list|,
name|gchar
modifier|*
name|ext
parameter_list|)
block|{
comment|/* Come up with a dialog presenting all previews, a field for pixel    * size, and a button to regenerate previews with the pixel size.    * Clicking on an image selects the version. */
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|listbox
decl_stmt|;
name|GtkWidget
modifier|*
name|plist
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|argv
decl_stmt|;
name|gint
name|argc
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|xd
operator|->
name|versions
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|xpm_buffers
operator|=
name|g_new0
argument_list|(
name|datum
argument_list|,
name|xd
operator|->
name|versions
argument_list|)
expr_stmt|;
name|xpm_pixmaps
operator|=
name|g_new0
argument_list|(
name|GdkPixmap
operator|*
argument_list|,
name|xd
operator|->
name|versions
argument_list|)
expr_stmt|;
name|preview_xd
operator|=
name|xd
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|xd
operator|->
name|versions
condition|;
name|i
operator|+=
literal|1
control|)
block|{
name|xpm_buffers
index|[
name|i
index|]
operator|=
name|get_buffer
argument_list|(
name|xd
argument_list|,
name|ext
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xpm_buffers
index|[
name|i
index|]
operator|.
name|dptr
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|argc
operator|=
literal|1
expr_stmt|;
name|argv
operator|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
name|g_strdup
argument_list|(
literal|"save"
argument_list|)
expr_stmt|;
name|gtk_init
argument_list|(
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|gtk_rc_parse
argument_list|(
name|gimp_gtkrc
argument_list|()
argument_list|)
expr_stmt|;
comment|/* Dialog */
name|dlg
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"Load from Xdelta File"
argument_list|)
expr_stmt|;
name|gtk_window_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|destroy_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Button box */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Preview list */
name|listbox
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|listbox
argument_list|,
comment|/*W*/
operator|(
name|PREVIEW_MAX_DIM
operator|+
literal|4
operator|)
operator|*
literal|2
argument_list|,
comment|/*H*/
operator|(
name|PREVIEW_MAX_DIM
operator|+
literal|4
operator|)
operator|*
literal|4
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|listbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Button box */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Generate button */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Select"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect_object
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|select_callback
argument_list|,
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
comment|/* Cancel button */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Cancel"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect_object
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|cancel_callback
argument_list|,
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|plist
operator|=
name|gtk_list_new
argument_list|()
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|listbox
argument_list|)
argument_list|,
name|plist
argument_list|)
expr_stmt|;
name|gtk_list_set_selection_mode
argument_list|(
name|GTK_LIST
argument_list|(
name|plist
argument_list|)
argument_list|,
name|GTK_SELECTION_BROWSE
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|plist
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|listbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|xd
operator|->
name|versions
condition|;
name|i
operator|+=
literal|1
control|)
block|{
name|GtkWidget
modifier|*
name|list_item
decl_stmt|;
name|GtkWidget
modifier|*
name|lhbox
decl_stmt|;
name|GtkWidget
modifier|*
name|drawing_area
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GString
modifier|*
name|text
decl_stmt|;
comment|/* List Item */
name|list_item
operator|=
name|gtk_list_item_new
argument_list|()
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|i
argument_list|)
expr_stmt|;
comment|/* with a hbox */
name|lhbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|list_item
argument_list|)
argument_list|,
name|lhbox
argument_list|)
expr_stmt|;
comment|/* and a drawing area. */
name|drawing_area
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_drawing_area_size
argument_list|(
name|GTK_DRAWING_AREA
argument_list|(
name|drawing_area
argument_list|)
argument_list|,
name|PREVIEW_MAX_DIM
operator|+
literal|4
argument_list|,
name|PREVIEW_MAX_DIM
operator|+
literal|4
argument_list|)
expr_stmt|;
name|gtk_object_set_user_data
argument_list|(
name|GTK_OBJECT
argument_list|(
name|drawing_area
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|i
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|drawing_area
argument_list|,
name|GDK_EXPOSURE_MASK
operator||
name|GDK_BUTTON_PRESS_MASK
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|lhbox
argument_list|)
argument_list|,
name|drawing_area
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|drawing_area
argument_list|)
argument_list|,
literal|"event"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|preview_event
argument_list|,
name|drawing_area
argument_list|)
expr_stmt|;
comment|/* and a label */
name|text
operator|=
name|g_string_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|g_string_sprintf
argument_list|(
name|text
argument_list|,
literal|"version %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|text
operator|->
name|str
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|lhbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|text
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gtk_list_append_items
argument_list|(
name|GTK_LIST
argument_list|(
name|plist
argument_list|)
argument_list|,
name|g_list_prepend
argument_list|(
name|NULL
argument_list|,
name|list_item
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"select"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|select_event
argument_list|,
name|list_item
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|drawing_area
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|lhbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|list_item
argument_list|)
expr_stmt|;
name|xpm_pixmaps
index|[
name|i
index|]
operator|=
name|gdk_pixmap_create_from_xpm_b
argument_list|(
name|drawing_area
operator|->
name|window
argument_list|,
name|NULL
argument_list|,
operator|&
name|drawing_area
operator|->
name|style
operator|->
name|bg
index|[
name|GTK_STATE_SELECTED
index|]
argument_list|,
name|xpm_buffers
index|[
name|i
index|]
operator|.
name|dptr
argument_list|,
name|xpm_buffers
index|[
name|i
index|]
operator|.
name|dsize
argument_list|)
expr_stmt|;
block|}
comment|/* Select the most recent version. */
name|gtk_list_select_item
argument_list|(
name|GTK_LIST
argument_list|(
name|plist
argument_list|)
argument_list|,
name|xd
operator|->
name|versions
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
return|return
name|preview_selected_version
return|;
block|}
end_function

end_unit

