begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * Universal plug-in -- universal matrix filter  * Copyright (C) 1997 Ole Steinfatt  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_comment
comment|/*  * The plug-in code structure is based on the Whirl plug-in,  * which is Copyright (C) 1997 Federico Mena Quintero  *   * The basic code is form the solid_noise plug-in  * Copyright (C) 1997 Marcelo de Gomensoro Malheiros  *  * The convolution is copied from the sharpen plug-in  * Copyright 1997 Michael Sweet  *  * Also some stuff from some other plug-ins and from the Gimp has  * been used. Thanks to all!   */
end_comment

begin_comment
comment|/* Version 0.0:  *  *  My first try  */
end_comment

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"gtk/gtk.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimp.h"
end_include

begin_comment
comment|/*---- Defines ----*/
end_comment

begin_define
DECL|macro|MATRIX_SIZE
define|#
directive|define
name|MATRIX_SIZE
value|3
end_define

begin_define
DECL|macro|ENTRY_WIDTH
define|#
directive|define
name|ENTRY_WIDTH
value|48
end_define

begin_comment
comment|/*---- Typedefs ----*/
end_comment

begin_typedef
DECL|struct|__anon2b3939410108
typedef|typedef
struct|struct
block|{
DECL|member|matrix
name|gint
name|matrix
index|[
name|MATRIX_SIZE
operator|*
name|MATRIX_SIZE
index|]
decl_stmt|;
DECL|member|automatic
name|gint
name|automatic
decl_stmt|;
DECL|member|norm
name|gint
name|norm
decl_stmt|;
DECL|member|bias
name|gint
name|bias
decl_stmt|;
DECL|typedef|UniversalValues
block|}
name|UniversalValues
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2b3939410208
typedef|typedef
struct|struct
block|{
DECL|member|run
name|gint
name|run
decl_stmt|;
DECL|typedef|UniversalInterface
block|}
name|UniversalInterface
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2b3939410308
typedef|typedef
struct|struct
block|{
DECL|member|normentry
name|GtkWidget
modifier|*
name|normentry
decl_stmt|;
DECL|member|normlabel
name|GtkWidget
modifier|*
name|normlabel
decl_stmt|;
DECL|member|biasentry
name|GtkWidget
modifier|*
name|biasentry
decl_stmt|;
DECL|member|biaslabel
name|GtkWidget
modifier|*
name|biaslabel
decl_stmt|;
DECL|member|list
name|GtkWidget
modifier|*
name|list
decl_stmt|;
DECL|typedef|UniDialog
block|}
name|UniDialog
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2b3939410408
typedef|typedef
struct|struct
block|{
DECL|member|name
name|char
modifier|*
name|name
decl_stmt|;
DECL|member|filename
name|char
modifier|*
name|filename
decl_stmt|;
DECL|member|xsize
name|int
name|xsize
decl_stmt|;
DECL|member|ysize
name|int
name|ysize
decl_stmt|;
DECL|member|matrix
name|int
modifier|*
name|matrix
decl_stmt|;
DECL|member|automatic
name|int
name|automatic
decl_stmt|;
DECL|member|norm
name|int
name|norm
decl_stmt|;
DECL|member|bias
name|int
name|bias
decl_stmt|;
DECL|typedef|UniMatrix
block|}
name|UniMatrix
typedef|;
end_typedef

begin_comment
comment|/* Neede for functions copied from the GIMP */
end_comment

begin_typedef
DECL|typedef|QueryFunc
typedef|typedef
name|void
function_decl|(
modifier|*
name|QueryFunc
function_decl|)
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|/*---- Prototypes ----*/
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|universal
parameter_list|(
name|GDrawable
modifier|*
name|drawable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_norm
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* static void uni_save_matrix (UniMatrix *matrix, char *fname); */
end_comment

begin_comment
comment|/* static void uni_load_matrix (char *fname); */
end_comment

begin_function_decl
specifier|static
name|UniMatrix
modifier|*
name|uni_new_matrix
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|UniMatrix
modifier|*
name|uni_new_matrix_with_defaults
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|uni_add_to_list
parameter_list|(
name|UniMatrix
modifier|*
name|matrix
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|universal_dialog
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_toggle_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_entry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_matrixentry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_selector_new_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_selector_get_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_selector_save_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_selector_del_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_do_selector_new_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|,
name|gpointer
name|call_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dialog_selector_select
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Functions copied from the GIMP */
end_comment

begin_function_decl
name|GtkWidget
modifier|*
name|query_string_box
parameter_list|(
name|char
modifier|*
name|title
parameter_list|,
name|char
modifier|*
name|message
parameter_list|,
name|char
modifier|*
name|initial
parameter_list|,
name|QueryFunc
name|callback
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|prune_filename
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*---- Variables ----*/
end_comment

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc */
name|NULL
block|,
comment|/* quit_proc */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|univals
specifier|static
name|UniversalValues
name|univals
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|uniint
specifier|static
name|UniversalInterface
name|uniint
init|=
block|{
name|FALSE
comment|/* run */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|unidlg
specifier|static
name|UniDialog
modifier|*
name|unidlg
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|current_matrix
specifier|static
name|UniMatrix
modifier|*
name|current_matrix
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*---- Functions ----*/
end_comment

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|GParamDef
name|args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Input image"
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Input drawable"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(0,0)"
block|,
literal|"Filter Matrix (0,0)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(0,1)"
block|,
literal|"Filter Matrix (0,1)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(0,2)"
block|,
literal|"Filter Matrix (0,2)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(1,0)"
block|,
literal|"Filter Matrix (1,0)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(1,1)"
block|,
literal|"Filter Matrix (1,1)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(1,2)"
block|,
literal|"Filter Matrix (1,2)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(2,0)"
block|,
literal|"Filter Matrix (2,0)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(2,1)"
block|,
literal|"Filter Matrix (2,1)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"matrix(2,2)"
block|,
literal|"Filter Matrix (2,2)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"auto"
block|,
literal|"Automatic Normalisation (n/y)"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"norm"
block|,
literal|"Normalisation value"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"bias"
block|,
literal|"Bias value"
block|}
block|,        }
decl_stmt|;
specifier|static
name|GParamDef
modifier|*
name|return_vals
init|=
name|NULL
decl_stmt|;
specifier|static
name|gint
name|nargs
init|=
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|gint
name|nreturn_vals
init|=
literal|0
decl_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"plug_in_universal_filter"
argument_list|,
literal|"Universal matrix filter"
argument_list|,
literal|"Filter the image by usage of convolution"
argument_list|,
literal|"O. Steinfatt"
argument_list|,
literal|"O. Steinfatt"
argument_list|,
literal|"June 1997, 0.0"
argument_list|,
literal|"<Image>/Filters/Generic/Universal"
argument_list|,
literal|"RGB*, GRAY*"
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nargs
argument_list|,
name|nreturn_vals
argument_list|,
name|args
argument_list|,
name|return_vals
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (char * name,int nparams,GParam * param,int * nreturn_vals,GParam ** return_vals)
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GParam
name|values
index|[
literal|1
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|GDrawable
modifier|*
name|drawable
decl_stmt|;
name|GRunModeType
name|run_mode
decl_stmt|;
name|GStatusType
name|status
decl_stmt|;
name|status
operator|=
name|STATUS_SUCCESS
expr_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|PARAM_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
comment|/*  Get the specified drawable  */
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
argument_list|)
expr_stmt|;
comment|/*  See how we will run  */
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|RUN_INTERACTIVE
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
literal|"plug_in_universal"
argument_list|,
operator|&
name|univals
argument_list|)
expr_stmt|;
comment|/*  Get information from the dialog  */
if|if
condition|(
operator|!
name|universal_dialog
argument_list|()
condition|)
return|return;
break|break;
case|case
name|RUN_NONINTERACTIVE
case|:
comment|/*  Make sure all the arguments are present  */
if|if
condition|(
name|nparams
operator|!=
literal|15
condition|)
name|status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|STATUS_SUCCESS
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|MATRIX_SIZE
operator|*
name|MATRIX_SIZE
operator|)
condition|;
name|i
operator|++
control|)
name|univals
operator|.
name|matrix
index|[
name|i
index|]
operator|=
name|param
index|[
literal|3
operator|+
name|i
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|univals
operator|.
name|automatic
operator|=
name|param
index|[
literal|12
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|univals
operator|.
name|norm
operator|=
name|param
index|[
literal|13
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|univals
operator|.
name|bias
operator|=
name|param
index|[
literal|14
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
block|}
break|break;
case|case
name|RUN_WITH_LAST_VALS
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
literal|"plug_in_universal"
argument_list|,
operator|&
name|univals
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/*  Create texture  */
if|if
condition|(
operator|(
name|status
operator|==
name|STATUS_SUCCESS
operator|)
operator|&&
operator|(
name|gimp_drawable_color
argument_list|(
name|drawable
operator|->
name|id
argument_list|)
operator|||
name|gimp_drawable_gray
argument_list|(
name|drawable
operator|->
name|id
argument_list|)
operator|)
condition|)
block|{
comment|/*  Set the tile cache size  */
name|gimp_tile_cache_ntiles
argument_list|(
operator|(
name|drawable
operator|->
name|width
operator|+
name|gimp_tile_width
argument_list|()
operator|-
literal|1
operator|)
operator|/
name|gimp_tile_width
argument_list|()
argument_list|)
expr_stmt|;
comment|/*  Run!  */
name|universal
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
comment|/*  If run mode is interactive, flush displays  */
if|if
condition|(
name|run_mode
operator|!=
name|RUN_NONINTERACTIVE
condition|)
name|gimp_displays_flush
argument_list|()
expr_stmt|;
comment|/*  Store data  */
if|if
condition|(
name|run_mode
operator|==
name|RUN_INTERACTIVE
condition|)
name|gimp_set_data
argument_list|(
literal|"plug_in_universal"
argument_list|,
operator|&
name|univals
argument_list|,
sizeof|sizeof
argument_list|(
name|UniversalValues
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* gimp_message ("Universal Filter: cannot operate on indexed color images"); */
name|status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|calc_norm (void)
specifier|static
name|void
name|calc_norm
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|univals
operator|.
name|automatic
condition|)
block|{
name|univals
operator|.
name|norm
operator|=
literal|0
expr_stmt|;
name|univals
operator|.
name|bias
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MATRIX_SIZE
operator|*
name|MATRIX_SIZE
condition|;
name|i
operator|++
control|)
name|univals
operator|.
name|norm
operator|+=
name|univals
operator|.
name|matrix
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|univals
operator|.
name|norm
operator|==
literal|0
condition|)
block|{
name|univals
operator|.
name|norm
operator|=
literal|1
expr_stmt|;
name|univals
operator|.
name|bias
operator|=
literal|128
expr_stmt|;
block|}
if|if
condition|(
name|univals
operator|.
name|norm
operator|<
literal|0
condition|)
block|{
name|univals
operator|.
name|norm
operator|=
operator|-
name|univals
operator|.
name|norm
expr_stmt|;
name|univals
operator|.
name|bias
operator|=
literal|255
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|universal (GDrawable * drawable)
name|universal
parameter_list|(
name|GDrawable
modifier|*
name|drawable
parameter_list|)
block|{
name|GPixelRgn
name|src_rgn
decl_stmt|,
comment|/* Source image region */
name|dst_rgn
decl_stmt|;
comment|/* Destination image region */
name|guchar
modifier|*
name|src_rows
index|[
literal|4
index|]
decl_stmt|,
comment|/* Source pixel rows */
modifier|*
name|dst_row
decl_stmt|,
comment|/* Destination pixel row */
modifier|*
name|dst_ptr
decl_stmt|,
comment|/* Current destination pixel */
modifier|*
name|src_filters
index|[
literal|3
index|]
decl_stmt|;
comment|/* Source pixels, ordered for filter */
name|int
name|i
decl_stmt|,
comment|/* Looping vars */
name|x
decl_stmt|,
name|y
decl_stmt|,
comment|/* Current location in image */
name|xmax
decl_stmt|,
comment|/* Maximum filtered X coordinate */
name|row
decl_stmt|,
comment|/* Current row in src_rows */
name|trow
decl_stmt|,
comment|/* Looping var */
name|count
decl_stmt|,
comment|/* Current number of filled src_rows */
name|width
decl_stmt|;
comment|/* Byte width of the image */
name|gint
name|sel_x1
decl_stmt|,
name|sel_y1
decl_stmt|,
name|sel_x2
decl_stmt|,
name|sel_y2
decl_stmt|;
name|gint
name|sel_width
decl_stmt|,
name|sel_height
decl_stmt|;
name|gint
name|img_bpp
decl_stmt|;
comment|/*   * Calculate normalisation value   */
name|calc_norm
argument_list|()
expr_stmt|;
comment|/*   * Find boundaries   */
name|gimp_drawable_mask_bounds
argument_list|(
name|drawable
operator|->
name|id
argument_list|,
operator|&
name|sel_x1
argument_list|,
operator|&
name|sel_y1
argument_list|,
operator|&
name|sel_x2
argument_list|,
operator|&
name|sel_y2
argument_list|)
expr_stmt|;
name|sel_width
operator|=
name|sel_x2
operator|-
name|sel_x1
expr_stmt|;
name|sel_height
operator|=
name|sel_y2
operator|-
name|sel_y1
expr_stmt|;
name|img_bpp
operator|=
name|gimp_drawable_bpp
argument_list|(
name|drawable
operator|->
name|id
argument_list|)
expr_stmt|;
comment|/*   * Let the user know what we're doing...   */
name|gimp_progress_init
argument_list|(
literal|"Filtering..."
argument_list|)
expr_stmt|;
comment|/*   * Setup for filter...   */
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|drawable
argument_list|,
name|sel_x1
argument_list|,
name|sel_y1
argument_list|,
name|sel_width
argument_list|,
name|sel_height
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|dst_rgn
argument_list|,
name|drawable
argument_list|,
name|sel_x1
argument_list|,
name|sel_y1
argument_list|,
name|sel_width
argument_list|,
name|sel_height
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|width
operator|=
name|sel_width
operator|*
name|img_bpp
expr_stmt|;
name|xmax
operator|=
name|width
operator|-
name|img_bpp
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
literal|4
condition|;
name|row
operator|++
control|)
name|src_rows
index|[
name|row
index|]
operator|=
name|g_malloc
argument_list|(
name|width
operator|*
sizeof|sizeof
argument_list|(
name|guchar
argument_list|)
argument_list|)
expr_stmt|;
name|dst_row
operator|=
name|g_malloc
argument_list|(
name|width
operator|*
sizeof|sizeof
argument_list|(
name|guchar
argument_list|)
argument_list|)
expr_stmt|;
comment|/*   * Pre-load the first row for the filter...   */
name|gimp_pixel_rgn_get_row
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|src_rows
index|[
literal|0
index|]
argument_list|,
name|sel_x1
argument_list|,
name|sel_y1
argument_list|,
name|sel_width
argument_list|)
expr_stmt|;
name|row
operator|=
literal|1
expr_stmt|;
name|count
operator|=
literal|1
expr_stmt|;
comment|/*   * Filter...   */
for|for
control|(
name|y
operator|=
name|sel_y1
init|;
name|y
operator|<
name|sel_y2
condition|;
name|y
operator|++
control|)
block|{
comment|/*     * Load the next pixel row...     */
if|if
condition|(
operator|(
name|y
operator|+
literal|1
operator|)
operator|<
name|sel_y2
condition|)
block|{
comment|/*       * Check to see if our src_rows[] array is overflowing yet...       */
if|if
condition|(
name|count
operator|>=
literal|3
condition|)
name|count
operator|--
expr_stmt|;
comment|/*       * Grab the next row...       */
name|gimp_pixel_rgn_get_row
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|src_rows
index|[
name|row
index|]
argument_list|,
name|sel_x1
argument_list|,
name|y
operator|+
literal|1
argument_list|,
name|sel_width
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|row
operator|=
operator|(
name|row
operator|+
literal|1
operator|)
operator|&
literal|3
expr_stmt|;
block|}
else|else
block|{
comment|/*       * No more pixels at the bottom...  Drop the oldest samples...       */
name|count
operator|--
expr_stmt|;
block|}
empty_stmt|;
comment|/*     * Now filter pixels and save the results...     */
if|if
condition|(
name|count
operator|==
literal|3
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|trow
operator|=
operator|(
name|row
operator|+
literal|1
operator|)
operator|&
literal|3
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
operator|,
name|trow
operator|=
operator|(
name|trow
operator|+
literal|1
operator|)
operator|&
literal|3
control|)
name|src_filters
index|[
name|i
index|]
operator|=
name|src_rows
index|[
name|trow
index|]
expr_stmt|;
for|for
control|(
name|x
operator|=
name|img_bpp
operator|,
name|dst_ptr
operator|=
name|dst_row
operator|+
name|img_bpp
init|;
name|x
operator|<
name|xmax
condition|;
name|x
operator|++
operator|,
name|dst_ptr
operator|++
control|)
block|{
name|i
operator|=
operator|(
operator|(
name|univals
operator|.
name|matrix
index|[
literal|4
index|]
operator|*
name|src_filters
index|[
literal|1
index|]
index|[
name|x
index|]
operator|+
name|univals
operator|.
name|matrix
index|[
literal|0
index|]
operator|*
name|src_filters
index|[
literal|0
index|]
index|[
name|x
operator|-
name|img_bpp
index|]
operator|+
name|univals
operator|.
name|matrix
index|[
literal|1
index|]
operator|*
name|src_filters
index|[
literal|0
index|]
index|[
name|x
index|]
operator|+
name|univals
operator|.
name|matrix
index|[
literal|2
index|]
operator|*
name|src_filters
index|[
literal|0
index|]
index|[
name|x
operator|+
name|img_bpp
index|]
operator|+
name|univals
operator|.
name|matrix
index|[
literal|3
index|]
operator|*
name|src_filters
index|[
literal|1
index|]
index|[
name|x
operator|-
name|img_bpp
index|]
operator|+
name|univals
operator|.
name|matrix
index|[
literal|5
index|]
operator|*
name|src_filters
index|[
literal|1
index|]
index|[
name|x
operator|+
name|img_bpp
index|]
operator|+
name|univals
operator|.
name|matrix
index|[
literal|6
index|]
operator|*
name|src_filters
index|[
literal|2
index|]
index|[
name|x
operator|-
name|img_bpp
index|]
operator|+
name|univals
operator|.
name|matrix
index|[
literal|7
index|]
operator|*
name|src_filters
index|[
literal|2
index|]
index|[
name|x
index|]
operator|+
name|univals
operator|.
name|matrix
index|[
literal|8
index|]
operator|*
name|src_filters
index|[
literal|2
index|]
index|[
name|x
operator|+
name|img_bpp
index|]
operator|)
operator|/
name|univals
operator|.
name|norm
operator|)
operator|+
name|univals
operator|.
name|bias
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
operator|*
name|dst_ptr
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|>
literal|255
condition|)
operator|*
name|dst_ptr
operator|=
literal|255
expr_stmt|;
else|else
operator|*
name|dst_ptr
operator|=
name|i
expr_stmt|;
block|}
empty_stmt|;
name|gimp_pixel_rgn_set_row
argument_list|(
operator|&
name|dst_rgn
argument_list|,
name|dst_row
operator|+
name|img_bpp
argument_list|,
name|sel_x1
operator|+
literal|1
argument_list|,
name|y
argument_list|,
name|sel_width
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
operator|(
name|y
operator|&
literal|15
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
call|(
name|double
call|)
argument_list|(
name|y
operator|-
name|sel_y1
argument_list|)
operator|/
operator|(
name|double
operator|)
name|sel_height
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
comment|/*   * OK, we're done.  Free all memory used...   */
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
literal|4
condition|;
name|row
operator|++
control|)
name|g_free
argument_list|(
name|src_rows
index|[
name|row
index|]
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst_row
argument_list|)
expr_stmt|;
comment|/*   * Update the screen...   */
name|gimp_drawable_flush
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_merge_shadow
argument_list|(
name|drawable
operator|->
name|id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_update
argument_list|(
name|drawable
operator|->
name|id
argument_list|,
name|sel_x1
argument_list|,
name|sel_y1
argument_list|,
name|sel_width
argument_list|,
name|sel_height
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|universal_dialog (void)
name|universal_dialog
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|gtable
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|entry
decl_stmt|;
name|GtkWidget
modifier|*
name|listbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|argv
decl_stmt|;
name|gint
name|argc
decl_stmt|;
name|guchar
name|buffer
index|[
literal|32
index|]
decl_stmt|;
DECL|struct|__anon2b3939410508
specifier|static
struct|struct
block|{
DECL|member|label
name|char
modifier|*
name|label
decl_stmt|;
DECL|member|callback
name|GtkSignalFunc
name|callback
decl_stmt|;
block|}
name|buttons
index|[]
init|=
block|{
block|{
literal|"New"
block|,
operator|(
name|GtkSignalFunc
operator|)
operator|&
name|dialog_selector_new_callback
block|}
block|,
block|{
literal|"Get"
block|,
operator|(
name|GtkSignalFunc
operator|)
operator|&
name|dialog_selector_get_callback
block|}
block|,
block|{
literal|"Save"
block|,
operator|(
name|GtkSignalFunc
operator|)
operator|&
name|dialog_selector_save_callback
block|}
block|,
block|{
literal|"Delete"
block|,
operator|(
name|GtkSignalFunc
operator|)
operator|&
name|dialog_selector_del_callback
block|}
block|}
struct|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/*  Set args  */
name|argc
operator|=
literal|1
expr_stmt|;
name|argv
operator|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
name|g_strdup
argument_list|(
literal|"universal"
argument_list|)
expr_stmt|;
name|gtk_init
argument_list|(
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
comment|/*  Init global stucture */
name|unidlg
operator|=
name|g_new
argument_list|(
name|UniDialog
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/*  Dialog initialization  */
name|dlg
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"Universal Filter"
argument_list|)
expr_stmt|;
name|gtk_window_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|dialog_close_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* General table */
name|gtable
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|gtable
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|gtable
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  Frame  */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
literal|"Matrix"
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|gtable
argument_list|)
argument_list|,
name|frame
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  Matrix Table  */
name|table
operator|=
name|gtk_table_new
argument_list|(
name|MATRIX_SIZE
argument_list|,
name|MATRIX_SIZE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MATRIX_SIZE
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MATRIX_SIZE
condition|;
name|j
operator|++
control|)
block|{
comment|/*  Entry fields */
name|entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|entry
argument_list|,
name|j
argument_list|,
name|j
operator|+
literal|1
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|entry
argument_list|,
name|ENTRY_WIDTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|univals
operator|.
name|matrix
index|[
name|i
operator|*
name|MATRIX_SIZE
operator|+
name|j
index|]
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|entry
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|dialog_matrixentry_callback
argument_list|,
operator|&
name|univals
operator|.
name|matrix
index|[
name|i
operator|*
name|MATRIX_SIZE
operator|+
name|j
index|]
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/* Normalisation Frame */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
literal|"Normalisation"
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|gtable
argument_list|)
argument_list|,
name|frame
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* N. Table */
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
comment|/*  Check button #1  */
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
literal|"Automatic"
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|toggle
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_state
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|univals
operator|.
name|automatic
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|dialog_toggle_update
argument_list|,
operator|&
name|univals
operator|.
name|automatic
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
comment|/* Entry 1 */
name|unidlg
operator|->
name|normlabel
operator|=
name|gtk_label_new
argument_list|(
literal|"Divider"
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|unidlg
operator|->
name|normlabel
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|unidlg
operator|->
name|normlabel
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|unidlg
operator|->
name|normlabel
argument_list|,
operator|!
name|univals
operator|.
name|automatic
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|unidlg
operator|->
name|normlabel
argument_list|)
expr_stmt|;
name|unidlg
operator|->
name|normentry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|unidlg
operator|->
name|normentry
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|unidlg
operator|->
name|normentry
argument_list|,
name|ENTRY_WIDTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|univals
operator|.
name|norm
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|unidlg
operator|->
name|normentry
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|unidlg
operator|->
name|normentry
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|dialog_entry_callback
argument_list|,
operator|&
name|univals
operator|.
name|norm
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|unidlg
operator|->
name|normentry
argument_list|,
operator|!
name|univals
operator|.
name|automatic
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|unidlg
operator|->
name|normentry
argument_list|)
expr_stmt|;
comment|/* Entry 2 */
name|unidlg
operator|->
name|biaslabel
operator|=
name|gtk_label_new
argument_list|(
literal|"Bias"
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|unidlg
operator|->
name|biaslabel
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|unidlg
operator|->
name|biaslabel
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|unidlg
operator|->
name|biaslabel
argument_list|,
operator|!
name|univals
operator|.
name|automatic
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|unidlg
operator|->
name|biaslabel
argument_list|)
expr_stmt|;
name|unidlg
operator|->
name|biasentry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|unidlg
operator|->
name|biasentry
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_set_usize
argument_list|(
name|unidlg
operator|->
name|biasentry
argument_list|,
name|ENTRY_WIDTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|univals
operator|.
name|bias
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|unidlg
operator|->
name|biasentry
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|unidlg
operator|->
name|biasentry
argument_list|)
argument_list|,
literal|"changed"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|dialog_entry_callback
argument_list|,
operator|&
name|univals
operator|.
name|bias
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|unidlg
operator|->
name|biasentry
argument_list|,
operator|!
name|univals
operator|.
name|automatic
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|unidlg
operator|->
name|biasentry
argument_list|)
expr_stmt|;
comment|/*  Button #1  */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"OK"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|dialog_ok_callback
argument_list|,
name|dlg
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
comment|/*  Button #2  */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Cancel"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect_object
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gtk_widget_destroy
argument_list|,
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/* Selection Frame */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
literal|"Defined"
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|gtable
argument_list|)
argument_list|,
name|frame
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Selection List */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|listbox
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|listbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* gtk_scrolled_window_set_policy (GTK_SCROLLED_WINDOW (listbox), 	  			  GTK_POLICY_AUTOMATIC, 				  GTK_POLICY_ALWAYS); */
name|gtk_widget_set_usize
argument_list|(
name|listbox
argument_list|,
literal|100
comment|/* DLG_LISTBOX_WIDTH */
argument_list|,
literal|100
comment|/* DLG_LISTBOX_HEIGHT */
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|listbox
argument_list|)
expr_stmt|;
name|unidlg
operator|->
name|list
operator|=
name|gtk_list_new
argument_list|()
expr_stmt|;
name|gtk_list_set_selection_mode
argument_list|(
name|GTK_LIST
argument_list|(
name|unidlg
operator|->
name|list
argument_list|)
argument_list|,
name|GTK_SELECTION_BROWSE
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|listbox
argument_list|)
argument_list|,
name|unidlg
operator|->
name|list
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|unidlg
operator|->
name|list
argument_list|)
expr_stmt|;
name|uni_new_matrix_with_defaults
argument_list|(
literal|"default"
argument_list|)
expr_stmt|;
comment|/*    *	Buttons    */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|buttons
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|buttons
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
name|buttons
index|[
name|i
index|]
operator|.
name|label
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
name|buttons
index|[
name|i
index|]
operator|.
name|callback
argument_list|,
name|dlg
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
block|}
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
comment|/*  additional features diabled for the moment */
comment|/*  gtk_widget_show (frame); */
comment|/* Display all */
name|gtk_widget_show
argument_list|(
name|gtable
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
return|return
name|uniint
operator|.
name|run
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_close_callback (GtkWidget * widget,gpointer data)
name|dialog_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gtk_main_quit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_toggle_update (GtkWidget * widget,gpointer data)
name|dialog_toggle_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
modifier|*
name|toggle_val
decl_stmt|;
name|char
name|buffer
index|[
literal|10
index|]
decl_stmt|;
name|toggle_val
operator|=
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
operator|->
name|active
condition|)
operator|*
name|toggle_val
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|toggle_val
operator|=
name|FALSE
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|unidlg
operator|->
name|normentry
argument_list|,
operator|!
operator|(
operator|*
name|toggle_val
operator|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|unidlg
operator|->
name|normlabel
argument_list|,
operator|!
operator|(
operator|*
name|toggle_val
operator|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|unidlg
operator|->
name|biasentry
argument_list|,
operator|!
operator|(
operator|*
name|toggle_val
operator|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|unidlg
operator|->
name|biaslabel
argument_list|,
operator|!
operator|(
operator|*
name|toggle_val
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|toggle_val
condition|)
block|{
name|calc_norm
argument_list|()
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|univals
operator|.
name|norm
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|unidlg
operator|->
name|normentry
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|univals
operator|.
name|bias
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|unidlg
operator|->
name|biasentry
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_entry_callback (GtkWidget * widget,gpointer data)
name|dialog_entry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gint
modifier|*
name|text_val
decl_stmt|;
name|text_val
operator|=
operator|(
name|gint
operator|*
operator|)
name|data
expr_stmt|;
operator|*
name|text_val
operator|=
name|atoi
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_matrixentry_callback (GtkWidget * widget,gpointer data)
name|dialog_matrixentry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gint
modifier|*
name|text_val
decl_stmt|;
name|char
name|buffer
index|[
literal|10
index|]
decl_stmt|;
name|text_val
operator|=
operator|(
name|gint
operator|*
operator|)
name|data
expr_stmt|;
operator|*
name|text_val
operator|=
name|atoi
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|univals
operator|.
name|automatic
condition|)
block|{
name|calc_norm
argument_list|()
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|univals
operator|.
name|norm
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|unidlg
operator|->
name|normentry
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|univals
operator|.
name|bias
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|unidlg
operator|->
name|biasentry
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_ok_callback (GtkWidget * widget,gpointer data)
name|dialog_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|uniint
operator|.
name|run
operator|=
name|TRUE
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|GTK_WIDGET
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_selector_new_callback (GtkWidget * widget,gpointer data)
name|dialog_selector_new_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|query_string_box
argument_list|(
literal|"New Filtermatrix"
argument_list|,
literal|"Enter a name for the new Matrix"
argument_list|,
literal|"untitled"
argument_list|,
name|dialog_do_selector_new_callback
argument_list|,
name|unidlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_do_selector_new_callback (GtkWidget * widget,gpointer client_data,gpointer call_data)
name|dialog_do_selector_new_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|client_data
parameter_list|,
name|gpointer
name|call_data
parameter_list|)
block|{
name|char
modifier|*
name|new_name
init|=
name|call_data
decl_stmt|;
name|UniMatrix
modifier|*
name|matrix
decl_stmt|;
name|g_assert
argument_list|(
name|new_name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|matrix
operator|=
name|uni_new_matrix_with_defaults
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_selector_get_callback (GtkWidget * widget,gpointer data)
name|dialog_selector_get_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
name|current_matrix
operator|==
name|NULL
condition|)
return|return;
name|univals
operator|.
name|automatic
operator|=
name|current_matrix
operator|->
name|automatic
expr_stmt|;
name|univals
operator|.
name|norm
operator|=
name|current_matrix
operator|->
name|norm
expr_stmt|;
name|univals
operator|.
name|bias
operator|=
name|current_matrix
operator|->
name|bias
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_selector_save_callback (GtkWidget * widget,gpointer data)
name|dialog_selector_save_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{  }
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_selector_del_callback (GtkWidget * widget,gpointer data)
name|dialog_selector_del_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
DECL|function|dialog_selector_select (GtkWidget * widget,gpointer data)
name|dialog_selector_select
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|current_matrix
operator|=
name|data
expr_stmt|;
block|}
end_function

begin_comment
comment|/* static void uni_load_matrix (char *filename) {   FILE            *file;   char            line[1024];   UniMatrix       *matrix;   int             i;     g_assert(filename != NULL);    file = fopen(filename, "r");   if (!file) return;    fgets(line, 1024, file);   if (strcmp(line, "GIMP Matrix\n") != 0) return;       matrix = uni_new_matrix();      matrix->filename = g_strdup(filename);   matrix->name     = g_strdup(prune_filename(filename));    fgets(line, 1024, file);   matrix->xsize =atoi(line);      fgets(line, 1024, file);   matrix->ysize =atoi(line);    if ((matrix->xsize< 1) || (matrix->ysize< 1)) {     g_warning("uni_load_matrix(): invalid number of rows/colums in \"%s\"",                  filename);     g_free(matrix);     return;       }    matrix->matrix = g_malloc(sizeof(int) * matrix->xsize * matrix->ysize);     for (i=0; i<(matrix->ysize * matrix->xsize); i++) {     fgets(line, 1024, file);     matrix->matrix[i]=atoi(line);   }    fgets(line, 1024, file);   matrix->automatic =atoi(line);   fgets(line, 1024, file);   matrix->norm =atoi(line);   fgets(line, 1024, file);   matrix->bias =atoi(line);         fclose(file);     } */
end_comment

begin_comment
comment|/* static void uni_save_matrix (UniMatrix *matrix, char *filename) {   FILE            *file;   int             i;    g_assert(matrix != NULL);    if (!filename) {     g_warning("uni_save_matrix(): can not save matrix with NULL filename");     return;   }*/
end_comment

begin_comment
comment|/* if */
end_comment

begin_comment
comment|/*   file = fopen(filename, "w");   if (!file) {     g_warning("uni_save_matrix(): can't open \"%s\"", filename);     return;   } */
end_comment

begin_comment
comment|/* if */
end_comment

begin_comment
comment|/* File format is:       *        * GIMP Matrix       * columns       * rows       * value(0,0) (column,row)       * value(1,0)       * ...       * automatic       * divider       * bias       */
end_comment

begin_comment
comment|/*   fprintf (file,"GIMP Matrix\n");   fprintf (file,"%i\n",matrix->xsize);   fprintf (file,"%i\n",matrix->ysize);   for (i=0; i< (matrix->xsize * matrix->ysize); i++)      fprintf (file,"%i",matrix->matrix[i]);   fprintf (file,"%i\n",matrix->automatic);   fprintf (file,"%i\n",matrix->norm);   fprintf (file,"%i\n",matrix->bias);          fclose(file);     } */
end_comment

begin_function
DECL|function|uni_new_matrix (void)
specifier|static
name|UniMatrix
modifier|*
name|uni_new_matrix
parameter_list|(
name|void
parameter_list|)
block|{
name|UniMatrix
modifier|*
name|matrix
decl_stmt|;
name|matrix
operator|=
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|UniMatrix
argument_list|)
argument_list|)
expr_stmt|;
name|matrix
operator|->
name|name
operator|=
name|NULL
expr_stmt|;
name|matrix
operator|->
name|filename
operator|=
name|NULL
expr_stmt|;
name|matrix
operator|->
name|xsize
operator|=
literal|0
expr_stmt|;
name|matrix
operator|->
name|ysize
operator|=
literal|0
expr_stmt|;
name|matrix
operator|->
name|matrix
operator|=
name|NULL
expr_stmt|;
name|matrix
operator|->
name|automatic
operator|=
literal|1
expr_stmt|;
name|matrix
operator|->
name|norm
operator|=
literal|1
expr_stmt|;
name|matrix
operator|->
name|bias
operator|=
literal|0
expr_stmt|;
return|return
name|matrix
return|;
block|}
end_function

begin_function
DECL|function|uni_new_matrix_with_defaults (gchar * name)
specifier|static
name|UniMatrix
modifier|*
name|uni_new_matrix_with_defaults
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|)
block|{
name|UniMatrix
modifier|*
name|matrix
decl_stmt|;
name|int
name|i
decl_stmt|;
name|matrix
operator|=
name|uni_new_matrix
argument_list|()
expr_stmt|;
name|matrix
operator|->
name|name
operator|=
name|name
expr_stmt|;
name|matrix
operator|->
name|filename
operator|=
name|name
expr_stmt|;
name|matrix
operator|->
name|xsize
operator|=
literal|3
expr_stmt|;
name|matrix
operator|->
name|ysize
operator|=
literal|3
expr_stmt|;
name|matrix
operator|->
name|matrix
operator|=
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
literal|9
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
name|matrix
operator|->
name|matrix
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|matrix
operator|->
name|matrix
index|[
literal|4
index|]
operator|=
literal|1
expr_stmt|;
name|matrix
operator|->
name|automatic
operator|=
literal|1
expr_stmt|;
name|matrix
operator|->
name|norm
operator|=
literal|1
expr_stmt|;
name|matrix
operator|->
name|bias
operator|=
literal|0
expr_stmt|;
name|uni_add_to_list
argument_list|(
name|matrix
argument_list|)
expr_stmt|;
return|return
name|matrix
return|;
block|}
end_function

begin_function
DECL|function|uni_add_to_list (UniMatrix * matrix)
specifier|static
name|void
name|uni_add_to_list
parameter_list|(
name|UniMatrix
modifier|*
name|matrix
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|GtkWidget
modifier|*
name|list_item
decl_stmt|;
name|list_item
operator|=
name|gtk_list_item_new_with_label
argument_list|(
name|matrix
operator|->
name|name
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|list_item
argument_list|)
argument_list|,
literal|"select"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|dialog_selector_select
argument_list|,
operator|(
name|gpointer
operator|)
name|matrix
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|list_item
argument_list|)
expr_stmt|;
name|list
operator|=
name|g_list_append
argument_list|(
name|NULL
argument_list|,
name|list_item
argument_list|)
expr_stmt|;
name|gtk_list_insert_items
argument_list|(
name|GTK_LIST
argument_list|(
name|unidlg
operator|->
name|list
argument_list|)
argument_list|,
name|list
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**									**/
end_comment

begin_comment
comment|/**			+++ Miscellaneous				**/
end_comment

begin_comment
comment|/**									**/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/*   These query box functions are yanked from app/interface.c.	taka  */
end_comment

begin_comment
comment|/*  *  A text string query box  */
end_comment

begin_typedef
DECL|typedef|QueryBox
typedef|typedef
name|struct
name|_QueryBox
name|QueryBox
typedef|;
end_typedef

begin_struct
DECL|struct|_QueryBox
struct|struct
name|_QueryBox
block|{
DECL|member|qbox
name|GtkWidget
modifier|*
name|qbox
decl_stmt|;
DECL|member|entry
name|GtkWidget
modifier|*
name|entry
decl_stmt|;
DECL|member|callback
name|QueryFunc
name|callback
decl_stmt|;
DECL|member|data
name|gpointer
name|data
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|query_box_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|query_box_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|GtkWidget
modifier|*
DECL|function|query_string_box (char * title,char * message,char * initial,QueryFunc callback,gpointer data)
name|query_string_box
parameter_list|(
name|char
modifier|*
name|title
parameter_list|,
name|char
modifier|*
name|message
parameter_list|,
name|char
modifier|*
name|initial
parameter_list|,
name|QueryFunc
name|callback
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|QueryBox
modifier|*
name|query_box
decl_stmt|;
name|GtkWidget
modifier|*
name|qbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|entry
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|query_box
operator|=
operator|(
name|QueryBox
operator|*
operator|)
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|QueryBox
argument_list|)
argument_list|)
expr_stmt|;
name|qbox
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|qbox
argument_list|)
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|gtk_window_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|qbox
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|qbox
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"OK"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|query_box_ok_callback
argument_list|,
name|query_box
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|qbox
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Cancel"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|query_box_cancel_callback
argument_list|,
name|query_box
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|qbox
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|qbox
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|entry
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|initial
condition|)
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|initial
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|query_box
operator|->
name|qbox
operator|=
name|qbox
expr_stmt|;
name|query_box
operator|->
name|entry
operator|=
name|entry
expr_stmt|;
name|query_box
operator|->
name|callback
operator|=
name|callback
expr_stmt|;
name|query_box
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|qbox
argument_list|)
expr_stmt|;
return|return
name|qbox
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|query_box_cancel_callback (GtkWidget * w,gpointer client_data)
name|query_box_cancel_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|QueryBox
modifier|*
name|query_box
decl_stmt|;
name|query_box
operator|=
operator|(
name|QueryBox
operator|*
operator|)
name|client_data
expr_stmt|;
comment|/*  Destroy the box  */
name|gtk_widget_destroy
argument_list|(
name|query_box
operator|->
name|qbox
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|query_box_ok_callback (GtkWidget * w,gpointer client_data)
name|query_box_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|client_data
parameter_list|)
block|{
name|QueryBox
modifier|*
name|query_box
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|query_box
operator|=
operator|(
name|QueryBox
operator|*
operator|)
name|client_data
expr_stmt|;
comment|/*  Get the entry data  */
name|string
operator|=
name|g_strdup
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|query_box
operator|->
name|entry
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  Call the user defined callback  */
call|(
modifier|*
name|query_box
operator|->
name|callback
call|)
argument_list|(
name|w
argument_list|,
name|query_box
operator|->
name|data
argument_list|,
operator|(
name|gpointer
operator|)
name|string
argument_list|)
expr_stmt|;
comment|/*  Destroy the box  */
name|gtk_widget_destroy
argument_list|(
name|query_box
operator|->
name|qbox
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Function copied from general.c */
end_comment

begin_comment
comment|/* prune filename removes all of the leading path information to a filename */
end_comment

begin_function
name|char
modifier|*
DECL|function|prune_filename (char * filename)
name|prune_filename
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|char
modifier|*
name|last_slash
init|=
name|filename
decl_stmt|;
while|while
condition|(
operator|*
name|filename
condition|)
if|if
condition|(
operator|*
name|filename
operator|++
operator|==
literal|'/'
condition|)
name|last_slash
operator|=
name|filename
expr_stmt|;
return|return
name|last_slash
return|;
block|}
end_function

end_unit

