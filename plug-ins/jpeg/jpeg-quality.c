begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * jpeg-quality.c  * Copyright (C) 2007 RaphaÃ«l Quinet<raphael@gimp.org>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<jpeglib.h>
end_include

begin_include
include|#
directive|include
file|"jpeg-quality.h"
end_include

begin_comment
comment|/*  * Note that although 0 is a valid quality for IJG's JPEG library, the  * baseline quantization tables for quality 0 and 1 are identical (all  * divisors are set to the maximum value 255).  So 0 can be used here  * to flag unusual settings.  */
end_comment

begin_comment
comment|/* sum of the luminance divisors for quality = 0..100 (IJG standard tables) */
end_comment

begin_decl_stmt
DECL|variable|std_luminance_sum
specifier|static
name|gint
name|std_luminance_sum
index|[
literal|101
index|]
init|=
block|{
name|G_MAXINT
block|,
literal|16320
block|,
literal|16315
block|,
literal|15946
block|,
literal|15277
block|,
literal|14655
block|,
literal|14073
block|,
literal|13623
block|,
literal|13230
block|,
literal|12859
block|,
literal|12560
block|,
literal|12240
block|,
literal|11861
block|,
literal|11456
block|,
literal|11081
block|,
literal|10714
block|,
literal|10360
block|,
literal|10027
block|,
literal|9679
block|,
literal|9368
block|,
literal|9056
block|,
literal|8680
block|,
literal|8331
block|,
literal|7995
block|,
literal|7668
block|,
literal|7376
block|,
literal|7084
block|,
literal|6823
block|,
literal|6562
block|,
literal|6345
block|,
literal|6125
block|,
literal|5939
block|,
literal|5756
block|,
literal|5571
block|,
literal|5421
block|,
literal|5240
block|,
literal|5086
block|,
literal|4976
block|,
literal|4829
block|,
literal|4719
block|,
literal|4616
block|,
literal|4463
block|,
literal|4393
block|,
literal|4280
block|,
literal|4166
block|,
literal|4092
block|,
literal|3980
block|,
literal|3909
block|,
literal|3835
block|,
literal|3755
block|,
literal|3688
block|,
literal|3621
block|,
literal|3541
block|,
literal|3467
block|,
literal|3396
block|,
literal|3323
block|,
literal|3247
block|,
literal|3170
block|,
literal|3096
block|,
literal|3021
block|,
literal|2952
block|,
literal|2874
block|,
literal|2804
block|,
literal|2727
block|,
literal|2657
block|,
literal|2583
block|,
literal|2509
block|,
literal|2437
block|,
literal|2362
block|,
literal|2290
block|,
literal|2211
block|,
literal|2136
block|,
literal|2068
block|,
literal|1996
block|,
literal|1915
block|,
literal|1858
block|,
literal|1773
block|,
literal|1692
block|,
literal|1620
block|,
literal|1552
block|,
literal|1477
block|,
literal|1398
block|,
literal|1326
block|,
literal|1251
block|,
literal|1179
block|,
literal|1109
block|,
literal|1031
block|,
literal|961
block|,
literal|884
block|,
literal|814
block|,
literal|736
block|,
literal|667
block|,
literal|592
block|,
literal|518
block|,
literal|441
block|,
literal|369
block|,
literal|292
block|,
literal|221
block|,
literal|151
block|,
literal|86
block|,
literal|64
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sum of the chrominance divisors for quality = 0..100 (IJG standard tables) */
end_comment

begin_decl_stmt
DECL|variable|std_chrominance_sum
specifier|static
name|gint
name|std_chrominance_sum
index|[
literal|101
index|]
init|=
block|{
name|G_MAXINT
block|,
literal|16320
block|,
literal|16320
block|,
literal|16320
block|,
literal|16218
block|,
literal|16010
block|,
literal|15731
block|,
literal|15523
block|,
literal|15369
block|,
literal|15245
block|,
literal|15110
block|,
literal|14985
block|,
literal|14864
block|,
literal|14754
block|,
literal|14635
block|,
literal|14526
block|,
literal|14429
block|,
literal|14346
block|,
literal|14267
block|,
literal|14204
block|,
literal|13790
block|,
literal|13121
block|,
literal|12511
block|,
literal|11954
block|,
literal|11453
block|,
literal|11010
block|,
literal|10567
block|,
literal|10175
block|,
literal|9787
block|,
literal|9455
block|,
literal|9122
block|,
literal|8844
block|,
literal|8565
block|,
literal|8288
block|,
literal|8114
block|,
literal|7841
block|,
literal|7616
block|,
literal|7447
block|,
literal|7227
block|,
literal|7060
block|,
literal|6897
block|,
literal|6672
block|,
literal|6562
block|,
literal|6396
block|,
literal|6226
block|,
literal|6116
block|,
literal|5948
block|,
literal|5838
block|,
literal|5729
block|,
literal|5614
block|,
literal|5505
block|,
literal|5396
block|,
literal|5281
block|,
literal|5172
block|,
literal|5062
block|,
literal|4947
block|,
literal|4837
block|,
literal|4726
block|,
literal|4614
block|,
literal|4506
block|,
literal|4395
block|,
literal|4282
block|,
literal|4173
block|,
literal|4061
block|,
literal|3950
block|,
literal|3839
block|,
literal|3727
block|,
literal|3617
block|,
literal|3505
block|,
literal|3394
block|,
literal|3284
block|,
literal|3169
block|,
literal|3060
block|,
literal|2949
block|,
literal|2836
block|,
literal|2780
block|,
literal|2669
block|,
literal|2556
block|,
literal|2445
block|,
literal|2336
block|,
literal|2221
block|,
literal|2111
block|,
literal|2000
block|,
literal|1888
block|,
literal|1778
block|,
literal|1666
block|,
literal|1555
block|,
literal|1444
block|,
literal|1332
block|,
literal|1223
block|,
literal|1110
block|,
literal|999
block|,
literal|891
block|,
literal|779
block|,
literal|668
block|,
literal|558
block|,
literal|443
block|,
literal|333
block|,
literal|224
block|,
literal|115
block|,
literal|64
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * jpeg_detect_quality:  * @cinfo: a pointer to a JPEG decompressor info.  *  * Returns the exact or estimated quality value that was used to save  * the JPEG image by analyzing the quantization table divisors.  *  * If an exact match for the IJG quantization tables is found, then a  * quality setting in the range 1..100 is returned.  If the quality  * can only be estimated, then a negative number in the range -1..-100  * is returned; its absolute value represents the maximum IJG quality  * setting to use.  If the quality cannot be reliably determined, then  * 0 is returned.  *  * This function must be called after jpeg_read_header() so that  * @cinfo contains the quantization tables read from the DQT markers  * in the file.  *  * Return Value: the JPEG quality setting in the range 1..100, -1..-100 or 0.  */
end_comment

begin_function
name|gint
DECL|function|jpeg_detect_quality (struct jpeg_decompress_struct * cinfo)
name|jpeg_detect_quality
parameter_list|(
name|struct
name|jpeg_decompress_struct
modifier|*
name|cinfo
parameter_list|)
block|{
name|gint
name|t
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|sum
index|[
literal|3
index|]
decl_stmt|;
name|gint
name|q
decl_stmt|;
comment|/* files using CMYK or having 4 quantization tables are unusual */
if|if
condition|(
operator|!
name|cinfo
operator|||
name|cinfo
operator|->
name|output_components
operator|>
literal|3
operator|||
name|cinfo
operator|->
name|quant_tbl_ptrs
index|[
literal|3
index|]
condition|)
return|return
literal|0
return|;
comment|/* Most files use table 0 for luminance divisors (Y) and table 1 for    * chrominance divisors (Cb and Cr).  Some files use separate tables    * for Cb and Cr, so table 2 may also be used.    */
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|3
condition|;
name|t
operator|++
control|)
block|{
name|sum
index|[
name|t
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cinfo
operator|->
name|quant_tbl_ptrs
index|[
name|t
index|]
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DCTSIZE2
condition|;
name|i
operator|++
control|)
name|sum
index|[
name|t
index|]
operator|+=
name|cinfo
operator|->
name|quant_tbl_ptrs
index|[
name|t
index|]
operator|->
name|quantval
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|cinfo
operator|->
name|output_components
operator|>
literal|1
condition|)
block|{
name|gint
name|sums
decl_stmt|;
if|if
condition|(
name|sum
index|[
literal|0
index|]
operator|<
literal|64
operator|||
name|sum
index|[
literal|1
index|]
operator|<
literal|64
condition|)
return|return
literal|0
return|;
comment|/* compare with the chrominance table having the lowest sum */
if|if
condition|(
name|sum
index|[
literal|1
index|]
operator|<
name|sum
index|[
literal|2
index|]
operator|||
name|sum
index|[
literal|2
index|]
operator|<=
literal|0
condition|)
name|sums
operator|=
name|sum
index|[
literal|0
index|]
operator|+
name|sum
index|[
literal|1
index|]
expr_stmt|;
else|else
name|sums
operator|=
name|sum
index|[
literal|0
index|]
operator|+
name|sum
index|[
literal|2
index|]
expr_stmt|;
name|q
operator|=
literal|100
expr_stmt|;
while|while
condition|(
name|sums
operator|>
name|std_luminance_sum
index|[
name|q
index|]
operator|+
name|std_chrominance_sum
index|[
name|q
index|]
condition|)
name|q
operator|--
expr_stmt|;
if|if
condition|(
name|sum
index|[
literal|0
index|]
operator|==
name|std_luminance_sum
index|[
name|q
index|]
operator|&&
name|sum
index|[
literal|1
index|]
operator|==
name|std_chrominance_sum
index|[
name|q
index|]
condition|)
return|return
name|q
return|;
else|else
return|return
operator|-
name|q
return|;
block|}
else|else
block|{
if|if
condition|(
name|sum
index|[
literal|0
index|]
operator|<
literal|64
condition|)
return|return
literal|0
return|;
name|q
operator|=
literal|100
expr_stmt|;
while|while
condition|(
name|sum
index|[
literal|0
index|]
operator|>
name|std_luminance_sum
index|[
name|q
index|]
condition|)
name|q
operator|--
expr_stmt|;
if|if
condition|(
name|sum
index|[
literal|0
index|]
operator|==
name|std_luminance_sum
index|[
name|q
index|]
condition|)
return|return
name|q
return|;
else|else
return|return
operator|-
name|q
return|;
block|}
block|}
end_function

end_unit

