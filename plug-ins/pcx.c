begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* PCX loading and saving file filter for the Gimp  *  -Francisco Bustamante  *  * This filter's code is based on the GIF loading/saving filter for the GIMP,  * by Peter Mattis, and Spencer Kimball. However, code from the "netpbm" package  * is no longer used in this plug-in.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"gtk/gtk.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimp.h"
end_include

begin_comment
comment|/* Declare some local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|load_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|save_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc */
name|NULL
block|,
comment|/* quit_proc */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc */
block|}
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|()
block|{
specifier|static
name|GParamDef
name|load_args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to load"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"raw_filename"
block|,
literal|"The name entered"
block|}
block|,   }
decl_stmt|;
specifier|static
name|GParamDef
name|load_return_vals
index|[]
init|=
block|{
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Output image"
block|}
block|,   }
decl_stmt|;
specifier|static
name|int
name|nload_args
init|=
sizeof|sizeof
argument_list|(
name|load_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|load_args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|int
name|nload_return_vals
init|=
sizeof|sizeof
argument_list|(
name|load_return_vals
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|load_return_vals
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|GParamDef
name|save_args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Input image"
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Drawable to save"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to save the image in"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"raw_filename"
block|,
literal|"The name entered"
block|}
block|,   }
decl_stmt|;
specifier|static
name|int
name|nsave_args
init|=
sizeof|sizeof
argument_list|(
name|save_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|save_args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"file_pcx_load"
argument_list|,
literal|"Loads files of Zsoft PCX file format"
argument_list|,
literal|"FIXME: write help for pcx_load"
argument_list|,
literal|"Francisco Bustamante"
argument_list|,
literal|"Francisco Bustamante"
argument_list|,
literal|"1997"
argument_list|,
literal|"<Load>/PCX"
argument_list|,
name|NULL
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nload_args
argument_list|,
name|nload_return_vals
argument_list|,
name|load_args
argument_list|,
name|load_return_vals
argument_list|)
expr_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"file_pcx_save"
argument_list|,
literal|"Saves files in ZSoft PCX file format"
argument_list|,
literal|"FIXME: write help for pcx_save"
argument_list|,
literal|"Francisco Bustamante"
argument_list|,
literal|"Francisco Bustamante"
argument_list|,
literal|"1997"
argument_list|,
literal|"<Save>/PCX"
argument_list|,
literal|"INDEXED*"
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nsave_args
argument_list|,
literal|0
argument_list|,
name|save_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_register_magic_load_handler
argument_list|(
literal|"file_pcx_load"
argument_list|,
literal|"pcx"
argument_list|,
literal|""
argument_list|,
literal|"0&,byte,10,2&,byte,1,3&,byte,>0,3,byte,<9"
argument_list|)
expr_stmt|;
name|gimp_register_save_handler
argument_list|(
literal|"file_pcx_save"
argument_list|,
literal|"pcx"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (char * name,int nparams,GParam * param,int * nreturn_vals,GParam ** return_vals)
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GParam
name|values
index|[
literal|2
index|]
decl_stmt|;
name|GStatusType
name|status
init|=
name|STATUS_SUCCESS
decl_stmt|;
name|GRunModeType
name|run_mode
decl_stmt|;
name|gint32
name|image_ID
decl_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|PARAM_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"file_pcx_load"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|image_ID
operator|=
name|load_image
argument_list|(
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|image_ID
operator|!=
operator|-
literal|1
condition|)
block|{
operator|*
name|nreturn_vals
operator|=
literal|2
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_SUCCESS
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|PARAM_IMAGE
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
operator|=
name|image_ID
expr_stmt|;
block|}
else|else
block|{
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"file_pcx_save"
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|RUN_INTERACTIVE
case|:
comment|/*  Possibly retrieve data  */
comment|/*gimp_get_data ("file_pcx_save",&gsvals);*/
comment|/*  First acquire information with a dialog  */
comment|/*  return;*/
break|break;
case|case
name|RUN_NONINTERACTIVE
case|:
comment|/*  Make sure all the arguments are there!  */
if|if
condition|(
name|nparams
operator|!=
literal|5
condition|)
name|status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
break|break;
case|case
name|RUN_WITH_LAST_VALS
case|:
comment|/*  Possibly retrieve data  */
comment|/*	  gimp_get_data ("file_pcx_save",&gsvals);*/
break|break;
default|default:
break|break;
block|}
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|save_image
argument_list|(
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|,
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|)
condition|)
block|{
comment|/*  Store psvals data  */
comment|/*	  gimp_set_data ("file_pcx_save",&gsvals, sizeof (GIFSaveVals));*/
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_SUCCESS
expr_stmt|;
block|}
else|else
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
block|}
block|}
end_function

begin_define
DECL|macro|MAXCOLORMAPSIZE
define|#
directive|define
name|MAXCOLORMAPSIZE
value|256
end_define

begin_define
DECL|macro|TRUE
define|#
directive|define
name|TRUE
value|1
end_define

begin_define
DECL|macro|FALSE
define|#
directive|define
name|FALSE
value|0
end_define

begin_define
DECL|macro|OK
define|#
directive|define
name|OK
value|0
end_define

begin_define
DECL|macro|ERROR
define|#
directive|define
name|ERROR
value|1
end_define

begin_define
DECL|macro|CM_RED
define|#
directive|define
name|CM_RED
value|0
end_define

begin_define
DECL|macro|CM_GREEN
define|#
directive|define
name|CM_GREEN
value|1
end_define

begin_define
DECL|macro|CM_BLUE
define|#
directive|define
name|CM_BLUE
value|2
end_define

begin_define
DECL|macro|BitSet (byte,bit)
define|#
directive|define
name|BitSet
parameter_list|(
name|byte
parameter_list|,
name|bit
parameter_list|)
value|(((byte)& (bit)) == (bit))
end_define

begin_define
DECL|macro|ReadOK (file,buffer,len)
define|#
directive|define
name|ReadOK
parameter_list|(
name|file
parameter_list|,
name|buffer
parameter_list|,
name|len
parameter_list|)
value|(fread(buffer, len, 1, file) != 0)
end_define

begin_define
DECL|macro|GRAYSCALE
define|#
directive|define
name|GRAYSCALE
value|1
end_define

begin_define
DECL|macro|COLOR
define|#
directive|define
name|COLOR
value|2
end_define

begin_define
DECL|macro|RGB
define|#
directive|define
name|RGB
value|3
end_define

begin_typedef
DECL|typedef|CMap
typedef|typedef
name|unsigned
name|char
name|CMap
index|[
literal|3
index|]
index|[
name|MAXCOLORMAPSIZE
index|]
typedef|;
end_typedef

begin_struct
DECL|struct|__anon2a100ab30108
specifier|static
struct|struct
block|{
DECL|member|manufacturer
name|unsigned
name|char
name|manufacturer
decl_stmt|;
DECL|member|version
name|unsigned
name|char
name|version
decl_stmt|;
DECL|member|encoding
name|unsigned
name|char
name|encoding
decl_stmt|;
DECL|member|bitsperpixel
name|unsigned
name|char
name|bitsperpixel
decl_stmt|;
DECL|member|x1
DECL|member|y1
name|short
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|;
DECL|member|x2
DECL|member|y2
name|short
name|int
name|x2
decl_stmt|,
name|y2
decl_stmt|;
DECL|member|hdpi
name|short
name|int
name|hdpi
decl_stmt|;
DECL|member|vdpi
name|short
name|int
name|vdpi
decl_stmt|;
DECL|member|colormap
name|unsigned
name|char
name|colormap
index|[
literal|48
index|]
decl_stmt|;
DECL|member|reserved
name|unsigned
name|char
name|reserved
decl_stmt|;
DECL|member|nplanes
name|unsigned
name|char
name|nplanes
decl_stmt|;
DECL|member|bytesperline
name|short
name|int
name|bytesperline
decl_stmt|;
DECL|member|paletteinfo
name|short
name|int
name|paletteinfo
decl_stmt|;
DECL|member|hscreensize
name|short
name|int
name|hscreensize
decl_stmt|;
DECL|member|vscreensize
name|short
name|int
name|vscreensize
decl_stmt|;
DECL|member|filler
name|unsigned
name|char
name|filler
index|[
literal|54
index|]
decl_stmt|;
DECL|variable|pcx_header
block|}
name|pcx_header
struct|;
end_struct

begin_decl_stmt
DECL|variable|verbose
name|int
name|verbose
init|=
name|TRUE
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|gint32
name|ReadImage
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|gint32
DECL|function|load_image (char * filename)
name|load_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|FILE
modifier|*
name|fd
decl_stmt|;
name|char
modifier|*
name|name_buf
decl_stmt|;
name|int
name|imageCount
init|=
literal|0
decl_stmt|;
name|gint32
name|image_ID
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|img_height
decl_stmt|,
name|img_width
decl_stmt|;
name|short
name|int
name|bpp
decl_stmt|;
name|name_buf
operator|=
name|g_malloc
argument_list|(
name|strlen
argument_list|(
name|filename
argument_list|)
operator|+
literal|11
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|name_buf
argument_list|,
literal|"Loading %s:"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gimp_progress_init
argument_list|(
name|name_buf
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name_buf
argument_list|)
expr_stmt|;
name|fd
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fd
condition|)
block|{
name|printf
argument_list|(
literal|"PCX: can't open \"%s\"\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|ReadOK
argument_list|(
name|fd
argument_list|,
operator|&
name|pcx_header
argument_list|,
literal|128
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PCX: error reading file \"%s\"\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pcx_header
operator|.
name|manufacturer
operator|!=
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"PCX: error reading magic number\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bpp
operator|=
name|pcx_header
operator|.
name|bitsperpixel
operator|*
name|pcx_header
operator|.
name|nplanes
expr_stmt|;
operator|++
name|imageCount
expr_stmt|;
name|img_width
operator|=
name|pcx_header
operator|.
name|x2
operator|-
name|pcx_header
operator|.
name|x1
operator|+
literal|1
expr_stmt|;
name|img_height
operator|=
name|pcx_header
operator|.
name|y2
operator|-
name|pcx_header
operator|.
name|y1
operator|+
literal|1
expr_stmt|;
name|image_ID
operator|=
name|ReadImage
argument_list|(
name|fd
argument_list|,
name|filename
argument_list|,
name|img_width
argument_list|,
name|img_height
argument_list|,
name|MAXCOLORMAPSIZE
argument_list|,
name|COLOR
argument_list|,
name|imageCount
argument_list|)
expr_stmt|;
return|return
name|image_ID
return|;
block|}
end_function

begin_function_decl
name|int
name|load_monochrome
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|bytes_per_line
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|load_8bit
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|bytes_per_line
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|load_24bit
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|bytes_per_line
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|gint32
DECL|function|ReadImage (FILE * fd,char * filename,int len,int height,int ncols,int format,int number)
name|ReadImage
parameter_list|(
name|FILE
modifier|*
name|fd
parameter_list|,
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|ncols
parameter_list|,
name|int
name|format
parameter_list|,
name|int
name|number
parameter_list|)
block|{
specifier|static
name|gint32
name|image_ID
decl_stmt|;
name|gint32
name|layer_ID
decl_stmt|;
comment|/*  gint32 mask_ID; */
name|GPixelRgn
name|pixel_rgn
decl_stmt|;
name|GDrawable
modifier|*
name|drawable
decl_stmt|;
name|guchar
modifier|*
name|dest
decl_stmt|;
name|guchar
name|gimp_cmap
index|[
literal|768
index|]
decl_stmt|;
specifier|static
name|gint
name|frame_number
init|=
literal|1
decl_stmt|;
name|int
name|bpp
decl_stmt|;
name|gint
name|cur_progress
decl_stmt|,
name|max_progress
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|gchar
name|framename
index|[
literal|20
index|]
decl_stmt|;
name|gboolean
name|alpha_frame
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|frame_number
operator|==
literal|1
condition|)
block|{
name|image_ID
operator|=
name|gimp_image_new
argument_list|(
name|len
argument_list|,
name|height
argument_list|,
name|INDEXED
argument_list|)
expr_stmt|;
name|gimp_image_set_filename
argument_list|(
name|image_ID
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|layer_ID
operator|=
name|gimp_layer_new
argument_list|(
name|image_ID
argument_list|,
literal|"Background"
argument_list|,
name|len
argument_list|,
name|height
argument_list|,
name|INDEXED_IMAGE
argument_list|,
literal|100
argument_list|,
name|NORMAL_MODE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|framename
argument_list|,
literal|"Frame %d"
argument_list|,
name|frame_number
argument_list|)
expr_stmt|;
name|layer_ID
operator|=
name|gimp_layer_new
argument_list|(
name|image_ID
argument_list|,
name|framename
argument_list|,
name|len
argument_list|,
name|height
argument_list|,
name|INDEXEDA_IMAGE
argument_list|,
literal|100
argument_list|,
name|NORMAL_MODE
argument_list|)
expr_stmt|;
name|alpha_frame
operator|=
name|TRUE
expr_stmt|;
block|}
name|frame_number
operator|++
expr_stmt|;
name|bpp
operator|=
name|pcx_header
operator|.
name|bitsperpixel
operator|*
name|pcx_header
operator|.
name|nplanes
expr_stmt|;
name|gimp_image_add_layer
argument_list|(
name|image_ID
argument_list|,
name|layer_ID
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|layer_ID
argument_list|)
expr_stmt|;
name|cur_progress
operator|=
literal|0
expr_stmt|;
name|max_progress
operator|=
name|height
expr_stmt|;
if|if
condition|(
name|alpha_frame
condition|)
name|dest
operator|=
operator|(
name|guchar
operator|*
operator|)
name|g_malloc
argument_list|(
name|len
operator|*
name|height
operator|*
literal|2
argument_list|)
expr_stmt|;
else|else
name|dest
operator|=
operator|(
name|guchar
operator|*
operator|)
name|g_malloc
argument_list|(
name|len
operator|*
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"PCX: reading %d by %d PCX image, ncols=%d\n"
argument_list|,
name|len
argument_list|,
name|height
argument_list|,
name|ncols
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bpp
operator|==
literal|1
operator|)
operator|&&
operator|!
name|alpha_frame
condition|)
block|{
name|load_monochrome
argument_list|(
name|fd
argument_list|,
name|len
argument_list|,
name|height
argument_list|,
name|dest
argument_list|,
name|pcx_header
operator|.
name|bytesperline
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bpp
operator|==
literal|8
operator|)
operator|&&
operator|!
name|alpha_frame
condition|)
block|{
name|load_8bit
argument_list|(
name|fd
argument_list|,
name|len
argument_list|,
name|height
argument_list|,
name|dest
argument_list|,
name|pcx_header
operator|.
name|bytesperline
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|pcx_header
operator|.
name|bitsperpixel
operator|==
literal|8
operator|)
operator|&&
operator|(
name|pcx_header
operator|.
name|nplanes
operator|==
literal|1
operator|)
condition|)
block|{
name|fseek
argument_list|(
name|fd
argument_list|,
operator|-
literal|768L
argument_list|,
name|SEEK_END
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|ncols
condition|;
name|i
operator|++
control|)
block|{
name|gimp_cmap
index|[
name|j
operator|++
index|]
operator|=
name|fgetc
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|gimp_cmap
index|[
name|j
operator|++
index|]
operator|=
name|fgetc
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|gimp_cmap
index|[
name|j
operator|++
index|]
operator|=
name|fgetc
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|pcx_header
operator|.
name|bitsperpixel
operator|==
literal|1
condition|)
block|{
name|gimp_cmap
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|gimp_cmap
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|gimp_cmap
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|gimp_cmap
index|[
literal|3
index|]
operator|=
literal|255
expr_stmt|;
name|gimp_cmap
index|[
literal|4
index|]
operator|=
literal|255
expr_stmt|;
name|gimp_cmap
index|[
literal|5
index|]
operator|=
literal|255
expr_stmt|;
block|}
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_set_rect
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|dest
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|gimp_image_set_cmap
argument_list|(
name|image_ID
argument_list|,
name|gimp_cmap
argument_list|,
name|ncols
argument_list|)
expr_stmt|;
name|gimp_drawable_flush
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return
name|image_ID
return|;
block|}
end_function

begin_comment
comment|/*read_image*/
end_comment

begin_function
name|int
DECL|function|load_monochrome (FILE * fp,int len,int height,char * buffer,int bytes_per_line)
name|load_monochrome
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|bytes_per_line
parameter_list|)
block|{
name|guchar
modifier|*
name|temp
decl_stmt|;
name|gint
name|v
decl_stmt|;
name|gint
name|cur_x
init|=
literal|0
decl_stmt|,
name|cur_y
init|=
literal|0
decl_stmt|;
name|gint
name|times
decl_stmt|;
name|gint
name|cur_progress
init|=
literal|0
decl_stmt|,
name|max_progress
init|=
name|height
decl_stmt|;
name|int
name|cur_bit
decl_stmt|;
while|while
condition|(
operator|(
name|cur_y
operator|<
name|height
operator|)
operator|&&
operator|(
operator|!
name|feof
argument_list|(
name|fp
argument_list|)
operator|)
condition|)
block|{
name|v
operator|=
name|fgetc
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|>=
literal|192
condition|)
block|{
name|times
operator|=
name|v
operator|-
literal|192
expr_stmt|;
name|v
operator|=
name|fgetc
argument_list|(
name|fp
argument_list|)
expr_stmt|;
while|while
condition|(
name|times
operator|>
literal|0
condition|)
block|{
name|times
operator|--
expr_stmt|;
for|for
control|(
name|cur_bit
operator|=
literal|7
init|;
name|cur_bit
operator|>=
literal|0
condition|;
name|cur_bit
operator|--
control|)
block|{
name|temp
operator|=
name|buffer
operator|+
operator|(
name|cur_y
operator|*
name|len
operator|)
operator|+
name|cur_x
expr_stmt|;
if|if
condition|(
name|BitSet
argument_list|(
name|v
argument_list|,
literal|1
operator|<<
name|cur_bit
argument_list|)
condition|)
block|{
operator|*
name|temp
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
operator|*
name|temp
operator|=
literal|0
expr_stmt|;
block|}
operator|++
name|cur_x
expr_stmt|;
if|if
condition|(
name|cur_x
operator|==
name|len
condition|)
block|{
name|cur_x
operator|=
literal|0
expr_stmt|;
operator|++
name|cur_y
expr_stmt|;
name|cur_progress
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cur_progress
operator|%
literal|10
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|cur_progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
for|for
control|(
name|cur_bit
operator|=
literal|7
init|;
name|cur_bit
operator|>=
literal|0
condition|;
name|cur_bit
operator|--
control|)
block|{
name|temp
operator|=
name|buffer
operator|+
operator|(
name|cur_y
operator|*
name|len
operator|)
operator|+
name|cur_x
expr_stmt|;
if|if
condition|(
name|BitSet
argument_list|(
name|v
argument_list|,
literal|1
operator|<<
name|cur_bit
argument_list|)
condition|)
block|{
operator|*
name|temp
operator|=
literal|1
expr_stmt|;
block|}
else|else
operator|*
name|temp
operator|=
literal|0
expr_stmt|;
operator|++
name|cur_x
expr_stmt|;
if|if
condition|(
name|cur_x
operator|==
name|len
condition|)
block|{
name|cur_x
operator|=
literal|0
expr_stmt|;
operator|++
name|cur_y
expr_stmt|;
name|cur_progress
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cur_progress
operator|%
literal|10
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|cur_progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|cur_x
operator|==
name|len
condition|)
block|{
name|cur_x
operator|=
literal|0
expr_stmt|;
operator|++
name|cur_y
expr_stmt|;
name|cur_progress
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cur_progress
operator|%
literal|10
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|cur_progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cur_y
operator|==
name|height
condition|)
break|break;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_function
name|int
DECL|function|load_8bit (FILE * fp,int len,int height,char * buffer,int bytes_per_line)
name|load_8bit
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|bytes_per_line
parameter_list|)
block|{
name|guchar
modifier|*
name|temp
decl_stmt|;
name|gint
name|v
decl_stmt|;
name|gint
name|cur_progress
init|=
literal|0
decl_stmt|,
name|max_progress
init|=
name|height
decl_stmt|;
name|gint
name|times
decl_stmt|;
name|gint
name|cur_x
init|=
literal|0
decl_stmt|,
name|cur_y
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|cur_y
operator|<
name|height
condition|)
block|{
name|v
operator|=
name|fgetc
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|>=
literal|192
condition|)
block|{
name|times
operator|=
name|v
operator|-
literal|192
expr_stmt|;
name|v
operator|=
name|fgetc
argument_list|(
name|fp
argument_list|)
expr_stmt|;
while|while
condition|(
name|times
operator|>
literal|0
condition|)
block|{
name|times
operator|--
expr_stmt|;
name|temp
operator|=
name|buffer
operator|+
operator|(
name|cur_y
operator|*
name|len
operator|)
operator|+
name|cur_x
expr_stmt|;
operator|*
name|temp
operator|=
name|v
expr_stmt|;
operator|++
name|cur_x
expr_stmt|;
if|if
condition|(
name|cur_x
operator|==
name|len
condition|)
block|{
name|cur_x
operator|=
literal|0
expr_stmt|;
name|cur_y
operator|++
expr_stmt|;
name|cur_progress
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cur_progress
operator|%
literal|10
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|cur_progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|temp
operator|=
name|buffer
operator|+
operator|(
name|cur_y
operator|*
name|len
operator|)
operator|+
name|cur_x
expr_stmt|;
operator|*
name|temp
operator|=
name|v
expr_stmt|;
operator|++
name|cur_x
expr_stmt|;
if|if
condition|(
name|cur_x
operator|==
name|len
condition|)
block|{
name|cur_x
operator|=
literal|0
expr_stmt|;
name|cur_y
operator|++
expr_stmt|;
name|cur_progress
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cur_progress
operator|%
literal|10
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|cur_progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cur_x
operator|==
name|len
condition|)
block|{
name|cur_x
operator|=
literal|0
expr_stmt|;
name|cur_y
operator|++
expr_stmt|;
name|cur_progress
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cur_progress
operator|%
literal|10
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|cur_progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|OK
return|;
block|}
end_function

begin_function
name|int
DECL|function|load_24bit (FILE * fp,int len,int height,char * buffer,int bytes_per_line)
name|load_24bit
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|bytes_per_line
parameter_list|)
block|{
return|return
name|OK
return|;
block|}
end_function

begin_define
DECL|macro|MAXCOLORS
define|#
directive|define
name|MAXCOLORS
value|256
end_define

begin_function_decl
name|gint
name|colorstobpp
parameter_list|(
name|int
name|colors
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|gint
name|save_8bit
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|guchar
modifier|*
name|buffer
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|pixels
name|guchar
modifier|*
name|pixels
decl_stmt|;
end_decl_stmt

begin_function
name|gint
DECL|function|save_image (char * filename,gint32 image_ID,gint32 drawable_ID)
name|save_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|)
block|{
name|GPixelRgn
name|pixel_rgn
decl_stmt|;
name|GDrawable
modifier|*
name|drawable
decl_stmt|;
name|GDrawableType
name|drawable_type
decl_stmt|;
name|int
name|Red
index|[
name|MAXCOLORS
index|]
decl_stmt|;
name|int
name|Green
index|[
name|MAXCOLORS
index|]
decl_stmt|;
name|int
name|Blue
index|[
name|MAXCOLORS
index|]
decl_stmt|;
name|guchar
modifier|*
name|cmap
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|bpp
decl_stmt|;
name|int
name|colors
decl_stmt|;
name|guchar
modifier|*
name|temp
decl_stmt|;
name|FILE
modifier|*
name|outfile
decl_stmt|;
name|guchar
modifier|*
name|name_buf
decl_stmt|;
name|gint
name|cur_progress
init|=
literal|0
decl_stmt|,
name|max_progress
decl_stmt|;
name|int
name|i
decl_stmt|;
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|drawable_ID
argument_list|)
expr_stmt|;
name|drawable_type
operator|=
name|gimp_drawable_type
argument_list|(
name|drawable_ID
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|name_buf
operator|=
operator|(
name|guchar
operator|*
operator|)
name|g_malloc
argument_list|(
name|strlen
argument_list|(
name|filename
argument_list|)
operator|+
literal|11
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|name_buf
argument_list|,
literal|"Saving %s:"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gimp_progress_init
argument_list|(
name|name_buf
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name_buf
argument_list|)
expr_stmt|;
name|max_progress
operator|=
name|drawable
operator|->
name|height
expr_stmt|;
switch|switch
condition|(
name|drawable_type
condition|)
block|{
case|case
name|INDEXED_IMAGE
case|:
name|cmap
operator|=
name|gimp_image_get_cmap
argument_list|(
name|image_ID
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|colors
condition|;
name|i
operator|++
control|)
block|{
name|Red
index|[
name|i
index|]
operator|=
operator|*
name|cmap
operator|++
expr_stmt|;
name|Green
index|[
name|i
index|]
operator|=
operator|*
name|cmap
operator|++
expr_stmt|;
name|Blue
index|[
name|i
index|]
operator|=
operator|*
name|cmap
operator|++
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|Red
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|Green
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|Blue
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|bpp
operator|=
name|colorstobpp
argument_list|(
name|colors
argument_list|)
expr_stmt|;
break|break;
case|case
name|INDEXEDA_IMAGE
case|:
case|case
name|RGBA_IMAGE
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PCX: unable to save alpha images"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
break|break;
case|case
name|RGB_IMAGE
case|:
name|bpp
operator|=
literal|24
expr_stmt|;
break|break;
default|default :
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PCX: you should not receive this error for any reason\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|outfile
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"wb"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PCX: Can't open \"%s\"\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|pixels
operator|=
operator|(
name|guchar
operator|*
operator|)
name|g_malloc
argument_list|(
name|drawable
operator|->
name|width
operator|*
name|drawable
operator|->
name|height
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_get_rect
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|pixels
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|)
expr_stmt|;
name|width
operator|=
name|drawable
operator|->
name|width
expr_stmt|;
name|height
operator|=
name|drawable
operator|->
name|height
expr_stmt|;
name|pcx_header
operator|.
name|manufacturer
operator|=
literal|10
expr_stmt|;
name|pcx_header
operator|.
name|version
operator|=
literal|5
expr_stmt|;
name|pcx_header
operator|.
name|encoding
operator|=
literal|1
expr_stmt|;
name|pcx_header
operator|.
name|x1
operator|=
literal|0
expr_stmt|;
name|pcx_header
operator|.
name|y1
operator|=
literal|0
expr_stmt|;
name|pcx_header
operator|.
name|x2
operator|=
name|width
operator|-
literal|1
expr_stmt|;
name|pcx_header
operator|.
name|y2
operator|=
name|height
operator|-
literal|1
expr_stmt|;
name|pcx_header
operator|.
name|paletteinfo
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|bpp
operator|<=
literal|8
condition|)
block|{
name|pcx_header
operator|.
name|bitsperpixel
operator|=
literal|8
expr_stmt|;
name|pcx_header
operator|.
name|nplanes
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|pcx_header
operator|.
name|bitsperpixel
operator|=
literal|8
expr_stmt|;
name|pcx_header
operator|.
name|nplanes
operator|=
literal|3
expr_stmt|;
block|}
name|pcx_header
operator|.
name|hdpi
operator|=
literal|300
expr_stmt|;
name|pcx_header
operator|.
name|vdpi
operator|=
literal|300
expr_stmt|;
name|pcx_header
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bpp
operator|<=
literal|4
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|colors
condition|;
name|i
operator|++
control|)
block|{
name|pcx_header
operator|.
name|colormap
index|[
operator|(
name|i
operator|*
literal|3
operator|)
index|]
operator|=
name|Red
index|[
name|i
index|]
expr_stmt|;
name|pcx_header
operator|.
name|colormap
index|[
operator|(
name|i
operator|*
literal|3
operator|)
operator|+
literal|1
index|]
operator|=
name|Green
index|[
name|i
index|]
expr_stmt|;
name|pcx_header
operator|.
name|colormap
index|[
operator|(
name|i
operator|*
literal|3
operator|)
operator|+
literal|2
index|]
operator|=
name|Blue
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
name|fwrite
argument_list|(
operator|&
name|pcx_header
argument_list|,
literal|128
argument_list|,
literal|1
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpp
operator|==
literal|8
condition|)
block|{
name|save_8bit
argument_list|(
name|outfile
argument_list|,
name|pixels
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|0x0c
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|0x0c
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|255
condition|;
name|i
operator|++
control|)
block|{
name|fputc
argument_list|(
name|Red
index|[
name|i
index|]
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
name|Green
index|[
name|i
index|]
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
name|Blue
index|[
name|i
index|]
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
block|}
block|}
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|pixels
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|gint
DECL|function|save_8bit (FILE * out,guchar * buffer,int len,int height)
name|save_8bit
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|guchar
modifier|*
name|buffer
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|height
parameter_list|)
block|{
name|guchar
modifier|*
name|temp
decl_stmt|;
name|int
name|times
decl_stmt|;
name|gint
name|max
decl_stmt|;
name|unsigned
name|char
name|v
decl_stmt|;
name|gint
name|cur_x
init|=
literal|0
decl_stmt|,
name|cur_y
init|=
literal|0
decl_stmt|;
name|gint
name|cur_progress
init|=
literal|0
decl_stmt|,
name|max_progress
init|=
name|height
decl_stmt|;
name|printf
argument_list|(
literal|"saving %d * %d\n"
argument_list|,
name|len
argument_list|,
name|height
argument_list|)
expr_stmt|;
while|while
condition|(
name|cur_y
operator|<
name|height
condition|)
block|{
while|while
condition|(
name|cur_x
operator|<=
name|len
condition|)
block|{
name|temp
operator|=
operator|(
name|cur_y
operator|*
name|len
operator|)
operator|+
name|cur_x
operator|+
name|buffer
expr_stmt|;
name|v
operator|=
operator|*
name|temp
expr_stmt|;
name|times
operator|=
literal|1
expr_stmt|;
operator|++
name|cur_x
expr_stmt|;
name|temp
operator|=
operator|(
name|cur_y
operator|*
name|len
operator|)
operator|+
name|cur_x
operator|+
name|buffer
expr_stmt|;
if|if
condition|(
name|cur_x
operator|+
literal|63
operator|>
name|len
condition|)
block|{
name|max
operator|=
name|len
expr_stmt|;
block|}
else|else
name|max
operator|=
name|cur_x
operator|+
literal|63
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|temp
operator|==
name|v
operator|)
operator|&&
operator|(
name|cur_x
operator|<
name|max
operator|)
condition|)
block|{
name|times
operator|++
expr_stmt|;
name|temp
operator|=
operator|(
name|cur_y
operator|*
name|len
operator|)
operator|+
name|cur_x
operator|+
name|buffer
expr_stmt|;
name|cur_x
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|times
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|v
operator|>=
literal|0xC0
condition|)
block|{
name|fputc
argument_list|(
literal|0xC0
operator|+
literal|1
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
name|v
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
else|else
name|fputc
argument_list|(
name|v
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|max
operator|=
literal|0xC0
operator|+
name|times
expr_stmt|;
name|fputc
argument_list|(
name|max
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
name|v
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
block|}
name|cur_x
operator|=
literal|0
expr_stmt|;
name|cur_y
operator|++
expr_stmt|;
name|cur_progress
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cur_progress
operator|%
literal|10
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|cur_progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_function
name|gint
DECL|function|colorstobpp (int colors)
name|colorstobpp
parameter_list|(
name|int
name|colors
parameter_list|)
block|{
name|int
name|bpp
decl_stmt|;
if|if
condition|(
name|colors
operator|<=
literal|2
condition|)
name|bpp
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|colors
operator|<=
literal|4
condition|)
name|bpp
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|colors
operator|<=
literal|16
condition|)
name|bpp
operator|=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|colors
operator|<=
literal|256
condition|)
name|bpp
operator|=
literal|8
expr_stmt|;
else|else
name|bpp
operator|=
literal|24
expr_stmt|;
return|return
name|bpp
return|;
block|}
end_function

begin_comment
comment|/* The End */
end_comment

end_unit

