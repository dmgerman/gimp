begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * "$Id$"  *  *   Print plug-in CANON BJL driver for the GIMP.  *  *   Copyright 1997-2000 Michael Sweet (mike@easysw.com) and  *	Robert Krawitz (rlk@alum.mit.edu)  *  *   This program is free software; you can redistribute it and/or modify it  *   under the terms of the GNU General Public License as published by the Free  *   Software Foundation; either version 2 of the License, or (at your option)  *   any later version.  *  *   This program is distributed in the hope that it will be useful, but  *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY  *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License  *   for more details.  *  *   You should have received a copy of the GNU General Public License  *   along with this program; if not, write to the Free Software  *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  *  * Contents:  *  *   canon_parameters()     - Return the parameter values for the given  *                            parameter.  *   canon_imageable_area() - Return the imageable area of the page.  *   canon_print()          - Print an image to a CANON printer.  *   canon_write()          - Send 6-color graphics using compression.  *  * Revision History:  *  *   See ChangeLog  */
end_comment

begin_comment
comment|/* TODO-LIST  *  *   * implement the left border  *  */
end_comment

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|"print.h"
end_include

begin_comment
comment|/*  * Local functions...  */
end_comment

begin_typedef
DECL|struct|__anon29fc17b70108
typedef|typedef
struct|struct
block|{
DECL|member|model
name|int
name|model
decl_stmt|;
DECL|member|max_width
name|int
name|max_width
decl_stmt|;
comment|/* maximum printable paper size */
DECL|member|max_height
name|int
name|max_height
decl_stmt|;
DECL|member|max_xdpi
name|int
name|max_xdpi
decl_stmt|;
DECL|member|max_ydpi
name|int
name|max_ydpi
decl_stmt|;
DECL|member|max_quality
name|int
name|max_quality
decl_stmt|;
DECL|member|border_left
name|int
name|border_left
decl_stmt|;
DECL|member|border_right
name|int
name|border_right
decl_stmt|;
DECL|member|border_top
name|int
name|border_top
decl_stmt|;
DECL|member|border_bottom
name|int
name|border_bottom
decl_stmt|;
DECL|member|inks
name|int
name|inks
decl_stmt|;
comment|/* installable cartridges (CANON_INK_*) */
DECL|member|slots
name|int
name|slots
decl_stmt|;
comment|/* available paperslots */
DECL|member|features
name|int
name|features
decl_stmt|;
comment|/* special bjl settings */
DECL|typedef|canon_cap_t
block|}
name|canon_cap_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|canon_write_line
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|canon_cap_t
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_define
DECL|macro|PHYSICAL_BPI
define|#
directive|define
name|PHYSICAL_BPI
value|1440
end_define

begin_define
DECL|macro|MAX_OVERSAMPLED
define|#
directive|define
name|MAX_OVERSAMPLED
value|4
end_define

begin_define
DECL|macro|MAX_BPP
define|#
directive|define
name|MAX_BPP
value|2
end_define

begin_define
DECL|macro|BITS_PER_BYTE
define|#
directive|define
name|BITS_PER_BYTE
value|8
end_define

begin_define
DECL|macro|COMPBUFWIDTH
define|#
directive|define
name|COMPBUFWIDTH
value|(PHYSICAL_BPI * MAX_OVERSAMPLED * MAX_BPP * \ 	MAX_CARRIAGE_WIDTH / BITS_PER_BYTE)
end_define

begin_comment
comment|/* Codes for possible ink-tank combinations.  * Each combo is represented by the colors that can be used with  * the installed ink-tank(s)  * Combinations of the codes represent the combinations allowed for a model  */
end_comment

begin_define
DECL|macro|CANON_INK_K
define|#
directive|define
name|CANON_INK_K
value|1
end_define

begin_define
DECL|macro|CANON_INK_CMY
define|#
directive|define
name|CANON_INK_CMY
value|2
end_define

begin_define
DECL|macro|CANON_INK_CMYK
define|#
directive|define
name|CANON_INK_CMYK
value|4
end_define

begin_define
DECL|macro|CANON_INK_CcMmYK
define|#
directive|define
name|CANON_INK_CcMmYK
value|8
end_define

begin_define
DECL|macro|CANON_INK_CcMmYy
define|#
directive|define
name|CANON_INK_CcMmYy
value|16
end_define

begin_define
DECL|macro|CANON_INK_CcMmYyK
define|#
directive|define
name|CANON_INK_CcMmYyK
value|32
end_define

begin_define
DECL|macro|CANON_INK_BLACK_MASK
define|#
directive|define
name|CANON_INK_BLACK_MASK
value|(CANON_INK_K|CANON_INK_CMYK|\                               CANON_INK_CcMmYK|CANON_INK_CcMmYyK)
end_define

begin_define
DECL|macro|CANON_INK_PHOTO_MASK
define|#
directive|define
name|CANON_INK_PHOTO_MASK
value|(CANON_INK_CcMmYy|CANON_INK_CcMmYK|\                               CANON_INK_CcMmYyK)
end_define

begin_comment
comment|/* document feeding */
end_comment

begin_define
DECL|macro|CANON_SLOT_ASF1
define|#
directive|define
name|CANON_SLOT_ASF1
value|1
end_define

begin_define
DECL|macro|CANON_SLOT_ASF2
define|#
directive|define
name|CANON_SLOT_ASF2
value|2
end_define

begin_define
DECL|macro|CANON_SLOT_MAN1
define|#
directive|define
name|CANON_SLOT_MAN1
value|4
end_define

begin_define
DECL|macro|CANON_SLOT_MAN2
define|#
directive|define
name|CANON_SLOT_MAN2
value|8
end_define

begin_comment
comment|/* model peculiarities */
end_comment

begin_define
DECL|macro|CANON_CAP_DMT
define|#
directive|define
name|CANON_CAP_DMT
value|1<<0
end_define

begin_comment
DECL|macro|CANON_CAP_DMT
comment|/* Drop Modulation Technology */
end_comment

begin_define
DECL|macro|CANON_CAP_MSB_FIRST
define|#
directive|define
name|CANON_CAP_MSB_FIRST
value|1<<1
end_define

begin_comment
DECL|macro|CANON_CAP_MSB_FIRST
comment|/* how to send data           */
end_comment

begin_define
DECL|macro|CANON_CAP_CMD61
define|#
directive|define
name|CANON_CAP_CMD61
value|1<<2
end_define

begin_comment
DECL|macro|CANON_CAP_CMD61
comment|/* uses command #0x61         */
end_comment

begin_define
DECL|macro|CANON_CAP_CMD6d
define|#
directive|define
name|CANON_CAP_CMD6d
value|1<<3
end_define

begin_comment
DECL|macro|CANON_CAP_CMD6d
comment|/* uses command #0x6d         */
end_comment

begin_define
DECL|macro|CANON_CAP_CMD70
define|#
directive|define
name|CANON_CAP_CMD70
value|1<<4
end_define

begin_comment
DECL|macro|CANON_CAP_CMD70
comment|/* uses command #0x70         */
end_comment

begin_define
DECL|macro|CANON_CAP_CMD72
define|#
directive|define
name|CANON_CAP_CMD72
value|1<<5
end_define

begin_comment
DECL|macro|CANON_CAP_CMD72
comment|/* uses command #0x72         */
end_comment

begin_decl_stmt
DECL|variable|canon_model_capabilities
specifier|static
name|canon_cap_t
name|canon_model_capabilities
index|[]
init|=
block|{
comment|/* default settings for unkown models */
block|{
operator|-
literal|1
block|,
literal|8
operator|*
literal|72
block|,
literal|11
operator|*
literal|72
block|,
literal|180
block|,
literal|180
block|,
literal|20
block|,
literal|20
block|,
literal|20
block|,
literal|20
block|,
name|CANON_INK_K
block|,
name|CANON_SLOT_ASF1
block|,
literal|0
block|}
block|,
comment|/* tested models */
block|{
comment|/* Canon BJC 4300 */
literal|4300
block|,
literal|618
block|,
literal|936
block|,
comment|/* 8.58" x 13 " */
literal|1440
block|,
literal|720
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
operator||
name|CANON_SLOT_MAN1
block|,
name|CANON_CAP_DMT
block|}
block|,
block|{
comment|/* Canon BJC 4400 */
literal|4400
block|,
literal|9.5
operator|*
literal|72
block|,
literal|14
operator|*
literal|72
block|,
literal|720
block|,
literal|360
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_K
operator||
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_CMD61
operator||
name|CANON_CAP_DMT
block|}
block|,
block|{
comment|/* Canon BJC 6000 */
literal|6000
block|,
literal|618
block|,
literal|936
block|,
comment|/* 8.58" x 13 " */
literal|1440
block|,
literal|720
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
operator||
name|CANON_SLOT_MAN1
block|,
name|CANON_CAP_DMT
block|}
block|,
block|{
comment|/* Canon BJC 8200 */
literal|8200
block|,
literal|11
operator|*
literal|72
block|,
literal|17
operator|*
literal|72
block|,
literal|1200
block|,
literal|1200
block|,
literal|4
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_DMT
operator||
name|CANON_CAP_CMD72
block|}
block|,
comment|/* untested models */
block|{
comment|/* Canon BJC 1000 */
literal|1000
block|,
literal|11
operator|*
literal|72
block|,
literal|17
operator|*
literal|72
block|,
literal|360
block|,
literal|360
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_K
operator||
name|CANON_INK_CMY
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_CMD61
block|}
block|,
block|{
comment|/* Canon BJC 2000 */
literal|2000
block|,
literal|11
operator|*
literal|72
block|,
literal|17
operator|*
literal|72
block|,
literal|720
block|,
literal|360
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_CMD61
block|}
block|,
block|{
comment|/* Canon BJC 3000 */
literal|3000
block|,
literal|11
operator|*
literal|72
block|,
literal|17
operator|*
literal|72
block|,
literal|1440
block|,
literal|720
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_CMD61
operator||
name|CANON_CAP_DMT
block|}
block|,
block|{
comment|/* Canon BJC 6100 */
literal|6100
block|,
literal|11
operator|*
literal|72
block|,
literal|17
operator|*
literal|72
block|,
literal|1440
block|,
literal|720
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_CMD61
block|}
block|,
block|{
comment|/* Canon BJC 7000 */
literal|7000
block|,
literal|11
operator|*
literal|72
block|,
literal|17
operator|*
literal|72
block|,
literal|1200
block|,
literal|600
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
literal|0
block|}
block|,
block|{
comment|/* Canon BJC 7100 */
literal|7100
block|,
literal|11
operator|*
literal|72
block|,
literal|17
operator|*
literal|72
block|,
literal|1200
block|,
literal|600
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYyK
block|,
name|CANON_SLOT_ASF1
block|,
literal|0
block|}
block|,
comment|/* extremely fuzzy models */
block|{
comment|/* Canon BJC 5100 */
literal|5100
block|,
literal|17
operator|*
literal|72
block|,
literal|22
operator|*
literal|72
block|,
literal|1440
block|,
literal|720
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_DMT
block|}
block|,
block|{
comment|/* Canon BJC 5500 */
literal|5500
block|,
literal|22
operator|*
literal|72
block|,
literal|34
operator|*
literal|72
block|,
literal|720
block|,
literal|360
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_CMD61
block|}
block|,
block|{
comment|/* Canon BJC 6500 */
literal|6500
block|,
literal|17
operator|*
literal|72
block|,
literal|22
operator|*
literal|72
block|,
literal|1440
block|,
literal|720
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
name|CANON_CAP_CMD61
operator||
name|CANON_CAP_DMT
block|}
block|,
block|{
comment|/* Canon BJC 8500 */
literal|8500
block|,
literal|17
operator|*
literal|72
block|,
literal|22
operator|*
literal|72
block|,
literal|1200
block|,
literal|1200
block|,
literal|2
block|,
literal|11
block|,
literal|9
block|,
literal|10
block|,
literal|18
block|,
name|CANON_INK_CMYK
operator||
name|CANON_INK_CcMmYK
block|,
name|CANON_SLOT_ASF1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
DECL|function|canon_get_model_capabilities (int model)
specifier|static
name|canon_cap_t
name|canon_get_model_capabilities
parameter_list|(
name|int
name|model
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|models
init|=
sizeof|sizeof
argument_list|(
name|canon_model_capabilities
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|canon_cap_t
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|models
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|canon_model_capabilities
index|[
name|i
index|]
operator|.
name|model
operator|==
name|model
condition|)
block|{
return|return
name|canon_model_capabilities
index|[
name|i
index|]
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: model %d not found in capabilities list.\n"
argument_list|,
name|model
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|canon_model_capabilities
index|[
literal|0
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|canon_media_type (const char * name,canon_cap_t caps)
name|canon_media_type
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|canon_cap_t
name|caps
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Plain Paper"
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Transparencies"
argument_list|)
condition|)
return|return
literal|2
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Back Print Film"
argument_list|)
condition|)
return|return
literal|3
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Fabric Sheets"
argument_list|)
condition|)
return|return
literal|4
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Envelope"
argument_list|)
condition|)
return|return
literal|5
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"High Resolution Paper"
argument_list|)
condition|)
return|return
literal|6
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"T-Shirt Transfers"
argument_list|)
condition|)
return|return
literal|7
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"High Gloss Film"
argument_list|)
condition|)
return|return
literal|8
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Glossy Photo Paper"
argument_list|)
condition|)
return|return
literal|9
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Glossy Photo Cards"
argument_list|)
condition|)
return|return
literal|10
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Photo Paper Pro"
argument_list|)
condition|)
return|return
literal|11
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: Unknown media type '%s' - reverting to plain\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|canon_source_type (const char * name,canon_cap_t caps)
name|canon_source_type
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|canon_cap_t
name|caps
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Auto Sheet Feeder"
argument_list|)
condition|)
return|return
literal|4
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Manual with Pause"
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Manual without Pause"
argument_list|)
condition|)
return|return
literal|1
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: Unknown source type '%s' - reverting to auto\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|4
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|canon_printhead_type (const char * name,canon_cap_t caps)
name|canon_printhead_type
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|canon_cap_t
name|caps
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Black"
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Color"
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Black/Color"
argument_list|)
condition|)
return|return
literal|2
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Photo/Color"
argument_list|)
condition|)
return|return
literal|3
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Photo"
argument_list|)
condition|)
return|return
literal|4
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: Unknown head combo '%s' - reverting to black\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
DECL|function|canon_size_type (const vars_t * v,canon_cap_t caps)
name|canon_size_type
parameter_list|(
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|,
name|canon_cap_t
name|caps
parameter_list|)
block|{
specifier|const
name|papersize_t
modifier|*
name|pp
init|=
name|get_papersize_by_size
argument_list|(
name|v
operator|->
name|page_height
argument_list|,
name|v
operator|->
name|page_width
argument_list|)
decl_stmt|;
if|if
condition|(
name|pp
condition|)
block|{
specifier|const
name|char
modifier|*
name|name
init|=
name|pp
operator|->
name|name
decl_stmt|;
comment|/* built ins: */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"A5"
argument_list|)
condition|)
return|return
literal|0x01
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"A4"
argument_list|)
condition|)
return|return
literal|0x03
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"B5"
argument_list|)
condition|)
return|return
literal|0x08
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Letter"
argument_list|)
condition|)
return|return
literal|0x0d
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Legal"
argument_list|)
condition|)
return|return
literal|0x0f
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Envelope 10"
argument_list|)
condition|)
return|return
literal|0x16
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Envelope DL"
argument_list|)
condition|)
return|return
literal|0x17
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Letter+"
argument_list|)
condition|)
return|return
literal|0x2a
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"A4+"
argument_list|)
condition|)
return|return
literal|0x2b
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Canon 4x2"
argument_list|)
condition|)
return|return
literal|0x2d
return|;
block|}
comment|/* custom */
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: Unknown paper size '%s' - using custom\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|c_strdup (const char * s)
name|c_strdup
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|char
modifier|*
name|ret
init|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|strcpy
argument_list|(
name|ret
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
DECL|function|canon_default_resolution (const printer_t * printer)
name|canon_default_resolution
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|)
block|{
name|canon_cap_t
name|caps
init|=
name|canon_get_model_capabilities
argument_list|(
name|printer
operator|->
name|model
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|caps
operator|.
name|max_xdpi
operator|%
literal|300
operator|)
condition|)
return|return
literal|"300x300 DPI"
return|;
else|else
return|return
literal|"180x180 DPI"
return|;
block|}
end_function

begin_comment
comment|/*  * 'canon_parameters()' - Return the parameter values for the given parameter.  */
end_comment

begin_function
name|char
modifier|*
modifier|*
comment|/* O - Parameter values */
DECL|function|canon_parameters (const printer_t * printer,char * ppd_file,char * name,int * count)
name|canon_parameters
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Printer model */
name|char
modifier|*
name|ppd_file
parameter_list|,
comment|/* I - PPD file (not used) */
name|char
modifier|*
name|name
parameter_list|,
comment|/* I - Name of parameter */
name|int
modifier|*
name|count
parameter_list|)
comment|/* O - Number of values */
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
modifier|*
name|p
init|=
literal|0
decl_stmt|,
modifier|*
modifier|*
name|valptrs
init|=
literal|0
decl_stmt|;
specifier|static
name|char
modifier|*
name|media_types
index|[]
init|=
block|{
operator|(
literal|"Plain Paper"
operator|)
block|,
operator|(
literal|"Transparencies"
operator|)
block|,
operator|(
literal|"Back Print Film"
operator|)
block|,
operator|(
literal|"Fabric Sheets"
operator|)
block|,
operator|(
literal|"Envelope"
operator|)
block|,
operator|(
literal|"High Resolution Paper"
operator|)
block|,
operator|(
literal|"T-Shirt Transfers"
operator|)
block|,
operator|(
literal|"High Gloss Film"
operator|)
block|,
operator|(
literal|"Glossy Photo Paper"
operator|)
block|,
operator|(
literal|"Glossy Photo Cards"
operator|)
block|,
operator|(
literal|"Photo Paper Pro"
operator|)
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|media_sources
index|[]
init|=
block|{
operator|(
literal|"Auto Sheet Feeder"
operator|)
block|,
operator|(
literal|"Manual with Pause"
operator|)
block|,
operator|(
literal|"Manual without Pause"
operator|)
block|,                 }
decl_stmt|;
name|canon_cap_t
name|caps
init|=
name|canon_get_model_capabilities
argument_list|(
name|printer
operator|->
name|model
argument_list|)
decl_stmt|;
if|if
condition|(
name|count
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"PageSize"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|length_limit
decl_stmt|,
name|width_limit
decl_stmt|;
specifier|const
name|papersize_t
modifier|*
name|papersizes
init|=
name|get_papersizes
argument_list|()
decl_stmt|;
name|valptrs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|known_papersizes
argument_list|()
argument_list|)
expr_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|width_limit
operator|=
name|caps
operator|.
name|max_width
expr_stmt|;
name|length_limit
operator|=
name|caps
operator|.
name|max_height
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|known_papersizes
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|papersizes
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|>
literal|0
operator|&&
name|papersizes
index|[
name|i
index|]
operator|.
name|width
operator|<=
name|width_limit
operator|&&
name|papersizes
index|[
name|i
index|]
operator|.
name|length
operator|<=
name|length_limit
condition|)
block|{
name|valptrs
index|[
operator|*
name|count
index|]
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|papersizes
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|valptrs
index|[
operator|*
name|count
index|]
argument_list|,
name|papersizes
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|valptrs
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Resolution"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|x
init|=
name|caps
operator|.
name|max_xdpi
decl_stmt|,
name|y
init|=
name|caps
operator|.
name|max_ydpi
decl_stmt|;
name|int
name|c
init|=
literal|0
decl_stmt|;
name|valptrs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|caps
operator|.
name|max_xdpi
operator|%
literal|300
operator|)
condition|)
block|{
if|if
condition|(
literal|300
operator|<=
name|x
operator|&&
literal|300
operator|<=
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"300x300 DPI"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|300
operator|<=
name|x
operator|&&
literal|300
operator|<=
name|y
operator|&&
operator|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_DMT
operator|)
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"300x300 DPI DMT"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|600
operator|<=
name|x
operator|&&
literal|600
operator|<=
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"600x600 DPI"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|600
operator|<=
name|x
operator|&&
literal|600
operator|<=
name|y
operator|&&
operator|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_DMT
operator|)
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"600x600 DPI DMT"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1200
operator|==
name|x
operator|&&
literal|600
operator|==
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"1200x600 DPI"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1200
operator|<=
name|x
operator|&&
literal|1200
operator|<=
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"1200x1200 DPI"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|caps
operator|.
name|max_xdpi
operator|%
literal|180
operator|)
condition|)
block|{
if|if
condition|(
literal|180
operator|<=
name|x
operator|&&
literal|180
operator|<=
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"180x180 DPI"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|360
operator|<=
name|x
operator|&&
literal|360
operator|<=
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"360x360 DPI"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|360
operator|<=
name|x
operator|&&
literal|360
operator|<=
name|y
operator|&&
operator|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_DMT
operator|)
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"360x360 DPI DMT"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|720
operator|==
name|x
operator|&&
literal|360
operator|==
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"720x360 DPI"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|720
operator|<=
name|x
operator|&&
literal|720
operator|<=
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"720x720 DPI"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1440
operator|==
name|x
operator|&&
literal|720
operator|==
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"1440x720 DPI"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1440
operator|<=
name|x
operator|&&
literal|1440
operator|<=
name|y
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"1440x1440 DPI"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: unknown resolution multiplier for model %d\n"
argument_list|,
name|caps
operator|.
name|model
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
operator|*
name|count
operator|=
name|c
expr_stmt|;
name|p
operator|=
name|valptrs
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"InkType"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|c
init|=
literal|0
decl_stmt|;
name|valptrs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|.
name|inks
operator|&
name|CANON_INK_K
operator|)
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"Black"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|.
name|inks
operator|&
name|CANON_INK_CMY
operator|)
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"Color"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|.
name|inks
operator|&
name|CANON_INK_CMYK
operator|)
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"Black/Color"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|.
name|inks
operator|&
name|CANON_INK_CcMmYK
operator|)
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"Photo/Color"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|.
name|inks
operator|&
name|CANON_INK_CcMmYy
operator|)
condition|)
name|valptrs
index|[
name|c
operator|++
index|]
operator|=
name|c_strdup
argument_list|(
literal|"Photo/Color"
argument_list|)
expr_stmt|;
operator|*
name|count
operator|=
name|c
expr_stmt|;
name|p
operator|=
name|valptrs
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"MediaType"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|count
operator|=
literal|11
expr_stmt|;
name|p
operator|=
name|media_types
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"InputSlot"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|count
operator|=
literal|3
expr_stmt|;
name|p
operator|=
name|media_sources
expr_stmt|;
block|}
else|else
return|return
operator|(
name|NULL
operator|)
return|;
name|valptrs
operator|=
name|malloc
argument_list|(
operator|*
name|count
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|count
condition|;
name|i
operator|++
control|)
name|valptrs
index|[
name|i
index|]
operator|=
name|c_strdup
argument_list|(
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|valptrs
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * 'canon_imageable_area()' - Return the imageable area of the page.  */
end_comment

begin_function
name|void
DECL|function|canon_imageable_area (const printer_t * printer,const vars_t * v,int * left,int * right,int * bottom,int * top)
name|canon_imageable_area
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Printer model */
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|,
comment|/* I */
name|int
modifier|*
name|left
parameter_list|,
comment|/* O - Left position in points */
name|int
modifier|*
name|right
parameter_list|,
comment|/* O - Right position in points */
name|int
modifier|*
name|bottom
parameter_list|,
comment|/* O - Bottom position in points */
name|int
modifier|*
name|top
parameter_list|)
comment|/* O - Top position in points */
block|{
name|int
name|width
decl_stmt|,
name|length
decl_stmt|;
comment|/* Size of page */
name|canon_cap_t
name|caps
init|=
name|canon_get_model_capabilities
argument_list|(
name|printer
operator|->
name|model
argument_list|)
decl_stmt|;
name|default_media_size
argument_list|(
name|printer
argument_list|,
name|v
argument_list|,
operator|&
name|width
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
operator|*
name|left
operator|=
name|caps
operator|.
name|border_left
expr_stmt|;
operator|*
name|right
operator|=
name|width
operator|-
name|caps
operator|.
name|border_right
expr_stmt|;
operator|*
name|top
operator|=
name|length
operator|-
name|caps
operator|.
name|border_top
expr_stmt|;
operator|*
name|bottom
operator|=
name|caps
operator|.
name|border_bottom
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|canon_limit (const printer_t * printer,const vars_t * v,int * width,int * length)
name|canon_limit
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Printer model */
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|,
comment|/* I */
name|int
modifier|*
name|width
parameter_list|,
comment|/* O - Left position in points */
name|int
modifier|*
name|length
parameter_list|)
comment|/* O - Top position in points */
block|{
name|canon_cap_t
name|caps
init|=
name|canon_get_model_capabilities
argument_list|(
name|printer
operator|->
name|model
argument_list|)
decl_stmt|;
operator|*
name|width
operator|=
name|caps
operator|.
name|max_width
expr_stmt|;
operator|*
name|length
operator|=
name|caps
operator|.
name|max_height
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 'canon_cmd()' - Sends a command with variable args  */
end_comment

begin_function
specifier|static
name|void
DECL|function|canon_cmd (FILE * prn,char * ini,char cmd,int num,...)
name|canon_cmd
parameter_list|(
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - the printer         */
name|char
modifier|*
name|ini
parameter_list|,
comment|/* I - 2 bytes start code  */
name|char
name|cmd
parameter_list|,
comment|/* I - command code        */
name|int
name|num
parameter_list|,
comment|/* I - number of arguments */
modifier|...
comment|/* I - the args themselves */
parameter_list|)
block|{
specifier|static
name|int
name|bufsize
init|=
literal|0
decl_stmt|;
specifier|static
name|unsigned
name|char
modifier|*
name|buffer
decl_stmt|;
name|int
name|i
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
operator|!
name|buffer
operator|||
operator|(
name|num
operator|>
name|bufsize
operator|)
condition|)
block|{
if|if
condition|(
name|buffer
condition|)
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|malloc
argument_list|(
name|num
argument_list|)
expr_stmt|;
name|bufsize
operator|=
name|num
expr_stmt|;
if|if
condition|(
operator|!
name|buffer
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\ncanon: *** buffer allocation failed...\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: *** command 0x%02x with %d args dropped\n\n"
argument_list|,
name|cmd
argument_list|,
name|num
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
block|}
if|if
condition|(
name|num
condition|)
block|{
name|va_start
argument_list|(
name|ap
argument_list|,
name|num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
name|buffer
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
argument|ap
argument_list|,
argument|unsigned char
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
name|fwrite
argument_list|(
name|ini
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
condition|)
block|{
name|fputc
argument_list|(
name|cmd
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
operator|(
name|num
operator|&
literal|255
operator|)
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
operator|(
name|num
operator|>>
literal|8
operator|)
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|buffer
argument_list|,
name|num
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
DECL|macro|PUT (WHAT,VAL,RES)
define|#
directive|define
name|PUT
parameter_list|(
name|WHAT
parameter_list|,
name|VAL
parameter_list|,
name|RES
parameter_list|)
value|fprintf(stderr,"canon: "WHAT" is %04x =% 5d = %f\" = %f mm\n",(VAL),(VAL),(VAL)/(1.*RES),(VAL)/(RES/25.4))
end_define

begin_else
else|#
directive|else
end_else

begin_define
DECL|macro|PUT (WHAT,VAL,RES)
define|#
directive|define
name|PUT
parameter_list|(
name|WHAT
parameter_list|,
name|VAL
parameter_list|,
name|RES
parameter_list|)
value|do {} while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
DECL|function|canon_init_printer (FILE * prn,canon_cap_t caps,int output_type,char * media_str,const vars_t * v,int print_head,char * source_str,int xdpi,int ydpi,int page_width,int page_height,int top,int left,int use_dmt)
name|canon_init_printer
parameter_list|(
name|FILE
modifier|*
name|prn
parameter_list|,
name|canon_cap_t
name|caps
parameter_list|,
name|int
name|output_type
parameter_list|,
name|char
modifier|*
name|media_str
parameter_list|,
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|,
name|int
name|print_head
parameter_list|,
name|char
modifier|*
name|source_str
parameter_list|,
name|int
name|xdpi
parameter_list|,
name|int
name|ydpi
parameter_list|,
name|int
name|page_width
parameter_list|,
name|int
name|page_height
parameter_list|,
name|int
name|top
parameter_list|,
name|int
name|left
parameter_list|,
name|int
name|use_dmt
parameter_list|)
block|{
DECL|macro|MEDIACODES
define|#
directive|define
name|MEDIACODES
value|11
specifier|static
name|unsigned
name|char
name|mediacode_63
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0x03
block|,
literal|0x04
block|,
literal|0x08
block|,
literal|0x07
block|,
literal|0x03
block|,
literal|0x06
block|,
literal|0x05
block|,
literal|0x05
block|,
literal|0x09
block|}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|mediacode_6c
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0x03
block|,
literal|0x04
block|,
literal|0x08
block|,
literal|0x07
block|,
literal|0x03
block|,
literal|0x06
block|,
literal|0x05
block|,
literal|0x0a
block|,
literal|0x09
block|}
decl_stmt|;
DECL|macro|ESC28
define|#
directive|define
name|ESC28
value|"\x1b\x28"
DECL|macro|ESC5b
define|#
directive|define
name|ESC5b
value|"\x1b\x5b"
DECL|macro|ESC40
define|#
directive|define
name|ESC40
value|"\x1b\x40"
name|unsigned
name|char
name|arg_63_1
init|=
literal|0x00
decl_stmt|,
name|arg_63_2
init|=
literal|0x00
decl_stmt|,
comment|/* plain paper */
name|arg_63_3
init|=
name|caps
operator|.
name|max_quality
decl_stmt|,
comment|/* output quality  */
name|arg_6c_1
init|=
literal|0x00
decl_stmt|,
name|arg_6c_2
init|=
literal|0x01
decl_stmt|,
comment|/* plain paper */
name|arg_6d_1
init|=
literal|0x03
decl_stmt|,
comment|/* color printhead? */
name|arg_6d_2
init|=
literal|0x00
decl_stmt|,
comment|/* 00=color  02=b/w */
name|arg_6d_3
init|=
literal|0x00
decl_stmt|,
comment|/* only 01 for bjc8200 */
name|arg_6d_a
init|=
literal|0x03
decl_stmt|,
comment|/* A4 paper */
name|arg_6d_b
init|=
literal|0x00
decl_stmt|,
name|arg_70_1
init|=
literal|0x02
decl_stmt|,
comment|/* A4 printable area */
name|arg_70_2
init|=
literal|0xa6
decl_stmt|,
name|arg_70_3
init|=
literal|0x01
decl_stmt|,
name|arg_70_4
init|=
literal|0xe0
decl_stmt|,
name|arg_74_1
init|=
literal|0x01
decl_stmt|,
comment|/* 1 bit per pixel */
name|arg_74_2
init|=
literal|0x00
decl_stmt|,
comment|/*  */
name|arg_74_3
init|=
literal|0x01
decl_stmt|;
comment|/* 01<= 360 dpi    09>= 720 dpi */
name|int
name|media
init|=
name|canon_media_type
argument_list|(
name|media_str
argument_list|,
name|caps
argument_list|)
decl_stmt|;
name|int
name|source
init|=
name|canon_source_type
argument_list|(
name|source_str
argument_list|,
name|caps
argument_list|)
decl_stmt|;
name|int
name|printable_width
init|=
name|page_width
operator|*
literal|10
operator|/
literal|12
decl_stmt|;
name|int
name|printable_height
init|=
name|page_height
operator|*
literal|10
operator|/
literal|12
decl_stmt|;
name|arg_6d_a
operator|=
name|canon_size_type
argument_list|(
name|v
argument_list|,
name|caps
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg_6d_a
condition|)
name|arg_6d_b
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|model
operator|<
literal|3000
condition|)
name|arg_63_1
operator|=
name|arg_6c_1
operator|=
literal|0x10
expr_stmt|;
else|else
name|arg_63_1
operator|=
name|arg_6c_1
operator|=
literal|0x30
expr_stmt|;
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
name|arg_63_1
operator||=
literal|0x01
expr_stmt|;
name|arg_6c_1
operator||=
operator|(
name|source
operator|&
literal|0x0f
operator|)
expr_stmt|;
if|if
condition|(
name|print_head
operator|==
literal|0
condition|)
name|arg_6d_1
operator|=
literal|0x03
expr_stmt|;
elseif|else
if|if
condition|(
name|print_head
operator|<=
literal|2
condition|)
name|arg_6d_1
operator|=
literal|0x02
expr_stmt|;
elseif|else
if|if
condition|(
name|print_head
operator|<=
literal|4
condition|)
name|arg_6d_1
operator|=
literal|0x04
expr_stmt|;
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
name|arg_6d_2
operator|=
literal|0x02
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|model
operator|==
literal|8200
condition|)
name|arg_6d_3
operator|=
literal|0x01
expr_stmt|;
name|arg_70_1
operator|=
operator|(
name|printable_height
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|arg_70_2
operator|=
operator|(
name|printable_height
operator|)
operator|&
literal|0xff
expr_stmt|;
name|arg_70_3
operator|=
operator|(
name|printable_width
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|arg_70_4
operator|=
operator|(
name|printable_width
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|xdpi
operator|==
literal|1440
condition|)
name|arg_74_2
operator|=
literal|0x04
expr_stmt|;
if|if
condition|(
name|ydpi
operator|>=
literal|720
condition|)
name|arg_74_3
operator|=
literal|0x09
expr_stmt|;
if|if
condition|(
name|media
operator|<
name|MEDIACODES
condition|)
block|{
name|arg_63_2
operator|=
name|mediacode_63
index|[
name|media
index|]
expr_stmt|;
name|arg_6c_2
operator|=
name|mediacode_6c
index|[
name|media
index|]
expr_stmt|;
block|}
if|if
condition|(
name|use_dmt
condition|)
block|{
name|arg_74_1
operator|=
literal|0x02
expr_stmt|;
name|arg_74_2
operator|=
literal|0x80
expr_stmt|;
name|arg_74_3
operator|=
literal|0x09
expr_stmt|;
block|}
comment|/* workaround for the bjc8200 - not really understood */
if|if
condition|(
name|caps
operator|.
name|model
operator|==
literal|8200
operator|&&
name|use_dmt
condition|)
block|{
name|arg_74_1
operator|=
literal|0xff
expr_stmt|;
name|arg_74_2
operator|=
literal|0x90
expr_stmt|;
name|arg_74_3
operator|=
literal|0x04
expr_stmt|;
block|}
comment|/* #ifdef DEBUG   fprintf(stderr,"canon: printable size = %dx%d (%dx%d) %02x%02x %02x%02x\n", 	  page_width,page_height,printable_width,printable_height, 	  arg_70_1,arg_70_2,arg_70_3,arg_70_4); #endif   */
comment|/* init printer */
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC5b
argument_list|,
literal|0x4b
argument_list|,
literal|2
argument_list|,
literal|0x00
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_CMD61
condition|)
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC5b
argument_list|,
literal|0x61
argument_list|,
literal|1
argument_list|,
literal|0x00
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x62
argument_list|,
literal|1
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x71
argument_list|,
literal|1
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_CMD6d
condition|)
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x6d
argument_list|,
literal|12
argument_list|,
name|arg_6d_1
argument_list|,
literal|0xff
argument_list|,
literal|0xff
argument_list|,
literal|0x00
argument_list|,
literal|0x00
argument_list|,
literal|0x07
argument_list|,
literal|0x00
argument_list|,
name|arg_6d_a
argument_list|,
name|arg_6d_b
argument_list|,
name|arg_6d_2
argument_list|,
literal|0x00
argument_list|,
name|arg_6d_3
argument_list|)
expr_stmt|;
comment|/* set resolution */
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x64
argument_list|,
literal|4
argument_list|,
operator|(
name|ydpi
operator|>>
literal|8
operator|)
argument_list|,
operator|(
name|ydpi
operator|&
literal|255
operator|)
argument_list|,
operator|(
name|xdpi
operator|>>
literal|8
operator|)
argument_list|,
operator|(
name|xdpi
operator|&
literal|255
operator|)
argument_list|)
expr_stmt|;
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x74
argument_list|,
literal|3
argument_list|,
name|arg_74_1
argument_list|,
name|arg_74_2
argument_list|,
name|arg_74_3
argument_list|)
expr_stmt|;
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x63
argument_list|,
literal|3
argument_list|,
name|arg_63_1
argument_list|,
name|arg_63_2
argument_list|,
name|arg_63_3
argument_list|)
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_CMD70
condition|)
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x70
argument_list|,
literal|8
argument_list|,
name|arg_70_1
argument_list|,
name|arg_70_2
argument_list|,
literal|0x00
argument_list|,
literal|0x00
argument_list|,
name|arg_70_3
argument_list|,
name|arg_70_4
argument_list|,
literal|0x00
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x6c
argument_list|,
literal|2
argument_list|,
name|arg_6c_1
argument_list|,
name|arg_6c_2
argument_list|)
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_CMD72
condition|)
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x72
argument_list|,
literal|1
argument_list|,
literal|0x61
argument_list|)
expr_stmt|;
comment|/* whatever for - 8200 might need it */
comment|/* some linefeeds */
name|top
operator|=
operator|(
name|top
operator|*
name|ydpi
operator|)
operator|/
literal|72
expr_stmt|;
name|PUT
argument_list|(
literal|"topskip "
argument_list|,
name|top
argument_list|,
name|ydpi
argument_list|)
expr_stmt|;
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x65
argument_list|,
literal|2
argument_list|,
operator|(
name|top
operator|>>
literal|8
operator|)
argument_list|,
operator|(
name|top
operator|&
literal|255
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  'alloc_buffer()' allocates buffer and fills it with 0  */
end_comment

begin_function
DECL|function|canon_alloc_buffer (int size)
specifier|static
name|unsigned
name|char
modifier|*
name|canon_alloc_buffer
parameter_list|(
name|int
name|size
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|buf
init|=
name|malloc
argument_list|(
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
condition|)
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/*  * 'advance_buffer()' - Move (num) lines of length (len) down one line  *                      and sets first line to 0s  *                      accepts NULL pointers as buf  *                  !!! buf must contain more than (num) lines !!!  *                      also sets first line to 0s if num<1  */
end_comment

begin_function
specifier|static
name|void
DECL|function|canon_advance_buffer (unsigned char * buf,int len,int num)
name|canon_advance_buffer
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|num
parameter_list|)
block|{
if|if
condition|(
operator|!
name|buf
operator|||
operator|!
name|len
condition|)
return|return;
if|if
condition|(
name|num
operator|>
literal|0
condition|)
name|memmove
argument_list|(
name|buf
operator|+
name|len
argument_list|,
name|buf
argument_list|,
name|len
operator|*
name|num
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 'canon_print()' - Print an image to a CANON printer.  */
end_comment

begin_function
name|void
DECL|function|canon_print (const printer_t * printer,int copies,FILE * prn,Image image,const vars_t * v)
name|canon_print
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Model */
name|int
name|copies
parameter_list|,
comment|/* I - Number of copies */
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - File to print to */
name|Image
name|image
parameter_list|,
comment|/* I - Image to print */
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|cmap
init|=
name|v
operator|->
name|cmap
decl_stmt|;
name|int
name|model
init|=
name|printer
operator|->
name|model
decl_stmt|;
name|char
modifier|*
name|resolution
init|=
name|v
operator|->
name|resolution
decl_stmt|;
name|char
modifier|*
name|media_type
init|=
name|v
operator|->
name|media_type
decl_stmt|;
name|char
modifier|*
name|media_source
init|=
name|v
operator|->
name|media_source
decl_stmt|;
name|int
name|output_type
init|=
name|v
operator|->
name|output_type
decl_stmt|;
name|int
name|orientation
init|=
name|v
operator|->
name|orientation
decl_stmt|;
name|char
modifier|*
name|ink_type
init|=
name|v
operator|->
name|ink_type
decl_stmt|;
name|float
name|scaling
init|=
name|v
operator|->
name|scaling
decl_stmt|;
name|int
name|top
init|=
name|v
operator|->
name|top
decl_stmt|;
name|int
name|left
init|=
name|v
operator|->
name|left
decl_stmt|;
name|int
name|y
decl_stmt|;
comment|/* Looping vars */
name|int
name|xdpi
decl_stmt|,
name|ydpi
decl_stmt|;
comment|/* Resolution */
name|int
name|n
decl_stmt|;
comment|/* Output number */
name|unsigned
name|short
modifier|*
name|out
decl_stmt|;
comment|/* Output pixels (16-bit) */
name|unsigned
name|char
modifier|*
name|in
decl_stmt|,
comment|/* Input pixels */
modifier|*
name|black
decl_stmt|,
comment|/* Black bitmap data */
modifier|*
name|cyan
decl_stmt|,
comment|/* Cyan bitmap data */
modifier|*
name|magenta
decl_stmt|,
comment|/* Magenta bitmap data */
modifier|*
name|yellow
decl_stmt|,
comment|/* Yellow bitmap data */
modifier|*
name|lcyan
decl_stmt|,
comment|/* Light cyan bitmap data */
modifier|*
name|lmagenta
decl_stmt|,
comment|/* Light magenta bitmap data */
modifier|*
name|lyellow
decl_stmt|;
comment|/* Light yellow bitmap data */
name|int
name|delay_k
decl_stmt|,
name|delay_c
decl_stmt|,
name|delay_m
decl_stmt|,
name|delay_y
decl_stmt|,
name|delay_lc
decl_stmt|,
name|delay_lm
decl_stmt|,
name|delay_ly
decl_stmt|,
name|delay_max
decl_stmt|;
name|int
name|page_left
decl_stmt|,
comment|/* Left margin of page */
name|page_right
decl_stmt|,
comment|/* Right margin of page */
name|page_top
decl_stmt|,
comment|/* Top of page */
name|page_bottom
decl_stmt|,
comment|/* Bottom of page */
name|page_width
decl_stmt|,
comment|/* Width of page */
name|page_height
decl_stmt|,
comment|/* Height of page */
name|page_length
decl_stmt|,
comment|/* True length of page */
name|out_width
decl_stmt|,
comment|/* Width of image on page */
name|out_height
decl_stmt|,
comment|/* Height of image on page */
name|out_bpp
decl_stmt|,
comment|/* Output bytes per pixel */
name|length
decl_stmt|,
comment|/* Length of raster data */
name|buf_length
decl_stmt|,
comment|/* Length of raster data buffer (dmt) */
name|errdiv
decl_stmt|,
comment|/* Error dividend */
name|errmod
decl_stmt|,
comment|/* Error modulus */
name|errval
decl_stmt|,
comment|/* Current error value */
name|errline
decl_stmt|,
comment|/* Current raster line */
name|errlast
decl_stmt|;
comment|/* Last raster line loaded */
name|convert_t
name|colorfunc
init|=
literal|0
decl_stmt|;
comment|/* Color conversion function... */
name|int
name|image_height
decl_stmt|,
name|image_width
decl_stmt|,
name|image_bpp
decl_stmt|;
name|int
name|use_dmt
init|=
literal|0
decl_stmt|;
name|void
modifier|*
name|dither
decl_stmt|;
name|double
name|the_levels
index|[]
init|=
block|{
literal|0.5
block|,
literal|0.75
block|,
literal|1.0
block|}
decl_stmt|;
name|vars_t
name|nv
decl_stmt|;
name|canon_cap_t
name|caps
init|=
name|canon_get_model_capabilities
argument_list|(
name|model
argument_list|)
decl_stmt|;
name|int
name|printhead
init|=
name|canon_printhead_type
argument_list|(
name|ink_type
argument_list|,
name|caps
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|nv
argument_list|,
name|v
argument_list|,
sizeof|sizeof
argument_list|(
name|vars_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*   PUT("top        ",top,72);   PUT("left       ",left,72);   */
comment|/*   * Setup a read-only pixel region for the entire image...   */
name|Image_init
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_height
operator|=
name|Image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_width
operator|=
name|Image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_bpp
operator|=
name|Image_bpp
argument_list|(
name|image
argument_list|)
expr_stmt|;
comment|/* force grayscale if image is grayscale    *                 or single black cartridge installed    */
if|if
condition|(
name|nv
operator|.
name|image_type
operator|==
name|IMAGE_MONOCHROME
condition|)
block|{
name|output_type
operator|=
name|OUTPUT_GRAY
expr_stmt|;
block|}
if|if
condition|(
name|printhead
operator|==
literal|0
operator|||
name|caps
operator|.
name|inks
operator|==
name|CANON_INK_K
condition|)
name|output_type
operator|=
name|OUTPUT_GRAY
expr_stmt|;
elseif|else
if|if
condition|(
name|image_bpp
operator|<
literal|3
operator|&&
name|cmap
operator|==
name|NULL
operator|&&
name|output_type
operator|==
name|OUTPUT_COLOR
condition|)
name|output_type
operator|=
name|OUTPUT_GRAY_COLOR
expr_stmt|;
comment|/*    * Choose the correct color conversion function...    */
name|colorfunc
operator|=
name|choose_colorfunc
argument_list|(
name|output_type
argument_list|,
name|image_bpp
argument_list|,
name|cmap
argument_list|,
operator|&
name|out_bpp
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
comment|/*   * Figure out the output resolution...   */
name|sscanf
argument_list|(
name|resolution
argument_list|,
literal|"%dx%d"
argument_list|,
operator|&
name|xdpi
argument_list|,
operator|&
name|ydpi
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: resolution=%dx%d\n"
argument_list|,
name|xdpi
argument_list|,
name|ydpi
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|resolution
operator|+
operator|(
name|strlen
argument_list|(
name|resolution
argument_list|)
operator|-
literal|3
operator|)
argument_list|,
literal|"DMT"
argument_list|)
operator|&&
operator|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_DMT
operator|)
operator|&&
name|nv
operator|.
name|image_type
operator|!=
name|IMAGE_MONOCHROME
condition|)
block|{
name|use_dmt
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: using drop modulation technology\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/*   * Compute the output size...   */
name|canon_imageable_area
argument_list|(
name|printer
argument_list|,
operator|&
name|nv
argument_list|,
operator|&
name|page_left
argument_list|,
operator|&
name|page_right
argument_list|,
operator|&
name|page_bottom
argument_list|,
operator|&
name|page_top
argument_list|)
expr_stmt|;
name|compute_page_parameters
argument_list|(
name|page_right
argument_list|,
name|page_left
argument_list|,
name|page_top
argument_list|,
name|page_bottom
argument_list|,
name|scaling
argument_list|,
name|image_width
argument_list|,
name|image_height
argument_list|,
name|image
argument_list|,
operator|&
name|orientation
argument_list|,
operator|&
name|page_width
argument_list|,
operator|&
name|page_height
argument_list|,
operator|&
name|out_width
argument_list|,
operator|&
name|out_height
argument_list|,
operator|&
name|left
argument_list|,
operator|&
name|top
argument_list|)
expr_stmt|;
comment|/*    * Recompute the image height and width.  If the image has been    * rotated, these will change from previously.    */
name|image_height
operator|=
name|Image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_width
operator|=
name|Image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|default_media_size
argument_list|(
name|printer
argument_list|,
operator|&
name|nv
argument_list|,
operator|&
name|n
argument_list|,
operator|&
name|page_length
argument_list|)
expr_stmt|;
comment|/*   PUT("top        ",top,72);   PUT("left       ",left,72);   PUT("page_top   ",page_top,72);   PUT("page_bottom",page_bottom,72);   PUT("page_left  ",page_left,72);   PUT("page_right ",page_right,72);   PUT("page_width ",page_width,72);   PUT("page_height",page_height,72);   PUT("page_length",page_length,72);   PUT("out_width ", out_width,xdpi);   PUT("out_height", out_height,ydpi);   */
name|Image_progress_init
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|PUT
argument_list|(
literal|"top     "
argument_list|,
name|top
argument_list|,
literal|72
argument_list|)
expr_stmt|;
name|PUT
argument_list|(
literal|"left    "
argument_list|,
name|left
argument_list|,
literal|72
argument_list|)
expr_stmt|;
name|canon_init_printer
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|output_type
argument_list|,
name|media_type
argument_list|,
operator|&
name|nv
argument_list|,
name|printhead
argument_list|,
name|media_source
argument_list|,
name|xdpi
argument_list|,
name|ydpi
argument_list|,
name|page_width
argument_list|,
name|page_height
argument_list|,
name|top
argument_list|,
name|left
argument_list|,
name|use_dmt
argument_list|)
expr_stmt|;
comment|/*   * Convert image size to printer resolution...   */
name|out_width
operator|=
name|xdpi
operator|*
name|out_width
operator|/
literal|72
expr_stmt|;
name|out_height
operator|=
name|ydpi
operator|*
name|out_height
operator|/
literal|72
expr_stmt|;
comment|/*   PUT("out_width ", out_width,xdpi);   PUT("out_height", out_height,ydpi);   */
name|left
operator|=
name|ydpi
operator|*
name|left
operator|/
literal|72
expr_stmt|;
name|PUT
argument_list|(
literal|"leftskip"
argument_list|,
name|left
argument_list|,
name|xdpi
argument_list|)
expr_stmt|;
if|if
condition|(
name|xdpi
operator|==
literal|1440
condition|)
block|{
name|delay_k
operator|=
literal|0
expr_stmt|;
name|delay_c
operator|=
literal|112
expr_stmt|;
name|delay_m
operator|=
literal|224
expr_stmt|;
name|delay_y
operator|=
literal|336
expr_stmt|;
name|delay_lc
operator|=
literal|112
expr_stmt|;
name|delay_lm
operator|=
literal|224
expr_stmt|;
name|delay_ly
operator|=
literal|0
expr_stmt|;
name|delay_max
operator|=
literal|336
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: delay on!\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|delay_k
operator|=
name|delay_c
operator|=
name|delay_m
operator|=
name|delay_y
operator|=
name|delay_lc
operator|=
name|delay_lm
operator|=
name|delay_ly
operator|=
literal|0
expr_stmt|;
name|delay_max
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: delay off!\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/*   * Allocate memory for the raster data...   */
name|length
operator|=
operator|(
name|out_width
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|use_dmt
condition|)
block|{
name|buf_length
operator|=
name|length
operator|*
literal|2
expr_stmt|;
block|}
else|else
block|{
name|buf_length
operator|=
name|length
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: buflength is %d!\n"
argument_list|,
name|buf_length
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
block|{
name|black
operator|=
name|canon_alloc_buffer
argument_list|(
name|buf_length
operator|*
operator|(
name|delay_k
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|cyan
operator|=
name|NULL
expr_stmt|;
name|magenta
operator|=
name|NULL
expr_stmt|;
name|lcyan
operator|=
name|NULL
expr_stmt|;
name|lmagenta
operator|=
name|NULL
expr_stmt|;
name|yellow
operator|=
name|NULL
expr_stmt|;
name|lyellow
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|cyan
operator|=
name|canon_alloc_buffer
argument_list|(
name|buf_length
operator|*
operator|(
name|delay_c
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|magenta
operator|=
name|canon_alloc_buffer
argument_list|(
name|buf_length
operator|*
operator|(
name|delay_m
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|yellow
operator|=
name|canon_alloc_buffer
argument_list|(
name|buf_length
operator|*
operator|(
name|delay_y
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|.
name|inks
operator|&
name|CANON_INK_BLACK_MASK
operator|)
condition|)
name|black
operator|=
name|canon_alloc_buffer
argument_list|(
name|buf_length
operator|*
operator|(
name|delay_k
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
else|else
name|black
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|printhead
operator|==
literal|3
operator|&&
operator|(
name|caps
operator|.
name|inks
operator|&
operator|(
name|CANON_INK_PHOTO_MASK
operator|)
operator|)
condition|)
block|{
name|lcyan
operator|=
name|canon_alloc_buffer
argument_list|(
name|buf_length
operator|*
operator|(
name|delay_lc
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|lmagenta
operator|=
name|canon_alloc_buffer
argument_list|(
name|buf_length
operator|*
operator|(
name|delay_lm
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|.
name|inks
operator|&
name|CANON_INK_CcMmYy
operator|)
condition|)
name|lyellow
operator|=
name|canon_alloc_buffer
argument_list|(
name|buf_length
operator|*
operator|(
name|delay_lc
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
else|else
name|lyellow
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|lcyan
operator|=
name|NULL
expr_stmt|;
name|lmagenta
operator|=
name|NULL
expr_stmt|;
name|lyellow
operator|=
name|NULL
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"canon: driver will use colors "
argument_list|)
expr_stmt|;
if|if
condition|(
name|cyan
condition|)
name|fputc
argument_list|(
literal|'C'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcyan
condition|)
name|fputc
argument_list|(
literal|'c'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|magenta
condition|)
name|fputc
argument_list|(
literal|'M'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|lmagenta
condition|)
name|fputc
argument_list|(
literal|'m'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|yellow
condition|)
name|fputc
argument_list|(
literal|'Y'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|lyellow
condition|)
name|fputc
argument_list|(
literal|'y'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|black
condition|)
name|fputc
argument_list|(
literal|'K'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|nv
operator|.
name|density
operator|*=
name|ydpi
operator|/
name|xdpi
expr_stmt|;
if|if
condition|(
name|nv
operator|.
name|density
operator|>
literal|1.0
condition|)
name|nv
operator|.
name|density
operator|=
literal|1.0
expr_stmt|;
name|compute_lut
argument_list|(
literal|256
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
if|if
condition|(
name|xdpi
operator|>
name|ydpi
condition|)
name|dither
operator|=
name|init_dither
argument_list|(
name|image_width
argument_list|,
name|out_width
argument_list|,
literal|1
argument_list|,
name|xdpi
operator|/
name|ydpi
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
else|else
name|dither
operator|=
name|init_dither
argument_list|(
name|image_width
argument_list|,
name|out_width
argument_list|,
name|ydpi
operator|/
name|xdpi
argument_list|,
literal|1
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
name|dither_set_black_levels
argument_list|(
name|dither
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|dither_set_black_lower
argument_list|(
name|dither
argument_list|,
literal|.8
operator|/
operator|(
operator|(
literal|1
operator|<<
operator|(
name|use_dmt
operator|+
literal|1
operator|)
operator|)
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/*   if (use_glossy_film)   */
name|dither_set_black_upper
argument_list|(
name|dither
argument_list|,
literal|.999
argument_list|)
expr_stmt|;
comment|/*   else     dither_set_black_upper(dither, .999);   */
if|if
condition|(
operator|!
name|use_dmt
condition|)
block|{
name|dither_set_light_inks
argument_list|(
name|dither
argument_list|,
operator|(
name|lcyan
operator|)
condition|?
operator|(
literal|0.3333
operator|)
else|:
operator|(
literal|0.0
operator|)
argument_list|,
operator|(
name|lmagenta
operator|)
condition|?
operator|(
literal|0.3333
operator|)
else|:
operator|(
literal|0.0
operator|)
argument_list|,
operator|(
name|lyellow
operator|)
condition|?
operator|(
literal|0.3333
operator|)
else|:
operator|(
literal|0.0
operator|)
argument_list|,
name|nv
operator|.
name|density
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|nv
operator|.
name|image_type
condition|)
block|{
case|case
name|IMAGE_LINE_ART
case|:
name|dither_set_ink_spread
argument_list|(
name|dither
argument_list|,
literal|19
argument_list|)
expr_stmt|;
break|break;
case|case
name|IMAGE_SOLID_TONE
case|:
name|dither_set_ink_spread
argument_list|(
name|dither
argument_list|,
literal|15
argument_list|)
expr_stmt|;
break|break;
case|case
name|IMAGE_CONTINUOUS
case|:
name|dither_set_ink_spread
argument_list|(
name|dither
argument_list|,
literal|14
argument_list|)
expr_stmt|;
break|break;
block|}
name|dither_set_density
argument_list|(
name|dither
argument_list|,
name|nv
operator|.
name|density
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_dmt
condition|)
block|{
name|dither_set_c_ranges_simple
argument_list|(
name|dither
argument_list|,
literal|3
argument_list|,
name|the_levels
argument_list|,
name|nv
operator|.
name|density
argument_list|)
expr_stmt|;
name|dither_set_m_ranges_simple
argument_list|(
name|dither
argument_list|,
literal|3
argument_list|,
name|the_levels
argument_list|,
name|nv
operator|.
name|density
argument_list|)
expr_stmt|;
name|dither_set_y_ranges_simple
argument_list|(
name|dither
argument_list|,
literal|3
argument_list|,
name|the_levels
argument_list|,
name|nv
operator|.
name|density
argument_list|)
expr_stmt|;
name|dither_set_k_ranges_simple
argument_list|(
name|dither
argument_list|,
literal|3
argument_list|,
name|the_levels
argument_list|,
name|nv
operator|.
name|density
argument_list|)
expr_stmt|;
block|}
comment|/*   * Output the page...   */
name|in
operator|=
name|malloc
argument_list|(
name|image_width
operator|*
name|image_bpp
argument_list|)
expr_stmt|;
name|out
operator|=
name|malloc
argument_list|(
name|image_width
operator|*
name|out_bpp
operator|*
literal|2
argument_list|)
expr_stmt|;
name|errdiv
operator|=
name|image_height
operator|/
name|out_height
expr_stmt|;
name|errmod
operator|=
name|image_height
operator|%
name|out_height
expr_stmt|;
name|errval
operator|=
literal|0
expr_stmt|;
name|errlast
operator|=
operator|-
literal|1
expr_stmt|;
name|errline
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|out_height
condition|;
name|y
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|y
operator|&
literal|255
operator|)
operator|==
literal|0
condition|)
name|Image_note_progress
argument_list|(
name|image
argument_list|,
name|y
argument_list|,
name|out_height
argument_list|)
expr_stmt|;
if|if
condition|(
name|errline
operator|!=
name|errlast
condition|)
block|{
name|errlast
operator|=
name|errline
expr_stmt|;
name|Image_get_row
argument_list|(
name|image
argument_list|,
name|in
argument_list|,
name|errline
argument_list|)
expr_stmt|;
block|}
call|(
modifier|*
name|colorfunc
call|)
argument_list|(
name|in
argument_list|,
name|out
argument_list|,
name|image_width
argument_list|,
name|image_bpp
argument_list|,
name|cmap
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
block|{
if|if
condition|(
name|nv
operator|.
name|image_type
operator|==
name|IMAGE_MONOCHROME
condition|)
name|dither_fastblack
argument_list|(
name|out
argument_list|,
name|y
argument_list|,
name|dither
argument_list|,
name|black
argument_list|)
expr_stmt|;
else|else
name|dither_black
argument_list|(
name|out
argument_list|,
name|y
argument_list|,
name|dither
argument_list|,
name|black
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dither_cmyk
argument_list|(
name|out
argument_list|,
name|y
argument_list|,
name|dither
argument_list|,
name|cyan
argument_list|,
name|lcyan
argument_list|,
name|magenta
argument_list|,
name|lmagenta
argument_list|,
name|yellow
argument_list|,
name|lyellow
argument_list|,
name|black
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
comment|/* fprintf(stderr,","); */
endif|#
directive|endif
name|canon_write_line
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|ydpi
argument_list|,
name|black
argument_list|,
name|delay_k
argument_list|,
name|cyan
argument_list|,
name|delay_c
argument_list|,
name|magenta
argument_list|,
name|delay_m
argument_list|,
name|yellow
argument_list|,
name|delay_y
argument_list|,
name|lcyan
argument_list|,
name|delay_lc
argument_list|,
name|lmagenta
argument_list|,
name|delay_lm
argument_list|,
name|lyellow
argument_list|,
name|delay_ly
argument_list|,
name|length
argument_list|,
name|out_width
argument_list|,
name|left
argument_list|,
name|use_dmt
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
comment|/* fprintf(stderr,"!"); */
endif|#
directive|endif
name|canon_advance_buffer
argument_list|(
name|black
argument_list|,
name|buf_length
argument_list|,
name|delay_k
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|cyan
argument_list|,
name|buf_length
argument_list|,
name|delay_c
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|magenta
argument_list|,
name|buf_length
argument_list|,
name|delay_m
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|yellow
argument_list|,
name|buf_length
argument_list|,
name|delay_y
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|lcyan
argument_list|,
name|buf_length
argument_list|,
name|delay_lc
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|lmagenta
argument_list|,
name|buf_length
argument_list|,
name|delay_lm
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|lyellow
argument_list|,
name|buf_length
argument_list|,
name|delay_ly
argument_list|)
expr_stmt|;
name|errval
operator|+=
name|errmod
expr_stmt|;
name|errline
operator|+=
name|errdiv
expr_stmt|;
if|if
condition|(
name|errval
operator|>=
name|out_height
condition|)
block|{
name|errval
operator|-=
name|out_height
expr_stmt|;
name|errline
operator|++
expr_stmt|;
block|}
block|}
name|Image_progress_conclude
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|free_dither
argument_list|(
name|dither
argument_list|)
expr_stmt|;
comment|/*    * Flush delayed buffers...    */
if|if
condition|(
name|delay_max
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\ncanon: flushing %d possibly delayed buffers\n"
argument_list|,
name|delay_max
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|delay_max
condition|;
name|y
operator|++
control|)
block|{
name|canon_write_line
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|ydpi
argument_list|,
name|black
argument_list|,
name|delay_k
argument_list|,
name|cyan
argument_list|,
name|delay_c
argument_list|,
name|magenta
argument_list|,
name|delay_m
argument_list|,
name|yellow
argument_list|,
name|delay_y
argument_list|,
name|lcyan
argument_list|,
name|delay_lc
argument_list|,
name|lmagenta
argument_list|,
name|delay_lm
argument_list|,
name|lyellow
argument_list|,
name|delay_ly
argument_list|,
name|length
argument_list|,
name|out_width
argument_list|,
name|left
argument_list|,
name|use_dmt
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
comment|/* fprintf(stderr,"-"); */
endif|#
directive|endif
name|canon_advance_buffer
argument_list|(
name|black
argument_list|,
name|buf_length
argument_list|,
name|delay_k
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|cyan
argument_list|,
name|buf_length
argument_list|,
name|delay_c
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|magenta
argument_list|,
name|buf_length
argument_list|,
name|delay_m
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|yellow
argument_list|,
name|buf_length
argument_list|,
name|delay_y
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|lcyan
argument_list|,
name|buf_length
argument_list|,
name|delay_lc
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|lmagenta
argument_list|,
name|buf_length
argument_list|,
name|delay_lm
argument_list|)
expr_stmt|;
name|canon_advance_buffer
argument_list|(
name|lyellow
argument_list|,
name|buf_length
argument_list|,
name|delay_ly
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*   * Cleanup...   */
name|free_lut
argument_list|(
operator|&
name|nv
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|black
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|black
argument_list|)
expr_stmt|;
if|if
condition|(
name|cyan
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|cyan
argument_list|)
expr_stmt|;
if|if
condition|(
name|magenta
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|magenta
argument_list|)
expr_stmt|;
if|if
condition|(
name|yellow
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|yellow
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcyan
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|lcyan
argument_list|)
expr_stmt|;
if|if
condition|(
name|lmagenta
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|lmagenta
argument_list|)
expr_stmt|;
if|if
condition|(
name|lyellow
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|lyellow
argument_list|)
expr_stmt|;
comment|/* eject page */
name|fputc
argument_list|(
literal|0x0c
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* say goodbye */
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC28
argument_list|,
literal|0x62
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_CMD61
condition|)
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC5b
argument_list|,
literal|0x61
argument_list|,
literal|1
argument_list|,
literal|0x00
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|canon_cmd
argument_list|(
name|prn
argument_list|,
name|ESC40
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|prn
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 'canon_fold_lsb_msb()' fold 2 lines in order lsb/msb  */
end_comment

begin_function
specifier|static
name|void
DECL|function|canon_fold_lsb_msb (const unsigned char * line,int single_length,unsigned char * outbuf)
name|canon_fold_lsb_msb
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|line
parameter_list|,
name|int
name|single_length
parameter_list|,
name|unsigned
name|char
modifier|*
name|outbuf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|single_length
condition|;
name|i
operator|++
control|)
block|{
name|outbuf
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
operator|>>
literal|1
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
operator|)
operator|>>
literal|3
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|4
operator|)
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
operator|>>
literal|0
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
operator|>>
literal|1
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
operator|)
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|4
operator|)
operator|)
operator|>>
literal|3
operator|)
expr_stmt|;
name|outbuf
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|3
operator|)
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|<<
literal|0
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|3
operator|)
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|<<
literal|1
operator|)
expr_stmt|;
name|line
operator|++
expr_stmt|;
name|outbuf
operator|+=
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * 'canon_fold_msb_lsb()' fold 2 lines in order msb/lsb  */
end_comment

begin_function
specifier|static
name|void
DECL|function|canon_fold_msb_lsb (const unsigned char * line,int single_length,unsigned char * outbuf)
name|canon_fold_msb_lsb
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|line
parameter_list|,
name|int
name|single_length
parameter_list|,
name|unsigned
name|char
modifier|*
name|outbuf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|single_length
condition|;
name|i
operator|++
control|)
block|{
name|outbuf
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
operator|>>
literal|0
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
operator|>>
literal|1
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
operator|)
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|4
operator|)
operator|)
operator|>>
literal|3
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
operator|>>
literal|1
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
operator|)
operator|>>
literal|3
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|4
operator|)
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|outbuf
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|3
operator|)
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|line
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|3
operator|)
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
operator|(
name|line
index|[
name|single_length
index|]
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|<<
literal|0
operator|)
expr_stmt|;
name|line
operator|++
expr_stmt|;
name|outbuf
operator|+=
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|canon_pack (unsigned char * line,int length,unsigned char * comp_buf,unsigned char ** comp_ptr)
name|canon_pack
parameter_list|(
name|unsigned
name|char
modifier|*
name|line
parameter_list|,
name|int
name|length
parameter_list|,
name|unsigned
name|char
modifier|*
name|comp_buf
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|comp_ptr
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|start
decl_stmt|;
comment|/* Start of compressed data */
name|unsigned
name|char
name|repeat
decl_stmt|;
comment|/* Repeating char */
name|int
name|count
decl_stmt|;
comment|/* Count of compressed bytes */
name|int
name|tcount
decl_stmt|;
comment|/* Temporary count< 128 */
comment|/*    * Compress using TIFF "packbits" run-length encoding...    */
operator|(
operator|*
name|comp_ptr
operator|)
operator|=
name|comp_buf
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
condition|)
block|{
comment|/*        * Get a run of non-repeated chars...        */
name|start
operator|=
name|line
expr_stmt|;
name|line
operator|+=
literal|2
expr_stmt|;
name|length
operator|-=
literal|2
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
operator|&&
operator|(
name|line
index|[
operator|-
literal|2
index|]
operator|!=
name|line
index|[
operator|-
literal|1
index|]
operator|||
name|line
index|[
operator|-
literal|1
index|]
operator|!=
name|line
index|[
literal|0
index|]
operator|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
name|length
operator|--
expr_stmt|;
block|}
name|line
operator|-=
literal|2
expr_stmt|;
name|length
operator|+=
literal|2
expr_stmt|;
comment|/*        * Output the non-repeated sequences (max 128 at a time).        */
name|count
operator|=
name|line
operator|-
name|start
expr_stmt|;
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|tcount
operator|=
name|count
operator|>
literal|128
condition|?
literal|128
else|:
name|count
expr_stmt|;
operator|(
operator|*
name|comp_ptr
operator|)
index|[
literal|0
index|]
operator|=
name|tcount
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|comp_ptr
operator|)
operator|+
literal|1
argument_list|,
name|start
argument_list|,
name|tcount
argument_list|)
expr_stmt|;
operator|(
operator|*
name|comp_ptr
operator|)
operator|+=
name|tcount
operator|+
literal|1
expr_stmt|;
name|start
operator|+=
name|tcount
expr_stmt|;
name|count
operator|-=
name|tcount
expr_stmt|;
block|}
if|if
condition|(
name|length
operator|<=
literal|0
condition|)
break|break;
comment|/*        * Find the repeated sequences...        */
name|start
operator|=
name|line
expr_stmt|;
name|repeat
operator|=
name|line
index|[
literal|0
index|]
expr_stmt|;
name|line
operator|++
expr_stmt|;
name|length
operator|--
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
operator|&&
operator|*
name|line
operator|==
name|repeat
condition|)
block|{
name|line
operator|++
expr_stmt|;
name|length
operator|--
expr_stmt|;
block|}
comment|/*        * Output the repeated sequences (max 128 at a time).        */
name|count
operator|=
name|line
operator|-
name|start
expr_stmt|;
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|tcount
operator|=
name|count
operator|>
literal|128
condition|?
literal|128
else|:
name|count
expr_stmt|;
operator|(
operator|*
name|comp_ptr
operator|)
index|[
literal|0
index|]
operator|=
literal|1
operator|-
name|tcount
expr_stmt|;
operator|(
operator|*
name|comp_ptr
operator|)
index|[
literal|1
index|]
operator|=
name|repeat
expr_stmt|;
operator|(
operator|*
name|comp_ptr
operator|)
operator|+=
literal|2
expr_stmt|;
name|count
operator|-=
name|tcount
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * 'canon_write()' - Send graphics using TIFF packbits compression.  */
end_comment

begin_function
specifier|static
name|int
DECL|function|canon_write (FILE * prn,canon_cap_t caps,unsigned char * line,int length,int coloridx,int ydpi,int * empty,int width,int offset,int dmt)
name|canon_write
parameter_list|(
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - Print file or command */
name|canon_cap_t
name|caps
parameter_list|,
comment|/* I - Printer model */
name|unsigned
name|char
modifier|*
name|line
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|length
parameter_list|,
comment|/* I - Length of bitmap data */
name|int
name|coloridx
parameter_list|,
comment|/* I - Which color */
name|int
name|ydpi
parameter_list|,
comment|/* I - Vertical resolution */
name|int
modifier|*
name|empty
parameter_list|,
comment|/* IO- Preceeding empty lines */
name|int
name|width
parameter_list|,
comment|/* I - Printed width */
name|int
name|offset
parameter_list|,
comment|/* I - Offset from left side */
name|int
name|dmt
parameter_list|)
block|{
name|unsigned
name|char
name|comp_buf
index|[
name|COMPBUFWIDTH
index|]
decl_stmt|,
comment|/* Compression buffer */
name|in_fold
index|[
name|COMPBUFWIDTH
index|]
decl_stmt|,
modifier|*
name|in_ptr
init|=
name|line
decl_stmt|,
modifier|*
name|comp_ptr
decl_stmt|,
modifier|*
name|comp_data
decl_stmt|;
name|int
name|newlength
decl_stmt|;
name|unsigned
name|char
name|color
decl_stmt|;
comment|/* Don't send blank lines... */
if|if
condition|(
name|line
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|memcmp
argument_list|(
name|line
argument_list|,
name|line
operator|+
literal|1
argument_list|,
name|length
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* fold lsb/msb pairs if drop modulation is active */
if|if
condition|(
name|dmt
condition|)
block|{
if|if
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|caps
operator|.
name|features
operator|&
name|CANON_CAP_MSB_FIRST
condition|)
name|canon_fold_msb_lsb
argument_list|(
name|line
argument_list|,
name|length
argument_list|,
name|in_fold
argument_list|)
expr_stmt|;
else|else
name|canon_fold_lsb_msb
argument_list|(
name|line
argument_list|,
name|length
argument_list|,
name|in_fold
argument_list|)
expr_stmt|;
name|in_ptr
operator|=
name|in_fold
expr_stmt|;
block|}
name|length
operator|*=
literal|2
expr_stmt|;
name|offset
operator|*=
literal|2
expr_stmt|;
block|}
comment|/* pack left border rounded to multiples of 8 dots */
name|comp_data
operator|=
name|comp_buf
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|int
name|offset2
init|=
operator|(
name|offset
operator|+
literal|4
operator|)
operator|/
literal|8
decl_stmt|;
while|while
condition|(
name|offset2
operator|>
literal|0
condition|)
block|{
name|unsigned
name|char
name|toffset
init|=
name|offset2
operator|>
literal|128
condition|?
literal|128
else|:
name|offset2
decl_stmt|;
name|comp_data
index|[
literal|0
index|]
operator|=
literal|1
operator|-
name|toffset
expr_stmt|;
name|comp_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|comp_data
operator|+=
literal|2
expr_stmt|;
name|offset2
operator|-=
name|toffset
expr_stmt|;
block|}
block|}
name|canon_pack
argument_list|(
name|in_ptr
argument_list|,
name|length
argument_list|,
name|comp_data
argument_list|,
operator|&
name|comp_ptr
argument_list|)
expr_stmt|;
name|newlength
operator|=
name|comp_ptr
operator|-
name|comp_buf
expr_stmt|;
comment|/* send packed empty lines if any */
if|if
condition|(
operator|*
name|empty
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
comment|/* fprintf(stderr,"<%d%c>",*empty,("CMYKcmy"[coloridx])); */
endif|#
directive|endif
name|fwrite
argument_list|(
literal|"\x1b\x28\x65\x02\x00"
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
operator|(
operator|*
name|empty
operator|)
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
operator|(
operator|*
name|empty
operator|)
operator|&
literal|255
argument_list|,
name|prn
argument_list|)
expr_stmt|;
operator|*
name|empty
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Send a line of raster graphics... */
name|fwrite
argument_list|(
literal|"\x1b\x28\x41"
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
operator|(
name|newlength
operator|+
literal|1
operator|)
operator|&
literal|255
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
operator|(
name|newlength
operator|+
literal|1
operator|)
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|color
operator|=
literal|"CMYKcmy"
index|[
name|coloridx
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|color
condition|)
name|color
operator|=
literal|'K'
expr_stmt|;
name|putc
argument_list|(
name|color
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|comp_buf
argument_list|,
name|newlength
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\x0d'
argument_list|,
name|prn
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|canon_write_line (FILE * prn,canon_cap_t caps,int ydpi,unsigned char * k,int dk,unsigned char * c,int dc,unsigned char * m,int dm,unsigned char * y,int dy,unsigned char * lc,int dlc,unsigned char * lm,int dlm,unsigned char * ly,int dly,int l,int width,int offset,int dmt)
name|canon_write_line
parameter_list|(
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - Print file or command */
name|canon_cap_t
name|caps
parameter_list|,
comment|/* I - Printer model */
name|int
name|ydpi
parameter_list|,
comment|/* I - Vertical resolution */
name|unsigned
name|char
modifier|*
name|k
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|dk
parameter_list|,
comment|/* I -  */
name|unsigned
name|char
modifier|*
name|c
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|dc
parameter_list|,
comment|/* I -  */
name|unsigned
name|char
modifier|*
name|m
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|dm
parameter_list|,
comment|/* I -  */
name|unsigned
name|char
modifier|*
name|y
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|dy
parameter_list|,
comment|/* I -  */
name|unsigned
name|char
modifier|*
name|lc
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|dlc
parameter_list|,
comment|/* I -  */
name|unsigned
name|char
modifier|*
name|lm
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|dlm
parameter_list|,
comment|/* I -  */
name|unsigned
name|char
modifier|*
name|ly
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|dly
parameter_list|,
comment|/* I -  */
name|int
name|l
parameter_list|,
comment|/* I - Length of bitmap data */
name|int
name|width
parameter_list|,
comment|/* I - Printed width */
name|int
name|offset
parameter_list|,
comment|/* I - horizontal offset */
name|int
name|dmt
parameter_list|)
block|{
specifier|static
name|int
name|empty
init|=
literal|0
decl_stmt|;
name|int
name|written
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|k
condition|)
name|written
operator|+=
name|canon_write
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|k
operator|+
name|dk
operator|*
name|l
argument_list|,
name|l
argument_list|,
literal|3
argument_list|,
name|ydpi
argument_list|,
operator|&
name|empty
argument_list|,
name|width
argument_list|,
name|offset
argument_list|,
name|dmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|y
condition|)
name|written
operator|+=
name|canon_write
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|y
operator|+
name|dy
operator|*
name|l
argument_list|,
name|l
argument_list|,
literal|2
argument_list|,
name|ydpi
argument_list|,
operator|&
name|empty
argument_list|,
name|width
argument_list|,
name|offset
argument_list|,
name|dmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
name|written
operator|+=
name|canon_write
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|m
operator|+
name|dm
operator|*
name|l
argument_list|,
name|l
argument_list|,
literal|1
argument_list|,
name|ydpi
argument_list|,
operator|&
name|empty
argument_list|,
name|width
argument_list|,
name|offset
argument_list|,
name|dmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
condition|)
name|written
operator|+=
name|canon_write
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|c
operator|+
name|dc
operator|*
name|l
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
name|ydpi
argument_list|,
operator|&
name|empty
argument_list|,
name|width
argument_list|,
name|offset
argument_list|,
name|dmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ly
condition|)
name|written
operator|+=
name|canon_write
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|ly
operator|+
name|dly
operator|*
name|l
argument_list|,
name|l
argument_list|,
literal|6
argument_list|,
name|ydpi
argument_list|,
operator|&
name|empty
argument_list|,
name|width
argument_list|,
name|offset
argument_list|,
name|dmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|lm
condition|)
name|written
operator|+=
name|canon_write
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|lm
operator|+
name|dlm
operator|*
name|l
argument_list|,
name|l
argument_list|,
literal|5
argument_list|,
name|ydpi
argument_list|,
operator|&
name|empty
argument_list|,
name|width
argument_list|,
name|offset
argument_list|,
name|dmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|lc
condition|)
name|written
operator|+=
name|canon_write
argument_list|(
name|prn
argument_list|,
name|caps
argument_list|,
name|lc
operator|+
name|dlc
operator|*
name|l
argument_list|,
name|l
argument_list|,
literal|4
argument_list|,
name|ydpi
argument_list|,
operator|&
name|empty
argument_list|,
name|width
argument_list|,
name|offset
argument_list|,
name|dmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|written
condition|)
name|fwrite
argument_list|(
literal|"\x1b\x28\x65\x02\x00\x00\x01"
argument_list|,
literal|7
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
else|else
name|empty
operator|++
expr_stmt|;
block|}
end_function

end_unit

