begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * "$Id$"  *  *   Print plug-in Adobe PostScript driver for the GIMP.  *  *   Copyright 1997-2000 Michael Sweet (mike@easysw.com) and  *	Robert Krawitz (rlk@alum.mit.edu)  *  *   This program is free software; you can redistribute it and/or modify it  *   under the terms of the GNU General Public License as published by the Free  *   Software Foundation; either version 2 of the License, or (at your option)  *   any later version.  *  *   This program is distributed in the hope that it will be useful, but  *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY  *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License  *   for more details.  *  *   You should have received a copy of the GNU General Public License  *   along with this program; if not, write to the Free Software  *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  *  * Contents:  *  *   ps_parameters()     - Return the parameter values for the given  *                            parameter.  *   ps_media_size()     - Return the size of the page.  *   ps_imageable_area() - Return the imageable area of the page.  *   ps_print()          - Print an image to a PostScript printer.  *   ps_hex()            - Print binary data as a series of hexadecimal numbers.  *   ps_ascii85()        - Print binary data as a series of base-85 numbers.  *  * Revision History:  *  *   See ChangeLog  */
end_comment

begin_include
include|#
directive|include
file|"print.h"
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_comment
comment|/*#define DEBUG*/
end_comment

begin_comment
comment|/*  * Local variables...  */
end_comment

begin_decl_stmt
DECL|variable|ps_ppd
specifier|static
name|FILE
modifier|*
name|ps_ppd
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ps_ppd_file
specifier|static
name|char
modifier|*
name|ps_ppd_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Local functions...  */
end_comment

begin_function_decl
specifier|static
name|void
name|ps_hex
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|unsigned
name|short
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ps_ascii85
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|unsigned
name|short
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ppd_find
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * 'ps_parameters()' - Return the parameter values for the given parameter.  */
end_comment

begin_function
name|char
modifier|*
modifier|*
comment|/* O - Parameter values */
DECL|function|ps_parameters (const printer_t * printer,char * ppd_file,char * name,int * count)
name|ps_parameters
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Printer model */
name|char
modifier|*
name|ppd_file
parameter_list|,
comment|/* I - PPD file (not used) */
name|char
modifier|*
name|name
parameter_list|,
comment|/* I - Name of parameter */
name|int
modifier|*
name|count
parameter_list|)
comment|/* O - Number of values */
block|{
name|int
name|i
decl_stmt|;
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|,
name|lname
index|[
literal|255
index|]
decl_stmt|,
name|loption
index|[
literal|255
index|]
decl_stmt|;
name|char
modifier|*
modifier|*
name|valptrs
decl_stmt|;
if|if
condition|(
name|count
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ppd_file
operator|==
name|NULL
operator|||
name|name
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|ps_ppd_file
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|ps_ppd_file
argument_list|,
name|ppd_file
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ps_ppd
operator|!=
name|NULL
condition|)
name|fclose
argument_list|(
name|ps_ppd
argument_list|)
expr_stmt|;
name|ps_ppd
operator|=
name|fopen
argument_list|(
name|ppd_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps_ppd
operator|==
name|NULL
condition|)
name|ps_ppd_file
operator|=
name|NULL
expr_stmt|;
else|else
name|ps_ppd_file
operator|=
name|ppd_file
expr_stmt|;
block|}
if|if
condition|(
name|ps_ppd
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"PageSize"
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|papersize_t
modifier|*
name|papersizes
init|=
name|get_papersizes
argument_list|()
decl_stmt|;
name|valptrs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|known_papersizes
argument_list|()
argument_list|)
expr_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|known_papersizes
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|papersizes
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|>
literal|0
condition|)
block|{
name|valptrs
index|[
operator|*
name|count
index|]
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|papersizes
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|valptrs
index|[
operator|*
name|count
index|]
argument_list|,
name|papersizes
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|valptrs
operator|)
return|;
block|}
else|else
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|rewind
argument_list|(
name|ps_ppd
argument_list|)
expr_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|valptrs
operator|=
name|malloc
argument_list|(
literal|100
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|ps_ppd
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|line
index|[
literal|0
index|]
operator|!=
literal|'*'
condition|)
continue|continue;
if|if
condition|(
name|sscanf
argument_list|(
name|line
argument_list|,
literal|"*%s %[^/:]"
argument_list|,
name|lname
argument_list|,
name|loption
argument_list|)
operator|!=
literal|2
condition|)
continue|continue;
if|if
condition|(
name|strcasecmp
argument_list|(
name|lname
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|valptrs
index|[
operator|(
operator|*
name|count
operator|)
index|]
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|loption
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|valptrs
index|[
operator|(
operator|*
name|count
operator|)
index|]
argument_list|,
name|loption
argument_list|)
expr_stmt|;
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|count
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|valptrs
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
else|else
return|return
operator|(
name|valptrs
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * 'ps_media_size()' - Return the size of the page.  */
end_comment

begin_function
name|void
DECL|function|ps_media_size (const printer_t * printer,const vars_t * v,int * width,int * length)
name|ps_media_size
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Printer model */
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|,
comment|/* I */
name|int
modifier|*
name|width
parameter_list|,
comment|/* O - Width in points */
name|int
modifier|*
name|length
parameter_list|)
comment|/* O - Length in points */
block|{
name|char
modifier|*
name|dimensions
decl_stmt|;
comment|/* Dimensions of media size */
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"ps_media_size(%d, \'%s\', \'%s\', %08x, %08x)\n"
argument_list|,
name|model
argument_list|,
name|ppd_file
argument_list|,
name|media_size
argument_list|,
name|width
argument_list|,
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
if|if
condition|(
operator|(
name|dimensions
operator|=
name|ppd_find
argument_list|(
name|v
operator|->
name|ppd_file
argument_list|,
literal|"PaperDimension"
argument_list|,
name|v
operator|->
name|media_size
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|sscanf
argument_list|(
name|dimensions
argument_list|,
literal|"%d%d"
argument_list|,
name|width
argument_list|,
name|length
argument_list|)
expr_stmt|;
else|else
name|default_media_size
argument_list|(
name|printer
argument_list|,
name|v
argument_list|,
name|width
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 'ps_imageable_area()' - Return the imageable area of the page.  */
end_comment

begin_function
name|void
DECL|function|ps_imageable_area (const printer_t * printer,const vars_t * v,int * left,int * right,int * bottom,int * top)
name|ps_imageable_area
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Printer model */
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|,
comment|/* I */
name|int
modifier|*
name|left
parameter_list|,
comment|/* O - Left position in points */
name|int
modifier|*
name|right
parameter_list|,
comment|/* O - Right position in points */
name|int
modifier|*
name|bottom
parameter_list|,
comment|/* O - Bottom position in points */
name|int
modifier|*
name|top
parameter_list|)
comment|/* O - Top position in points */
block|{
name|char
modifier|*
name|area
decl_stmt|;
comment|/* Imageable area of media */
name|float
name|fleft
decl_stmt|,
comment|/* Floating point versions */
name|fright
decl_stmt|,
name|fbottom
decl_stmt|,
name|ftop
decl_stmt|;
if|if
condition|(
operator|(
name|area
operator|=
name|ppd_find
argument_list|(
name|v
operator|->
name|ppd_file
argument_list|,
literal|"ImageableArea"
argument_list|,
name|v
operator|->
name|media_size
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"area = \'%s\'\n"
argument_list|,
name|area
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
if|if
condition|(
name|sscanf
argument_list|(
name|area
argument_list|,
literal|"%f%f%f%f"
argument_list|,
operator|&
name|fleft
argument_list|,
operator|&
name|fbottom
argument_list|,
operator|&
name|fright
argument_list|,
operator|&
name|ftop
argument_list|)
operator|==
literal|4
condition|)
block|{
operator|*
name|left
operator|=
operator|(
name|int
operator|)
name|fleft
expr_stmt|;
operator|*
name|right
operator|=
operator|(
name|int
operator|)
name|fright
expr_stmt|;
operator|*
name|bottom
operator|=
operator|(
name|int
operator|)
name|fbottom
expr_stmt|;
operator|*
name|top
operator|=
operator|(
name|int
operator|)
name|ftop
expr_stmt|;
block|}
else|else
operator|*
name|left
operator|=
operator|*
name|right
operator|=
operator|*
name|bottom
operator|=
operator|*
name|top
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|default_media_size
argument_list|(
name|printer
argument_list|,
name|v
argument_list|,
name|right
argument_list|,
name|top
argument_list|)
expr_stmt|;
operator|*
name|left
operator|=
literal|18
expr_stmt|;
operator|*
name|right
operator|-=
literal|18
expr_stmt|;
operator|*
name|top
operator|-=
literal|36
expr_stmt|;
operator|*
name|bottom
operator|=
literal|36
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|ps_limit (const printer_t * printer,const vars_t * v,int * width,int * length)
name|ps_limit
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Printer model */
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|,
comment|/* I */
name|int
modifier|*
name|width
parameter_list|,
comment|/* O - Left position in points */
name|int
modifier|*
name|length
parameter_list|)
comment|/* O - Top position in points */
block|{
operator|*
name|width
operator|=
name|INT_MAX
expr_stmt|;
operator|*
name|length
operator|=
name|INT_MAX
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
DECL|function|ps_default_resolution (const printer_t * printer)
name|ps_default_resolution
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|)
block|{
return|return
literal|"default"
return|;
block|}
end_function

begin_comment
comment|/*  * 'ps_print()' - Print an image to a PostScript printer.  */
end_comment

begin_function
name|void
DECL|function|ps_print (const printer_t * printer,int copies,FILE * prn,Image image,const vars_t * v)
name|ps_print
parameter_list|(
specifier|const
name|printer_t
modifier|*
name|printer
parameter_list|,
comment|/* I - Model (Level 1 or 2) */
name|int
name|copies
parameter_list|,
comment|/* I - Number of copies */
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - File to print to */
name|Image
name|image
parameter_list|,
comment|/* I - Image to print */
specifier|const
name|vars_t
modifier|*
name|v
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|cmap
init|=
name|v
operator|->
name|cmap
decl_stmt|;
name|int
name|model
init|=
name|printer
operator|->
name|model
decl_stmt|;
name|char
modifier|*
name|ppd_file
init|=
name|v
operator|->
name|ppd_file
decl_stmt|;
name|char
modifier|*
name|resolution
init|=
name|v
operator|->
name|resolution
decl_stmt|;
name|char
modifier|*
name|media_size
init|=
name|v
operator|->
name|media_size
decl_stmt|;
name|char
modifier|*
name|media_type
init|=
name|v
operator|->
name|media_type
decl_stmt|;
name|char
modifier|*
name|media_source
init|=
name|v
operator|->
name|media_source
decl_stmt|;
name|int
name|output_type
init|=
name|v
operator|->
name|output_type
decl_stmt|;
name|int
name|orientation
init|=
name|v
operator|->
name|orientation
decl_stmt|;
name|float
name|scaling
init|=
name|v
operator|->
name|scaling
decl_stmt|;
name|int
name|top
init|=
name|v
operator|->
name|top
decl_stmt|;
name|int
name|left
init|=
name|v
operator|->
name|left
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Looping vars */
name|int
name|y
decl_stmt|;
comment|/* Looping vars */
name|unsigned
name|char
modifier|*
name|in
decl_stmt|;
comment|/* Input pixels from image */
name|unsigned
name|short
modifier|*
name|out
decl_stmt|;
comment|/* Output pixels for printer */
name|int
name|page_left
decl_stmt|,
comment|/* Left margin of page */
name|page_right
decl_stmt|,
comment|/* Right margin of page */
name|page_top
decl_stmt|,
comment|/* Top of page */
name|page_bottom
decl_stmt|,
comment|/* Bottom of page */
name|page_width
decl_stmt|,
comment|/* Width of page */
name|page_height
decl_stmt|,
comment|/* Height of page */
name|out_width
decl_stmt|,
comment|/* Width of image on page */
name|out_height
decl_stmt|,
comment|/* Height of image on page */
name|out_bpp
decl_stmt|,
comment|/* Output bytes per pixel */
name|out_length
decl_stmt|,
comment|/* Output length (Level 2 output) */
name|out_offset
decl_stmt|;
comment|/* Output offset (Level 2 output) */
name|time_t
name|curtime
decl_stmt|;
comment|/* Current time of day */
name|convert_t
name|colorfunc
decl_stmt|;
comment|/* Color conversion function... */
name|char
modifier|*
name|command
decl_stmt|;
comment|/* PostScript command */
name|int
name|order
decl_stmt|,
comment|/* Order of command */
name|num_commands
decl_stmt|;
comment|/* Number of commands */
struct|struct
comment|/* PostScript commands... */
DECL|struct|__anon2bb1f4eb0108
block|{
DECL|member|command
name|char
modifier|*
name|command
decl_stmt|;
DECL|member|order
name|int
name|order
decl_stmt|;
block|}
name|commands
index|[
literal|4
index|]
struct|;
name|int
name|image_height
decl_stmt|,
name|image_width
decl_stmt|,
name|image_bpp
decl_stmt|;
name|vars_t
name|nv
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|nv
argument_list|,
name|v
argument_list|,
sizeof|sizeof
argument_list|(
name|vars_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*   * Setup a read-only pixel region for the entire image...   */
name|Image_init
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_height
operator|=
name|Image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_width
operator|=
name|Image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_bpp
operator|=
name|Image_bpp
argument_list|(
name|image
argument_list|)
expr_stmt|;
comment|/*   * Choose the correct color conversion function...   */
if|if
condition|(
name|image_bpp
operator|<
literal|3
operator|&&
name|cmap
operator|==
name|NULL
operator|&&
name|output_type
operator|==
name|OUTPUT_COLOR
condition|)
name|output_type
operator|=
name|OUTPUT_GRAY_COLOR
expr_stmt|;
comment|/* Force grayscale output */
name|colorfunc
operator|=
name|choose_colorfunc
argument_list|(
name|output_type
argument_list|,
name|image_bpp
argument_list|,
name|cmap
argument_list|,
operator|&
name|out_bpp
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
comment|/*   * Compute the output size...   */
name|ps_imageable_area
argument_list|(
name|printer
argument_list|,
operator|&
name|nv
argument_list|,
operator|&
name|page_left
argument_list|,
operator|&
name|page_right
argument_list|,
operator|&
name|page_bottom
argument_list|,
operator|&
name|page_top
argument_list|)
expr_stmt|;
name|compute_page_parameters
argument_list|(
name|page_right
argument_list|,
name|page_left
argument_list|,
name|page_top
argument_list|,
name|page_bottom
argument_list|,
name|scaling
argument_list|,
name|image_width
argument_list|,
name|image_height
argument_list|,
name|image
argument_list|,
operator|&
name|orientation
argument_list|,
operator|&
name|page_width
argument_list|,
operator|&
name|page_height
argument_list|,
operator|&
name|out_width
argument_list|,
operator|&
name|out_height
argument_list|,
operator|&
name|left
argument_list|,
operator|&
name|top
argument_list|)
expr_stmt|;
comment|/*    * Recompute the image height and width.  If the image has been    * rotated, these will change from previously.    */
name|image_height
operator|=
name|Image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_width
operator|=
name|Image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
comment|/*   * Let the user know what we're doing...   */
name|Image_progress_init
argument_list|(
name|image
argument_list|)
expr_stmt|;
comment|/*   * Output a standard PostScript header with DSC comments...   */
name|curtime
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|0
condition|)
name|left
operator|=
operator|(
name|page_width
operator|-
name|out_width
operator|)
operator|/
literal|2
operator|+
name|page_left
expr_stmt|;
else|else
name|left
operator|+=
name|page_left
expr_stmt|;
if|if
condition|(
name|top
operator|<
literal|0
condition|)
name|top
operator|=
operator|(
name|page_height
operator|+
name|out_height
operator|)
operator|/
literal|2
operator|+
name|page_bottom
expr_stmt|;
else|else
name|top
operator|=
name|page_height
operator|-
name|top
operator|+
name|page_bottom
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"out_width = %d, out_height = %d\n"
argument_list|,
name|out_width
argument_list|,
name|out_height
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"page_left = %d, page_right = %d, page_bottom = %d, page_top = %d\n"
argument_list|,
name|page_left
argument_list|,
name|page_right
argument_list|,
name|page_bottom
argument_list|,
name|page_top
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"left = %d, top = %d\n"
argument_list|,
name|left
argument_list|,
name|top
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
ifdef|#
directive|ifdef
name|__EMX__
name|_fsetmode
argument_list|(
name|prn
argument_list|,
literal|"t"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fputs
argument_list|(
literal|"%!PS-Adobe-3.0\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"%%%%Creator: %s\n"
argument_list|,
name|Image_get_appname
argument_list|(
name|image
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"%%%%CreationDate: %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|curtime
argument_list|)
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"%%Copyright: 1997-2000 by Michael Sweet (mike@easysw.com) and Robert Krawitz (rlk@alum.mit.edu)\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"%%%%BoundingBox: %d %d %d %d\n"
argument_list|,
name|left
argument_list|,
name|top
operator|-
name|out_height
argument_list|,
name|left
operator|+
name|out_width
argument_list|,
name|top
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"%%DocumentData: Clean7Bit\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"%%%%LanguageLevel: %d\n"
argument_list|,
name|model
operator|+
literal|1
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"%%Pages: 1\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"%%Orientation: Portrait\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"%%EndComments\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/*   * Find any printer-specific commands...   */
name|num_commands
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|command
operator|=
name|ppd_find
argument_list|(
name|ppd_file
argument_list|,
literal|"PageSize"
argument_list|,
name|media_size
argument_list|,
operator|&
name|order
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|commands
index|[
name|num_commands
index|]
operator|.
name|command
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|command
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|commands
index|[
name|num_commands
index|]
operator|.
name|command
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|commands
index|[
name|num_commands
index|]
operator|.
name|order
operator|=
name|order
expr_stmt|;
name|num_commands
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|command
operator|=
name|ppd_find
argument_list|(
name|ppd_file
argument_list|,
literal|"InputSlot"
argument_list|,
name|media_source
argument_list|,
operator|&
name|order
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|commands
index|[
name|num_commands
index|]
operator|.
name|command
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|command
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|commands
index|[
name|num_commands
index|]
operator|.
name|command
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|commands
index|[
name|num_commands
index|]
operator|.
name|order
operator|=
name|order
expr_stmt|;
name|num_commands
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|command
operator|=
name|ppd_find
argument_list|(
name|ppd_file
argument_list|,
literal|"MediaType"
argument_list|,
name|media_type
argument_list|,
operator|&
name|order
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|commands
index|[
name|num_commands
index|]
operator|.
name|command
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|command
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|commands
index|[
name|num_commands
index|]
operator|.
name|command
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|commands
index|[
name|num_commands
index|]
operator|.
name|order
operator|=
name|order
expr_stmt|;
name|num_commands
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|command
operator|=
name|ppd_find
argument_list|(
name|ppd_file
argument_list|,
literal|"Resolution"
argument_list|,
name|resolution
argument_list|,
operator|&
name|order
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|commands
index|[
name|num_commands
index|]
operator|.
name|command
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|command
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|commands
index|[
name|num_commands
index|]
operator|.
name|command
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|commands
index|[
name|num_commands
index|]
operator|.
name|order
operator|=
name|order
expr_stmt|;
name|num_commands
operator|++
expr_stmt|;
block|}
comment|/*   * Sort the commands using the OrderDependency value...   */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|num_commands
operator|-
literal|1
operator|)
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
name|i
operator|+
literal|1
init|;
name|j
operator|<
name|num_commands
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|commands
index|[
name|j
index|]
operator|.
name|order
operator|<
name|commands
index|[
name|i
index|]
operator|.
name|order
condition|)
block|{
name|order
operator|=
name|commands
index|[
name|i
index|]
operator|.
name|order
expr_stmt|;
name|command
operator|=
name|commands
index|[
name|i
index|]
operator|.
name|command
expr_stmt|;
name|commands
index|[
name|i
index|]
operator|.
name|command
operator|=
name|commands
index|[
name|j
index|]
operator|.
name|command
expr_stmt|;
name|commands
index|[
name|i
index|]
operator|.
name|order
operator|=
name|commands
index|[
name|j
index|]
operator|.
name|order
expr_stmt|;
name|commands
index|[
name|j
index|]
operator|.
name|command
operator|=
name|command
expr_stmt|;
name|commands
index|[
name|j
index|]
operator|.
name|order
operator|=
name|order
expr_stmt|;
block|}
comment|/*   * Send the commands...   */
if|if
condition|(
name|num_commands
operator|>
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|"%%BeginProlog\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_commands
condition|;
name|i
operator|++
control|)
block|{
name|fputs
argument_list|(
name|commands
index|[
name|i
index|]
operator|.
name|command
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|commands
index|[
name|i
index|]
operator|.
name|command
argument_list|)
expr_stmt|;
block|}
name|fputs
argument_list|(
literal|"%%EndProlog\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
comment|/*   * Output the page...   */
name|fputs
argument_list|(
literal|"%%Page: 1\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"gsave\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"%d %d translate\n"
argument_list|,
name|left
argument_list|,
name|top
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"%.3f %.3f scale\n"
argument_list|,
operator|(
name|float
operator|)
name|out_width
operator|/
operator|(
operator|(
name|float
operator|)
name|image_width
operator|)
argument_list|,
operator|(
name|float
operator|)
name|out_height
operator|/
operator|(
operator|(
name|float
operator|)
name|image_height
operator|)
argument_list|)
expr_stmt|;
name|in
operator|=
name|malloc
argument_list|(
name|image_width
operator|*
name|image_bpp
argument_list|)
expr_stmt|;
name|out
operator|=
name|malloc
argument_list|(
operator|(
name|image_width
operator|*
name|out_bpp
operator|+
literal|3
operator|)
operator|*
literal|2
argument_list|)
expr_stmt|;
name|compute_lut
argument_list|(
literal|256
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
if|if
condition|(
name|model
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"/picture %d string def\n"
argument_list|,
name|image_width
operator|*
name|out_bpp
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"%d %d 8\n"
argument_list|,
name|image_width
argument_list|,
name|image_height
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"[ 1 0 0 -1 0 1 ]\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
name|fputs
argument_list|(
literal|"{currentfile picture readhexstring pop} image\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
else|else
name|fputs
argument_list|(
literal|"{currentfile picture readhexstring pop} false 3 colorimage\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|image_height
condition|;
name|y
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|y
operator|&
literal|15
operator|)
operator|==
literal|0
condition|)
name|Image_note_progress
argument_list|(
name|image
argument_list|,
name|y
argument_list|,
name|image_height
argument_list|)
expr_stmt|;
name|Image_get_row
argument_list|(
name|image
argument_list|,
name|in
argument_list|,
name|y
argument_list|)
expr_stmt|;
call|(
modifier|*
name|colorfunc
call|)
argument_list|(
name|in
argument_list|,
name|out
argument_list|,
name|image_width
argument_list|,
name|image_bpp
argument_list|,
name|cmap
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
name|ps_hex
argument_list|(
name|prn
argument_list|,
name|out
argument_list|,
name|image_width
operator|*
name|out_bpp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
name|fputs
argument_list|(
literal|"/DeviceGray setcolorspace\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
else|else
name|fputs
argument_list|(
literal|"/DeviceRGB setcolorspace\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"<<\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t/ImageType 1\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\t/Width %d\n"
argument_list|,
name|image_width
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\t/Height %d\n"
argument_list|,
name|image_height
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t/BitsPerComponent 8\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
name|fputs
argument_list|(
literal|"\t/Decode [ 0 1 ]\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
else|else
name|fputs
argument_list|(
literal|"\t/Decode [ 0 1 0 1 0 1 ]\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t/DataSource currentfile /ASCII85Decode filter\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|image_width
operator|*
literal|72
operator|/
name|out_width
operator|)
operator|<
literal|100
condition|)
name|fputs
argument_list|(
literal|"\t/Interpolate true\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t/ImageMatrix [ 1 0 0 -1 0 1 ]\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|">>\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"image\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
operator|,
name|out_offset
operator|=
literal|0
init|;
name|y
operator|<
name|image_height
condition|;
name|y
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|y
operator|&
literal|15
operator|)
operator|==
literal|0
condition|)
name|Image_note_progress
argument_list|(
name|image
argument_list|,
name|y
argument_list|,
name|image_height
argument_list|)
expr_stmt|;
name|Image_get_row
argument_list|(
name|image
argument_list|,
name|in
argument_list|,
name|y
argument_list|)
expr_stmt|;
call|(
modifier|*
name|colorfunc
call|)
argument_list|(
name|in
argument_list|,
name|out
operator|+
name|out_offset
argument_list|,
name|image_width
argument_list|,
name|image_bpp
argument_list|,
name|cmap
argument_list|,
operator|&
name|nv
argument_list|)
expr_stmt|;
name|out_length
operator|=
name|out_offset
operator|+
name|image_width
operator|*
name|out_bpp
expr_stmt|;
if|if
condition|(
name|y
operator|<
operator|(
name|image_height
operator|-
literal|1
operator|)
condition|)
block|{
name|ps_ascii85
argument_list|(
name|prn
argument_list|,
name|out
argument_list|,
name|out_length
operator|&
operator|~
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|out_offset
operator|=
name|out_length
operator|&
literal|3
expr_stmt|;
block|}
else|else
block|{
name|ps_ascii85
argument_list|(
name|prn
argument_list|,
name|out
argument_list|,
name|out_length
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|out_offset
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|out_offset
operator|>
literal|0
condition|)
name|memcpy
argument_list|(
name|out
argument_list|,
name|out
operator|+
name|out_length
operator|-
name|out_offset
argument_list|,
name|out_offset
argument_list|)
expr_stmt|;
block|}
block|}
name|Image_progress_conclude
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|free_lut
argument_list|(
operator|&
name|nv
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"grestore\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"showpage\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"%%EndPage\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"%%EOF\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 'ps_hex()' - Print binary data as a series of hexadecimal numbers.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|ps_hex (FILE * prn,unsigned short * data,int length)
name|ps_hex
parameter_list|(
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - File to print to */
name|unsigned
name|short
modifier|*
name|data
parameter_list|,
comment|/* I - Data to print */
name|int
name|length
parameter_list|)
comment|/* I - Number of bytes to print */
block|{
name|int
name|col
decl_stmt|;
comment|/* Current column */
specifier|static
name|char
modifier|*
name|hex
init|=
literal|"0123456789ABCDEF"
decl_stmt|;
name|col
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|unsigned
name|char
name|pixel
init|=
operator|(
operator|*
name|data
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
decl_stmt|;
comment|/*     * Put the hex chars out to the file; note that we don't use fprintf()     * for speed reasons...     */
name|putc
argument_list|(
name|hex
index|[
name|pixel
operator|>>
literal|4
index|]
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|hex
index|[
name|pixel
operator|&
literal|15
index|]
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|length
operator|--
expr_stmt|;
name|col
operator|=
operator|(
name|col
operator|+
literal|1
operator|)
operator|&
literal|31
expr_stmt|;
if|if
condition|(
name|col
operator|==
literal|0
condition|)
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|col
operator|>
literal|0
condition|)
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 'ps_ascii85()' - Print binary data as a series of base-85 numbers.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|ps_ascii85 (FILE * prn,unsigned short * data,int length,int last_line)
name|ps_ascii85
parameter_list|(
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - File to print to */
name|unsigned
name|short
modifier|*
name|data
parameter_list|,
comment|/* I - Data to print */
name|int
name|length
parameter_list|,
comment|/* I - Number of bytes to print */
name|int
name|last_line
parameter_list|)
comment|/* I - Last line of raster data? */
block|{
name|int
name|i
decl_stmt|;
comment|/* Looping var */
name|unsigned
name|b
decl_stmt|;
comment|/* Binary data word */
name|unsigned
name|char
name|c
index|[
literal|5
index|]
decl_stmt|;
comment|/* ASCII85 encoded chars */
while|while
condition|(
name|length
operator|>
literal|3
condition|)
block|{
name|unsigned
name|char
name|d0
init|=
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
decl_stmt|;
name|unsigned
name|char
name|d1
init|=
operator|(
name|data
index|[
literal|1
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
decl_stmt|;
name|unsigned
name|char
name|d2
init|=
operator|(
name|data
index|[
literal|2
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
decl_stmt|;
name|unsigned
name|char
name|d3
init|=
operator|(
name|data
index|[
literal|3
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
decl_stmt|;
name|b
operator|=
operator|(
operator|(
operator|(
operator|(
operator|(
name|d0
operator|<<
literal|8
operator|)
operator||
name|d1
operator|)
operator|<<
literal|8
operator|)
operator||
name|d2
operator|)
operator|<<
literal|8
operator|)
operator||
name|d3
expr_stmt|;
if|if
condition|(
name|b
operator|==
literal|0
condition|)
name|putc
argument_list|(
literal|'z'
argument_list|,
name|prn
argument_list|)
expr_stmt|;
else|else
block|{
name|c
index|[
literal|4
index|]
operator|=
operator|(
name|b
operator|%
literal|85
operator|)
operator|+
literal|'!'
expr_stmt|;
name|b
operator|/=
literal|85
expr_stmt|;
name|c
index|[
literal|3
index|]
operator|=
operator|(
name|b
operator|%
literal|85
operator|)
operator|+
literal|'!'
expr_stmt|;
name|b
operator|/=
literal|85
expr_stmt|;
name|c
index|[
literal|2
index|]
operator|=
operator|(
name|b
operator|%
literal|85
operator|)
operator|+
literal|'!'
expr_stmt|;
name|b
operator|/=
literal|85
expr_stmt|;
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|b
operator|%
literal|85
operator|)
operator|+
literal|'!'
expr_stmt|;
name|b
operator|/=
literal|85
expr_stmt|;
name|c
index|[
literal|0
index|]
operator|=
name|b
operator|+
literal|'!'
expr_stmt|;
name|fwrite
argument_list|(
name|c
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
name|data
operator|+=
literal|4
expr_stmt|;
name|length
operator|-=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|last_line
condition|)
block|{
if|if
condition|(
name|length
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|b
operator|=
literal|0
operator|,
name|i
operator|=
name|length
init|;
name|i
operator|>
literal|0
condition|;
name|b
operator|=
operator|(
name|b
operator|<<
literal|8
operator|)
operator||
name|data
index|[
literal|0
index|]
operator|,
name|data
operator|++
operator|,
name|i
operator|--
control|)
empty_stmt|;
name|c
index|[
literal|4
index|]
operator|=
operator|(
name|b
operator|%
literal|85
operator|)
operator|+
literal|'!'
expr_stmt|;
name|b
operator|/=
literal|85
expr_stmt|;
name|c
index|[
literal|3
index|]
operator|=
operator|(
name|b
operator|%
literal|85
operator|)
operator|+
literal|'!'
expr_stmt|;
name|b
operator|/=
literal|85
expr_stmt|;
name|c
index|[
literal|2
index|]
operator|=
operator|(
name|b
operator|%
literal|85
operator|)
operator|+
literal|'!'
expr_stmt|;
name|b
operator|/=
literal|85
expr_stmt|;
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|b
operator|%
literal|85
operator|)
operator|+
literal|'!'
expr_stmt|;
name|b
operator|/=
literal|85
expr_stmt|;
name|c
index|[
literal|0
index|]
operator|=
name|b
operator|+
literal|'!'
expr_stmt|;
name|fwrite
argument_list|(
name|c
argument_list|,
name|length
operator|+
literal|1
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
name|fputs
argument_list|(
literal|"~>\n"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * 'ppd_find()' - Find a control string with the specified name& parameters.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
comment|/* O - Control string */
DECL|function|ppd_find (const char * ppd_file,const char * name,const char * option,int * order)
name|ppd_find
parameter_list|(
specifier|const
name|char
modifier|*
name|ppd_file
parameter_list|,
comment|/* I - Name of PPD file */
specifier|const
name|char
modifier|*
name|name
parameter_list|,
comment|/* I - Name of parameter */
specifier|const
name|char
modifier|*
name|option
parameter_list|,
comment|/* I - Value of parameter */
name|int
modifier|*
name|order
parameter_list|)
comment|/* O - Order of the control string */
block|{
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|,
comment|/* Line from file */
name|lname
index|[
literal|255
index|]
decl_stmt|,
comment|/* Name from line */
name|loption
index|[
literal|255
index|]
decl_stmt|,
comment|/* Value from line */
modifier|*
name|opt
decl_stmt|;
comment|/* Current control string pointer */
specifier|static
name|char
modifier|*
name|value
init|=
name|NULL
decl_stmt|;
comment|/* Current control string value */
if|if
condition|(
name|ppd_file
operator|==
name|NULL
operator|||
name|name
operator|==
name|NULL
operator|||
name|option
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
operator|!
name|value
condition|)
name|value
operator|=
name|malloc
argument_list|(
literal|32768
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps_ppd_file
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|ps_ppd_file
argument_list|,
name|ppd_file
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ps_ppd
operator|!=
name|NULL
condition|)
name|fclose
argument_list|(
name|ps_ppd
argument_list|)
expr_stmt|;
name|ps_ppd
operator|=
name|fopen
argument_list|(
name|ppd_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps_ppd
operator|==
name|NULL
condition|)
name|ps_ppd_file
operator|=
name|NULL
expr_stmt|;
else|else
name|ps_ppd_file
operator|=
name|ppd_file
expr_stmt|;
block|}
if|if
condition|(
name|ps_ppd
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|order
operator|!=
name|NULL
condition|)
operator|*
name|order
operator|=
literal|1000
expr_stmt|;
name|rewind
argument_list|(
name|ps_ppd
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|ps_ppd
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|line
index|[
literal|0
index|]
operator|!=
literal|'*'
condition|)
continue|continue;
if|if
condition|(
name|strncasecmp
argument_list|(
name|line
argument_list|,
literal|"*OrderDependency:"
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
operator|&&
name|order
operator|!=
name|NULL
condition|)
block|{
name|sscanf
argument_list|(
name|line
argument_list|,
literal|"%*s%d"
argument_list|,
name|order
argument_list|)
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|sscanf
argument_list|(
name|line
argument_list|,
literal|"*%s %[^/:]"
argument_list|,
name|lname
argument_list|,
name|loption
argument_list|)
operator|!=
literal|2
condition|)
continue|continue;
if|if
condition|(
name|strcasecmp
argument_list|(
name|lname
argument_list|,
name|name
argument_list|)
operator|==
literal|0
operator|&&
name|strcasecmp
argument_list|(
name|loption
argument_list|,
name|option
argument_list|)
operator|==
literal|0
condition|)
block|{
name|opt
operator|=
name|strchr
argument_list|(
name|line
argument_list|,
literal|':'
argument_list|)
operator|+
literal|1
expr_stmt|;
while|while
condition|(
operator|*
name|opt
operator|==
literal|' '
operator|||
operator|*
name|opt
operator|==
literal|'\t'
condition|)
name|opt
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|opt
operator|!=
literal|'\"'
condition|)
continue|continue;
name|strcpy
argument_list|(
name|value
argument_list|,
name|opt
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opt
operator|=
name|strchr
argument_list|(
name|value
argument_list|,
literal|'\"'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|ps_ppd
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|strcat
argument_list|(
name|value
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|line
argument_list|,
literal|'\"'
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|strcpy
argument_list|(
name|strchr
argument_list|(
name|value
argument_list|,
literal|'\"'
argument_list|)
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
operator|*
name|opt
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

end_unit

