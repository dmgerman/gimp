begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * "$Id$"  *  *   Printer maintenance utility for Epson Stylus printers  *  *   Copyright 2000 Robert Krawitz (rlk@alum.mit.edu)  *  *   This program is free software; you can redistribute it and/or modify it  *   under the terms of the GNU General Public License as published by the Free  *   Software Foundation; either version 2 of the License, or (at your option)  *   any later version.  *  *   This program is distributed in the hope that it will be useful, but  *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY  *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License  *   for more details.  *  *   You should have received a copy of the GNU General Public License  *   along with this program; if not, write to the Free Software  *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__GNU_LIBRARY__
end_ifdef

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
DECL|variable|banner
name|char
modifier|*
name|banner
init|=
literal|"\ Copyright 2000 Robert Krawitz (rlk@alum.mit.edu)\n\ \n\ This program is free software; you can redistribute it and/or modify it\n\ under the terms of the GNU General Public License as published by the Free\n\ Software Foundation; either version 2 of the License, or (at your option)\n\ any later version.\n\ \n\ This program is distributed in the hope that it will be useful, but\n\ WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY\n\ or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n\ for more details.\n\ \n\ You should have received a copy of the GNU General Public License\n\ along with this program; if not, write to the Free Software\n\ Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.\n"
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__GNU_LIBRARY__
end_ifdef

begin_decl_stmt
DECL|variable|optlist
name|struct
name|option
name|optlist
index|[]
init|=
block|{
block|{
literal|"printer-name"
block|,
literal|1
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'P'
block|}
block|,
block|{
literal|"raw-device"
block|,
literal|1
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'r'
block|}
block|,
block|{
literal|"ink-level"
block|,
literal|0
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'i'
block|}
block|,
block|{
literal|"clean-head"
block|,
literal|0
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'c'
block|}
block|,
block|{
literal|"nozzle-check"
block|,
literal|0
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'n'
block|}
block|,
block|{
literal|"align-head"
block|,
literal|0
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'a'
block|}
block|,
block|{
literal|"usb"
block|,
literal|0
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'u'
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'h'
block|}
block|,
block|{
literal|"identify"
block|,
literal|0
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'d'
block|}
block|,
block|{
literal|"model"
block|,
literal|1
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'m'
block|}
block|,
block|{
literal|"quiet"
block|,
literal|0
block|,
name|NULL
block|,
operator|(
name|int
operator|)
literal|'q'
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|help_msg
name|char
modifier|*
name|help_msg
init|=
literal|"\ Usage: escputil [-P printer | -r device] [-m model] [-u]\n\                 [-c | -n | -a | -i] [-q]\n\     -P|--printer-name  Specify the name of the printer to operate on.\n\                        Default is the default system printer.\n\     -r|--raw-device    Specify the name of the device to write to directly\n\                        rather than going through a printer queue.\n\     -c|--clean-head    Clean the print head.\n\     -n|--nozzle-check  Print a nozzle test pattern.\n\                        Dirty or clogged nozzles will show as gaps in the\n\                        pattern.  If you see any gaps, you should run a\n\                        head cleaning pass.\n\     -a|--align-head    Align the print head.  CAUTION: Misuse of this\n\                        utility may result in poor print quality and/or\n\                        damage to the printer.\n\     -i|--ink-level     Obtain the ink level from the printer.  This requires\n\                        read/write access to the raw printer device.\n\     -d|--identify      Query the printer for make and model information.\n\                        This requires read/write access to the raw printer\n\                        device.\n\     -u|--usb           The printer is connected via USB.\n\     -h|--help          Print this help message.\n\     -q|--quiet         Suppress the banner.\n\     -m|--model         Specify the precise printer model for head alignment.\n"
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
DECL|variable|help_msg
name|char
modifier|*
name|help_msg
init|=
literal|"\ Usage: escputil [-P printer | -r device] [-u] [-c | -n | -a | -i] [-q]\n\     -P Specify the name of the printer to operate on.\n\           Default is the default system printer.\n\     -r Specify the name of the device to write to directly\n\           rather than going through a printer queue.\n\     -c Clean the print head.\n\     -n Print a nozzle test pattern.\n\           Dirty or clogged nozzles will show as gaps in the\n\           pattern.  If you see any gaps, you should run a\n\           head cleaning pass.\n\     -a Align the print head.  CAUTION: Misuse of this\n\           utility may result in poor print quality and/or\n\           damage to the printer.\n\     -i Obtain the ink level from the printer.  This requires\n\           read/write access to the raw printer device.\n\     -d Query the printer for make and model information.  This\n\           requires read/write access to the raw printer device.\n\     -u The printer is connected via USB.\n\     -h Print this help message.\n\     -q Suppress the banner.\n\     -m Specify the precise printer model for head alignment.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon28dc1dc70108
block|{
DECL|member|short_name
name|char
modifier|*
name|short_name
decl_stmt|;
DECL|member|long_name
name|char
modifier|*
name|long_name
decl_stmt|;
DECL|member|passes
name|int
name|passes
decl_stmt|;
DECL|member|choices
name|int
name|choices
decl_stmt|;
DECL|typedef|printer_t
block|}
name|printer_t
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|printer_list
name|printer_t
name|printer_list
index|[]
init|=
block|{
block|{
literal|"color"
block|,
literal|"Stylus Color"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"pro"
block|,
literal|"Stylus Color Pro"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"pro-xl"
block|,
literal|"Stylus Color Pro XL"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"400"
block|,
literal|"Stylus Color 400"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"440"
block|,
literal|"Stylus Color 440"
block|,
literal|1
block|,
literal|15
block|}
block|,
block|{
literal|"460"
block|,
literal|"Stylus Color 460"
block|,
literal|1
block|,
literal|15
block|}
block|,
block|{
literal|"480"
block|,
literal|"Stylus Color 480"
block|,
literal|1
block|,
literal|15
block|}
block|,
block|{
literal|"500"
block|,
literal|"Stylus Color 500"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"600"
block|,
literal|"Stylus Color 600"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"640"
block|,
literal|"Stylus Color 640"
block|,
literal|1
block|,
literal|15
block|}
block|,
block|{
literal|"660"
block|,
literal|"Stylus Color 660"
block|,
literal|1
block|,
literal|15
block|}
block|,
block|{
literal|"670"
block|,
literal|"Stylus Color 670"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"740"
block|,
literal|"Stylus Color 740"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"760"
block|,
literal|"Stylus Color 760"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"800"
block|,
literal|"Stylus Color 800"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"850"
block|,
literal|"Stylus Color 850"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"860"
block|,
literal|"Stylus Color 860"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"880"
block|,
literal|"Stylus Color 880"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"900"
block|,
literal|"Stylus Color 900"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"980"
block|,
literal|"Stylus Color 980"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"1160"
block|,
literal|"Stylus Color 1160"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"1500"
block|,
literal|"Stylus Color 1500"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"1520"
block|,
literal|"Stylus Color 1520"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"3000"
block|,
literal|"Stylus Color 3000"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"photo"
block|,
literal|"Stylus Photo"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"700"
block|,
literal|"Stylus Photo 700"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"ex"
block|,
literal|"Stylus Photo EX"
block|,
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|"720"
block|,
literal|"Stylus Photo 720"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"750"
block|,
literal|"Stylus Photo 750"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"870"
block|,
literal|"Stylus Photo 870"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"1200"
block|,
literal|"Stylus Photo 1200"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"1270"
block|,
literal|"Stylus Photo 1270"
block|,
literal|3
block|,
literal|15
block|}
block|,
block|{
literal|"2000"
block|,
literal|"Stylus Photo 2000P"
block|,
literal|2
block|,
literal|15
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|initialize_print_cmd
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|do_head_clean
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|do_nozzle_check
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|do_align
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|do_ink_level
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|do_identify
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|printer
name|char
modifier|*
name|printer
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|raw_device
name|char
modifier|*
name|raw_device
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|printer_model
name|char
modifier|*
name|printer_model
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|printer_cmd
name|char
name|printer_cmd
index|[
literal|1025
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|bufpos
name|int
name|bufpos
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|isUSB
name|int
name|isUSB
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|do_help (int code)
name|do_help
parameter_list|(
name|int
name|code
parameter_list|)
block|{
name|printer_t
modifier|*
name|printer
init|=
operator|&
name|printer_list
index|[
literal|0
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|help_msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Available models are:\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|printer
operator|->
name|short_name
condition|)
block|{
name|printf
argument_list|(
literal|"%10s      %s\n"
argument_list|,
name|printer
operator|->
name|short_name
argument_list|,
name|printer
operator|->
name|long_name
argument_list|)
expr_stmt|;
name|printer
operator|++
expr_stmt|;
block|}
name|exit
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
DECL|function|main (int argc,char ** argv)
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|quiet
init|=
literal|0
decl_stmt|;
name|int
name|operation
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|__GNU_LIBRARY__
name|int
name|option_index
init|=
literal|0
decl_stmt|;
name|c
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"P:r:icnaduqm:"
argument_list|,
name|optlist
argument_list|,
operator|&
name|option_index
argument_list|)
expr_stmt|;
else|#
directive|else
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"P:r:icnaduqm:"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|c
operator|==
operator|-
literal|1
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'q'
case|:
name|quiet
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
case|case
literal|'i'
case|:
case|case
literal|'n'
case|:
case|case
literal|'a'
case|:
case|case
literal|'d'
case|:
if|if
condition|(
name|operation
condition|)
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|operation
operator|=
name|c
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
if|if
condition|(
name|printer
operator|||
name|raw_device
condition|)
block|{
name|printf
argument_list|(
literal|"You may only specify one printer or raw device.\n"
argument_list|)
expr_stmt|;
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printer
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|optarg
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|printer
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
name|printer
operator|||
name|raw_device
condition|)
block|{
name|printf
argument_list|(
literal|"You may only specify one printer or raw device.\n"
argument_list|)
expr_stmt|;
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|raw_device
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|optarg
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|raw_device
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
if|if
condition|(
name|printer_model
condition|)
block|{
name|printf
argument_list|(
literal|"You may only specify one printer model.\n"
argument_list|)
expr_stmt|;
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printer_model
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|optarg
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|printer_model
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|isUSB
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|do_help
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|banner
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown option %c\n"
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|quiet
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|banner
argument_list|)
expr_stmt|;
if|if
condition|(
name|operation
operator|==
literal|0
condition|)
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|initialize_print_cmd
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|operation
condition|)
block|{
case|case
literal|'c'
case|:
name|do_head_clean
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|do_nozzle_check
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|do_ink_level
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|do_align
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|do_identify
argument_list|()
expr_stmt|;
break|break;
default|default:
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
DECL|function|do_print_cmd (void)
name|do_print_cmd
parameter_list|(
name|void
parameter_list|)
block|{
name|FILE
modifier|*
name|pfile
decl_stmt|;
name|int
name|bytes
init|=
literal|0
decl_stmt|;
name|int
name|retries
init|=
literal|0
decl_stmt|;
name|char
name|command
index|[
literal|1024
index|]
decl_stmt|;
name|memcpy
argument_list|(
name|printer_cmd
operator|+
name|bufpos
argument_list|,
literal|"\f\033\000\033\000"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|bufpos
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
name|raw_device
condition|)
block|{
name|pfile
operator|=
name|fopen
argument_list|(
name|raw_device
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pfile
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open device %s: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|access
argument_list|(
literal|"/bin/lpr"
argument_list|,
name|X_OK
argument_list|)
operator|||
operator|!
name|access
argument_list|(
literal|"/usr/bin/lpr"
argument_list|,
name|X_OK
argument_list|)
operator|||
operator|!
name|access
argument_list|(
literal|"/usr/bsd/lpr"
argument_list|,
name|X_OK
argument_list|)
condition|)
block|{
if|if
condition|(
name|printer
operator|==
name|NULL
condition|)
name|strcpy
argument_list|(
name|command
argument_list|,
literal|"lpr -l"
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|command
argument_list|,
literal|"lpr -P%s -l"
argument_list|,
name|printer
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|printer
operator|==
name|NULL
condition|)
name|strcpy
argument_list|(
name|command
argument_list|,
literal|"lp -s -oraw"
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|command
argument_list|,
literal|"lp -s -oraw -d%s"
argument_list|,
name|printer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pfile
operator|=
name|popen
argument_list|(
name|command
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot print to printer %s with %s\n"
argument_list|,
name|printer
argument_list|,
name|command
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
while|while
condition|(
name|bytes
operator|<
name|bufpos
condition|)
block|{
name|int
name|status
init|=
name|fwrite
argument_list|(
name|printer_cmd
operator|+
name|bytes
argument_list|,
literal|1
argument_list|,
name|bufpos
operator|-
name|bytes
argument_list|,
name|pfile
argument_list|)
decl_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
block|{
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|retries
operator|>
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to send command to printer\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw_device
condition|)
name|fclose
argument_list|(
name|pfile
argument_list|)
expr_stmt|;
else|else
name|pclose
argument_list|(
name|pfile
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|status
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to send command to printer\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw_device
condition|)
name|fclose
argument_list|(
name|pfile
argument_list|)
expr_stmt|;
else|else
name|pclose
argument_list|(
name|pfile
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
block|{
name|bytes
operator|+=
name|status
expr_stmt|;
name|retries
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|raw_device
condition|)
name|fclose
argument_list|(
name|pfile
argument_list|)
expr_stmt|;
else|else
name|pclose
argument_list|(
name|pfile
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
DECL|function|initialize_print_cmd (void)
name|initialize_print_cmd
parameter_list|(
name|void
parameter_list|)
block|{
name|bufpos
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|isUSB
condition|)
block|{
specifier|static
name|char
name|hdr
index|[]
init|=
literal|"\000\000\000\033\001@EJL 1284.4\n@EJL     \n\033@"
decl_stmt|;
name|memcpy
argument_list|(
name|printer_cmd
argument_list|,
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Do NOT include the null! */
name|bufpos
operator|=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|do_remote_cmd (char * cmd,int nargs,int a0,int a1,int a2,int a3)
name|do_remote_cmd
parameter_list|(
name|char
modifier|*
name|cmd
parameter_list|,
name|int
name|nargs
parameter_list|,
name|int
name|a0
parameter_list|,
name|int
name|a1
parameter_list|,
name|int
name|a2
parameter_list|,
name|int
name|a3
parameter_list|)
block|{
specifier|static
name|char
name|remote_hdr
index|[]
init|=
literal|"\033@\033(R\010\000\000REMOTE1"
decl_stmt|;
specifier|static
name|char
name|remote_trailer
index|[]
init|=
literal|"\033\000\000\000\033\000"
decl_stmt|;
name|memcpy
argument_list|(
name|printer_cmd
operator|+
name|bufpos
argument_list|,
name|remote_hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|remote_hdr
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bufpos
operator|+=
sizeof|sizeof
argument_list|(
name|remote_hdr
argument_list|)
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|printer_cmd
operator|+
name|bufpos
argument_list|,
name|cmd
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bufpos
operator|+=
literal|2
expr_stmt|;
name|printer_cmd
index|[
name|bufpos
index|]
operator|=
name|nargs
operator|%
literal|256
expr_stmt|;
name|printer_cmd
index|[
name|bufpos
operator|+
literal|1
index|]
operator|=
operator|(
name|nargs
operator|>>
literal|8
operator|)
operator|%
literal|256
expr_stmt|;
if|if
condition|(
name|nargs
operator|>
literal|0
condition|)
name|printer_cmd
index|[
name|bufpos
operator|+
literal|2
index|]
operator|=
name|a0
expr_stmt|;
if|if
condition|(
name|nargs
operator|>
literal|1
condition|)
name|printer_cmd
index|[
name|bufpos
operator|+
literal|3
index|]
operator|=
name|a1
expr_stmt|;
if|if
condition|(
name|nargs
operator|>
literal|2
condition|)
name|printer_cmd
index|[
name|bufpos
operator|+
literal|4
index|]
operator|=
name|a2
expr_stmt|;
if|if
condition|(
name|nargs
operator|>
literal|3
condition|)
name|printer_cmd
index|[
name|bufpos
operator|+
literal|5
index|]
operator|=
name|a3
expr_stmt|;
name|bufpos
operator|+=
literal|2
operator|+
name|nargs
expr_stmt|;
name|memcpy
argument_list|(
name|printer_cmd
operator|+
name|bufpos
argument_list|,
name|remote_trailer
argument_list|,
sizeof|sizeof
argument_list|(
name|remote_trailer
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bufpos
operator|+=
sizeof|sizeof
argument_list|(
name|remote_trailer
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|add_newlines (int count)
name|add_newlines
parameter_list|(
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|printer_cmd
index|[
name|bufpos
operator|++
index|]
operator|=
literal|'\r'
expr_stmt|;
name|printer_cmd
index|[
name|bufpos
operator|++
index|]
operator|=
literal|'\n'
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|add_resets (int count)
name|add_resets
parameter_list|(
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|printer_cmd
index|[
name|bufpos
operator|++
index|]
operator|=
literal|'\033'
expr_stmt|;
name|printer_cmd
index|[
name|bufpos
operator|++
index|]
operator|=
literal|'\000'
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
DECL|variable|colors
name|char
modifier|*
name|colors
index|[]
init|=
block|{
literal|"Black"
block|,
literal|"Cyan"
block|,
literal|"Magenta"
block|,
literal|"Yellow"
block|,
literal|"Light Cyan"
block|,
literal|"Light Magenta"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|do_ink_level (void)
name|do_ink_level
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|int
name|status
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|ind
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|raw_device
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Obtaining ink levels requires using a raw device.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|raw_device
argument_list|,
name|O_RDWR
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open %s read/write: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|do_remote_cmd
argument_list|(
literal|"IQ"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|add_resets
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|printer_cmd
argument_list|,
name|bufpos
argument_list|)
operator|<
name|bufpos
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot write to %s: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|status
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
literal|1023
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot read from %s: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ind
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'I'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ind
operator|||
name|ind
index|[
literal|1
index|]
operator|!=
literal|'Q'
operator|||
name|ind
index|[
literal|2
index|]
operator|!=
literal|':'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot parse output from printer\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ind
operator|+=
literal|3
expr_stmt|;
name|printf
argument_list|(
literal|"%20s    %s\n"
argument_list|,
literal|"Ink color"
argument_list|,
literal|"Percent remaining"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
name|int
name|val
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
operator|!
name|ind
index|[
literal|0
index|]
operator|||
name|ind
index|[
literal|0
index|]
operator|==
literal|';'
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|2
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|ind
index|[
name|j
index|]
operator|>=
literal|'0'
operator|&&
name|ind
index|[
name|j
index|]
operator|<=
literal|'9'
condition|)
name|ind
index|[
name|j
index|]
operator|-=
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
name|ind
index|[
name|j
index|]
operator|>=
literal|'A'
operator|&&
name|ind
index|[
name|j
index|]
operator|<=
literal|'F'
condition|)
name|ind
index|[
name|j
index|]
operator|=
name|ind
index|[
name|j
index|]
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
elseif|else
if|if
condition|(
name|ind
index|[
name|j
index|]
operator|>=
literal|'a'
operator|&&
name|ind
index|[
name|j
index|]
operator|<=
literal|'f'
condition|)
name|ind
index|[
name|j
index|]
operator|=
name|ind
index|[
name|j
index|]
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
else|else
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
operator|(
name|ind
index|[
literal|0
index|]
operator|<<
literal|4
operator|)
operator|+
name|ind
index|[
literal|1
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"%20s    %3d\n"
argument_list|,
name|colors
index|[
name|i
index|]
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ind
operator|+=
literal|2
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|do_identify (void)
name|do_identify
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|int
name|status
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|raw_device
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Printer identification requires using a raw device.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|raw_device
argument_list|,
name|O_RDWR
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open %s read/write: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|bufpos
operator|=
literal|0
expr_stmt|;
name|sprintf
argument_list|(
name|printer_cmd
argument_list|,
literal|"\033\001@EJL ID\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|printer_cmd
argument_list|,
name|strlen
argument_list|(
name|printer_cmd
argument_list|)
argument_list|)
operator|<
name|strlen
argument_list|(
name|printer_cmd
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot write to %s: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|status
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
literal|1023
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot read from %s: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|do_head_clean (void)
name|do_head_clean
parameter_list|(
name|void
parameter_list|)
block|{
name|do_remote_cmd
argument_list|(
literal|"CH"
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Cleaning heads...\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|do_print_cmd
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|do_nozzle_check (void)
name|do_nozzle_check
parameter_list|(
name|void
parameter_list|)
block|{
name|do_remote_cmd
argument_list|(
literal|"VI"
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|do_remote_cmd
argument_list|(
literal|"NC"
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Running nozzle check, please ensure paper is in the printer.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|do_print_cmd
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
DECL|variable|new_align_help
name|char
name|new_align_help
index|[]
init|=
literal|"\ Please read these instructions very carefully before proceeding.\n\ \n\ This utility lets you align the print head of your Epson Stylus inkjet\n\ printer.  Misuse of this utility may cause your print quality to degrade\n\ and possibly damage your printer.  This utility has not been reviewed by\n\ Seiko Epson for correctness, and is offered with no warranty at all.  The\n\ entire risk of using this utility lies with you.\n\ \n\ This utility prints %d test patterns.  Each pattern looks very similar.\n\ The patterns consist of a series of pairs of vertical lines that overlap.\n\ Below each pair of lines is a number between %d and %d.\n\ \n\ When you inspect the pairs of lines, you should find the pair of lines that\n\ is best in alignment, that is, that best forms a single vertical line.\n\ Inspect the pairs very carefully to find the best match.  Using a loupe\n\ or magnifying glass is recommended for the most critical inspection.\n\ It is also suggested that you use a good quality paper for the test,\n\ so that the lines are well-formed and do not spread through the paper.\n\ After picking the number matching the best pair, place the paper back in\n\ the paper input tray before typing it in.\n\ \n\ Each pattern is similar, but later patterns use finer dots for more\n\ critical alignment.  You must run all of the passes to correctly align your\n\ printer.  After running all the alignment passes, the alignment\n\ patterns will be printed once more.  You should find that the middle-most\n\ pair (#%d out of the %d) is the best for all patterns.\n\ \n\ After the passes are printed once more, you will be offered the\n\ choices of (s)aving the result in the printer, (r)epeating the process,\n\ or (q)uitting without saving.  Quitting will not restore the previous\n\ settings, but powering the printer off and back on will.  If you quit,\n\ you must repeat the entire process if you wish to later save the results.\n\ It is essential that you not turn your printer off during this procedure.\n\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|old_align_help
name|char
name|old_align_help
index|[]
init|=
literal|"\ Please read these instructions very carefully before proceeding.\n\ \n\ This utility lets you align the print head of your Epson Stylus inkjet\n\ printer.  Misuse of this utility may cause your print quality to degrade\n\ and possibly damage your printer.  This utility has not been reviewed by\n\ Seiko Epson for correctness, and is offered with no warranty at all.  The\n\ entire risk of using this utility lies with you.\n\ \n\ This utility prints a test pattern that consist of a series of pairs of\n\ vertical lines that overlap.  Below each pair of lines is a number between\n\ %d and %d.\n\ \n\ When you inspect the pairs of lines, you should find the pair of lines that\n\ is best in alignment, that is, that best forms a single vertical align.\n\ Inspect the pairs very carefully to find the best match.  Using a loupe\n\ or magnifying glass is recommended for the most critical inspection.\n\ It is also suggested that you use a good quality paper for the test,\n\ so that the lines are well-formed and do not spread through the paper.\n\ After picking the number matching the best pair, place the paper back in\n\ the paper input tray before typing it in.\n\ \n\ After running the alignment pattern, it will be printed once more.  You\n\ should find that the middle-most pair (#%d out of the %d) is the best.\n\ You will then be offered the choices of (s)aving the result in the printer,\n\ (r)epeating the process, or (q)uitting without saving.  Quitting will not\n\ restore the previous settings, but powering the printer off and back on will.\n\ If you quit, you must repeat the entire process if you wish to later save\n\ the results.  It is essential that you not turn off your printer during\n\ this procedure.\n\n"
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|do_align_help (int passes,int choices)
name|do_align_help
parameter_list|(
name|int
name|passes
parameter_list|,
name|int
name|choices
parameter_list|)
block|{
if|if
condition|(
name|passes
operator|>
literal|1
condition|)
name|printf
argument_list|(
name|new_align_help
argument_list|,
name|passes
argument_list|,
literal|1
argument_list|,
name|choices
argument_list|,
operator|(
name|choices
operator|+
literal|1
operator|)
operator|/
literal|2
argument_list|,
name|choices
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
name|old_align_help
argument_list|,
literal|1
argument_list|,
name|choices
argument_list|,
operator|(
name|choices
operator|+
literal|1
operator|)
operator|/
literal|2
argument_list|,
name|choices
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|align_error (void)
name|align_error
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Unable to send command to the printer, exiting.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This is the thorny one.  */
end_comment

begin_function
name|void
DECL|function|do_align (void)
name|do_align
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|inbuf
index|[
literal|64
index|]
decl_stmt|;
name|long
name|answer
decl_stmt|;
name|char
modifier|*
name|endptr
decl_stmt|;
name|int
name|passes
init|=
literal|0
decl_stmt|;
name|int
name|choices
init|=
literal|0
decl_stmt|;
name|int
name|curpass
decl_stmt|;
name|int
name|notfound
init|=
literal|1
decl_stmt|;
name|printer_t
modifier|*
name|printer
init|=
operator|&
name|printer_list
index|[
literal|0
index|]
decl_stmt|;
name|char
modifier|*
name|printer_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|printer_model
condition|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|int
name|status
decl_stmt|;
name|char
modifier|*
name|pos
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|spos
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|raw_device
condition|)
block|{
name|printf
argument_list|(
literal|"Printer alignment must be done with a raw device or else\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"the -m option must be used to specify a printer.\n"
argument_list|)
expr_stmt|;
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Attempting to detect printer model..."
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|raw_device
argument_list|,
name|O_RDWR
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nCannot open %s read/write: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|bufpos
operator|=
literal|0
expr_stmt|;
name|sprintf
argument_list|(
name|printer_cmd
argument_list|,
literal|"\033\001@EJL ID\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|printer_cmd
argument_list|,
name|strlen
argument_list|(
name|printer_cmd
argument_list|)
argument_list|)
operator|<
name|strlen
argument_list|(
name|printer_cmd
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nCannot write to %s: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|status
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
literal|1023
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nCannot read from %s: %s\n"
argument_list|,
name|raw_device
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
operator|(
name|int
operator|)
literal|';'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|pos
operator|=
name|strchr
argument_list|(
name|pos
operator|+
literal|1
argument_list|,
operator|(
name|int
operator|)
literal|';'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|pos
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
operator|(
name|int
operator|)
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|spos
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
operator|(
name|int
operator|)
literal|';'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nCannot detect printer type.  Please use -m to specify your printer model.\n"
argument_list|)
expr_stmt|;
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|spos
condition|)
operator|*
name|spos
operator|=
literal|'\000'
expr_stmt|;
name|printer_model
operator|=
name|pos
operator|+
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n\n"
argument_list|,
name|printer_model
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|printer
operator|->
name|short_name
operator|&&
name|notfound
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|printer_model
argument_list|,
name|printer
operator|->
name|short_name
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|printer_model
argument_list|,
name|printer
operator|->
name|long_name
argument_list|)
condition|)
block|{
name|passes
operator|=
name|printer
operator|->
name|passes
expr_stmt|;
name|choices
operator|=
name|printer
operator|->
name|choices
expr_stmt|;
name|printer_name
operator|=
name|printer
operator|->
name|long_name
expr_stmt|;
name|notfound
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|printer
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|notfound
condition|)
block|{
name|printf
argument_list|(
literal|"Printer model %s is not known.\n"
argument_list|,
name|printer_model
argument_list|)
expr_stmt|;
name|do_help
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|start
label|:
name|do_align_help
argument_list|(
name|passes
argument_list|,
name|choices
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"This procedure assumes that your printer is an Epson %s.\n"
argument_list|,
name|printer_name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"If this is not your printer model, please type control-C now and\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"choose your actual printer model.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Please place a sheet of paper in your printer to begin the head\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"alignment procedure.\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|inbuf
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|inbuf
argument_list|,
literal|63
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|initialize_print_cmd
argument_list|()
expr_stmt|;
for|for
control|(
name|curpass
operator|=
literal|1
init|;
name|curpass
operator|<=
name|passes
condition|;
name|curpass
operator|++
control|)
block|{
name|top
label|:
name|add_newlines
argument_list|(
literal|7
operator|*
operator|(
name|curpass
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|do_remote_cmd
argument_list|(
literal|"DT"
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|curpass
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_print_cmd
argument_list|()
condition|)
name|align_error
argument_list|()
expr_stmt|;
name|reread
label|:
name|printf
argument_list|(
literal|"Please inspect the print, and choose the best pair of lines\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|curpass
operator|==
name|passes
condition|)
name|printf
argument_list|(
literal|"in pattern #%d, and then insert a fresh page in the input tray.\n"
argument_list|,
name|curpass
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"in pattern #%d, and then reinsert the page in the input tray.\n"
argument_list|,
name|curpass
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Type a pair number, '?' for help, or 'r' to retry this pattern. ==> "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|inbuf
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|inbuf
argument_list|,
literal|63
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|inbuf
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'r'
case|:
case|case
literal|'R'
case|:
name|printf
argument_list|(
literal|"Please insert a fresh sheet of paper, and then type the enter key.\n"
argument_list|)
expr_stmt|;
name|initialize_print_cmd
argument_list|()
expr_stmt|;
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|inbuf
argument_list|,
literal|15
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
case|case
literal|'h'
case|:
case|case
literal|'?'
case|:
name|do_align_help
argument_list|(
name|passes
argument_list|,
name|choices
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
case|case
literal|'\n'
case|:
case|case
literal|'\000'
case|:
goto|goto
name|reread
goto|;
default|default:
break|break;
block|}
name|answer
operator|=
name|strtol
argument_list|(
name|inbuf
argument_list|,
operator|&
name|endptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|endptr
operator|==
name|inbuf
condition|)
block|{
name|printf
argument_list|(
literal|"I cannot understand what you typed!\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
goto|goto
name|reread
goto|;
block|}
if|if
condition|(
name|answer
operator|<
literal|1
operator|||
name|answer
operator|>
name|choices
condition|)
block|{
name|printf
argument_list|(
literal|"The best pair of lines should be numbered between 1 and %d.\n"
argument_list|,
name|choices
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
goto|goto
name|reread
goto|;
block|}
if|if
condition|(
name|curpass
operator|==
name|passes
condition|)
block|{
name|printf
argument_list|(
literal|"Aligning phase %d, and performing final test.\n"
argument_list|,
name|curpass
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Please insert a fresh sheet of paper.\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"Aligning phase %d, and starting phase %d.\n"
argument_list|,
name|curpass
argument_list|,
name|curpass
operator|+
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|initialize_print_cmd
argument_list|()
expr_stmt|;
name|do_remote_cmd
argument_list|(
literal|"DA"
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
name|curpass
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|answer
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|curpass
operator|=
literal|0
init|;
name|curpass
operator|<
name|passes
condition|;
name|curpass
operator|++
control|)
name|do_remote_cmd
argument_list|(
literal|"DT"
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|curpass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_print_cmd
argument_list|()
condition|)
name|align_error
argument_list|()
expr_stmt|;
name|read_final
label|:
name|printf
argument_list|(
literal|"Please inspect the final output very carefully to ensure that your\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"printer is in proper alignment.  You may now (s)ave the results in\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"the printer, (q)uit without saving the results, or (r)epeat the entire\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"process from the beginning.  You will then be asked to confirm your choice\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"What do you want to do (s, q, r)? "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|inbuf
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|inbuf
argument_list|,
literal|15
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|inbuf
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'q'
case|:
case|case
literal|'Q'
case|:
name|printf
argument_list|(
literal|"Please confirm by typing 'q' again that you wish to quit without saving: "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|inbuf
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|inbuf
argument_list|,
literal|15
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
if|if
condition|(
name|inbuf
index|[
literal|0
index|]
operator|==
literal|'q'
operator|||
name|inbuf
index|[
literal|0
index|]
operator|==
literal|'Q'
condition|)
block|{
name|printf
argument_list|(
literal|"OK, your printer is aligned, but the alignment has not been saved.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"If you wish to save the alignment, you must repeat this process.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'r'
case|:
case|case
literal|'R'
case|:
name|printf
argument_list|(
literal|"Please confirm by typing 'r' again that you wish to repeat the\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"alignment process: "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|inbuf
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|inbuf
argument_list|,
literal|15
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
if|if
condition|(
name|inbuf
index|[
literal|0
index|]
operator|==
literal|'r'
operator|||
name|inbuf
index|[
literal|0
index|]
operator|==
literal|'R'
condition|)
block|{
name|printf
argument_list|(
literal|"Repeating the alignment process.\n"
argument_list|)
expr_stmt|;
goto|goto
name|start
goto|;
block|}
break|break;
case|case
literal|'s'
case|:
case|case
literal|'S'
case|:
name|printf
argument_list|(
literal|"Please confirm by typing 's' again that you wish to save the settings\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"to your printer.  This will permanently alter the configuration of\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"your printer.  WARNING: this procedure has not been approved by\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Seiko Epson, and it may damage your printer.  Proceed? "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|inbuf
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|inbuf
argument_list|,
literal|15
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
if|if
condition|(
name|inbuf
index|[
literal|0
index|]
operator|==
literal|'s'
operator|||
name|inbuf
index|[
literal|0
index|]
operator|==
literal|'S'
condition|)
block|{
name|printf
argument_list|(
literal|"Please insert your alignment test page in the printer once more\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"for the final save of your alignment settings.  When the printer\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"feeds the page through, your settings have been saved.\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|initialize_print_cmd
argument_list|()
expr_stmt|;
name|add_newlines
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|do_remote_cmd
argument_list|(
literal|"SV"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|add_newlines
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_print_cmd
argument_list|()
condition|)
name|align_error
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"Unrecognized command.\n"
argument_list|)
expr_stmt|;
goto|goto
name|read_final
goto|;
block|}
name|printf
argument_list|(
literal|"Final command was not confirmed.\n"
argument_list|)
expr_stmt|;
goto|goto
name|read_final
goto|;
block|}
end_function

end_unit

