begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * "$Id$"  *  *   Print plug-in HP PCL driver for the GIMP.  *  *   Copyright 1997-1999 Michael Sweet (mike@easysw.com) and  *	Robert Krawitz (rlk@alum.mit.edu)  *  *   This program is free software; you can redistribute it and/or modify it  *   under the terms of the GNU General Public License as published by the Free  *   Software Foundation; either version 2 of the License, or (at your option)  *   any later version.  *  *   This program is distributed in the hope that it will be useful, but  *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY  *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License  *   for more details.  *  *   You should have received a copy of the GNU General Public License  *   along with this program; if not, write to the Free Software  *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  *  * Contents:  *  *   pcl_parameters()     - Return the parameter values for the given  *                          parameter.  *   pcl_imageable_area() - Return the imageable area of the page.  *   pcl_print()          - Print an image to an HP printer.  *   pcl_mode0()          - Send PCL graphics using mode 0 (no) compression.  *   pcl_mode2()          - Send PCL graphics using mode 2 (TIFF) compression.  *  * Revision History:  *  *   $Log$  *   Revision 1.12  1999/12/16 19:44:01  olofk  *   Thu Dec 16 20:15:25 CET 1999  Olof S Kylande<olof@gimp.org>  *  *           Fix of KDE/Kwm  selection add/sub/inter problem  *           NOTE: This is a workaround, not a real fix.  *           Many Thanks to Matthias Ettrich  *  *           * app/disp_callbacks.c  *  *           Updated unsharp-mask to version 0.10  *  *           * plug-ins/unsharp/dialog_f.c  *           * plug-ins/unsharp/dialog_f.h  *           * plug-ins/unsharp/dialog_i.c  *           * plug-ins/unsharp/dialog_i.h  *           * plug-ins/unsharp/unsharp.c  *  *           Updated print plug-in to version 3.0.1  *  *           * plug-ins/print/README (new file)  *           * plug-ins/print/print-escp2.c  *           * plug-ins/print/print-pcl.c  *           * plug-ins/print/print-ps.c  *           * plug-ins/print/print-util.c  *           * plug-ins/print/print.c  *           * plug-ins/print/print.h  *  *           Updated all files in the help/C/dialogs dir. This is  *           a first alpha glimpse of the help system. Please give  *           me feedback of the content. However since it's in alpha  *           stage it means that there is spell, grammatical, etc errors.  *           There is may also be pure errors which I hope "you" will  *           report to either olof@gimp.org or karin@gimp.org. Please  *           don't report spell, grammatical, etc error at this stage in dev.  *  *           If you have any plans to commit to the help system please write  *           to olof@gimp.org. (This is mandatory not a please ;-).  *  *           * help/C/welcome.html  *           * help/C/dialogs/about.html ..............  *  *   Revision 1.13  1999/11/23 02:11:37  rlk  *   Rationalize variables, pass 3  *  *   Revision 1.12  1999/11/23 01:45:00  rlk  *   Rationalize variables -- pass 2  *  *   Revision 1.11  1999/11/10 01:13:44  rlk  *   multi-pass  *  *   Revision 1.10  1999/10/26 23:36:51  rlk  *   Comment out all remaining 16-bit code, and rename 16-bit functions to "standard" names  *  *   Revision 1.9  1999/10/26 02:10:30  rlk  *   Mostly fix save/load  *  *   Move all gimp, glib, gtk stuff into print.c (take it out of everything else).  *   This should help port it to more general purposes later.  *  *   Revision 1.8  1999/10/25 23:31:59  rlk  *   16-bit clean  *  *   Revision 1.7  1999/10/21 01:27:37  rlk  *   More progress toward full 16-bit rendering  *  *   Revision 1.6  1999/10/19 02:04:59  rlk  *   Merge all of the single-level print_cmyk functions  *  *   Revision 1.5  1999/10/17 23:44:07  rlk  *   16-bit everything (untested)  *  *   Revision 1.4  1999/10/17 23:01:01  rlk  *   Move various dither functions into print-utils.c  *  *   Revision 1.3  1999/10/14 01:59:59  rlk  *   Saturation  *  *   Revision 1.2  1999/09/12 00:12:24  rlk  *   Current best stuff  *  *   Revision 1.11  1999/05/29 16:35:27  yosh  *   * configure.in  *   * Makefile.am: removed tips files, AC_SUBST GIMP_PLUGINS and  *   GIMP_MODULES so you can easily skip those parts of the build  *  *   * acinclude.m4  *   * config.sub  *   * config.guess  *   * ltconfig  *   * ltmain.sh: libtool 1.3.2  *  *   * app/fileops.c: shuffle #includes to avoid warning about MIN and  *   MAX  *  *   [ The following is a big i18n patch from David Monniaux  *<david.monniaux@ens.fr> ]  *  *   * tips/gimp_conseils.fr.txt  *   * tips/gimp_tips.txt  *   * tips/Makefile.am  *   * configure.in: moved tips to separate dir  *  *   * po-plugins: new dir for plug-in translation files  *  *   * configure.in: add po-plugins dir and POTFILES processing  *  *   * app/boundary.c  *   * app/brightness_contrast.c  *   * app/by_color_select.c  *   * app/color_balance.c  *   * app/convert.c  *   * app/curves.c  *   * app/free_select.c  *   * app/gdisplay.c  *   * app/gimpimage.c  *   * app/gimpunit.c  *   * app/gradient.c  *   * app/gradient_select.c  *   * app/install.c  *   * app/session.c: various i18n tweaks  *  *   * app/tips_dialog.c: localize tips filename  *  *   * libgimp/gimpunit.c  *   * libgimp/gimpunitmenu.c: #include "config.h"  *  *   * plug-ins/CEL  *   * plug-ins/CML_explorer  *   * plug-ins/Lighting  *   * plug-ins/apply_lens  *   * plug-ins/autostretch_hsv  *   * plug-ins/blur  *   * plug-ins/bmp  *   * plug-ins/borderaverage  *   * plug-ins/bumpmap  *   * plug-ins/bz2  *   * plug-ins/checkerboard  *   * plug-ins/colorify  *   * plug-ins/compose  *   * plug-ins/convmatrix  *   * plug-ins/cubism  *   * plug-ins/depthmerge  *   * plug-ins/destripe  *   * plug-ins/gif  *   * plug-ins/gifload  *   * plug-ins/jpeg  *   * plug-ins/mail  *   * plug-ins/oilify  *   * plug-ins/png  *   * plug-ins/print  *   * plug-ins/ps  *   * plug-ins/xbm  *   * plug-ins/xpm  *   * plug-ins/xwd: plug-in i18n stuff  *  *   -Yosh  *  *   Revision 1.10  1998/08/28 23:01:45  yosh  *   * acconfig.h  *   * configure.in  *   * app/main.c: added check for putenv and #ifdefed it's usage since NeXTStep is  *   lame  *  *   * libgimp/gimp.c  *   * app/main.c  *   * app/plug_in.c: conditionally compile shared mem stuff so platforms without  *   it can still work  *  *   * plug-ins/CEL/CEL.c  *   * plug-ins/palette/palette.c  *   * plug-ins/print/print-escp2.c  *   * plug-ins/print/print-pcl.c  *   * plug-ins/print/print-ps.c: s/strdup/g_strdup/ for portability  *  *   -Yosh  *  *   Revision 1.9  1998/05/17 07:16:46  yosh  *   0.99.31 fun  *  *   updated print plugin  *  *   -Yosh  *  *   Revision 1.12  1998/05/16  18:27:59  mike  *   Added support for 4-level "CRet" mode of 800/1100 series printers.  *  *   Revision 1.11  1998/05/15  21:01:51  mike  *   Updated image positioning code (invert top and center left/top independently)  *  *   Revision 1.10  1998/05/08  21:22:00  mike  *   Added quality mode command for DeskJet printers (high quality for 300  *   DPI or higher).  *  *   Revision 1.9  1998/05/08  19:20:50  mike  *   Updated to support media size, imageable area, and parameter functions.  *   Added support for scaling modes - scale by percent or scale by PPI.  *  *   Revision 1.8  1998/01/21  21:33:47  mike  *   Updated copyright.  *  *   Revision 1.7  1997/11/12  15:57:48  mike  *   Minor changes for clean compiles under Digital UNIX.  *  *   Revision 1.7  1997/11/12  15:57:48  mike  *   Minor changes for clean compiles under Digital UNIX.  *  *   Revision 1.6  1997/10/02  17:57:26  mike  *   Updated positioning code to use "decipoint" commands.  *  *   Revision 1.5  1997/07/30  20:33:05  mike  *   Final changes for 1.1 release.  *  *   Revision 1.4  1997/07/30  18:47:39  mike  *   Added scaling, orientation, and offset options.  *  *   Revision 1.3  1997/07/03  13:24:12  mike  *   Updated documentation for 1.0 release.  *  *   Revision 1.2  1997/07/02  18:48:14  mike  *   Added mode 2 compression code.  *   Fixed bug in pcl_mode0 and pcl_mode2 - wasn't sending 'V' or 'W' at  *   the right times.  *  *   Revision 1.2  1997/07/02  18:48:14  mike  *   Added mode 2 compression code.  *   Fixed bug in pcl_mode0 and pcl_mode2 - wasn't sending 'V' or 'W' at  *   the right times.  *  *   Revision 1.1  1997/07/02  13:51:53  mike  *   Initial revision  */
end_comment

begin_include
include|#
directive|include
file|"print.h"
end_include

begin_comment
comment|/*  * Local functions...  */
end_comment

begin_function_decl
specifier|static
name|void
name|pcl_mode0
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcl_mode2
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|error
index|[
literal|2
index|]
index|[
literal|4
index|]
index|[
literal|14
operator|*
literal|720
operator|+
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * 'pcl_parameters()' - Return the parameter values for the given parameter.  */
end_comment

begin_function
name|char
modifier|*
modifier|*
comment|/* O - Parameter values */
DECL|function|pcl_parameters (int model,char * ppd_file,char * name,int * count)
name|pcl_parameters
parameter_list|(
name|int
name|model
parameter_list|,
comment|/* I - Printer model */
name|char
modifier|*
name|ppd_file
parameter_list|,
comment|/* I - PPD file (not used) */
name|char
modifier|*
name|name
parameter_list|,
comment|/* I - Name of parameter */
name|int
modifier|*
name|count
parameter_list|)
comment|/* O - Number of values */
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
modifier|*
name|p
decl_stmt|,
modifier|*
modifier|*
name|valptrs
decl_stmt|;
specifier|static
name|char
modifier|*
name|media_sizes
index|[]
init|=
block|{
operator|(
literal|"Letter"
operator|)
block|,
operator|(
literal|"Legal"
operator|)
block|,
operator|(
literal|"A4"
operator|)
block|,
operator|(
literal|"Tabloid"
operator|)
block|,
operator|(
literal|"A3"
operator|)
block|,
operator|(
literal|"12x18"
operator|)
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|media_types
index|[]
init|=
block|{
operator|(
literal|"Plain"
operator|)
block|,
operator|(
literal|"Premium"
operator|)
block|,
operator|(
literal|"Glossy"
operator|)
block|,
operator|(
literal|"Transparency"
operator|)
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|media_sources
index|[]
init|=
block|{
operator|(
literal|"Manual"
operator|)
block|,
operator|(
literal|"Tray 1"
operator|)
block|,
operator|(
literal|"Tray 2"
operator|)
block|,
operator|(
literal|"Tray 3"
operator|)
block|,
operator|(
literal|"Tray 4"
operator|)
block|, 		}
decl_stmt|;
specifier|static
name|char
modifier|*
name|resolutions
index|[]
init|=
block|{
operator|(
literal|"150 DPI"
operator|)
block|,
operator|(
literal|"300 DPI"
operator|)
block|,
operator|(
literal|"600 DPI"
operator|)
block|}
decl_stmt|;
if|if
condition|(
name|count
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"PageSize"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|model
operator|==
literal|5
operator|||
name|model
operator|==
literal|1100
condition|)
operator|*
name|count
operator|=
literal|6
expr_stmt|;
else|else
operator|*
name|count
operator|=
literal|3
expr_stmt|;
name|p
operator|=
name|media_sizes
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"MediaType"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|model
operator|<
literal|500
condition|)
block|{
operator|*
name|count
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
else|else
block|{
operator|*
name|count
operator|=
literal|4
expr_stmt|;
name|p
operator|=
name|media_types
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"InputSlot"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|model
operator|<
literal|500
condition|)
block|{
operator|*
name|count
operator|=
literal|5
expr_stmt|;
name|p
operator|=
name|media_sources
expr_stmt|;
block|}
else|else
block|{
operator|*
name|count
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Resolution"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|model
operator|==
literal|4
operator|||
name|model
operator|==
literal|5
operator|||
name|model
operator|==
literal|800
operator|||
name|model
operator|==
literal|600
condition|)
operator|*
name|count
operator|=
literal|3
expr_stmt|;
else|else
operator|*
name|count
operator|=
literal|2
expr_stmt|;
name|p
operator|=
name|resolutions
expr_stmt|;
block|}
else|else
return|return
operator|(
name|NULL
operator|)
return|;
name|valptrs
operator|=
name|malloc
argument_list|(
operator|*
name|count
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|count
condition|;
name|i
operator|++
control|)
block|{
comment|/* strdup doesn't appear to be POSIX... */
name|valptrs
index|[
name|i
index|]
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|p
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|valptrs
index|[
name|i
index|]
argument_list|,
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|valptrs
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * 'pcl_imageable_area()' - Return the imageable area of the page.  */
end_comment

begin_function
name|void
DECL|function|pcl_imageable_area (int model,char * ppd_file,char * media_size,int * left,int * right,int * bottom,int * top)
name|pcl_imageable_area
parameter_list|(
name|int
name|model
parameter_list|,
comment|/* I - Printer model */
name|char
modifier|*
name|ppd_file
parameter_list|,
comment|/* I - PPD file (not used) */
name|char
modifier|*
name|media_size
parameter_list|,
comment|/* I - Media size */
name|int
modifier|*
name|left
parameter_list|,
comment|/* O - Left position in points */
name|int
modifier|*
name|right
parameter_list|,
comment|/* O - Right position in points */
name|int
modifier|*
name|bottom
parameter_list|,
comment|/* O - Bottom position in points */
name|int
modifier|*
name|top
parameter_list|)
comment|/* O - Top position in points */
block|{
name|int
name|width
decl_stmt|,
name|length
decl_stmt|;
comment|/* Size of page */
name|default_media_size
argument_list|(
name|model
argument_list|,
name|ppd_file
argument_list|,
name|media_size
argument_list|,
operator|&
name|width
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|model
condition|)
block|{
default|default :
operator|*
name|left
operator|=
literal|18
expr_stmt|;
operator|*
name|right
operator|=
name|width
operator|-
literal|18
expr_stmt|;
operator|*
name|top
operator|=
name|length
operator|-
literal|12
expr_stmt|;
operator|*
name|bottom
operator|=
literal|12
expr_stmt|;
break|break;
case|case
literal|500
case|:
operator|*
name|left
operator|=
literal|18
expr_stmt|;
operator|*
name|right
operator|=
name|width
operator|-
literal|18
expr_stmt|;
operator|*
name|top
operator|=
name|length
operator|-
literal|7
expr_stmt|;
operator|*
name|bottom
operator|=
literal|41
expr_stmt|;
break|break;
case|case
literal|501
case|:
operator|*
name|left
operator|=
literal|18
expr_stmt|;
operator|*
name|right
operator|=
name|width
operator|-
literal|18
expr_stmt|;
operator|*
name|top
operator|=
name|length
operator|-
literal|7
expr_stmt|;
operator|*
name|bottom
operator|=
literal|33
expr_stmt|;
break|break;
case|case
literal|550
case|:
case|case
literal|800
case|:
case|case
literal|1100
case|:
operator|*
name|left
operator|=
literal|18
expr_stmt|;
operator|*
name|right
operator|=
name|width
operator|-
literal|18
expr_stmt|;
operator|*
name|top
operator|=
name|length
operator|-
literal|3
expr_stmt|;
operator|*
name|bottom
operator|=
literal|33
expr_stmt|;
break|break;
case|case
literal|600
case|:
operator|*
name|left
operator|=
literal|18
expr_stmt|;
operator|*
name|right
operator|=
name|width
operator|-
literal|18
expr_stmt|;
operator|*
name|top
operator|=
name|length
operator|-
literal|0
expr_stmt|;
operator|*
name|bottom
operator|=
literal|33
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * 'pcl_print()' - Print an image to an HP printer.  */
end_comment

begin_function
name|void
DECL|function|pcl_print (int model,int copies,FILE * prn,Image image,unsigned char * cmap,lut_t * lut,vars_t * v)
name|pcl_print
parameter_list|(
name|int
name|model
parameter_list|,
comment|/* I - Model */
name|int
name|copies
parameter_list|,
comment|/* I - Number of copies */
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - File to print to */
name|Image
name|image
parameter_list|,
comment|/* I - Image to print */
name|unsigned
name|char
modifier|*
name|cmap
parameter_list|,
comment|/* I - Colormap (for indexed images) */
name|lut_t
modifier|*
name|lut
parameter_list|,
comment|/* I - Brightness lookup table */
name|vars_t
modifier|*
name|v
parameter_list|)
block|{
name|char
modifier|*
name|ppd_file
init|=
name|v
operator|->
name|ppd_file
decl_stmt|;
name|char
modifier|*
name|resolution
init|=
name|v
operator|->
name|resolution
decl_stmt|;
name|char
modifier|*
name|media_size
init|=
name|v
operator|->
name|media_size
decl_stmt|;
name|char
modifier|*
name|media_type
init|=
name|v
operator|->
name|media_type
decl_stmt|;
name|int
name|output_type
init|=
name|v
operator|->
name|output_type
decl_stmt|;
name|int
name|orientation
init|=
name|v
operator|->
name|orientation
decl_stmt|;
name|float
name|scaling
init|=
name|v
operator|->
name|scaling
decl_stmt|;
name|int
name|top
init|=
name|v
operator|->
name|top
decl_stmt|;
name|int
name|left
init|=
name|v
operator|->
name|left
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
comment|/* Looping vars */
name|int
name|xdpi
decl_stmt|,
name|ydpi
decl_stmt|;
comment|/* Resolution */
name|unsigned
name|short
modifier|*
name|out
decl_stmt|;
name|unsigned
name|char
modifier|*
name|in
decl_stmt|,
comment|/* Input pixels */
modifier|*
name|black
decl_stmt|,
comment|/* Black bitmap data */
modifier|*
name|cyan
decl_stmt|,
comment|/* Cyan bitmap data */
modifier|*
name|magenta
decl_stmt|,
comment|/* Magenta bitmap data */
modifier|*
name|yellow
decl_stmt|;
comment|/* Yellow bitmap data */
name|int
name|page_left
decl_stmt|,
comment|/* Left margin of page */
name|page_right
decl_stmt|,
comment|/* Right margin of page */
name|page_top
decl_stmt|,
comment|/* Top of page */
name|page_bottom
decl_stmt|,
comment|/* Bottom of page */
name|page_width
decl_stmt|,
comment|/* Width of page */
name|page_height
decl_stmt|,
comment|/* Height of page */
name|out_width
decl_stmt|,
comment|/* Width of image on page */
name|out_height
decl_stmt|,
comment|/* Height of image on page */
name|out_bpp
decl_stmt|,
comment|/* Output bytes per pixel */
name|temp_width
decl_stmt|,
comment|/* Temporary width of image on page */
name|temp_height
decl_stmt|,
comment|/* Temporary height of image on page */
name|landscape
decl_stmt|,
comment|/* True if we rotate the output 90 degrees */
name|length
decl_stmt|,
comment|/* Length of raster data */
name|errdiv
decl_stmt|,
comment|/* Error dividend */
name|errmod
decl_stmt|,
comment|/* Error modulus */
name|errval
decl_stmt|,
comment|/* Current error value */
name|errline
decl_stmt|,
comment|/* Current raster line */
name|errlast
decl_stmt|;
comment|/* Last raster line loaded */
name|convert_t
name|colorfunc
decl_stmt|;
comment|/* Color conversion function... */
name|void
function_decl|(
modifier|*
name|writefunc
function_decl|)
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
comment|/* PCL output function */
name|int
name|image_height
decl_stmt|,
name|image_width
decl_stmt|,
name|image_bpp
decl_stmt|;
comment|/*   * Setup a read-only pixel region for the entire image...   */
name|Image_init
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_height
operator|=
name|Image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_width
operator|=
name|Image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|image_bpp
operator|=
name|Image_bpp
argument_list|(
name|image
argument_list|)
expr_stmt|;
comment|/*   * Choose the correct color conversion function...   */
if|if
condition|(
operator|(
name|image_bpp
operator|<
literal|3
operator|&&
name|cmap
operator|==
name|NULL
operator|)
operator|||
name|model
operator|<=
literal|500
condition|)
name|output_type
operator|=
name|OUTPUT_GRAY
expr_stmt|;
comment|/* Force grayscale output */
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_COLOR
condition|)
block|{
name|out_bpp
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|image_bpp
operator|>=
literal|3
condition|)
name|colorfunc
operator|=
name|rgb_to_rgb
expr_stmt|;
else|else
name|colorfunc
operator|=
name|indexed_to_rgb
expr_stmt|;
block|}
else|else
block|{
name|out_bpp
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|image_bpp
operator|>=
literal|3
condition|)
name|colorfunc
operator|=
name|rgb_to_gray
expr_stmt|;
elseif|else
if|if
condition|(
name|cmap
operator|==
name|NULL
condition|)
name|colorfunc
operator|=
name|gray_to_gray
expr_stmt|;
else|else
name|colorfunc
operator|=
name|indexed_to_gray
expr_stmt|;
block|}
comment|/*   * Figure out the output resolution...   */
name|xdpi
operator|=
name|atoi
argument_list|(
name|resolution
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|model
operator|==
literal|800
operator|||
name|model
operator|==
literal|1100
operator|)
operator|&&
name|output_type
operator|==
name|OUTPUT_COLOR
operator|&&
name|xdpi
operator|==
literal|600
condition|)
name|xdpi
operator|=
literal|300
expr_stmt|;
if|if
condition|(
name|model
operator|==
literal|600
operator|&&
name|xdpi
operator|==
literal|600
condition|)
name|ydpi
operator|=
literal|300
expr_stmt|;
else|else
name|ydpi
operator|=
name|xdpi
expr_stmt|;
comment|/*   * Compute the output size...   */
name|landscape
operator|=
literal|0
expr_stmt|;
name|pcl_imageable_area
argument_list|(
name|model
argument_list|,
name|ppd_file
argument_list|,
name|media_size
argument_list|,
operator|&
name|page_left
argument_list|,
operator|&
name|page_right
argument_list|,
operator|&
name|page_bottom
argument_list|,
operator|&
name|page_top
argument_list|)
expr_stmt|;
name|page_width
operator|=
name|page_right
operator|-
name|page_left
expr_stmt|;
name|page_height
operator|=
name|page_top
operator|-
name|page_bottom
expr_stmt|;
comment|/*   * Portrait width/height...   */
if|if
condition|(
name|scaling
operator|<
literal|0.0
condition|)
block|{
comment|/*     * Scale to pixels per inch...     */
name|out_width
operator|=
name|image_width
operator|*
operator|-
literal|72.0
operator|/
name|scaling
expr_stmt|;
name|out_height
operator|=
name|image_height
operator|*
operator|-
literal|72.0
operator|/
name|scaling
expr_stmt|;
block|}
else|else
block|{
comment|/*     * Scale by percent...     */
name|out_width
operator|=
name|page_width
operator|*
name|scaling
operator|/
literal|100.0
expr_stmt|;
name|out_height
operator|=
name|out_width
operator|*
name|image_height
operator|/
name|image_width
expr_stmt|;
if|if
condition|(
name|out_height
operator|>
name|page_height
condition|)
block|{
name|out_height
operator|=
name|page_height
operator|*
name|scaling
operator|/
literal|100.0
expr_stmt|;
name|out_width
operator|=
name|out_height
operator|*
name|image_width
operator|/
name|image_height
expr_stmt|;
block|}
block|}
comment|/*   * Landscape width/height...   */
if|if
condition|(
name|scaling
operator|<
literal|0.0
condition|)
block|{
comment|/*     * Scale to pixels per inch...     */
name|temp_width
operator|=
name|image_height
operator|*
operator|-
literal|72.0
operator|/
name|scaling
expr_stmt|;
name|temp_height
operator|=
name|image_width
operator|*
operator|-
literal|72.0
operator|/
name|scaling
expr_stmt|;
block|}
else|else
block|{
comment|/*     * Scale by percent...     */
name|temp_width
operator|=
name|page_width
operator|*
name|scaling
operator|/
literal|100.0
expr_stmt|;
name|temp_height
operator|=
name|temp_width
operator|*
name|image_width
operator|/
name|image_height
expr_stmt|;
if|if
condition|(
name|temp_height
operator|>
name|page_height
condition|)
block|{
name|temp_height
operator|=
name|page_height
expr_stmt|;
name|temp_width
operator|=
name|temp_height
operator|*
name|image_height
operator|/
name|image_width
expr_stmt|;
block|}
block|}
comment|/*   * See which orientation has the greatest area (or if we need to rotate the   * image to fit it on the page...)   */
if|if
condition|(
name|orientation
operator|==
name|ORIENT_AUTO
condition|)
block|{
if|if
condition|(
name|scaling
operator|<
literal|0.0
condition|)
block|{
if|if
condition|(
operator|(
name|out_width
operator|>
name|page_width
operator|&&
name|out_height
operator|<
name|page_width
operator|)
operator|||
operator|(
name|out_height
operator|>
name|page_height
operator|&&
name|out_width
operator|<
name|page_height
operator|)
condition|)
name|orientation
operator|=
name|ORIENT_LANDSCAPE
expr_stmt|;
else|else
name|orientation
operator|=
name|ORIENT_PORTRAIT
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|temp_width
operator|*
name|temp_height
operator|)
operator|>
operator|(
name|out_width
operator|*
name|out_height
operator|)
condition|)
name|orientation
operator|=
name|ORIENT_LANDSCAPE
expr_stmt|;
else|else
name|orientation
operator|=
name|ORIENT_PORTRAIT
expr_stmt|;
block|}
block|}
if|if
condition|(
name|orientation
operator|==
name|ORIENT_LANDSCAPE
condition|)
block|{
name|out_width
operator|=
name|temp_width
expr_stmt|;
name|out_height
operator|=
name|temp_height
expr_stmt|;
name|landscape
operator|=
literal|1
expr_stmt|;
comment|/*     * Swap left/top offsets...     */
name|x
operator|=
name|top
expr_stmt|;
name|top
operator|=
name|left
expr_stmt|;
name|left
operator|=
name|x
expr_stmt|;
block|}
if|if
condition|(
name|left
operator|<
literal|0
condition|)
name|left
operator|=
operator|(
name|page_width
operator|-
name|out_width
operator|)
operator|/
literal|2
operator|+
name|page_left
expr_stmt|;
if|if
condition|(
name|top
operator|<
literal|0
condition|)
name|top
operator|=
operator|(
name|page_height
operator|+
name|out_height
operator|)
operator|/
literal|2
operator|+
name|page_bottom
expr_stmt|;
else|else
name|top
operator|=
name|page_height
operator|-
name|top
operator|+
name|page_bottom
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"page_width = %d, page_height = %d\n"
argument_list|,
name|page_width
argument_list|,
name|page_height
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"out_width = %d, out_height = %d\n"
argument_list|,
name|out_width
argument_list|,
name|out_height
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"xdpi = %d, ydpi = %d, landscape = %d\n"
argument_list|,
name|xdpi
argument_list|,
name|ydpi
argument_list|,
name|landscape
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
comment|/*   * Let the user know what we're doing...   */
name|Image_progress_init
argument_list|(
name|image
argument_list|)
expr_stmt|;
comment|/*   * Send PCL initialization commands...   */
name|fputs
argument_list|(
literal|"\033E"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* PCL reset */
if|if
condition|(
name|strcmp
argument_list|(
name|media_size
argument_list|,
literal|"Letter"
argument_list|)
operator|==
literal|0
condition|)
comment|/* Set media size */
block|{
name|fputs
argument_list|(
literal|"\033&l2A"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|top
operator|=
literal|792
operator|-
name|top
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_size
argument_list|,
literal|"Legal"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|"\033&l3A"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|top
operator|=
literal|1008
operator|-
name|top
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_size
argument_list|,
literal|"Tabloid"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|"\033&l6A"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|top
operator|=
literal|1214
operator|-
name|top
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_size
argument_list|,
literal|"A4"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|"\033&l26A"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|top
operator|=
literal|842
operator|-
name|top
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_size
argument_list|,
literal|"A3"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|"\033&l27A"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|top
operator|=
literal|1191
operator|-
name|top
expr_stmt|;
block|}
name|fputs
argument_list|(
literal|"\033&l0L"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Turn off perforation skip */
name|fputs
argument_list|(
literal|"\033&l0E"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Reset top margin to 0 */
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Plain"
argument_list|)
operator|==
literal|0
condition|)
comment|/* Set media type */
name|fputs
argument_list|(
literal|"\033&l0M"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Premium"
argument_list|)
operator|==
literal|0
condition|)
name|fputs
argument_list|(
literal|"\033&l2M"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Glossy"
argument_list|)
operator|==
literal|0
condition|)
name|fputs
argument_list|(
literal|"\033&l3M"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Transparency"
argument_list|)
operator|==
literal|0
condition|)
name|fputs
argument_list|(
literal|"\033&l4M"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Manual"
argument_list|)
operator|==
literal|0
condition|)
comment|/* Set media source */
name|fputs
argument_list|(
literal|"\033&l2H"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Tray 1"
argument_list|)
operator|==
literal|0
condition|)
name|fputs
argument_list|(
literal|"\033&l8H"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Tray 2"
argument_list|)
operator|==
literal|0
condition|)
name|fputs
argument_list|(
literal|"\033&l1H"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Tray 3"
argument_list|)
operator|==
literal|0
condition|)
name|fputs
argument_list|(
literal|"\033&l4H"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|media_type
argument_list|,
literal|"Tray 4"
argument_list|)
operator|==
literal|0
condition|)
name|fputs
argument_list|(
literal|"\033&l5H"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
if|if
condition|(
name|model
operator|>=
literal|500
operator|&&
name|model
operator|<
literal|1200
operator|&&
name|xdpi
operator|>=
literal|300
condition|)
name|fputs
argument_list|(
literal|"\033*r2Q"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|model
operator|==
literal|1200
operator|&&
name|xdpi
operator|>=
literal|300
condition|)
name|fputs
argument_list|(
literal|"\033*o1Q"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
if|if
condition|(
name|xdpi
operator|!=
name|ydpi
condition|)
comment|/* Set resolution */
block|{
comment|/*     * Send 26-byte configure image data command with horizontal and     * vertical resolutions as well as a color count...     */
name|fputs
argument_list|(
literal|"\033*g26W"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|2
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Format 2 */
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_COLOR
condition|)
name|putc
argument_list|(
literal|4
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # output planes */
else|else
name|putc
argument_list|(
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # output planes */
name|putc
argument_list|(
name|xdpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Black resolution */
name|putc
argument_list|(
name|xdpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|0
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|2
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # of black levels */
name|putc
argument_list|(
name|xdpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Cyan resolution */
name|putc
argument_list|(
name|xdpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|0
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|2
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # of cyan levels */
name|putc
argument_list|(
name|xdpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Magenta resolution */
name|putc
argument_list|(
name|xdpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|0
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|2
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # of magenta levels */
name|putc
argument_list|(
name|xdpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Yellow resolution */
name|putc
argument_list|(
name|xdpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|0
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|2
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # of yellow levels */
block|}
elseif|else
if|if
condition|(
name|xdpi
operator|==
literal|300
operator|&&
name|model
operator|==
literal|800
condition|)
comment|/* 300 DPI CRet */
block|{
comment|/*     * Send 26-byte configure image data command with horizontal and     * vertical resolutions as well as a color count...     */
name|fputs
argument_list|(
literal|"\033*g26W"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|2
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Format 2 */
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_COLOR
condition|)
name|putc
argument_list|(
literal|4
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # output planes */
else|else
name|putc
argument_list|(
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # output planes */
name|putc
argument_list|(
name|xdpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Black resolution */
name|putc
argument_list|(
name|xdpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|0
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|4
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # of black levels */
name|putc
argument_list|(
name|xdpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Cyan resolution */
name|putc
argument_list|(
name|xdpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|0
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|4
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # of cyan levels */
name|putc
argument_list|(
name|xdpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Magenta resolution */
name|putc
argument_list|(
name|xdpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|0
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|4
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # of magenta levels */
name|putc
argument_list|(
name|xdpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Yellow resolution */
name|putc
argument_list|(
name|xdpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
operator|>>
literal|8
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|ydpi
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|0
argument_list|,
name|prn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|4
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* # of yellow levels */
block|}
else|else
block|{
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\033*t%dR"
argument_list|,
name|xdpi
argument_list|)
expr_stmt|;
comment|/* Simple resolution */
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_COLOR
condition|)
block|{
if|if
condition|(
name|model
operator|==
literal|501
operator|||
name|model
operator|==
literal|1200
condition|)
name|fputs
argument_list|(
literal|"\033*r-3U"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Simple CMY color */
else|else
name|fputs
argument_list|(
literal|"\033*r-4U"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Simple KCMY color */
block|}
block|}
if|if
condition|(
name|model
operator|<
literal|3
operator|||
name|model
operator|==
literal|500
condition|)
name|fputs
argument_list|(
literal|"\033*b0M"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Mode 0 (no compression) */
else|else
name|fputs
argument_list|(
literal|"\033*b2M"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Mode 2 (TIFF) */
comment|/*   * Convert image size to printer resolution and setup the page for printing...   */
name|out_width
operator|=
name|xdpi
operator|*
name|out_width
operator|/
literal|72
expr_stmt|;
name|out_height
operator|=
name|ydpi
operator|*
name|out_height
operator|/
literal|72
expr_stmt|;
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\033&a%dH"
argument_list|,
literal|10
operator|*
name|left
operator|-
literal|180
argument_list|)
expr_stmt|;
comment|/* Set left raster position */
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\033&a%dV"
argument_list|,
literal|10
operator|*
name|top
argument_list|)
expr_stmt|;
comment|/* Set top raster position */
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\033*r%dS"
argument_list|,
name|out_width
argument_list|)
expr_stmt|;
comment|/* Set raster width */
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\033*r%dT"
argument_list|,
name|out_height
argument_list|)
expr_stmt|;
comment|/* Set raster height */
name|fputs
argument_list|(
literal|"\033*r1A"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Start GFX */
comment|/*   * Allocate memory for the raster data...   */
name|length
operator|=
operator|(
name|out_width
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|xdpi
operator|==
literal|300
operator|&&
name|model
operator|==
literal|800
condition|)
name|length
operator|*=
literal|2
expr_stmt|;
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
block|{
name|black
operator|=
name|malloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|cyan
operator|=
name|NULL
expr_stmt|;
name|magenta
operator|=
name|NULL
expr_stmt|;
name|yellow
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|cyan
operator|=
name|malloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|magenta
operator|=
name|malloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|yellow
operator|=
name|malloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|model
operator|!=
literal|501
operator|&&
name|model
operator|!=
literal|1200
condition|)
name|black
operator|=
name|malloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
else|else
name|black
operator|=
name|NULL
expr_stmt|;
block|}
comment|/*   * Output the page, rotating as necessary...   */
if|if
condition|(
name|model
operator|<
literal|3
operator|||
name|model
operator|==
literal|500
condition|)
name|writefunc
operator|=
name|pcl_mode0
expr_stmt|;
else|else
name|writefunc
operator|=
name|pcl_mode2
expr_stmt|;
if|if
condition|(
name|landscape
condition|)
block|{
name|in
operator|=
name|malloc
argument_list|(
name|image_height
operator|*
name|image_bpp
argument_list|)
expr_stmt|;
name|out
operator|=
name|malloc
argument_list|(
name|image_height
operator|*
name|out_bpp
operator|*
literal|2
argument_list|)
expr_stmt|;
name|errdiv
operator|=
name|image_width
operator|/
name|out_height
expr_stmt|;
name|errmod
operator|=
name|image_width
operator|%
name|out_height
expr_stmt|;
name|errval
operator|=
literal|0
expr_stmt|;
name|errlast
operator|=
operator|-
literal|1
expr_stmt|;
name|errline
operator|=
name|image_width
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|out_height
condition|;
name|x
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"pcl_print: x = %d, line = %d, val = %d, mod = %d, height = %d\n"
argument_list|,
name|x
argument_list|,
name|errline
argument_list|,
name|errval
argument_list|,
name|errmod
argument_list|,
name|out_height
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
if|if
condition|(
operator|(
name|x
operator|&
literal|255
operator|)
operator|==
literal|0
condition|)
name|Image_note_progress
argument_list|(
name|image
argument_list|,
name|x
argument_list|,
name|out_height
argument_list|)
expr_stmt|;
if|if
condition|(
name|errline
operator|!=
name|errlast
condition|)
block|{
name|errlast
operator|=
name|errline
expr_stmt|;
name|Image_get_col
argument_list|(
name|image
argument_list|,
name|in
argument_list|,
name|errline
argument_list|)
expr_stmt|;
block|}
call|(
modifier|*
name|colorfunc
call|)
argument_list|(
name|in
argument_list|,
name|out
argument_list|,
name|image_height
argument_list|,
name|image_bpp
argument_list|,
name|lut
argument_list|,
name|cmap
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|xdpi
operator|==
literal|300
operator|&&
name|model
operator|==
literal|800
condition|)
block|{
comment|/*         * 4-level (CRet) dithers... 	*/
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
block|{
name|dither_black4
argument_list|(
name|out
argument_list|,
name|x
argument_list|,
name|image_height
argument_list|,
name|out_width
argument_list|,
name|black
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dither_cmyk4
argument_list|(
name|out
argument_list|,
name|x
argument_list|,
name|image_height
argument_list|,
name|out_width
argument_list|,
name|cyan
argument_list|,
name|magenta
argument_list|,
name|yellow
argument_list|,
name|black
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|cyan
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|cyan
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|magenta
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|magenta
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|yellow
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|yellow
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*         * Standard 2-level dithers... 	*/
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
block|{
name|dither_black
argument_list|(
name|out
argument_list|,
name|x
argument_list|,
name|image_height
argument_list|,
name|out_width
argument_list|,
name|black
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
argument_list|,
name|length
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dither_cmyk
argument_list|(
name|out
argument_list|,
name|x
argument_list|,
name|image_height
argument_list|,
name|out_width
argument_list|,
name|cyan
argument_list|,
literal|0
argument_list|,
name|magenta
argument_list|,
literal|0
argument_list|,
name|yellow
argument_list|,
literal|0
argument_list|,
name|black
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|black
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
argument_list|,
name|length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|cyan
argument_list|,
name|length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|magenta
argument_list|,
name|length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|yellow
argument_list|,
name|length
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|errval
operator|+=
name|errmod
expr_stmt|;
name|errline
operator|-=
name|errdiv
expr_stmt|;
if|if
condition|(
name|errval
operator|>=
name|out_height
condition|)
block|{
name|errval
operator|-=
name|out_height
expr_stmt|;
name|errline
operator|--
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|in
operator|=
name|malloc
argument_list|(
name|image_width
operator|*
name|image_bpp
argument_list|)
expr_stmt|;
name|out
operator|=
name|malloc
argument_list|(
name|image_width
operator|*
name|out_bpp
operator|*
literal|2
argument_list|)
expr_stmt|;
name|errdiv
operator|=
name|image_height
operator|/
name|out_height
expr_stmt|;
name|errmod
operator|=
name|image_height
operator|%
name|out_height
expr_stmt|;
name|errval
operator|=
literal|0
expr_stmt|;
name|errlast
operator|=
operator|-
literal|1
expr_stmt|;
name|errline
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|out_height
condition|;
name|y
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"pcl_print: y = %d, line = %d, val = %d, mod = %d, height = %d\n"
argument_list|,
name|y
argument_list|,
name|errline
argument_list|,
name|errval
argument_list|,
name|errmod
argument_list|,
name|out_height
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
if|if
condition|(
operator|(
name|y
operator|&
literal|255
operator|)
operator|==
literal|0
condition|)
name|Image_note_progress
argument_list|(
name|image
argument_list|,
name|y
argument_list|,
name|out_height
argument_list|)
expr_stmt|;
if|if
condition|(
name|errline
operator|!=
name|errlast
condition|)
block|{
name|errlast
operator|=
name|errline
expr_stmt|;
name|Image_get_row
argument_list|(
name|image
argument_list|,
name|in
argument_list|,
name|errline
argument_list|)
expr_stmt|;
block|}
call|(
modifier|*
name|colorfunc
call|)
argument_list|(
name|in
argument_list|,
name|out
argument_list|,
name|image_width
argument_list|,
name|image_bpp
argument_list|,
name|lut
argument_list|,
name|cmap
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|xdpi
operator|==
literal|300
operator|&&
name|model
operator|==
literal|800
condition|)
block|{
comment|/*         * 4-level (CRet) dithers... 	*/
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
block|{
name|dither_black4
argument_list|(
name|out
argument_list|,
name|y
argument_list|,
name|image_width
argument_list|,
name|out_width
argument_list|,
name|black
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dither_cmyk4
argument_list|(
name|out
argument_list|,
name|y
argument_list|,
name|image_width
argument_list|,
name|out_width
argument_list|,
name|cyan
argument_list|,
name|magenta
argument_list|,
name|yellow
argument_list|,
name|black
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|cyan
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|cyan
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|magenta
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|magenta
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|yellow
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|yellow
operator|+
name|length
operator|/
literal|2
argument_list|,
name|length
operator|/
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*         * Standard 2-level dithers... 	*/
if|if
condition|(
name|output_type
operator|==
name|OUTPUT_GRAY
condition|)
block|{
name|dither_black
argument_list|(
name|out
argument_list|,
name|y
argument_list|,
name|image_width
argument_list|,
name|out_width
argument_list|,
name|black
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
argument_list|,
name|length
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dither_cmyk
argument_list|(
name|out
argument_list|,
name|y
argument_list|,
name|image_width
argument_list|,
name|out_width
argument_list|,
name|cyan
argument_list|,
literal|0
argument_list|,
name|magenta
argument_list|,
literal|0
argument_list|,
name|yellow
argument_list|,
literal|0
argument_list|,
name|black
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|black
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|black
argument_list|,
name|length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|cyan
argument_list|,
name|length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|magenta
argument_list|,
name|length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
call|(
modifier|*
name|writefunc
call|)
argument_list|(
name|prn
argument_list|,
name|yellow
argument_list|,
name|length
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|errval
operator|+=
name|errmod
expr_stmt|;
name|errline
operator|+=
name|errdiv
expr_stmt|;
if|if
condition|(
name|errval
operator|>=
name|out_height
condition|)
block|{
name|errval
operator|-=
name|out_height
expr_stmt|;
name|errline
operator|++
expr_stmt|;
block|}
block|}
block|}
comment|/*   * Cleanup...   */
name|free
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|black
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|black
argument_list|)
expr_stmt|;
if|if
condition|(
name|cyan
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|cyan
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|magenta
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|yellow
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|model
condition|)
comment|/* End raster graphics */
block|{
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|3
case|:
case|case
literal|500
case|:
name|fputs
argument_list|(
literal|"\033*rB"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
break|break;
default|default :
name|fputs
argument_list|(
literal|"\033*rbC"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
break|break;
block|}
name|fputs
argument_list|(
literal|"\033&l0H"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* Eject page */
name|fputs
argument_list|(
literal|"\033E"
argument_list|,
name|prn
argument_list|)
expr_stmt|;
comment|/* PCL reset */
block|}
end_function

begin_comment
comment|/*  * 'pcl_mode0()' - Send PCL graphics using mode 0 (no) compression.  */
end_comment

begin_function
name|void
DECL|function|pcl_mode0 (FILE * prn,unsigned char * line,int length,int last_plane)
name|pcl_mode0
parameter_list|(
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - Print file or command */
name|unsigned
name|char
modifier|*
name|line
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|length
parameter_list|,
comment|/* I - Length of bitmap data */
name|int
name|last_plane
parameter_list|)
comment|/* I - True if this is the last plane */
block|{
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\033*b%d%c"
argument_list|,
name|length
argument_list|,
name|last_plane
condition|?
literal|'W'
else|:
literal|'V'
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|line
argument_list|,
name|length
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 'pcl_mode2()' - Send PCL graphics using mode 2 (TIFF) compression.  */
end_comment

begin_function
name|void
DECL|function|pcl_mode2 (FILE * prn,unsigned char * line,int length,int last_plane)
name|pcl_mode2
parameter_list|(
name|FILE
modifier|*
name|prn
parameter_list|,
comment|/* I - Print file or command */
name|unsigned
name|char
modifier|*
name|line
parameter_list|,
comment|/* I - Output bitmap data */
name|int
name|length
parameter_list|,
comment|/* I - Length of bitmap data */
name|int
name|last_plane
parameter_list|)
comment|/* I - True if this is the last plane */
block|{
name|unsigned
name|char
name|comp_buf
index|[
literal|1536
index|]
decl_stmt|,
comment|/* Compression buffer */
modifier|*
name|comp_ptr
decl_stmt|,
comment|/* Current slot in buffer */
modifier|*
name|start
decl_stmt|,
comment|/* Start of compressed data */
name|repeat
decl_stmt|;
comment|/* Repeating char */
name|int
name|count
decl_stmt|,
comment|/* Count of compressed bytes */
name|tcount
decl_stmt|;
comment|/* Temporary count< 128 */
comment|/*   * Compress using TIFF "packbits" run-length encoding...   */
name|comp_ptr
operator|=
name|comp_buf
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
condition|)
block|{
comment|/*     * Get a run of non-repeated chars...     */
name|start
operator|=
name|line
expr_stmt|;
name|line
operator|+=
literal|2
expr_stmt|;
name|length
operator|-=
literal|2
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
operator|&&
operator|(
name|line
index|[
operator|-
literal|2
index|]
operator|!=
name|line
index|[
operator|-
literal|1
index|]
operator|||
name|line
index|[
operator|-
literal|1
index|]
operator|!=
name|line
index|[
literal|0
index|]
operator|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
name|length
operator|--
expr_stmt|;
block|}
name|line
operator|-=
literal|2
expr_stmt|;
name|length
operator|+=
literal|2
expr_stmt|;
comment|/*     * Output the non-repeated sequences (max 128 at a time).     */
name|count
operator|=
name|line
operator|-
name|start
expr_stmt|;
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|tcount
operator|=
name|count
operator|>
literal|128
condition|?
literal|128
else|:
name|count
expr_stmt|;
name|comp_ptr
index|[
literal|0
index|]
operator|=
name|tcount
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|comp_ptr
operator|+
literal|1
argument_list|,
name|start
argument_list|,
name|tcount
argument_list|)
expr_stmt|;
name|comp_ptr
operator|+=
name|tcount
operator|+
literal|1
expr_stmt|;
name|start
operator|+=
name|tcount
expr_stmt|;
name|count
operator|-=
name|tcount
expr_stmt|;
block|}
if|if
condition|(
name|length
operator|<=
literal|0
condition|)
break|break;
comment|/*     * Find the repeated sequences...     */
name|start
operator|=
name|line
expr_stmt|;
name|repeat
operator|=
name|line
index|[
literal|0
index|]
expr_stmt|;
name|line
operator|++
expr_stmt|;
name|length
operator|--
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
operator|&&
operator|*
name|line
operator|==
name|repeat
condition|)
block|{
name|line
operator|++
expr_stmt|;
name|length
operator|--
expr_stmt|;
block|}
comment|/*     * Output the repeated sequences (max 128 at a time).     */
name|count
operator|=
name|line
operator|-
name|start
expr_stmt|;
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|tcount
operator|=
name|count
operator|>
literal|128
condition|?
literal|128
else|:
name|count
expr_stmt|;
name|comp_ptr
index|[
literal|0
index|]
operator|=
literal|1
operator|-
name|tcount
expr_stmt|;
name|comp_ptr
index|[
literal|1
index|]
operator|=
name|repeat
expr_stmt|;
name|comp_ptr
operator|+=
literal|2
expr_stmt|;
name|count
operator|-=
name|tcount
expr_stmt|;
block|}
block|}
comment|/*   * Send a line of raster graphics...   */
name|fprintf
argument_list|(
name|prn
argument_list|,
literal|"\033*b%d%c"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|comp_ptr
operator|-
name|comp_buf
argument_list|)
argument_list|,
name|last_plane
condition|?
literal|'W'
else|:
literal|'V'
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|comp_buf
argument_list|,
name|comp_ptr
operator|-
name|comp_buf
argument_list|,
literal|1
argument_list|,
name|prn
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * End of "$Id$".  */
end_comment

end_unit

