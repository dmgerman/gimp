begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  Screenshot plug-in  *  Copyright 1998-2000 Sven Neumann<sven@gimp.org>  *  Copyright 2003      Henrik Brix Andersen<brix@gimp.org>  *  *  Any suggestions, bug-reports or patches are very welcome.  *  */
end_comment

begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|<gdk/gdkkeysyms.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|GDK_WINDOWING_X11
argument_list|)
end_if

begin_include
include|#
directive|include
file|<gdk/gdkx.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_X11_XMU_WINUTIL_H
end_ifdef

begin_include
include|#
directive|include
file|<X11/Xmu/WinUtil.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_X11_XMU_WINUTIL_H */
end_comment

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|GDK_WINDOWING_WIN32
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_comment
comment|/* GdkPixbuf RGBA C-Source image dump 1-byte-run-length-encoded */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__SUNPRO_C
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|align
name|4
name|(
name|screenshot_icon
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_decl_stmt
DECL|variable|screenshot_icon
specifier|static
specifier|const
name|guint8
name|screenshot_icon
index|[]
name|__attribute__
argument_list|(
operator|(
name|__aligned__
argument_list|(
literal|4
argument_list|)
operator|)
argument_list|)
init|=
else|#
directive|else
specifier|static
specifier|const
name|guint8
name|screenshot_icon
index|[]
operator|=
endif|#
directive|endif
block|{
literal|""
comment|/* Pixbuf magic (0x47646b50) */
literal|"GdkP"
comment|/* length: header (24) + pixel_data (1653) */
literal|"\0\0\6\215"
comment|/* pixdata_type (0x2010002) */
literal|"\2\1\0\2"
comment|/* rowstride (96) */
literal|"\0\0\0`"
comment|/* width (24) */
literal|"\0\0\0\30"
comment|/* height (24) */
literal|"\0\0\0\30"
comment|/* pixel_data: */
literal|"\273\0\0\0\0\7kkk\17\250\250\250\316\265\265\265\377\276\276\276\377"
literal|"\273\273\273\377\253\253\253\316rrr\17\221\0\0\0\0\7\210\210\210F\322"
literal|"\322\322\364\370\370\370\377\376\376\376\377\370\370\370\377\325\325"
literal|"\325\370\220\220\220F\221\0\0\0\0\7www\250\256\256\256\377\300\300\300"
literal|"\377\310\310\310\377\303\303\303\377\260\260\260\377\204\204\204\253"
literal|"\220\0\0\0\0\11\35\35\35\17"
literal|"111\354<<<\334LLL\201PPPrLLL\201>>>\323"
literal|";;;\344'''\17\217\0\0\0\0\11\2\2\2E\40\40\40\377***\316RRR\200QQQ\200"
literal|"PPP\200$$$\316\34\34\34\377\4\4\4E\215\0\0\0\0\5\0\0\0\12\0\0\0'\0\0"
literal|"\0\207777\365ppp\377\203zzz\377\6ppp\377000\366\0\0\0\217\0\0\0'\0\0"
literal|"\0\\\0\0\0"
literal|"4\204\0\0\0\0\13\0\0\0\6\0\0\0/\2\2\2`\1\1\0\222\"\"\"\251"
literal|"111\324FFF\342DDD\343PPP\312\216\216\216\377\244\244\244\377\204\260"
literal|"\260\260\377\6\222\222\222\377DDD\364888\355'''\342\37\37\37\322\0\0"
literal|"\0\3\202\0\0\0\0\14\0\0\0h988\377ddc\377feb\377edb\377kjg\377{{z\377"
literal|"nnn\377\344\344\344\377\231\231\231\377\256\256\256\377\212\212\212\377"
literal|"\202\203\203\203\377\202\201\201\201\377\6\226\226\226\377xxx\377www"
literal|"\377yyy\377MMM\366\12\12\11E\202\0\0\0\0\1LKH\377\202yxu\377\5ffd\377"
literal|",,,\377a`^\377FFD\377ZZZ\377\202\220\220\220\377\4\240\240\240\377\217"
literal|"\216\216\377\215\214\212\377nmj\377\202ffd\377\6nnm\377\212\212\212\377"
literal|"lll\377fff\377kkk\377\6\6\6q\202\0\0\0\0\26>=:\377\232\232\226\377\222"
literal|"\221\215\377\226\225\224\377\206\205\202\377\\\\Z\377((&\377ooo\377e"
literal|"ee\377\232\232\232\377\206\206\205\377prp\377add\377X\\\\\377RVV\377"
literal|"ORR\377BEA\377[]Y\377hhh\377~~~\377}}}\377\0\0\0\200\202\0\0\0\0\26>"
literal|"=8\377\203\201x\377sph\377gd]\377XVP\377;:6\37700.\377qqq\377nnn\377"
literal|"\222\222\221\377`cc\377W\\\\\377DHI\377FJL\377DIL\377<AC\377151\377/"
literal|"1+\377OOL\377zzz\377~~~\377\0\0\0\200\202\0\0\0\0\26=<8\377\203\200x"
literal|"\377sph\377hf^\377YVP\377=;7\377543\377mmm\377\200\200\200\377Z]]\377"
literal|"KQQ\377NQR\377RTR\377)+,\377%((\377MOP\377PSU\377042\377+*$\377rrr\377"
literal|"|||\377\0\0\0\200\202\0\0\0\0\26=;7\377\202\200x\377rog\377ge^\377XV"
literal|"O\377<:6\377443\377qqq\377^`a\377PUW\377RVT\377698\377443\377,,,\377"
literal|"\34\34\34\377\32\32\32\3777;;\377\77DG\377'(\"\377``\\\377{{{\377\0\0"
literal|"\0\200\202\0\0\0\0\177<;7\377\202\177w\377rog\377fd]\377WUN\377<:6\377"
literal|"442\377kkk\377VXY\377<BB\377VYY\377887\377\224\224\224\377\265\265\265"
literal|"\377XXX\377;;;\377*++\377JPR\377)-,\377DC\77\377yyy\377\0\0\0\201\0\0"
literal|"\0\1\0\0\0\2<;6\377\202\177w\377qnf\377fc\\\377VTN\377<:6\377442\377"
literal|"mmm\377\\^^\377@EF\377KOL\377\36\36\36\377xxx\377\316\316\316\377\237"
literal|"\237\237\377YYY\377:::\377NRU\377)-/\377ZZV\377vvv\377\0\0\0\206\0\0"
literal|"\0\6\0\0\0\10<:6\377\200~v\377qnf\377eb\\\377VTN\377;95\377442\377nn"
literal|"n\377XYZ\3779@@\3776<<\377\20\21\20\377...\377ggg\377\204\204\204\377"
literal|"\206\206\206\377BBB\377EKN\377(,.\377hih\377jjj\377\0\0\0\215\0\0\0\16"
literal|"\0\0\0\20<:6\377\200~v\377pnf\377dc[\377USM\377;95\377432\377ttt\377"
literal|"ijj\377*./\377<DG\377$(&\377###\377@@@\377RRR\377JJJ\377JLP\377<BG\377"
literal|"),,\377xxx\377BBB\371\0\0\0b\0\0\0\16\0\0\0\17\"\"\"\255XVP\371`^W\376"
literal|"^\\U\377NKF\377,+(\363\0\0\0\310\0\0\0\274\0\0\0\276\20\22\22\3457>A"
literal|"\377UXX\377045\377024\3778<=\377BFH\377SWY\377158\377\13\15\15\307\0"
literal|"\0\0\251\0\0\0e\0\0\0\32\0\0\0\10\0\0\0\6\0\0\0\30\0\0\0G\0\0\0e\0\0"
literal|"\0|\15\14\13o\5\5\4X\0\0\0F'\0\0\0J\0\0\0V\2\2\2q\24\26\27\324<AD\377"
literal|"PUX\377@FJ\377RVY\377WZ\\\377379\377\17\20\21\262\0\0\0Q\0\0\0"
literal|"3\0\0"
literal|"\0\32\0\0\0\11\0\0\0\2\0\0\0\1\0\0\0\4\0\0\0\10\0\0\0\12\0\0\0\13\0\0"
literal|"\0\15\0\0\0\20\0\0\0\22\0\0\0\26\0\0\0$\0\0\0"
literal|"2\1\1\1D\11\12\12\212"
literal|"$')\306\"%'\360&),\343\33\35\36\300\12\13\13l\0\0\0"
literal|"6\0\0\0\"\0\0\0"
literal|"\20\0\0\0\6\0\0\0\1\210\0\0\0\0\16\0\0\0\1\0\0\0\2\0\0\0\10\0\0\0\16"
literal|"\0\0\0\25\0\0\0\34\0\0\0\"\0\0\0#\0\0\0\40\0\0\0\34\0\0\0\27\0\0\0\17"
literal|"\0\0\0\7\0\0\0\2\215\0\0\0\0\3\0\0\0\2\0\0\0\4\0\0\0\6\202\0\0\0\11\4"
literal|"\0\0\0\7\0\0\0\5\0\0\0\3\0\0\0\1\205\0\0\0\0"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Defines */
end_comment

begin_define
DECL|macro|PLUG_IN_PROC
define|#
directive|define
name|PLUG_IN_PROC
value|"plug-in-screenshot"
end_define

begin_define
DECL|macro|PLUG_IN_BINARY
define|#
directive|define
name|PLUG_IN_BINARY
value|"screenshot"
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|GDK_NATIVE_WINDOW_POINTER
end_ifdef

begin_if
if|#
directive|if
name|GLIB_SIZEOF_VOID_P
operator|!=
literal|4
end_if

begin_warning
warning|#
directive|warning
warning|window_id does not fit in PDB_INT32
end_warning

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
enum|enum
DECL|enum|__anon29e20ada0103
block|{
DECL|enumerator|SHOOT_ROOT
name|SHOOT_ROOT
block|,
DECL|enumerator|SHOOT_REGION
name|SHOOT_REGION
block|,
DECL|enumerator|SHOOT_WINDOW
name|SHOOT_WINDOW
DECL|typedef|ShootType
block|}
name|ShootType
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon29e20ada0208
block|{
DECL|member|shoot_type
name|ShootType
name|shoot_type
decl_stmt|;
DECL|member|decorate
name|gboolean
name|decorate
decl_stmt|;
DECL|member|window_id
name|guint
name|window_id
decl_stmt|;
DECL|member|select_delay
name|guint
name|select_delay
decl_stmt|;
DECL|member|x1
name|gint
name|x1
decl_stmt|;
DECL|member|y1
name|gint
name|y1
decl_stmt|;
DECL|member|x2
name|gint
name|x2
decl_stmt|;
DECL|member|y2
name|gint
name|y2
decl_stmt|;
DECL|typedef|ScreenshotValues
block|}
name|ScreenshotValues
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|shootvals
specifier|static
name|ScreenshotValues
name|shootvals
init|=
block|{
name|SHOOT_WINDOW
block|,
comment|/* root window  */
name|TRUE
block|,
comment|/* include WM decorations */
literal|0
block|,
comment|/* window ID    */
literal|0
block|,
comment|/* select delay */
literal|0
block|,
comment|/* coords of region dragged out by pointer */
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GdkNativeWindow
name|select_window
parameter_list|(
name|GdkScreen
modifier|*
name|screen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|create_image
parameter_list|(
specifier|const
name|GdkPixbuf
modifier|*
name|pixbuf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|shoot
parameter_list|(
name|GdkScreen
modifier|*
name|screen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|shoot_dialog
parameter_list|(
name|GdkScreen
modifier|*
modifier|*
name|screen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|shoot_delay
parameter_list|(
name|gint32
name|delay
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|shoot_delay_callback
parameter_list|(
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Global Variables */
end_comment

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc  */
name|NULL
block|,
comment|/* quit_proc  */
name|query
block|,
comment|/* query_proc */
name|run
comment|/* run_proc   */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Functions */
end_comment

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|GimpParamDef
name|args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run-mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"root"
block|,
literal|"Root window { TRUE, FALSE }"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"window-id"
block|,
literal|"Window id"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"x1"
block|,
literal|"(optional) Region left x coord"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"y1"
block|,
literal|"(optional) Region top y coord"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"x2"
block|,
literal|"(optional) Region right x coord"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"y2"
block|,
literal|"(optional) Region bottom y coord"
block|}
block|}
decl_stmt|;
specifier|static
name|GimpParamDef
name|return_vals
index|[]
init|=
block|{
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Output image"
block|}
block|}
decl_stmt|;
name|gimp_install_procedure
argument_list|(
name|PLUG_IN_PROC
argument_list|,
literal|"Take a screenshot"
argument_list|,
literal|"The plug-in allows to take screenshots of a an "
literal|"interactively selected window or of the desktop, "
literal|"either the whole desktop or an interactively "
literal|"selected region. When called non-interactively, it "
literal|"may grab the root window or use the window-id "
literal|"passed as a parameter.  The last four parameters "
literal|"are optional and can be used to specify the corners "
literal|"of the region to be grabbed."
argument_list|,
literal|"Sven Neumann<sven@gimp.org>, "
literal|"Henrik Brix Andersen<brix@gimp.org>"
argument_list|,
literal|"1998 - 2003"
argument_list|,
literal|"v0.9.7 (2003/11/15)"
argument_list|,
name|N_
argument_list|(
literal|"_Screenshot..."
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|args
argument_list|)
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|return_vals
argument_list|)
argument_list|,
name|args
argument_list|,
name|return_vals
argument_list|)
expr_stmt|;
name|gimp_plugin_menu_register
argument_list|(
name|PLUG_IN_PROC
argument_list|,
literal|"<Toolbox>/File/Acquire"
argument_list|)
expr_stmt|;
name|gimp_plugin_menu_register
argument_list|(
name|PLUG_IN_PROC
argument_list|,
literal|"<Image>/File/Acquire"
argument_list|)
expr_stmt|;
name|gimp_plugin_icon_register
argument_list|(
name|PLUG_IN_PROC
argument_list|,
name|GIMP_ICON_TYPE_INLINE_PIXBUF
argument_list|,
name|screenshot_icon
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
name|GimpRunMode
name|run_mode
init|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
decl_stmt|;
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
name|GdkScreen
modifier|*
name|screen
init|=
name|NULL
decl_stmt|;
name|gint32
name|image_ID
decl_stmt|;
specifier|static
name|GimpParam
name|values
index|[
literal|2
index|]
decl_stmt|;
comment|/* initialize the return of the status */
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
comment|/* how are we running today? */
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|GIMP_RUN_INTERACTIVE
case|:
comment|/* Possibly retrieve data from a previous run */
name|gimp_get_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|shootvals
argument_list|)
expr_stmt|;
name|shootvals
operator|.
name|window_id
operator|=
literal|0
expr_stmt|;
comment|/* Get information from the dialog */
if|if
condition|(
operator|!
name|shoot_dialog
argument_list|(
operator|&
name|screen
argument_list|)
condition|)
name|status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
break|break;
case|case
name|GIMP_RUN_NONINTERACTIVE
case|:
if|if
condition|(
name|nparams
operator|==
literal|3
condition|)
block|{
name|gboolean
name|do_root
init|=
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
decl_stmt|;
if|if
condition|(
name|do_root
condition|)
name|shootvals
operator|.
name|shoot_type
operator|=
name|SHOOT_ROOT
expr_stmt|;
else|else
name|shootvals
operator|.
name|shoot_type
operator|=
name|SHOOT_WINDOW
expr_stmt|;
name|shootvals
operator|.
name|window_id
operator|=
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|shootvals
operator|.
name|select_delay
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nparams
operator|==
literal|7
condition|)
block|{
name|shootvals
operator|.
name|shoot_type
operator|=
name|SHOOT_REGION
expr_stmt|;
name|shootvals
operator|.
name|window_id
operator|=
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|shootvals
operator|.
name|select_delay
operator|=
literal|0
expr_stmt|;
name|shootvals
operator|.
name|x1
operator|=
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|shootvals
operator|.
name|y1
operator|=
name|param
index|[
literal|4
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|shootvals
operator|.
name|x2
operator|=
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|shootvals
operator|.
name|y2
operator|=
name|param
index|[
literal|6
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
block|}
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|gdk_init_check
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
break|break;
case|case
name|GIMP_RUN_WITH_LAST_VALS
case|:
comment|/* Possibly retrieve data from a previous run */
name|gimp_get_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|shootvals
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
block|{
if|if
condition|(
name|shootvals
operator|.
name|select_delay
operator|>
literal|0
condition|)
name|shoot_delay
argument_list|(
name|shootvals
operator|.
name|select_delay
argument_list|)
expr_stmt|;
name|image_ID
operator|=
name|shoot
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|status
operator|=
operator|(
name|image_ID
operator|!=
operator|-
literal|1
operator|)
condition|?
name|GIMP_PDB_SUCCESS
else|:
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
block|{
if|if
condition|(
name|run_mode
operator|==
name|GIMP_RUN_INTERACTIVE
condition|)
block|{
comment|/* Store variable states for next run */
name|gimp_set_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|shootvals
argument_list|,
sizeof|sizeof
argument_list|(
name|ScreenshotValues
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_display_new
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
block|}
comment|/* set return values */
operator|*
name|nreturn_vals
operator|=
literal|2
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_IMAGE
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
operator|=
name|image_ID
expr_stmt|;
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Allow the user to select a window or a region with the mouse */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|GDK_WINDOWING_X11
end_ifdef

begin_function
specifier|static
name|GdkNativeWindow
DECL|function|select_window_x11 (GdkScreen * screen)
name|select_window_x11
parameter_list|(
name|GdkScreen
modifier|*
name|screen
parameter_list|)
block|{
name|Display
modifier|*
name|x_dpy
decl_stmt|;
name|Cursor
name|x_cursor
decl_stmt|;
name|XEvent
name|x_event
decl_stmt|;
name|Window
name|x_win
decl_stmt|;
name|Window
name|x_root
decl_stmt|;
name|XGCValues
name|gc_values
decl_stmt|;
name|GC
name|gc
init|=
name|NULL
decl_stmt|;
name|GdkKeymapKey
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
name|gint
name|x_scr
decl_stmt|;
name|gint
name|status
decl_stmt|;
name|gint
name|buttons
decl_stmt|;
name|gint
name|mask
init|=
name|ButtonPressMask
operator||
name|ButtonReleaseMask
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|gint
name|num_keys
decl_stmt|;
name|gboolean
name|cancel
init|=
name|FALSE
decl_stmt|;
name|x_dpy
operator|=
name|GDK_SCREEN_XDISPLAY
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|x_scr
operator|=
name|GDK_SCREEN_XNUMBER
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|x_win
operator|=
name|None
expr_stmt|;
name|x_root
operator|=
name|RootWindow
argument_list|(
name|x_dpy
argument_list|,
name|x_scr
argument_list|)
expr_stmt|;
name|x_cursor
operator|=
name|XCreateFontCursor
argument_list|(
name|x_dpy
argument_list|,
name|GDK_CROSSHAIR
argument_list|)
expr_stmt|;
name|buttons
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|shootvals
operator|.
name|shoot_type
operator|==
name|SHOOT_REGION
condition|)
block|{
name|mask
operator||=
name|PointerMotionMask
expr_stmt|;
name|gc_values
operator|.
name|function
operator|=
name|GXxor
expr_stmt|;
name|gc_values
operator|.
name|plane_mask
operator|=
name|AllPlanes
expr_stmt|;
name|gc_values
operator|.
name|foreground
operator|=
name|WhitePixel
argument_list|(
name|x_dpy
argument_list|,
name|x_scr
argument_list|)
expr_stmt|;
name|gc_values
operator|.
name|background
operator|=
name|BlackPixel
argument_list|(
name|x_dpy
argument_list|,
name|x_scr
argument_list|)
expr_stmt|;
name|gc_values
operator|.
name|line_width
operator|=
literal|0
expr_stmt|;
name|gc_values
operator|.
name|line_style
operator|=
name|LineSolid
expr_stmt|;
name|gc_values
operator|.
name|fill_style
operator|=
name|FillSolid
expr_stmt|;
name|gc_values
operator|.
name|cap_style
operator|=
name|CapButt
expr_stmt|;
name|gc_values
operator|.
name|join_style
operator|=
name|JoinMiter
expr_stmt|;
name|gc_values
operator|.
name|graphics_exposures
operator|=
name|FALSE
expr_stmt|;
name|gc_values
operator|.
name|clip_x_origin
operator|=
literal|0
expr_stmt|;
name|gc_values
operator|.
name|clip_y_origin
operator|=
literal|0
expr_stmt|;
name|gc_values
operator|.
name|clip_mask
operator|=
name|None
expr_stmt|;
name|gc_values
operator|.
name|subwindow_mode
operator|=
name|IncludeInferiors
expr_stmt|;
name|gc
operator|=
name|XCreateGC
argument_list|(
name|x_dpy
argument_list|,
name|x_root
argument_list|,
name|GCFunction
operator||
name|GCPlaneMask
operator||
name|GCForeground
operator||
name|GCLineWidth
operator||
name|GCLineStyle
operator||
name|GCCapStyle
operator||
name|GCJoinStyle
operator||
name|GCGraphicsExposures
operator||
name|GCBackground
operator||
name|GCFillStyle
operator||
name|GCClipXOrigin
operator||
name|GCClipYOrigin
operator||
name|GCClipMask
operator||
name|GCSubwindowMode
argument_list|,
operator|&
name|gc_values
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|XGrabPointer
argument_list|(
name|x_dpy
argument_list|,
name|x_root
argument_list|,
name|False
argument_list|,
name|mask
argument_list|,
name|GrabModeSync
argument_list|,
name|GrabModeAsync
argument_list|,
name|x_root
argument_list|,
name|x_cursor
argument_list|,
name|CurrentTime
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|GrabSuccess
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Error grabbing the pointer"
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|gdk_keymap_get_entries_for_keyval
argument_list|(
name|NULL
argument_list|,
name|GDK_Escape
argument_list|,
operator|&
name|keys
argument_list|,
operator|&
name|num_keys
argument_list|)
condition|)
block|{
name|gdk_error_trap_push
argument_list|()
expr_stmt|;
name|XGrabKey
argument_list|(
name|x_dpy
argument_list|,
name|keys
index|[
literal|0
index|]
operator|.
name|keycode
argument_list|,
name|AnyModifier
argument_list|,
name|x_root
argument_list|,
name|False
argument_list|,
name|GrabModeAsync
argument_list|,
name|GrabModeAsync
argument_list|)
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
name|gdk_error_trap_pop
argument_list|()
expr_stmt|;
block|}
while|while
condition|(
operator|!
name|cancel
operator|&&
operator|(
operator|(
name|x_win
operator|==
name|None
operator|)
operator|||
operator|(
name|buttons
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|XAllowEvents
argument_list|(
name|x_dpy
argument_list|,
name|SyncPointer
argument_list|,
name|CurrentTime
argument_list|)
expr_stmt|;
name|XWindowEvent
argument_list|(
name|x_dpy
argument_list|,
name|x_root
argument_list|,
name|mask
operator||
name|KeyPressMask
argument_list|,
operator|&
name|x_event
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|x_event
operator|.
name|type
condition|)
block|{
case|case
name|ButtonPress
case|:
if|if
condition|(
name|x_win
operator|==
name|None
condition|)
block|{
name|x_win
operator|=
name|x_event
operator|.
name|xbutton
operator|.
name|subwindow
expr_stmt|;
if|if
condition|(
name|x_win
operator|==
name|None
condition|)
name|x_win
operator|=
name|x_root
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_X11_XMU_WINUTIL_H
elseif|else
if|if
condition|(
operator|!
name|shootvals
operator|.
name|decorate
condition|)
block|{
name|x_win
operator|=
name|XmuClientWindow
argument_list|(
name|x_dpy
argument_list|,
name|x_win
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|shootvals
operator|.
name|x2
operator|=
name|shootvals
operator|.
name|x1
operator|=
name|x_event
operator|.
name|xbutton
operator|.
name|x_root
expr_stmt|;
name|shootvals
operator|.
name|y2
operator|=
name|shootvals
operator|.
name|y1
operator|=
name|x_event
operator|.
name|xbutton
operator|.
name|y_root
expr_stmt|;
block|}
name|buttons
operator|++
expr_stmt|;
break|break;
case|case
name|ButtonRelease
case|:
if|if
condition|(
name|buttons
operator|>
literal|0
condition|)
name|buttons
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|buttons
operator|&&
name|shootvals
operator|.
name|shoot_type
operator|==
name|SHOOT_REGION
condition|)
block|{
name|x
operator|=
name|MIN
argument_list|(
name|shootvals
operator|.
name|x1
argument_list|,
name|shootvals
operator|.
name|x2
argument_list|)
expr_stmt|;
name|y
operator|=
name|MIN
argument_list|(
name|shootvals
operator|.
name|y1
argument_list|,
name|shootvals
operator|.
name|y2
argument_list|)
expr_stmt|;
name|w
operator|=
name|ABS
argument_list|(
name|shootvals
operator|.
name|x2
operator|-
name|shootvals
operator|.
name|x1
argument_list|)
expr_stmt|;
name|h
operator|=
name|ABS
argument_list|(
name|shootvals
operator|.
name|y2
operator|-
name|shootvals
operator|.
name|y1
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|>
literal|0
operator|&&
name|h
operator|>
literal|0
condition|)
name|XDrawRectangle
argument_list|(
name|x_dpy
argument_list|,
name|x_root
argument_list|,
name|gc
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|shootvals
operator|.
name|x2
operator|=
name|x_event
operator|.
name|xbutton
operator|.
name|x_root
expr_stmt|;
name|shootvals
operator|.
name|y2
operator|=
name|x_event
operator|.
name|xbutton
operator|.
name|y_root
expr_stmt|;
block|}
break|break;
case|case
name|MotionNotify
case|:
if|if
condition|(
name|buttons
operator|>
literal|0
condition|)
block|{
name|x
operator|=
name|MIN
argument_list|(
name|shootvals
operator|.
name|x1
argument_list|,
name|shootvals
operator|.
name|x2
argument_list|)
expr_stmt|;
name|y
operator|=
name|MIN
argument_list|(
name|shootvals
operator|.
name|y1
argument_list|,
name|shootvals
operator|.
name|y2
argument_list|)
expr_stmt|;
name|w
operator|=
name|ABS
argument_list|(
name|shootvals
operator|.
name|x2
operator|-
name|shootvals
operator|.
name|x1
argument_list|)
expr_stmt|;
name|h
operator|=
name|ABS
argument_list|(
name|shootvals
operator|.
name|y2
operator|-
name|shootvals
operator|.
name|y1
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|>
literal|0
operator|&&
name|h
operator|>
literal|0
condition|)
name|XDrawRectangle
argument_list|(
name|x_dpy
argument_list|,
name|x_root
argument_list|,
name|gc
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|shootvals
operator|.
name|x2
operator|=
name|x_event
operator|.
name|xmotion
operator|.
name|x_root
expr_stmt|;
name|shootvals
operator|.
name|y2
operator|=
name|x_event
operator|.
name|xmotion
operator|.
name|y_root
expr_stmt|;
name|x
operator|=
name|MIN
argument_list|(
name|shootvals
operator|.
name|x1
argument_list|,
name|shootvals
operator|.
name|x2
argument_list|)
expr_stmt|;
name|y
operator|=
name|MIN
argument_list|(
name|shootvals
operator|.
name|y1
argument_list|,
name|shootvals
operator|.
name|y2
argument_list|)
expr_stmt|;
name|w
operator|=
name|ABS
argument_list|(
name|shootvals
operator|.
name|x2
operator|-
name|shootvals
operator|.
name|x1
argument_list|)
expr_stmt|;
name|h
operator|=
name|ABS
argument_list|(
name|shootvals
operator|.
name|y2
operator|-
name|shootvals
operator|.
name|y1
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|>
literal|0
operator|&&
name|h
operator|>
literal|0
condition|)
name|XDrawRectangle
argument_list|(
name|x_dpy
argument_list|,
name|x_root
argument_list|,
name|gc
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|KeyPress
case|:
block|{
name|guint
modifier|*
name|keyvals
decl_stmt|;
name|gint
name|n
decl_stmt|;
if|if
condition|(
name|gdk_keymap_get_entries_for_keycode
argument_list|(
name|NULL
argument_list|,
name|x_event
operator|.
name|xkey
operator|.
name|keycode
argument_list|,
name|NULL
argument_list|,
operator|&
name|keyvals
argument_list|,
operator|&
name|n
argument_list|)
condition|)
block|{
name|gint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
operator|&&
operator|!
name|cancel
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|keyvals
index|[
name|i
index|]
operator|==
name|GDK_Escape
condition|)
name|cancel
operator|=
name|TRUE
expr_stmt|;
name|g_free
argument_list|(
name|keyvals
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|keys
condition|)
block|{
name|XUngrabKey
argument_list|(
name|x_dpy
argument_list|,
name|keys
index|[
literal|0
index|]
operator|.
name|keycode
argument_list|,
name|AnyModifier
argument_list|,
name|x_root
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|keys
argument_list|)
expr_stmt|;
block|}
name|XUngrabPointer
argument_list|(
name|x_dpy
argument_list|,
name|CurrentTime
argument_list|)
expr_stmt|;
name|XFreeCursor
argument_list|(
name|x_dpy
argument_list|,
name|x_cursor
argument_list|)
expr_stmt|;
return|return
name|x_win
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|GDK_WINDOWING_WIN32
end_ifdef

begin_function
specifier|static
name|GdkNativeWindow
DECL|function|select_window_win32 (GdkScreen * screen)
name|select_window_win32
parameter_list|(
name|GdkScreen
modifier|*
name|screen
parameter_list|)
block|{
comment|/* MS Windows specific code goes here (yet to be written) */
comment|/* basically the code should grab the pointer using a crosshair    * cursor, allow the user to click on a window and return the    * obtained HWND (as a GdkNativeWindow) - for more details consult    * the X11 specific code above    */
comment|/* note to self: take a look at the winsnap plug-in for example code */
ifdef|#
directive|ifdef
name|__GNUC__
warning|#
directive|warning
warning|Win32 screenshot window chooser not implemented yet
else|#
directive|else
pragma|#
directive|pragma
name|message
name|(
literal|"Win32 screenshot window chooser not implemented yet"
name|)
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|GdkNativeWindow
DECL|function|select_window (GdkScreen * screen)
name|select_window
parameter_list|(
name|GdkScreen
modifier|*
name|screen
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|GDK_WINDOWING_X11
argument_list|)
return|return
name|select_window_x11
argument_list|(
name|screen
argument_list|)
return|;
elif|#
directive|elif
name|defined
argument_list|(
name|GDK_WINDOWING_WIN32
argument_list|)
return|return
name|select_window_win32
argument_list|(
name|screen
argument_list|)
return|;
else|#
directive|else
warning|#
directive|warning
warning|screenshot window chooser not implemented yet for this GDK backend
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Create a GimpImage from a GdkPixbuf */
end_comment

begin_function
specifier|static
name|gint32
DECL|function|create_image (const GdkPixbuf * pixbuf)
name|create_image
parameter_list|(
specifier|const
name|GdkPixbuf
modifier|*
name|pixbuf
parameter_list|)
block|{
name|GimpPixelRgn
name|rgn
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|gint32
name|image
decl_stmt|;
name|gint32
name|layer
decl_stmt|;
name|gdouble
name|xres
decl_stmt|,
name|yres
decl_stmt|;
name|gchar
modifier|*
name|comment
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gint
name|rowstride
decl_stmt|;
name|gint
name|bpp
decl_stmt|;
name|gboolean
name|status
decl_stmt|;
name|guchar
modifier|*
name|pixels
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
name|status
operator|=
name|gimp_progress_init
argument_list|(
name|_
argument_list|(
literal|"Importing screenshot"
argument_list|)
argument_list|)
expr_stmt|;
name|width
operator|=
name|gdk_pixbuf_get_width
argument_list|(
name|pixbuf
argument_list|)
expr_stmt|;
name|height
operator|=
name|gdk_pixbuf_get_height
argument_list|(
name|pixbuf
argument_list|)
expr_stmt|;
name|image
operator|=
name|gimp_image_new
argument_list|(
name|width
argument_list|,
name|height
argument_list|,
name|GIMP_RGB
argument_list|)
expr_stmt|;
name|gimp_image_undo_disable
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|layer
operator|=
name|gimp_layer_new
argument_list|(
name|image
argument_list|,
name|_
argument_list|(
literal|"Screenshot"
argument_list|)
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|GIMP_RGB_IMAGE
argument_list|,
literal|100
argument_list|,
name|GIMP_NORMAL_MODE
argument_list|)
expr_stmt|;
name|gimp_image_add_layer
argument_list|(
name|image
argument_list|,
name|layer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|layer
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|rowstride
operator|=
name|gdk_pixbuf_get_rowstride
argument_list|(
name|pixbuf
argument_list|)
expr_stmt|;
name|bpp
operator|=
name|gdk_pixbuf_get_n_channels
argument_list|(
name|pixbuf
argument_list|)
expr_stmt|;
name|pixels
operator|=
name|gdk_pixbuf_get_pixels
argument_list|(
name|pixbuf
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|bpp
operator|==
name|rgn
operator|.
name|bpp
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|gimp_pixel_rgns_register
argument_list|(
literal|1
argument_list|,
operator|&
name|rgn
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|gimp_pixel_rgns_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
specifier|const
name|guchar
modifier|*
name|src
decl_stmt|;
name|guchar
modifier|*
name|dest
decl_stmt|;
name|gint
name|y
decl_stmt|;
name|src
operator|=
name|pixels
operator|+
name|rgn
operator|.
name|y
operator|*
name|rowstride
operator|+
name|rgn
operator|.
name|x
operator|*
name|bpp
expr_stmt|;
name|dest
operator|=
name|rgn
operator|.
name|data
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|rgn
operator|.
name|h
condition|;
name|y
operator|++
control|)
block|{
name|memcpy
argument_list|(
name|dest
argument_list|,
name|src
argument_list|,
name|rgn
operator|.
name|w
operator|*
name|rgn
operator|.
name|bpp
argument_list|)
expr_stmt|;
name|src
operator|+=
name|rowstride
expr_stmt|;
name|dest
operator|+=
name|rgn
operator|.
name|rowstride
expr_stmt|;
block|}
block|}
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_progress_update
argument_list|(
literal|1.0
argument_list|)
expr_stmt|;
name|gimp_get_monitor_resolution
argument_list|(
operator|&
name|xres
argument_list|,
operator|&
name|yres
argument_list|)
expr_stmt|;
name|gimp_image_set_resolution
argument_list|(
name|image
argument_list|,
name|xres
argument_list|,
name|yres
argument_list|)
expr_stmt|;
name|comment
operator|=
name|gimp_get_default_comment
argument_list|()
expr_stmt|;
if|if
condition|(
name|comment
condition|)
block|{
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
literal|"gimp-comment"
argument_list|,
name|GIMP_PARASITE_PERSISTENT
argument_list|,
name|g_utf8_strlen
argument_list|(
name|comment
argument_list|,
operator|-
literal|1
argument_list|)
operator|+
literal|1
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|gimp_image_parasite_attach
argument_list|(
name|image
argument_list|,
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|comment
argument_list|)
expr_stmt|;
block|}
name|gimp_image_undo_enable
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
name|image
return|;
block|}
end_function

begin_comment
comment|/* The main Screenshot function */
end_comment

begin_function
specifier|static
name|gint32
DECL|function|shoot (GdkScreen * screen)
name|shoot
parameter_list|(
name|GdkScreen
modifier|*
name|screen
parameter_list|)
block|{
name|GdkWindow
modifier|*
name|window
decl_stmt|;
name|GdkPixbuf
modifier|*
name|screenshot
decl_stmt|;
name|GdkRectangle
name|rect
decl_stmt|;
name|GdkRectangle
name|screen_rect
decl_stmt|;
name|gint32
name|image
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
comment|/* use default screen if we are running non-interactively */
if|if
condition|(
name|screen
operator|==
name|NULL
condition|)
name|screen
operator|=
name|gdk_screen_get_default
argument_list|()
expr_stmt|;
name|screen_rect
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|screen_rect
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|screen_rect
operator|.
name|width
operator|=
name|gdk_screen_get_width
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen_rect
operator|.
name|height
operator|=
name|gdk_screen_get_height
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|shootvals
operator|.
name|shoot_type
operator|==
name|SHOOT_REGION
condition|)
block|{
name|rect
operator|.
name|x
operator|=
name|MIN
argument_list|(
name|shootvals
operator|.
name|x1
argument_list|,
name|shootvals
operator|.
name|x2
argument_list|)
expr_stmt|;
name|rect
operator|.
name|y
operator|=
name|MIN
argument_list|(
name|shootvals
operator|.
name|y1
argument_list|,
name|shootvals
operator|.
name|y2
argument_list|)
expr_stmt|;
name|rect
operator|.
name|width
operator|=
name|ABS
argument_list|(
name|shootvals
operator|.
name|x2
operator|-
name|shootvals
operator|.
name|x1
argument_list|)
expr_stmt|;
name|rect
operator|.
name|height
operator|=
name|ABS
argument_list|(
name|shootvals
operator|.
name|y2
operator|-
name|shootvals
operator|.
name|y1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|shootvals
operator|.
name|shoot_type
operator|==
name|SHOOT_ROOT
condition|)
block|{
name|window
operator|=
name|gdk_screen_get_root_window
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|GdkDisplay
modifier|*
name|display
init|=
name|gdk_screen_get_display
argument_list|(
name|screen
argument_list|)
decl_stmt|;
name|window
operator|=
name|gdk_window_foreign_new_for_display
argument_list|(
name|display
argument_list|,
name|shootvals
operator|.
name|window_id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|window
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Specified window not found"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|gdk_drawable_get_size
argument_list|(
name|GDK_DRAWABLE
argument_list|(
name|window
argument_list|)
argument_list|,
operator|&
name|rect
operator|.
name|width
argument_list|,
operator|&
name|rect
operator|.
name|height
argument_list|)
expr_stmt|;
name|gdk_window_get_origin
argument_list|(
name|window
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
name|rect
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|rect
operator|.
name|y
operator|=
name|y
expr_stmt|;
block|}
name|window
operator|=
name|gdk_screen_get_root_window
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|gdk_window_get_origin
argument_list|(
name|window
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gdk_rectangle_intersect
argument_list|(
operator|&
name|rect
argument_list|,
operator|&
name|screen_rect
argument_list|,
operator|&
name|rect
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|screenshot
operator|=
name|gdk_pixbuf_get_from_drawable
argument_list|(
name|NULL
argument_list|,
name|window
argument_list|,
name|NULL
argument_list|,
name|rect
operator|.
name|x
operator|-
name|x
argument_list|,
name|rect
operator|.
name|y
operator|-
name|y
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|rect
operator|.
name|width
argument_list|,
name|rect
operator|.
name|height
argument_list|)
expr_stmt|;
name|gdk_display_beep
argument_list|(
name|gdk_screen_get_display
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|screenshot
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"There was an error taking the screenshot."
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|image
operator|=
name|create_image
argument_list|(
name|screenshot
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|screenshot
argument_list|)
expr_stmt|;
return|return
name|image
return|;
block|}
end_function

begin_comment
comment|/*  Screenshot dialog  */
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|shoot_dialog (GdkScreen ** screen)
name|shoot_dialog
parameter_list|(
name|GdkScreen
modifier|*
modifier|*
name|screen
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle
decl_stmt|;
name|GtkWidget
modifier|*
name|spinner
decl_stmt|;
name|GdkPixbuf
modifier|*
name|pixbuf
decl_stmt|;
name|GSList
modifier|*
name|radio_group
init|=
name|NULL
decl_stmt|;
name|GtkObject
modifier|*
name|adj
decl_stmt|;
name|gboolean
name|region
init|=
name|FALSE
decl_stmt|;
name|gboolean
name|run
decl_stmt|;
if|if
condition|(
name|shootvals
operator|.
name|shoot_type
operator|==
name|SHOOT_REGION
condition|)
block|{
name|shootvals
operator|.
name|shoot_type
operator|=
name|SHOOT_ROOT
expr_stmt|;
name|region
operator|=
name|TRUE
expr_stmt|;
block|}
name|gimp_ui_init
argument_list|(
name|PLUG_IN_BINARY
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|dialog
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Screenshot"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PLUG_IN_PROC
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_dialog_add_button
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"_Grab"
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|pixbuf
operator|=
name|gdk_pixbuf_new_from_inline
argument_list|(
operator|-
literal|1
argument_list|,
name|screenshot_icon
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pixbuf
condition|)
block|{
name|gtk_button_set_image
argument_list|(
name|GTK_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|gtk_image_new_from_pixbuf
argument_list|(
name|pixbuf
argument_list|)
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|pixbuf
argument_list|)
expr_stmt|;
block|}
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_radio_button_new_with_mnemonic
argument_list|(
name|radio_group
argument_list|,
name|_
argument_list|(
literal|"Take a screenshot of "
literal|"a single _window"
argument_list|)
argument_list|)
expr_stmt|;
name|radio_group
operator|=
name|gtk_radio_button_get_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|shootvals
operator|.
name|shoot_type
operator|==
name|SHOOT_WINDOW
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"gimp-item-data"
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|SHOOT_WINDOW
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_radio_button_update
argument_list|)
argument_list|,
operator|&
name|shootvals
operator|.
name|shoot_type
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_X11_XMU_WINUTIL_H
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Include window decoration"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|shootvals
operator|.
name|decorate
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"set_sensitive"
argument_list|,
name|toggle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|shootvals
operator|.
name|decorate
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_X11_XMU_WINUTIL_H */
comment|/*  root window  */
name|button
operator|=
name|gtk_radio_button_new_with_mnemonic
argument_list|(
name|radio_group
argument_list|,
name|_
argument_list|(
literal|"Take a screenshot of "
literal|"your _desktop"
argument_list|)
argument_list|)
expr_stmt|;
name|radio_group
operator|=
name|gtk_radio_button_get_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|shootvals
operator|.
name|shoot_type
operator|==
name|SHOOT_ROOT
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"gimp-item-data"
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|SHOOT_ROOT
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_radio_button_update
argument_list|)
argument_list|,
operator|&
name|shootvals
operator|.
name|shoot_type
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
comment|/*  dragged region  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Select a region"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|region
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|toggle
argument_list|,
name|_
argument_list|(
literal|"If enabled, you can use the mouse to "
literal|"select a rectangular region of the "
literal|"screen."
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"set_sensitive"
argument_list|,
name|toggle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
comment|/*  grab delay  */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"W_ait"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|spinner
operator|=
name|gimp_spin_button_new
argument_list|(
operator|&
name|adj
argument_list|,
name|shootvals
operator|.
name|select_delay
argument_list|,
literal|0.0
argument_list|,
literal|100.0
argument_list|,
literal|1.0
argument_list|,
literal|5.0
argument_list|,
literal|0.0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|spinner
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|spinner
argument_list|)
expr_stmt|;
name|gtk_label_set_mnemonic_widget
argument_list|(
name|GTK_LABEL
argument_list|(
name|label
argument_list|)
argument_list|,
name|spinner
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|shootvals
operator|.
name|select_delay
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"seconds before grabbing"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|spinner
argument_list|,
name|_
argument_list|(
literal|"The number of seconds to wait after "
literal|"selecting the window or region and "
literal|"actually taking the screenshot."
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|run
operator|=
operator|(
name|gimp_dialog_run
argument_list|(
name|GIMP_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|)
operator|==
name|GTK_RESPONSE_OK
operator|)
expr_stmt|;
if|if
condition|(
name|shootvals
operator|.
name|shoot_type
operator|==
name|SHOOT_ROOT
operator|&&
name|region
condition|)
name|shootvals
operator|.
name|shoot_type
operator|=
name|SHOOT_REGION
expr_stmt|;
if|if
condition|(
name|run
condition|)
block|{
comment|/* get the screen on which we are running */
operator|*
name|screen
operator|=
name|gtk_widget_get_screen
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_destroy
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
if|if
condition|(
name|run
condition|)
block|{
comment|/*  A short timeout to give the server a chance to       *  redraw the area that was obscured by our dialog.       */
name|g_timeout_add
argument_list|(
literal|100
argument_list|,
operator|(
name|GSourceFunc
operator|)
name|gtk_main_quit
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
if|if
condition|(
name|shootvals
operator|.
name|shoot_type
operator|!=
name|SHOOT_ROOT
operator|&&
operator|!
name|shootvals
operator|.
name|window_id
condition|)
block|{
name|shootvals
operator|.
name|window_id
operator|=
name|select_window
argument_list|(
operator|*
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|shootvals
operator|.
name|window_id
condition|)
return|return
name|FALSE
return|;
block|}
block|}
return|return
name|run
return|;
block|}
end_function

begin_comment
comment|/*  delay functions  */
end_comment

begin_function
name|void
DECL|function|shoot_delay (gint delay)
name|shoot_delay
parameter_list|(
name|gint
name|delay
parameter_list|)
block|{
name|g_timeout_add
argument_list|(
literal|1000
argument_list|,
name|shoot_delay_callback
argument_list|,
operator|&
name|delay
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|gboolean
DECL|function|shoot_delay_callback (gpointer data)
name|shoot_delay_callback
parameter_list|(
name|gpointer
name|data
parameter_list|)
block|{
name|gint
modifier|*
name|seconds_left
init|=
name|data
decl_stmt|;
operator|(
operator|*
name|seconds_left
operator|)
operator|--
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|seconds_left
condition|)
name|gtk_main_quit
argument_list|()
expr_stmt|;
return|return
operator|*
name|seconds_left
return|;
block|}
end_function

end_unit

