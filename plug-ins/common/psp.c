begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP plug-in to load and save Paint Shop Pro files (.PSP)  *  * Copyright (C) 1999 Tor Lillqvist  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/*  *  * Work in progress! Doesn't do anything at all useful yet.  *  */
end_comment

begin_comment
comment|/* set to the level of debugging output you want, 0 for none */
end_comment

begin_define
DECL|macro|PSP_DEBUG
define|#
directive|define
name|PSP_DEBUG
value|2
end_define

begin_comment
comment|/* the max number of layers that this plugin should try to load */
end_comment

begin_define
DECL|macro|MAX_LAYERS
define|#
directive|define
name|MAX_LAYERS
value|64
end_define

begin_define
DECL|macro|IFDBG (level)
define|#
directive|define
name|IFDBG
parameter_list|(
name|level
parameter_list|)
value|if (PSP_DEBUG>= level)
end_define

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<glib.h>
end_include

begin_comment
comment|/* We want glib.h first for some pretty obscure 				 * Win32 compilation issues. 				 */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/stdplugins-intl.h>
end_include

begin_define
DECL|macro|gimp_message_printf (x)
define|#
directive|define
name|gimp_message_printf
parameter_list|(
name|x
parameter_list|)
define|\
value|do { \     gchar *_t = g_strdup_printf x; \     gimp_message (_t); \     g_free (_t); \   } while (0)
end_define

begin_comment
comment|/* The following was cut and pasted from the PSP file format  * documentation version 3.0.  * (Minor stylistic changes done.)  */
end_comment

begin_comment
comment|/*  * To be on the safe side, here is the whole copyright notice from the  * specification:  *  * The Paint Shop Pro File Format Specification (the  * *Specification*) is copyright 1998 by Jasc Software,  * Inc. Jasc grants you a nonexclusive license to use the  * Specification for the sole purposes of developing software  * products(s) incorporating the Specification. You are also granted  * the right to identify your software product(s) as incorporating the  * Paint Shop Pro Format (PSP) provided that your software in  * incorporating the Specification complies with the terms,  * definitions, constraints and specifications contained in the  * Specification and subject to the following: DISCLAIMER OF  * WARRANTIES. THE SPECIFICATION IS PROVIDED AS IS. JASC  * DISCLAIMS ALL OTHER WARRANTIES, EXPRESS OR IMPLIED, INCLUDING, BUT  * NOT LIMITED TO, ANY IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS  * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  *  * You are solely responsible for the selection, use, efficiency and  * suitability of the Specification for your software products.  OTHER  * WARRANTIES EXCLUDED. JASC SHALL NOT BE LIABLE FOR ANY DIRECT,  * INDIRECT, CONSEQUENTIAL, EXEMPLARY, PUNITIVE OR INCIDENTAL DAMAGES  * ARISING FROM ANY CAUSE EVEN IF JASC HAS BEEN ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGES. CERTAIN JURISDICTIONS DO NOT PERMIT  * THE LIMITATION OR EXCLUSION OF INCIDENTAL DAMAGES, SO THIS  * LIMITATION MAY NOT APPLY TO YOU.  IN NO EVENT WILL JASC BE LIABLE  * FOR ANY AMOUNT GREATER THAN WHAT YOU ACTUALLY PAID FOR THE  * SPECIFICATION. Should any warranties be found to exist, such  * warranties shall be limited in duration to ninety (90) days  * following the date you receive the Specification.  *  * Indemnification. By your inclusion of the Paint Shop Pro File  * Format in your software product(s) you agree to indemnify and hold  * Jasc Software, Inc. harmless from any and all claims of any kind or  * nature made by any of your customers with respect to your software  * product(s).  *  * Export Laws. You agree that you and your customers will not export  * your software or Specification except in compliance with the laws  * and regulations of the United States.  *  * US Government Restricted Rights. The Specification and any  * accompanying materials are provided with Restricted Rights. Use,  * duplication or disclosure by the Government is subject to  * restrictions as set forth in subparagraph (c)(1)(ii) of The Rights  * in Technical Data and Computer Software clause at DFARS  * 252.227-7013, or subparagraphs (c)(1) and (2) of the Commercial  * Computer Software - Restricted Rights at 48 CFR 52.227-19, as  * applicable. Contractor/manufacturer is Jasc Software, Inc., PO Box  * 44997, Eden Prairie MN 55344.  *  * Jasc reserves the right to amend, modify, change, revoke or  * withdraw the Specification at any time and from time to time. Jasc  * shall have no obligation to support or maintain the Specification.  */
end_comment

begin_comment
comment|/* Block identifiers.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910103
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_IMAGE_BLOCK
name|PSP_IMAGE_BLOCK
init|=
literal|0
block|,
comment|/* General Image Attributes Block (main) */
DECL|enumerator|PSP_CREATOR_BLOCK
name|PSP_CREATOR_BLOCK
block|,
comment|/* Creator Data Block (main) */
DECL|enumerator|PSP_COLOR_BLOCK
name|PSP_COLOR_BLOCK
block|,
comment|/* Color Palette Block (main and sub) */
DECL|enumerator|PSP_LAYER_START_BLOCK
name|PSP_LAYER_START_BLOCK
block|,
comment|/* Layer Bank Block (main) */
DECL|enumerator|PSP_LAYER_BLOCK
name|PSP_LAYER_BLOCK
block|,
comment|/* Layer Block (sub) */
DECL|enumerator|PSP_CHANNEL_BLOCK
name|PSP_CHANNEL_BLOCK
block|,
comment|/* Channel Block (sub) */
DECL|enumerator|PSP_SELECTION_BLOCK
name|PSP_SELECTION_BLOCK
block|,
comment|/* Selection Block (main) */
DECL|enumerator|PSP_ALPHA_BANK_BLOCK
name|PSP_ALPHA_BANK_BLOCK
block|,
comment|/* Alpha Bank Block (main) */
DECL|enumerator|PSP_ALPHA_CHANNEL_BLOCK
name|PSP_ALPHA_CHANNEL_BLOCK
block|,
comment|/* Alpha Channel Block (sub) */
DECL|enumerator|PSP_THUMBNAIL_BLOCK
name|PSP_THUMBNAIL_BLOCK
block|,
comment|/* Thumbnail Block (main) */
DECL|enumerator|PSP_EXTENDED_DATA_BLOCK
name|PSP_EXTENDED_DATA_BLOCK
block|,
comment|/* Extended Data Block (main) */
DECL|enumerator|PSP_TUBE_BLOCK
name|PSP_TUBE_BLOCK
comment|/* Picture Tube Data Block (main) */
DECL|typedef|PSPBlockID
block|}
name|PSPBlockID
typedef|;
end_typedef

begin_comment
comment|/* Bitmap type.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910203
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_DIB_IMAGE
name|PSP_DIB_IMAGE
init|=
literal|0
block|,
comment|/* Layer color bitmap */
DECL|enumerator|PSP_DIB_TRANS_MASK
name|PSP_DIB_TRANS_MASK
block|,
comment|/* Layer transparency mask bitmap */
DECL|enumerator|PSP_DIB_USER_MASK
name|PSP_DIB_USER_MASK
block|,
comment|/* Layer user mask bitmap */
DECL|enumerator|PSP_DIB_SELECTION
name|PSP_DIB_SELECTION
block|,
comment|/* Selection mask bitmap */
DECL|enumerator|PSP_DIB_ALPHA_MASK
name|PSP_DIB_ALPHA_MASK
block|,
comment|/* Alpha channel mask bitmap */
DECL|enumerator|PSP_DIB_THUMBNAIL
name|PSP_DIB_THUMBNAIL
comment|/* Thumbnail bitmap */
DECL|typedef|PSPDIBType
block|}
name|PSPDIBType
typedef|;
end_typedef

begin_comment
comment|/* Channel types.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910303
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_CHANNEL_COMPOSITE
name|PSP_CHANNEL_COMPOSITE
init|=
literal|0
block|,
comment|/* Channel of single channel bitmap */
DECL|enumerator|PSP_CHANNEL_RED
name|PSP_CHANNEL_RED
block|,
comment|/* Red channel of 24 bit bitmap */
DECL|enumerator|PSP_CHANNEL_GREEN
name|PSP_CHANNEL_GREEN
block|,
comment|/* Green channel of 24 bit bitmap */
DECL|enumerator|PSP_CHANNEL_BLUE
name|PSP_CHANNEL_BLUE
comment|/* Blue channel of 24 bit bitmap */
DECL|typedef|PSPChannelType
block|}
name|PSPChannelType
typedef|;
end_typedef

begin_comment
comment|/* Possible metrics used to measure resolution.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910403
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_METRIC_UNDEFINED
name|PSP_METRIC_UNDEFINED
init|=
literal|0
block|,
comment|/* Metric unknown */
DECL|enumerator|PSP_METRIC_INCH
name|PSP_METRIC_INCH
block|,
comment|/* Resolution is in inches */
DECL|enumerator|PSP_METRIC_CM
name|PSP_METRIC_CM
comment|/* Resolution is in centimeters */
DECL|typedef|PSP_METRIC
block|}
name|PSP_METRIC
typedef|;
end_typedef

begin_comment
comment|/* Possible types of compression.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910503
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_COMP_NONE
name|PSP_COMP_NONE
init|=
literal|0
block|,
comment|/* No compression */
DECL|enumerator|PSP_COMP_RLE
name|PSP_COMP_RLE
block|,
comment|/* RLE compression */
DECL|enumerator|PSP_COMP_LZ77
name|PSP_COMP_LZ77
comment|/* LZ77 compression */
DECL|typedef|PSPCompression
block|}
name|PSPCompression
typedef|;
end_typedef

begin_comment
comment|/* Picture tube placement mode.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910603
typedef|typedef
enum|enum
block|{
DECL|enumerator|tpmRandom
name|tpmRandom
block|,
comment|/* Place tube images in random intervals */
DECL|enumerator|tpmConstant
name|tpmConstant
comment|/* Place tube images in constant intervals */
DECL|typedef|TubePlacementMode
block|}
name|TubePlacementMode
typedef|;
end_typedef

begin_comment
comment|/* Picture tube selection mode.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910703
typedef|typedef
enum|enum
block|{
DECL|enumerator|tsmRandom
name|tsmRandom
block|,
comment|/* Randomly select the next image in  */
comment|/* tube to display */
DECL|enumerator|tsmIncremental
name|tsmIncremental
block|,
comment|/* Select each tube image in turn */
DECL|enumerator|tsmAngular
name|tsmAngular
block|,
comment|/* Select image based on cursor direction */
DECL|enumerator|tsmPressure
name|tsmPressure
block|,
comment|/* Select image based on pressure  */
comment|/* (from pressure-sensitive pad) */
DECL|enumerator|tsmVelocity
name|tsmVelocity
comment|/* Select image based on cursor speed */
DECL|typedef|TubeSelectionMode
block|}
name|TubeSelectionMode
typedef|;
end_typedef

begin_comment
comment|/* Extended data field types.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910803
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_XDATA_TRNS_INDEX
name|PSP_XDATA_TRNS_INDEX
init|=
literal|0
comment|/* Transparency index field */
DECL|typedef|PSPExtendedDataID
block|}
name|PSPExtendedDataID
typedef|;
end_typedef

begin_comment
comment|/* Creator field types.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910903
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_CRTR_FLD_TITLE
name|PSP_CRTR_FLD_TITLE
init|=
literal|0
block|,
comment|/* Image document title field */
DECL|enumerator|PSP_CRTR_FLD_CRT_DATE
name|PSP_CRTR_FLD_CRT_DATE
block|,
comment|/* Creation date field */
DECL|enumerator|PSP_CRTR_FLD_MOD_DATE
name|PSP_CRTR_FLD_MOD_DATE
block|,
comment|/* Modification date field */
DECL|enumerator|PSP_CRTR_FLD_ARTIST
name|PSP_CRTR_FLD_ARTIST
block|,
comment|/* Artist name field */
DECL|enumerator|PSP_CRTR_FLD_CPYRGHT
name|PSP_CRTR_FLD_CPYRGHT
block|,
comment|/* Copyright holder name field */
DECL|enumerator|PSP_CRTR_FLD_DESC
name|PSP_CRTR_FLD_DESC
block|,
comment|/* Image document description field */
DECL|enumerator|PSP_CRTR_FLD_APP_ID
name|PSP_CRTR_FLD_APP_ID
block|,
comment|/* Creating app id field */
DECL|enumerator|PSP_CRTR_FLD_APP_VER
name|PSP_CRTR_FLD_APP_VER
comment|/* Creating app version field */
DECL|typedef|PSPCreatorFieldID
block|}
name|PSPCreatorFieldID
typedef|;
end_typedef

begin_comment
comment|/* Creator application identifiers.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910a03
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_CREATOR_APP_UNKNOWN
name|PSP_CREATOR_APP_UNKNOWN
init|=
literal|0
block|,
comment|/* Creator application unknown */
DECL|enumerator|PSP_CREATOR_APP_PAINT_SHOP_PRO
name|PSP_CREATOR_APP_PAINT_SHOP_PRO
comment|/* Creator is Paint Shop Pro */
DECL|typedef|PSPCreatorAppID
block|}
name|PSPCreatorAppID
typedef|;
end_typedef

begin_comment
comment|/* Layer types.  */
end_comment

begin_typedef
DECL|enum|__anon2c3873910b03
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_LAYER_NORMAL
name|PSP_LAYER_NORMAL
init|=
literal|0
block|,
comment|/* Normal layer */
DECL|enumerator|PSP_LAYER_FLOATING_SELECTION
name|PSP_LAYER_FLOATING_SELECTION
comment|/* Floating selection layer */
DECL|typedef|PSPLayerType
block|}
name|PSPLayerType
typedef|;
end_typedef

begin_comment
comment|/* Truth values.  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FALSE and TRUE taken by GLib */
end_comment

begin_else
unit|typedef enum {   FALSE = 0,   TRUE } PSP_BOOLEAN;
else|#
directive|else
end_else

begin_typedef
DECL|typedef|PSP_BOOLEAN
typedef|typedef
name|gboolean
name|PSP_BOOLEAN
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* End of cut&paste from psp spec */
end_comment

begin_comment
comment|/* We store the various PSP data in own structures. Of course,  * we cannot read struct directly from the file because of  * struct alignment issues.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2c3873910c08
block|{
DECL|member|width
DECL|member|height
name|guint32
name|width
decl_stmt|,
name|height
decl_stmt|;
DECL|member|resolution
name|gdouble
name|resolution
decl_stmt|;
DECL|member|compression
name|PSPCompression
name|compression
decl_stmt|;
DECL|member|depth
name|guint16
name|depth
decl_stmt|;
DECL|member|greyscale
name|gboolean
name|greyscale
decl_stmt|;
DECL|member|active_layer
name|guint32
name|active_layer
decl_stmt|;
DECL|member|layer_count
name|guint16
name|layer_count
decl_stmt|;
DECL|typedef|PSPimage
block|}
name|PSPimage
typedef|;
end_typedef

begin_comment
comment|/* Declare some local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|load_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|save_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Various local variables...  */
end_comment

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc */
name|NULL
block|,
comment|/* quit_proc */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|prog_name
specifier|static
specifier|const
name|gchar
modifier|*
name|prog_name
init|=
literal|"PSP"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Save info  */
end_comment

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2c3873910d08
block|{
DECL|member|compression
name|PSPCompression
name|compression
decl_stmt|;
DECL|typedef|PSPSaveVals
block|}
name|PSPSaveVals
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2c3873910e08
block|{
DECL|member|run
name|gint
name|run
decl_stmt|;
comment|/*  run  */
DECL|typedef|PSPSaveInterface
block|}
name|PSPSaveInterface
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|psvals
specifier|static
name|PSPSaveVals
name|psvals
init|=
block|{
name|TRUE
comment|/* raw? or ascii */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|psint
specifier|static
name|PSPSaveInterface
name|psint
init|=
block|{
name|FALSE
comment|/* run */
block|}
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|()
block|{
specifier|static
name|GParamDef
name|load_args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to load"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"raw_filename"
block|,
literal|"The name of the file to load"
block|}
block|,   }
decl_stmt|;
specifier|static
name|GParamDef
name|load_return_vals
index|[]
init|=
block|{
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Output image"
block|}
block|,   }
decl_stmt|;
specifier|static
name|int
name|nload_args
init|=
sizeof|sizeof
argument_list|(
name|load_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|load_args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|int
name|nload_return_vals
init|=
sizeof|sizeof
argument_list|(
name|load_return_vals
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|load_return_vals
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|GParamDef
name|save_args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Input image"
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Drawable to save"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to save the image in"
block|}
block|,
block|{
name|PARAM_STRING
block|,
literal|"raw_filename"
block|,
literal|"The name of the file to save the image in"
block|}
block|,
block|{
name|PARAM_INT32
block|,
literal|"compression"
block|,
literal|"Specify 0 for no compression, "
literal|"1 for RLE, and 2 for LZ77"
block|}
block|}
decl_stmt|;
specifier|static
name|int
name|nsave_args
init|=
sizeof|sizeof
argument_list|(
name|save_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|save_args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"file_psp_load"
argument_list|,
literal|"loads images from the Paint Shop Pro PSP file format"
argument_list|,
literal|"This filter loads and saves images in "
literal|"Paint Shop Pro's native PSP format. "
literal|"These images may be of any type supported by GIMP, "
literal|"with or without layers, layer masks, "
literal|"or aux channels."
argument_list|,
literal|"Tor Lillqvist"
argument_list|,
literal|"Tor Lillqvist"
argument_list|,
literal|"1999"
argument_list|,
literal|"<Load>/PSP"
argument_list|,
name|NULL
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nload_args
argument_list|,
name|nload_return_vals
argument_list|,
name|load_args
argument_list|,
name|load_return_vals
argument_list|)
expr_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"file_pso_save"
argument_list|,
literal|"saves images in the Paint Shop Pro PSP file format"
argument_list|,
literal|"This filter loads and saves images in "
literal|"Paint Shop Pro's native PSP format. "
literal|"These images may be of any type supported by GIMP, "
literal|"with or without layers, layer masks, "
literal|"or aux channels."
argument_list|,
literal|"Tor Lillqvist"
argument_list|,
literal|"Tor Lillqvist"
argument_list|,
literal|"1999"
argument_list|,
literal|"<Save>/PSP"
argument_list|,
literal|"RGB*, GRAY*, INDEXED*"
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nsave_args
argument_list|,
literal|0
argument_list|,
name|save_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_register_magic_load_handler
argument_list|(
literal|"file_psp_load"
argument_list|,
literal|"psp,tub"
argument_list|,
literal|""
argument_list|,
literal|"0,string,Paint Shop Pro Image File\n\032"
argument_list|)
expr_stmt|;
name|gimp_register_save_handler
argument_list|(
literal|"file_psp_save"
argument_list|,
literal|"psp,tub"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|save_toggle_update (GtkWidget * widget,gpointer data)
name|save_toggle_update
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
modifier|*
name|toggle_val
decl_stmt|;
name|toggle_val
operator|=
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
operator|->
name|active
condition|)
operator|*
name|toggle_val
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|toggle_val
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|save_close_callback (GtkWidget * widget,gpointer data)
name|save_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gtk_main_quit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|save_ok_callback (GtkWidget * widget,gpointer data)
name|save_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|psint
operator|.
name|run
operator|=
name|TRUE
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|GTK_WIDGET
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|save_dialog ()
name|save_dialog
parameter_list|()
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle_vbox
decl_stmt|;
name|GSList
modifier|*
name|group
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|argv
decl_stmt|;
name|gint
name|argc
decl_stmt|;
name|gint
name|use_none
init|=
operator|(
name|psvals
operator|.
name|compression
operator|==
name|PSP_COMP_NONE
operator|)
decl_stmt|;
name|gint
name|use_rle
init|=
operator|(
name|psvals
operator|.
name|compression
operator|==
name|PSP_COMP_RLE
operator|)
decl_stmt|;
name|gint
name|use_lz77
init|=
operator|(
name|psvals
operator|.
name|compression
operator|==
name|PSP_COMP_LZ77
operator|)
decl_stmt|;
name|argc
operator|=
literal|1
expr_stmt|;
name|argv
operator|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
name|g_strdup
argument_list|(
literal|"save"
argument_list|)
expr_stmt|;
name|gtk_init
argument_list|(
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|gtk_rc_parse
argument_list|(
name|gimp_gtkrc
argument_list|()
argument_list|)
expr_stmt|;
name|dlg
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"Save as PSP"
argument_list|)
expr_stmt|;
name|gtk_window_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|save_close_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*  Action area  */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"OK"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|save_ok_callback
argument_list|,
name|dlg
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Cancel"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect_object
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gtk_widget_destroy
argument_list|,
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
comment|/*  file save type  */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
literal|"Data Compression"
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|toggle_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|toggle_vbox
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|toggle_vbox
argument_list|)
expr_stmt|;
name|group
operator|=
name|NULL
expr_stmt|;
name|toggle
operator|=
name|gtk_radio_button_new_with_label
argument_list|(
name|group
argument_list|,
literal|"None"
argument_list|)
expr_stmt|;
name|group
operator|=
name|gtk_radio_button_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|toggle_vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|save_toggle_update
argument_list|,
operator|&
name|use_none
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|use_none
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_radio_button_new_with_label
argument_list|(
name|group
argument_list|,
literal|"RLE"
argument_list|)
expr_stmt|;
name|group
operator|=
name|gtk_radio_button_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|toggle_vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|save_toggle_update
argument_list|,
operator|&
name|use_rle
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|use_rle
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_radio_button_new_with_label
argument_list|(
name|group
argument_list|,
literal|"LZ77"
argument_list|)
expr_stmt|;
name|group
operator|=
name|gtk_radio_button_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|toggle_vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"toggled"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|save_toggle_update
argument_list|,
operator|&
name|use_lz77
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|use_lz77
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle_vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
if|if
condition|(
name|use_none
condition|)
name|psvals
operator|.
name|compression
operator|=
name|PSP_COMP_NONE
expr_stmt|;
elseif|else
if|if
condition|(
name|use_rle
condition|)
name|psvals
operator|.
name|compression
operator|=
name|PSP_COMP_RLE
expr_stmt|;
else|else
name|psvals
operator|.
name|compression
operator|=
name|PSP_COMP_LZ77
expr_stmt|;
return|return
name|psint
operator|.
name|run
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|block_name (int id)
name|block_name
parameter_list|(
name|int
name|id
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|block_names
index|[]
init|=
block|{
literal|"IMAGE"
block|,
literal|"CREATOR"
block|,
literal|"COLOR"
block|,
literal|"LAYER_START"
block|,
literal|"LAYER"
block|,
literal|"CHANNEL"
block|,
literal|"SELECTION"
block|,
literal|"ALPHA_BANK"
block|,
literal|"ALPHA_CHANNEL"
block|,
literal|"THUMBNAIL"
block|,
literal|"EXTENDED_DATA"
block|,
literal|"TUBE"
block|}
decl_stmt|;
specifier|static
name|gchar
modifier|*
name|err_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|id
operator|>=
literal|0
operator|&&
name|id
operator|<=
name|PSP_TUBE_BLOCK
condition|)
return|return
name|block_names
index|[
name|id
index|]
return|;
name|g_free
argument_list|(
name|err_name
argument_list|)
expr_stmt|;
name|err_name
operator|=
name|g_strdup_printf
argument_list|(
literal|"id=%d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
name|err_name
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|read_block_header (FILE * f,guint32 * initial_length,guint32 * total_length)
name|read_block_header
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|guint32
modifier|*
name|initial_length
parameter_list|,
name|guint32
modifier|*
name|total_length
parameter_list|)
block|{
name|guchar
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|guint16
name|id
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|id
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|initial_length
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|total_length
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Error reading block header"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
literal|"~BK\0"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Invalid block header"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|id
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|read_general_image_attribute_block (FILE * f,guint init_len,guint total_len,PSPimage * ia)
name|read_general_image_attribute_block
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|guint
name|init_len
parameter_list|,
name|guint
name|total_len
parameter_list|,
name|PSPimage
modifier|*
name|ia
parameter_list|)
block|{
name|char
name|buf
index|[
literal|6
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|G_HAVE_GINT64
name|gint64
name|res
index|[
literal|1
index|]
decl_stmt|;
else|#
directive|else
name|guchar
name|res
index|[
literal|8
index|]
decl_stmt|;
endif|#
directive|endif
name|guchar
name|metric
decl_stmt|;
name|guint16
name|compression
decl_stmt|;
name|guchar
name|greyscale
decl_stmt|;
if|if
condition|(
name|init_len
operator|<
literal|38
operator|||
name|total_len
operator|<
literal|38
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Invalid general image attribute chunk size"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|width
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|height
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|res
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|metric
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|compression
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|depth
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|buf
argument_list|,
literal|2
operator|+
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
comment|/* Skip plane and colour count */
operator|||
name|fread
argument_list|(
operator|&
name|greyscale
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
comment|/* Skip total image size */
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|active_layer
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|layer_count
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Error reading general image attribute block"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ia
operator|->
name|height
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|ia
operator|->
name|height
argument_list|)
expr_stmt|;
name|ia
operator|->
name|width
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|ia
operator|->
name|width
argument_list|)
expr_stmt|;
name|ia
operator|->
name|width
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|ia
operator|->
name|width
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|G_HAVE_GINT64
name|res
index|[
literal|0
index|]
operator|=
name|GUINT64_FROM_LE
argument_list|(
name|res
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|#
directive|else
if|#
directive|if
name|G_BYTE_ORDER
operator|==
name|G_BIG_ENDIAN
block|{
comment|/* Swap bytes in the double */
name|guchar
name|t
decl_stmt|;
name|t
operator|=
name|res
index|[
literal|0
index|]
expr_stmt|;
name|res
index|[
literal|0
index|]
operator|=
name|res
index|[
literal|7
index|]
expr_stmt|;
name|res
index|[
literal|7
index|]
operator|=
name|t
expr_stmt|;
name|t
operator|=
name|res
index|[
literal|1
index|]
expr_stmt|;
name|res
index|[
literal|1
index|]
operator|=
name|res
index|[
literal|6
index|]
expr_stmt|;
name|res
index|[
literal|6
index|]
operator|=
name|t
expr_stmt|;
name|t
operator|=
name|res
index|[
literal|2
index|]
expr_stmt|;
name|res
index|[
literal|2
index|]
operator|=
name|res
index|[
literal|5
index|]
expr_stmt|;
name|res
index|[
literal|5
index|]
operator|=
name|t
expr_stmt|;
name|t
operator|=
name|res
index|[
literal|3
index|]
expr_stmt|;
name|res
index|[
literal|3
index|]
operator|=
name|res
index|[
literal|4
index|]
expr_stmt|;
name|res
index|[
literal|4
index|]
operator|=
name|t
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
name|memcpy
argument_list|(
operator|&
name|ia
operator|->
name|resolution
argument_list|,
name|res
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|metric
operator|==
name|PSP_METRIC_CM
condition|)
name|ia
operator|->
name|resolution
operator|/=
literal|2.54
expr_stmt|;
name|ia
operator|->
name|compression
operator|=
name|compression
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|read_creator_block (FILE * f,gint image_ID,guint init_len,guint total_len,PSPimage * ia)
name|read_creator_block
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|gint
name|image_ID
parameter_list|,
name|guint
name|init_len
parameter_list|,
name|guint
name|total_len
parameter_list|,
name|PSPimage
modifier|*
name|ia
parameter_list|)
block|{
name|long
name|data_start
decl_stmt|;
name|guchar
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|guint16
name|keyword
decl_stmt|;
name|guint32
name|length
decl_stmt|;
name|gchar
modifier|*
name|string
decl_stmt|;
name|gchar
modifier|*
name|title
init|=
name|NULL
decl_stmt|,
modifier|*
name|artist
init|=
name|NULL
decl_stmt|,
modifier|*
name|copyright
init|=
name|NULL
decl_stmt|,
modifier|*
name|description
init|=
name|NULL
decl_stmt|;
name|guint32
name|dword
decl_stmt|;
name|guint32
name|cdate
init|=
literal|0
decl_stmt|,
name|mdate
init|=
literal|0
decl_stmt|,
name|appid
decl_stmt|,
name|appver
decl_stmt|;
name|GString
modifier|*
name|comment
decl_stmt|;
name|Parasite
modifier|*
name|comment_parasite
decl_stmt|;
name|data_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|comment
operator|=
name|g_string_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
name|ftell
argument_list|(
name|f
argument_list|)
operator|<
name|data_start
operator|+
name|total_len
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|keyword
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|length
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Error reading creator keyword chunk"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
literal|"~FL\0"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Invalid keyword chunk header"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|keyword
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|keyword
argument_list|)
expr_stmt|;
name|length
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|length
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|keyword
condition|)
block|{
case|case
name|PSP_CRTR_FLD_TITLE
case|:
case|case
name|PSP_CRTR_FLD_ARTIST
case|:
case|case
name|PSP_CRTR_FLD_CPYRGHT
case|:
case|case
name|PSP_CRTR_FLD_DESC
case|:
name|string
operator|=
name|g_malloc
argument_list|(
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|string
argument_list|,
name|length
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Error reading creator keyword data"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|keyword
condition|)
block|{
case|case
name|PSP_CRTR_FLD_TITLE
case|:
name|g_free
argument_list|(
name|title
argument_list|)
expr_stmt|;
name|title
operator|=
name|string
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_ARTIST
case|:
name|g_free
argument_list|(
name|artist
argument_list|)
expr_stmt|;
name|artist
operator|=
name|string
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_CPYRGHT
case|:
name|g_free
argument_list|(
name|copyright
argument_list|)
expr_stmt|;
name|copyright
operator|=
name|string
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_DESC
case|:
name|g_free
argument_list|(
name|description
argument_list|)
expr_stmt|;
name|description
operator|=
name|string
expr_stmt|;
break|break;
default|default:
name|g_free
argument_list|(
name|string
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PSP_CRTR_FLD_CRT_DATE
case|:
case|case
name|PSP_CRTR_FLD_MOD_DATE
case|:
case|case
name|PSP_CRTR_FLD_APP_ID
case|:
case|case
name|PSP_CRTR_FLD_APP_VER
case|:
if|if
condition|(
name|fread
argument_list|(
operator|&
name|dword
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Error reading creator keyword data"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|keyword
condition|)
block|{
case|case
name|PSP_CRTR_FLD_CRT_DATE
case|:
name|cdate
operator|=
name|dword
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_MOD_DATE
case|:
name|mdate
operator|=
name|dword
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_APP_ID
case|:
name|appid
operator|=
name|dword
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_APP_VER
case|:
name|appver
operator|=
name|dword
expr_stmt|;
break|break;
block|}
break|break;
default|default:
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|length
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Seek error"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|title
condition|)
block|{
name|g_string_append
argument_list|(
name|comment
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|title
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|artist
condition|)
block|{
name|g_string_append
argument_list|(
name|comment
argument_list|,
name|artist
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|artist
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|copyright
condition|)
block|{
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"Copyright "
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
name|copyright
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|copyright
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|description
condition|)
block|{
name|g_string_append
argument_list|(
name|comment
argument_list|,
name|description
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|description
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|comment
operator|->
name|len
operator|>
literal|0
condition|)
name|comment_parasite
operator|=
name|parasite_new
argument_list|(
literal|"gimp-comment"
argument_list|,
name|PARASITE_PERSISTENT
argument_list|,
name|strlen
argument_list|(
name|comment
operator|->
name|str
argument_list|)
operator|+
literal|1
argument_list|,
name|comment
operator|->
name|str
argument_list|)
expr_stmt|;
name|g_string_free
argument_list|(
name|comment
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|read_layer_block (FILE * f,gint image_ID,guint init_len,guint total_len,PSPimage * ia)
name|read_layer_block
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|gint
name|image_ID
parameter_list|,
name|guint
name|init_len
parameter_list|,
name|guint
name|total_len
parameter_list|,
name|PSPimage
modifier|*
name|ia
parameter_list|)
block|{
name|long
name|data_start
decl_stmt|;
name|int
name|sub_id
decl_stmt|;
name|guint32
name|sub_init_len
decl_stmt|,
name|sub_total_len
decl_stmt|;
name|guchar
name|name
index|[
literal|256
index|]
decl_stmt|;
name|data_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
while|while
condition|(
name|ftell
argument_list|(
name|f
argument_list|)
operator|<
name|data_start
operator|+
name|total_len
condition|)
block|{
name|sub_id
operator|=
name|read_block_header
argument_list|(
name|f
argument_list|,
operator|&
name|sub_init_len
argument_list|,
operator|&
name|sub_total_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sub_id
operator|==
operator|-
literal|1
condition|)
block|{
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|sub_id
operator|!=
name|PSP_LAYER_BLOCK
condition|)
block|{
name|gimp_message_printf
argument_list|(
operator|(
literal|"PSP: Invalid layer sub-block %s, "
literal|"should be LAYER"
operator|,
name|block_name
argument_list|(
name|sub_id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fseek
argument_list|(
name|f
argument_list|,
name|data_start
operator|+
name|total_len
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gint32
DECL|function|load_image (char * filename)
name|load_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|guint16
name|major
decl_stmt|,
name|minor
decl_stmt|;
name|PSPimage
name|ia
decl_stmt|;
name|guint32
name|initial_length
decl_stmt|,
name|total_length
decl_stmt|;
name|PSPBlockID
name|id
decl_stmt|;
name|gint
name|block_number
decl_stmt|;
name|GPixelRgn
name|pixel_rgn
decl_stmt|;
name|gint32
name|image_ID
init|=
operator|-
literal|1
decl_stmt|;
name|gint32
name|layer_ID
decl_stmt|;
name|GDrawable
modifier|*
name|drawable
decl_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|filename
argument_list|,
operator|&
name|st
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Read thePSP File Header */
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|32
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|major
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|minor
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Error reading file header"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
literal|"Paint Shop Pro Image File\n\032\0\0\0\0\0"
argument_list|,
literal|32
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Incorrect file signature"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|GUINT16_FROM_LE
argument_list|(
name|major
argument_list|)
operator|!=
literal|3
operator|||
name|GUINT16_FROM_LE
argument_list|(
name|minor
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|gimp_message_printf
argument_list|(
operator|(
literal|"PSP: Unknown file format version %d.%d, only knows 3.0"
operator|,
name|GUINT16_FROM_LE
argument_list|(
name|major
argument_list|)
operator|,
name|GUINT16_FROM_LE
argument_list|(
name|minor
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Read all the blocks */
name|block_number
operator|=
literal|0
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|gimp_message_printf
argument_list|(
operator|(
literal|"PSP: size = %d"
operator|,
name|st
operator|.
name|st_size
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|ftell
argument_list|(
name|f
argument_list|)
operator|!=
name|st
operator|.
name|st_size
operator|&&
operator|(
name|id
operator|=
name|read_block_header
argument_list|(
name|f
argument_list|,
operator|&
name|initial_length
argument_list|,
operator|&
name|total_length
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|long
name|data_start
decl_stmt|;
name|long
name|handled_data_end
decl_stmt|;
name|data_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|gimp_message_printf
argument_list|(
operator|(
literal|"PSP: %s, data_start = %d"
operator|,
name|block_name
argument_list|(
name|id
argument_list|)
operator|,
name|data_start
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|PSP_IMAGE_BLOCK
condition|)
block|{
if|if
condition|(
name|block_number
operator|!=
literal|0
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Duplicate General Image Attributes block"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|read_general_image_attribute_block
argument_list|(
name|f
argument_list|,
name|initial_length
argument_list|,
name|total_length
argument_list|,
operator|&
name|ia
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|gimp_message_printf
argument_list|(
operator|(
literal|"PSP: resolution: %d dpi "
literal|"width: %d height %d"
operator|,
operator|(
name|int
operator|)
name|ia
operator|.
name|resolution
operator|,
name|ia
operator|.
name|width
operator|,
name|ia
operator|.
name|height
operator|)
argument_list|)
expr_stmt|;
name|image_ID
operator|=
name|gimp_image_new
argument_list|(
name|ia
operator|.
name|width
argument_list|,
name|ia
operator|.
name|height
argument_list|,
name|ia
operator|.
name|greyscale
condition|?
name|GRAY
else|:
name|RGB
argument_list|)
expr_stmt|;
if|if
condition|(
name|image_ID
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|gimp_image_set_filename
argument_list|(
name|image_ID
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gimp_image_set_resolution
argument_list|(
name|image_ID
argument_list|,
operator|(
name|int
operator|)
name|ia
operator|.
name|resolution
argument_list|,
operator|(
name|int
operator|)
name|ia
operator|.
name|resolution
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|block_number
operator|==
literal|0
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Missing General Image Attributes block"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|PSP_CREATOR_BLOCK
case|:
if|if
condition|(
name|read_creator_block
argument_list|(
name|f
argument_list|,
name|image_ID
argument_list|,
name|initial_length
argument_list|,
name|total_length
argument_list|,
operator|&
name|ia
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|PSP_COLOR_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_LAYER_START_BLOCK
case|:
if|if
condition|(
name|read_layer_block
argument_list|(
name|f
argument_list|,
name|image_ID
argument_list|,
name|initial_length
argument_list|,
name|total_length
argument_list|,
operator|&
name|ia
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|PSP_SELECTION_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_ALPHA_BANK_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_THUMBNAIL_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_EXTENDED_DATA_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_TUBE_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_LAYER_BLOCK
case|:
case|case
name|PSP_CHANNEL_BLOCK
case|:
case|case
name|PSP_ALPHA_CHANNEL_BLOCK
case|:
name|gimp_message_printf
argument_list|(
operator|(
literal|"PSP: Sub-block %s should not occur "
literal|"at main level of file"
operator|,
name|block_name
argument_list|(
name|id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|gimp_message_printf
argument_list|(
operator|(
literal|"PSP: Unrecognized block id %d"
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|data_start
operator|+
name|total_length
operator|>=
name|st
operator|.
name|st_size
condition|)
break|break;
name|handled_data_end
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|handled_data_end
operator|!=
name|data_start
operator|+
name|total_length
condition|)
block|{
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|gimp_message_printf
argument_list|(
operator|(
literal|"PSP: Seeking to %d + %d"
operator|,
name|data_start
operator|,
name|total_length
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|data_start
operator|+
name|total_length
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|gimp_message
argument_list|(
literal|"PSP: Seek failed"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|block_number
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|id
operator|==
operator|-
literal|1
condition|)
block|{
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|image_ID
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|save_image (char * filename,gint32 image_ID,gint32 drawable_ID)
name|save_image
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|)
block|{
return|return
literal|42
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (char * name,int nparams,GParam * param,int * nreturn_vals,GParam ** return_vals)
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GParam
name|values
index|[
literal|2
index|]
decl_stmt|;
name|GRunModeType
name|run_mode
decl_stmt|;
name|GStatusType
name|status
init|=
name|STATUS_SUCCESS
decl_stmt|;
name|gint32
name|image_ID
decl_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|PARAM_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"file_psp_load"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|image_ID
operator|=
name|load_image
argument_list|(
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|image_ID
operator|!=
operator|-
literal|1
condition|)
block|{
operator|*
name|nreturn_vals
operator|=
literal|2
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_SUCCESS
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|PARAM_IMAGE
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
operator|=
name|image_ID
expr_stmt|;
block|}
else|else
block|{
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"file_psp_save"
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|RUN_INTERACTIVE
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
literal|"file_pnm_save"
argument_list|,
operator|&
name|psvals
argument_list|)
expr_stmt|;
comment|/*  First acquire information with a dialog  */
if|if
condition|(
operator|!
name|save_dialog
argument_list|()
condition|)
return|return;
break|break;
case|case
name|RUN_NONINTERACTIVE
case|:
comment|/*  Make sure all the arguments are there!  */
if|if
condition|(
name|nparams
operator|!=
literal|6
operator|||
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
operator|<
literal|0
operator|||
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
operator|>
name|PSP_COMP_LZ77
condition|)
name|status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|STATUS_SUCCESS
condition|)
block|{
name|psvals
operator|.
name|compression
operator|=
operator|(
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
block|}
case|case
name|RUN_WITH_LAST_VALS
case|:
name|gimp_get_data
argument_list|(
literal|"file_psp_save"
argument_list|,
operator|&
name|psvals
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|STATUS_SUCCESS
condition|)
block|{
if|if
condition|(
name|save_image
argument_list|(
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|,
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_int32
argument_list|)
condition|)
block|{
name|gimp_set_data
argument_list|(
literal|"file_psp_save"
argument_list|,
operator|&
name|psvals
argument_list|,
sizeof|sizeof
argument_list|(
name|PSPSaveVals
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|STATUS_SUCCESS
expr_stmt|;
block|}
else|else
name|status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
block|}
block|}
end_function

end_unit

