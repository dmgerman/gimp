begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  * Copyright (C) 1997 Daniel Risacher  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/*  *   GUMP - Gimp Useless Mail Plugin (or Gump Useless Mail Plugin if  *   you prefer) version about .85 I would say... give or take a few  *   decimal points  *  *  *   by Adrian Likins<adrian@gimp.org>  *      MIME encapsulation by Reagan Blundell<reagan@emails.net>  *  *  *  *   Based heavily on gz.c by Daniel Risacher  *  *     Lets you choose to send a image to the mail from the file save  *     as dialog.  images are piped to uuencode and then to mail...  *  *  *   This works fine for .99.10. I havent actually tried it in  *   combination with the gz plugin, but it works with all other file  *   types. I will eventually get around to making sure it works with  *   gz.  *  *  To use: 1) image->File->mail image  *          2) when the mail dialog popups up, fill it out. Only to:  *             and filename are required note: the filename needs to a  *             type that the image can be saved as. otherwise you will  *             just send an empty message.  *          3) click ok and it should be on its way  *  *  * NOTE: You probabaly need sendmail installed. If your sendmail is in  *       an odd spot you can change the #define below. If you use  *       qmail or other MTA's, and this works after changing the  *       MAILER, let me know how well or what changes were needed.  *  * NOTE: Uuencode is needed. If it is in the path, it should work fine  *       as is. Other- wise just change the UUENCODE.  *  *  * TODO: 1) the aforementioned abilty to specify the  *           uuencode filename                         *done*  *       2) someway to do this without tmp files  *              * wont happen anytime soon*  *       3) MIME? *done*  *       4) a pointlessly snazzier dialog  *       5) make sure it works with gz  *               * works for .xcfgz but not .xcf.gz *  *       6) add an option to choose if mail get  *          uuencode or not (or MIME'ed for that matter)  *       7) realtime preview  *       8) better entry for comments    *done*  *       9) list of frequently used addreses  *      10) openGL compliance  *      11) better handling of filesave errors  *  *  * As always: The utility of this plugin is left as an exercise for  * the reader  *  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_comment
comment|/* GdkPixbuf RGBA C-Source image dump 1-byte-run-length-encoded */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__SUNPRO_C
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|align
name|4
name|(
name|mail_icon
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_decl_stmt
DECL|variable|mail_icon
specifier|static
specifier|const
name|guint8
name|mail_icon
index|[]
name|__attribute__
argument_list|(
operator|(
name|__aligned__
argument_list|(
literal|4
argument_list|)
operator|)
argument_list|)
init|=
else|#
directive|else
specifier|static
specifier|const
name|guint8
name|mail_icon
index|[]
operator|=
endif|#
directive|endif
block|{
literal|""
comment|/* Pixbuf magic (0x47646b50) */
literal|"GdkP"
comment|/* length: header (24) + pixel_data (473) */
literal|"\0\0\1\361"
comment|/* pixdata_type (0x2010002) */
literal|"\2\1\0\2"
comment|/* rowstride (64) */
literal|"\0\0\0@"
comment|/* width (16) */
literal|"\0\0\0\20"
comment|/* height (16) */
literal|"\0\0\0\20"
comment|/* pixel_data: */
literal|"\261\0\0\0\0\3\0\0\0e\0\0\0\377\40\40\40\377\211\0\0\0\377\1\0\0\0e\203"
literal|"\0\0\0\0\2\0\0\0\377ttt\377\211\365\365\365\377\2DDD\377\0\0\0\377\203"
literal|"\0\0\0\0\15\0\0\0\377\365\365\365\377ggg\377\361\361\361\377\343\343"
literal|"\343\377\365\365\365\377\343\343\343\377\363\363\363\377\343\343\343"
literal|"\377\330\330\330\377VVV\377\270\270\270\377\0\0\0\377\203\0\0\0\0\15"
literal|"\0\0\0\377\365\365\365\377\343\343\343\377hhh\377\363\363\363\377\345"
literal|"\345\345\377\362\362\362\377\343\343\343\377\326\326\326\377YYY\377\326"
literal|"\326\326\377\260\260\260\377\0\0\0\377\203\0\0\0\0\2\0\0\0\377\365\365"
literal|"\365\377\202\343\343\343\377\11eee\377\363\363\363\377\343\343\343\377"
literal|"\333\333\333\377YYY\377\343\343\343\377\323\323\323\377\260\260\260\377"
literal|"\0\0\0\377\203\0\0\0\0\15\0\0\0\377\365\365\365\377\343\343\343\377\336"
literal|"\336\336\377\177\177\177\377YYY\377\365\365\365\377YYY\377nnn\377\330"
literal|"\330\330\377\306\306\306\377\257\257\257\377\0\0\0\377\203\0\0\0\0\4"
literal|"\0\0\0\377\365\365\365\377\340\340\340\377yyy\377\202\343\343\343\377"
literal|"\1YYY\377\202\333\333\333\377\4eee\377\266\266\266\377\257\257\257\377"
literal|"\0\0\0\377\203\0\0\0\0\15\0\0\0\377\365\365\365\377{{{\377\343\343\343"
literal|"\377\323\323\323\377\334\334\334\377\325\325\325\377\333\333\333\377"
literal|"\324\324\324\377\270\270\270\377JJJ\377\265\265\265\377\0\0\0\377\203"
literal|"\0\0\0\0\3\0\0\0\377ZZZ\377\252\252\252\377\203\253\253\253\377\1\252"
literal|"\252\252\377\202\254\254\254\377\4\255\255\255\377\262\262\262\377DD"
literal|"D\377\0\0\0\377\203\0\0\0\0\1\0\0\0e\213\0\0\0\377\1\0\0\0e\262\0\0\0"
literal|"\0"
block|}
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|SENDMAIL
end_ifndef

begin_define
DECL|macro|SENDMAIL
define|#
directive|define
name|SENDMAIL
value|"/usr/lib/sendmail"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|UUENCODE
end_ifndef

begin_define
DECL|macro|UUENCODE
define|#
directive|define
name|UUENCODE
value|"uuencode"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_enum
enum|enum
DECL|enum|__anon27dea4560103
block|{
DECL|enumerator|ENCAPSULATION_UUENCODE
name|ENCAPSULATION_UUENCODE
block|,
DECL|enumerator|ENCAPSULATION_MIME
name|ENCAPSULATION_MIME
block|}
enum|;
end_enum

begin_define
DECL|macro|BUFFER_SIZE
define|#
directive|define
name|BUFFER_SIZE
value|256
end_define

begin_define
DECL|macro|PLUG_IN_NAME
define|#
directive|define
name|PLUG_IN_NAME
value|"plug_in_mail_image"
end_define

begin_define
DECL|macro|HELP_ID
define|#
directive|define
name|HELP_ID
value|"plug-in-mail-image"
end_define

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon27dea4560208
block|{
DECL|member|receipt
name|gchar
name|receipt
index|[
name|BUFFER_SIZE
index|]
decl_stmt|;
DECL|member|subject
name|gchar
name|subject
index|[
name|BUFFER_SIZE
index|]
decl_stmt|;
DECL|member|comment
name|gchar
name|comment
index|[
name|BUFFER_SIZE
index|]
decl_stmt|;
DECL|member|from
name|gchar
name|from
index|[
name|BUFFER_SIZE
index|]
decl_stmt|;
DECL|member|filename
name|gchar
name|filename
index|[
name|BUFFER_SIZE
index|]
decl_stmt|;
DECL|member|encapsulation
name|gint
name|encapsulation
decl_stmt|;
DECL|typedef|m_info
block|}
name|m_info
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GimpPDBStatusType
name|save_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|gint32
name|run_mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|save_dialog
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mail_entry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gchar
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mesg_body_callback
parameter_list|(
name|GtkTextBuffer
modifier|*
name|buffer
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|valid_file
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|create_headers
parameter_list|(
name|FILE
modifier|*
name|mailpipe
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gchar
modifier|*
name|find_extension
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|to64
parameter_list|(
name|FILE
modifier|*
name|infile
parameter_list|,
name|FILE
modifier|*
name|outfile
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|output64chunk
parameter_list|(
name|gint
name|c1
parameter_list|,
name|gint
name|c2
parameter_list|,
name|gint
name|c3
parameter_list|,
name|gint
name|pads
parameter_list|,
name|FILE
modifier|*
name|outfile
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|sane_dup2
parameter_list|(
name|gint
name|fd1
parameter_list|,
name|gint
name|fd2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|FILE
modifier|*
name|sendmail_pipe
parameter_list|(
name|gchar
modifier|*
modifier|*
name|cmd
parameter_list|,
name|gint
modifier|*
name|pid
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc  */
name|NULL
block|,
comment|/* quit_proc  */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc   */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mail_info
specifier|static
name|m_info
name|mail_info
init|=
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|,
name|ENCAPSULATION_MIME
block|,
comment|/* Change this to ENCAPSULATION_UUENCODE 			  if you prefer that as the default */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mesg_body
specifier|static
name|gchar
modifier|*
name|mesg_body
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|GimpParamDef
name|args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Input image"
block|}
block|,
block|{
name|GIMP_PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Drawable to save"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to save the image in"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"receipt"
block|,
literal|"The email address to send to"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"from"
block|,
literal|"The email address for the From: field"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"subject"
block|,
literal|"The subject"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"comment"
block|,
literal|"The Comment"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"encapsulation"
block|,
literal|"Uuencode, MIME"
block|}
block|}
decl_stmt|;
name|gimp_install_procedure
argument_list|(
name|PLUG_IN_NAME
argument_list|,
literal|"pipe files to uuencode then mail them"
argument_list|,
literal|"You need to have uuencode and mail installed"
argument_list|,
literal|"Adrian Likins, Reagan Blundell"
argument_list|,
literal|"Adrian Likins, Reagan Blundell, Daniel Risacher, "
literal|"Spencer Kimball and Peter Mattis"
argument_list|,
literal|"1995-1997"
argument_list|,
name|N_
argument_list|(
literal|"_Mail Image..."
argument_list|)
argument_list|,
literal|"RGB*, GRAY*, INDEXED*"
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|args
argument_list|)
argument_list|,
literal|0
argument_list|,
name|args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_plugin_menu_register
argument_list|(
name|PLUG_IN_NAME
argument_list|,
literal|"<Image>/File/Send"
argument_list|)
expr_stmt|;
name|gimp_plugin_icon_register
argument_list|(
name|PLUG_IN_NAME
argument_list|,
name|GIMP_ICON_TYPE_INLINE_PIXBUF
argument_list|,
name|mail_icon
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GimpParam
name|values
index|[
literal|2
index|]
decl_stmt|;
name|GimpRunMode
name|run_mode
decl_stmt|;
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
name|gint32
name|image_ID
decl_stmt|;
name|gint32
name|drawable_ID
decl_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|image_ID
operator|=
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
expr_stmt|;
name|drawable_ID
operator|=
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|PLUG_IN_NAME
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|GIMP_RUN_INTERACTIVE
case|:
name|gimp_get_data
argument_list|(
name|PLUG_IN_NAME
argument_list|,
operator|&
name|mail_info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strlen
argument_list|(
name|mail_info
operator|.
name|filename
argument_list|)
condition|)
block|{
name|gchar
modifier|*
name|filename
init|=
name|gimp_image_get_filename
argument_list|(
name|image_ID
argument_list|)
decl_stmt|;
if|if
condition|(
name|filename
condition|)
block|{
name|gchar
modifier|*
name|basename
init|=
name|g_path_get_basename
argument_list|(
name|filename
argument_list|)
decl_stmt|;
name|g_strlcpy
argument_list|(
name|mail_info
operator|.
name|filename
argument_list|,
name|basename
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|basename
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|save_dialog
argument_list|()
condition|)
name|status
operator|=
name|GIMP_PDB_CANCEL
expr_stmt|;
break|break;
case|case
name|GIMP_RUN_NONINTERACTIVE
case|:
comment|/*  Make sure all the arguments are there!  */
if|if
condition|(
name|nparams
operator|!=
literal|9
condition|)
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
else|else
block|{
name|g_strlcpy
argument_list|(
name|mail_info
operator|.
name|filename
argument_list|,
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
name|g_strlcpy
argument_list|(
name|mail_info
operator|.
name|receipt
argument_list|,
name|param
index|[
literal|4
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
name|g_strlcpy
argument_list|(
name|mail_info
operator|.
name|from
argument_list|,
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
name|g_strlcpy
argument_list|(
name|mail_info
operator|.
name|subject
argument_list|,
name|param
index|[
literal|6
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
name|g_strlcpy
argument_list|(
name|mail_info
operator|.
name|comment
argument_list|,
name|param
index|[
literal|7
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
name|mail_info
operator|.
name|encapsulation
operator|=
name|param
index|[
literal|8
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
block|}
break|break;
case|case
name|GIMP_RUN_WITH_LAST_VALS
case|:
name|gimp_get_data
argument_list|(
name|PLUG_IN_NAME
argument_list|,
operator|&
name|mail_info
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
block|{
name|status
operator|=
name|save_image
argument_list|(
name|mail_info
operator|.
name|filename
argument_list|,
name|image_ID
argument_list|,
name|drawable_ID
argument_list|,
name|run_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
name|gimp_set_data
argument_list|(
name|PLUG_IN_NAME
argument_list|,
operator|&
name|mail_info
argument_list|,
sizeof|sizeof
argument_list|(
name|m_info
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|GimpPDBStatusType
DECL|function|save_image (const gchar * filename,gint32 image_ID,gint32 drawable_ID,gint32 run_mode)
name|save_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|gint32
name|run_mode
parameter_list|)
block|{
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
name|gchar
modifier|*
name|ext
decl_stmt|;
name|gchar
modifier|*
name|tmpname
decl_stmt|;
name|gchar
modifier|*
name|mailcmd
index|[
literal|3
index|]
decl_stmt|;
name|GPid
name|mailpid
decl_stmt|;
name|pid_t
name|uupid
decl_stmt|;
name|gint
name|wpid
decl_stmt|;
name|gint
name|process_status
decl_stmt|;
name|FILE
modifier|*
name|mailpipe
decl_stmt|;
name|FILE
modifier|*
name|infile
decl_stmt|;
name|ext
operator|=
name|find_extension
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext
operator|==
name|NULL
condition|)
return|return
name|GIMP_PDB_CALLING_ERROR
return|;
comment|/* get a temp name with the right extension and save into it. */
name|tmpname
operator|=
name|gimp_temp_name
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* construct the "sendmail user@location" line */
name|mailcmd
index|[
literal|0
index|]
operator|=
name|SENDMAIL
expr_stmt|;
name|mailcmd
index|[
literal|1
index|]
operator|=
name|mail_info
operator|.
name|receipt
expr_stmt|;
name|mailcmd
index|[
literal|2
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* create a pipe to sendmail */
name|mailpipe
operator|=
name|sendmail_pipe
argument_list|(
name|mailcmd
argument_list|,
operator|&
name|mailpid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mailpipe
operator|==
name|NULL
condition|)
return|return
name|GIMP_PDB_EXECUTION_ERROR
return|;
name|create_headers
argument_list|(
name|mailpipe
argument_list|)
expr_stmt|;
comment|/* This is necessary to make the comments and headers work    * correctly. Not real sure why.    */
name|fflush
argument_list|(
name|mailpipe
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|gimp_file_save
argument_list|(
name|run_mode
argument_list|,
name|image_ID
argument_list|,
name|drawable_ID
argument_list|,
name|tmpname
argument_list|,
name|tmpname
argument_list|)
operator|&&
name|valid_file
argument_list|(
name|tmpname
argument_list|)
operator|)
condition|)
block|{
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|mail_info
operator|.
name|encapsulation
operator|==
name|ENCAPSULATION_UUENCODE
condition|)
block|{
comment|/* fork off a uuencode process */
if|if
condition|(
operator|(
name|uupid
operator|=
name|fork
argument_list|()
operator|)
operator|<
literal|0
condition|)
block|{
name|g_message
argument_list|(
literal|"fork() failed: %s"
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
name|uupid
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sane_dup2
argument_list|(
name|fileno
argument_list|(
name|mailpipe
argument_list|)
argument_list|,
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|g_message
argument_list|(
literal|"dup2() failed: %s"
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|execlp
argument_list|(
name|UUENCODE
argument_list|,
name|UUENCODE
argument_list|,
name|tmpname
argument_list|,
name|filename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* What are we doing here? exec must have failed */
name|g_message
argument_list|(
literal|"exec failed: uuencode: %s"
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|127
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpid
operator|=
name|waitpid
argument_list|(
name|uupid
argument_list|,
operator|&
name|process_status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wpid
operator|<
literal|0
operator|)
operator|||
operator|!
name|WIFEXITED
argument_list|(
name|process_status
argument_list|)
operator|||
operator|(
name|WEXITSTATUS
argument_list|(
name|process_status
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|g_message
argument_list|(
literal|"mail didn't work or something on file '%s'"
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|tmpname
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
block|}
else|else
block|{
comment|/* This must be MIME stuff. Base64 away... */
name|infile
operator|=
name|g_fopen
argument_list|(
name|tmpname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|to64
argument_list|(
name|infile
argument_list|,
name|mailpipe
argument_list|)
expr_stmt|;
comment|/* close off mime */
if|if
condition|(
name|mail_info
operator|.
name|encapsulation
operator|==
name|ENCAPSULATION_MIME
condition|)
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"\n--GUMP-MIME-boundary--\n"
argument_list|)
expr_stmt|;
block|}
goto|goto
name|cleanup
goto|;
name|error
label|:
comment|/* stop sendmail from doing anything */
name|kill
argument_list|(
name|mailpid
argument_list|,
name|SIGINT
argument_list|)
expr_stmt|;
name|status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
name|cleanup
label|:
comment|/* close out the sendmail process */
name|fclose
argument_list|(
name|mailpipe
argument_list|)
expr_stmt|;
name|waitpid
argument_list|(
name|mailpid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* delete the tmpfile that was generated */
name|g_unlink
argument_list|(
name|tmpname
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmpname
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|save_dialog (void)
name|save_dialog
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|main_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|entry
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|scrolled_window
decl_stmt|;
name|GtkWidget
modifier|*
name|text_view
decl_stmt|;
name|GtkTextBuffer
modifier|*
name|text_buffer
decl_stmt|;
name|gchar
modifier|*
name|gump_from
decl_stmt|;
name|gint
name|row
init|=
literal|0
decl_stmt|;
name|gboolean
name|run
decl_stmt|;
name|gimp_ui_init
argument_list|(
literal|"mail"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* check gimprc for a preferred "From:" address */
name|gump_from
operator|=
name|gimp_gimprc_query
argument_list|(
literal|"gump-from"
argument_list|)
expr_stmt|;
if|if
condition|(
name|gump_from
condition|)
block|{
name|g_strlcpy
argument_list|(
name|mail_info
operator|.
name|from
argument_list|,
name|gump_from
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gump_from
argument_list|)
expr_stmt|;
block|}
name|dlg
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Send as Mail"
argument_list|)
argument_list|,
literal|"mail"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|HELP_ID
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|GTK_STOCK_OK
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|main_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|main_vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|main_vbox
argument_list|)
expr_stmt|;
comment|/* table */
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|5
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/* Filename entry */
name|entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|entry
argument_list|,
literal|200
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_max_length
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|BUFFER_SIZE
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|mail_info
operator|.
name|filename
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"_Filename:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|entry
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|mail_entry_callback
argument_list|)
argument_list|,
name|mail_info
operator|.
name|filename
argument_list|)
expr_stmt|;
comment|/* Encapsulation label */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Encapsulation:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.2
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|row
argument_list|,
name|row
operator|+
literal|1
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/* Encapsulation radiobuttons */
name|vbox
operator|=
name|gimp_int_radio_group_new
argument_list|(
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_radio_button_update
argument_list|)
argument_list|,
operator|&
name|mail_info
operator|.
name|encapsulation
argument_list|,
name|mail_info
operator|.
name|encapsulation
argument_list|,
name|_
argument_list|(
literal|"_MIME"
argument_list|)
argument_list|,
name|ENCAPSULATION_MIME
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"_Uuencode"
argument_list|)
argument_list|,
name|ENCAPSULATION_UUENCODE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|vbox
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|row
argument_list|,
name|row
operator|+
literal|2
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|row
operator|+=
literal|2
expr_stmt|;
comment|/* To entry */
name|entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|entry
argument_list|,
literal|200
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_max_length
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|BUFFER_SIZE
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|mail_info
operator|.
name|receipt
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"_Recipient:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|entry
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|mail_entry_callback
argument_list|)
argument_list|,
name|mail_info
operator|.
name|receipt
argument_list|)
expr_stmt|;
name|gtk_widget_grab_focus
argument_list|(
name|entry
argument_list|)
expr_stmt|;
comment|/* From entry */
name|entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|entry
argument_list|,
literal|200
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_max_length
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|BUFFER_SIZE
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|mail_info
operator|.
name|from
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"_Sender:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|entry
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|mail_entry_callback
argument_list|)
argument_list|,
name|mail_info
operator|.
name|from
argument_list|)
expr_stmt|;
comment|/* Subject entry */
name|entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|entry
argument_list|,
literal|200
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_max_length
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|BUFFER_SIZE
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|mail_info
operator|.
name|subject
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"S_ubject:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|entry
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|mail_entry_callback
argument_list|)
argument_list|,
name|mail_info
operator|.
name|subject
argument_list|)
expr_stmt|;
comment|/* Comment entry */
name|entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|entry
argument_list|,
literal|200
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_max_length
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|BUFFER_SIZE
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|mail_info
operator|.
name|comment
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Comm_ent:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|entry
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|mail_entry_callback
argument_list|)
argument_list|,
name|mail_info
operator|.
name|comment
argument_list|)
expr_stmt|;
comment|/* Body  */
name|scrolled_window
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_shadow_type
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|scrolled_window
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|scrolled_window
argument_list|)
expr_stmt|;
name|text_buffer
operator|=
name|gtk_text_buffer_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|text_view
operator|=
name|gtk_text_view_new_with_buffer
argument_list|(
name|text_buffer
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|text_buffer
argument_list|)
expr_stmt|;
name|gtk_text_view_set_wrap_mode
argument_list|(
name|GTK_TEXT_VIEW
argument_list|(
name|text_view
argument_list|)
argument_list|,
name|GTK_WRAP_WORD
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|text_view
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|text_view
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|text_buffer
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|mesg_body_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|run
operator|=
operator|(
name|gimp_dialog_run
argument_list|(
name|GIMP_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|)
operator|==
name|GTK_RESPONSE_OK
operator|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
return|return
name|run
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|valid_file (const gchar * filename)
name|valid_file
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|)
block|{
name|int
name|stat_res
decl_stmt|;
name|struct
name|stat
name|buf
decl_stmt|;
name|stat_res
operator|=
name|g_stat
argument_list|(
name|filename
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
literal|0
operator|==
name|stat_res
operator|)
operator|&&
operator|(
name|buf
operator|.
name|st_size
operator|>
literal|0
operator|)
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|find_content_type (const gchar * filename)
name|find_content_type
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|)
block|{
comment|/* This function returns a MIME Content-type: value based on the      filename it is given.  */
specifier|const
name|gchar
modifier|*
name|type_mappings
index|[
literal|20
index|]
init|=
block|{
literal|"gif"
block|,
literal|"image/gif"
block|,
literal|"jpg"
block|,
literal|"image/jpeg"
block|,
literal|"jpeg"
block|,
literal|"image/jpeg"
block|,
literal|"tif"
block|,
literal|"image/tiff"
block|,
literal|"tiff"
block|,
literal|"image/tiff"
block|,
literal|"png"
block|,
literal|"image/png"
block|,
literal|"g3"
block|,
literal|"image/g3fax"
block|,
literal|"ps"
block|,
literal|"application/postscript"
block|,
literal|"eps"
block|,
literal|"application/postscript"
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
name|gchar
modifier|*
name|ext
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|ext
operator|=
name|find_extension
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ext
condition|)
block|{
return|return
name|g_strdup
argument_list|(
literal|"application/octet-stream"
argument_list|)
return|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|ext
operator|+=
literal|1
expr_stmt|;
while|while
condition|(
name|type_mappings
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ext
argument_list|,
name|type_mappings
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|g_strdup
argument_list|(
name|type_mappings
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
return|;
block|}
name|i
operator|+=
literal|2
expr_stmt|;
block|}
return|return
name|g_strdup_printf
argument_list|(
literal|"image/x-%s"
argument_list|,
name|ext
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|find_extension (const gchar * filename)
name|find_extension
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|)
block|{
name|gchar
modifier|*
name|filename_copy
decl_stmt|;
name|gchar
modifier|*
name|ext
decl_stmt|;
comment|/* we never free this copy - aren't we evil! */
name|filename_copy
operator|=
name|g_strdup
argument_list|(
name|filename
argument_list|)
expr_stmt|;
comment|/* find the extension, boy! */
name|ext
operator|=
name|strrchr
argument_list|(
name|filename_copy
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
if|if
condition|(
operator|!
name|ext
operator|||
name|ext
index|[
literal|1
index|]
operator|==
literal|0
operator|||
name|strchr
argument_list|(
name|ext
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"some sort of error with the file extension "
literal|"or lack thereof"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
literal|0
operator|!=
name|strcmp
argument_list|(
name|ext
argument_list|,
literal|".gz"
argument_list|)
condition|)
block|{
return|return
name|ext
return|;
block|}
else|else
block|{
comment|/* we found somehting, loop back, and look again */
operator|*
name|ext
operator|=
literal|0
expr_stmt|;
name|ext
operator|=
name|strrchr
argument_list|(
name|filename_copy
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ext
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|mail_entry_callback (GtkWidget * widget,gchar * data)
name|mail_entry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gchar
modifier|*
name|data
parameter_list|)
block|{
name|g_strlcpy
argument_list|(
name|data
argument_list|,
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|mesg_body_callback (GtkTextBuffer * buffer,gpointer data)
name|mesg_body_callback
parameter_list|(
name|GtkTextBuffer
modifier|*
name|buffer
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkTextIter
name|start_iter
decl_stmt|;
name|GtkTextIter
name|end_iter
decl_stmt|;
name|gtk_text_buffer_get_bounds
argument_list|(
name|buffer
argument_list|,
operator|&
name|start_iter
argument_list|,
operator|&
name|end_iter
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|mesg_body
argument_list|)
expr_stmt|;
name|mesg_body
operator|=
name|gtk_text_buffer_get_text
argument_list|(
name|buffer
argument_list|,
operator|&
name|start_iter
argument_list|,
operator|&
name|end_iter
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|create_headers (FILE * mailpipe)
name|create_headers
parameter_list|(
name|FILE
modifier|*
name|mailpipe
parameter_list|)
block|{
comment|/* create all the mail header stuff. Feel free to add your own */
comment|/* It is advisable to leave the X-Mailer header though, as     */
comment|/* there is a possibilty of a Gimp mail scanner/reader in the  */
comment|/* future. It will probabaly need that header.                 */
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"To: %s \n"
argument_list|,
name|mail_info
operator|.
name|receipt
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"Subject: %s \n"
argument_list|,
name|mail_info
operator|.
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|mail_info
operator|.
name|from
argument_list|)
operator|>
literal|0
condition|)
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"From: %s \n"
argument_list|,
name|mail_info
operator|.
name|from
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"X-Mailer: GIMP Useless Mail Program %s\n"
argument_list|,
name|GIMP_VERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|mail_info
operator|.
name|encapsulation
operator|==
name|ENCAPSULATION_MIME
condition|)
block|{
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"MIME-Version: 1.0\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"Content-type: multipart/mixed; "
literal|"boundary=GUMP-MIME-boundary\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mail_info
operator|.
name|encapsulation
operator|==
name|ENCAPSULATION_MIME
condition|)
block|{
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"--GUMP-MIME-boundary\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"Content-type: text/plain; charset=UTF-8\n\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|mail_info
operator|.
name|comment
argument_list|)
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
name|mail_info
operator|.
name|comment
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mesg_body
condition|)
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
name|mesg_body
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mail_info
operator|.
name|encapsulation
operator|==
name|ENCAPSULATION_MIME
condition|)
block|{
name|gchar
modifier|*
name|content
init|=
name|find_content_type
argument_list|(
name|mail_info
operator|.
name|filename
argument_list|)
decl_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"--GUMP-MIME-boundary\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"Content-type: %s\n"
argument_list|,
name|content
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"Content-transfer-encoding: base64\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"Content-disposition: attachment; filename=\"%s\"\n"
argument_list|,
name|mail_info
operator|.
name|filename
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|mailpipe
argument_list|,
literal|"Content-description: %s\n\n"
argument_list|,
name|mail_info
operator|.
name|filename
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|content
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * The following code taken from codes.c in the mpack-1.5 distribution  * by Carnegie Mellon University.  *  *  * (C) Copyright 1993,1994 by Carnegie Mellon University  * All Rights Reserved.  *  * CARNEGIE MELLON UNIVERSITY DISCLAIMS ALL WARRANTIES WITH REGARD TO  * THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS, IN NO EVENT SHALL CARNEGIE MELLON UNIVERSITY BE LIABLE  * FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN  * AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING  * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS  * SOFTWARE.  */
end_comment

begin_comment
comment|/* Copyright (c) 1991 Bell Communications Research, Inc. (Bellcore)  Permission to use, copy, modify, and distribute this material for any purpose and without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies, and that the name of Bellcore not be used in advertising or publicity pertaining to this material without the specific, prior written permission of an authorized representative of Bellcore.  BELLCORE MAKES NO REPRESENTATIONS ABOUT THE ACCURACY OR SUITABILITY OF THIS MATERIAL FOR ANY PURPOSE.  IT IS PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES.  */
end_comment

begin_decl_stmt
DECL|variable|basis_64
specifier|static
name|gchar
name|basis_64
index|[]
init|=
literal|"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|gint
DECL|function|to64 (FILE * infile,FILE * outfile)
name|to64
parameter_list|(
name|FILE
modifier|*
name|infile
parameter_list|,
name|FILE
modifier|*
name|outfile
parameter_list|)
block|{
name|gint
name|c1
decl_stmt|,
name|c2
decl_stmt|,
name|c3
decl_stmt|,
name|ct
init|=
literal|0
decl_stmt|,
name|written
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|c1
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
name|c2
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
expr_stmt|;
if|if
condition|(
name|c2
operator|==
name|EOF
condition|)
block|{
name|output64chunk
argument_list|(
name|c1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c3
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
expr_stmt|;
if|if
condition|(
name|c3
operator|==
name|EOF
condition|)
block|{
name|output64chunk
argument_list|(
name|c1
argument_list|,
name|c2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|output64chunk
argument_list|(
name|c1
argument_list|,
name|c2
argument_list|,
name|c3
argument_list|,
literal|0
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
block|}
block|}
name|ct
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|ct
operator|>
literal|71
condition|)
block|{
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|written
operator|+=
literal|73
expr_stmt|;
name|ct
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ct
condition|)
block|{
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|ct
operator|++
expr_stmt|;
block|}
return|return
name|written
operator|+
name|ct
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|output64chunk (gint c1,gint c2,gint c3,gint pads,FILE * outfile)
name|output64chunk
parameter_list|(
name|gint
name|c1
parameter_list|,
name|gint
name|c2
parameter_list|,
name|gint
name|c3
parameter_list|,
name|gint
name|pads
parameter_list|,
name|FILE
modifier|*
name|outfile
parameter_list|)
block|{
name|putc
argument_list|(
name|basis_64
index|[
name|c1
operator|>>
literal|2
index|]
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|basis_64
index|[
operator|(
operator|(
name|c1
operator|&
literal|0x3
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
operator|(
name|c2
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
index|]
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|pads
operator|==
literal|2
condition|)
block|{
name|putc
argument_list|(
literal|'='
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'='
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pads
condition|)
block|{
name|putc
argument_list|(
name|basis_64
index|[
operator|(
operator|(
name|c2
operator|&
literal|0xF
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|c3
operator|&
literal|0xC0
operator|)
operator|>>
literal|6
operator|)
index|]
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'='
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|putc
argument_list|(
name|basis_64
index|[
operator|(
operator|(
name|c2
operator|&
literal|0xF
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|c3
operator|&
literal|0xC0
operator|)
operator|>>
literal|6
operator|)
index|]
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|basis_64
index|[
name|c3
operator|&
literal|0x3F
index|]
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|sane_dup2 (gint fd1,gint fd2)
name|sane_dup2
parameter_list|(
name|gint
name|fd1
parameter_list|,
name|gint
name|fd2
parameter_list|)
block|{
name|gint
name|ret
decl_stmt|;
name|retry
label|:
name|ret
operator|=
name|dup2
argument_list|(
name|fd1
argument_list|,
name|fd2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EINTR
condition|)
goto|goto
name|retry
goto|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|FILE
modifier|*
DECL|function|sendmail_pipe (gchar ** cmd,gint * pid)
name|sendmail_pipe
parameter_list|(
name|gchar
modifier|*
modifier|*
name|cmd
parameter_list|,
name|gint
modifier|*
name|pid
parameter_list|)
block|{
name|gint
name|fd
decl_stmt|;
name|GError
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|g_spawn_async_with_pipes
argument_list|(
name|NULL
argument_list|,
name|cmd
argument_list|,
name|NULL
argument_list|,
name|G_SPAWN_DO_NOT_REAP_CHILD
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|pid
argument_list|,
operator|&
name|fd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|err
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Could not start sendmail (%s)"
argument_list|)
argument_list|,
name|err
operator|->
name|message
argument_list|)
expr_stmt|;
name|g_error_free
argument_list|(
name|err
argument_list|)
expr_stmt|;
operator|*
name|pid
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|fdopen
argument_list|(
name|fd
argument_list|,
literal|"w"
argument_list|)
return|;
block|}
end_function

end_unit

