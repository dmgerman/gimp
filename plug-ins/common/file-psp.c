begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP plug-in to load and export Paint Shop Pro files (.PSP and .TUB)  *  * Copyright (C) 1999 Tor Lillqvist  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<https://www.gnu.org/licenses/>.  */
end_comment

begin_comment
comment|/*  *  * Work in progress! Doesn't handle exporting yet.  *  * For a copy of the PSP file format documentation, surf to  * http://www.jasc.com.  *  */
end_comment

begin_define
DECL|macro|LOAD_PROC
define|#
directive|define
name|LOAD_PROC
value|"file-psp-load"
end_define

begin_define
DECL|macro|SAVE_PROC
define|#
directive|define
name|SAVE_PROC
value|"file-psp-save"
end_define

begin_define
DECL|macro|PLUG_IN_BINARY
define|#
directive|define
name|PLUG_IN_BINARY
value|"file-psp"
end_define

begin_define
DECL|macro|PLUG_IN_ROLE
define|#
directive|define
name|PLUG_IN_ROLE
value|"gimp-file-psp"
end_define

begin_comment
comment|/* set to the level of debugging output you want, 0 for none */
end_comment

begin_define
DECL|macro|PSP_DEBUG
define|#
directive|define
name|PSP_DEBUG
value|0
end_define

begin_define
DECL|macro|IFDBG (level)
define|#
directive|define
name|IFDBG
parameter_list|(
name|level
parameter_list|)
value|if (PSP_DEBUG>= level)
end_define

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<zlib.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|<libgimpbase/gimpparasiteio.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_comment
comment|/* Note that the upcoming PSP version 6 writes PSP file format version  * 4.0, but the documentation for that apparently isn't publicly  * available (yet). The format is luckily designed to be somwehat  * downward compatible, however. The semantics of many of the  * additional fields and block types can be relatively easily reverse  * engineered.  */
end_comment

begin_comment
comment|/* The following was cut and pasted from the PSP file format  * documentation version 3.0.(Minor stylistic changes done.)  *  *  * To be on the safe side, here is the whole copyright notice from the  * specification:  *  * The Paint Shop Pro File Format Specification (the Specification) is  * copyright 1998 by Jasc Software, Inc. Jasc grants you a  * nonexclusive license to use the Specification for the sole purposes  * of developing software products(s) incorporating the  * Specification. You are also granted the right to identify your  * software product(s) as incorporating the Paint Shop Pro Format  * (PSP) provided that your software in incorporating the  * Specification complies with the terms, definitions, constraints and  * specifications contained in the Specification and subject to the  * following: DISCLAIMER OF WARRANTIES. THE SPECIFICATION IS PROVIDED  * AS IS. JASC DISCLAIMS ALL OTHER WARRANTIES, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, ANY IMPLIED WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT.  *  * You are solely responsible for the selection, use, efficiency and  * suitability of the Specification for your software products.  OTHER  * WARRANTIES EXCLUDED. JASC SHALL NOT BE LIABLE FOR ANY DIRECT,  * INDIRECT, CONSEQUENTIAL, EXEMPLARY, PUNITIVE OR INCIDENTAL DAMAGES  * ARISING FROM ANY CAUSE EVEN IF JASC HAS BEEN ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGES. CERTAIN JURISDICTIONS DO NOT PERMIT  * THE LIMITATION OR EXCLUSION OF INCIDENTAL DAMAGES, SO THIS  * LIMITATION MAY NOT APPLY TO YOU.  IN NO EVENT WILL JASC BE LIABLE  * FOR ANY AMOUNT GREATER THAN WHAT YOU ACTUALLY PAID FOR THE  * SPECIFICATION. Should any warranties be found to exist, such  * warranties shall be limited in duration to ninety (90) days  * following the date you receive the Specification.  *  * Indemnification. By your inclusion of the Paint Shop Pro File  * Format in your software product(s) you agree to indemnify and hold  * Jasc Software, Inc. harmless from any and all claims of any kind or  * nature made by any of your customers with respect to your software  * product(s).  *  * Export Laws. You agree that you and your customers will not export  * your software or Specification except in compliance with the laws  * and regulations of the United States.  *  * US Government Restricted Rights. The Specification and any  * accompanying materials are provided with Restricted Rights. Use,  * duplication or disclosure by the Government is subject to  * restrictions as set forth in subparagraph (c)(1)(ii) of The Rights  * in Technical Data and Computer Software clause at DFARS  * 252.227-7013, or subparagraphs (c)(1) and (2) of the Commercial  * Computer Software - Restricted Rights at 48 CFR 52.227-19, as  * applicable. Contractor/manufacturer is Jasc Software, Inc., PO Box  * 44997, Eden Prairie MN 55344.  *  * Jasc reserves the right to amend, modify, change, revoke or  * withdraw the Specification at any time and from time to time. Jasc  * shall have no obligation to support or maintain the Specification.  */
end_comment

begin_comment
comment|/* Block identifiers.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70103
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_IMAGE_BLOCK
name|PSP_IMAGE_BLOCK
init|=
literal|0
block|,
comment|/* General Image Attributes Block (main) */
DECL|enumerator|PSP_CREATOR_BLOCK
name|PSP_CREATOR_BLOCK
block|,
comment|/* Creator Data Block (main) */
DECL|enumerator|PSP_COLOR_BLOCK
name|PSP_COLOR_BLOCK
block|,
comment|/* Color Palette Block (main and sub) */
DECL|enumerator|PSP_LAYER_START_BLOCK
name|PSP_LAYER_START_BLOCK
block|,
comment|/* Layer Bank Block (main) */
DECL|enumerator|PSP_LAYER_BLOCK
name|PSP_LAYER_BLOCK
block|,
comment|/* Layer Block (sub) */
DECL|enumerator|PSP_CHANNEL_BLOCK
name|PSP_CHANNEL_BLOCK
block|,
comment|/* Channel Block (sub) */
DECL|enumerator|PSP_SELECTION_BLOCK
name|PSP_SELECTION_BLOCK
block|,
comment|/* Selection Block (main) */
DECL|enumerator|PSP_ALPHA_BANK_BLOCK
name|PSP_ALPHA_BANK_BLOCK
block|,
comment|/* Alpha Bank Block (main) */
DECL|enumerator|PSP_ALPHA_CHANNEL_BLOCK
name|PSP_ALPHA_CHANNEL_BLOCK
block|,
comment|/* Alpha Channel Block (sub) */
DECL|enumerator|PSP_THUMBNAIL_BLOCK
name|PSP_THUMBNAIL_BLOCK
block|,
comment|/* Thumbnail Block (main) */
DECL|enumerator|PSP_EXTENDED_DATA_BLOCK
name|PSP_EXTENDED_DATA_BLOCK
block|,
comment|/* Extended Data Block (main) */
DECL|enumerator|PSP_TUBE_BLOCK
name|PSP_TUBE_BLOCK
block|,
comment|/* Picture Tube Data Block (main) */
DECL|enumerator|PSP_ADJUSTMENT_EXTENSION_BLOCK
name|PSP_ADJUSTMENT_EXTENSION_BLOCK
block|,
comment|/* Adjustment Layer Extension Block (sub) (since PSP6)*/
DECL|enumerator|PSP_VECTOR_EXTENSION_BLOCK
name|PSP_VECTOR_EXTENSION_BLOCK
block|,
comment|/* Vector Layer Extension Block (sub) (since PSP6) */
DECL|enumerator|PSP_SHAPE_BLOCK
name|PSP_SHAPE_BLOCK
block|,
comment|/* Vector Shape Block (sub) (since PSP6) */
DECL|enumerator|PSP_PAINTSTYLE_BLOCK
name|PSP_PAINTSTYLE_BLOCK
block|,
comment|/* Paint Style Block (sub) (since PSP6) */
DECL|enumerator|PSP_COMPOSITE_IMAGE_BANK_BLOCK
name|PSP_COMPOSITE_IMAGE_BANK_BLOCK
block|,
comment|/* Composite Image Bank (main) (since PSP6) */
DECL|enumerator|PSP_COMPOSITE_ATTRIBUTES_BLOCK
name|PSP_COMPOSITE_ATTRIBUTES_BLOCK
block|,
comment|/* Composite Image Attributes (sub) (since PSP6) */
DECL|enumerator|PSP_JPEG_BLOCK
name|PSP_JPEG_BLOCK
block|,
comment|/* JPEG Image Block (sub) (since PSP6) */
DECL|enumerator|PSP_LINESTYLE_BLOCK
name|PSP_LINESTYLE_BLOCK
block|,
comment|/* Line Style Block (sub) (since PSP7) */
DECL|enumerator|PSP_TABLE_BANK_BLOCK
name|PSP_TABLE_BANK_BLOCK
block|,
comment|/* Table Bank Block (main) (since PSP7) */
DECL|enumerator|PSP_TABLE_BLOCK
name|PSP_TABLE_BLOCK
block|,
comment|/* Table Block (sub) (since PSP7) */
DECL|enumerator|PSP_PAPER_BLOCK
name|PSP_PAPER_BLOCK
block|,
comment|/* Vector Table Paper Block (sub) (since PSP7) */
DECL|enumerator|PSP_PATTERN_BLOCK
name|PSP_PATTERN_BLOCK
block|,
comment|/* Vector Table Pattern Block (sub) (since PSP7) */
DECL|enumerator|PSP_GRADIENT_BLOCK
name|PSP_GRADIENT_BLOCK
block|,
comment|/* Vector Table Gradient Block (not used) (since PSP8) */
DECL|enumerator|PSP_GROUP_EXTENSION_BLOCK
name|PSP_GROUP_EXTENSION_BLOCK
block|,
comment|/* Group Layer Block (sub) (since PSP8) */
DECL|enumerator|PSP_MASK_EXTENSION_BLOCK
name|PSP_MASK_EXTENSION_BLOCK
block|,
comment|/* Mask Layer Block (sub) (since PSP8) */
DECL|enumerator|PSP_BRUSH_BLOCK
name|PSP_BRUSH_BLOCK
block|,
comment|/* Brush Data Block (main) (since PSP8) */
DECL|typedef|PSPBlockID
block|}
name|PSPBlockID
typedef|;
end_typedef

begin_comment
comment|/* Bitmap type.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70203
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_DIB_IMAGE
name|PSP_DIB_IMAGE
init|=
literal|0
block|,
comment|/* Layer color bitmap */
DECL|enumerator|PSP_DIB_TRANS_MASK
name|PSP_DIB_TRANS_MASK
block|,
comment|/* Layer transparency mask bitmap */
DECL|enumerator|PSP_DIB_USER_MASK
name|PSP_DIB_USER_MASK
block|,
comment|/* Layer user mask bitmap */
DECL|enumerator|PSP_DIB_SELECTION
name|PSP_DIB_SELECTION
block|,
comment|/* Selection mask bitmap */
DECL|enumerator|PSP_DIB_ALPHA_MASK
name|PSP_DIB_ALPHA_MASK
block|,
comment|/* Alpha channel mask bitmap */
DECL|enumerator|PSP_DIB_THUMBNAIL
name|PSP_DIB_THUMBNAIL
block|,
comment|/* Thumbnail bitmap */
DECL|enumerator|PSP_DIB_THUMBNAIL_TRANS_MASK
name|PSP_DIB_THUMBNAIL_TRANS_MASK
block|,
comment|/* Thumbnail transparency mask (since PSP6) */
DECL|enumerator|PSP_DIB_ADJUSTMENT_LAYER
name|PSP_DIB_ADJUSTMENT_LAYER
block|,
comment|/* Adjustment layer bitmap (since PSP6) */
DECL|enumerator|PSP_DIB_COMPOSITE
name|PSP_DIB_COMPOSITE
block|,
comment|/* Composite image bitmap (since PSP6) */
DECL|enumerator|PSP_DIB_COMPOSITE_TRANS_MASK
name|PSP_DIB_COMPOSITE_TRANS_MASK
block|,
comment|/* Composite image transparency (since PSP6) */
DECL|enumerator|PSP_DIB_PAPER
name|PSP_DIB_PAPER
block|,
comment|/* Paper bitmap (since PSP7) */
DECL|enumerator|PSP_DIB_PATTERN
name|PSP_DIB_PATTERN
block|,
comment|/* Pattern bitmap (since PSP7) */
DECL|enumerator|PSP_DIB_PATTERN_TRANS_MASK
name|PSP_DIB_PATTERN_TRANS_MASK
block|,
comment|/* Pattern transparency mask (since PSP7) */
DECL|typedef|PSPDIBType
block|}
name|PSPDIBType
typedef|;
end_typedef

begin_comment
comment|/* Type of image in the composite image bank block. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70303
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_IMAGE_COMPOSITE
name|PSP_IMAGE_COMPOSITE
init|=
literal|0
block|,
comment|/* Composite Image */
DECL|enumerator|PSP_IMAGE_THUMBNAIL
name|PSP_IMAGE_THUMBNAIL
block|,
comment|/* Thumbnail Image */
DECL|typedef|PSPCompositeImageType
block|}
name|PSPCompositeImageType
typedef|;
end_typedef

begin_comment
comment|/* Graphic contents flags. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70403
typedef|typedef
enum|enum
block|{
comment|/* Layer types */
DECL|enumerator|keGCRasterLayers
name|keGCRasterLayers
init|=
literal|0x00000001
block|,
comment|/* At least one raster layer */
DECL|enumerator|keGCVectorLayers
name|keGCVectorLayers
init|=
literal|0x00000002
block|,
comment|/* At least one vector layer */
DECL|enumerator|keGCAdjustmentLayers
name|keGCAdjustmentLayers
init|=
literal|0x00000004
block|,
comment|/* At least one adjustment layer */
comment|/* Additional attributes */
DECL|enumerator|keGCThumbnail
name|keGCThumbnail
init|=
literal|0x01000000
block|,
comment|/* Has a thumbnail */
DECL|enumerator|keGCThumbnailTransparency
name|keGCThumbnailTransparency
init|=
literal|0x02000000
block|,
comment|/* Thumbnail transp. */
DECL|enumerator|keGCComposite
name|keGCComposite
init|=
literal|0x04000000
block|,
comment|/* Has a composite image */
DECL|enumerator|keGCCompositeTransparency
name|keGCCompositeTransparency
init|=
literal|0x08000000
block|,
comment|/* Composite transp. */
DECL|enumerator|keGCFlatImage
name|keGCFlatImage
init|=
literal|0x10000000
block|,
comment|/* Just a background */
DECL|enumerator|keGCSelection
name|keGCSelection
init|=
literal|0x20000000
block|,
comment|/* Has a selection */
DECL|enumerator|keGCFloatingSelectionLayer
name|keGCFloatingSelectionLayer
init|=
literal|0x40000000
block|,
comment|/* Has float. selection */
DECL|enumerator|keGCAlphaChannels
name|keGCAlphaChannels
init|=
literal|0x80000000
block|,
comment|/* Has alpha channel(s) */
DECL|typedef|PSPGraphicContents
block|}
name|PSPGraphicContents
typedef|;
end_typedef

begin_comment
comment|/* Character style flags. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70503
typedef|typedef
enum|enum
block|{
DECL|enumerator|keStyleItalic
name|keStyleItalic
init|=
literal|0x00000001
block|,
comment|/* Italic property bit */
DECL|enumerator|keStyleStruck
name|keStyleStruck
init|=
literal|0x00000002
block|,
comment|/* StrikeÂ­out property bit */
DECL|enumerator|keStyleUnderlined
name|keStyleUnderlined
init|=
literal|0x00000004
block|,
comment|/* Underlined property bit */
DECL|enumerator|keStyleWarped
name|keStyleWarped
init|=
literal|0x00000008
block|,
comment|/* Warped property bit (since PSP8) */
DECL|enumerator|keStyleAntiAliased
name|keStyleAntiAliased
init|=
literal|0x00000010
block|,
comment|/* AntiÂ­aliased property bit (since PSP8) */
DECL|typedef|PSPCharacterProperties
block|}
name|PSPCharacterProperties
typedef|;
end_typedef

begin_comment
comment|/* Table type. (since PSP7)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70603
typedef|typedef
enum|enum
block|{
DECL|enumerator|keTTUndefined
name|keTTUndefined
init|=
literal|0
block|,
comment|/* Undefined table type */
DECL|enumerator|keTTGradientTable
name|keTTGradientTable
block|,
comment|/* Gradient table type */
DECL|enumerator|keTTPaperTable
name|keTTPaperTable
block|,
comment|/* Paper table type */
DECL|enumerator|keTTPatternTable
name|keTTPatternTable
comment|/* Pattern table type */
DECL|typedef|PSPTableType
block|}
name|PSPTableType
typedef|;
end_typedef

begin_comment
comment|/* Layer flags. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70703
typedef|typedef
enum|enum
block|{
DECL|enumerator|keVisibleFlag
name|keVisibleFlag
init|=
literal|0x00000001
block|,
comment|/* Layer is visible */
DECL|enumerator|keMaskPresenceFlag
name|keMaskPresenceFlag
init|=
literal|0x00000002
block|,
comment|/* Layer has a mask */
DECL|typedef|PSPLayerProperties
block|}
name|PSPLayerProperties
typedef|;
end_typedef

begin_comment
comment|/* Shape property flags. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70803
typedef|typedef
enum|enum
block|{
DECL|enumerator|keShapeAntiAliased
name|keShapeAntiAliased
init|=
literal|0x00000001
block|,
comment|/* Shape is antiÂ­aliased */
DECL|enumerator|keShapeSelected
name|keShapeSelected
init|=
literal|0x00000002
block|,
comment|/* Shape is selected */
DECL|enumerator|keShapeVisible
name|keShapeVisible
init|=
literal|0x00000004
block|,
comment|/* Shape is visible */
DECL|typedef|PSPShapeProperties
block|}
name|PSPShapeProperties
typedef|;
end_typedef

begin_comment
comment|/* Polyline node type flags. (since PSP7)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70903
typedef|typedef
enum|enum
block|{
DECL|enumerator|keNodeUnconstrained
name|keNodeUnconstrained
init|=
literal|0x0000
block|,
comment|/* Default node type */
DECL|enumerator|keNodeSmooth
name|keNodeSmooth
init|=
literal|0x0001
block|,
comment|/* Node is smooth */
DECL|enumerator|keNodeSymmetric
name|keNodeSymmetric
init|=
literal|0x0002
block|,
comment|/* Node is symmetric */
DECL|enumerator|keNodeAligned
name|keNodeAligned
init|=
literal|0x0004
block|,
comment|/* Node is aligned */
DECL|enumerator|keNodeActive
name|keNodeActive
init|=
literal|0x0008
block|,
comment|/* Node is active */
DECL|enumerator|keNodeLocked
name|keNodeLocked
init|=
literal|0x0010
block|,
comment|/* Node is locked */
DECL|enumerator|keNodeSelected
name|keNodeSelected
init|=
literal|0x0020
block|,
comment|/* Node is selected */
DECL|enumerator|keNodeVisible
name|keNodeVisible
init|=
literal|0x0040
block|,
comment|/* Node is visible */
DECL|enumerator|keNodeClosed
name|keNodeClosed
init|=
literal|0x0080
block|,
comment|/* Node is closed */
comment|/* TODO: This might be a thinko in the spec document only or in the image    *       format itself. Need to investigate that later    */
DECL|enumerator|keNodeLockedPSP6
name|keNodeLockedPSP6
init|=
literal|0x0016
block|,
comment|/* Node is locked */
DECL|enumerator|keNodeSelectedPSP6
name|keNodeSelectedPSP6
init|=
literal|0x0032
block|,
comment|/* Node is selected */
DECL|enumerator|keNodeVisiblePSP6
name|keNodeVisiblePSP6
init|=
literal|0x0064
block|,
comment|/* Node is visible */
DECL|enumerator|keNodeClosedPSP6
name|keNodeClosedPSP6
init|=
literal|0x0128
block|,
comment|/* Node is closed */
DECL|typedef|PSPPolylineNodeTypes
block|}
name|PSPPolylineNodeTypes
typedef|;
end_typedef

begin_comment
comment|/* Blend modes. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70a03
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_BLEND_NORMAL
name|PSP_BLEND_NORMAL
block|,
DECL|enumerator|PSP_BLEND_DARKEN
name|PSP_BLEND_DARKEN
block|,
DECL|enumerator|PSP_BLEND_LIGHTEN
name|PSP_BLEND_LIGHTEN
block|,
DECL|enumerator|PSP_BLEND_HUE
name|PSP_BLEND_HUE
block|,
DECL|enumerator|PSP_BLEND_SATURATION
name|PSP_BLEND_SATURATION
block|,
DECL|enumerator|PSP_BLEND_COLOR
name|PSP_BLEND_COLOR
block|,
DECL|enumerator|PSP_BLEND_LUMINOSITY
name|PSP_BLEND_LUMINOSITY
block|,
DECL|enumerator|PSP_BLEND_MULTIPLY
name|PSP_BLEND_MULTIPLY
block|,
DECL|enumerator|PSP_BLEND_SCREEN
name|PSP_BLEND_SCREEN
block|,
DECL|enumerator|PSP_BLEND_DISSOLVE
name|PSP_BLEND_DISSOLVE
block|,
DECL|enumerator|PSP_BLEND_OVERLAY
name|PSP_BLEND_OVERLAY
block|,
DECL|enumerator|PSP_BLEND_HARD_LIGHT
name|PSP_BLEND_HARD_LIGHT
block|,
DECL|enumerator|PSP_BLEND_SOFT_LIGHT
name|PSP_BLEND_SOFT_LIGHT
block|,
DECL|enumerator|PSP_BLEND_DIFFERENCE
name|PSP_BLEND_DIFFERENCE
block|,
DECL|enumerator|PSP_BLEND_DODGE
name|PSP_BLEND_DODGE
block|,
DECL|enumerator|PSP_BLEND_BURN
name|PSP_BLEND_BURN
block|,
DECL|enumerator|PSP_BLEND_EXCLUSION
name|PSP_BLEND_EXCLUSION
block|,
DECL|enumerator|PSP_BLEND_TRUE_HUE
name|PSP_BLEND_TRUE_HUE
block|,
comment|/* since PSP8 */
DECL|enumerator|PSP_BLEND_TRUE_SATURATION
name|PSP_BLEND_TRUE_SATURATION
block|,
comment|/* since PSP8 */
DECL|enumerator|PSP_BLEND_TRUE_COLOR
name|PSP_BLEND_TRUE_COLOR
block|,
comment|/* since PSP8 */
DECL|enumerator|PSP_BLEND_TRUE_LIGHTNESS
name|PSP_BLEND_TRUE_LIGHTNESS
block|,
comment|/* since PSP8 */
DECL|enumerator|PSP_BLEND_ADJUST
name|PSP_BLEND_ADJUST
init|=
literal|255
block|, }
DECL|typedef|PSPBlendModes
name|PSPBlendModes
typedef|;
end_typedef

begin_comment
comment|/* Adjustment layer types. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70b03
typedef|typedef
enum|enum
block|{
DECL|enumerator|keAdjNone
name|keAdjNone
init|=
literal|0
block|,
comment|/* Undefined adjustment layer type */
DECL|enumerator|keAdjLevel
name|keAdjLevel
block|,
comment|/* Level adjustment */
DECL|enumerator|keAdjCurve
name|keAdjCurve
block|,
comment|/* Curve adjustment */
DECL|enumerator|keAdjBrightContrast
name|keAdjBrightContrast
block|,
comment|/* BrightnessÂ­contrast adjustment */
DECL|enumerator|keAdjColorBal
name|keAdjColorBal
block|,
comment|/* Color balance adjustment */
DECL|enumerator|keAdjHSL
name|keAdjHSL
block|,
comment|/* HSL adjustment */
DECL|enumerator|keAdjChannelMixer
name|keAdjChannelMixer
block|,
comment|/* Channel mixer adjustment */
DECL|enumerator|keAdjInvert
name|keAdjInvert
block|,
comment|/* Invert adjustment */
DECL|enumerator|keAdjThreshold
name|keAdjThreshold
block|,
comment|/* Threshold adjustment */
DECL|enumerator|keAdjPoster
name|keAdjPoster
comment|/* Posterize adjustment */
DECL|typedef|PSPAdjustmentLayerType
block|}
name|PSPAdjustmentLayerType
typedef|;
end_typedef

begin_comment
comment|/* Vector shape types. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70c03
typedef|typedef
enum|enum
block|{
DECL|enumerator|keVSTUnknown
name|keVSTUnknown
init|=
literal|0
block|,
comment|/* Undefined vector type */
DECL|enumerator|keVSTText
name|keVSTText
block|,
comment|/* Shape represents lines of text */
DECL|enumerator|keVSTPolyline
name|keVSTPolyline
block|,
comment|/* Shape represents a multiple segment line */
DECL|enumerator|keVSTEllipse
name|keVSTEllipse
block|,
comment|/* Shape represents an ellipse (or circle) */
DECL|enumerator|keVSTPolygon
name|keVSTPolygon
block|,
comment|/* Shape represents a closed polygon */
DECL|enumerator|keVSTGroup
name|keVSTGroup
block|,
comment|/* Shape represents a group shape (since PSP7) */
DECL|typedef|PSPVectorShapeType
block|}
name|PSPVectorShapeType
typedef|;
end_typedef

begin_comment
comment|/* Text element types. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70d03
typedef|typedef
enum|enum
block|{
DECL|enumerator|keTextElemUnknown
name|keTextElemUnknown
init|=
literal|0
block|,
comment|/* Undefined text element type */
DECL|enumerator|keTextElemChar
name|keTextElemChar
block|,
comment|/* A single character code */
DECL|enumerator|keTextElemCharStyle
name|keTextElemCharStyle
block|,
comment|/* A character style change */
DECL|enumerator|keTextElemLineStyle
name|keTextElemLineStyle
comment|/* A line style change */
DECL|typedef|PSPTextElementType
block|}
name|PSPTextElementType
typedef|;
end_typedef

begin_comment
comment|/* Text alignment types. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70e03
typedef|typedef
enum|enum
block|{
DECL|enumerator|keTextAlignmentLeft
name|keTextAlignmentLeft
init|=
literal|0
block|,
comment|/* Left text alignment */
DECL|enumerator|keTextAlignmentCenter
name|keTextAlignmentCenter
block|,
comment|/* Center text alignment */
DECL|enumerator|keTextAlignmentRight
name|keTextAlignmentRight
comment|/* Right text alignment */
DECL|typedef|PSPTextAlignment
block|}
name|PSPTextAlignment
typedef|;
end_typedef

begin_comment
comment|/* Paint style types. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac70f03
typedef|typedef
enum|enum
block|{
DECL|enumerator|keStyleNone
name|keStyleNone
init|=
literal|0x0000
block|,
comment|/* No paint style info applies */
DECL|enumerator|keStyleColor
name|keStyleColor
init|=
literal|0x0001
block|,
comment|/* Color paint style info */
DECL|enumerator|keStyleGradient
name|keStyleGradient
init|=
literal|0x0002
block|,
comment|/* Gradient paint style info */
DECL|enumerator|keStylePattern
name|keStylePattern
init|=
literal|0x0004
block|,
comment|/* Pattern paint style info (since PSP7) */
DECL|enumerator|keStylePaper
name|keStylePaper
init|=
literal|0x0008
block|,
comment|/* Paper paint style info (since PSP7) */
DECL|enumerator|keStylePen
name|keStylePen
init|=
literal|0x0010
block|,
comment|/* Organic pen paint style info (since PSP7) */
DECL|typedef|PSPPaintStyleType
block|}
name|PSPPaintStyleType
typedef|;
end_typedef

begin_comment
comment|/* Gradient type. (since PSP7)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71003
typedef|typedef
enum|enum
block|{
DECL|enumerator|keSGTLinear
name|keSGTLinear
init|=
literal|0
block|,
comment|/* Linera gradient type */
DECL|enumerator|keSGTRadial
name|keSGTRadial
block|,
comment|/* Radial gradient type */
DECL|enumerator|keSGTRectangular
name|keSGTRectangular
block|,
comment|/* Rectangulat gradient type */
DECL|enumerator|keSGTSunburst
name|keSGTSunburst
comment|/* Sunburst gradient type */
DECL|typedef|PSPStyleGradientType
block|}
name|PSPStyleGradientType
typedef|;
end_typedef

begin_comment
comment|/* Paint Style Cap Type (Start& End). (since PSP7)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71103
typedef|typedef
enum|enum
block|{
DECL|enumerator|keSCTCapFlat
name|keSCTCapFlat
init|=
literal|0
block|,
comment|/* Flat cap type (was round in psp6) */
DECL|enumerator|keSCTCapRound
name|keSCTCapRound
block|,
comment|/* Round cap type (was square in psp6) */
DECL|enumerator|keSCTCapSquare
name|keSCTCapSquare
block|,
comment|/* Square cap type (was flat in psp6) */
DECL|enumerator|keSCTCapArrow
name|keSCTCapArrow
block|,
comment|/* Arrow cap type */
DECL|enumerator|keSCTCapCadArrow
name|keSCTCapCadArrow
block|,
comment|/* Cad arrow cap type */
DECL|enumerator|keSCTCapCurvedTipArrow
name|keSCTCapCurvedTipArrow
block|,
comment|/* Curved tip arrow cap type */
DECL|enumerator|keSCTCapRingBaseArrow
name|keSCTCapRingBaseArrow
block|,
comment|/* Ring base arrow cap type */
DECL|enumerator|keSCTCapFluerDelis
name|keSCTCapFluerDelis
block|,
comment|/* Fluer deLis cap type */
DECL|enumerator|keSCTCapFootball
name|keSCTCapFootball
block|,
comment|/* Football cap type */
DECL|enumerator|keSCTCapXr71Arrow
name|keSCTCapXr71Arrow
block|,
comment|/* Xr71 arrow cap type */
DECL|enumerator|keSCTCapLilly
name|keSCTCapLilly
block|,
comment|/* Lilly cap type */
DECL|enumerator|keSCTCapPinapple
name|keSCTCapPinapple
block|,
comment|/* Pinapple cap type */
DECL|enumerator|keSCTCapBall
name|keSCTCapBall
block|,
comment|/* Ball cap type */
DECL|enumerator|keSCTCapTulip
name|keSCTCapTulip
comment|/* Tulip cap type */
DECL|typedef|PSPStyleCapType
block|}
name|PSPStyleCapType
typedef|;
end_typedef

begin_comment
comment|/* Paint Style Join Type. (since PSP7)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71203
typedef|typedef
enum|enum
block|{
DECL|enumerator|keSJTJoinMiter
name|keSJTJoinMiter
init|=
literal|0
block|,
DECL|enumerator|keSJTJoinRound
name|keSJTJoinRound
block|,
DECL|enumerator|keSJTJoinBevel
name|keSJTJoinBevel
DECL|typedef|PSPStyleJoinType
block|}
name|PSPStyleJoinType
typedef|;
end_typedef

begin_comment
comment|/* Organic pen type. (since PSP7)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71303
typedef|typedef
enum|enum
block|{
DECL|enumerator|keSPTOrganicPenNone
name|keSPTOrganicPenNone
init|=
literal|0
block|,
comment|/* Undefined pen type */
DECL|enumerator|keSPTOrganicPenMesh
name|keSPTOrganicPenMesh
block|,
comment|/* Mesh pen type */
DECL|enumerator|keSPTOrganicPenSand
name|keSPTOrganicPenSand
block|,
comment|/* Sand pen type */
DECL|enumerator|keSPTOrganicPenCurlicues
name|keSPTOrganicPenCurlicues
block|,
comment|/* Curlicues pen type */
DECL|enumerator|keSPTOrganicPenRays
name|keSPTOrganicPenRays
block|,
comment|/* Rays pen type */
DECL|enumerator|keSPTOrganicPenRipple
name|keSPTOrganicPenRipple
block|,
comment|/* Ripple pen type */
DECL|enumerator|keSPTOrganicPenWave
name|keSPTOrganicPenWave
block|,
comment|/* Wave pen type */
DECL|enumerator|keSPTOrganicPen
name|keSPTOrganicPen
comment|/* Generic pen type */
DECL|typedef|PSPStylePenType
block|}
name|PSPStylePenType
typedef|;
end_typedef

begin_comment
comment|/* Channel types.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71403
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_CHANNEL_COMPOSITE
name|PSP_CHANNEL_COMPOSITE
init|=
literal|0
block|,
comment|/* Channel of single channel bitmap */
DECL|enumerator|PSP_CHANNEL_RED
name|PSP_CHANNEL_RED
block|,
comment|/* Red channel of 24 bit bitmap */
DECL|enumerator|PSP_CHANNEL_GREEN
name|PSP_CHANNEL_GREEN
block|,
comment|/* Green channel of 24 bit bitmap */
DECL|enumerator|PSP_CHANNEL_BLUE
name|PSP_CHANNEL_BLUE
comment|/* Blue channel of 24 bit bitmap */
DECL|typedef|PSPChannelType
block|}
name|PSPChannelType
typedef|;
end_typedef

begin_comment
comment|/* Possible metrics used to measure resolution.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71503
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_METRIC_UNDEFINED
name|PSP_METRIC_UNDEFINED
init|=
literal|0
block|,
comment|/* Metric unknown */
DECL|enumerator|PSP_METRIC_INCH
name|PSP_METRIC_INCH
block|,
comment|/* Resolution is in inches */
DECL|enumerator|PSP_METRIC_CM
name|PSP_METRIC_CM
comment|/* Resolution is in centimeters */
DECL|typedef|PSP_METRIC
block|}
name|PSP_METRIC
typedef|;
end_typedef

begin_comment
comment|/* Possible types of compression.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71603
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_COMP_NONE
name|PSP_COMP_NONE
init|=
literal|0
block|,
comment|/* No compression */
DECL|enumerator|PSP_COMP_RLE
name|PSP_COMP_RLE
block|,
comment|/* RLE compression */
DECL|enumerator|PSP_COMP_LZ77
name|PSP_COMP_LZ77
block|,
comment|/* LZ77 compression */
DECL|enumerator|PSP_COMP_JPEG
name|PSP_COMP_JPEG
comment|/* JPEG compression (only used by thumbnail and composite image) (since PSP6) */
DECL|typedef|PSPCompression
block|}
name|PSPCompression
typedef|;
end_typedef

begin_comment
comment|/* Picture tube placement mode.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71703
typedef|typedef
enum|enum
block|{
DECL|enumerator|tpmRandom
name|tpmRandom
block|,
comment|/* Place tube images in random intervals */
DECL|enumerator|tpmConstant
name|tpmConstant
comment|/* Place tube images in constant intervals */
DECL|typedef|TubePlacementMode
block|}
name|TubePlacementMode
typedef|;
end_typedef

begin_comment
comment|/* Picture tube selection mode.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71803
typedef|typedef
enum|enum
block|{
DECL|enumerator|tsmRandom
name|tsmRandom
block|,
comment|/* Randomly select the next image in  */
comment|/* tube to display */
DECL|enumerator|tsmIncremental
name|tsmIncremental
block|,
comment|/* Select each tube image in turn */
DECL|enumerator|tsmAngular
name|tsmAngular
block|,
comment|/* Select image based on cursor direction */
DECL|enumerator|tsmPressure
name|tsmPressure
block|,
comment|/* Select image based on pressure  */
comment|/* (from pressure-sensitive pad) */
DECL|enumerator|tsmVelocity
name|tsmVelocity
comment|/* Select image based on cursor speed */
DECL|typedef|TubeSelectionMode
block|}
name|TubeSelectionMode
typedef|;
end_typedef

begin_comment
comment|/* Extended data field types.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71903
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_XDATA_TRNS_INDEX
name|PSP_XDATA_TRNS_INDEX
init|=
literal|0
block|,
comment|/* Transparency index field */
DECL|enumerator|PSP_XDATA_GRID
name|PSP_XDATA_GRID
block|,
comment|/* Image grid information (since PSP7) */
DECL|enumerator|PSP_XDATA_GUIDE
name|PSP_XDATA_GUIDE
block|,
comment|/* Image guide information (since PSP7) */
DECL|enumerator|PSP_XDATA_EXIF
name|PSP_XDATA_EXIF
block|,
comment|/* Image Exif information (since PSP8) */
DECL|typedef|PSPExtendedDataID
block|}
name|PSPExtendedDataID
typedef|;
end_typedef

begin_comment
comment|/* Creator field types.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71a03
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_CRTR_FLD_TITLE
name|PSP_CRTR_FLD_TITLE
init|=
literal|0
block|,
comment|/* Image document title field */
DECL|enumerator|PSP_CRTR_FLD_CRT_DATE
name|PSP_CRTR_FLD_CRT_DATE
block|,
comment|/* Creation date field */
DECL|enumerator|PSP_CRTR_FLD_MOD_DATE
name|PSP_CRTR_FLD_MOD_DATE
block|,
comment|/* Modification date field */
DECL|enumerator|PSP_CRTR_FLD_ARTIST
name|PSP_CRTR_FLD_ARTIST
block|,
comment|/* Artist name field */
DECL|enumerator|PSP_CRTR_FLD_CPYRGHT
name|PSP_CRTR_FLD_CPYRGHT
block|,
comment|/* Copyright holder name field */
DECL|enumerator|PSP_CRTR_FLD_DESC
name|PSP_CRTR_FLD_DESC
block|,
comment|/* Image document description field */
DECL|enumerator|PSP_CRTR_FLD_APP_ID
name|PSP_CRTR_FLD_APP_ID
block|,
comment|/* Creating app id field */
DECL|enumerator|PSP_CRTR_FLD_APP_VER
name|PSP_CRTR_FLD_APP_VER
comment|/* Creating app version field */
DECL|typedef|PSPCreatorFieldID
block|}
name|PSPCreatorFieldID
typedef|;
end_typedef

begin_comment
comment|/* Grid units type. (since PSP7)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71b03
typedef|typedef
enum|enum
block|{
DECL|enumerator|keGridUnitsPixels
name|keGridUnitsPixels
init|=
literal|0
block|,
comment|/* Grid units is pixels */
DECL|enumerator|keGridUnitsInches
name|keGridUnitsInches
block|,
comment|/* Grid units is inches */
DECL|enumerator|keGridUnitsCentimeters
name|keGridUnitsCentimeters
comment|/* Grid units is centimeters */
DECL|typedef|PSPGridUnitsType
block|}
name|PSPGridUnitsType
typedef|;
end_typedef

begin_comment
comment|/* Guide orientation type. (since PSP7)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71c03
typedef|typedef
enum|enum
block|{
DECL|enumerator|keHorizontalGuide
name|keHorizontalGuide
init|=
literal|0
block|,
DECL|enumerator|keVerticalGuide
name|keVerticalGuide
DECL|typedef|PSPGuideOrientationType
block|}
name|PSPGuideOrientationType
typedef|;
end_typedef

begin_comment
comment|/* Creator application identifiers.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71d03
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_CREATOR_APP_UNKNOWN
name|PSP_CREATOR_APP_UNKNOWN
init|=
literal|0
block|,
comment|/* Creator application unknown */
DECL|enumerator|PSP_CREATOR_APP_PAINT_SHOP_PRO
name|PSP_CREATOR_APP_PAINT_SHOP_PRO
comment|/* Creator is Paint Shop Pro */
DECL|typedef|PSPCreatorAppID
block|}
name|PSPCreatorAppID
typedef|;
end_typedef

begin_comment
comment|/* Layer types.  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71e03
typedef|typedef
enum|enum
block|{
DECL|enumerator|PSP_LAYER_NORMAL
name|PSP_LAYER_NORMAL
init|=
literal|0
block|,
comment|/* Normal layer */
DECL|enumerator|PSP_LAYER_FLOATING_SELECTION
name|PSP_LAYER_FLOATING_SELECTION
comment|/* Floating selection layer */
DECL|typedef|PSPLayerTypePSP5
block|}
name|PSPLayerTypePSP5
typedef|;
end_typedef

begin_comment
comment|/* Layer types. (since PSP6)  */
end_comment

begin_typedef
DECL|enum|__anon291cdac71f03
typedef|typedef
enum|enum
block|{
DECL|enumerator|keGLTUndefined
name|keGLTUndefined
init|=
literal|0
block|,
comment|/* Undefined layer type */
DECL|enumerator|keGLTRaster
name|keGLTRaster
block|,
comment|/* Standard raster layer */
DECL|enumerator|keGLTFloatingRasterSelection
name|keGLTFloatingRasterSelection
block|,
comment|/* Floating selection (raster layer) */
DECL|enumerator|keGLTVector
name|keGLTVector
block|,
comment|/* Vector layer */
DECL|enumerator|keGLTAdjustment
name|keGLTAdjustment
block|,
comment|/* Adjustment layer */
DECL|enumerator|keGLTMask
name|keGLTMask
comment|/* Mask layer (since PSP8) */
DECL|typedef|PSPLayerTypePSP6
block|}
name|PSPLayerTypePSP6
typedef|;
end_typedef

begin_comment
comment|/* Truth values.  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FALSE and TRUE taken by GLib */
end_comment

begin_else
unit|typedef enum {   FALSE = 0,   TRUE } PSP_BOOLEAN;
else|#
directive|else
end_else

begin_typedef
DECL|typedef|PSP_BOOLEAN
typedef|typedef
name|gboolean
name|PSP_BOOLEAN
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* End of cut&paste from psp spec */
end_comment

begin_comment
comment|/* We store the various PSP data in own structures.  * We cannot use structs intended to be direct copies of the file block  * headers because of struct alignment issues.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon291cdac72008
block|{
DECL|member|width
DECL|member|height
name|guint32
name|width
decl_stmt|,
name|height
decl_stmt|;
DECL|member|resolution
name|gdouble
name|resolution
decl_stmt|;
DECL|member|metric
name|guchar
name|metric
decl_stmt|;
DECL|member|compression
name|guint16
name|compression
decl_stmt|;
DECL|member|depth
name|guint16
name|depth
decl_stmt|;
DECL|member|grayscale
name|guchar
name|grayscale
decl_stmt|;
DECL|member|active_layer
name|guint32
name|active_layer
decl_stmt|;
DECL|member|layer_count
name|guint16
name|layer_count
decl_stmt|;
DECL|typedef|PSPimage
block|}
name|PSPimage
typedef|;
end_typedef

begin_comment
comment|/* Declare some local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|load_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|save_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Various local variables...  */
end_comment

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
specifier|const
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc  */
name|NULL
block|,
comment|/* quit_proc  */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc   */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Save info  */
end_comment

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon291cdac72108
block|{
DECL|member|compression
name|PSPCompression
name|compression
decl_stmt|;
DECL|typedef|PSPSaveVals
block|}
name|PSPSaveVals
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|psvals
specifier|static
name|PSPSaveVals
name|psvals
init|=
block|{
name|PSP_COMP_LZ77
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|psp_ver_major
DECL|variable|psp_ver_minor
specifier|static
name|guint16
name|psp_ver_major
decl_stmt|,
name|psp_ver_minor
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
specifier|const
name|GimpParamDef
name|load_args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run-mode"
block|,
literal|"The run mode { RUN-INTERACTIVE (0), RUN-NONINTERACTIVE (1) }"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to load"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"raw-filename"
block|,
literal|"The name of the file to load"
block|}
block|}
decl_stmt|;
specifier|static
specifier|const
name|GimpParamDef
name|load_return_vals
index|[]
init|=
block|{
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Output image"
block|}
block|}
decl_stmt|;
if|#
directive|if
literal|0
block|static const GimpParamDef save_args[] =   {     { GIMP_PDB_INT32,    "run-mode",     "The run mode { RUN-INTERACTIVE (0), RUN-NONINTERACTIVE (1) }" },     { GIMP_PDB_IMAGE,    "image",        "Input image" },     { GIMP_PDB_DRAWABLE, "drawable",     "Drawable to export" },     { GIMP_PDB_STRING,   "filename",     "The name of the file to export the image in" },     { GIMP_PDB_STRING,   "raw-filename", "The name of the file to export the image in" },     { GIMP_PDB_INT32,    "compression",  "Specify 0 for no compression, 1 for RLE, and 2 for LZ77" }   };
endif|#
directive|endif
name|gimp_install_procedure
argument_list|(
name|LOAD_PROC
argument_list|,
literal|"loads images from the Paint Shop Pro PSP file format"
argument_list|,
literal|"This plug-in loads and exports images in "
literal|"Paint Shop Pro's native PSP format. "
literal|"Vector layers aren't handled. Exporting isn't "
literal|"yet implemented."
argument_list|,
literal|"Tor Lillqvist"
argument_list|,
literal|"Tor Lillqvist"
argument_list|,
literal|"1999"
argument_list|,
name|N_
argument_list|(
literal|"Paint Shop Pro image"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|load_args
argument_list|)
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|load_return_vals
argument_list|)
argument_list|,
name|load_args
argument_list|,
name|load_return_vals
argument_list|)
expr_stmt|;
name|gimp_register_file_handler_mime
argument_list|(
name|LOAD_PROC
argument_list|,
literal|"image/x-psp"
argument_list|)
expr_stmt|;
name|gimp_register_magic_load_handler
argument_list|(
name|LOAD_PROC
argument_list|,
literal|"psp,tub,pspimage"
argument_list|,
literal|""
argument_list|,
literal|"0,string,Paint\\040Shop\\040Pro\\040Image\\040File\n\032"
argument_list|)
expr_stmt|;
comment|/* commented out until exporting is implemented */
if|#
directive|if
literal|0
block|gimp_install_procedure (SAVE_PROC,                           "exports images in the Paint Shop Pro PSP file format",                           "This plug-in loads and exports images in "                           "Paint Shop Pro's native PSP format. "                           "Vector layers aren't handled. Exporting isn't "                           "yet implemented.",                           "Tor Lillqvist",                           "Tor Lillqvist",                           "1999",                           N_("Paint Shop Pro image"),                           "RGB*, GRAY*, INDEXED*",                           GIMP_PLUGIN,                           G_N_ELEMENTS (save_args), 0,                           save_args, NULL);    gimp_register_save_handler (SAVE_PROC, "psp,tub", "");
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|save_dialog (void)
name|save_dialog
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|gint
name|run
decl_stmt|;
name|dialog
operator|=
name|gimp_export_dialog_new
argument_list|(
name|_
argument_list|(
literal|"PSP"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|SAVE_PROC
argument_list|)
expr_stmt|;
comment|/*  file save type  */
name|frame
operator|=
name|gimp_int_radio_group_new
argument_list|(
name|TRUE
argument_list|,
name|_
argument_list|(
literal|"Data Compression"
argument_list|)
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_radio_button_update
argument_list|)
argument_list|,
operator|&
name|psvals
operator|.
name|compression
argument_list|,
name|psvals
operator|.
name|compression
argument_list|,
name|C_
argument_list|(
literal|"compression"
argument_list|,
literal|"None"
argument_list|)
argument_list|,
name|PSP_COMP_NONE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"RLE"
argument_list|)
argument_list|,
name|PSP_COMP_RLE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"LZ77"
argument_list|)
argument_list|,
name|PSP_COMP_LZ77
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gimp_export_dialog_get_content_area
argument_list|(
name|dialog
argument_list|)
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|run
operator|=
operator|(
name|gimp_dialog_run
argument_list|(
name|GIMP_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|)
operator|==
name|GTK_RESPONSE_OK
operator|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
return|return
name|run
return|;
block|}
end_function

begin_comment
comment|/* This helper method is used to get the name of the block for the known block  * types. The enum PSPBlockID must cover the input values.  */
end_comment

begin_function
specifier|static
specifier|const
name|gchar
modifier|*
DECL|function|block_name (gint id)
name|block_name
parameter_list|(
name|gint
name|id
parameter_list|)
block|{
specifier|static
specifier|const
name|gchar
modifier|*
name|block_names
index|[]
init|=
block|{
literal|"IMAGE"
block|,
literal|"CREATOR"
block|,
literal|"COLOR"
block|,
literal|"LAYER_START"
block|,
literal|"LAYER"
block|,
literal|"CHANNEL"
block|,
literal|"SELECTION"
block|,
literal|"ALPHA_BANK"
block|,
literal|"ALPHA_CHANNEL"
block|,
literal|"THUMBNAIL"
block|,
literal|"EXTENDED_DATA"
block|,
literal|"TUBE"
block|,
literal|"ADJUSTMENT_EXTENSION"
block|,
literal|"VECTOR_EXTENSION_BLOCK"
block|,
literal|"SHAPE_BLOCK"
block|,
literal|"PAINTSTYLE_BLOCK"
block|,
literal|"COMPOSITE_IMAGE_BANK_BLOCK"
block|,
literal|"COMPOSITE_ATTRIBUTES_BLOCK"
block|,
literal|"JPEG_BLOCK"
block|,   }
decl_stmt|;
specifier|static
name|gchar
modifier|*
name|err_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|id
operator|>=
literal|0
operator|&&
name|id
operator|<=
name|PSP_JPEG_BLOCK
condition|)
return|return
name|block_names
index|[
name|id
index|]
return|;
name|g_free
argument_list|(
name|err_name
argument_list|)
expr_stmt|;
name|err_name
operator|=
name|g_strdup_printf
argument_list|(
literal|"id=%d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
name|err_name
return|;
block|}
end_function

begin_comment
comment|/* This helper method is used during loading. It verifies the block we are  * reading has a valid header. Fills the variables init_len and total_len  */
end_comment

begin_function
specifier|static
name|gint
DECL|function|read_block_header (FILE * f,guint32 * init_len,guint32 * total_len,GError ** error)
name|read_block_header
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|guint32
modifier|*
name|init_len
parameter_list|,
name|guint32
modifier|*
name|total_len
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|guchar
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|guint16
name|id
decl_stmt|;
name|long
name|header_start
decl_stmt|;
name|guint32
name|len
decl_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|header_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|id
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
operator|(
name|psp_ver_major
operator|<
literal|4
operator|&&
name|fread
argument_list|(
name|total_len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|)
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading block header"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
literal|"~BK\0"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Invalid block header at %ld"
argument_list|)
argument_list|,
name|header_start
argument_list|)
expr_stmt|;
else|else
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Invalid block header"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_message
argument_list|(
literal|"%s at %ld"
argument_list|,
name|block_name
argument_list|(
name|id
argument_list|)
argument_list|,
name|header_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|psp_ver_major
operator|<
literal|4
condition|)
block|{
operator|*
name|init_len
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|len
argument_list|)
expr_stmt|;
operator|*
name|total_len
operator|=
name|GUINT32_FROM_LE
argument_list|(
operator|*
name|total_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Version 4.0 seems to have dropped the initial data chunk length        * field.        */
operator|*
name|init_len
operator|=
literal|0xDEADBEEF
expr_stmt|;
comment|/* Intentionally bogus, should not be used */
operator|*
name|total_len
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|len
argument_list|)
expr_stmt|;
block|}
return|return
name|GUINT16_FROM_LE
argument_list|(
name|id
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Read the PSP_IMAGE_BLOCK */
end_comment

begin_function
specifier|static
name|gint
DECL|function|read_general_image_attribute_block (FILE * f,guint init_len,guint total_len,PSPimage * ia)
name|read_general_image_attribute_block
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|guint
name|init_len
parameter_list|,
name|guint
name|total_len
parameter_list|,
name|PSPimage
modifier|*
name|ia
parameter_list|)
block|{
name|gchar
name|buf
index|[
literal|6
index|]
decl_stmt|;
name|guint64
name|res
decl_stmt|;
name|gchar
name|graphics_content
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|init_len
operator|<
literal|38
operator|||
name|total_len
operator|<
literal|38
condition|)
block|{
name|g_message
argument_list|(
literal|"Invalid general image attribute chunk size"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|psp_ver_major
operator|>=
literal|4
condition|)
block|{
comment|/* TODO: This causes the chunk size to be ignored. Better verify if it is        *       valid since it might create read offset problems with the        *       "expansion field" (which follows after the "graphics content" and        *       is of unknown size).        */
name|fseek
argument_list|(
name|f
argument_list|,
literal|4
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|width
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|height
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|res
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|metric
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|compression
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|depth
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|buf
argument_list|,
literal|2
operator|+
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
comment|/* Skip plane and color count */
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|grayscale
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
comment|/* Skip total image size */
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|active_layer
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|ia
operator|->
name|layer_count
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
operator|(
name|psp_ver_major
operator|>=
literal|4
operator|&&
name|fread
argument_list|(
name|graphics_content
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Error reading general image attribute block"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ia
operator|->
name|width
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|ia
operator|->
name|width
argument_list|)
expr_stmt|;
name|ia
operator|->
name|height
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|ia
operator|->
name|height
argument_list|)
expr_stmt|;
name|res
operator|=
name|GUINT64_FROM_LE
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ia
operator|->
name|resolution
argument_list|,
operator|&
name|res
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|ia
operator|->
name|metric
operator|==
name|PSP_METRIC_CM
condition|)
name|ia
operator|->
name|resolution
operator|/=
literal|2.54
expr_stmt|;
name|ia
operator|->
name|compression
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|ia
operator|->
name|compression
argument_list|)
expr_stmt|;
if|if
condition|(
name|ia
operator|->
name|compression
operator|>
name|PSP_COMP_LZ77
condition|)
block|{
name|g_message
argument_list|(
literal|"Unknown compression type %d"
argument_list|,
name|ia
operator|->
name|compression
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ia
operator|->
name|depth
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|ia
operator|->
name|depth
argument_list|)
expr_stmt|;
if|if
condition|(
name|ia
operator|->
name|depth
operator|!=
literal|24
condition|)
block|{
name|g_message
argument_list|(
literal|"Unsupported bit depth %d"
argument_list|,
name|ia
operator|->
name|depth
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ia
operator|->
name|active_layer
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|ia
operator|->
name|active_layer
argument_list|)
expr_stmt|;
name|ia
operator|->
name|layer_count
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|ia
operator|->
name|layer_count
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|try_fseek (FILE * f,glong pos,gint whence,GError ** error)
name|try_fseek
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|glong
name|pos
parameter_list|,
name|gint
name|whence
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
name|pos
argument_list|,
name|whence
argument_list|)
operator|<
literal|0
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|g_file_error_from_errno
argument_list|(
name|errno
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Seek error: %s"
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|read_creator_block (FILE * f,gint image_ID,guint total_len,PSPimage * ia,GError ** error)
name|read_creator_block
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|gint
name|image_ID
parameter_list|,
name|guint
name|total_len
parameter_list|,
name|PSPimage
modifier|*
name|ia
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|long
name|data_start
decl_stmt|;
name|guchar
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|guint16
name|keyword
decl_stmt|;
name|guint32
name|length
decl_stmt|;
name|gchar
modifier|*
name|string
decl_stmt|;
name|gchar
modifier|*
name|title
init|=
name|NULL
decl_stmt|,
modifier|*
name|artist
init|=
name|NULL
decl_stmt|,
modifier|*
name|copyright
init|=
name|NULL
decl_stmt|,
modifier|*
name|description
init|=
name|NULL
decl_stmt|;
name|guint32
name|dword
decl_stmt|;
name|guint32
name|__attribute__
argument_list|(
operator|(
name|unused
operator|)
argument_list|)
name|cdate
init|=
literal|0
decl_stmt|;
name|guint32
name|__attribute__
argument_list|(
operator|(
name|unused
operator|)
argument_list|)
name|mdate
init|=
literal|0
decl_stmt|;
name|guint32
name|__attribute__
argument_list|(
operator|(
name|unused
operator|)
argument_list|)
name|appid
decl_stmt|;
name|guint32
name|__attribute__
argument_list|(
operator|(
name|unused
operator|)
argument_list|)
name|appver
decl_stmt|;
name|GString
modifier|*
name|comment
decl_stmt|;
name|GimpParasite
modifier|*
name|comment_parasite
decl_stmt|;
name|data_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|comment
operator|=
name|g_string_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
name|ftell
argument_list|(
name|f
argument_list|)
operator|<
name|data_start
operator|+
name|total_len
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|keyword
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|length
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading creator keyword chunk"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
literal|"~FL\0"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Invalid keyword chunk header"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|keyword
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|keyword
argument_list|)
expr_stmt|;
name|length
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|length
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|keyword
condition|)
block|{
case|case
name|PSP_CRTR_FLD_TITLE
case|:
case|case
name|PSP_CRTR_FLD_ARTIST
case|:
case|case
name|PSP_CRTR_FLD_CPYRGHT
case|:
case|case
name|PSP_CRTR_FLD_DESC
case|:
name|string
operator|=
name|g_malloc
argument_list|(
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|string
argument_list|,
name|length
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading creator keyword data"
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|string
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|string
index|[
name|length
operator|-
literal|1
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Creator keyword data not nul-terminated"
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|string
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|keyword
condition|)
block|{
case|case
name|PSP_CRTR_FLD_TITLE
case|:
name|g_free
argument_list|(
name|title
argument_list|)
expr_stmt|;
name|title
operator|=
name|string
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_ARTIST
case|:
name|g_free
argument_list|(
name|artist
argument_list|)
expr_stmt|;
name|artist
operator|=
name|string
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_CPYRGHT
case|:
name|g_free
argument_list|(
name|copyright
argument_list|)
expr_stmt|;
name|copyright
operator|=
name|string
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_DESC
case|:
name|g_free
argument_list|(
name|description
argument_list|)
expr_stmt|;
name|description
operator|=
name|string
expr_stmt|;
break|break;
default|default:
name|g_free
argument_list|(
name|string
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PSP_CRTR_FLD_CRT_DATE
case|:
case|case
name|PSP_CRTR_FLD_MOD_DATE
case|:
case|case
name|PSP_CRTR_FLD_APP_ID
case|:
case|case
name|PSP_CRTR_FLD_APP_VER
case|:
if|if
condition|(
name|fread
argument_list|(
operator|&
name|dword
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading creator keyword data"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|keyword
condition|)
block|{
case|case
name|PSP_CRTR_FLD_CRT_DATE
case|:
name|cdate
operator|=
name|dword
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_MOD_DATE
case|:
name|mdate
operator|=
name|dword
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_APP_ID
case|:
name|appid
operator|=
name|dword
expr_stmt|;
break|break;
case|case
name|PSP_CRTR_FLD_APP_VER
case|:
name|appver
operator|=
name|dword
expr_stmt|;
break|break;
block|}
break|break;
default|default:
if|if
condition|(
name|try_fseek
argument_list|(
name|f
argument_list|,
name|length
argument_list|,
name|SEEK_CUR
argument_list|,
name|error
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|title
condition|)
block|{
name|g_string_append
argument_list|(
name|comment
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|title
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|artist
condition|)
block|{
name|g_string_append
argument_list|(
name|comment
argument_list|,
name|artist
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|artist
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|copyright
condition|)
block|{
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"Copyright "
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
name|copyright
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|copyright
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|description
condition|)
block|{
name|g_string_append
argument_list|(
name|comment
argument_list|,
name|description
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|description
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|comment
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|comment
operator|->
name|len
operator|>
literal|0
condition|)
block|{
name|comment_parasite
operator|=
name|gimp_parasite_new
argument_list|(
literal|"gimp-comment"
argument_list|,
name|GIMP_PARASITE_PERSISTENT
argument_list|,
name|strlen
argument_list|(
name|comment
operator|->
name|str
argument_list|)
operator|+
literal|1
argument_list|,
name|comment
operator|->
name|str
argument_list|)
expr_stmt|;
name|gimp_image_attach_parasite
argument_list|(
name|image_ID
argument_list|,
name|comment_parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|comment_parasite
argument_list|)
expr_stmt|;
block|}
name|g_string_free
argument_list|(
name|comment
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
specifier|inline
DECL|function|swab_rect (guint32 * rect)
name|swab_rect
parameter_list|(
name|guint32
modifier|*
name|rect
parameter_list|)
block|{
name|rect
index|[
literal|0
index|]
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|rect
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|rect
index|[
literal|1
index|]
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|rect
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|rect
index|[
literal|2
index|]
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|rect
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|rect
index|[
literal|3
index|]
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|rect
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|GimpLayerMode
DECL|function|gimp_layer_mode_from_psp_blend_mode (PSPBlendModes mode)
name|gimp_layer_mode_from_psp_blend_mode
parameter_list|(
name|PSPBlendModes
name|mode
parameter_list|)
block|{
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|PSP_BLEND_NORMAL
case|:
return|return
name|GIMP_LAYER_MODE_NORMAL_LEGACY
return|;
case|case
name|PSP_BLEND_DARKEN
case|:
return|return
name|GIMP_LAYER_MODE_DARKEN_ONLY_LEGACY
return|;
case|case
name|PSP_BLEND_LIGHTEN
case|:
return|return
name|GIMP_LAYER_MODE_LIGHTEN_ONLY_LEGACY
return|;
case|case
name|PSP_BLEND_HUE
case|:
return|return
name|GIMP_LAYER_MODE_HSV_HUE_LEGACY
return|;
case|case
name|PSP_BLEND_SATURATION
case|:
return|return
name|GIMP_LAYER_MODE_HSV_SATURATION_LEGACY
return|;
case|case
name|PSP_BLEND_COLOR
case|:
return|return
name|GIMP_LAYER_MODE_HSL_COLOR_LEGACY
return|;
case|case
name|PSP_BLEND_LUMINOSITY
case|:
return|return
name|GIMP_LAYER_MODE_HSV_VALUE_LEGACY
return|;
comment|/* ??? */
case|case
name|PSP_BLEND_MULTIPLY
case|:
return|return
name|GIMP_LAYER_MODE_MULTIPLY_LEGACY
return|;
case|case
name|PSP_BLEND_SCREEN
case|:
return|return
name|GIMP_LAYER_MODE_SCREEN_LEGACY
return|;
case|case
name|PSP_BLEND_DISSOLVE
case|:
return|return
name|GIMP_LAYER_MODE_DISSOLVE
return|;
case|case
name|PSP_BLEND_OVERLAY
case|:
return|return
name|GIMP_LAYER_MODE_OVERLAY
return|;
case|case
name|PSP_BLEND_HARD_LIGHT
case|:
return|return
name|GIMP_LAYER_MODE_HARDLIGHT_LEGACY
return|;
case|case
name|PSP_BLEND_SOFT_LIGHT
case|:
return|return
name|GIMP_LAYER_MODE_SOFTLIGHT_LEGACY
return|;
case|case
name|PSP_BLEND_DIFFERENCE
case|:
return|return
name|GIMP_LAYER_MODE_DIFFERENCE_LEGACY
return|;
case|case
name|PSP_BLEND_DODGE
case|:
return|return
name|GIMP_LAYER_MODE_DODGE_LEGACY
return|;
case|case
name|PSP_BLEND_BURN
case|:
return|return
name|GIMP_LAYER_MODE_BURN_LEGACY
return|;
case|case
name|PSP_BLEND_EXCLUSION
case|:
return|return
operator|-
literal|1
return|;
comment|/* ??? */
case|case
name|PSP_BLEND_ADJUST
case|:
return|return
operator|-
literal|1
return|;
comment|/* ??? */
case|case
name|PSP_BLEND_TRUE_HUE
case|:
return|return
operator|-
literal|1
return|;
comment|/* ??? */
case|case
name|PSP_BLEND_TRUE_SATURATION
case|:
return|return
operator|-
literal|1
return|;
comment|/* ??? */
case|case
name|PSP_BLEND_TRUE_COLOR
case|:
return|return
operator|-
literal|1
return|;
comment|/* ??? */
case|case
name|PSP_BLEND_TRUE_LIGHTNESS
case|:
return|return
operator|-
literal|1
return|;
comment|/* ??? */
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|gchar
modifier|*
DECL|function|blend_mode_name (PSPBlendModes mode)
name|blend_mode_name
parameter_list|(
name|PSPBlendModes
name|mode
parameter_list|)
block|{
specifier|static
specifier|const
name|gchar
modifier|*
name|blend_mode_names
index|[]
init|=
block|{
literal|"NORMAL"
block|,
literal|"DARKEN"
block|,
literal|"LIGHTEN"
block|,
literal|"HUE"
block|,
literal|"SATURATION"
block|,
literal|"COLOR"
block|,
literal|"LUMINOSITY"
block|,
literal|"MULTIPLY"
block|,
literal|"SCREEN"
block|,
literal|"DISSOLVE"
block|,
literal|"OVERLAY"
block|,
literal|"HARD_LIGHT"
block|,
literal|"SOFT_LIGHT"
block|,
literal|"DIFFERENCE"
block|,
literal|"DODGE"
block|,
literal|"BURN"
block|,
literal|"EXCLUSION"
block|}
decl_stmt|;
specifier|static
name|gchar
modifier|*
name|err_name
init|=
name|NULL
decl_stmt|;
comment|/* TODO: what about PSP_BLEND_ADJUST? */
if|if
condition|(
name|mode
operator|>=
literal|0
operator|&&
name|mode
operator|<=
name|PSP_BLEND_EXCLUSION
condition|)
return|return
name|blend_mode_names
index|[
name|mode
index|]
return|;
name|g_free
argument_list|(
name|err_name
argument_list|)
expr_stmt|;
name|err_name
operator|=
name|g_strdup_printf
argument_list|(
literal|"unknown layer blend mode %d"
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
name|err_name
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|gchar
modifier|*
DECL|function|bitmap_type_name (gint type)
name|bitmap_type_name
parameter_list|(
name|gint
name|type
parameter_list|)
block|{
specifier|static
specifier|const
name|gchar
modifier|*
name|bitmap_type_names
index|[]
init|=
block|{
literal|"IMAGE"
block|,
literal|"TRANS_MASK"
block|,
literal|"USER_MASK"
block|,
literal|"SELECTION"
block|,
literal|"ALPHA_MASK"
block|,
literal|"THUMBNAIL"
block|}
decl_stmt|;
specifier|static
name|gchar
modifier|*
name|err_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|type
operator|>=
literal|0
operator|&&
name|type
operator|<=
name|PSP_DIB_THUMBNAIL
condition|)
return|return
name|bitmap_type_names
index|[
name|type
index|]
return|;
name|g_free
argument_list|(
name|err_name
argument_list|)
expr_stmt|;
name|err_name
operator|=
name|g_strdup_printf
argument_list|(
literal|"unknown bitmap type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|err_name
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|gchar
modifier|*
DECL|function|channel_type_name (gint type)
name|channel_type_name
parameter_list|(
name|gint
name|type
parameter_list|)
block|{
specifier|static
specifier|const
name|gchar
modifier|*
name|channel_type_names
index|[]
init|=
block|{
literal|"COMPOSITE"
block|,
literal|"RED"
block|,
literal|"GREEN"
block|,
literal|"BLUE"
block|}
decl_stmt|;
specifier|static
name|gchar
modifier|*
name|err_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|type
operator|>=
literal|0
operator|&&
name|type
operator|<=
name|PSP_CHANNEL_BLUE
condition|)
return|return
name|channel_type_names
index|[
name|type
index|]
return|;
name|g_free
argument_list|(
name|err_name
argument_list|)
expr_stmt|;
name|err_name
operator|=
name|g_strdup_printf
argument_list|(
literal|"unknown channel type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|err_name
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|psp_zalloc (void * opaque,guint items,guint size)
name|psp_zalloc
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|guint
name|items
parameter_list|,
name|guint
name|size
parameter_list|)
block|{
return|return
name|g_malloc
argument_list|(
name|items
operator|*
name|size
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|psp_zfree (void * opaque,void * ptr)
name|psp_zfree
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|g_free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|read_channel_data (FILE * f,PSPimage * ia,guchar ** pixels,guint bytespp,guint offset,GeglBuffer * buffer,guint32 compressed_len,GError ** error)
name|read_channel_data
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|PSPimage
modifier|*
name|ia
parameter_list|,
name|guchar
modifier|*
modifier|*
name|pixels
parameter_list|,
name|guint
name|bytespp
parameter_list|,
name|guint
name|offset
parameter_list|,
name|GeglBuffer
modifier|*
name|buffer
parameter_list|,
name|guint32
name|compressed_len
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|y
decl_stmt|;
name|gint
name|width
init|=
name|gegl_buffer_get_width
argument_list|(
name|buffer
argument_list|)
decl_stmt|;
name|gint
name|height
init|=
name|gegl_buffer_get_height
argument_list|(
name|buffer
argument_list|)
decl_stmt|;
name|gint
name|npixels
init|=
name|width
operator|*
name|height
decl_stmt|;
name|guchar
modifier|*
name|buf
decl_stmt|;
name|guchar
modifier|*
name|buf2
init|=
name|NULL
decl_stmt|;
comment|/* please the compiler */
name|guchar
name|runcount
decl_stmt|,
name|byte
decl_stmt|;
name|z_stream
name|zstream
decl_stmt|;
switch|switch
condition|(
name|ia
operator|->
name|compression
condition|)
block|{
case|case
name|PSP_COMP_NONE
case|:
if|if
condition|(
name|bytespp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|width
operator|%
literal|4
operator|)
operator|==
literal|0
condition|)
name|fread
argument_list|(
name|pixels
index|[
literal|0
index|]
argument_list|,
name|height
operator|*
name|width
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
else|else
block|{
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
name|fread
argument_list|(
name|pixels
index|[
name|y
index|]
argument_list|,
name|width
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|f
argument_list|,
literal|4
operator|-
operator|(
name|width
operator|%
literal|4
operator|)
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|buf
operator|=
name|g_malloc
argument_list|(
name|width
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
name|guchar
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|fread
argument_list|(
name|buf
argument_list|,
name|width
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|%
literal|4
condition|)
name|fseek
argument_list|(
name|f
argument_list|,
literal|4
operator|-
operator|(
name|width
operator|%
literal|4
operator|)
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
name|q
operator|=
name|pixels
index|[
name|y
index|]
operator|+
name|offset
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|width
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|q
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|q
operator|+=
name|bytespp
expr_stmt|;
block|}
block|}
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PSP_COMP_RLE
case|:
block|{
name|guchar
modifier|*
name|q
decl_stmt|,
modifier|*
name|endq
decl_stmt|;
name|q
operator|=
name|pixels
index|[
literal|0
index|]
operator|+
name|offset
expr_stmt|;
name|endq
operator|=
name|q
operator|+
name|npixels
operator|*
name|bytespp
expr_stmt|;
name|buf
operator|=
name|g_malloc
argument_list|(
literal|127
argument_list|)
expr_stmt|;
while|while
condition|(
name|q
operator|<
name|endq
condition|)
block|{
name|fread
argument_list|(
operator|&
name|runcount
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|runcount
operator|>
literal|128
condition|)
block|{
name|runcount
operator|-=
literal|128
expr_stmt|;
name|fread
argument_list|(
operator|&
name|byte
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
name|byte
argument_list|,
name|runcount
argument_list|)
expr_stmt|;
block|}
else|else
name|fread
argument_list|(
name|buf
argument_list|,
name|runcount
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
comment|/* prevent buffer overflow for bogus data */
name|runcount
operator|=
name|MIN
argument_list|(
name|runcount
argument_list|,
operator|(
name|endq
operator|-
name|q
operator|)
operator|/
name|bytespp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytespp
operator|==
literal|1
condition|)
block|{
name|memmove
argument_list|(
name|q
argument_list|,
name|buf
argument_list|,
name|runcount
argument_list|)
expr_stmt|;
name|q
operator|+=
name|runcount
expr_stmt|;
block|}
else|else
block|{
name|guchar
modifier|*
name|p
init|=
name|buf
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|runcount
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|q
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|q
operator|+=
name|bytespp
expr_stmt|;
block|}
block|}
block|}
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PSP_COMP_LZ77
case|:
name|buf
operator|=
name|g_malloc
argument_list|(
name|compressed_len
argument_list|)
expr_stmt|;
name|fread
argument_list|(
name|buf
argument_list|,
name|compressed_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|zstream
operator|.
name|next_in
operator|=
name|buf
expr_stmt|;
name|zstream
operator|.
name|avail_in
operator|=
name|compressed_len
expr_stmt|;
name|zstream
operator|.
name|zalloc
operator|=
name|psp_zalloc
expr_stmt|;
name|zstream
operator|.
name|zfree
operator|=
name|psp_zfree
expr_stmt|;
name|zstream
operator|.
name|opaque
operator|=
name|f
expr_stmt|;
if|if
condition|(
name|inflateInit
argument_list|(
operator|&
name|zstream
argument_list|)
operator|!=
name|Z_OK
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"zlib error"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|bytespp
operator|==
literal|1
condition|)
name|zstream
operator|.
name|next_out
operator|=
name|pixels
index|[
literal|0
index|]
expr_stmt|;
else|else
block|{
name|buf2
operator|=
name|g_malloc
argument_list|(
name|npixels
argument_list|)
expr_stmt|;
name|zstream
operator|.
name|next_out
operator|=
name|buf2
expr_stmt|;
block|}
name|zstream
operator|.
name|avail_out
operator|=
name|npixels
expr_stmt|;
if|if
condition|(
name|inflate
argument_list|(
operator|&
name|zstream
argument_list|,
name|Z_FINISH
argument_list|)
operator|!=
name|Z_STREAM_END
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"zlib error"
argument_list|)
argument_list|)
expr_stmt|;
name|inflateEnd
argument_list|(
operator|&
name|zstream
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|inflateEnd
argument_list|(
operator|&
name|zstream
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytespp
operator|>
literal|1
condition|)
block|{
name|guchar
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|p
operator|=
name|buf2
expr_stmt|;
name|q
operator|=
name|pixels
index|[
literal|0
index|]
operator|+
name|offset
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npixels
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|q
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|q
operator|+=
name|bytespp
expr_stmt|;
block|}
name|g_free
argument_list|(
name|buf2
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|read_layer_block (FILE * f,gint image_ID,guint total_len,PSPimage * ia,GError ** error)
name|read_layer_block
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|gint
name|image_ID
parameter_list|,
name|guint
name|total_len
parameter_list|,
name|PSPimage
modifier|*
name|ia
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|long
name|block_start
decl_stmt|,
name|sub_block_start
decl_stmt|,
name|channel_start
decl_stmt|;
name|gint
name|sub_id
decl_stmt|;
name|guint32
name|sub_init_len
decl_stmt|,
name|sub_total_len
decl_stmt|;
name|gchar
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|guint16
name|namelen
decl_stmt|;
name|guchar
name|type
decl_stmt|,
name|opacity
decl_stmt|,
name|blend_mode
decl_stmt|,
name|visibility
decl_stmt|,
name|transparency_protected
decl_stmt|;
name|guchar
name|link_group_id
decl_stmt|,
name|mask_linked
decl_stmt|,
name|mask_disabled
decl_stmt|;
name|guint32
name|image_rect
index|[
literal|4
index|]
decl_stmt|,
name|saved_image_rect
index|[
literal|4
index|]
decl_stmt|,
name|mask_rect
index|[
literal|4
index|]
decl_stmt|,
name|saved_mask_rect
index|[
literal|4
index|]
decl_stmt|;
name|gboolean
name|null_layer
init|=
name|FALSE
decl_stmt|;
name|guint16
name|bitmap_count
decl_stmt|,
name|channel_count
decl_stmt|;
name|GimpImageType
name|drawable_type
decl_stmt|;
name|guint32
name|layer_ID
init|=
literal|0
decl_stmt|;
name|GimpLayerMode
name|layer_mode
decl_stmt|;
name|guint32
name|channel_init_len
decl_stmt|,
name|channel_total_len
decl_stmt|;
name|guint32
name|compressed_len
decl_stmt|,
name|uncompressed_len
decl_stmt|;
name|guint16
name|bitmap_type
decl_stmt|,
name|channel_type
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|,
name|bytespp
decl_stmt|,
name|offset
decl_stmt|;
name|guchar
modifier|*
modifier|*
name|pixels
decl_stmt|,
modifier|*
name|pixel
decl_stmt|;
name|GeglBuffer
modifier|*
name|buffer
decl_stmt|;
name|block_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
while|while
condition|(
name|ftell
argument_list|(
name|f
argument_list|)
operator|<
name|block_start
operator|+
name|total_len
condition|)
block|{
comment|/* Read the layer sub-block header */
name|sub_id
operator|=
name|read_block_header
argument_list|(
name|f
argument_list|,
operator|&
name|sub_init_len
argument_list|,
operator|&
name|sub_total_len
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|sub_id
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|sub_id
operator|!=
name|PSP_LAYER_BLOCK
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Invalid layer sub-block %s, should be LAYER"
argument_list|)
argument_list|,
name|block_name
argument_list|(
name|sub_id
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sub_block_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Read layer information chunk */
if|if
condition|(
name|psp_ver_major
operator|>=
literal|4
condition|)
block|{
if|if
condition|(
name|fseek
argument_list|(
name|f
argument_list|,
literal|4
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
operator|||
name|fread
argument_list|(
operator|&
name|namelen
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
operator|(
operator|(
name|namelen
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|namelen
argument_list|)
operator|)
operator|&&
name|FALSE
operator|)
operator|||
operator|(
name|name
operator|=
name|g_malloc
argument_list|(
name|namelen
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|fread
argument_list|(
name|name
argument_list|,
name|namelen
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|type
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|image_rect
argument_list|,
literal|16
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|saved_image_rect
argument_list|,
literal|16
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|opacity
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blend_mode
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|visibility
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|transparency_protected
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|link_group_id
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|mask_rect
argument_list|,
literal|16
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|saved_mask_rect
argument_list|,
literal|16
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|mask_linked
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|mask_disabled
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fseek
argument_list|(
name|f
argument_list|,
literal|47
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
operator|||
name|fread
argument_list|(
operator|&
name|bitmap_count
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|channel_count
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading layer information chunk"
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|name
index|[
name|namelen
index|]
operator|=
literal|0
expr_stmt|;
name|type
operator|=
name|PSP_LAYER_NORMAL
expr_stmt|;
comment|/* ??? */
block|}
else|else
block|{
name|name
operator|=
name|g_malloc
argument_list|(
literal|257
argument_list|)
expr_stmt|;
name|name
index|[
literal|256
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|name
argument_list|,
literal|256
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|type
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|image_rect
argument_list|,
literal|16
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|saved_image_rect
argument_list|,
literal|16
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|opacity
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|blend_mode
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|visibility
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|transparency_protected
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|link_group_id
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|mask_rect
argument_list|,
literal|16
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|saved_mask_rect
argument_list|,
literal|16
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|mask_linked
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|mask_disabled
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fseek
argument_list|(
name|f
argument_list|,
literal|43
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
operator|||
name|fread
argument_list|(
operator|&
name|bitmap_count
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|channel_count
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading layer information chunk"
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|type
operator|==
name|PSP_LAYER_FLOATING_SELECTION
condition|)
name|g_message
argument_list|(
literal|"Floating selection restored as normal layer"
argument_list|)
expr_stmt|;
name|swab_rect
argument_list|(
name|image_rect
argument_list|)
expr_stmt|;
name|swab_rect
argument_list|(
name|saved_image_rect
argument_list|)
expr_stmt|;
name|swab_rect
argument_list|(
name|mask_rect
argument_list|)
expr_stmt|;
name|swab_rect
argument_list|(
name|saved_mask_rect
argument_list|)
expr_stmt|;
name|bitmap_count
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|bitmap_count
argument_list|)
expr_stmt|;
name|channel_count
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|channel_count
argument_list|)
expr_stmt|;
name|layer_mode
operator|=
name|gimp_layer_mode_from_psp_blend_mode
argument_list|(
name|blend_mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|layer_mode
operator|==
operator|-
literal|1
condition|)
block|{
name|g_message
argument_list|(
literal|"Unsupported PSP layer blend mode %s "
literal|"for layer %s, setting layer invisible"
argument_list|,
name|blend_mode_name
argument_list|(
name|blend_mode
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|layer_mode
operator|=
name|GIMP_LAYER_MODE_NORMAL_LEGACY
expr_stmt|;
name|visibility
operator|=
name|FALSE
expr_stmt|;
block|}
name|width
operator|=
name|saved_image_rect
index|[
literal|2
index|]
operator|-
name|saved_image_rect
index|[
literal|0
index|]
expr_stmt|;
name|height
operator|=
name|saved_image_rect
index|[
literal|3
index|]
operator|-
name|saved_image_rect
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|width
operator|<
literal|0
operator|)
operator|||
operator|(
name|width
operator|>
name|GIMP_MAX_IMAGE_SIZE
operator|)
comment|/* w<= 2^18 */
operator|||
operator|(
name|height
operator|<
literal|0
operator|)
operator|||
operator|(
name|height
operator|>
name|GIMP_MAX_IMAGE_SIZE
operator|)
comment|/* h<= 2^18 */
operator|||
operator|(
operator|(
name|width
operator|/
literal|256
operator|)
operator|*
operator|(
name|height
operator|/
literal|256
operator|)
operator|>=
literal|8192
operator|)
condition|)
comment|/* w * h< 2^29 */
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Invalid layer dimensions: %dx%d"
argument_list|)
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_message
argument_list|(
literal|"layer: %s %dx%d (%dx%d) @%d,%d opacity %d blend_mode %s "
literal|"%d bitmaps %d channels"
argument_list|,
name|name
argument_list|,
name|image_rect
index|[
literal|2
index|]
operator|-
name|image_rect
index|[
literal|0
index|]
argument_list|,
name|image_rect
index|[
literal|3
index|]
operator|-
name|image_rect
index|[
literal|1
index|]
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|saved_image_rect
index|[
literal|0
index|]
argument_list|,
name|saved_image_rect
index|[
literal|1
index|]
argument_list|,
name|opacity
argument_list|,
name|blend_mode_name
argument_list|(
name|blend_mode
argument_list|)
argument_list|,
name|bitmap_count
argument_list|,
name|channel_count
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_message
argument_list|(
literal|"mask %dx%d (%dx%d) @%d,%d"
argument_list|,
name|mask_rect
index|[
literal|2
index|]
operator|-
name|mask_rect
index|[
literal|0
index|]
argument_list|,
name|mask_rect
index|[
literal|3
index|]
operator|-
name|mask_rect
index|[
literal|1
index|]
argument_list|,
name|saved_mask_rect
index|[
literal|2
index|]
operator|-
name|saved_mask_rect
index|[
literal|0
index|]
argument_list|,
name|saved_mask_rect
index|[
literal|3
index|]
operator|-
name|saved_mask_rect
index|[
literal|1
index|]
argument_list|,
name|saved_mask_rect
index|[
literal|0
index|]
argument_list|,
name|saved_mask_rect
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|width
operator|==
literal|0
condition|)
block|{
name|width
operator|++
expr_stmt|;
name|null_layer
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|height
operator|==
literal|0
condition|)
block|{
name|height
operator|++
expr_stmt|;
name|null_layer
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|ia
operator|->
name|grayscale
condition|)
if|if
condition|(
operator|!
name|null_layer
operator|&&
name|bitmap_count
operator|==
literal|1
condition|)
name|drawable_type
operator|=
name|GIMP_GRAY_IMAGE
operator|,
name|bytespp
operator|=
literal|1
expr_stmt|;
else|else
name|drawable_type
operator|=
name|GIMP_GRAYA_IMAGE
operator|,
name|bytespp
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|null_layer
operator|&&
name|bitmap_count
operator|==
literal|1
condition|)
name|drawable_type
operator|=
name|GIMP_RGB_IMAGE
operator|,
name|bytespp
operator|=
literal|3
expr_stmt|;
else|else
name|drawable_type
operator|=
name|GIMP_RGBA_IMAGE
operator|,
name|bytespp
operator|=
literal|4
expr_stmt|;
name|layer_ID
operator|=
name|gimp_layer_new
argument_list|(
name|image_ID
argument_list|,
name|name
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|drawable_type
argument_list|,
literal|100.0
operator|*
name|opacity
operator|/
literal|255.0
argument_list|,
name|layer_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_ID
operator|==
operator|-
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error creating layer"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|gimp_image_insert_layer
argument_list|(
name|image_ID
argument_list|,
name|layer_ID
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|saved_image_rect
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
name|saved_image_rect
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
name|gimp_layer_set_offsets
argument_list|(
name|layer_ID
argument_list|,
name|saved_image_rect
index|[
literal|0
index|]
argument_list|,
name|saved_image_rect
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|visibility
condition|)
name|gimp_item_set_visible
argument_list|(
name|layer_ID
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_layer_set_lock_alpha
argument_list|(
name|layer_ID
argument_list|,
name|transparency_protected
argument_list|)
expr_stmt|;
if|if
condition|(
name|psp_ver_major
operator|<
literal|4
condition|)
if|if
condition|(
name|try_fseek
argument_list|(
name|f
argument_list|,
name|sub_block_start
operator|+
name|sub_init_len
argument_list|,
name|SEEK_SET
argument_list|,
name|error
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|pixel
operator|=
name|g_malloc0
argument_list|(
name|height
operator|*
name|width
operator|*
name|bytespp
argument_list|)
expr_stmt|;
if|if
condition|(
name|null_layer
condition|)
block|{
name|pixels
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|pixels
operator|=
name|g_new
argument_list|(
name|guchar
operator|*
argument_list|,
name|height
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|height
condition|;
name|i
operator|++
control|)
name|pixels
index|[
name|i
index|]
operator|=
name|pixel
operator|+
name|width
operator|*
name|bytespp
operator|*
name|i
expr_stmt|;
block|}
name|buffer
operator|=
name|gimp_drawable_get_buffer
argument_list|(
name|layer_ID
argument_list|)
expr_stmt|;
comment|/* Read the layer channel sub-blocks */
while|while
condition|(
name|ftell
argument_list|(
name|f
argument_list|)
operator|<
name|sub_block_start
operator|+
name|sub_total_len
condition|)
block|{
name|sub_id
operator|=
name|read_block_header
argument_list|(
name|f
argument_list|,
operator|&
name|channel_init_len
argument_list|,
operator|&
name|channel_total_len
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|sub_id
operator|==
operator|-
literal|1
condition|)
block|{
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sub_id
operator|!=
name|PSP_CHANNEL_BLOCK
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Invalid layer sub-block %s, should be CHANNEL"
argument_list|)
argument_list|,
name|block_name
argument_list|(
name|sub_id
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|channel_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|psp_ver_major
operator|==
literal|4
condition|)
name|fseek
argument_list|(
name|f
argument_list|,
literal|4
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
comment|/* Unknown field */
if|if
condition|(
name|fread
argument_list|(
operator|&
name|compressed_len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|uncompressed_len
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|bitmap_type
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|channel_type
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading channel information chunk"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|compressed_len
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|compressed_len
argument_list|)
expr_stmt|;
name|uncompressed_len
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|uncompressed_len
argument_list|)
expr_stmt|;
name|bitmap_type
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|bitmap_type
argument_list|)
expr_stmt|;
name|channel_type
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|channel_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitmap_type
operator|>
name|PSP_DIB_USER_MASK
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Invalid bitmap type %d in channel information chunk"
argument_list|)
argument_list|,
name|bitmap_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|channel_type
operator|>
name|PSP_CHANNEL_BLUE
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Invalid channel type %d in channel information chunk"
argument_list|)
argument_list|,
name|channel_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_message
argument_list|(
literal|"channel: %s %s %d (%d) bytes %d bytespp"
argument_list|,
name|bitmap_type_name
argument_list|(
name|bitmap_type
argument_list|)
argument_list|,
name|channel_type_name
argument_list|(
name|channel_type
argument_list|)
argument_list|,
name|uncompressed_len
argument_list|,
name|compressed_len
argument_list|,
name|bytespp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitmap_type
operator|==
name|PSP_DIB_TRANS_MASK
condition|)
name|offset
operator|=
literal|3
expr_stmt|;
else|else
name|offset
operator|=
name|channel_type
operator|-
name|PSP_CHANNEL_RED
expr_stmt|;
if|if
condition|(
name|psp_ver_major
operator|<
literal|4
condition|)
if|if
condition|(
name|try_fseek
argument_list|(
name|f
argument_list|,
name|channel_start
operator|+
name|channel_init_len
argument_list|,
name|SEEK_SET
argument_list|,
name|error
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|null_layer
condition|)
if|if
condition|(
name|read_channel_data
argument_list|(
name|f
argument_list|,
name|ia
argument_list|,
name|pixels
argument_list|,
name|bytespp
argument_list|,
name|offset
argument_list|,
name|buffer
argument_list|,
name|compressed_len
argument_list|,
name|error
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|try_fseek
argument_list|(
name|f
argument_list|,
name|channel_start
operator|+
name|channel_total_len
argument_list|,
name|SEEK_SET
argument_list|,
name|error
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
name|gegl_buffer_set
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|pixel
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|pixels
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|pixel
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|try_fseek
argument_list|(
name|f
argument_list|,
name|block_start
operator|+
name|total_len
argument_list|,
name|SEEK_SET
argument_list|,
name|error
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
name|layer_ID
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|read_tube_block (FILE * f,gint image_ID,guint total_len,PSPimage * ia,GError ** error)
name|read_tube_block
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|gint
name|image_ID
parameter_list|,
name|guint
name|total_len
parameter_list|,
name|PSPimage
modifier|*
name|ia
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|guint16
name|version
decl_stmt|;
name|guchar
name|name
index|[
literal|514
index|]
decl_stmt|;
name|guint32
name|step_size
decl_stmt|,
name|column_count
decl_stmt|,
name|row_count
decl_stmt|,
name|cell_count
decl_stmt|;
name|guint32
name|placement_mode
decl_stmt|,
name|selection_mode
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|GimpPixPipeParams
name|params
decl_stmt|;
name|GimpParasite
modifier|*
name|pipe_parasite
decl_stmt|;
name|gchar
modifier|*
name|parasite_text
decl_stmt|;
name|gimp_pixpipe_params_init
argument_list|(
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|&
name|version
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
name|name
argument_list|,
literal|513
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|step_size
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|column_count
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|row_count
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|cell_count
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|placement_mode
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|selection_mode
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading tube data chunk"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|name
index|[
literal|513
index|]
operator|=
literal|0
expr_stmt|;
name|version
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|params
operator|.
name|step
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|step_size
argument_list|)
expr_stmt|;
name|params
operator|.
name|cols
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|column_count
argument_list|)
expr_stmt|;
name|params
operator|.
name|rows
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|row_count
argument_list|)
expr_stmt|;
name|params
operator|.
name|ncells
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|cell_count
argument_list|)
expr_stmt|;
name|placement_mode
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|placement_mode
argument_list|)
expr_stmt|;
name|selection_mode
operator|=
name|GUINT32_FROM_LE
argument_list|(
name|selection_mode
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|params
operator|.
name|cols
condition|;
name|i
operator|++
control|)
name|gimp_image_add_vguide
argument_list|(
name|image_ID
argument_list|,
operator|(
name|ia
operator|->
name|width
operator|*
name|i
operator|)
operator|/
name|params
operator|.
name|cols
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|params
operator|.
name|rows
condition|;
name|i
operator|++
control|)
name|gimp_image_add_hguide
argument_list|(
name|image_ID
argument_list|,
operator|(
name|ia
operator|->
name|height
operator|*
name|i
operator|)
operator|/
name|params
operator|.
name|rows
argument_list|)
expr_stmt|;
comment|/* We use a parasite to pass in the tube (pipe) parameters in    * case we will have any use of those, for instance in the gpb    * plug-in that exports a GIMP image pipe.    */
name|params
operator|.
name|dim
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|cellwidth
operator|=
name|ia
operator|->
name|width
operator|/
name|params
operator|.
name|cols
expr_stmt|;
name|params
operator|.
name|cellheight
operator|=
name|ia
operator|->
name|height
operator|/
name|params
operator|.
name|rows
expr_stmt|;
name|params
operator|.
name|placement
operator|=
operator|(
name|placement_mode
operator|==
name|tpmRandom
condition|?
literal|"random"
else|:
operator|(
name|placement_mode
operator|==
name|tpmConstant
condition|?
literal|"constant"
else|:
literal|"default"
operator|)
operator|)
expr_stmt|;
name|params
operator|.
name|rank
index|[
literal|0
index|]
operator|=
name|params
operator|.
name|ncells
expr_stmt|;
name|params
operator|.
name|selection
index|[
literal|0
index|]
operator|=
operator|(
name|selection_mode
operator|==
name|tsmRandom
condition|?
literal|"random"
else|:
operator|(
name|selection_mode
operator|==
name|tsmIncremental
condition|?
literal|"incremental"
else|:
operator|(
name|selection_mode
operator|==
name|tsmAngular
condition|?
literal|"angular"
else|:
operator|(
name|selection_mode
operator|==
name|tsmPressure
condition|?
literal|"pressure"
else|:
operator|(
name|selection_mode
operator|==
name|tsmVelocity
condition|?
literal|"velocity"
else|:
literal|"default"
operator|)
operator|)
operator|)
operator|)
operator|)
expr_stmt|;
name|parasite_text
operator|=
name|gimp_pixpipe_params_build
argument_list|(
operator|&
name|params
argument_list|)
expr_stmt|;
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_message
argument_list|(
literal|"parasite: %s"
argument_list|,
name|parasite_text
argument_list|)
expr_stmt|;
name|pipe_parasite
operator|=
name|gimp_parasite_new
argument_list|(
literal|"gimp-brush-pipe-parameters"
argument_list|,
name|GIMP_PARASITE_PERSISTENT
argument_list|,
name|strlen
argument_list|(
name|parasite_text
argument_list|)
operator|+
literal|1
argument_list|,
name|parasite_text
argument_list|)
expr_stmt|;
name|gimp_image_attach_parasite
argument_list|(
name|image_ID
argument_list|,
name|pipe_parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|pipe_parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|parasite_text
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|gchar
modifier|*
DECL|function|compression_name (gint compression)
name|compression_name
parameter_list|(
name|gint
name|compression
parameter_list|)
block|{
switch|switch
condition|(
name|compression
condition|)
block|{
case|case
name|PSP_COMP_NONE
case|:
return|return
literal|"no compression"
return|;
case|case
name|PSP_COMP_RLE
case|:
return|return
literal|"RLE"
return|;
case|case
name|PSP_COMP_LZ77
case|:
return|return
literal|"LZ77"
return|;
block|}
name|g_assert_not_reached
argument_list|()
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* The main function for loading PSP-images  */
end_comment

begin_function
specifier|static
name|gint32
DECL|function|load_image (const gchar * filename,GError ** error)
name|load_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|PSPimage
name|ia
decl_stmt|;
name|guint32
name|block_init_len
decl_stmt|,
name|block_total_len
decl_stmt|;
name|long
name|block_start
decl_stmt|;
name|PSPBlockID
name|id
init|=
operator|-
literal|1
decl_stmt|;
name|gint
name|block_number
decl_stmt|;
name|gint32
name|image_ID
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|g_stat
argument_list|(
name|filename
argument_list|,
operator|&
name|st
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|g_file_error_from_errno
argument_list|(
name|errno
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Could not open '%s' for reading: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Read the PSP File Header and determine file version */
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|32
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|psp_ver_major
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
operator|||
name|fread
argument_list|(
operator|&
name|psp_ver_minor
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|<
literal|1
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Error reading file header."
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
literal|"Paint Shop Pro Image File\n\032\0\0\0\0\0"
argument_list|,
literal|32
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Incorrect file signature."
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|psp_ver_major
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|psp_ver_major
argument_list|)
expr_stmt|;
name|psp_ver_minor
operator|=
name|GUINT16_FROM_LE
argument_list|(
name|psp_ver_minor
argument_list|)
expr_stmt|;
comment|/* I only have the documentation for file format version 3.0,    * but PSP 6 writes version 4.0. Let's hope it's backwards compatible.    * Earlier versions probably don't have all the fields I expect    * so don't accept those.    */
if|if
condition|(
name|psp_ver_major
operator|!=
literal|3
operator|&&
name|psp_ver_major
operator|!=
literal|4
operator|&&
name|psp_ver_major
operator|!=
literal|5
operator|&&
name|psp_ver_major
operator|!=
literal|6
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Unsupported PSP file format version %d.%d."
argument_list|)
argument_list|,
name|psp_ver_major
argument_list|,
name|psp_ver_minor
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* Read all the blocks */
name|block_number
operator|=
literal|0
expr_stmt|;
name|IFDBG
argument_list|(
literal|3
argument_list|)
name|g_message
argument_list|(
literal|"size = %d"
argument_list|,
operator|(
name|int
operator|)
name|st
operator|.
name|st_size
argument_list|)
expr_stmt|;
while|while
condition|(
name|ftell
argument_list|(
name|f
argument_list|)
operator|!=
name|st
operator|.
name|st_size
operator|&&
operator|(
name|id
operator|=
name|read_block_header
argument_list|(
name|f
argument_list|,
operator|&
name|block_init_len
argument_list|,
operator|&
name|block_total_len
argument_list|,
name|error
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|block_start
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|block_start
operator|+
name|block_total_len
operator|>
name|st
operator|.
name|st_size
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Could not open '%s' for reading: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"invalid block size"
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|id
operator|==
name|PSP_IMAGE_BLOCK
condition|)
block|{
if|if
condition|(
name|block_number
operator|!=
literal|0
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Duplicate General Image Attributes block."
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|read_general_image_attribute_block
argument_list|(
name|f
argument_list|,
name|block_init_len
argument_list|,
name|block_total_len
argument_list|,
operator|&
name|ia
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|IFDBG
argument_list|(
literal|2
argument_list|)
name|g_message
argument_list|(
literal|"%d dpi %dx%d %s"
argument_list|,
operator|(
name|int
operator|)
name|ia
operator|.
name|resolution
argument_list|,
name|ia
operator|.
name|width
argument_list|,
name|ia
operator|.
name|height
argument_list|,
name|compression_name
argument_list|(
name|ia
operator|.
name|compression
argument_list|)
argument_list|)
expr_stmt|;
name|image_ID
operator|=
name|gimp_image_new
argument_list|(
name|ia
operator|.
name|width
argument_list|,
name|ia
operator|.
name|height
argument_list|,
name|ia
operator|.
name|grayscale
condition|?
name|GIMP_GRAY
else|:
name|GIMP_RGB
argument_list|)
expr_stmt|;
if|if
condition|(
name|image_ID
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|gimp_image_set_filename
argument_list|(
name|image_ID
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gimp_image_set_resolution
argument_list|(
name|image_ID
argument_list|,
name|ia
operator|.
name|resolution
argument_list|,
name|ia
operator|.
name|resolution
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|block_number
operator|==
literal|0
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Missing General Image Attributes block."
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|PSP_CREATOR_BLOCK
case|:
if|if
condition|(
name|read_creator_block
argument_list|(
name|f
argument_list|,
name|image_ID
argument_list|,
name|block_total_len
argument_list|,
operator|&
name|ia
argument_list|,
name|error
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|error
goto|;
break|break;
case|case
name|PSP_COLOR_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_LAYER_START_BLOCK
case|:
if|if
condition|(
name|read_layer_block
argument_list|(
name|f
argument_list|,
name|image_ID
argument_list|,
name|block_total_len
argument_list|,
operator|&
name|ia
argument_list|,
name|error
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|error
goto|;
break|break;
case|case
name|PSP_SELECTION_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_ALPHA_BANK_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_THUMBNAIL_BLOCK
case|:
break|break;
comment|/* No use for it */
case|case
name|PSP_EXTENDED_DATA_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_TUBE_BLOCK
case|:
if|if
condition|(
name|read_tube_block
argument_list|(
name|f
argument_list|,
name|image_ID
argument_list|,
name|block_total_len
argument_list|,
operator|&
name|ia
argument_list|,
name|error
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|error
goto|;
break|break;
case|case
name|PSP_COMPOSITE_IMAGE_BANK_BLOCK
case|:
break|break;
comment|/* Not yet implemented */
case|case
name|PSP_LAYER_BLOCK
case|:
case|case
name|PSP_CHANNEL_BLOCK
case|:
case|case
name|PSP_ALPHA_CHANNEL_BLOCK
case|:
case|case
name|PSP_ADJUSTMENT_EXTENSION_BLOCK
case|:
case|case
name|PSP_VECTOR_EXTENSION_BLOCK
case|:
case|case
name|PSP_SHAPE_BLOCK
case|:
case|case
name|PSP_PAINTSTYLE_BLOCK
case|:
case|case
name|PSP_COMPOSITE_ATTRIBUTES_BLOCK
case|:
case|case
name|PSP_JPEG_BLOCK
case|:
name|g_message
argument_list|(
literal|"Sub-block %s should not occur "
literal|"at main level of file"
argument_list|,
name|block_name
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_message
argument_list|(
literal|"Unrecognized block id %d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|block_start
operator|+
name|block_total_len
operator|>=
name|st
operator|.
name|st_size
condition|)
break|break;
if|if
condition|(
name|try_fseek
argument_list|(
name|f
argument_list|,
name|block_start
operator|+
name|block_total_len
argument_list|,
name|SEEK_SET
argument_list|,
name|error
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
name|block_number
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|id
operator|==
operator|-
literal|1
condition|)
block|{
name|error
label|:
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|image_ID
operator|!=
operator|-
literal|1
condition|)
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|image_ID
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|save_image (const gchar * filename,gint32 image_ID,gint32 drawable_ID,GError ** error)
name|save_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|G_FILE_ERROR_FAILED
argument_list|,
name|_
argument_list|(
literal|"Exporting not implemented yet."
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GimpParam
name|values
index|[
literal|2
index|]
decl_stmt|;
name|GimpRunMode
name|run_mode
decl_stmt|;
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
name|gint32
name|image_ID
decl_stmt|;
name|gint32
name|drawable_ID
decl_stmt|;
name|GimpExportReturn
name|export
init|=
name|GIMP_EXPORT_CANCEL
decl_stmt|;
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
name|gegl_init
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|LOAD_PROC
argument_list|)
operator|==
literal|0
condition|)
block|{
name|GFile
modifier|*
name|file
init|=
name|g_file_new_for_uri
argument_list|(
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|)
decl_stmt|;
name|image_ID
operator|=
name|load_image
argument_list|(
name|g_file_get_path
argument_list|(
name|file
argument_list|)
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|image_ID
operator|!=
operator|-
literal|1
condition|)
block|{
operator|*
name|nreturn_vals
operator|=
literal|2
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_IMAGE
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
operator|=
name|image_ID
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|SAVE_PROC
argument_list|)
operator|==
literal|0
condition|)
block|{
name|image_ID
operator|=
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|drawable_ID
operator|=
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
comment|/*  eventually export the image */
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|GIMP_RUN_INTERACTIVE
case|:
case|case
name|GIMP_RUN_WITH_LAST_VALS
case|:
name|gimp_ui_init
argument_list|(
name|PLUG_IN_BINARY
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|export
operator|=
name|gimp_export_image
argument_list|(
operator|&
name|image_ID
argument_list|,
operator|&
name|drawable_ID
argument_list|,
literal|"PSP"
argument_list|,
name|GIMP_EXPORT_CAN_HANDLE_RGB
operator||
name|GIMP_EXPORT_CAN_HANDLE_GRAY
operator||
name|GIMP_EXPORT_CAN_HANDLE_INDEXED
operator||
name|GIMP_EXPORT_CAN_HANDLE_ALPHA
operator||
name|GIMP_EXPORT_CAN_HANDLE_LAYERS
argument_list|)
expr_stmt|;
if|if
condition|(
name|export
operator|==
name|GIMP_EXPORT_CANCEL
condition|)
block|{
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_CANCEL
expr_stmt|;
return|return;
block|}
break|break;
default|default:
break|break;
block|}
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|GIMP_RUN_INTERACTIVE
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
name|SAVE_PROC
argument_list|,
operator|&
name|psvals
argument_list|)
expr_stmt|;
comment|/*  First acquire information with a dialog  */
if|if
condition|(
operator|!
name|save_dialog
argument_list|()
condition|)
name|status
operator|=
name|GIMP_PDB_CANCEL
expr_stmt|;
break|break;
case|case
name|GIMP_RUN_NONINTERACTIVE
case|:
comment|/*  Make sure all the arguments are there!  */
if|if
condition|(
name|nparams
operator|!=
literal|6
condition|)
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
else|else
block|{
name|psvals
operator|.
name|compression
operator|=
operator|(
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
if|if
condition|(
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
operator|<
literal|0
operator|||
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
operator|>
name|PSP_COMP_LZ77
condition|)
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
case|case
name|GIMP_RUN_WITH_LAST_VALS
case|:
name|gimp_get_data
argument_list|(
name|SAVE_PROC
argument_list|,
operator|&
name|psvals
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
block|{
name|GFile
modifier|*
name|file
init|=
name|g_file_new_for_uri
argument_list|(
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|)
decl_stmt|;
if|if
condition|(
name|save_image
argument_list|(
name|g_file_get_path
argument_list|(
name|file
argument_list|)
argument_list|,
name|image_ID
argument_list|,
name|drawable_ID
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|gimp_set_data
argument_list|(
name|SAVE_PROC
argument_list|,
operator|&
name|psvals
argument_list|,
sizeof|sizeof
argument_list|(
name|PSPSaveVals
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
block|}
block|}
if|if
condition|(
name|export
operator|==
name|GIMP_EXPORT_EXPORT
condition|)
name|gimp_image_delete
argument_list|(
name|image_ID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|GIMP_PDB_SUCCESS
operator|&&
name|error
condition|)
block|{
operator|*
name|nreturn_vals
operator|=
literal|2
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
operator|=
name|error
operator|->
name|message
expr_stmt|;
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
block|}
end_function

end_unit

