begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_comment
comment|/*  * SphereDesigner v0.4 - creates textured spheres  * by Vidar Madsen<vidar@prosalg.no>  *  * Status: Last updated 1999-09-11  *  * Known issues:  * - Might crash if you click OK or Cancel before first preview is rendered  * - Phong might look weird with transparent textures  *  * Todo:  * - Saving / Loading of presets needs an overhaul  * - Antialiasing  * - Global controls: Gamma, ++  * - Beautification of GUI  * - Clean up messy source (lots of Glade remnants)  * - (Probably more. ;-)  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_define
DECL|macro|PLUG_IN_PROC
define|#
directive|define
name|PLUG_IN_PROC
value|"plug-in-spheredesigner"
end_define

begin_define
DECL|macro|PLUG_IN_BINARY
define|#
directive|define
name|PLUG_IN_BINARY
value|"sphere-designer"
end_define

begin_define
DECL|macro|RESPONSE_RESET
define|#
directive|define
name|RESPONSE_RESET
value|1
end_define

begin_define
DECL|macro|PREVIEWSIZE
define|#
directive|define
name|PREVIEWSIZE
value|150
end_define

begin_comment
comment|/* These must be adjusted as more functionality is added */
end_comment

begin_define
DECL|macro|MAXOBJECT
define|#
directive|define
name|MAXOBJECT
value|5
end_define

begin_define
DECL|macro|MAXLIGHT
define|#
directive|define
name|MAXLIGHT
value|5
end_define

begin_define
DECL|macro|MAXTEXTURE
define|#
directive|define
name|MAXTEXTURE
value|20
end_define

begin_define
DECL|macro|MAXTEXTUREPEROBJ
define|#
directive|define
name|MAXTEXTUREPEROBJ
value|20
end_define

begin_define
DECL|macro|MAXNORMAL
define|#
directive|define
name|MAXNORMAL
value|20
end_define

begin_define
DECL|macro|MAXNORMALPEROBJ
define|#
directive|define
name|MAXNORMALPEROBJ
value|20
end_define

begin_define
DECL|macro|MAXATMOS
define|#
directive|define
name|MAXATMOS
value|1
end_define

begin_define
DECL|macro|MAXCOLPERGRADIENT
define|#
directive|define
name|MAXCOLPERGRADIENT
value|5
end_define

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
specifier|const
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc  */
name|NULL
block|,
comment|/* quit_proc  */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc   */
block|}
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
DECL|enum|__anon2ade8fc30103
block|{
DECL|enumerator|TRIANGLE
name|TRIANGLE
block|,
DECL|enumerator|DISC
name|DISC
block|,
DECL|enumerator|PLANE
name|PLANE
block|,
DECL|enumerator|SPHERE
name|SPHERE
block|,
DECL|enumerator|CYLINDER
name|CYLINDER
block|,
DECL|enumerator|LIGHT
name|LIGHT
block|}
enum|;
end_enum

begin_enum
enum|enum
DECL|enum|__anon2ade8fc30203
block|{
DECL|enumerator|SOLID
name|SOLID
block|,
DECL|enumerator|CHECKER
name|CHECKER
block|,
DECL|enumerator|MARBLE
name|MARBLE
block|,
DECL|enumerator|LIZARD
name|LIZARD
block|,
DECL|enumerator|IMAGE
name|IMAGE
block|,
DECL|enumerator|PHONG
name|PHONG
block|,
DECL|enumerator|REFLECTION
name|REFLECTION
block|,
DECL|enumerator|REFRACTION
name|REFRACTION
block|,
DECL|enumerator|PERLIN
name|PERLIN
block|,
DECL|enumerator|WOOD
name|WOOD
block|,
DECL|enumerator|TRANSPARENT
name|TRANSPARENT
block|,
DECL|enumerator|SPIRAL
name|SPIRAL
block|,
DECL|enumerator|SPOTS
name|SPOTS
block|,
DECL|enumerator|SMOKE
name|SMOKE
block|}
enum|;
end_enum

begin_enum
enum|enum
DECL|enum|__anon2ade8fc30303
block|{
DECL|enumerator|PERSPECTIVE
name|PERSPECTIVE
block|,
DECL|enumerator|ORTHOGONAL
name|ORTHOGONAL
block|,
DECL|enumerator|FISHEYE
name|FISHEYE
block|}
enum|;
end_enum

begin_enum
enum|enum
DECL|enum|__anon2ade8fc30403
block|{
DECL|enumerator|FOG
name|FOG
block|}
enum|;
end_enum

begin_enum
enum|enum
DECL|enum|__anon2ade8fc30503
block|{
DECL|enumerator|TYPE
name|TYPE
block|,
DECL|enumerator|TEXTURE
name|TEXTURE
block|,
DECL|enumerator|NUM_COLUMNS
name|NUM_COLUMNS
block|}
enum|;
end_enum

begin_comment
comment|/* World-flags */
end_comment

begin_define
DECL|macro|SMARTAMBIENT
define|#
directive|define
name|SMARTAMBIENT
value|0x00000001
end_define

begin_comment
comment|/* Object-flags */
end_comment

begin_define
DECL|macro|NOSHADOW
define|#
directive|define
name|NOSHADOW
value|0x00000001
end_define

begin_comment
comment|/* Texture-flags */
end_comment

begin_define
DECL|macro|GRADIENT
define|#
directive|define
name|GRADIENT
value|0x00000001
end_define

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30608
block|{
DECL|member|xsize
DECL|member|ysize
name|gshort
name|xsize
decl_stmt|,
name|ysize
decl_stmt|;
DECL|member|rgb
name|guchar
modifier|*
name|rgb
decl_stmt|;
DECL|typedef|image
block|}
name|image
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30708
block|{
DECL|member|numcol
name|gshort
name|numcol
decl_stmt|;
DECL|member|pos
name|gdouble
name|pos
index|[
name|MAXCOLPERGRADIENT
index|]
decl_stmt|;
DECL|member|color
name|GimpVector4
name|color
index|[
name|MAXCOLPERGRADIENT
index|]
decl_stmt|;
DECL|typedef|gradient
block|}
name|gradient
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30808
block|{
DECL|member|majtype
name|gint
name|majtype
decl_stmt|;
DECL|member|type
name|gint
name|type
decl_stmt|;
DECL|member|flags
name|gulong
name|flags
decl_stmt|;
DECL|member|color1
DECL|member|color2
name|GimpVector4
name|color1
decl_stmt|,
name|color2
decl_stmt|;
DECL|member|gradient
name|gradient
name|gradient
decl_stmt|;
DECL|member|ambient
DECL|member|diffuse
name|GimpVector4
name|ambient
decl_stmt|,
name|diffuse
decl_stmt|;
DECL|member|oscale
name|gdouble
name|oscale
decl_stmt|;
DECL|member|scale
DECL|member|translate
DECL|member|rotate
name|GimpVector4
name|scale
decl_stmt|,
name|translate
decl_stmt|,
name|rotate
decl_stmt|;
DECL|member|image
name|image
name|image
decl_stmt|;
DECL|member|reflection
name|GimpVector4
name|reflection
decl_stmt|;
DECL|member|refraction
name|GimpVector4
name|refraction
decl_stmt|;
DECL|member|transparent
name|GimpVector4
name|transparent
decl_stmt|;
DECL|member|ior
name|gdouble
name|ior
decl_stmt|;
DECL|member|phongcolor
name|GimpVector4
name|phongcolor
decl_stmt|;
DECL|member|phongsize
name|gdouble
name|phongsize
decl_stmt|;
DECL|member|amount
name|gdouble
name|amount
decl_stmt|;
DECL|member|exp
name|gdouble
name|exp
decl_stmt|;
DECL|member|turbulence
name|GimpVector4
name|turbulence
decl_stmt|;
DECL|typedef|texture
block|}
name|texture
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30908
block|{
DECL|member|type
name|gshort
name|type
decl_stmt|;
DECL|member|density
name|gdouble
name|density
decl_stmt|;
DECL|member|color
name|GimpVector4
name|color
decl_stmt|;
DECL|member|turbulence
name|gdouble
name|turbulence
decl_stmt|;
DECL|typedef|atmos
block|}
name|atmos
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30a08
block|{
DECL|member|type
name|gshort
name|type
decl_stmt|;
DECL|member|flags
name|gulong
name|flags
decl_stmt|;
DECL|member|numtexture
name|gshort
name|numtexture
decl_stmt|;
DECL|member|texture
name|texture
name|texture
index|[
name|MAXTEXTUREPEROBJ
index|]
decl_stmt|;
DECL|member|numnormal
name|gshort
name|numnormal
decl_stmt|;
DECL|member|normal
name|texture
name|normal
index|[
name|MAXNORMALPEROBJ
index|]
decl_stmt|;
DECL|typedef|common
block|}
name|common
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30b08
block|{
DECL|member|com
name|common
name|com
decl_stmt|;
DECL|member|a
DECL|member|b
DECL|member|c
name|GimpVector4
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
DECL|typedef|triangle
block|}
name|triangle
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30c08
block|{
DECL|member|com
name|common
name|com
decl_stmt|;
DECL|member|a
name|GimpVector4
name|a
decl_stmt|;
DECL|member|b
DECL|member|r
name|gdouble
name|b
decl_stmt|,
name|r
decl_stmt|;
DECL|typedef|disc
block|}
name|disc
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30d08
block|{
DECL|member|com
name|common
name|com
decl_stmt|;
DECL|member|a
name|GimpVector4
name|a
decl_stmt|;
DECL|member|r
name|gdouble
name|r
decl_stmt|;
DECL|typedef|sphere
block|}
name|sphere
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30e08
block|{
DECL|member|com
name|common
name|com
decl_stmt|;
DECL|member|a
DECL|member|b
DECL|member|c
name|GimpVector4
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
DECL|typedef|cylinder
block|}
name|cylinder
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc30f08
block|{
DECL|member|com
name|common
name|com
decl_stmt|;
DECL|member|a
name|GimpVector4
name|a
decl_stmt|;
DECL|member|b
name|gdouble
name|b
decl_stmt|;
DECL|typedef|plane
block|}
name|plane
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc31008
block|{
DECL|member|com
name|common
name|com
decl_stmt|;
DECL|member|color
name|GimpVector4
name|color
decl_stmt|;
DECL|member|a
name|GimpVector4
name|a
decl_stmt|;
DECL|typedef|light
block|}
name|light
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2ade8fc31108
block|{
DECL|member|v1
DECL|member|v2
name|GimpVector4
name|v1
decl_stmt|,
name|v2
decl_stmt|;
DECL|member|inside
name|gshort
name|inside
decl_stmt|;
DECL|member|ior
name|gdouble
name|ior
decl_stmt|;
DECL|typedef|ray
block|}
name|ray
typedef|;
end_typedef

begin_typedef
typedef|typedef
union|union
DECL|union|__anon2ade8fc3120a
block|{
DECL|member|com
name|common
name|com
decl_stmt|;
DECL|member|tri
name|triangle
name|tri
decl_stmt|;
DECL|member|disc
name|disc
name|disc
decl_stmt|;
DECL|member|plane
name|plane
name|plane
decl_stmt|;
DECL|member|sphere
name|sphere
name|sphere
decl_stmt|;
DECL|member|cylinder
name|cylinder
name|cylinder
decl_stmt|;
DECL|typedef|object
block|}
name|object
typedef|;
end_typedef

begin_struct
DECL|struct|world_t
struct|struct
name|world_t
block|{
DECL|member|numobj
name|gint
name|numobj
decl_stmt|;
DECL|member|obj
name|object
name|obj
index|[
name|MAXOBJECT
index|]
decl_stmt|;
DECL|member|numlight
name|gint
name|numlight
decl_stmt|;
DECL|member|light
name|light
name|light
index|[
name|MAXLIGHT
index|]
decl_stmt|;
DECL|member|numtexture
name|gint
name|numtexture
decl_stmt|;
DECL|member|texture
name|texture
name|texture
index|[
name|MAXTEXTURE
index|]
decl_stmt|;
DECL|member|flags
name|gulong
name|flags
decl_stmt|;
DECL|member|quality
name|gshort
name|quality
decl_stmt|;
DECL|member|smartambient
name|gdouble
name|smartambient
decl_stmt|;
DECL|member|numatmos
name|gshort
name|numatmos
decl_stmt|;
DECL|member|atmos
name|atmos
name|atmos
index|[
name|MAXATMOS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
DECL|struct|camera_t
struct|struct
name|camera_t
block|{
DECL|member|location
DECL|member|lookat
DECL|member|up
DECL|member|right
name|GimpVector4
name|location
decl_stmt|,
name|lookat
decl_stmt|,
name|up
decl_stmt|,
name|right
decl_stmt|;
DECL|member|type
name|short
name|type
decl_stmt|;
DECL|member|fov
DECL|member|tilt
name|double
name|fov
decl_stmt|,
name|tilt
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
DECL|variable|drawarea
specifier|static
name|GtkWidget
modifier|*
name|drawarea
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|img
specifier|static
name|guchar
modifier|*
name|img
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|img_stride
specifier|static
name|gint
name|img_stride
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|buffer
specifier|static
name|cairo_surface_t
modifier|*
name|buffer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|idle_id
specifier|static
name|guint
name|idle_id
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|s
specifier|static
name|sphere
name|s
decl_stmt|;
end_decl_stmt

begin_struct
DECL|struct|textures_t
struct|struct
name|textures_t
block|{
DECL|member|index
name|gint
name|index
decl_stmt|;
DECL|member|s
name|gchar
modifier|*
name|s
decl_stmt|;
DECL|member|n
name|glong
name|n
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
DECL|variable|textures
specifier|static
name|struct
name|textures_t
name|textures
index|[]
init|=
block|{
block|{
literal|0
block|,
name|N_
argument_list|(
literal|"Solid"
argument_list|)
block|,
name|SOLID
block|}
block|,
block|{
literal|1
block|,
name|N_
argument_list|(
literal|"Checker"
argument_list|)
block|,
name|CHECKER
block|}
block|,
block|{
literal|2
block|,
name|N_
argument_list|(
literal|"Marble"
argument_list|)
block|,
name|MARBLE
block|}
block|,
block|{
literal|3
block|,
name|N_
argument_list|(
literal|"Lizard"
argument_list|)
block|,
name|LIZARD
block|}
block|,
block|{
literal|4
block|,
name|N_
argument_list|(
literal|"Phong"
argument_list|)
block|,
name|PHONG
block|}
block|,
block|{
literal|5
block|,
name|N_
argument_list|(
literal|"Noise"
argument_list|)
block|,
name|PERLIN
block|}
block|,
block|{
literal|6
block|,
name|N_
argument_list|(
literal|"Wood"
argument_list|)
block|,
name|WOOD
block|}
block|,
block|{
literal|7
block|,
name|N_
argument_list|(
literal|"Spiral"
argument_list|)
block|,
name|SPIRAL
block|}
block|,
block|{
literal|8
block|,
name|N_
argument_list|(
literal|"Spots"
argument_list|)
block|,
name|SPOTS
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
specifier|inline
name|void
name|vset
parameter_list|(
name|GimpVector4
modifier|*
name|v
parameter_list|,
name|gdouble
name|a
parameter_list|,
name|gdouble
name|b
parameter_list|,
name|gdouble
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|restartrender
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|drawcolor1
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|drawcolor2
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|render
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|realrender
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fileselect
parameter_list|(
name|GtkFileChooserAction
name|action
parameter_list|,
name|GtkWidget
modifier|*
name|parent
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|traceray
parameter_list|(
name|ray
modifier|*
name|r
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|gint
name|level
parameter_list|,
name|gdouble
name|imp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gdouble
name|turbulence
parameter_list|(
name|gdouble
modifier|*
name|point
parameter_list|,
name|gdouble
name|lofreq
parameter_list|,
name|gdouble
name|hifreq
parameter_list|)
function_decl|;
end_function_decl

begin_define
DECL|macro|COLORBUTTONWIDTH
define|#
directive|define
name|COLORBUTTONWIDTH
value|30
end_define

begin_define
DECL|macro|COLORBUTTONHEIGHT
define|#
directive|define
name|COLORBUTTONHEIGHT
value|20
end_define

begin_decl_stmt
DECL|variable|texturelist
specifier|static
name|GtkTreeView
modifier|*
name|texturelist
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|scalexscale
DECL|variable|scaleyscale
DECL|variable|scalezscale
specifier|static
name|GtkObject
modifier|*
name|scalexscale
decl_stmt|,
modifier|*
name|scaleyscale
decl_stmt|,
modifier|*
name|scalezscale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|rotxscale
DECL|variable|rotyscale
DECL|variable|rotzscale
specifier|static
name|GtkObject
modifier|*
name|rotxscale
decl_stmt|,
modifier|*
name|rotyscale
decl_stmt|,
modifier|*
name|rotzscale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|posxscale
DECL|variable|posyscale
DECL|variable|poszscale
specifier|static
name|GtkObject
modifier|*
name|posxscale
decl_stmt|,
modifier|*
name|posyscale
decl_stmt|,
modifier|*
name|poszscale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|scalescale
specifier|static
name|GtkObject
modifier|*
name|scalescale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|turbulencescale
specifier|static
name|GtkObject
modifier|*
name|turbulencescale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|amountscale
specifier|static
name|GtkObject
modifier|*
name|amountscale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|expscale
specifier|static
name|GtkObject
modifier|*
name|expscale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|typemenu
specifier|static
name|GtkWidget
modifier|*
name|typemenu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|texturemenu
specifier|static
name|GtkWidget
modifier|*
name|texturemenu
decl_stmt|;
end_decl_stmt

begin_define
DECL|macro|DOT (a,b)
define|#
directive|define
name|DOT
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(a[0] * b[0] + a[1] * b[1] + a[2] * b[2])
end_define

begin_define
DECL|macro|B
define|#
directive|define
name|B
value|256
end_define

begin_decl_stmt
DECL|variable|p
specifier|static
name|gint
name|p
index|[
name|B
operator|+
name|B
operator|+
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|g
specifier|static
name|gdouble
name|g
index|[
name|B
operator|+
name|B
operator|+
literal|2
index|]
index|[
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|start
specifier|static
name|gboolean
name|start
init|=
name|TRUE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gr
specifier|static
name|GRand
modifier|*
name|gr
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|init (void)
name|init
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|gdouble
name|v
index|[
literal|3
index|]
decl_stmt|,
name|s
decl_stmt|;
comment|/* Create an array of random gradient vectors uniformly on the unit sphere */
name|gr
operator|=
name|g_rand_new
argument_list|()
expr_stmt|;
name|g_rand_set_seed
argument_list|(
name|gr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Use static seed, to get reproducable results */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|B
condition|;
name|i
operator|++
control|)
block|{
do|do
block|{
comment|/* Choose uniformly in a cube */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|3
condition|;
name|j
operator|++
control|)
name|v
index|[
name|j
index|]
operator|=
name|g_rand_double_range
argument_list|(
name|gr
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|s
operator|=
name|DOT
argument_list|(
name|v
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|s
operator|>
literal|1.0
condition|)
do|;
comment|/* If not in sphere try again */
name|s
operator|=
name|sqrt
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|3
condition|;
name|j
operator|++
control|)
comment|/* Else normalize */
name|g
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
name|v
index|[
name|j
index|]
operator|/
name|s
expr_stmt|;
block|}
comment|/* Create a pseudorandom permutation of [1..B] */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|B
condition|;
name|i
operator|++
control|)
name|p
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
for|for
control|(
name|i
operator|=
name|B
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|-=
literal|2
control|)
block|{
name|k
operator|=
name|p
index|[
name|i
index|]
expr_stmt|;
name|p
index|[
name|i
index|]
operator|=
name|p
index|[
name|j
operator|=
name|g_rand_int_range
argument_list|(
name|gr
argument_list|,
literal|0
argument_list|,
name|B
argument_list|)
index|]
expr_stmt|;
name|p
index|[
name|j
index|]
operator|=
name|k
expr_stmt|;
block|}
comment|/* Extend g and p arrays to allow for faster indexing */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|B
operator|+
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|p
index|[
name|B
operator|+
name|i
index|]
operator|=
name|p
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|3
condition|;
name|j
operator|++
control|)
name|g
index|[
name|B
operator|+
name|i
index|]
index|[
name|j
index|]
operator|=
name|g
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
block|}
name|g_rand_free
argument_list|(
name|gr
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
DECL|macro|setup (i,b0,b1,r0,r1)
define|#
directive|define
name|setup
parameter_list|(
name|i
parameter_list|,
name|b0
parameter_list|,
name|b1
parameter_list|,
name|r0
parameter_list|,
name|r1
parameter_list|)
define|\
value|t = vec[i] + 10000.; \         b0 = ((int)t)& (B-1); \         b1 = (b0+1)& (B-1); \         r0 = t - (int)t; \         r1 = r0 - 1.;
end_define

begin_function
specifier|static
name|gdouble
DECL|function|noise3 (gdouble * vec)
name|noise3
parameter_list|(
name|gdouble
modifier|*
name|vec
parameter_list|)
block|{
name|gint
name|bx0
decl_stmt|,
name|bx1
decl_stmt|,
name|by0
decl_stmt|,
name|by1
decl_stmt|,
name|bz0
decl_stmt|,
name|bz1
decl_stmt|,
name|b00
decl_stmt|,
name|b10
decl_stmt|,
name|b01
decl_stmt|,
name|b11
decl_stmt|;
name|gdouble
name|rx0
decl_stmt|,
name|rx1
decl_stmt|,
name|ry0
decl_stmt|,
name|ry1
decl_stmt|,
name|rz0
decl_stmt|,
name|rz1
decl_stmt|,
modifier|*
name|q
decl_stmt|,
name|sx
decl_stmt|,
name|sy
decl_stmt|,
name|sz
decl_stmt|,
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|t
decl_stmt|,
name|u
decl_stmt|,
name|v
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|start
condition|)
block|{
name|start
operator|=
name|FALSE
expr_stmt|;
name|init
argument_list|()
expr_stmt|;
block|}
name|setup
argument_list|(
literal|0
argument_list|,
name|bx0
argument_list|,
name|bx1
argument_list|,
name|rx0
argument_list|,
name|rx1
argument_list|)
expr_stmt|;
name|setup
argument_list|(
literal|1
argument_list|,
name|by0
argument_list|,
name|by1
argument_list|,
name|ry0
argument_list|,
name|ry1
argument_list|)
expr_stmt|;
name|setup
argument_list|(
literal|2
argument_list|,
name|bz0
argument_list|,
name|bz1
argument_list|,
name|rz0
argument_list|,
name|rz1
argument_list|)
expr_stmt|;
name|i
operator|=
name|p
index|[
name|bx0
index|]
expr_stmt|;
name|j
operator|=
name|p
index|[
name|bx1
index|]
expr_stmt|;
name|b00
operator|=
name|p
index|[
name|i
operator|+
name|by0
index|]
expr_stmt|;
name|b10
operator|=
name|p
index|[
name|j
operator|+
name|by0
index|]
expr_stmt|;
name|b01
operator|=
name|p
index|[
name|i
operator|+
name|by1
index|]
expr_stmt|;
name|b11
operator|=
name|p
index|[
name|j
operator|+
name|by1
index|]
expr_stmt|;
DECL|macro|at (rx,ry,rz)
define|#
directive|define
name|at
parameter_list|(
name|rx
parameter_list|,
name|ry
parameter_list|,
name|rz
parameter_list|)
value|( rx * q[0] + ry * q[1] + rz * q[2] )
DECL|macro|surve (t)
define|#
directive|define
name|surve
parameter_list|(
name|t
parameter_list|)
value|( t * t * (3. - 2. * t) )
DECL|macro|lerp (t,a,b)
define|#
directive|define
name|lerp
parameter_list|(
name|t
parameter_list|,
name|a
parameter_list|,
name|b
parameter_list|)
value|( a + t * (b - a) )
name|sx
operator|=
name|surve
argument_list|(
name|rx0
argument_list|)
expr_stmt|;
name|sy
operator|=
name|surve
argument_list|(
name|ry0
argument_list|)
expr_stmt|;
name|sz
operator|=
name|surve
argument_list|(
name|rz0
argument_list|)
expr_stmt|;
name|q
operator|=
name|g
index|[
name|b00
operator|+
name|bz0
index|]
expr_stmt|;
name|u
operator|=
name|at
argument_list|(
name|rx0
argument_list|,
name|ry0
argument_list|,
name|rz0
argument_list|)
expr_stmt|;
name|q
operator|=
name|g
index|[
name|b10
operator|+
name|bz0
index|]
expr_stmt|;
name|v
operator|=
name|at
argument_list|(
name|rx1
argument_list|,
name|ry0
argument_list|,
name|rz0
argument_list|)
expr_stmt|;
name|a
operator|=
name|lerp
argument_list|(
name|sx
argument_list|,
name|u
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|q
operator|=
name|g
index|[
name|b01
operator|+
name|bz0
index|]
expr_stmt|;
name|u
operator|=
name|at
argument_list|(
name|rx0
argument_list|,
name|ry1
argument_list|,
name|rz0
argument_list|)
expr_stmt|;
name|q
operator|=
name|g
index|[
name|b11
operator|+
name|bz0
index|]
expr_stmt|;
name|v
operator|=
name|at
argument_list|(
name|rx1
argument_list|,
name|ry1
argument_list|,
name|rz0
argument_list|)
expr_stmt|;
name|b
operator|=
name|lerp
argument_list|(
name|sx
argument_list|,
name|u
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|c
operator|=
name|lerp
argument_list|(
name|sy
argument_list|,
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
comment|/* interpolate in y at lo x */
name|q
operator|=
name|g
index|[
name|b00
operator|+
name|bz1
index|]
expr_stmt|;
name|u
operator|=
name|at
argument_list|(
name|rx0
argument_list|,
name|ry0
argument_list|,
name|rz1
argument_list|)
expr_stmt|;
name|q
operator|=
name|g
index|[
name|b10
operator|+
name|bz1
index|]
expr_stmt|;
name|v
operator|=
name|at
argument_list|(
name|rx1
argument_list|,
name|ry0
argument_list|,
name|rz1
argument_list|)
expr_stmt|;
name|a
operator|=
name|lerp
argument_list|(
name|sx
argument_list|,
name|u
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|q
operator|=
name|g
index|[
name|b01
operator|+
name|bz1
index|]
expr_stmt|;
name|u
operator|=
name|at
argument_list|(
name|rx0
argument_list|,
name|ry1
argument_list|,
name|rz1
argument_list|)
expr_stmt|;
name|q
operator|=
name|g
index|[
name|b11
operator|+
name|bz1
index|]
expr_stmt|;
name|v
operator|=
name|at
argument_list|(
name|rx1
argument_list|,
name|ry1
argument_list|,
name|rz1
argument_list|)
expr_stmt|;
name|b
operator|=
name|lerp
argument_list|(
name|sx
argument_list|,
name|u
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|d
operator|=
name|lerp
argument_list|(
name|sy
argument_list|,
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
comment|/* interpolate in y at hi x */
return|return
literal|1.5
operator|*
name|lerp
argument_list|(
name|sz
argument_list|,
name|c
argument_list|,
name|d
argument_list|)
return|;
comment|/* interpolate in z */
block|}
end_function

begin_function
specifier|static
name|double
DECL|function|turbulence (gdouble * point,gdouble lofreq,gdouble hifreq)
name|turbulence
parameter_list|(
name|gdouble
modifier|*
name|point
parameter_list|,
name|gdouble
name|lofreq
parameter_list|,
name|gdouble
name|hifreq
parameter_list|)
block|{
name|gdouble
name|freq
decl_stmt|,
name|t
decl_stmt|,
name|p
index|[
literal|3
index|]
decl_stmt|;
name|p
index|[
literal|0
index|]
operator|=
name|point
index|[
literal|0
index|]
operator|+
literal|123.456
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
name|point
index|[
literal|1
index|]
operator|+
literal|234.567
expr_stmt|;
name|p
index|[
literal|2
index|]
operator|=
name|point
index|[
literal|2
index|]
operator|+
literal|345.678
expr_stmt|;
name|t
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|freq
operator|=
name|lofreq
init|;
name|freq
operator|<
name|hifreq
condition|;
name|freq
operator|*=
literal|2.
control|)
block|{
name|t
operator|+=
name|noise3
argument_list|(
name|p
argument_list|)
operator|/
name|freq
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|*=
literal|2.
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|*=
literal|2.
expr_stmt|;
name|p
index|[
literal|2
index|]
operator|*=
literal|2.
expr_stmt|;
block|}
return|return
name|t
operator|-
literal|0.3
return|;
comment|/* readjust to make mean value = 0.0 */
block|}
end_function

begin_decl_stmt
DECL|variable|world
specifier|static
name|struct
name|world_t
name|world
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vcopy (GimpVector4 * a,GimpVector4 * b)
name|vcopy
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|)
block|{
operator|*
name|a
operator|=
operator|*
name|b
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vcross (GimpVector4 * r,GimpVector4 * a,GimpVector4 * b)
name|vcross
parameter_list|(
name|GimpVector4
modifier|*
name|r
parameter_list|,
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|)
block|{
name|r
operator|->
name|x
operator|=
name|a
operator|->
name|y
operator|*
name|b
operator|->
name|z
operator|-
name|a
operator|->
name|z
operator|*
name|b
operator|->
name|y
expr_stmt|;
name|r
operator|->
name|y
operator|=
operator|-
operator|(
name|a
operator|->
name|x
operator|*
name|b
operator|->
name|z
operator|-
name|a
operator|->
name|z
operator|*
name|b
operator|->
name|x
operator|)
expr_stmt|;
name|r
operator|->
name|z
operator|=
name|a
operator|->
name|x
operator|*
name|b
operator|->
name|y
operator|-
name|a
operator|->
name|y
operator|*
name|b
operator|->
name|x
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|gdouble
DECL|function|vdot (GimpVector4 * a,GimpVector4 * b)
name|vdot
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|)
block|{
return|return
name|a
operator|->
name|x
operator|*
name|b
operator|->
name|x
operator|+
name|a
operator|->
name|y
operator|*
name|b
operator|->
name|y
operator|+
name|a
operator|->
name|z
operator|*
name|b
operator|->
name|z
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|gdouble
DECL|function|vdist (GimpVector4 * a,GimpVector4 * b)
name|vdist
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|)
block|{
name|gdouble
name|x
decl_stmt|,
name|y
decl_stmt|,
name|z
decl_stmt|;
name|x
operator|=
name|a
operator|->
name|x
operator|-
name|b
operator|->
name|x
expr_stmt|;
name|y
operator|=
name|a
operator|->
name|y
operator|-
name|b
operator|->
name|y
expr_stmt|;
name|z
operator|=
name|a
operator|->
name|z
operator|-
name|b
operator|->
name|z
expr_stmt|;
return|return
name|sqrt
argument_list|(
name|x
operator|*
name|x
operator|+
name|y
operator|*
name|y
operator|+
name|z
operator|*
name|z
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|gdouble
DECL|function|vlen (GimpVector4 * a)
name|vlen
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|)
block|{
return|return
name|sqrt
argument_list|(
name|a
operator|->
name|x
operator|*
name|a
operator|->
name|x
operator|+
name|a
operator|->
name|y
operator|*
name|a
operator|->
name|y
operator|+
name|a
operator|->
name|z
operator|*
name|a
operator|->
name|z
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vnorm (GimpVector4 * a,gdouble v)
name|vnorm
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|gdouble
name|v
parameter_list|)
block|{
name|gdouble
name|d
decl_stmt|;
name|d
operator|=
name|vlen
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|a
operator|->
name|x
operator|*=
name|v
operator|/
name|d
expr_stmt|;
name|a
operator|->
name|y
operator|*=
name|v
operator|/
name|d
expr_stmt|;
name|a
operator|->
name|z
operator|*=
name|v
operator|/
name|d
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vrotate (GimpVector4 * axis,gdouble ang,GimpVector4 * vector)
name|vrotate
parameter_list|(
name|GimpVector4
modifier|*
name|axis
parameter_list|,
name|gdouble
name|ang
parameter_list|,
name|GimpVector4
modifier|*
name|vector
parameter_list|)
block|{
name|gdouble
name|rad
init|=
name|ang
operator|/
literal|180.0
operator|*
name|G_PI
decl_stmt|;
name|gdouble
name|ax
init|=
name|vector
operator|->
name|x
decl_stmt|;
name|gdouble
name|ay
init|=
name|vector
operator|->
name|y
decl_stmt|;
name|gdouble
name|az
init|=
name|vector
operator|->
name|z
decl_stmt|;
name|gdouble
name|x
init|=
name|axis
operator|->
name|x
decl_stmt|;
name|gdouble
name|y
init|=
name|axis
operator|->
name|y
decl_stmt|;
name|gdouble
name|z
init|=
name|axis
operator|->
name|z
decl_stmt|;
name|gdouble
name|c
init|=
name|cos
argument_list|(
name|rad
argument_list|)
decl_stmt|;
name|gdouble
name|s
init|=
name|sin
argument_list|(
name|rad
argument_list|)
decl_stmt|;
name|gdouble
name|c1
init|=
literal|1.0
operator|-
name|c
decl_stmt|;
name|gdouble
name|xx
init|=
name|c1
operator|*
name|x
operator|*
name|x
decl_stmt|;
name|gdouble
name|yy
init|=
name|c1
operator|*
name|y
operator|*
name|y
decl_stmt|;
name|gdouble
name|zz
init|=
name|c1
operator|*
name|z
operator|*
name|z
decl_stmt|;
name|gdouble
name|xy
init|=
name|c1
operator|*
name|x
operator|*
name|y
decl_stmt|;
name|gdouble
name|xz
init|=
name|c1
operator|*
name|x
operator|*
name|z
decl_stmt|;
name|gdouble
name|yz
init|=
name|c1
operator|*
name|y
operator|*
name|z
decl_stmt|;
name|gdouble
name|sx
init|=
name|s
operator|*
name|x
decl_stmt|;
name|gdouble
name|sy
init|=
name|s
operator|*
name|y
decl_stmt|;
name|gdouble
name|sz
init|=
name|s
operator|*
name|z
decl_stmt|;
name|vector
operator|->
name|x
operator|=
operator|(
name|xx
operator|+
name|c
operator|)
operator|*
name|ax
operator|+
operator|(
name|xy
operator|+
name|sz
operator|)
operator|*
name|ay
operator|+
operator|(
name|xz
operator|-
name|sy
operator|)
operator|*
name|az
expr_stmt|;
name|vector
operator|->
name|y
operator|=
operator|(
name|xy
operator|-
name|sz
operator|)
operator|*
name|ax
operator|+
operator|(
name|yy
operator|+
name|c
operator|)
operator|*
name|ay
operator|+
operator|(
name|yz
operator|+
name|sx
operator|)
operator|*
name|az
expr_stmt|;
name|vector
operator|->
name|z
operator|=
operator|(
name|xz
operator|+
name|sy
operator|)
operator|*
name|ax
operator|+
operator|(
name|yz
operator|-
name|sx
operator|)
operator|*
name|ay
operator|+
operator|(
name|zz
operator|+
name|c
operator|)
operator|*
name|az
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vset (GimpVector4 * v,gdouble a,gdouble b,gdouble c)
name|vset
parameter_list|(
name|GimpVector4
modifier|*
name|v
parameter_list|,
name|gdouble
name|a
parameter_list|,
name|gdouble
name|b
parameter_list|,
name|gdouble
name|c
parameter_list|)
block|{
name|v
operator|->
name|x
operator|=
name|a
expr_stmt|;
name|v
operator|->
name|y
operator|=
name|b
expr_stmt|;
name|v
operator|->
name|z
operator|=
name|c
expr_stmt|;
name|v
operator|->
name|w
operator|=
literal|1.0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vcset (GimpVector4 * v,gdouble a,gdouble b,gdouble c,gdouble d)
name|vcset
parameter_list|(
name|GimpVector4
modifier|*
name|v
parameter_list|,
name|gdouble
name|a
parameter_list|,
name|gdouble
name|b
parameter_list|,
name|gdouble
name|c
parameter_list|,
name|gdouble
name|d
parameter_list|)
block|{
name|v
operator|->
name|x
operator|=
name|a
expr_stmt|;
name|v
operator|->
name|y
operator|=
name|b
expr_stmt|;
name|v
operator|->
name|z
operator|=
name|c
expr_stmt|;
name|v
operator|->
name|w
operator|=
name|d
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vvrotate (GimpVector4 * p,GimpVector4 * rot)
name|vvrotate
parameter_list|(
name|GimpVector4
modifier|*
name|p
parameter_list|,
name|GimpVector4
modifier|*
name|rot
parameter_list|)
block|{
name|GimpVector4
name|axis
decl_stmt|;
if|if
condition|(
name|rot
operator|->
name|x
operator|!=
literal|0.0
condition|)
block|{
name|vset
argument_list|(
operator|&
name|axis
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrotate
argument_list|(
operator|&
name|axis
argument_list|,
name|rot
operator|->
name|x
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rot
operator|->
name|y
operator|!=
literal|0.0
condition|)
block|{
name|vset
argument_list|(
operator|&
name|axis
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vrotate
argument_list|(
operator|&
name|axis
argument_list|,
name|rot
operator|->
name|y
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rot
operator|->
name|z
operator|!=
literal|0.0
condition|)
block|{
name|vset
argument_list|(
operator|&
name|axis
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vrotate
argument_list|(
operator|&
name|axis
argument_list|,
name|rot
operator|->
name|z
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vsub (GimpVector4 * a,GimpVector4 * b)
name|vsub
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|)
block|{
name|a
operator|->
name|x
operator|-=
name|b
operator|->
name|x
expr_stmt|;
name|a
operator|->
name|y
operator|-=
name|b
operator|->
name|y
expr_stmt|;
name|a
operator|->
name|z
operator|-=
name|b
operator|->
name|z
expr_stmt|;
name|a
operator|->
name|w
operator|-=
name|b
operator|->
name|w
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vadd (GimpVector4 * a,GimpVector4 * b)
name|vadd
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|)
block|{
name|a
operator|->
name|x
operator|+=
name|b
operator|->
name|x
expr_stmt|;
name|a
operator|->
name|y
operator|+=
name|b
operator|->
name|y
expr_stmt|;
name|a
operator|->
name|z
operator|+=
name|b
operator|->
name|z
expr_stmt|;
name|a
operator|->
name|w
operator|+=
name|b
operator|->
name|w
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vneg (GimpVector4 * a)
name|vneg
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|)
block|{
name|a
operator|->
name|x
operator|=
operator|-
name|a
operator|->
name|x
expr_stmt|;
name|a
operator|->
name|y
operator|=
operator|-
name|a
operator|->
name|y
expr_stmt|;
name|a
operator|->
name|z
operator|=
operator|-
name|a
operator|->
name|z
expr_stmt|;
name|a
operator|->
name|w
operator|=
operator|-
name|a
operator|->
name|w
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vmul (GimpVector4 * v,gdouble a)
name|vmul
parameter_list|(
name|GimpVector4
modifier|*
name|v
parameter_list|,
name|gdouble
name|a
parameter_list|)
block|{
name|v
operator|->
name|x
operator|*=
name|a
expr_stmt|;
name|v
operator|->
name|y
operator|*=
name|a
expr_stmt|;
name|v
operator|->
name|z
operator|*=
name|a
expr_stmt|;
name|v
operator|->
name|w
operator|*=
name|a
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vvmul (GimpVector4 * a,GimpVector4 * b)
name|vvmul
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|)
block|{
name|a
operator|->
name|x
operator|*=
name|b
operator|->
name|x
expr_stmt|;
name|a
operator|->
name|y
operator|*=
name|b
operator|->
name|y
expr_stmt|;
name|a
operator|->
name|z
operator|*=
name|b
operator|->
name|z
expr_stmt|;
name|a
operator|->
name|w
operator|*=
name|b
operator|->
name|w
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
DECL|function|vvdiv (GimpVector4 * a,GimpVector4 * b)
name|vvdiv
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|)
block|{
name|a
operator|->
name|x
operator|/=
name|b
operator|->
name|x
expr_stmt|;
name|a
operator|->
name|y
operator|/=
name|b
operator|->
name|y
expr_stmt|;
name|a
operator|->
name|z
operator|/=
name|b
operator|->
name|z
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|vmix (GimpVector4 * r,GimpVector4 * a,GimpVector4 * b,gdouble v)
name|vmix
parameter_list|(
name|GimpVector4
modifier|*
name|r
parameter_list|,
name|GimpVector4
modifier|*
name|a
parameter_list|,
name|GimpVector4
modifier|*
name|b
parameter_list|,
name|gdouble
name|v
parameter_list|)
block|{
name|gdouble
name|i
init|=
literal|1.0
operator|-
name|v
decl_stmt|;
name|r
operator|->
name|x
operator|=
name|a
operator|->
name|x
operator|*
name|v
operator|+
name|b
operator|->
name|x
operator|*
name|i
expr_stmt|;
name|r
operator|->
name|y
operator|=
name|a
operator|->
name|y
operator|*
name|v
operator|+
name|b
operator|->
name|y
operator|*
name|i
expr_stmt|;
name|r
operator|->
name|z
operator|=
name|a
operator|->
name|z
operator|*
name|v
operator|+
name|b
operator|->
name|z
operator|*
name|i
expr_stmt|;
name|r
operator|->
name|w
operator|=
name|a
operator|->
name|w
operator|*
name|v
operator|+
name|b
operator|->
name|w
operator|*
name|i
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|double
DECL|function|vmax (GimpVector4 * a)
name|vmax
parameter_list|(
name|GimpVector4
modifier|*
name|a
parameter_list|)
block|{
name|gdouble
name|max
init|=
name|fabs
argument_list|(
name|a
operator|->
name|x
argument_list|)
decl_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|a
operator|->
name|y
argument_list|)
operator|>
name|max
condition|)
name|max
operator|=
name|fabs
argument_list|(
name|a
operator|->
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|a
operator|->
name|z
argument_list|)
operator|>
name|max
condition|)
name|max
operator|=
name|fabs
argument_list|(
name|a
operator|->
name|z
argument_list|)
expr_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|a
operator|->
name|w
argument_list|)
operator|>
name|max
condition|)
name|max
operator|=
name|fabs
argument_list|(
name|a
operator|->
name|w
argument_list|)
expr_stmt|;
return|return
name|max
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void vavg (GimpVector4 * a) {   gdouble s;    s = (a->x + a->y + a->z) / 3.0;   a->x = a->y = a->z = s; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
DECL|function|trianglenormal (GimpVector4 * n,gdouble * t,triangle * tri)
name|trianglenormal
parameter_list|(
name|GimpVector4
modifier|*
name|n
parameter_list|,
name|gdouble
modifier|*
name|t
parameter_list|,
name|triangle
modifier|*
name|tri
parameter_list|)
block|{
name|triangle
name|tmp
decl_stmt|;
name|vcopy
argument_list|(
operator|&
name|tmp
operator|.
name|b
argument_list|,
operator|&
name|tri
operator|->
name|b
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|tmp
operator|.
name|c
argument_list|,
operator|&
name|tri
operator|->
name|c
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|tmp
operator|.
name|b
argument_list|,
operator|&
name|tri
operator|->
name|a
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|tmp
operator|.
name|c
argument_list|,
operator|&
name|tri
operator|->
name|a
argument_list|)
expr_stmt|;
name|vset
argument_list|(
operator|&
name|tmp
operator|.
name|a
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vcross
argument_list|(
name|n
argument_list|,
operator|&
name|tmp
operator|.
name|b
argument_list|,
operator|&
name|tmp
operator|.
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
condition|)
operator|*
name|t
operator|=
name|vdot
argument_list|(
operator|&
name|tmp
operator|.
name|b
argument_list|,
operator|&
name|tmp
operator|.
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|checkdisc (ray * r,disc * disc)
name|checkdisc
parameter_list|(
name|ray
modifier|*
name|r
parameter_list|,
name|disc
modifier|*
name|disc
parameter_list|)
block|{
name|GimpVector4
name|p
decl_stmt|,
modifier|*
name|v
init|=
operator|&
name|disc
operator|->
name|a
decl_stmt|;
name|gdouble
name|t
decl_stmt|,
name|d
decl_stmt|;
name|gdouble
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|i
operator|=
name|r
operator|->
name|v2
operator|.
name|x
operator|-
name|r
operator|->
name|v1
operator|.
name|x
expr_stmt|;
name|j
operator|=
name|r
operator|->
name|v2
operator|.
name|y
operator|-
name|r
operator|->
name|v1
operator|.
name|y
expr_stmt|;
name|k
operator|=
name|r
operator|->
name|v2
operator|.
name|z
operator|-
name|r
operator|->
name|v1
operator|.
name|z
expr_stmt|;
name|t
operator|=
operator|-
operator|(
name|v
operator|->
name|x
operator|*
name|r
operator|->
name|v1
operator|.
name|x
operator|+
name|v
operator|->
name|y
operator|*
name|r
operator|->
name|v1
operator|.
name|y
operator|+
name|v
operator|->
name|z
operator|*
name|r
operator|->
name|v1
operator|.
name|z
operator|-
name|disc
operator|->
name|b
operator|)
operator|/
operator|(
name|v
operator|->
name|x
operator|*
name|i
operator|+
name|v
operator|->
name|y
operator|*
name|j
operator|+
name|v
operator|->
name|z
operator|*
name|k
operator|)
expr_stmt|;
name|p
operator|.
name|x
operator|=
name|r
operator|->
name|v1
operator|.
name|x
operator|+
name|i
operator|*
name|t
expr_stmt|;
name|p
operator|.
name|y
operator|=
name|r
operator|->
name|v1
operator|.
name|y
operator|+
name|j
operator|*
name|t
expr_stmt|;
name|p
operator|.
name|z
operator|=
name|r
operator|->
name|v1
operator|.
name|z
operator|+
name|k
operator|*
name|t
expr_stmt|;
name|d
operator|=
name|vdist
argument_list|(
operator|&
name|p
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|>
name|disc
operator|->
name|r
condition|)
name|t
operator|=
literal|0.0
expr_stmt|;
return|return
name|t
return|;
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|checksphere (ray * r,sphere * sphere)
name|checksphere
parameter_list|(
name|ray
modifier|*
name|r
parameter_list|,
name|sphere
modifier|*
name|sphere
parameter_list|)
block|{
name|GimpVector4
name|cendir
decl_stmt|,
name|rdir
decl_stmt|;
name|gdouble
name|dirproj
decl_stmt|,
name|cdlensq
decl_stmt|;
name|gdouble
name|linear
decl_stmt|,
name|constant
decl_stmt|,
name|rsq
decl_stmt|,
name|quadratic
decl_stmt|,
name|discriminant
decl_stmt|;
name|gdouble
name|smallzero
decl_stmt|,
name|solmin
decl_stmt|,
name|solmax
decl_stmt|,
name|tolerance
init|=
literal|0.001
decl_stmt|;
name|vcopy
argument_list|(
operator|&
name|rdir
argument_list|,
operator|&
name|r
operator|->
name|v2
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|rdir
argument_list|,
operator|&
name|r
operator|->
name|v1
argument_list|)
expr_stmt|;
name|rsq
operator|=
name|sphere
operator|->
name|r
operator|*
name|sphere
operator|->
name|r
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|cendir
argument_list|,
operator|&
name|r
operator|->
name|v1
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|cendir
argument_list|,
operator|&
name|sphere
operator|->
name|a
argument_list|)
expr_stmt|;
name|dirproj
operator|=
name|vdot
argument_list|(
operator|&
name|rdir
argument_list|,
operator|&
name|cendir
argument_list|)
expr_stmt|;
name|cdlensq
operator|=
name|vdot
argument_list|(
operator|&
name|cendir
argument_list|,
operator|&
name|cendir
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cdlensq
operator|>=
name|rsq
operator|)
operator|&&
operator|(
name|dirproj
operator|>
literal|0.0
operator|)
condition|)
return|return
literal|0.0
return|;
name|linear
operator|=
literal|2.0
operator|*
name|dirproj
expr_stmt|;
name|constant
operator|=
name|cdlensq
operator|-
name|rsq
expr_stmt|;
name|quadratic
operator|=
name|vdot
argument_list|(
operator|&
name|rdir
argument_list|,
operator|&
name|rdir
argument_list|)
expr_stmt|;
name|smallzero
operator|=
operator|(
name|constant
operator|/
name|linear
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|smallzero
operator|<
name|tolerance
operator|)
operator|&&
operator|(
name|smallzero
operator|>
operator|-
name|tolerance
operator|)
condition|)
block|{
name|solmin
operator|=
operator|-
name|linear
operator|/
name|quadratic
expr_stmt|;
if|if
condition|(
name|solmin
operator|>
name|tolerance
condition|)
block|{
return|return
name|solmin
return|;
comment|/*            *hits = solmin;            return 1;            */
block|}
else|else
return|return
literal|0.0
return|;
block|}
name|discriminant
operator|=
name|linear
operator|*
name|linear
operator|-
literal|4.0
operator|*
name|quadratic
operator|*
name|constant
expr_stmt|;
if|if
condition|(
name|discriminant
operator|<
literal|0.0
condition|)
return|return
literal|0.0
return|;
name|quadratic
operator|*=
literal|2.0
expr_stmt|;
name|discriminant
operator|=
name|sqrt
argument_list|(
name|discriminant
argument_list|)
expr_stmt|;
name|solmax
operator|=
operator|(
operator|-
name|linear
operator|+
name|discriminant
operator|)
operator|/
operator|(
name|quadratic
operator|)
expr_stmt|;
name|solmin
operator|=
operator|(
operator|-
name|linear
operator|-
name|discriminant
operator|)
operator|/
operator|(
name|quadratic
operator|)
expr_stmt|;
if|if
condition|(
name|solmax
operator|<
name|tolerance
condition|)
return|return
literal|0.0
return|;
if|if
condition|(
name|solmin
operator|<
name|tolerance
condition|)
block|{
return|return
name|solmax
return|;
comment|/*        * hits = solmax;        * return 1;        */
block|}
else|else
block|{
return|return
name|solmin
return|;
comment|/*        * hits++ = solmin;        * hits = solmax;        * return 2;        */
block|}
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|checkcylinder (ray * r,cylinder * cylinder)
name|checkcylinder
parameter_list|(
name|ray
modifier|*
name|r
parameter_list|,
name|cylinder
modifier|*
name|cylinder
parameter_list|)
block|{
comment|/* FIXME */
return|return
literal|0.0
return|;
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|checkplane (ray * r,plane * plane)
name|checkplane
parameter_list|(
name|ray
modifier|*
name|r
parameter_list|,
name|plane
modifier|*
name|plane
parameter_list|)
block|{
name|GimpVector4
modifier|*
name|v
init|=
operator|&
name|plane
operator|->
name|a
decl_stmt|;
name|gdouble
name|t
decl_stmt|;
name|gdouble
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|i
operator|=
name|r
operator|->
name|v2
operator|.
name|x
operator|-
name|r
operator|->
name|v1
operator|.
name|x
expr_stmt|;
name|j
operator|=
name|r
operator|->
name|v2
operator|.
name|y
operator|-
name|r
operator|->
name|v1
operator|.
name|y
expr_stmt|;
name|k
operator|=
name|r
operator|->
name|v2
operator|.
name|z
operator|-
name|r
operator|->
name|v1
operator|.
name|z
expr_stmt|;
name|t
operator|=
operator|-
operator|(
name|v
operator|->
name|x
operator|*
name|r
operator|->
name|v1
operator|.
name|x
operator|+
name|v
operator|->
name|y
operator|*
name|r
operator|->
name|v1
operator|.
name|y
operator|+
name|v
operator|->
name|z
operator|*
name|r
operator|->
name|v1
operator|.
name|z
operator|-
name|plane
operator|->
name|b
operator|)
operator|/
operator|(
name|v
operator|->
name|x
operator|*
name|i
operator|+
name|v
operator|->
name|y
operator|*
name|j
operator|+
name|v
operator|->
name|z
operator|*
name|k
operator|)
expr_stmt|;
return|return
name|t
return|;
block|}
end_function

begin_function
specifier|static
name|gdouble
DECL|function|checktri (ray * r,triangle * tri)
name|checktri
parameter_list|(
name|ray
modifier|*
name|r
parameter_list|,
name|triangle
modifier|*
name|tri
parameter_list|)
block|{
name|GimpVector4
name|ed1
decl_stmt|,
name|ed2
decl_stmt|;
name|GimpVector4
name|tvec
decl_stmt|,
name|pvec
decl_stmt|,
name|qvec
decl_stmt|;
name|gdouble
name|det
decl_stmt|,
name|idet
decl_stmt|,
name|t
decl_stmt|,
name|u
decl_stmt|,
name|v
decl_stmt|;
name|GimpVector4
modifier|*
name|orig
decl_stmt|,
name|dir
decl_stmt|;
name|orig
operator|=
operator|&
name|r
operator|->
name|v1
expr_stmt|;
name|dir
operator|=
name|r
operator|->
name|v2
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|dir
argument_list|,
name|orig
argument_list|)
expr_stmt|;
name|ed1
operator|.
name|x
operator|=
name|tri
operator|->
name|c
operator|.
name|x
operator|-
name|tri
operator|->
name|a
operator|.
name|x
expr_stmt|;
name|ed1
operator|.
name|y
operator|=
name|tri
operator|->
name|c
operator|.
name|y
operator|-
name|tri
operator|->
name|a
operator|.
name|y
expr_stmt|;
name|ed1
operator|.
name|z
operator|=
name|tri
operator|->
name|c
operator|.
name|z
operator|-
name|tri
operator|->
name|a
operator|.
name|z
expr_stmt|;
name|ed2
operator|.
name|x
operator|=
name|tri
operator|->
name|b
operator|.
name|x
operator|-
name|tri
operator|->
name|a
operator|.
name|x
expr_stmt|;
name|ed2
operator|.
name|y
operator|=
name|tri
operator|->
name|b
operator|.
name|y
operator|-
name|tri
operator|->
name|a
operator|.
name|y
expr_stmt|;
name|ed2
operator|.
name|z
operator|=
name|tri
operator|->
name|b
operator|.
name|z
operator|-
name|tri
operator|->
name|a
operator|.
name|z
expr_stmt|;
name|vcross
argument_list|(
operator|&
name|pvec
argument_list|,
operator|&
name|dir
argument_list|,
operator|&
name|ed2
argument_list|)
expr_stmt|;
name|det
operator|=
name|vdot
argument_list|(
operator|&
name|ed1
argument_list|,
operator|&
name|pvec
argument_list|)
expr_stmt|;
name|idet
operator|=
literal|1.0
operator|/
name|det
expr_stmt|;
name|tvec
operator|.
name|x
operator|=
name|orig
operator|->
name|x
expr_stmt|;
name|tvec
operator|.
name|y
operator|=
name|orig
operator|->
name|y
expr_stmt|;
name|tvec
operator|.
name|z
operator|=
name|orig
operator|->
name|z
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|tvec
argument_list|,
operator|&
name|tri
operator|->
name|a
argument_list|)
expr_stmt|;
name|u
operator|=
name|vdot
argument_list|(
operator|&
name|tvec
argument_list|,
operator|&
name|pvec
argument_list|)
operator|*
name|idet
expr_stmt|;
if|if
condition|(
name|u
operator|<
literal|0.0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|u
operator|>
literal|1.0
condition|)
return|return
literal|0
return|;
name|vcross
argument_list|(
operator|&
name|qvec
argument_list|,
operator|&
name|tvec
argument_list|,
operator|&
name|ed1
argument_list|)
expr_stmt|;
name|v
operator|=
name|vdot
argument_list|(
operator|&
name|dir
argument_list|,
operator|&
name|qvec
argument_list|)
operator|*
name|idet
expr_stmt|;
if|if
condition|(
operator|(
name|v
operator|<
literal|0.0
operator|)
operator|||
operator|(
name|u
operator|+
name|v
operator|>
literal|1.0
operator|)
condition|)
return|return
literal|0
return|;
name|t
operator|=
name|vdot
argument_list|(
operator|&
name|ed2
argument_list|,
operator|&
name|qvec
argument_list|)
operator|*
name|idet
expr_stmt|;
return|return
name|t
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|transformpoint (GimpVector4 * p,texture * t)
name|transformpoint
parameter_list|(
name|GimpVector4
modifier|*
name|p
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|gdouble
name|point
index|[
literal|3
index|]
decl_stmt|,
name|f
decl_stmt|;
if|if
condition|(
operator|(
name|t
operator|->
name|rotate
operator|.
name|x
operator|!=
literal|0.0
operator|)
operator|||
operator|(
name|t
operator|->
name|rotate
operator|.
name|y
operator|!=
literal|0.0
operator|)
operator|||
operator|(
name|t
operator|->
name|rotate
operator|.
name|z
operator|!=
literal|0.0
operator|)
condition|)
name|vvrotate
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|->
name|rotate
argument_list|)
expr_stmt|;
name|vvdiv
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|->
name|scale
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|->
name|translate
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|t
operator|->
name|turbulence
operator|.
name|x
operator|!=
literal|0.0
operator|)
operator|||
operator|(
name|t
operator|->
name|turbulence
operator|.
name|y
operator|!=
literal|0.0
operator|)
operator|||
operator|(
name|t
operator|->
name|turbulence
operator|.
name|z
operator|!=
literal|0.0
operator|)
condition|)
block|{
name|point
index|[
literal|0
index|]
operator|=
name|p
operator|->
name|x
expr_stmt|;
name|point
index|[
literal|1
index|]
operator|=
name|p
operator|->
name|y
expr_stmt|;
name|point
index|[
literal|2
index|]
operator|=
name|p
operator|->
name|z
expr_stmt|;
name|f
operator|=
name|turbulence
argument_list|(
name|point
argument_list|,
literal|1
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|p
operator|->
name|x
operator|+=
name|t
operator|->
name|turbulence
operator|.
name|x
operator|*
name|f
expr_stmt|;
name|p
operator|->
name|y
operator|+=
name|t
operator|->
name|turbulence
operator|.
name|y
operator|*
name|f
expr_stmt|;
name|p
operator|->
name|z
operator|+=
name|t
operator|->
name|turbulence
operator|.
name|z
operator|*
name|f
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|checker (GimpVector4 * q,GimpVector4 * col,texture * t)
name|checker
parameter_list|(
name|GimpVector4
modifier|*
name|q
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|gint
name|c
init|=
literal|0
decl_stmt|;
name|GimpVector4
name|p
decl_stmt|;
name|p
operator|=
operator|*
name|q
expr_stmt|;
name|transformpoint
argument_list|(
operator|&
name|p
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|p
argument_list|,
literal|0.25
argument_list|)
expr_stmt|;
name|p
operator|.
name|x
operator|+=
literal|0.00001
expr_stmt|;
name|p
operator|.
name|y
operator|+=
literal|0.00001
expr_stmt|;
name|p
operator|.
name|z
operator|+=
literal|0.00001
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|x
operator|<
literal|0.0
condition|)
name|p
operator|.
name|x
operator|=
literal|0.5
operator|-
name|p
operator|.
name|x
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|y
operator|<
literal|0.0
condition|)
name|p
operator|.
name|y
operator|=
literal|0.5
operator|-
name|p
operator|.
name|y
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|z
operator|<
literal|0.0
condition|)
name|p
operator|.
name|z
operator|=
literal|0.5
operator|-
name|p
operator|.
name|z
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|.
name|x
operator|-
operator|(
name|gint
operator|)
name|p
operator|.
name|x
operator|)
operator|<
literal|0.5
condition|)
name|c
operator|^=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|.
name|y
operator|-
operator|(
name|gint
operator|)
name|p
operator|.
name|y
operator|)
operator|<
literal|0.5
condition|)
name|c
operator|^=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|.
name|z
operator|-
operator|(
name|gint
operator|)
name|p
operator|.
name|z
operator|)
operator|<
literal|0.5
condition|)
name|c
operator|^=
literal|1
expr_stmt|;
operator|*
name|col
operator|=
operator|(
name|c
operator|)
condition|?
name|t
operator|->
name|color1
else|:
name|t
operator|->
name|color2
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradcolor (GimpVector4 * col,gradient * t,gdouble val)
name|gradcolor
parameter_list|(
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|gradient
modifier|*
name|t
parameter_list|,
name|gdouble
name|val
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|gdouble
name|d
decl_stmt|;
name|GimpVector4
name|tmpcol
decl_stmt|;
name|val
operator|=
name|CLAMP
argument_list|(
name|val
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|t
operator|->
name|numcol
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|t
operator|->
name|pos
index|[
name|i
index|]
operator|==
name|val
condition|)
block|{
operator|*
name|col
operator|=
name|t
operator|->
name|color
index|[
name|i
index|]
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|t
operator|->
name|pos
index|[
name|i
index|]
operator|>
name|val
condition|)
block|{
name|d
operator|=
operator|(
name|val
operator|-
name|t
operator|->
name|pos
index|[
name|i
operator|-
literal|1
index|]
operator|)
operator|/
operator|(
name|t
operator|->
name|pos
index|[
name|i
index|]
operator|-
name|t
operator|->
name|pos
index|[
name|i
operator|-
literal|1
index|]
operator|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|tmpcol
argument_list|,
operator|&
name|t
operator|->
name|color
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|tmpcol
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
name|col
argument_list|,
operator|&
name|tmpcol
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|tmpcol
argument_list|,
operator|&
name|t
operator|->
name|color
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|tmpcol
argument_list|,
literal|1.0
operator|-
name|d
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|tmpcol
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|g_printerr
argument_list|(
literal|"Error in gradient!\n"
argument_list|)
expr_stmt|;
name|vset
argument_list|(
name|col
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|marble (GimpVector4 * q,GimpVector4 * col,texture * t)
name|marble
parameter_list|(
name|GimpVector4
modifier|*
name|q
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|gdouble
name|f
decl_stmt|;
name|GimpVector4
name|p
decl_stmt|;
name|p
operator|=
operator|*
name|q
expr_stmt|;
name|transformpoint
argument_list|(
operator|&
name|p
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|f
operator|=
name|sin
argument_list|(
name|p
operator|.
name|x
operator|*
literal|4
argument_list|)
operator|/
literal|2
operator|+
literal|0.5
expr_stmt|;
name|f
operator|=
name|pow
argument_list|(
name|f
argument_list|,
name|t
operator|->
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|flags
operator|&
name|GRADIENT
condition|)
name|gradcolor
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|gradient
argument_list|,
name|f
argument_list|)
expr_stmt|;
else|else
name|vmix
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|,
operator|&
name|t
operator|->
name|color2
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|lizard (GimpVector4 * q,GimpVector4 * col,texture * t)
name|lizard
parameter_list|(
name|GimpVector4
modifier|*
name|q
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|gdouble
name|f
decl_stmt|;
name|GimpVector4
name|p
decl_stmt|;
name|p
operator|=
operator|*
name|q
expr_stmt|;
name|transformpoint
argument_list|(
operator|&
name|p
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|f
operator|=
name|fabs
argument_list|(
name|sin
argument_list|(
name|p
operator|.
name|x
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|+=
name|fabs
argument_list|(
name|sin
argument_list|(
name|p
operator|.
name|y
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|+=
name|fabs
argument_list|(
name|sin
argument_list|(
name|p
operator|.
name|z
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|/=
literal|3.0
expr_stmt|;
name|f
operator|=
name|pow
argument_list|(
name|f
argument_list|,
name|t
operator|->
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|flags
operator|&
name|GRADIENT
condition|)
name|gradcolor
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|gradient
argument_list|,
name|f
argument_list|)
expr_stmt|;
else|else
name|vmix
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|,
operator|&
name|t
operator|->
name|color2
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|wood (GimpVector4 * q,GimpVector4 * col,texture * t)
name|wood
parameter_list|(
name|GimpVector4
modifier|*
name|q
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|gdouble
name|f
decl_stmt|;
name|GimpVector4
name|p
decl_stmt|;
name|p
operator|=
operator|*
name|q
expr_stmt|;
name|transformpoint
argument_list|(
operator|&
name|p
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|f
operator|=
name|fabs
argument_list|(
name|p
operator|.
name|x
argument_list|)
expr_stmt|;
name|f
operator|=
name|f
operator|-
operator|(
name|int
operator|)
name|f
expr_stmt|;
name|f
operator|=
name|pow
argument_list|(
name|f
argument_list|,
name|t
operator|->
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|flags
operator|&
name|GRADIENT
condition|)
name|gradcolor
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|gradient
argument_list|,
name|f
argument_list|)
expr_stmt|;
else|else
name|vmix
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|,
operator|&
name|t
operator|->
name|color2
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|spiral (GimpVector4 * q,GimpVector4 * col,texture * t)
name|spiral
parameter_list|(
name|GimpVector4
modifier|*
name|q
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|gdouble
name|f
decl_stmt|;
name|GimpVector4
name|p
decl_stmt|;
name|p
operator|=
operator|*
name|q
expr_stmt|;
name|transformpoint
argument_list|(
operator|&
name|p
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|f
operator|=
name|fabs
argument_list|(
name|atan2
argument_list|(
name|p
operator|.
name|x
argument_list|,
name|p
operator|.
name|z
argument_list|)
operator|/
name|G_PI
operator|/
literal|2
operator|+
name|p
operator|.
name|y
operator|+
literal|99999
argument_list|)
expr_stmt|;
name|f
operator|=
name|f
operator|-
operator|(
name|int
operator|)
name|f
expr_stmt|;
name|f
operator|=
name|pow
argument_list|(
name|f
argument_list|,
name|t
operator|->
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|flags
operator|&
name|GRADIENT
condition|)
name|gradcolor
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|gradient
argument_list|,
name|f
argument_list|)
expr_stmt|;
else|else
name|vmix
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|,
operator|&
name|t
operator|->
name|color2
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|spots (GimpVector4 * q,GimpVector4 * col,texture * t)
name|spots
parameter_list|(
name|GimpVector4
modifier|*
name|q
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|gdouble
name|f
decl_stmt|;
name|GimpVector4
name|p
decl_stmt|,
name|r
decl_stmt|;
name|p
operator|=
operator|*
name|q
expr_stmt|;
name|transformpoint
argument_list|(
operator|&
name|p
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|p
operator|.
name|x
operator|+=
literal|10000.0
expr_stmt|;
name|p
operator|.
name|y
operator|+=
literal|10000.0
expr_stmt|;
name|p
operator|.
name|z
operator|+=
literal|10000.0
expr_stmt|;
name|vset
argument_list|(
operator|&
name|r
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|p
operator|.
name|x
operator|+
literal|0.5
argument_list|)
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|p
operator|.
name|y
operator|+
literal|0.5
argument_list|)
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|p
operator|.
name|z
operator|+
literal|0.5
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|=
name|vdist
argument_list|(
operator|&
name|p
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|f
operator|=
name|cos
argument_list|(
name|f
operator|*
name|G_PI
argument_list|)
expr_stmt|;
name|f
operator|=
name|CLAMP
argument_list|(
name|f
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|f
operator|=
name|pow
argument_list|(
name|f
argument_list|,
name|t
operator|->
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|flags
operator|&
name|GRADIENT
condition|)
name|gradcolor
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|gradient
argument_list|,
name|f
argument_list|)
expr_stmt|;
else|else
name|vmix
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|,
operator|&
name|t
operator|->
name|color2
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|perlin (GimpVector4 * q,GimpVector4 * col,texture * t)
name|perlin
parameter_list|(
name|GimpVector4
modifier|*
name|q
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|gdouble
name|f
decl_stmt|,
name|point
index|[
literal|3
index|]
decl_stmt|;
name|GimpVector4
name|p
decl_stmt|;
name|p
operator|=
operator|*
name|q
expr_stmt|;
name|transformpoint
argument_list|(
operator|&
name|p
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|point
index|[
literal|0
index|]
operator|=
name|p
operator|.
name|x
expr_stmt|;
name|point
index|[
literal|1
index|]
operator|=
name|p
operator|.
name|y
expr_stmt|;
name|point
index|[
literal|2
index|]
operator|=
name|p
operator|.
name|z
expr_stmt|;
name|f
operator|=
name|turbulence
argument_list|(
name|point
argument_list|,
literal|1
argument_list|,
literal|256
argument_list|)
operator|*
literal|0.3
operator|+
literal|0.5
expr_stmt|;
name|f
operator|=
name|pow
argument_list|(
name|f
argument_list|,
name|t
operator|->
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|flags
operator|&
name|GRADIENT
condition|)
name|gradcolor
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|gradient
argument_list|,
name|f
argument_list|)
expr_stmt|;
else|else
name|vmix
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|,
operator|&
name|t
operator|->
name|color2
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|imagepixel (GimpVector4 * q,GimpVector4 * col,texture * t)
name|imagepixel
parameter_list|(
name|GimpVector4
modifier|*
name|q
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|GimpVector4
name|p
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|guchar
modifier|*
name|rgb
decl_stmt|;
name|p
operator|=
operator|*
name|q
expr_stmt|;
name|transformpoint
argument_list|(
operator|&
name|p
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|p
operator|.
name|x
operator|*
name|t
operator|->
name|image
operator|.
name|xsize
operator|)
expr_stmt|;
name|y
operator|=
operator|(
name|p
operator|.
name|y
operator|*
name|t
operator|->
name|image
operator|.
name|ysize
operator|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|%
name|t
operator|->
name|image
operator|.
name|xsize
operator|+
name|t
operator|->
name|image
operator|.
name|xsize
operator|)
operator|%
name|t
operator|->
name|image
operator|.
name|xsize
expr_stmt|;
name|y
operator|=
operator|(
name|y
operator|%
name|t
operator|->
name|image
operator|.
name|ysize
operator|+
name|t
operator|->
name|image
operator|.
name|ysize
operator|)
operator|%
name|t
operator|->
name|image
operator|.
name|ysize
expr_stmt|;
name|rgb
operator|=
operator|&
name|t
operator|->
name|image
operator|.
name|rgb
index|[
name|x
operator|*
literal|3
operator|+
operator|(
name|t
operator|->
name|image
operator|.
name|ysize
operator|-
literal|1
operator|-
name|y
operator|)
operator|*
name|t
operator|->
name|image
operator|.
name|xsize
operator|*
literal|3
index|]
expr_stmt|;
name|vset
argument_list|(
name|col
argument_list|,
name|rgb
index|[
literal|0
index|]
operator|/
literal|255.0
argument_list|,
name|rgb
index|[
literal|1
index|]
operator|/
literal|255.0
argument_list|,
name|rgb
index|[
literal|2
index|]
operator|/
literal|255.0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|objcolor (GimpVector4 * col,GimpVector4 * p,common * obj)
name|objcolor
parameter_list|(
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|GimpVector4
modifier|*
name|p
parameter_list|,
name|common
modifier|*
name|obj
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|texture
modifier|*
name|t
decl_stmt|;
name|GimpVector4
name|tmpcol
decl_stmt|;
name|vcset
argument_list|(
name|col
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|obj
operator|->
name|numtexture
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
operator|&
name|obj
operator|->
name|texture
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|world
operator|.
name|quality
operator|<
literal|1
condition|)
block|{
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|vset
argument_list|(
operator|&
name|tmpcol
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|t
operator|->
name|type
condition|)
block|{
case|case
name|SOLID
case|:
name|vcopy
argument_list|(
operator|&
name|tmpcol
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHECKER
case|:
name|checker
argument_list|(
name|p
argument_list|,
operator|&
name|tmpcol
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|MARBLE
case|:
name|marble
argument_list|(
name|p
argument_list|,
operator|&
name|tmpcol
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|LIZARD
case|:
name|lizard
argument_list|(
name|p
argument_list|,
operator|&
name|tmpcol
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|PERLIN
case|:
name|perlin
argument_list|(
name|p
argument_list|,
operator|&
name|tmpcol
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|WOOD
case|:
name|wood
argument_list|(
name|p
argument_list|,
operator|&
name|tmpcol
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPIRAL
case|:
name|spiral
argument_list|(
name|p
argument_list|,
operator|&
name|tmpcol
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPOTS
case|:
name|spots
argument_list|(
name|p
argument_list|,
operator|&
name|tmpcol
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|IMAGE
case|:
name|imagepixel
argument_list|(
name|p
argument_list|,
operator|&
name|tmpcol
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|PHONG
case|:
case|case
name|REFRACTION
case|:
case|case
name|REFLECTION
case|:
case|case
name|TRANSPARENT
case|:
case|case
name|SMOKE
case|:
comment|/* Silently ignore non-color textures */
continue|continue;
break|break;
default|default:
name|g_printerr
argument_list|(
literal|"Warning: unknown texture %d\n"
argument_list|,
name|t
operator|->
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
name|vmul
argument_list|(
operator|&
name|tmpcol
argument_list|,
name|t
operator|->
name|amount
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|tmpcol
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|i
condition|)
block|{
name|g_printerr
argument_list|(
literal|"Warning: object %p has no textures\n"
argument_list|,
name|obj
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|objnormal (GimpVector4 * res,common * obj,GimpVector4 * p)
name|objnormal
parameter_list|(
name|GimpVector4
modifier|*
name|res
parameter_list|,
name|common
modifier|*
name|obj
parameter_list|,
name|GimpVector4
modifier|*
name|p
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
switch|switch
condition|(
name|obj
operator|->
name|type
condition|)
block|{
case|case
name|TRIANGLE
case|:
name|trianglenormal
argument_list|(
name|res
argument_list|,
name|NULL
argument_list|,
operator|(
name|triangle
operator|*
operator|)
name|obj
argument_list|)
expr_stmt|;
break|break;
case|case
name|DISC
case|:
name|vcopy
argument_list|(
name|res
argument_list|,
operator|&
operator|(
operator|(
name|disc
operator|*
operator|)
name|obj
operator|)
operator|->
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|PLANE
case|:
name|vcopy
argument_list|(
name|res
argument_list|,
operator|&
operator|(
operator|(
name|plane
operator|*
operator|)
name|obj
operator|)
operator|->
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPHERE
case|:
name|vcopy
argument_list|(
name|res
argument_list|,
operator|&
operator|(
operator|(
name|sphere
operator|*
operator|)
name|obj
operator|)
operator|->
name|a
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
name|res
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
name|CYLINDER
case|:
name|vset
argument_list|(
name|res
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* fixme */
break|break;
default|default:
name|g_error
argument_list|(
literal|"objnormal(): Unsupported object type!?\n"
argument_list|)
expr_stmt|;
block|}
name|vnorm
argument_list|(
name|res
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|obj
operator|->
name|numnormal
condition|;
name|i
operator|++
control|)
block|{
name|gint
name|k
decl_stmt|;
name|GimpVector4
name|tmpcol
index|[
literal|6
index|]
decl_stmt|;
name|GimpVector4
name|q
index|[
literal|6
index|]
decl_stmt|,
name|nres
decl_stmt|;
name|texture
modifier|*
name|t
init|=
operator|&
name|obj
operator|->
name|normal
index|[
name|i
index|]
decl_stmt|;
name|gdouble
name|nstep
init|=
literal|0.1
decl_stmt|;
name|vset
argument_list|(
operator|&
name|nres
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|6
condition|;
name|k
operator|++
control|)
block|{
name|vcopy
argument_list|(
operator|&
name|q
index|[
name|k
index|]
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
name|q
index|[
literal|0
index|]
operator|.
name|x
operator|+=
name|nstep
expr_stmt|;
name|q
index|[
literal|1
index|]
operator|.
name|x
operator|-=
name|nstep
expr_stmt|;
name|q
index|[
literal|2
index|]
operator|.
name|y
operator|+=
name|nstep
expr_stmt|;
name|q
index|[
literal|3
index|]
operator|.
name|y
operator|-=
name|nstep
expr_stmt|;
name|q
index|[
literal|4
index|]
operator|.
name|z
operator|+=
name|nstep
expr_stmt|;
name|q
index|[
literal|5
index|]
operator|.
name|z
operator|-=
name|nstep
expr_stmt|;
switch|switch
condition|(
name|t
operator|->
name|type
condition|)
block|{
case|case
name|MARBLE
case|:
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|6
condition|;
name|k
operator|++
control|)
name|marble
argument_list|(
operator|&
name|q
index|[
name|k
index|]
argument_list|,
operator|&
name|tmpcol
index|[
name|k
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|LIZARD
case|:
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|6
condition|;
name|k
operator|++
control|)
name|lizard
argument_list|(
operator|&
name|q
index|[
name|k
index|]
argument_list|,
operator|&
name|tmpcol
index|[
name|k
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|PERLIN
case|:
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|6
condition|;
name|k
operator|++
control|)
name|perlin
argument_list|(
operator|&
name|q
index|[
name|k
index|]
argument_list|,
operator|&
name|tmpcol
index|[
name|k
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|WOOD
case|:
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|6
condition|;
name|k
operator|++
control|)
name|wood
argument_list|(
operator|&
name|q
index|[
name|k
index|]
argument_list|,
operator|&
name|tmpcol
index|[
name|k
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPIRAL
case|:
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|6
condition|;
name|k
operator|++
control|)
name|spiral
argument_list|(
operator|&
name|q
index|[
name|k
index|]
argument_list|,
operator|&
name|tmpcol
index|[
name|k
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPOTS
case|:
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|6
condition|;
name|k
operator|++
control|)
name|spots
argument_list|(
operator|&
name|q
index|[
name|k
index|]
argument_list|,
operator|&
name|tmpcol
index|[
name|k
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|IMAGE
case|:
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|6
condition|;
name|k
operator|++
control|)
name|imagepixel
argument_list|(
operator|&
name|q
index|[
name|k
index|]
argument_list|,
operator|&
name|tmpcol
index|[
name|k
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHECKER
case|:
case|case
name|SOLID
case|:
case|case
name|PHONG
case|:
case|case
name|REFRACTION
case|:
case|case
name|REFLECTION
case|:
case|case
name|TRANSPARENT
case|:
case|case
name|SMOKE
case|:
continue|continue;
break|break;
default|default:
name|g_printerr
argument_list|(
literal|"Warning: unknown texture %d\n"
argument_list|,
name|t
operator|->
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
name|nres
operator|.
name|x
operator|=
name|tmpcol
index|[
literal|0
index|]
operator|.
name|x
operator|-
name|tmpcol
index|[
literal|1
index|]
operator|.
name|x
expr_stmt|;
name|nres
operator|.
name|y
operator|=
name|tmpcol
index|[
literal|2
index|]
operator|.
name|x
operator|-
name|tmpcol
index|[
literal|3
index|]
operator|.
name|x
expr_stmt|;
name|nres
operator|.
name|z
operator|=
name|tmpcol
index|[
literal|4
index|]
operator|.
name|x
operator|-
name|tmpcol
index|[
literal|5
index|]
operator|.
name|x
expr_stmt|;
name|vadd
argument_list|(
operator|&
name|nres
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|nres
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|nres
argument_list|,
name|t
operator|->
name|amount
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|res
argument_list|,
operator|&
name|nres
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
name|res
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*    Quality:    0 = Color only    1 = Textures    2 = Light + Normals    3 = Shadows    4 = Phong    5 = Reflection + Refraction  */
end_comment

begin_function
specifier|static
name|void
DECL|function|calclight (GimpVector4 * col,GimpVector4 * point,common * obj)
name|calclight
parameter_list|(
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|GimpVector4
modifier|*
name|point
parameter_list|,
name|common
modifier|*
name|obj
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ray
name|r
decl_stmt|;
name|gdouble
name|d
decl_stmt|,
name|b
decl_stmt|,
name|a
decl_stmt|;
name|GimpVector4
name|lcol
decl_stmt|;
name|GimpVector4
name|norm
decl_stmt|;
name|GimpVector4
name|pcol
decl_stmt|;
name|vcset
argument_list|(
name|col
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|objcolor
argument_list|(
operator|&
name|pcol
argument_list|,
name|point
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|a
operator|=
name|pcol
operator|.
name|w
expr_stmt|;
if|if
condition|(
name|world
operator|.
name|quality
operator|<
literal|2
condition|)
block|{
name|vcopy
argument_list|(
name|col
argument_list|,
operator|&
name|pcol
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|obj
operator|->
name|numtexture
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PHONG
condition|)
continue|continue;
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|REFLECTION
condition|)
continue|continue;
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|REFRACTION
condition|)
continue|continue;
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|TRANSPARENT
condition|)
continue|continue;
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|SMOKE
condition|)
continue|continue;
name|vcopy
argument_list|(
operator|&
name|lcol
argument_list|,
operator|&
name|pcol
argument_list|)
expr_stmt|;
name|vvmul
argument_list|(
operator|&
name|lcol
argument_list|,
operator|&
name|obj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|ambient
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|lcol
argument_list|)
expr_stmt|;
block|}
name|objnormal
argument_list|(
operator|&
name|norm
argument_list|,
name|obj
argument_list|,
name|point
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|norm
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|r
operator|.
name|inside
operator|=
operator|-
literal|1
expr_stmt|;
name|r
operator|.
name|ior
operator|=
literal|1.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|world
operator|.
name|numlight
condition|;
name|i
operator|++
control|)
block|{
name|vcopy
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
name|point
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|r
operator|.
name|v2
argument_list|,
operator|&
name|world
operator|.
name|light
index|[
name|i
index|]
operator|.
name|a
argument_list|)
expr_stmt|;
name|vmix
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r
operator|.
name|v2
argument_list|,
literal|0.9999
argument_list|)
expr_stmt|;
name|d
operator|=
name|vdist
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r
operator|.
name|v2
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r
operator|.
name|v2
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|b
operator|=
name|vdot
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|norm
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|<
literal|0.0
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|obj
operator|->
name|numtexture
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|type
operator|==
name|PHONG
condition|)
continue|continue;
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|type
operator|==
name|REFLECTION
condition|)
continue|continue;
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|type
operator|==
name|REFRACTION
condition|)
continue|continue;
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|type
operator|==
name|TRANSPARENT
condition|)
continue|continue;
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|type
operator|==
name|SMOKE
condition|)
continue|continue;
name|vcopy
argument_list|(
operator|&
name|lcol
argument_list|,
operator|&
name|pcol
argument_list|)
expr_stmt|;
name|vvmul
argument_list|(
operator|&
name|lcol
argument_list|,
operator|&
name|world
operator|.
name|light
index|[
name|i
index|]
operator|.
name|color
argument_list|)
expr_stmt|;
name|vvmul
argument_list|(
operator|&
name|lcol
argument_list|,
operator|&
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|diffuse
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|lcol
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|lcol
argument_list|)
expr_stmt|;
block|}
block|}
name|col
operator|->
name|w
operator|=
name|a
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|calcphong (common * obj,ray * r2,GimpVector4 * col)
name|calcphong
parameter_list|(
name|common
modifier|*
name|obj
parameter_list|,
name|ray
modifier|*
name|r2
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|,
name|o
decl_stmt|;
name|ray
name|r
decl_stmt|;
name|gdouble
name|d
decl_stmt|,
name|b
decl_stmt|;
name|GimpVector4
name|lcol
decl_stmt|;
name|GimpVector4
name|norm
decl_stmt|;
name|GimpVector4
name|pcol
decl_stmt|;
name|gdouble
name|ps
decl_stmt|;
name|vcopy
argument_list|(
operator|&
name|pcol
argument_list|,
name|col
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|norm
argument_list|,
operator|&
name|r2
operator|->
name|v2
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|norm
argument_list|,
operator|&
name|r2
operator|->
name|v1
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|norm
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|r
operator|.
name|inside
operator|=
operator|-
literal|1
expr_stmt|;
name|r
operator|.
name|ior
operator|=
literal|1.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|world
operator|.
name|numlight
condition|;
name|i
operator|++
control|)
block|{
name|vcopy
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r2
operator|->
name|v1
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|r
operator|.
name|v2
argument_list|,
operator|&
name|world
operator|.
name|light
index|[
name|i
index|]
operator|.
name|a
argument_list|)
expr_stmt|;
name|vmix
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r
operator|.
name|v2
argument_list|,
literal|0.9999
argument_list|)
expr_stmt|;
name|d
operator|=
name|vdist
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r
operator|.
name|v2
argument_list|)
expr_stmt|;
name|o
operator|=
name|traceray
argument_list|(
operator|&
name|r
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|o
condition|)
block|{
continue|continue;
block|}
comment|/* OK, light is visible */
name|vsub
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|r
operator|.
name|v2
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|b
operator|=
operator|-
name|vdot
argument_list|(
operator|&
name|r
operator|.
name|v1
argument_list|,
operator|&
name|norm
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|obj
operator|->
name|numtexture
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|type
operator|!=
name|PHONG
condition|)
continue|continue;
name|ps
operator|=
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|phongsize
expr_stmt|;
if|if
condition|(
name|b
operator|<
operator|(
literal|1
operator|-
name|ps
operator|)
condition|)
continue|continue;
name|ps
operator|=
operator|(
name|b
operator|-
operator|(
literal|1
operator|-
name|ps
operator|)
operator|)
operator|/
name|ps
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|lcol
argument_list|,
operator|&
name|obj
operator|->
name|texture
index|[
name|j
index|]
operator|.
name|phongcolor
argument_list|)
expr_stmt|;
name|vvmul
argument_list|(
operator|&
name|lcol
argument_list|,
operator|&
name|world
operator|.
name|light
index|[
name|i
index|]
operator|.
name|color
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|lcol
argument_list|,
name|ps
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|lcol
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|traceray (ray * r,GimpVector4 * col,gint level,gdouble imp)
name|traceray
parameter_list|(
name|ray
modifier|*
name|r
parameter_list|,
name|GimpVector4
modifier|*
name|col
parameter_list|,
name|gint
name|level
parameter_list|,
name|gdouble
name|imp
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|b
init|=
operator|-
literal|1
decl_stmt|;
name|gdouble
name|t
init|=
operator|-
literal|1.0
decl_stmt|,
name|min
init|=
literal|0.0
decl_stmt|;
name|gint
name|type
init|=
operator|-
literal|1
decl_stmt|;
name|common
modifier|*
name|obj
decl_stmt|,
modifier|*
name|bobj
init|=
name|NULL
decl_stmt|;
name|gint
name|hits
init|=
literal|0
decl_stmt|;
name|GimpVector4
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|level
operator|==
literal|0
operator|)
operator|||
operator|(
name|imp
operator|<
literal|0.005
operator|)
condition|)
block|{
name|vset
argument_list|(
name|col
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|world
operator|.
name|numobj
condition|;
name|i
operator|++
control|)
block|{
name|obj
operator|=
operator|(
name|common
operator|*
operator|)
operator|&
name|world
operator|.
name|obj
index|[
name|i
index|]
expr_stmt|;
switch|switch
condition|(
name|obj
operator|->
name|type
condition|)
block|{
case|case
name|TRIANGLE
case|:
name|t
operator|=
name|checktri
argument_list|(
name|r
argument_list|,
operator|(
name|triangle
operator|*
operator|)
operator|&
name|world
operator|.
name|obj
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|DISC
case|:
name|t
operator|=
name|checkdisc
argument_list|(
name|r
argument_list|,
operator|(
name|disc
operator|*
operator|)
operator|&
name|world
operator|.
name|obj
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|PLANE
case|:
name|t
operator|=
name|checkplane
argument_list|(
name|r
argument_list|,
operator|(
name|plane
operator|*
operator|)
operator|&
name|world
operator|.
name|obj
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPHERE
case|:
name|t
operator|=
name|checksphere
argument_list|(
name|r
argument_list|,
operator|(
name|sphere
operator|*
operator|)
operator|&
name|world
operator|.
name|obj
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|CYLINDER
case|:
name|t
operator|=
name|checkcylinder
argument_list|(
name|r
argument_list|,
operator|(
name|cylinder
operator|*
operator|)
operator|&
name|world
operator|.
name|obj
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_error
argument_list|(
literal|"Illegal object!!\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t
operator|<=
literal|0.0
condition|)
continue|continue;
if|if
condition|(
operator|!
operator|(
name|obj
operator|->
name|flags
operator|&
name|NOSHADOW
operator|)
operator|&&
operator|(
name|level
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
return|return
name|i
operator|+
literal|1
return|;
block|}
name|hits
operator|++
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|bobj
operator|)
operator|||
operator|(
name|t
operator|<
name|min
operator|)
condition|)
block|{
name|min
operator|=
name|t
expr_stmt|;
name|b
operator|=
name|i
expr_stmt|;
name|type
operator|=
name|obj
operator|->
name|type
expr_stmt|;
name|bobj
operator|=
name|obj
expr_stmt|;
block|}
block|}
if|if
condition|(
name|level
operator|==
operator|-
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|bobj
condition|)
block|{
name|p
operator|.
name|x
operator|=
name|r
operator|->
name|v1
operator|.
name|x
operator|+
operator|(
name|r
operator|->
name|v2
operator|.
name|x
operator|-
name|r
operator|->
name|v1
operator|.
name|x
operator|)
operator|*
name|min
expr_stmt|;
name|p
operator|.
name|y
operator|=
name|r
operator|->
name|v1
operator|.
name|y
operator|+
operator|(
name|r
operator|->
name|v2
operator|.
name|y
operator|-
name|r
operator|->
name|v1
operator|.
name|y
operator|)
operator|*
name|min
expr_stmt|;
name|p
operator|.
name|z
operator|=
name|r
operator|->
name|v1
operator|.
name|z
operator|+
operator|(
name|r
operator|->
name|v2
operator|.
name|z
operator|-
name|r
operator|->
name|v1
operator|.
name|z
operator|)
operator|*
name|min
expr_stmt|;
name|calclight
argument_list|(
name|col
argument_list|,
operator|&
name|p
argument_list|,
name|bobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|world
operator|.
name|flags
operator|&
name|SMARTAMBIENT
condition|)
block|{
name|gdouble
name|ambient
init|=
literal|0.3
operator|*
name|exp
argument_list|(
operator|-
name|min
operator|/
name|world
operator|.
name|smartambient
argument_list|)
decl_stmt|;
name|GimpVector4
name|lcol
decl_stmt|;
name|objcolor
argument_list|(
operator|&
name|lcol
argument_list|,
operator|&
name|p
argument_list|,
name|bobj
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|lcol
argument_list|,
name|ambient
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|lcol
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bobj
operator|->
name|numtexture
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|world
operator|.
name|quality
operator|>=
literal|4
operator|)
operator|&&
operator|(
operator|(
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|REFLECTION
operator|)
operator|||
operator|(
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PHONG
operator|)
operator|)
condition|)
block|{
name|GimpVector4
name|refcol
decl_stmt|,
name|norm
decl_stmt|,
name|ocol
decl_stmt|;
name|ray
name|ref
decl_stmt|;
name|objcolor
argument_list|(
operator|&
name|ocol
argument_list|,
operator|&
name|p
argument_list|,
name|bobj
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|r
operator|->
name|v1
argument_list|)
expr_stmt|;
name|ref
operator|.
name|inside
operator|=
name|r
operator|->
name|inside
expr_stmt|;
name|ref
operator|.
name|ior
operator|=
name|r
operator|->
name|ior
expr_stmt|;
name|vmix
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|0.9999
argument_list|)
expr_stmt|;
comment|/* push it a tad */
name|vsub
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|objnormal
argument_list|(
operator|&
name|norm
argument_list|,
name|bobj
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|norm
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|vrotate
argument_list|(
operator|&
name|norm
argument_list|,
literal|180.0
argument_list|,
operator|&
name|ref
operator|.
name|v2
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|norm
argument_list|,
operator|-
literal|0.0001
argument_list|)
expr_stmt|;
comment|/* push it a tad */
name|vadd
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|norm
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|world
operator|.
name|quality
operator|>=
literal|5
operator|)
operator|&&
operator|(
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|REFLECTION
operator|)
condition|)
block|{
name|traceray
argument_list|(
operator|&
name|ref
argument_list|,
operator|&
name|refcol
argument_list|,
name|level
operator|-
literal|1
argument_list|,
name|imp
operator|*
name|vmax
argument_list|(
operator|&
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|reflection
argument_list|)
argument_list|)
expr_stmt|;
name|vvmul
argument_list|(
operator|&
name|refcol
argument_list|,
operator|&
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|reflection
argument_list|)
expr_stmt|;
name|refcol
operator|.
name|w
operator|=
name|ocol
operator|.
name|w
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|refcol
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PHONG
condition|)
block|{
name|vcset
argument_list|(
operator|&
name|refcol
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|calcphong
argument_list|(
name|bobj
argument_list|,
operator|&
name|ref
argument_list|,
operator|&
name|refcol
argument_list|)
expr_stmt|;
name|refcol
operator|.
name|w
operator|=
name|ocol
operator|.
name|w
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|refcol
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|world
operator|.
name|quality
operator|>=
literal|5
operator|)
operator|&&
operator|(
name|col
operator|->
name|w
operator|<
literal|1.0
operator|)
condition|)
block|{
name|GimpVector4
name|refcol
decl_stmt|;
name|ray
name|ref
decl_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|r
operator|->
name|v1
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vmix
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|0.999
argument_list|)
expr_stmt|;
comment|/* push it a tad */
name|traceray
argument_list|(
operator|&
name|ref
argument_list|,
operator|&
name|refcol
argument_list|,
name|level
operator|-
literal|1
argument_list|,
name|imp
operator|*
operator|(
literal|1.0
operator|-
name|col
operator|->
name|w
operator|)
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|refcol
argument_list|,
operator|(
literal|1.0
operator|-
name|col
operator|->
name|w
operator|)
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|refcol
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|world
operator|.
name|quality
operator|>=
literal|5
operator|)
operator|&&
operator|(
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|TRANSPARENT
operator|)
condition|)
block|{
name|GimpVector4
name|refcol
decl_stmt|;
name|ray
name|ref
decl_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|r
operator|->
name|v1
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vmix
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|0.999
argument_list|)
expr_stmt|;
comment|/* push it a tad */
name|traceray
argument_list|(
operator|&
name|ref
argument_list|,
operator|&
name|refcol
argument_list|,
name|level
operator|-
literal|1
argument_list|,
name|imp
operator|*
name|vmax
argument_list|(
operator|&
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|transparent
argument_list|)
argument_list|)
expr_stmt|;
name|vvmul
argument_list|(
operator|&
name|refcol
argument_list|,
operator|&
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|transparent
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|refcol
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|world
operator|.
name|quality
operator|>=
literal|5
operator|)
operator|&&
operator|(
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|SMOKE
operator|)
condition|)
block|{
name|GimpVector4
name|smcol
decl_stmt|,
name|raydir
decl_stmt|,
name|norm
decl_stmt|;
name|double
name|tran
decl_stmt|;
name|ray
name|ref
decl_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|r
operator|->
name|v1
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|objnormal
argument_list|(
operator|&
name|norm
argument_list|,
name|bobj
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|raydir
argument_list|,
operator|&
name|r
operator|->
name|v2
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|raydir
argument_list|,
operator|&
name|r
operator|->
name|v1
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|raydir
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|tran
operator|=
name|vdot
argument_list|(
operator|&
name|norm
argument_list|,
operator|&
name|raydir
argument_list|)
expr_stmt|;
if|if
condition|(
name|tran
operator|<
literal|0.0
condition|)
continue|continue;
name|tran
operator|*=
name|tran
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|smcol
argument_list|,
operator|&
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|color1
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|smcol
argument_list|,
name|tran
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|smcol
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|world
operator|.
name|quality
operator|>=
literal|5
operator|)
operator|&&
operator|(
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|type
operator|==
name|REFRACTION
operator|)
condition|)
block|{
name|GimpVector4
name|refcol
decl_stmt|,
name|norm
decl_stmt|,
name|tmpv
decl_stmt|;
name|ray
name|ref
decl_stmt|;
name|double
name|c1
decl_stmt|,
name|c2
decl_stmt|,
name|n1
decl_stmt|,
name|n2
decl_stmt|,
name|n
decl_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|vsub
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|r
operator|->
name|v1
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|r
operator|->
name|v2
argument_list|)
expr_stmt|;
name|vmix
argument_list|(
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|ref
operator|.
name|v1
argument_list|,
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|0.999
argument_list|)
expr_stmt|;
comment|/* push it a tad */
name|vsub
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|objnormal
argument_list|(
operator|&
name|norm
argument_list|,
name|bobj
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|inside
operator|==
name|b
condition|)
block|{
name|ref
operator|.
name|inside
operator|=
operator|-
literal|1
expr_stmt|;
name|ref
operator|.
name|ior
operator|=
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|ref
operator|.
name|inside
operator|=
name|b
expr_stmt|;
name|ref
operator|.
name|ior
operator|=
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|ior
expr_stmt|;
block|}
name|c1
operator|=
name|vdot
argument_list|(
operator|&
name|norm
argument_list|,
operator|&
name|ref
operator|.
name|v2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ref
operator|.
name|inside
operator|<
literal|0
condition|)
name|c1
operator|=
operator|-
name|c1
expr_stmt|;
name|n1
operator|=
name|r
operator|->
name|ior
expr_stmt|;
comment|/* IOR of current media  */
name|n2
operator|=
name|ref
operator|.
name|ior
expr_stmt|;
comment|/* IOR of new media  */
name|n
operator|=
name|n1
operator|/
name|n2
expr_stmt|;
name|c2
operator|=
literal|1.0
operator|-
name|n
operator|*
name|n
operator|*
operator|(
literal|1.0
operator|-
name|c1
operator|*
name|c1
operator|)
expr_stmt|;
if|if
condition|(
name|c2
operator|<
literal|0.0
condition|)
block|{
comment|/* FIXME: Internal reflection should occur */
name|c2
operator|=
name|sqrt
argument_list|(
operator|-
name|c2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c2
operator|=
name|sqrt
argument_list|(
name|c2
argument_list|)
expr_stmt|;
block|}
name|vmul
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|tmpv
argument_list|,
operator|&
name|norm
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|tmpv
argument_list|,
name|n
operator|*
name|c1
operator|-
name|c2
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|tmpv
argument_list|)
expr_stmt|;
name|vnorm
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
operator|&
name|ref
operator|.
name|v2
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|traceray
argument_list|(
operator|&
name|ref
argument_list|,
operator|&
name|refcol
argument_list|,
name|level
operator|-
literal|1
argument_list|,
name|imp
operator|*
name|vmax
argument_list|(
operator|&
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|refraction
argument_list|)
argument_list|)
expr_stmt|;
name|vvmul
argument_list|(
operator|&
name|refcol
argument_list|,
operator|&
name|bobj
operator|->
name|texture
index|[
name|i
index|]
operator|.
name|refraction
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|refcol
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|vcset
argument_list|(
name|col
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|min
operator|=
literal|10000.0
expr_stmt|;
name|vcset
argument_list|(
operator|&
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|world
operator|.
name|numatmos
condition|;
name|i
operator|++
control|)
block|{
name|GimpVector4
name|tmpcol
decl_stmt|;
if|if
condition|(
name|world
operator|.
name|atmos
index|[
name|i
index|]
operator|.
name|type
operator|==
name|FOG
condition|)
block|{
name|gdouble
name|v
decl_stmt|,
name|pt
index|[
literal|3
index|]
decl_stmt|;
name|pt
index|[
literal|0
index|]
operator|=
name|p
operator|.
name|x
expr_stmt|;
name|pt
index|[
literal|1
index|]
operator|=
name|p
operator|.
name|y
expr_stmt|;
name|pt
index|[
literal|2
index|]
operator|=
name|p
operator|.
name|z
expr_stmt|;
if|if
condition|(
operator|(
name|v
operator|=
name|world
operator|.
name|atmos
index|[
name|i
index|]
operator|.
name|turbulence
operator|)
operator|>
literal|0.0
condition|)
name|v
operator|=
name|turbulence
argument_list|(
name|pt
argument_list|,
literal|1
argument_list|,
literal|256
argument_list|)
operator|*
name|world
operator|.
name|atmos
index|[
name|i
index|]
operator|.
name|turbulence
expr_stmt|;
name|v
operator|=
name|exp
argument_list|(
operator|-
operator|(
name|min
operator|+
name|v
operator|)
operator|/
name|world
operator|.
name|atmos
index|[
name|i
index|]
operator|.
name|density
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
name|col
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|tmpcol
argument_list|,
operator|&
name|world
operator|.
name|atmos
index|[
name|i
index|]
operator|.
name|color
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|tmpcol
argument_list|,
literal|1.0
operator|-
name|v
argument_list|)
expr_stmt|;
name|vadd
argument_list|(
name|col
argument_list|,
operator|&
name|tmpcol
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|hits
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|setdefaults (texture * t)
name|setdefaults
parameter_list|(
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|memset
argument_list|(
name|t
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|texture
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|type
operator|=
name|SOLID
expr_stmt|;
name|vcset
argument_list|(
operator|&
name|t
operator|->
name|color1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vcset
argument_list|(
operator|&
name|t
operator|->
name|color2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vcset
argument_list|(
operator|&
name|t
operator|->
name|diffuse
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vcset
argument_list|(
operator|&
name|t
operator|->
name|ambient
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vset
argument_list|(
operator|&
name|t
operator|->
name|scale
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vset
argument_list|(
operator|&
name|t
operator|->
name|rotate
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vset
argument_list|(
operator|&
name|t
operator|->
name|translate
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|t
operator|->
name|oscale
operator|=
literal|1.0
expr_stmt|;
name|t
operator|->
name|amount
operator|=
literal|1.0
expr_stmt|;
name|t
operator|->
name|exp
operator|=
literal|1.0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
DECL|function|mklabel (texture * t)
name|mklabel
parameter_list|(
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|struct
name|textures_t
modifier|*
name|l
decl_stmt|;
specifier|static
name|gchar
name|tmps
index|[
literal|100
index|]
decl_stmt|;
if|if
condition|(
name|t
operator|->
name|majtype
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|tmps
argument_list|,
name|_
argument_list|(
literal|"Texture"
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|t
operator|->
name|majtype
operator|==
literal|1
condition|)
name|strcpy
argument_list|(
name|tmps
argument_list|,
name|_
argument_list|(
literal|"Bumpmap"
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|t
operator|->
name|majtype
operator|==
literal|2
condition|)
name|strcpy
argument_list|(
name|tmps
argument_list|,
name|_
argument_list|(
literal|"Light"
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|tmps
argument_list|,
literal|"<unknown>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|t
operator|->
name|majtype
operator|==
literal|0
operator|)
operator|||
operator|(
name|t
operator|->
name|majtype
operator|==
literal|1
operator|)
condition|)
block|{
name|strcat
argument_list|(
name|tmps
argument_list|,
literal|" / "
argument_list|)
expr_stmt|;
name|l
operator|=
name|textures
expr_stmt|;
while|while
condition|(
name|l
operator|->
name|s
condition|)
block|{
if|if
condition|(
name|t
operator|->
name|type
operator|==
name|l
operator|->
name|n
condition|)
block|{
name|strcat
argument_list|(
name|tmps
argument_list|,
name|gettext
argument_list|(
name|l
operator|->
name|s
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|l
operator|++
expr_stmt|;
block|}
block|}
return|return
name|tmps
return|;
block|}
end_function

begin_function
specifier|static
name|texture
modifier|*
DECL|function|currenttexture (void)
name|currenttexture
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkTreeSelection
modifier|*
name|sel
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|texture
modifier|*
name|t
init|=
name|NULL
decl_stmt|;
name|sel
operator|=
name|gtk_tree_view_get_selection
argument_list|(
name|texturelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|gtk_tree_selection_get_selected
argument_list|(
name|sel
argument_list|,
name|NULL
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
block|{
name|gtk_tree_model_get
argument_list|(
name|gtk_tree_view_get_model
argument_list|(
name|texturelist
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|,
name|TEXTURE
argument_list|,
operator|&
name|t
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|t
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|relabel (void)
name|relabel
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|GtkTreeSelection
modifier|*
name|sel
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|texture
modifier|*
name|t
init|=
name|NULL
decl_stmt|;
name|sel
operator|=
name|gtk_tree_view_get_selection
argument_list|(
name|texturelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|gtk_tree_selection_get_selected
argument_list|(
name|sel
argument_list|,
name|NULL
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
block|{
name|model
operator|=
name|gtk_tree_view_get_model
argument_list|(
name|texturelist
argument_list|)
expr_stmt|;
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|TEXTURE
argument_list|,
operator|&
name|t
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|GTK_LIST_STORE
argument_list|(
name|model
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|,
name|TYPE
argument_list|,
name|mklabel
argument_list|(
name|t
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
DECL|variable|noupdate
specifier|static
name|gboolean
name|noupdate
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|setvals (texture * t)
name|setvals
parameter_list|(
name|texture
modifier|*
name|t
parameter_list|)
block|{
name|struct
name|textures_t
modifier|*
name|l
decl_stmt|;
if|if
condition|(
operator|!
name|t
condition|)
return|return;
name|noupdate
operator|=
name|TRUE
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|amountscale
argument_list|)
argument_list|,
name|t
operator|->
name|amount
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scalescale
argument_list|)
argument_list|,
name|t
operator|->
name|oscale
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scalexscale
argument_list|)
argument_list|,
name|t
operator|->
name|scale
operator|.
name|x
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scaleyscale
argument_list|)
argument_list|,
name|t
operator|->
name|scale
operator|.
name|y
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scalezscale
argument_list|)
argument_list|,
name|t
operator|->
name|scale
operator|.
name|z
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|rotxscale
argument_list|)
argument_list|,
name|t
operator|->
name|rotate
operator|.
name|x
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|rotyscale
argument_list|)
argument_list|,
name|t
operator|->
name|rotate
operator|.
name|y
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|rotzscale
argument_list|)
argument_list|,
name|t
operator|->
name|rotate
operator|.
name|z
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|posxscale
argument_list|)
argument_list|,
name|t
operator|->
name|translate
operator|.
name|x
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|posyscale
argument_list|)
argument_list|,
name|t
operator|->
name|translate
operator|.
name|y
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|poszscale
argument_list|)
argument_list|,
name|t
operator|->
name|translate
operator|.
name|z
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|turbulencescale
argument_list|)
argument_list|,
name|t
operator|->
name|turbulence
operator|.
name|x
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|expscale
argument_list|)
argument_list|,
name|t
operator|->
name|exp
argument_list|)
expr_stmt|;
name|drawcolor1
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|drawcolor2
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|l
operator|=
name|textures
expr_stmt|;
while|while
condition|(
name|l
operator|->
name|s
condition|)
block|{
if|if
condition|(
name|l
operator|->
name|n
operator|==
name|t
operator|->
name|type
condition|)
block|{
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|texturemenu
argument_list|)
argument_list|,
name|l
operator|->
name|index
argument_list|)
expr_stmt|;
break|break;
block|}
name|l
operator|++
expr_stmt|;
block|}
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|typemenu
argument_list|)
argument_list|,
name|t
operator|->
name|majtype
argument_list|)
expr_stmt|;
name|noupdate
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|selectitem (GtkTreeSelection * treeselection,gpointer data)
name|selectitem
parameter_list|(
name|GtkTreeSelection
modifier|*
name|treeselection
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|setvals
argument_list|(
name|currenttexture
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|addtexture (void)
name|addtexture
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkListStore
modifier|*
name|list_store
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|gint
name|n
init|=
name|s
operator|.
name|com
operator|.
name|numtexture
decl_stmt|;
if|if
condition|(
name|n
operator|==
name|MAXTEXTUREPEROBJ
operator|-
literal|1
condition|)
return|return;
name|setdefaults
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|list_store
operator|=
name|GTK_LIST_STORE
argument_list|(
name|gtk_tree_view_get_model
argument_list|(
name|texturelist
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_list_store_append
argument_list|(
name|list_store
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|list_store
argument_list|,
operator|&
name|iter
argument_list|,
name|TYPE
argument_list|,
name|mklabel
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
argument_list|)
argument_list|,
name|TEXTURE
argument_list|,
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_tree_selection_select_iter
argument_list|(
name|gtk_tree_view_get_selection
argument_list|(
name|texturelist
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|s
operator|.
name|com
operator|.
name|numtexture
operator|++
expr_stmt|;
name|restartrender
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|duptexture (void)
name|duptexture
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkListStore
modifier|*
name|list_store
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|texture
modifier|*
name|t
init|=
name|currenttexture
argument_list|()
decl_stmt|;
name|gint
name|n
init|=
name|s
operator|.
name|com
operator|.
name|numtexture
decl_stmt|;
if|if
condition|(
name|n
operator|==
name|MAXTEXTUREPEROBJ
operator|-
literal|1
condition|)
return|return;
if|if
condition|(
operator|!
name|t
condition|)
return|return;
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
operator|=
operator|*
name|t
expr_stmt|;
name|list_store
operator|=
name|GTK_LIST_STORE
argument_list|(
name|gtk_tree_view_get_model
argument_list|(
name|texturelist
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_list_store_append
argument_list|(
name|list_store
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|list_store
argument_list|,
operator|&
name|iter
argument_list|,
name|TYPE
argument_list|,
name|mklabel
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
argument_list|)
argument_list|,
name|TEXTURE
argument_list|,
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_tree_selection_select_iter
argument_list|(
name|gtk_tree_view_get_selection
argument_list|(
name|texturelist
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|s
operator|.
name|com
operator|.
name|numtexture
operator|++
expr_stmt|;
name|restartrender
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|rebuildlist (void)
name|rebuildlist
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkListStore
modifier|*
name|list_store
decl_stmt|;
name|GtkTreeSelection
modifier|*
name|sel
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|gint
name|n
decl_stmt|;
name|sel
operator|=
name|gtk_tree_view_get_selection
argument_list|(
name|texturelist
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|s
operator|.
name|com
operator|.
name|numtexture
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|s
operator|.
name|com
operator|.
name|numtexture
operator|&&
operator|(
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
operator|.
name|majtype
operator|<
literal|0
operator|)
condition|)
block|{
name|gint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|<
name|s
operator|.
name|com
operator|.
name|numtexture
operator|-
literal|1
condition|;
name|i
operator|++
control|)
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|i
index|]
operator|=
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|s
operator|.
name|com
operator|.
name|numtexture
operator|--
expr_stmt|;
name|n
operator|--
expr_stmt|;
block|}
block|}
name|list_store
operator|=
name|GTK_LIST_STORE
argument_list|(
name|gtk_tree_view_get_model
argument_list|(
name|texturelist
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|s
operator|.
name|com
operator|.
name|numtexture
condition|;
name|n
operator|++
control|)
block|{
name|gtk_list_store_append
argument_list|(
name|list_store
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|list_store
argument_list|,
operator|&
name|iter
argument_list|,
name|TYPE
argument_list|,
name|mklabel
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
argument_list|)
argument_list|,
name|TEXTURE
argument_list|,
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|n
index|]
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gtk_tree_model_get_iter_first
argument_list|(
name|GTK_TREE_MODEL
argument_list|(
name|list_store
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
name|gtk_tree_selection_select_iter
argument_list|(
name|sel
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|restartrender
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|deltexture (void)
name|deltexture
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkTreeSelection
modifier|*
name|sel
decl_stmt|;
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|texture
modifier|*
name|t
init|=
name|NULL
decl_stmt|;
name|sel
operator|=
name|gtk_tree_view_get_selection
argument_list|(
name|texturelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|gtk_tree_selection_get_selected
argument_list|(
name|sel
argument_list|,
name|NULL
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
block|{
name|model
operator|=
name|gtk_tree_view_get_model
argument_list|(
name|texturelist
argument_list|)
expr_stmt|;
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|TEXTURE
argument_list|,
operator|&
name|t
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|t
operator|->
name|majtype
operator|=
operator|-
literal|1
expr_stmt|;
name|gtk_list_store_remove
argument_list|(
name|GTK_LIST_STORE
argument_list|(
name|model
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
block|}
name|restartrender
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|loadit (const gchar * fn)
name|loadit
parameter_list|(
specifier|const
name|gchar
modifier|*
name|fn
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|gchar
name|endbuf
index|[
literal|21
operator|*
operator|(
name|G_ASCII_DTOSTR_BUF_SIZE
operator|+
literal|1
operator|)
index|]
decl_stmt|;
name|gchar
modifier|*
name|end
init|=
name|endbuf
decl_stmt|;
name|gchar
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|gchar
name|fmt_str
index|[
literal|16
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|texture
modifier|*
name|t
decl_stmt|;
name|gint
name|majtype
decl_stmt|,
name|type
decl_stmt|;
name|f
operator|=
name|g_fopen
argument_list|(
name|fn
argument_list|,
literal|"rt"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Could not open '%s' for reading: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|fn
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
literal|2
operator|!=
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"%d %d"
argument_list|,
operator|&
name|majtype
argument_list|,
operator|&
name|type
argument_list|)
operator|||
name|majtype
operator|<
literal|0
operator|||
name|majtype
operator|>
literal|2
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"File '%s' is not a valid save file."
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return;
block|}
name|rewind
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|s
operator|.
name|com
operator|.
name|numtexture
operator|=
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|fmt_str
argument_list|,
sizeof|sizeof
argument_list|(
name|fmt_str
argument_list|)
argument_list|,
literal|"%%d %%d %%%zus"
argument_list|,
sizeof|sizeof
argument_list|(
name|endbuf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|feof
argument_list|(
name|f
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|fgets
argument_list|(
name|line
argument_list|,
literal|1023
argument_list|,
name|f
argument_list|)
condition|)
break|break;
name|i
operator|=
name|s
operator|.
name|com
operator|.
name|numtexture
expr_stmt|;
name|t
operator|=
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|i
index|]
expr_stmt|;
name|setdefaults
argument_list|(
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|line
argument_list|,
name|fmt_str
argument_list|,
operator|&
name|t
operator|->
name|majtype
argument_list|,
operator|&
name|t
operator|->
name|type
argument_list|,
name|end
argument_list|)
operator|!=
literal|3
condition|)
name|t
operator|->
name|color1
operator|.
name|x
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|color1
operator|.
name|y
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|color1
operator|.
name|z
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|color1
operator|.
name|w
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|color2
operator|.
name|x
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|color2
operator|.
name|y
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|color2
operator|.
name|z
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|color2
operator|.
name|w
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|oscale
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|turbulence
operator|.
name|x
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|amount
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|exp
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|scale
operator|.
name|x
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|scale
operator|.
name|y
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|scale
operator|.
name|z
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|rotate
operator|.
name|x
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|rotate
operator|.
name|y
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|rotate
operator|.
name|z
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|translate
operator|.
name|x
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|translate
operator|.
name|y
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
name|errno
operator|!=
name|ERANGE
condition|)
name|t
operator|->
name|translate
operator|.
name|z
operator|=
name|g_ascii_strtod
argument_list|(
name|end
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
name|s
operator|.
name|com
operator|.
name|numtexture
operator|++
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|loadpreset_response (GtkWidget * dialog,gint response_id,gpointer data)
name|loadpreset_response
parameter_list|(
name|GtkWidget
modifier|*
name|dialog
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
name|response_id
operator|==
name|GTK_RESPONSE_OK
condition|)
block|{
name|GtkTreeModel
modifier|*
name|model
init|=
name|gtk_tree_view_get_model
argument_list|(
name|texturelist
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|gtk_file_chooser_get_filename
argument_list|(
name|GTK_FILE_CHOOSER
argument_list|(
name|dialog
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_list_store_clear
argument_list|(
name|GTK_LIST_STORE
argument_list|(
name|model
argument_list|)
argument_list|)
expr_stmt|;
name|loadit
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|rebuildlist
argument_list|()
expr_stmt|;
block|}
name|gtk_widget_hide
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|saveit (const gchar * fn)
name|saveit
parameter_list|(
specifier|const
name|gchar
modifier|*
name|fn
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|gchar
name|buf
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|f
operator|=
name|g_fopen
argument_list|(
name|fn
argument_list|,
literal|"wt"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Could not open '%s' for writing: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|fn
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|.
name|com
operator|.
name|numtexture
condition|;
name|i
operator|++
control|)
block|{
name|texture
modifier|*
name|t
init|=
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|t
operator|->
name|majtype
operator|<
literal|0
condition|)
continue|continue;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%d %d"
argument_list|,
name|t
operator|->
name|majtype
argument_list|,
name|t
operator|->
name|type
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|color1
operator|.
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|color1
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|color1
operator|.
name|z
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|color1
operator|.
name|w
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|color2
operator|.
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|color2
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|color2
operator|.
name|z
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|color2
operator|.
name|w
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|oscale
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|turbulence
operator|.
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|amount
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|exp
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|scale
operator|.
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|scale
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|scale
operator|.
name|z
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|rotate
operator|.
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|rotate
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|rotate
operator|.
name|z
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|translate
operator|.
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|translate
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" %s"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|t
operator|->
name|translate
operator|.
name|z
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|savepreset_response (GtkWidget * dialog,gint response_id,gpointer data)
name|savepreset_response
parameter_list|(
name|GtkWidget
modifier|*
name|dialog
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
name|response_id
operator|==
name|GTK_RESPONSE_OK
condition|)
block|{
name|gchar
modifier|*
name|name
init|=
name|gtk_file_chooser_get_filename
argument_list|(
name|GTK_FILE_CHOOSER
argument_list|(
name|dialog
argument_list|)
argument_list|)
decl_stmt|;
name|saveit
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_hide
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|loadpreset (GtkWidget * widget,GtkWidget * parent)
name|loadpreset
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GtkWidget
modifier|*
name|parent
parameter_list|)
block|{
name|fileselect
argument_list|(
name|GTK_FILE_CHOOSER_ACTION_OPEN
argument_list|,
name|parent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|savepreset (GtkWidget * widget,GtkWidget * parent)
name|savepreset
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GtkWidget
modifier|*
name|parent
parameter_list|)
block|{
name|fileselect
argument_list|(
name|GTK_FILE_CHOOSER_ACTION_SAVE
argument_list|,
name|parent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|fileselect (GtkFileChooserAction action,GtkWidget * parent)
name|fileselect
parameter_list|(
name|GtkFileChooserAction
name|action
parameter_list|,
name|GtkWidget
modifier|*
name|parent
parameter_list|)
block|{
specifier|static
name|GtkWidget
modifier|*
name|windows
index|[
literal|2
index|]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
name|gchar
modifier|*
name|titles
index|[]
init|=
block|{
name|N_
argument_list|(
literal|"Open File"
argument_list|)
block|,
name|N_
argument_list|(
literal|"Save File"
argument_list|)
block|}
decl_stmt|;
name|void
modifier|*
name|handlers
index|[]
init|=
block|{
name|loadpreset_response
block|,
name|savepreset_response
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|windows
index|[
name|action
index|]
condition|)
block|{
name|GtkWidget
modifier|*
name|dialog
init|=
name|windows
index|[
name|action
index|]
operator|=
name|gtk_file_chooser_dialog_new
argument_list|(
name|gettext
argument_list|(
name|titles
index|[
name|action
index|]
argument_list|)
argument_list|,
name|GTK_WINDOW
argument_list|(
name|parent
argument_list|)
argument_list|,
name|action
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|action
operator|==
name|GTK_FILE_CHOOSER_ACTION_OPEN
condition|?
name|GTK_STOCK_OPEN
else|:
name|GTK_STOCK_SAVE
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_dialog_set_default_response
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|GTK_FILE_CHOOSER_ACTION_SAVE
condition|)
name|gtk_file_chooser_set_do_overwrite_confirmation
argument_list|(
name|GTK_FILE_CHOOSER
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dialog
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_widget_destroyed
argument_list|)
argument_list|,
operator|&
name|windows
index|[
name|action
index|]
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dialog
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|handlers
index|[
name|action
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|gtk_window_present
argument_list|(
name|GTK_WINDOW
argument_list|(
name|windows
index|[
name|action
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|initworld (void)
name|initworld
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|memset
argument_list|(
operator|&
name|world
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|world
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|.
name|com
operator|.
name|type
operator|=
name|SPHERE
expr_stmt|;
name|s
operator|.
name|a
operator|.
name|x
operator|=
name|s
operator|.
name|a
operator|.
name|y
operator|=
name|s
operator|.
name|a
operator|.
name|z
operator|=
literal|0.0
expr_stmt|;
name|s
operator|.
name|r
operator|=
literal|4.0
expr_stmt|;
comment|/* not: world.obj[0] = s;    * s is a sphere so error C2115: '=' : incompatible types    */
name|memcpy
argument_list|(
operator|&
name|world
operator|.
name|obj
index|[
literal|0
index|]
argument_list|,
operator|&
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|world
operator|.
name|numobj
operator|=
literal|1
expr_stmt|;
name|world
operator|.
name|obj
index|[
literal|0
index|]
operator|.
name|com
operator|.
name|numtexture
operator|=
literal|0
expr_stmt|;
name|world
operator|.
name|obj
index|[
literal|0
index|]
operator|.
name|com
operator|.
name|numnormal
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|.
name|com
operator|.
name|numtexture
condition|;
name|i
operator|++
control|)
block|{
name|common
modifier|*
name|c
init|=
operator|&
name|s
operator|.
name|com
decl_stmt|;
name|common
modifier|*
name|d
init|=
operator|&
name|world
operator|.
name|obj
index|[
literal|0
index|]
operator|.
name|com
decl_stmt|;
name|texture
modifier|*
name|t
init|=
operator|&
name|c
operator|->
name|texture
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|t
operator|->
name|amount
operator|<=
literal|0.0
operator|)
operator|||
operator|(
name|t
operator|->
name|majtype
operator|<
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
name|t
operator|->
name|majtype
operator|==
literal|0
condition|)
block|{
comment|/* Normal texture */
if|if
condition|(
name|t
operator|->
name|type
operator|==
name|PHONG
condition|)
block|{
name|t
operator|->
name|phongcolor
operator|=
name|t
operator|->
name|color1
expr_stmt|;
name|t
operator|->
name|phongsize
operator|=
name|t
operator|->
name|oscale
operator|/
literal|25.0
expr_stmt|;
block|}
name|d
operator|->
name|texture
index|[
name|d
operator|->
name|numtexture
index|]
operator|=
operator|*
name|t
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|d
operator|->
name|texture
index|[
name|d
operator|->
name|numtexture
index|]
operator|.
name|scale
argument_list|,
name|d
operator|->
name|texture
index|[
name|d
operator|->
name|numtexture
index|]
operator|.
name|oscale
argument_list|)
expr_stmt|;
name|d
operator|->
name|numtexture
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|t
operator|->
name|majtype
operator|==
literal|1
condition|)
block|{
comment|/* Bumpmap */
name|d
operator|->
name|normal
index|[
name|d
operator|->
name|numnormal
index|]
operator|=
operator|*
name|t
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|d
operator|->
name|normal
index|[
name|d
operator|->
name|numnormal
index|]
operator|.
name|scale
argument_list|,
name|d
operator|->
name|texture
index|[
name|d
operator|->
name|numnormal
index|]
operator|.
name|oscale
argument_list|)
expr_stmt|;
name|d
operator|->
name|numnormal
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|t
operator|->
name|majtype
operator|==
literal|2
condition|)
block|{
comment|/* Lightsource */
name|light
name|l
decl_stmt|;
name|vcopy
argument_list|(
operator|&
name|l
operator|.
name|a
argument_list|,
operator|&
name|t
operator|->
name|translate
argument_list|)
expr_stmt|;
name|vcopy
argument_list|(
operator|&
name|l
operator|.
name|color
argument_list|,
operator|&
name|t
operator|->
name|color1
argument_list|)
expr_stmt|;
name|vmul
argument_list|(
operator|&
name|l
operator|.
name|color
argument_list|,
name|t
operator|->
name|amount
argument_list|)
expr_stmt|;
name|world
operator|.
name|light
index|[
name|world
operator|.
name|numlight
index|]
operator|=
name|l
expr_stmt|;
name|world
operator|.
name|numlight
operator|++
expr_stmt|;
block|}
block|}
name|world
operator|.
name|quality
operator|=
literal|5
expr_stmt|;
name|world
operator|.
name|flags
operator||=
name|SMARTAMBIENT
expr_stmt|;
name|world
operator|.
name|smartambient
operator|=
literal|40.0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|expose_event (GtkWidget * widget,GdkEventExpose * event)
name|expose_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEventExpose
modifier|*
name|event
parameter_list|)
block|{
name|cairo_t
modifier|*
name|cr
decl_stmt|;
name|cr
operator|=
name|gdk_cairo_create
argument_list|(
name|gtk_widget_get_window
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gdk_cairo_region
argument_list|(
name|cr
argument_list|,
name|event
operator|->
name|region
argument_list|)
expr_stmt|;
name|cairo_clip
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_set_source_surface
argument_list|(
name|cr
argument_list|,
name|buffer
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|cairo_paint
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|cairo_destroy
argument_list|(
name|cr
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|restartrender (void)
name|restartrender
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|idle_id
condition|)
name|g_source_remove
argument_list|(
name|idle_id
argument_list|)
expr_stmt|;
name|idle_id
operator|=
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|render
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|selecttexture (GtkWidget * widget,gpointer data)
name|selecttexture
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|texture
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|noupdate
condition|)
return|return;
name|t
operator|=
name|currenttexture
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|t
condition|)
return|return;
name|gimp_int_combo_box_get_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|,
operator|&
name|t
operator|->
name|type
argument_list|)
expr_stmt|;
name|relabel
argument_list|()
expr_stmt|;
name|restartrender
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|selecttype (GtkWidget * widget,gpointer data)
name|selecttype
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|texture
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|noupdate
condition|)
return|return;
name|t
operator|=
name|currenttexture
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|t
condition|)
return|return;
name|gimp_int_combo_box_get_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|,
operator|&
name|t
operator|->
name|majtype
argument_list|)
expr_stmt|;
name|relabel
argument_list|()
expr_stmt|;
name|restartrender
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|getscales (GtkWidget * widget,gpointer data)
name|getscales
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gdouble
name|f
decl_stmt|;
name|texture
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|noupdate
condition|)
return|return;
name|t
operator|=
name|currenttexture
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|t
condition|)
return|return;
name|t
operator|->
name|amount
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|amountscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|exp
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|expscale
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|turbulencescale
argument_list|)
argument_list|)
expr_stmt|;
name|vset
argument_list|(
operator|&
name|t
operator|->
name|turbulence
argument_list|,
name|f
argument_list|,
name|f
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|t
operator|->
name|oscale
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scalescale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|scale
operator|.
name|x
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scalexscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|scale
operator|.
name|y
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scaleyscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|scale
operator|.
name|z
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scalezscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|rotate
operator|.
name|x
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|rotxscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|rotate
operator|.
name|y
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|rotyscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|rotate
operator|.
name|z
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|rotzscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|translate
operator|.
name|x
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|posxscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|translate
operator|.
name|y
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|posyscale
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|->
name|translate
operator|.
name|z
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|poszscale
argument_list|)
argument_list|)
expr_stmt|;
name|restartrender
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|color1_changed (GimpColorButton * button)
name|color1_changed
parameter_list|(
name|GimpColorButton
modifier|*
name|button
parameter_list|)
block|{
name|texture
modifier|*
name|t
init|=
name|currenttexture
argument_list|()
decl_stmt|;
if|if
condition|(
name|t
condition|)
block|{
name|GimpRGB
name|color
decl_stmt|;
name|gimp_color_button_get_color
argument_list|(
name|button
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|t
operator|->
name|color1
operator|.
name|x
operator|=
name|color
operator|.
name|r
expr_stmt|;
name|t
operator|->
name|color1
operator|.
name|y
operator|=
name|color
operator|.
name|g
expr_stmt|;
name|t
operator|->
name|color1
operator|.
name|z
operator|=
name|color
operator|.
name|b
expr_stmt|;
name|t
operator|->
name|color1
operator|.
name|w
operator|=
name|color
operator|.
name|a
expr_stmt|;
name|restartrender
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|color2_changed (GimpColorButton * button)
name|color2_changed
parameter_list|(
name|GimpColorButton
modifier|*
name|button
parameter_list|)
block|{
name|texture
modifier|*
name|t
init|=
name|currenttexture
argument_list|()
decl_stmt|;
if|if
condition|(
name|t
condition|)
block|{
name|GimpRGB
name|color
decl_stmt|;
name|gimp_color_button_get_color
argument_list|(
name|button
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|t
operator|->
name|color2
operator|.
name|x
operator|=
name|color
operator|.
name|r
expr_stmt|;
name|t
operator|->
name|color2
operator|.
name|y
operator|=
name|color
operator|.
name|g
expr_stmt|;
name|t
operator|->
name|color2
operator|.
name|z
operator|=
name|color
operator|.
name|b
expr_stmt|;
name|t
operator|->
name|color2
operator|.
name|w
operator|=
name|color
operator|.
name|a
expr_stmt|;
name|restartrender
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|drawcolor1 (GtkWidget * w)
name|drawcolor1
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|)
block|{
specifier|static
name|GtkWidget
modifier|*
name|lastw
init|=
name|NULL
decl_stmt|;
name|GimpRGB
name|color
decl_stmt|;
name|texture
modifier|*
name|t
init|=
name|currenttexture
argument_list|()
decl_stmt|;
if|if
condition|(
name|w
condition|)
name|lastw
operator|=
name|w
expr_stmt|;
else|else
name|w
operator|=
name|lastw
expr_stmt|;
if|if
condition|(
operator|!
name|w
condition|)
return|return;
if|if
condition|(
operator|!
name|t
condition|)
return|return;
name|gimp_rgba_set
argument_list|(
operator|&
name|color
argument_list|,
name|t
operator|->
name|color1
operator|.
name|x
argument_list|,
name|t
operator|->
name|color1
operator|.
name|y
argument_list|,
name|t
operator|->
name|color1
operator|.
name|z
argument_list|,
name|t
operator|->
name|color1
operator|.
name|w
argument_list|)
expr_stmt|;
name|gimp_color_button_set_color
argument_list|(
name|GIMP_COLOR_BUTTON
argument_list|(
name|w
argument_list|)
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|drawcolor2 (GtkWidget * w)
name|drawcolor2
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|)
block|{
specifier|static
name|GtkWidget
modifier|*
name|lastw
init|=
name|NULL
decl_stmt|;
name|GimpRGB
name|color
decl_stmt|;
name|texture
modifier|*
name|t
init|=
name|currenttexture
argument_list|()
decl_stmt|;
if|if
condition|(
name|w
condition|)
name|lastw
operator|=
name|w
expr_stmt|;
else|else
name|w
operator|=
name|lastw
expr_stmt|;
if|if
condition|(
operator|!
name|w
condition|)
return|return;
if|if
condition|(
operator|!
name|t
condition|)
return|return;
name|gimp_rgba_set
argument_list|(
operator|&
name|color
argument_list|,
name|t
operator|->
name|color2
operator|.
name|x
argument_list|,
name|t
operator|->
name|color2
operator|.
name|y
argument_list|,
name|t
operator|->
name|color2
operator|.
name|z
argument_list|,
name|t
operator|->
name|color2
operator|.
name|w
argument_list|)
expr_stmt|;
name|gimp_color_button_set_color
argument_list|(
name|GIMP_COLOR_BUTTON
argument_list|(
name|w
argument_list|)
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
DECL|variable|do_run
specifier|static
name|gboolean
name|do_run
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|sphere_response (GtkWidget * widget,gint response_id,gpointer data)
name|sphere_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
switch|switch
condition|(
name|response_id
condition|)
block|{
case|case
name|RESPONSE_RESET
case|:
name|s
operator|.
name|com
operator|.
name|numtexture
operator|=
literal|3
expr_stmt|;
name|setdefaults
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|setdefaults
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|setdefaults
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|1
index|]
operator|.
name|majtype
operator|=
literal|2
expr_stmt|;
name|vset
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|1
index|]
operator|.
name|color1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vset
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|1
index|]
operator|.
name|translate
argument_list|,
operator|-
literal|15
argument_list|,
operator|-
literal|15
argument_list|,
operator|-
literal|15
argument_list|)
expr_stmt|;
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|2
index|]
operator|.
name|majtype
operator|=
literal|2
expr_stmt|;
name|vset
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|2
index|]
operator|.
name|color1
argument_list|,
literal|0
argument_list|,
literal|0.4
argument_list|,
literal|0.4
argument_list|)
expr_stmt|;
name|vset
argument_list|(
operator|&
name|s
operator|.
name|com
operator|.
name|texture
index|[
literal|2
index|]
operator|.
name|translate
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|,
operator|-
literal|15
argument_list|)
expr_stmt|;
name|gtk_list_store_clear
argument_list|(
name|GTK_LIST_STORE
argument_list|(
name|gtk_tree_view_get_model
argument_list|(
name|texturelist
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|rebuildlist
argument_list|()
expr_stmt|;
break|break;
case|case
name|GTK_RESPONSE_OK
case|:
if|if
condition|(
name|idle_id
condition|)
block|{
name|g_source_remove
argument_list|(
name|idle_id
argument_list|)
expr_stmt|;
name|idle_id
operator|=
literal|0
expr_stmt|;
block|}
name|do_run
operator|=
name|TRUE
expr_stmt|;
default|default:
name|gtk_widget_hide
argument_list|(
name|widget
argument_list|)
expr_stmt|;
name|gtk_main_quit
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|GtkWidget
modifier|*
DECL|function|makewindow (void)
name|makewindow
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkListStore
modifier|*
name|store
decl_stmt|;
name|GtkTreeViewColumn
modifier|*
name|col
decl_stmt|;
name|GtkTreeSelection
modifier|*
name|selection
decl_stmt|;
name|GtkWidget
modifier|*
name|window
decl_stmt|;
name|GtkWidget
modifier|*
name|main_hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|main_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|scrolled
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|list
decl_stmt|;
name|GimpRGB
name|rgb
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|window
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Sphere Designer"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PLUG_IN_PROC
argument_list|,
name|GIMP_STOCK_RESET
argument_list|,
name|RESPONSE_RESET
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|GTK_STOCK_OK
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|window
argument_list|)
argument_list|,
name|RESPONSE_RESET
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gimp_window_set_transient
argument_list|(
name|GTK_WINDOW
argument_list|(
name|window
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|window
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|sphere_response
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|main_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|window
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|main_vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|main_vbox
argument_list|)
expr_stmt|;
name|main_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|main_hbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|main_hbox
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_hbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|drawarea
operator|=
name|gtk_drawing_area_new
argument_list|()
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|drawarea
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|drawarea
argument_list|,
name|PREVIEWSIZE
argument_list|,
name|PREVIEWSIZE
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|drawarea
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|drawarea
argument_list|,
literal|"expose-event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|expose_event
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_end
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_from_stock
argument_list|(
name|GTK_STOCK_OPEN
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|loadpreset
argument_list|)
argument_list|,
name|window
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_from_stock
argument_list|(
name|GTK_STOCK_SAVE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|savepreset
argument_list|)
argument_list|,
name|window
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_end
argument_list|(
name|GTK_BOX
argument_list|(
name|main_hbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|scrolled
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_shadow_type
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled
argument_list|)
argument_list|,
name|GTK_POLICY_NEVER
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|scrolled
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|scrolled
argument_list|)
expr_stmt|;
name|store
operator|=
name|gtk_list_store_new
argument_list|(
name|NUM_COLUMNS
argument_list|,
name|G_TYPE_STRING
argument_list|,
name|G_TYPE_POINTER
argument_list|)
expr_stmt|;
name|list
operator|=
name|gtk_tree_view_new_with_model
argument_list|(
name|GTK_TREE_MODEL
argument_list|(
name|store
argument_list|)
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|store
argument_list|)
expr_stmt|;
name|texturelist
operator|=
name|GTK_TREE_VIEW
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|selection
operator|=
name|gtk_tree_view_get_selection
argument_list|(
name|texturelist
argument_list|)
expr_stmt|;
name|gtk_tree_selection_set_mode
argument_list|(
name|selection
argument_list|,
name|GTK_SELECTION_BROWSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|selection
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|selectitem
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|list
argument_list|,
operator|-
literal|1
argument_list|,
literal|150
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|scrolled
argument_list|)
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|col
operator|=
name|gtk_tree_view_column_new_with_attributes
argument_list|(
name|_
argument_list|(
literal|"Layers"
argument_list|)
argument_list|,
name|gtk_cell_renderer_text_new
argument_list|()
argument_list|,
literal|"text"
argument_list|,
name|TYPE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_tree_view_append_column
argument_list|(
name|texturelist
argument_list|,
name|col
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_from_stock
argument_list|(
name|GTK_STOCK_NEW
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|addtexture
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_from_stock
argument_list|(
name|GIMP_STOCK_DUPLICATE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|duptexture
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_from_stock
argument_list|(
name|GTK_STOCK_DELETE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|deltexture
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|main_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|main_hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|main_hbox
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Properties"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|7
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|typemenu
operator|=
name|gimp_int_combo_box_new
argument_list|(
name|_
argument_list|(
literal|"Texture"
argument_list|)
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Bump"
argument_list|)
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Light"
argument_list|)
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_int_combo_box_connect
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|typemenu
argument_list|)
argument_list|,
literal|0
argument_list|,
name|G_CALLBACK
argument_list|(
name|selecttype
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Type:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|typemenu
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|texturemenu
operator|=
name|g_object_new
argument_list|(
name|GIMP_TYPE_INT_COMBO_BOX
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|{
name|struct
name|textures_t
modifier|*
name|t
decl_stmt|;
for|for
control|(
name|t
operator|=
name|textures
init|;
name|t
operator|->
name|s
condition|;
name|t
operator|++
control|)
name|gimp_int_combo_box_append
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|texturemenu
argument_list|)
argument_list|,
name|GIMP_INT_STORE_VALUE
argument_list|,
name|t
operator|->
name|n
argument_list|,
name|GIMP_INT_STORE_LABEL
argument_list|,
name|gettext
argument_list|(
name|t
operator|->
name|s
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|gimp_int_combo_box_connect
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|texturemenu
argument_list|)
argument_list|,
literal|0
argument_list|,
name|G_CALLBACK
argument_list|(
name|selecttexture
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Texture:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|texturemenu
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|_
argument_list|(
literal|"Colors:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|hbox
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|button
operator|=
name|gimp_color_button_new
argument_list|(
name|_
argument_list|(
literal|"Color Selection Dialog"
argument_list|)
argument_list|,
name|COLORBUTTONWIDTH
argument_list|,
name|COLORBUTTONHEIGHT
argument_list|,
operator|&
name|rgb
argument_list|,
name|GIMP_COLOR_AREA_FLAT
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|drawcolor1
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"color-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|color1_changed
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|button
operator|=
name|gimp_color_button_new
argument_list|(
name|_
argument_list|(
literal|"Color Selection Dialog"
argument_list|)
argument_list|,
name|COLORBUTTONWIDTH
argument_list|,
name|COLORBUTTONHEIGHT
argument_list|,
operator|&
name|rgb
argument_list|,
name|GIMP_COLOR_AREA_FLAT
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|drawcolor2
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"color-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|color2_changed
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|scalescale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|_
argument_list|(
literal|"Scale:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|,
literal|10.0
argument_list|,
literal|0.1
argument_list|,
literal|1.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scalescale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|turbulencescale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
name|_
argument_list|(
literal|"Turbulence:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|,
literal|10.0
argument_list|,
literal|0.1
argument_list|,
literal|1.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|turbulencescale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|amountscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
name|_
argument_list|(
literal|"Amount:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|amountscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|expscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|,
name|_
argument_list|(
literal|"Exp.:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|expscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Transformations"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|9
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|5
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|scalexscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Scale X:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|,
literal|10.0
argument_list|,
literal|0.1
argument_list|,
literal|1.0
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scalexscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|scaleyscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Scale Y:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|,
literal|10.0
argument_list|,
literal|0.1
argument_list|,
literal|1.0
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scaleyscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|scalezscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|_
argument_list|(
literal|"Scale Z:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|,
literal|10.0
argument_list|,
literal|0.1
argument_list|,
literal|1.0
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scalezscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rotxscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|_
argument_list|(
literal|"Rotate X:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|360.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|rotxscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rotyscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
name|_
argument_list|(
literal|"Rotate Y:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|360.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|rotyscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rotzscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
name|_
argument_list|(
literal|"Rotate Z:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|360.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|rotzscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|posxscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|,
name|_
argument_list|(
literal|"Position X:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|0.0
argument_list|,
operator|-
literal|20.0
argument_list|,
literal|20.0
argument_list|,
literal|0.1
argument_list|,
literal|1.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|posxscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|posyscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|,
name|_
argument_list|(
literal|"Position Y:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|0.0
argument_list|,
operator|-
literal|20.0
argument_list|,
literal|20.0
argument_list|,
literal|0.1
argument_list|,
literal|1.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|posyscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|poszscale
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
name|_
argument_list|(
literal|"Position Z:"
argument_list|)
argument_list|,
literal|100
argument_list|,
operator|-
literal|1
argument_list|,
literal|0.0
argument_list|,
operator|-
literal|20.0
argument_list|,
literal|20.0
argument_list|,
literal|0.1
argument_list|,
literal|1.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|poszscale
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|getscales
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|window
argument_list|)
expr_stmt|;
return|return
name|window
return|;
block|}
end_function

begin_function
specifier|static
name|guchar
DECL|function|pixelval (gdouble v)
name|pixelval
parameter_list|(
name|gdouble
name|v
parameter_list|)
block|{
name|v
operator|+=
literal|0.5
expr_stmt|;
if|if
condition|(
name|v
operator|<
literal|0.0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|v
operator|>
literal|255.0
condition|)
return|return
literal|255
return|;
return|return
name|v
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|render (void)
name|render
parameter_list|(
name|void
parameter_list|)
block|{
name|GimpVector4
name|col
decl_stmt|;
name|guchar
modifier|*
name|dest_row
decl_stmt|;
name|ray
name|r
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|p
decl_stmt|;
name|gint
name|hit
decl_stmt|;
name|gint
name|tx
init|=
name|PREVIEWSIZE
decl_stmt|;
name|gint
name|ty
init|=
name|PREVIEWSIZE
decl_stmt|;
name|gint
name|bpp
init|=
literal|4
decl_stmt|;
name|idle_id
operator|=
literal|0
expr_stmt|;
name|initworld
argument_list|()
expr_stmt|;
name|r
operator|.
name|v1
operator|.
name|z
operator|=
operator|-
literal|10.0
expr_stmt|;
name|r
operator|.
name|v2
operator|.
name|z
operator|=
literal|0.0
expr_stmt|;
if|if
condition|(
name|world
operator|.
name|obj
index|[
literal|0
index|]
operator|.
name|com
operator|.
name|numtexture
operator|>
literal|0
condition|)
block|{
name|cairo_surface_flush
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|ty
condition|;
name|y
operator|++
control|)
block|{
name|dest_row
operator|=
name|img
operator|+
name|y
operator|*
name|img_stride
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|tx
condition|;
name|x
operator|++
control|)
block|{
name|gint
name|g
decl_stmt|,
name|gridsize
init|=
literal|16
decl_stmt|;
name|g
operator|=
operator|(
operator|(
name|x
operator|/
name|gridsize
operator|+
name|y
operator|/
name|gridsize
operator|)
operator|%
literal|2
operator|)
operator|*
literal|60
operator|+
literal|100
expr_stmt|;
name|r
operator|.
name|v1
operator|.
name|x
operator|=
name|r
operator|.
name|v2
operator|.
name|x
operator|=
literal|8.5
operator|*
operator|(
name|x
operator|/
call|(
name|float
call|)
argument_list|(
name|tx
operator|-
literal|1
argument_list|)
operator|-
literal|0.5
operator|)
expr_stmt|;
name|r
operator|.
name|v1
operator|.
name|y
operator|=
name|r
operator|.
name|v2
operator|.
name|y
operator|=
literal|8.5
operator|*
operator|(
name|y
operator|/
call|(
name|float
call|)
argument_list|(
name|ty
operator|-
literal|1
argument_list|)
operator|-
literal|0.5
operator|)
expr_stmt|;
name|p
operator|=
name|x
operator|*
name|bpp
expr_stmt|;
name|hit
operator|=
name|traceray
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|col
argument_list|,
literal|10
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|col
operator|.
name|w
operator|<
literal|0.0
condition|)
name|col
operator|.
name|w
operator|=
literal|0.0
expr_stmt|;
elseif|else
if|if
condition|(
name|col
operator|.
name|w
operator|>
literal|1.0
condition|)
name|col
operator|.
name|w
operator|=
literal|1.0
expr_stmt|;
name|GIMP_CAIRO_RGB24_SET_PIXEL
argument_list|(
operator|(
name|dest_row
operator|+
name|p
operator|)
argument_list|,
name|pixelval
argument_list|(
literal|255
operator|*
name|col
operator|.
name|x
argument_list|)
operator|*
name|col
operator|.
name|w
operator|+
name|g
operator|*
operator|(
literal|1.0
operator|-
name|col
operator|.
name|w
operator|)
argument_list|,
name|pixelval
argument_list|(
literal|255
operator|*
name|col
operator|.
name|y
argument_list|)
operator|*
name|col
operator|.
name|w
operator|+
name|g
operator|*
operator|(
literal|1.0
operator|-
name|col
operator|.
name|w
operator|)
argument_list|,
name|pixelval
argument_list|(
literal|255
operator|*
name|col
operator|.
name|z
argument_list|)
operator|*
name|col
operator|.
name|w
operator|+
name|g
operator|*
operator|(
literal|1.0
operator|-
name|col
operator|.
name|w
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|cairo_surface_mark_dirty
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_queue_draw
argument_list|(
name|drawarea
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|realrender (GimpDrawable * drawable)
name|realrender
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|ray
name|r
decl_stmt|;
name|GimpVector4
name|rcol
decl_stmt|;
name|gint
name|tx
decl_stmt|,
name|ty
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|guchar
modifier|*
name|dest
decl_stmt|;
name|gint
name|bpp
decl_stmt|;
name|GimpPixelRgn
name|pr
decl_stmt|,
name|dpr
decl_stmt|;
name|guchar
modifier|*
name|buffer
decl_stmt|,
modifier|*
name|ibuffer
decl_stmt|;
name|initworld
argument_list|()
expr_stmt|;
name|r
operator|.
name|v1
operator|.
name|z
operator|=
operator|-
literal|10.0
expr_stmt|;
name|r
operator|.
name|v2
operator|.
name|z
operator|=
literal|0.0
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|pr
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gimp_drawable_width
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
argument_list|,
name|gimp_drawable_height
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|dpr
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|gimp_drawable_width
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
argument_list|,
name|gimp_drawable_height
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_mask_bounds
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|)
expr_stmt|;
name|bpp
operator|=
name|gimp_drawable_bpp
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|g_malloc
argument_list|(
operator|(
name|x2
operator|-
name|x1
operator|)
operator|*
literal|4
argument_list|)
expr_stmt|;
name|ibuffer
operator|=
name|g_malloc
argument_list|(
operator|(
name|x2
operator|-
name|x1
operator|)
operator|*
literal|4
argument_list|)
expr_stmt|;
name|tx
operator|=
name|x2
operator|-
name|x1
expr_stmt|;
name|ty
operator|=
name|y2
operator|-
name|y1
expr_stmt|;
name|gimp_progress_init
argument_list|(
name|_
argument_list|(
literal|"Rendering sphere"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|ty
condition|;
name|y
operator|++
control|)
block|{
name|dest
operator|=
name|buffer
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|tx
condition|;
name|x
operator|++
control|)
block|{
name|r
operator|.
name|v1
operator|.
name|x
operator|=
name|r
operator|.
name|v2
operator|.
name|x
operator|=
literal|8.1
operator|*
operator|(
name|x
operator|/
call|(
name|float
call|)
argument_list|(
name|tx
operator|-
literal|1
argument_list|)
operator|-
literal|0.5
operator|)
expr_stmt|;
name|r
operator|.
name|v1
operator|.
name|y
operator|=
name|r
operator|.
name|v2
operator|.
name|y
operator|=
literal|8.1
operator|*
operator|(
name|y
operator|/
call|(
name|float
call|)
argument_list|(
name|ty
operator|-
literal|1
argument_list|)
operator|-
literal|0.5
operator|)
expr_stmt|;
name|traceray
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|rcol
argument_list|,
literal|10
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|dest
index|[
literal|0
index|]
operator|=
name|pixelval
argument_list|(
literal|255
operator|*
name|rcol
operator|.
name|x
argument_list|)
expr_stmt|;
name|dest
index|[
literal|1
index|]
operator|=
name|pixelval
argument_list|(
literal|255
operator|*
name|rcol
operator|.
name|y
argument_list|)
expr_stmt|;
name|dest
index|[
literal|2
index|]
operator|=
name|pixelval
argument_list|(
literal|255
operator|*
name|rcol
operator|.
name|z
argument_list|)
expr_stmt|;
name|dest
index|[
literal|3
index|]
operator|=
name|pixelval
argument_list|(
literal|255
operator|*
name|rcol
operator|.
name|w
argument_list|)
expr_stmt|;
name|dest
operator|+=
literal|4
expr_stmt|;
block|}
name|gimp_pixel_rgn_get_row
argument_list|(
operator|&
name|pr
argument_list|,
name|ibuffer
argument_list|,
name|x1
argument_list|,
name|y1
operator|+
name|y
argument_list|,
name|x2
operator|-
name|x1
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
operator|(
name|x2
operator|-
name|x1
operator|)
condition|;
name|x
operator|++
control|)
block|{
name|gint
name|k
decl_stmt|,
name|dx
init|=
name|x
operator|*
literal|4
decl_stmt|,
name|sx
init|=
name|x
operator|*
name|bpp
decl_stmt|;
name|gfloat
name|a
init|=
name|buffer
index|[
name|dx
operator|+
literal|3
index|]
operator|/
literal|255.0
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|bpp
condition|;
name|k
operator|++
control|)
block|{
name|ibuffer
index|[
name|sx
operator|+
name|k
index|]
operator|=
name|buffer
index|[
name|dx
operator|+
name|k
index|]
operator|*
name|a
operator|+
name|ibuffer
index|[
name|sx
operator|+
name|k
index|]
operator|*
operator|(
literal|1.0
operator|-
name|a
operator|)
expr_stmt|;
block|}
block|}
name|gimp_pixel_rgn_set_row
argument_list|(
operator|&
name|dpr
argument_list|,
name|ibuffer
argument_list|,
name|x1
argument_list|,
name|y1
operator|+
name|y
argument_list|,
name|x2
operator|-
name|x1
argument_list|)
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|gdouble
operator|)
name|y
operator|/
operator|(
name|gdouble
operator|)
name|ty
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|ibuffer
argument_list|)
expr_stmt|;
name|gimp_drawable_flush
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_merge_shadow
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_update
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
operator|-
name|x1
argument_list|,
name|y2
operator|-
name|y1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|query (void)
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
specifier|const
name|GimpParamDef
name|args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run-mode"
block|,
literal|"The run mode { RUN-INTERACTIVE (0), RUN-NONINTERACTIVE (1) }"
block|}
block|,
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Input image (unused)"
block|}
block|,
block|{
name|GIMP_PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Input drawable"
block|}
block|}
decl_stmt|;
name|gimp_install_procedure
argument_list|(
name|PLUG_IN_PROC
argument_list|,
name|N_
argument_list|(
literal|"Create an image of a textured sphere"
argument_list|)
argument_list|,
literal|"This plugin can be used to create textured and/or "
literal|"bumpmapped spheres, and uses a small lightweight "
literal|"raytracer to perform the task with good quality"
argument_list|,
literal|"Vidar Madsen"
argument_list|,
literal|"Vidar Madsen"
argument_list|,
literal|"1999"
argument_list|,
name|N_
argument_list|(
literal|"Sphere _Designer..."
argument_list|)
argument_list|,
literal|"RGB*, GRAY*"
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|args
argument_list|)
argument_list|,
literal|0
argument_list|,
name|args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_plugin_menu_register
argument_list|(
name|PLUG_IN_PROC
argument_list|,
literal|"<Image>/Filters/Render"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|sphere_main (GimpDrawable * drawable)
name|sphere_main
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
block|{
name|gimp_ui_init
argument_list|(
name|PLUG_IN_BINARY
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|img_stride
operator|=
name|cairo_format_stride_for_width
argument_list|(
name|CAIRO_FORMAT_RGB24
argument_list|,
name|PREVIEWSIZE
argument_list|)
expr_stmt|;
name|img
operator|=
name|g_malloc0
argument_list|(
name|img_stride
operator|*
name|PREVIEWSIZE
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|cairo_image_surface_create_for_data
argument_list|(
name|img
argument_list|,
name|CAIRO_FORMAT_RGB24
argument_list|,
name|PREVIEWSIZE
argument_list|,
name|PREVIEWSIZE
argument_list|,
name|img_stride
argument_list|)
expr_stmt|;
name|makewindow
argument_list|()
expr_stmt|;
if|if
condition|(
name|s
operator|.
name|com
operator|.
name|numtexture
operator|==
literal|0
condition|)
block|{
comment|/* Setup and use default list */
name|sphere_response
argument_list|(
name|NULL
argument_list|,
name|RESPONSE_RESET
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Reuse the list from a previous invocation */
name|rebuildlist
argument_list|()
expr_stmt|;
block|}
name|gtk_main
argument_list|()
expr_stmt|;
name|cairo_surface_destroy
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|img
argument_list|)
expr_stmt|;
return|return
name|do_run
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GimpParam
name|values
index|[
literal|1
index|]
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|GimpRunMode
name|run_mode
decl_stmt|;
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gimp_drawable_mask_intersect
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Region selected for plug-in is empty"
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|GIMP_RUN_INTERACTIVE
case|:
name|s
operator|.
name|com
operator|.
name|numtexture
operator|=
literal|0
expr_stmt|;
name|gimp_get_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sphere_main
argument_list|(
name|drawable
argument_list|)
condition|)
block|{
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|GIMP_RUN_WITH_LAST_VALS
case|:
name|s
operator|.
name|com
operator|.
name|numtexture
operator|=
literal|0
expr_stmt|;
name|gimp_get_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|.
name|com
operator|.
name|numtexture
operator|==
literal|0
condition|)
block|{
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|GIMP_RUN_NONINTERACTIVE
case|:
default|default:
comment|/* Not implementet yet... */
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return;
block|}
name|gimp_set_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|realrender
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_displays_flush
argument_list|()
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|MAIN
argument_list|()
end_macro

end_unit

