begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* IWarp  a plug-in for the GIMP    Version 0.1         IWarp is a gimp plug-in for interactive image warping. To apply the     selected deformation to the image, press the left mouse button and     move the mouse pointer in the preview image.        Copyright (C) 1997 Norbert Schmitz    nobert.schmitz@student.uni-tuebingen.de     Most of the gimp and gtk specific code is taken from other plug-ins      v0.11a     animation of non-alpha layers (background) creates now layers with      alpha channel. (thanks to Adrian Likins for reporting this bug)    v0.12      fixes a very bad bug.       (thanks to Arthur Hagen for reporting it)      */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_warning
warning|#
directive|warning
warning|GTK_DISABLE_DEPRECATED
end_warning

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|GTK_DISABLE_DEPRECATED
end_undef

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_define
DECL|macro|MAX_PREVIEW_WIDTH
define|#
directive|define
name|MAX_PREVIEW_WIDTH
value|256
end_define

begin_define
DECL|macro|MAX_PREVIEW_HEIGHT
define|#
directive|define
name|MAX_PREVIEW_HEIGHT
value|256
end_define

begin_define
DECL|macro|MAX_DEFORM_AREA_RADIUS
define|#
directive|define
name|MAX_DEFORM_AREA_RADIUS
value|100
end_define

begin_define
DECL|macro|SCALE_WIDTH
define|#
directive|define
name|SCALE_WIDTH
value|100
end_define

begin_define
DECL|macro|MAX_NUM_FRAMES
define|#
directive|define
name|MAX_NUM_FRAMES
value|100
end_define

begin_typedef
typedef|typedef
enum|enum
DECL|enum|__anon29aa5a6a0103
block|{
DECL|enumerator|GROW
name|GROW
block|,
DECL|enumerator|SHRINK
name|SHRINK
block|,
DECL|enumerator|MOVE
name|MOVE
block|,
DECL|enumerator|REMOVE
name|REMOVE
block|,
DECL|enumerator|SWIRL_CCW
name|SWIRL_CCW
block|,
DECL|enumerator|SWIRL_CW
name|SWIRL_CW
DECL|typedef|DeformMode
block|}
name|DeformMode
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon29aa5a6a0208
block|{
DECL|member|run
name|gboolean
name|run
decl_stmt|;
DECL|typedef|iwarp_interface
block|}
name|iwarp_interface
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon29aa5a6a0308
block|{
DECL|member|deform_area_radius
name|gint
name|deform_area_radius
decl_stmt|;
DECL|member|deform_amount
name|gdouble
name|deform_amount
decl_stmt|;
DECL|member|deform_mode
name|DeformMode
name|deform_mode
decl_stmt|;
DECL|member|do_bilinear
name|gboolean
name|do_bilinear
decl_stmt|;
DECL|member|do_supersample
name|gboolean
name|do_supersample
decl_stmt|;
DECL|member|supersample_threshold
name|gdouble
name|supersample_threshold
decl_stmt|;
DECL|member|max_supersample_depth
name|gint
name|max_supersample_depth
decl_stmt|;
DECL|typedef|iwarp_vals_t
block|}
name|iwarp_vals_t
typedef|;
end_typedef

begin_comment
comment|/* Declare local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_frame
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|iwarp_dialog
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_animate_dialog
parameter_list|(
name|GtkWidget
modifier|*
name|dlg
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_settings_dialog
parameter_list|(
name|GtkWidget
modifier|*
name|dlg
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_reset_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|iwarp_motion_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_update_preview
parameter_list|(
name|gint
name|x0
parameter_list|,
name|gint
name|y0
parameter_list|,
name|gint
name|x1
parameter_list|,
name|gint
name|y1
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_get_pixel
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_get_deform_vector
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|gdouble
modifier|*
name|xv
parameter_list|,
name|gdouble
modifier|*
name|yv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_get_point
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|guchar
modifier|*
name|color
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|iwarp_supersample_test
parameter_list|(
name|GimpVector2
modifier|*
name|v0
parameter_list|,
name|GimpVector2
modifier|*
name|v1
parameter_list|,
name|GimpVector2
modifier|*
name|v2
parameter_list|,
name|GimpVector2
modifier|*
name|v3
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_getsample
parameter_list|(
name|GimpVector2
name|v0
parameter_list|,
name|GimpVector2
name|v1
parameter_list|,
name|GimpVector2
name|v2
parameter_list|,
name|GimpVector2
name|v3
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|gint
modifier|*
name|sample
parameter_list|,
name|gint
modifier|*
name|cc
parameter_list|,
name|gint
name|depth
parameter_list|,
name|gdouble
name|scale
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_supersample
parameter_list|(
name|gint
name|sxl
parameter_list|,
name|gint
name|syl
parameter_list|,
name|gint
name|sxr
parameter_list|,
name|gint
name|syr
parameter_list|,
name|guchar
modifier|*
name|dest_data
parameter_list|,
name|gint
name|stride
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|guchar
name|iwarp_transparent_color
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_cpy_images
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_preview_get_pixel
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guchar
modifier|*
modifier|*
name|color
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_preview_get_point
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|guchar
modifier|*
name|color
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_deform
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gdouble
name|vx
parameter_list|,
name|gdouble
name|vy
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|iwarp_move
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|xx
parameter_list|,
name|gint
name|yy
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc  */
name|NULL
block|,
comment|/* quit_proc  */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc   */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|wint
specifier|static
name|iwarp_interface
name|wint
init|=
block|{
name|FALSE
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|iwarp_vals
specifier|static
name|iwarp_vals_t
name|iwarp_vals
init|=
block|{
literal|20
block|,
literal|0.3
block|,
name|MOVE
block|,
name|TRUE
block|,
name|FALSE
block|,
literal|2.0
block|,
literal|2
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|drawable
specifier|static
name|GimpDrawable
modifier|*
name|drawable
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|destdrawable
specifier|static
name|GimpDrawable
modifier|*
name|destdrawable
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|preview
specifier|static
name|GtkWidget
modifier|*
name|preview
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|srcimage
specifier|static
name|guchar
modifier|*
name|srcimage
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|dstimage
specifier|static
name|guchar
modifier|*
name|dstimage
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|preview_width
DECL|variable|preview_height
specifier|static
name|gint
name|preview_width
decl_stmt|,
name|preview_height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|sel_width
DECL|variable|sel_height
specifier|static
name|gint
name|sel_width
decl_stmt|,
name|sel_height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|image_bpp
specifier|static
name|gint
name|image_bpp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|preserve_trans
specifier|static
name|gint
name|preserve_trans
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|deform_vectors
specifier|static
name|GimpVector2
modifier|*
name|deform_vectors
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|deform_area_vectors
specifier|static
name|GimpVector2
modifier|*
name|deform_area_vectors
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|lastx
DECL|variable|lasty
specifier|static
name|gint
name|lastx
decl_stmt|,
name|lasty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|filter
specifier|static
name|gdouble
name|filter
index|[
name|MAX_DEFORM_AREA_RADIUS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|do_animate
specifier|static
name|gboolean
name|do_animate
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|do_animate_reverse
specifier|static
name|gboolean
name|do_animate_reverse
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|do_animate_ping_pong
specifier|static
name|gboolean
name|do_animate_ping_pong
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|supersample_threshold_2
specifier|static
name|gdouble
name|supersample_threshold_2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|xl
DECL|variable|yl
DECL|variable|xh
DECL|variable|yh
specifier|static
name|gint
name|xl
decl_stmt|,
name|yl
decl_stmt|,
name|xh
decl_stmt|,
name|yh
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tile_width
DECL|variable|tile_height
specifier|static
name|gint
name|tile_width
decl_stmt|,
name|tile_height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tile
specifier|static
name|GimpTile
modifier|*
name|tile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|pre2img
DECL|variable|img2pre
specifier|static
name|gdouble
name|pre2img
decl_stmt|,
name|img2pre
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|preview_bpp
specifier|static
name|gint
name|preview_bpp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|animate_deform_value
specifier|static
name|gdouble
name|animate_deform_value
init|=
literal|1.0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|imageID
specifier|static
name|gint32
name|imageID
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|animate_num_frames
specifier|static
name|gint
name|animate_num_frames
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|frame_number
specifier|static
name|gint
name|frame_number
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|layer_alpha
specifier|static
name|gint
name|layer_alpha
decl_stmt|;
end_decl_stmt

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|GimpParamDef
name|args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Input image (unused)"
block|}
block|,
block|{
name|GIMP_PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Input drawable"
block|}
block|}
decl_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"plug_in_iwarp"
argument_list|,
literal|"Interactive warping of the specified drawable"
argument_list|,
literal|"Interactive warping of the specified drawable"
argument_list|,
literal|"Norbert Schmitz"
argument_list|,
literal|"Norbert Schmitz"
argument_list|,
literal|"1997"
argument_list|,
name|N_
argument_list|(
literal|"<Image>/Filters/Distorts/_IWarp..."
argument_list|)
argument_list|,
literal|"RGB*, GRAY*"
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|args
argument_list|)
argument_list|,
literal|0
argument_list|,
name|args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GimpParam
name|values
index|[
literal|1
index|]
decl_stmt|;
name|GimpRunMode
name|run_mode
decl_stmt|;
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
comment|/*  Get the specified drawable  */
name|destdrawable
operator|=
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
argument_list|)
expr_stmt|;
name|imageID
operator|=
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
comment|/*  Make sure that the drawable is gray or RGB color  */
if|if
condition|(
name|gimp_drawable_is_rgb
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
operator|||
name|gimp_drawable_is_gray
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|GIMP_RUN_INTERACTIVE
case|:
name|gimp_get_data
argument_list|(
literal|"plug_in_iwarp"
argument_list|,
operator|&
name|iwarp_vals
argument_list|)
expr_stmt|;
name|gimp_tile_cache_ntiles
argument_list|(
literal|2
operator|*
operator|(
name|drawable
operator|->
name|width
operator|+
name|gimp_tile_width
argument_list|()
operator|-
literal|1
operator|)
operator|/
name|gimp_tile_width
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|iwarp_dialog
argument_list|()
condition|)
name|iwarp
argument_list|()
expr_stmt|;
name|gimp_set_data
argument_list|(
literal|"plug_in_iwarp"
argument_list|,
operator|&
name|iwarp_vals
argument_list|,
sizeof|sizeof
argument_list|(
name|iwarp_vals_t
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_displays_flush
argument_list|()
expr_stmt|;
break|break;
case|case
name|GIMP_RUN_NONINTERACTIVE
case|:
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
break|break;
case|case
name|GIMP_RUN_WITH_LAST_VALS
case|:
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
name|status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
block|}
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|srcimage
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dstimage
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|deform_vectors
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|deform_area_vectors
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_get_pixel (gint x,gint y,guchar * pixel)
name|iwarp_get_pixel
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guchar
modifier|*
name|pixel
parameter_list|)
block|{
specifier|static
name|gint
name|old_col
init|=
operator|-
literal|1
decl_stmt|;
specifier|static
name|gint
name|old_row
init|=
operator|-
literal|1
decl_stmt|;
name|guchar
modifier|*
name|data
decl_stmt|;
name|gint
name|col
decl_stmt|,
name|row
decl_stmt|;
name|gint
name|i
decl_stmt|;
if|if
condition|(
name|x
operator|>=
name|xl
operator|&&
name|x
operator|<
name|xh
operator|&&
name|y
operator|>=
name|yl
operator|&&
name|y
operator|<
name|yh
condition|)
block|{
name|col
operator|=
name|x
operator|/
name|tile_width
expr_stmt|;
name|row
operator|=
name|y
operator|/
name|tile_height
expr_stmt|;
if|if
condition|(
name|col
operator|!=
name|old_col
operator|||
name|row
operator|!=
name|old_row
condition|)
block|{
name|gimp_tile_unref
argument_list|(
name|tile
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|tile
operator|=
name|gimp_drawable_get_tile
argument_list|(
name|drawable
argument_list|,
name|FALSE
argument_list|,
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
name|gimp_tile_ref
argument_list|(
name|tile
argument_list|)
expr_stmt|;
name|old_col
operator|=
name|col
expr_stmt|;
name|old_row
operator|=
name|row
expr_stmt|;
block|}
name|data
operator|=
name|tile
operator|->
name|data
operator|+
operator|(
name|tile
operator|->
name|ewidth
operator|*
operator|(
name|y
operator|%
name|tile_height
operator|)
operator|+
name|x
operator|%
name|tile_width
operator|)
operator|*
name|image_bpp
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
condition|;
name|i
operator|++
control|)
operator|*
name|pixel
operator|++
operator|=
operator|*
name|data
operator|++
expr_stmt|;
block|}
else|else
block|{
name|pixel
index|[
literal|0
index|]
operator|=
name|pixel
index|[
literal|1
index|]
operator|=
name|pixel
index|[
literal|2
index|]
operator|=
name|pixel
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_get_deform_vector (gdouble x,gdouble y,gdouble * xv,gdouble * yv)
name|iwarp_get_deform_vector
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|gdouble
modifier|*
name|xv
parameter_list|,
name|gdouble
modifier|*
name|yv
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|xi
decl_stmt|,
name|yi
decl_stmt|;
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|my0
decl_stmt|,
name|my1
decl_stmt|,
name|mx0
decl_stmt|,
name|mx1
decl_stmt|;
if|if
condition|(
name|x
operator|>=
literal|0
operator|&&
name|x
operator|<
operator|(
name|preview_width
operator|-
literal|1
operator|)
operator|&&
name|y
operator|>=
literal|0
operator|&&
name|y
operator|<
operator|(
name|preview_height
operator|-
literal|1
operator|)
condition|)
block|{
name|xi
operator|=
operator|(
name|gint
operator|)
name|x
expr_stmt|;
name|yi
operator|=
operator|(
name|gint
operator|)
name|y
expr_stmt|;
name|dx
operator|=
name|x
operator|-
name|xi
expr_stmt|;
name|dy
operator|=
name|y
operator|-
name|yi
expr_stmt|;
name|i
operator|=
operator|(
name|yi
operator|*
name|preview_width
operator|+
name|xi
operator|)
expr_stmt|;
name|mx0
operator|=
name|deform_vectors
index|[
name|i
index|]
operator|.
name|x
operator|+
operator|(
name|deform_vectors
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|x
operator|-
name|deform_vectors
index|[
name|i
index|]
operator|.
name|x
operator|)
operator|*
name|dx
expr_stmt|;
name|mx1
operator|=
name|deform_vectors
index|[
name|i
operator|+
name|preview_width
index|]
operator|.
name|x
operator|+
operator|(
name|deform_vectors
index|[
name|i
operator|+
name|preview_width
operator|+
literal|1
index|]
operator|.
name|x
operator|-
name|deform_vectors
index|[
name|i
operator|+
name|preview_width
index|]
operator|.
name|x
operator|)
operator|*
name|dx
expr_stmt|;
name|my0
operator|=
name|deform_vectors
index|[
name|i
index|]
operator|.
name|y
operator|+
name|dx
operator|*
operator|(
name|deform_vectors
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|y
operator|-
name|deform_vectors
index|[
name|i
index|]
operator|.
name|y
operator|)
expr_stmt|;
name|my1
operator|=
name|deform_vectors
index|[
name|i
operator|+
name|preview_width
index|]
operator|.
name|y
operator|+
name|dx
operator|*
operator|(
name|deform_vectors
index|[
name|i
operator|+
name|preview_width
operator|+
literal|1
index|]
operator|.
name|y
operator|-
name|deform_vectors
index|[
name|i
operator|+
name|preview_width
index|]
operator|.
name|y
operator|)
expr_stmt|;
operator|*
name|xv
operator|=
name|mx0
operator|+
name|dy
operator|*
operator|(
name|mx1
operator|-
name|mx0
operator|)
expr_stmt|;
operator|*
name|yv
operator|=
name|my0
operator|+
name|dy
operator|*
operator|(
name|my1
operator|-
name|my0
operator|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|xv
operator|=
operator|*
name|yv
operator|=
literal|0.0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_get_point (gdouble x,gdouble y,guchar * color)
name|iwarp_get_point
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|guchar
modifier|*
name|color
parameter_list|)
block|{
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|m0
decl_stmt|,
name|m1
decl_stmt|;
name|guchar
name|p0
index|[
literal|4
index|]
decl_stmt|,
name|p1
index|[
literal|4
index|]
decl_stmt|,
name|p2
index|[
literal|4
index|]
decl_stmt|,
name|p3
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|xi
decl_stmt|,
name|yi
decl_stmt|,
name|i
decl_stmt|;
name|xi
operator|=
operator|(
name|gint
operator|)
name|x
expr_stmt|;
name|yi
operator|=
operator|(
name|gint
operator|)
name|y
expr_stmt|;
name|dx
operator|=
name|x
operator|-
name|xi
expr_stmt|;
name|dy
operator|=
name|y
operator|-
name|yi
expr_stmt|;
name|iwarp_get_pixel
argument_list|(
name|xi
argument_list|,
name|yi
argument_list|,
name|p0
argument_list|)
expr_stmt|;
name|iwarp_get_pixel
argument_list|(
name|xi
operator|+
literal|1
argument_list|,
name|yi
argument_list|,
name|p1
argument_list|)
expr_stmt|;
name|iwarp_get_pixel
argument_list|(
name|xi
argument_list|,
name|yi
operator|+
literal|1
argument_list|,
name|p2
argument_list|)
expr_stmt|;
name|iwarp_get_pixel
argument_list|(
name|xi
operator|+
literal|1
argument_list|,
name|yi
operator|+
literal|1
argument_list|,
name|p3
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_alpha
condition|)
block|{
name|gdouble
name|a0
init|=
name|p0
index|[
name|image_bpp
operator|-
literal|1
index|]
decl_stmt|;
name|gdouble
name|a1
init|=
name|p1
index|[
name|image_bpp
operator|-
literal|1
index|]
decl_stmt|;
name|gdouble
name|a2
init|=
name|p2
index|[
name|image_bpp
operator|-
literal|1
index|]
decl_stmt|;
name|gdouble
name|a3
init|=
name|p3
index|[
name|image_bpp
operator|-
literal|1
index|]
decl_stmt|;
name|gdouble
name|alpha
decl_stmt|;
name|m0
operator|=
name|a0
operator|+
name|dx
operator|*
operator|(
name|a1
operator|-
name|a0
operator|)
expr_stmt|;
name|m1
operator|=
name|a2
operator|+
name|dx
operator|*
operator|(
name|a3
operator|-
name|a2
operator|)
expr_stmt|;
name|alpha
operator|=
operator|(
name|m0
operator|+
name|dy
operator|*
operator|(
name|m1
operator|-
name|m0
operator|)
operator|)
expr_stmt|;
name|color
index|[
name|image_bpp
operator|-
literal|1
index|]
operator|=
name|alpha
expr_stmt|;
if|if
condition|(
name|color
index|[
name|image_bpp
operator|-
literal|1
index|]
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|m0
operator|=
name|a0
operator|*
name|p0
index|[
name|i
index|]
operator|+
name|dx
operator|*
operator|(
name|a1
operator|*
name|p1
index|[
name|i
index|]
operator|-
name|a0
operator|*
name|p0
index|[
name|i
index|]
operator|)
expr_stmt|;
name|m1
operator|=
name|a2
operator|*
name|p2
index|[
name|i
index|]
operator|+
name|dx
operator|*
operator|(
name|a3
operator|*
name|p3
index|[
name|i
index|]
operator|-
name|a2
operator|*
name|p2
index|[
name|i
index|]
operator|)
expr_stmt|;
name|color
index|[
name|i
index|]
operator|=
operator|(
name|m0
operator|+
name|dy
operator|*
operator|(
name|m1
operator|-
name|m0
operator|)
operator|)
operator|/
name|alpha
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
condition|;
name|i
operator|++
control|)
block|{
name|m0
operator|=
name|p0
index|[
name|i
index|]
operator|+
name|dx
operator|*
operator|(
name|p1
index|[
name|i
index|]
operator|-
name|p0
index|[
name|i
index|]
operator|)
expr_stmt|;
name|m1
operator|=
name|p2
index|[
name|i
index|]
operator|+
name|dx
operator|*
operator|(
name|p3
index|[
name|i
index|]
operator|-
name|p2
index|[
name|i
index|]
operator|)
expr_stmt|;
name|color
index|[
name|i
index|]
operator|=
name|m0
operator|+
name|dy
operator|*
operator|(
name|m1
operator|-
name|m0
operator|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|iwarp_supersample_test (GimpVector2 * v0,GimpVector2 * v1,GimpVector2 * v2,GimpVector2 * v3)
name|iwarp_supersample_test
parameter_list|(
name|GimpVector2
modifier|*
name|v0
parameter_list|,
name|GimpVector2
modifier|*
name|v1
parameter_list|,
name|GimpVector2
modifier|*
name|v2
parameter_list|,
name|GimpVector2
modifier|*
name|v3
parameter_list|)
block|{
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|dx
operator|=
literal|1.0
operator|+
name|v1
operator|->
name|x
operator|-
name|v0
operator|->
name|x
expr_stmt|;
name|dy
operator|=
name|v1
operator|->
name|y
operator|-
name|v0
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|SQR
argument_list|(
name|dx
argument_list|)
operator|+
name|SQR
argument_list|(
name|dy
argument_list|)
operator|>
name|supersample_threshold_2
condition|)
return|return
name|TRUE
return|;
name|dx
operator|=
literal|1.0
operator|+
name|v2
operator|->
name|x
operator|-
name|v3
operator|->
name|x
expr_stmt|;
name|dy
operator|=
name|v2
operator|->
name|y
operator|-
name|v3
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|SQR
argument_list|(
name|dx
argument_list|)
operator|+
name|SQR
argument_list|(
name|dy
argument_list|)
operator|>
name|supersample_threshold_2
condition|)
return|return
name|TRUE
return|;
name|dx
operator|=
name|v2
operator|->
name|x
operator|-
name|v0
operator|->
name|x
expr_stmt|;
name|dy
operator|=
literal|1.0
operator|+
name|v2
operator|->
name|y
operator|-
name|v0
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|SQR
argument_list|(
name|dx
argument_list|)
operator|+
name|SQR
argument_list|(
name|dy
argument_list|)
operator|>
name|supersample_threshold_2
condition|)
return|return
name|TRUE
return|;
name|dx
operator|=
name|v3
operator|->
name|x
operator|-
name|v1
operator|->
name|x
expr_stmt|;
name|dy
operator|=
literal|1.0
operator|+
name|v3
operator|->
name|y
operator|-
name|v1
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|SQR
argument_list|(
name|dx
argument_list|)
operator|+
name|SQR
argument_list|(
name|dy
argument_list|)
operator|>
name|supersample_threshold_2
condition|)
return|return
name|TRUE
return|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_getsample (GimpVector2 v0,GimpVector2 v1,GimpVector2 v2,GimpVector2 v3,gdouble x,gdouble y,gint * sample,gint * cc,gint depth,gdouble scale)
name|iwarp_getsample
parameter_list|(
name|GimpVector2
name|v0
parameter_list|,
name|GimpVector2
name|v1
parameter_list|,
name|GimpVector2
name|v2
parameter_list|,
name|GimpVector2
name|v3
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|gint
modifier|*
name|sample
parameter_list|,
name|gint
modifier|*
name|cc
parameter_list|,
name|gint
name|depth
parameter_list|,
name|gdouble
name|scale
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|gdouble
name|xv
decl_stmt|,
name|yv
decl_stmt|;
name|GimpVector2
name|v01
decl_stmt|,
name|v13
decl_stmt|,
name|v23
decl_stmt|,
name|v02
decl_stmt|,
name|vm
decl_stmt|;
name|guchar
name|c
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|depth
operator|>=
name|iwarp_vals
operator|.
name|max_supersample_depth
operator|)
operator|||
operator|(
operator|!
name|iwarp_supersample_test
argument_list|(
operator|&
name|v0
argument_list|,
operator|&
name|v1
argument_list|,
operator|&
name|v2
argument_list|,
operator|&
name|v3
argument_list|)
operator|)
condition|)
block|{
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
name|x
operator|-
name|xl
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
name|y
operator|-
name|yl
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|iwarp_get_point
argument_list|(
name|pre2img
operator|*
name|xv
operator|+
name|x
argument_list|,
name|pre2img
operator|*
name|yv
operator|+
name|y
argument_list|,
name|c
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
condition|;
name|i
operator|++
control|)
name|sample
index|[
name|i
index|]
operator|+=
name|c
index|[
name|i
index|]
expr_stmt|;
operator|(
operator|*
name|cc
operator|)
operator|++
expr_stmt|;
block|}
else|else
block|{
name|scale
operator|*=
literal|0.5
expr_stmt|;
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
name|x
operator|-
name|xl
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
name|y
operator|-
name|yl
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|iwarp_get_point
argument_list|(
name|pre2img
operator|*
name|xv
operator|+
name|x
argument_list|,
name|pre2img
operator|*
name|yv
operator|+
name|y
argument_list|,
name|c
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
condition|;
name|i
operator|++
control|)
name|sample
index|[
name|i
index|]
operator|+=
name|c
index|[
name|i
index|]
expr_stmt|;
operator|(
operator|*
name|cc
operator|)
operator|++
expr_stmt|;
name|vm
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|vm
operator|.
name|y
operator|=
name|yv
expr_stmt|;
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
name|x
operator|-
name|xl
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
name|y
operator|-
name|yl
operator|-
name|scale
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|v01
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|v01
operator|.
name|y
operator|=
name|yv
expr_stmt|;
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
name|x
operator|-
name|xl
operator|+
name|scale
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
name|y
operator|-
name|yl
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|v13
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|v13
operator|.
name|y
operator|=
name|yv
expr_stmt|;
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
name|x
operator|-
name|xl
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
name|y
operator|-
name|yl
operator|+
name|scale
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|v23
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|v23
operator|.
name|y
operator|=
name|yv
expr_stmt|;
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
name|x
operator|-
name|xl
operator|-
name|scale
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
name|y
operator|-
name|yl
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|v02
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|v02
operator|.
name|y
operator|=
name|yv
expr_stmt|;
name|iwarp_getsample
argument_list|(
name|v0
argument_list|,
name|v01
argument_list|,
name|vm
argument_list|,
name|v02
argument_list|,
name|x
operator|-
name|scale
argument_list|,
name|y
operator|-
name|scale
argument_list|,
name|sample
argument_list|,
name|cc
argument_list|,
name|depth
operator|+
literal|1
argument_list|,
name|scale
argument_list|)
expr_stmt|;
name|iwarp_getsample
argument_list|(
name|v01
argument_list|,
name|v1
argument_list|,
name|v13
argument_list|,
name|vm
argument_list|,
name|x
operator|+
name|scale
argument_list|,
name|y
operator|-
name|scale
argument_list|,
name|sample
argument_list|,
name|cc
argument_list|,
name|depth
operator|+
literal|1
argument_list|,
name|scale
argument_list|)
expr_stmt|;
name|iwarp_getsample
argument_list|(
name|v02
argument_list|,
name|vm
argument_list|,
name|v23
argument_list|,
name|v2
argument_list|,
name|x
operator|-
name|scale
argument_list|,
name|y
operator|+
name|scale
argument_list|,
name|sample
argument_list|,
name|cc
argument_list|,
name|depth
operator|+
literal|1
argument_list|,
name|scale
argument_list|)
expr_stmt|;
name|iwarp_getsample
argument_list|(
name|vm
argument_list|,
name|v13
argument_list|,
name|v3
argument_list|,
name|v23
argument_list|,
name|x
operator|+
name|scale
argument_list|,
name|y
operator|+
name|scale
argument_list|,
name|sample
argument_list|,
name|cc
argument_list|,
name|depth
operator|+
literal|1
argument_list|,
name|scale
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_supersample (gint sxl,gint syl,gint sxr,gint syr,guchar * dest_data,gint stride,gint * progress,gint max_progress)
name|iwarp_supersample
parameter_list|(
name|gint
name|sxl
parameter_list|,
name|gint
name|syl
parameter_list|,
name|gint
name|sxr
parameter_list|,
name|gint
name|syr
parameter_list|,
name|guchar
modifier|*
name|dest_data
parameter_list|,
name|gint
name|stride
parameter_list|,
name|gint
modifier|*
name|progress
parameter_list|,
name|gint
name|max_progress
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|wx
decl_stmt|,
name|wy
decl_stmt|,
name|col
decl_stmt|,
name|row
decl_stmt|,
name|cc
decl_stmt|;
name|GimpVector2
modifier|*
name|srow
decl_stmt|,
modifier|*
name|srow_old
decl_stmt|,
modifier|*
name|vh
decl_stmt|;
name|gdouble
name|xv
decl_stmt|,
name|yv
decl_stmt|;
name|gint
name|color
index|[
literal|4
index|]
decl_stmt|;
name|guchar
modifier|*
name|dest
decl_stmt|;
name|wx
operator|=
name|sxr
operator|-
name|sxl
operator|+
literal|1
expr_stmt|;
name|wy
operator|=
name|syr
operator|-
name|syl
operator|+
literal|1
expr_stmt|;
name|srow
operator|=
name|g_new
argument_list|(
name|GimpVector2
argument_list|,
name|sxr
operator|-
name|sxl
operator|+
literal|1
argument_list|)
expr_stmt|;
name|srow_old
operator|=
name|g_new
argument_list|(
name|GimpVector2
argument_list|,
name|sxr
operator|-
name|sxl
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|sxl
init|;
name|i
operator|<
operator|(
name|sxr
operator|+
literal|1
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
operator|-
literal|0.5
operator|+
name|i
operator|-
name|xl
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
operator|-
literal|0.5
operator|+
name|syl
operator|-
name|yl
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|srow_old
index|[
name|i
operator|-
name|sxl
index|]
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|srow_old
index|[
name|i
operator|-
name|sxl
index|]
operator|.
name|y
operator|=
name|yv
expr_stmt|;
block|}
for|for
control|(
name|col
operator|=
name|syl
init|;
name|col
operator|<
name|syr
condition|;
name|col
operator|++
control|)
block|{
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
operator|-
literal|0.5
operator|+
name|sxl
operator|-
name|xl
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
literal|0.5
operator|+
name|col
operator|-
name|yl
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|srow
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|srow
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|yv
expr_stmt|;
for|for
control|(
name|row
operator|=
name|sxl
init|;
name|row
operator|<
name|sxr
condition|;
name|row
operator|++
control|)
block|{
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
literal|0.5
operator|+
name|row
operator|-
name|xl
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
literal|0.5
operator|+
name|col
operator|-
name|yl
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
name|srow
index|[
name|row
operator|-
name|sxl
operator|+
literal|1
index|]
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|srow
index|[
name|row
operator|-
name|sxl
operator|+
literal|1
index|]
operator|.
name|y
operator|=
name|yv
expr_stmt|;
name|cc
operator|=
literal|0
expr_stmt|;
name|color
index|[
literal|0
index|]
operator|=
name|color
index|[
literal|1
index|]
operator|=
name|color
index|[
literal|2
index|]
operator|=
name|color
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|iwarp_getsample
argument_list|(
name|srow_old
index|[
name|row
operator|-
name|sxl
index|]
argument_list|,
name|srow_old
index|[
name|row
operator|-
name|sxl
operator|+
literal|1
index|]
argument_list|,
name|srow
index|[
name|row
operator|-
name|sxl
index|]
argument_list|,
name|srow
index|[
name|row
operator|-
name|sxl
operator|+
literal|1
index|]
argument_list|,
name|row
argument_list|,
name|col
argument_list|,
name|color
argument_list|,
operator|&
name|cc
argument_list|,
literal|0
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|layer_alpha
condition|)
name|dest
operator|=
name|dest_data
operator|+
operator|(
name|col
operator|-
name|syl
operator|)
operator|*
operator|(
name|stride
operator|)
operator|+
operator|(
name|row
operator|-
name|sxl
operator|)
operator|*
name|image_bpp
expr_stmt|;
else|else
name|dest
operator|=
name|dest_data
operator|+
operator|(
name|col
operator|-
name|syl
operator|)
operator|*
name|stride
operator|+
operator|(
name|row
operator|-
name|sxl
operator|)
operator|*
name|image_bpp
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
condition|;
name|i
operator|++
control|)
operator|*
name|dest
operator|++
operator|=
name|color
index|[
name|i
index|]
operator|/
name|cc
expr_stmt|;
operator|(
operator|*
name|progress
operator|)
operator|++
expr_stmt|;
block|}
name|gimp_progress_update
argument_list|(
call|(
name|gdouble
call|)
argument_list|(
operator|*
name|progress
argument_list|)
operator|/
name|max_progress
argument_list|)
expr_stmt|;
name|vh
operator|=
name|srow_old
expr_stmt|;
name|srow_old
operator|=
name|srow
expr_stmt|;
name|srow
operator|=
name|vh
expr_stmt|;
block|}
name|g_free
argument_list|(
name|srow
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|srow_old
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_frame (void)
name|iwarp_frame
parameter_list|(
name|void
parameter_list|)
block|{
name|GimpPixelRgn
name|dest_rgn
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
name|guchar
modifier|*
name|dest_row
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|gint
name|row
decl_stmt|,
name|col
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|progress
decl_stmt|,
name|max_progress
decl_stmt|;
name|guchar
name|color
index|[
literal|4
index|]
decl_stmt|;
name|gdouble
name|xv
decl_stmt|,
name|yv
decl_stmt|;
name|progress
operator|=
literal|0
expr_stmt|;
name|max_progress
operator|=
operator|(
name|yh
operator|-
name|yl
operator|)
operator|*
operator|(
name|xh
operator|-
name|xl
operator|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|dest_rgn
argument_list|,
name|destdrawable
argument_list|,
name|xl
argument_list|,
name|yl
argument_list|,
name|xh
operator|-
name|xl
argument_list|,
name|yh
operator|-
name|yl
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|do_animate
condition|)
name|gimp_progress_init
argument_list|(
name|_
argument_list|(
literal|"Warping..."
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|gimp_pixel_rgns_register
argument_list|(
literal|1
argument_list|,
operator|&
name|dest_rgn
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|gimp_pixel_rgns_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
name|dest_row
operator|=
name|dest_rgn
operator|.
name|data
expr_stmt|;
if|if
condition|(
operator|!
name|iwarp_vals
operator|.
name|do_supersample
condition|)
block|{
for|for
control|(
name|row
operator|=
name|dest_rgn
operator|.
name|y
init|;
name|row
operator|<
operator|(
name|dest_rgn
operator|.
name|y
operator|+
name|dest_rgn
operator|.
name|h
operator|)
condition|;
name|row
operator|++
control|)
block|{
name|dest
operator|=
name|dest_row
expr_stmt|;
for|for
control|(
name|col
operator|=
name|dest_rgn
operator|.
name|x
init|;
name|col
operator|<
operator|(
name|dest_rgn
operator|.
name|x
operator|+
name|dest_rgn
operator|.
name|w
operator|)
condition|;
name|col
operator|++
control|)
block|{
name|progress
operator|++
expr_stmt|;
name|iwarp_get_deform_vector
argument_list|(
name|img2pre
operator|*
operator|(
name|col
operator|-
name|xl
operator|)
argument_list|,
name|img2pre
operator|*
operator|(
name|row
operator|-
name|yl
operator|)
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|*=
name|animate_deform_value
expr_stmt|;
name|yv
operator|*=
name|animate_deform_value
expr_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|xv
argument_list|)
operator|>
literal|0.0
operator|||
name|fabs
argument_list|(
name|yv
argument_list|)
operator|>
literal|0.0
condition|)
block|{
name|iwarp_get_point
argument_list|(
name|pre2img
operator|*
name|xv
operator|+
name|col
argument_list|,
name|pre2img
operator|*
name|yv
operator|+
name|row
argument_list|,
name|color
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
condition|;
name|i
operator|++
control|)
operator|*
name|dest
operator|++
operator|=
name|color
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|iwarp_get_pixel
argument_list|(
name|col
argument_list|,
name|row
argument_list|,
name|color
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
condition|;
name|i
operator|++
control|)
operator|*
name|dest
operator|++
operator|=
name|color
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
name|dest_row
operator|+=
name|dest_rgn
operator|.
name|rowstride
expr_stmt|;
name|gimp_progress_update
argument_list|(
call|(
name|gdouble
call|)
argument_list|(
name|progress
argument_list|)
operator|/
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|supersample_threshold_2
operator|=
name|iwarp_vals
operator|.
name|supersample_threshold
operator|*
name|iwarp_vals
operator|.
name|supersample_threshold
expr_stmt|;
name|iwarp_supersample
argument_list|(
name|dest_rgn
operator|.
name|x
argument_list|,
name|dest_rgn
operator|.
name|y
argument_list|,
name|dest_rgn
operator|.
name|x
operator|+
name|dest_rgn
operator|.
name|w
argument_list|,
name|dest_rgn
operator|.
name|y
operator|+
name|dest_rgn
operator|.
name|h
argument_list|,
name|dest_rgn
operator|.
name|data
argument_list|,
name|dest_rgn
operator|.
name|rowstride
argument_list|,
operator|&
name|progress
argument_list|,
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
name|gimp_drawable_flush
argument_list|(
name|destdrawable
argument_list|)
expr_stmt|;
name|gimp_drawable_merge_shadow
argument_list|(
name|destdrawable
operator|->
name|drawable_id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_update
argument_list|(
name|destdrawable
operator|->
name|drawable_id
argument_list|,
name|xl
argument_list|,
name|yl
argument_list|,
operator|(
name|xh
operator|-
name|xl
operator|)
argument_list|,
operator|(
name|yh
operator|-
name|yl
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp (void)
name|iwarp
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|gint32
name|layerID
decl_stmt|;
name|gint32
modifier|*
name|animlayers
decl_stmt|;
name|gchar
modifier|*
name|st
decl_stmt|;
name|gdouble
name|delta
decl_stmt|;
if|if
condition|(
name|image_bpp
operator|==
literal|1
operator|||
name|image_bpp
operator|==
literal|3
condition|)
name|layer_alpha
operator|=
name|FALSE
expr_stmt|;
else|else
name|layer_alpha
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|animate_num_frames
operator|>
literal|1
operator|&&
name|do_animate
condition|)
block|{
name|animlayers
operator|=
name|g_new
argument_list|(
name|gint32
argument_list|,
name|animate_num_frames
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_animate_reverse
condition|)
block|{
name|animate_deform_value
operator|=
literal|1.0
expr_stmt|;
name|delta
operator|=
operator|-
literal|1.0
operator|/
operator|(
name|animate_num_frames
operator|-
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
name|animate_deform_value
operator|=
literal|0.0
expr_stmt|;
name|delta
operator|=
literal|1.0
operator|/
operator|(
name|animate_num_frames
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|layerID
operator|=
name|gimp_image_get_active_layer
argument_list|(
name|imageID
argument_list|)
expr_stmt|;
name|frame_number
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|animate_num_frames
condition|;
name|i
operator|++
control|)
block|{
name|st
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Frame %d"
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|animlayers
index|[
name|i
index|]
operator|=
name|gimp_layer_copy
argument_list|(
name|layerID
argument_list|)
expr_stmt|;
name|gimp_layer_add_alpha
argument_list|(
name|animlayers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|gimp_layer_set_name
argument_list|(
name|animlayers
index|[
name|i
index|]
argument_list|,
name|st
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|st
argument_list|)
expr_stmt|;
name|destdrawable
operator|=
name|gimp_drawable_get
argument_list|(
name|animlayers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|st
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Warping Frame No. %d..."
argument_list|)
argument_list|,
name|frame_number
argument_list|)
expr_stmt|;
name|gimp_progress_init
argument_list|(
name|st
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|st
argument_list|)
expr_stmt|;
if|if
condition|(
name|animate_deform_value
operator|>
literal|0.0
condition|)
name|iwarp_frame
argument_list|()
expr_stmt|;
name|gimp_image_add_layer
argument_list|(
name|imageID
argument_list|,
name|animlayers
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|animate_deform_value
operator|=
name|animate_deform_value
operator|+
name|delta
expr_stmt|;
name|frame_number
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|do_animate_ping_pong
condition|)
block|{
name|st
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Warping Frame No. %d..."
argument_list|)
argument_list|,
name|frame_number
argument_list|)
expr_stmt|;
name|gimp_progress_init
argument_list|(
name|_
argument_list|(
literal|"Ping Pong"
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|st
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|animate_num_frames
condition|;
name|i
operator|++
control|)
block|{
name|gimp_progress_update
argument_list|(
operator|(
name|gdouble
operator|)
name|i
operator|/
operator|(
name|animate_num_frames
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|layerID
operator|=
name|gimp_layer_copy
argument_list|(
name|animlayers
index|[
name|animate_num_frames
operator|-
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|gimp_layer_add_alpha
argument_list|(
name|layerID
argument_list|)
expr_stmt|;
name|st
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Frame %d"
argument_list|)
argument_list|,
name|i
operator|+
name|animate_num_frames
argument_list|)
expr_stmt|;
name|gimp_layer_set_name
argument_list|(
name|layerID
argument_list|,
name|st
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|st
argument_list|)
expr_stmt|;
name|gimp_image_add_layer
argument_list|(
name|imageID
argument_list|,
name|layerID
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|g_free
argument_list|(
name|animlayers
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|animate_deform_value
operator|=
literal|1.0
expr_stmt|;
name|iwarp_frame
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|tile
operator|!=
name|NULL
condition|)
block|{
name|gimp_tile_unref
argument_list|(
name|tile
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|tile
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|guchar
DECL|function|iwarp_transparent_color (gint x,gint y)
name|iwarp_transparent_color
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
if|if
condition|(
operator|(
name|y
operator|%
operator|(
name|GIMP_CHECK_SIZE
operator|*
literal|4
operator|)
operator|)
operator|>
operator|(
name|GIMP_CHECK_SIZE
operator|*
literal|2
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|x
operator|%
operator|(
name|GIMP_CHECK_SIZE
operator|*
literal|4
operator|)
operator|)
operator|>
operator|(
name|GIMP_CHECK_SIZE
operator|*
literal|2
operator|)
condition|)
return|return
name|GIMP_CHECK_DARK
operator|*
literal|255
return|;
else|else
return|return
name|GIMP_CHECK_LIGHT
operator|*
literal|255
return|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|x
operator|%
operator|(
name|GIMP_CHECK_SIZE
operator|*
literal|4
operator|)
operator|)
operator|<
operator|(
name|GIMP_CHECK_SIZE
operator|*
literal|2
operator|)
condition|)
return|return
name|GIMP_CHECK_DARK
operator|*
literal|255
return|;
else|else
return|return
name|GIMP_CHECK_LIGHT
operator|*
literal|255
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_cpy_images (void)
name|iwarp_cpy_images
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|p
decl_stmt|;
name|gdouble
name|alpha
decl_stmt|;
name|guchar
modifier|*
name|srccolor
decl_stmt|,
modifier|*
name|dstcolor
decl_stmt|;
if|if
condition|(
name|image_bpp
operator|==
literal|1
operator|||
name|image_bpp
operator|==
literal|3
condition|)
block|{
name|memcpy
argument_list|(
name|dstimage
argument_list|,
name|srcimage
argument_list|,
name|preview_width
operator|*
name|preview_height
operator|*
name|preview_bpp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|preview_width
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|preview_height
condition|;
name|j
operator|++
control|)
block|{
name|p
operator|=
operator|(
name|j
operator|*
name|preview_width
operator|+
name|i
operator|)
expr_stmt|;
name|srccolor
operator|=
name|srcimage
operator|+
name|p
operator|*
name|image_bpp
expr_stmt|;
name|alpha
operator|=
operator|(
name|gdouble
operator|)
name|srccolor
index|[
name|image_bpp
operator|-
literal|1
index|]
operator|/
literal|255
expr_stmt|;
name|dstcolor
operator|=
name|dstimage
operator|+
name|p
operator|*
name|preview_bpp
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|preview_bpp
condition|;
name|k
operator|++
control|)
block|{
operator|*
name|dstcolor
operator|++
operator|=
call|(
name|guchar
call|)
argument_list|(
name|alpha
operator|*
name|srccolor
index|[
name|k
index|]
operator|+
operator|(
literal|1.0
operator|-
name|alpha
operator|)
operator|*
name|iwarp_transparent_color
argument_list|(
name|i
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_init (void)
name|iwarp_init
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|y
decl_stmt|,
name|x
decl_stmt|,
name|xi
decl_stmt|,
name|i
decl_stmt|;
name|GimpPixelRgn
name|srcrgn
decl_stmt|;
name|guchar
modifier|*
name|pts
decl_stmt|;
name|guchar
modifier|*
name|linebuffer
init|=
name|NULL
decl_stmt|;
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|gimp_drawable_mask_bounds
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
operator|&
name|xl
argument_list|,
operator|&
name|yl
argument_list|,
operator|&
name|xh
argument_list|,
operator|&
name|yh
argument_list|)
expr_stmt|;
name|sel_width
operator|=
name|xh
operator|-
name|xl
expr_stmt|;
name|sel_height
operator|=
name|yh
operator|-
name|yl
expr_stmt|;
name|image_bpp
operator|=
name|gimp_drawable_bpp
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_drawable_is_layer
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
condition|)
name|preserve_trans
operator|=
operator|(
name|gimp_layer_get_preserve_transparency
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
operator|)
expr_stmt|;
else|else
name|preserve_trans
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|image_bpp
operator|<
literal|3
condition|)
name|preview_bpp
operator|=
literal|1
expr_stmt|;
else|else
name|preview_bpp
operator|=
literal|3
expr_stmt|;
name|dx
operator|=
operator|(
name|gdouble
operator|)
name|sel_width
operator|/
name|MAX_PREVIEW_WIDTH
expr_stmt|;
name|dy
operator|=
operator|(
name|gdouble
operator|)
name|sel_height
operator|/
name|MAX_PREVIEW_HEIGHT
expr_stmt|;
if|if
condition|(
name|dx
operator|>
name|dy
condition|)
name|pre2img
operator|=
name|dx
expr_stmt|;
else|else
name|pre2img
operator|=
name|dy
expr_stmt|;
if|if
condition|(
name|dx
operator|<=
literal|1.0
operator|&&
name|dy
operator|<=
literal|1.0
condition|)
name|pre2img
operator|=
literal|1.0
expr_stmt|;
name|img2pre
operator|=
literal|1.0
operator|/
name|pre2img
expr_stmt|;
name|preview_width
operator|=
call|(
name|gint
call|)
argument_list|(
name|sel_width
operator|/
name|pre2img
argument_list|)
expr_stmt|;
name|preview_height
operator|=
call|(
name|gint
call|)
argument_list|(
name|sel_height
operator|/
name|pre2img
argument_list|)
expr_stmt|;
name|tile_width
operator|=
name|gimp_tile_width
argument_list|()
expr_stmt|;
name|tile_height
operator|=
name|gimp_tile_height
argument_list|()
expr_stmt|;
name|srcimage
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|preview_width
operator|*
name|preview_height
operator|*
name|image_bpp
argument_list|)
expr_stmt|;
name|dstimage
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|preview_width
operator|*
name|preview_height
operator|*
name|preview_bpp
argument_list|)
expr_stmt|;
name|deform_vectors
operator|=
name|g_new0
argument_list|(
name|GimpVector2
argument_list|,
name|preview_width
operator|*
name|preview_height
argument_list|)
expr_stmt|;
name|deform_area_vectors
operator|=
name|g_new
argument_list|(
name|GimpVector2
argument_list|,
operator|(
name|MAX_DEFORM_AREA_RADIUS
operator|*
literal|2
operator|+
literal|1
operator|)
operator|*
operator|(
name|MAX_DEFORM_AREA_RADIUS
operator|*
literal|2
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|linebuffer
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|sel_width
operator|*
name|image_bpp
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|srcrgn
argument_list|,
name|drawable
argument_list|,
name|xl
argument_list|,
name|yl
argument_list|,
name|sel_width
argument_list|,
name|sel_height
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|preview_height
condition|;
name|y
operator|++
control|)
block|{
name|gimp_pixel_rgn_get_row
argument_list|(
operator|&
name|srcrgn
argument_list|,
name|linebuffer
argument_list|,
name|xl
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|pre2img
operator|*
name|y
argument_list|)
operator|+
name|yl
argument_list|,
name|sel_width
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|preview_width
condition|;
name|x
operator|++
control|)
block|{
name|pts
operator|=
name|srcimage
operator|+
operator|(
name|y
operator|*
name|preview_width
operator|+
name|x
operator|)
operator|*
name|image_bpp
expr_stmt|;
name|xi
operator|=
call|(
name|gint
call|)
argument_list|(
name|pre2img
operator|*
name|x
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|image_bpp
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|pts
operator|++
operator|=
name|linebuffer
index|[
name|xi
operator|*
name|image_bpp
operator|+
name|i
index|]
expr_stmt|;
block|}
block|}
block|}
name|iwarp_cpy_images
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_DEFORM_AREA_RADIUS
condition|;
name|i
operator|++
control|)
block|{
name|filter
index|[
name|i
index|]
operator|=
name|pow
argument_list|(
operator|(
name|cos
argument_list|(
name|sqrt
argument_list|(
operator|(
name|gdouble
operator|)
name|i
operator|/
name|MAX_DEFORM_AREA_RADIUS
argument_list|)
operator|*
name|G_PI
argument_list|)
operator|+
literal|1
operator|)
operator|*
literal|0.5
argument_list|,
literal|0.7
argument_list|)
expr_stmt|;
comment|/*0.7*/
block|}
name|g_free
argument_list|(
name|linebuffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_animate_dialog (GtkWidget * dlg,GtkWidget * notebook)
name|iwarp_animate_dialog
parameter_list|(
name|GtkWidget
modifier|*
name|dlg
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkObject
modifier|*
name|scale_data
decl_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"A_nimate"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|do_animate
argument_list|)
expr_stmt|;
name|gtk_frame_set_label_widget
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|do_animate
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"set_sensitive"
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|table
argument_list|,
name|do_animate
argument_list|)
expr_stmt|;
name|scale_data
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Number of _Frames:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|0
argument_list|,
name|animate_num_frames
argument_list|,
literal|2
argument_list|,
name|MAX_NUM_FRAMES
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scale_data
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|animate_num_frames
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"R_everse"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|button
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
operator||
name|GTK_EXPAND
argument_list|,
name|GTK_FILL
operator||
name|GTK_EXPAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|do_animate_reverse
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Ping Pong"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|button
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_FILL
operator||
name|GTK_EXPAND
argument_list|,
name|GTK_FILL
operator||
name|GTK_EXPAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|do_animate_ping_pong
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Animate"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_settings_dialog (GtkWidget * dlg,GtkWidget * notebook)
name|iwarp_settings_dialog
parameter_list|(
name|GtkWidget
modifier|*
name|dlg
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox2
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox3
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkObject
modifier|*
name|scale_data
decl_stmt|;
name|GtkWidget
modifier|*
name|widget
index|[
literal|3
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|scale_data
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"_Deform Radius:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|4
argument_list|,
name|iwarp_vals
operator|.
name|deform_area_radius
argument_list|,
literal|5.0
argument_list|,
name|MAX_DEFORM_AREA_RADIUS
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scale_data
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|iwarp_vals
operator|.
name|deform_area_radius
argument_list|)
expr_stmt|;
name|scale_data
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"D_eform Amount:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|4
argument_list|,
name|iwarp_vals
operator|.
name|deform_amount
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scale_data
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|iwarp_vals
operator|.
name|deform_amount
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Deform Mode"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|TRUE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|hbox
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|vbox2
operator|=
name|gimp_radio_group_new2
argument_list|(
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_radio_button_update
argument_list|)
argument_list|,
operator|&
name|iwarp_vals
operator|.
name|deform_mode
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|iwarp_vals
operator|.
name|deform_mode
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"_Move"
argument_list|)
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|MOVE
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"_Grow"
argument_list|)
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|GROW
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"S_wirl CCW"
argument_list|)
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|SWIRL_CCW
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Remo_ve"
argument_list|)
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|REMOVE
argument_list|)
argument_list|,
operator|&
name|widget
index|[
literal|0
index|]
argument_list|,
name|_
argument_list|(
literal|"S_hrink"
argument_list|)
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|SHRINK
argument_list|)
argument_list|,
operator|&
name|widget
index|[
literal|1
index|]
argument_list|,
name|_
argument_list|(
literal|"Sw_irl CW"
argument_list|)
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|SWIRL_CW
argument_list|)
argument_list|,
operator|&
name|widget
index|[
literal|2
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|vbox2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox2
argument_list|)
expr_stmt|;
name|vbox3
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|vbox3
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|g_object_ref
argument_list|(
name|widget
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|widget
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|gtk_container_remove
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|widget
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox3
argument_list|)
argument_list|,
name|widget
index|[
name|i
index|]
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|widget
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|widget
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|button
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Bilinear"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|iwarp_vals
operator|.
name|do_bilinear
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|iwarp_vals
operator|.
name|do_bilinear
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"Adaptive S_upersample"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|iwarp_vals
operator|.
name|do_supersample
argument_list|)
expr_stmt|;
name|gtk_frame_set_label_widget
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|iwarp_vals
operator|.
name|do_supersample
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"set_sensitive"
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|table
argument_list|,
name|iwarp_vals
operator|.
name|do_supersample
argument_list|)
expr_stmt|;
name|scale_data
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Ma_x Depth:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|5
argument_list|,
name|iwarp_vals
operator|.
name|max_supersample_depth
argument_list|,
literal|1.0
argument_list|,
literal|5.0
argument_list|,
literal|1.1
argument_list|,
literal|1.0
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scale_data
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|iwarp_vals
operator|.
name|max_supersample_depth
argument_list|)
expr_stmt|;
name|scale_data
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Thresho_ld:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|5
argument_list|,
name|iwarp_vals
operator|.
name|supersample_threshold
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scale_data
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|iwarp_vals
operator|.
name|supersample_threshold
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Settings"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|iwarp_dialog (void)
name|iwarp_dialog
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|main_hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|abox
decl_stmt|;
name|GtkWidget
modifier|*
name|pframe
decl_stmt|;
name|GtkWidget
modifier|*
name|notebook
decl_stmt|;
name|gimp_ui_init
argument_list|(
literal|"iwarp"
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|iwarp_init
argument_list|()
expr_stmt|;
name|dlg
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"IWarp"
argument_list|)
argument_list|,
literal|"iwarp"
argument_list|,
name|gimp_standard_help_func
argument_list|,
literal|"filters/iwarp.html"
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|GIMP_STOCK_RESET
argument_list|,
name|iwarp_reset_callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|gtk_widget_destroy
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|GTK_STOCK_OK
argument_list|,
name|iwarp_ok_callback
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_main_quit
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|main_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|main_hbox
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|main_hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Preview"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_hbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|abox
operator|=
name|gtk_alignment_new
argument_list|(
literal|0.5
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|abox
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|abox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|abox
argument_list|)
expr_stmt|;
name|pframe
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|pframe
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|abox
argument_list|)
argument_list|,
name|pframe
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|pframe
argument_list|)
expr_stmt|;
if|if
condition|(
name|preview_bpp
operator|==
literal|3
condition|)
name|preview
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_COLOR
argument_list|)
expr_stmt|;
else|else
name|preview
operator|=
name|gtk_preview_new
argument_list|(
name|GTK_PREVIEW_GRAYSCALE
argument_list|)
expr_stmt|;
name|gtk_preview_size
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|preview
argument_list|)
argument_list|,
name|preview_width
argument_list|,
name|preview_height
argument_list|)
expr_stmt|;
name|iwarp_update_preview
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|preview_width
argument_list|,
name|preview_height
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|pframe
argument_list|)
argument_list|,
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|preview
argument_list|,
name|GDK_BUTTON_PRESS_MASK
operator||
name|GDK_BUTTON_RELEASE_MASK
operator||
name|GDK_BUTTON1_MOTION_MASK
operator||
name|GDK_POINTER_MOTION_HINT_MASK
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|preview
argument_list|,
literal|"event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|iwarp_motion_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|notebook
operator|=
name|gtk_notebook_new
argument_list|()
expr_stmt|;
name|gtk_notebook_set_tab_pos
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_hbox
argument_list|)
argument_list|,
name|notebook
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|iwarp_settings_dialog
argument_list|(
name|dlg
argument_list|,
name|notebook
argument_list|)
expr_stmt|;
name|iwarp_animate_dialog
argument_list|(
name|dlg
argument_list|,
name|notebook
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|main_hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
return|return
name|wint
operator|.
name|run
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_update_preview (gint x0,gint y0,gint x1,gint y1)
name|iwarp_update_preview
parameter_list|(
name|gint
name|x0
parameter_list|,
name|gint
name|y0
parameter_list|,
name|gint
name|x1
parameter_list|,
name|gint
name|y1
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|x0
operator|=
name|MAX
argument_list|(
name|x0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|y0
operator|=
name|MAX
argument_list|(
name|y0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|x1
operator|=
name|MIN
argument_list|(
name|x1
argument_list|,
name|preview_width
argument_list|)
expr_stmt|;
name|y1
operator|=
name|MIN
argument_list|(
name|y1
argument_list|,
name|preview_height
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|y0
init|;
name|i
operator|<
name|y1
condition|;
name|i
operator|++
control|)
name|gtk_preview_draw_row
argument_list|(
name|GTK_PREVIEW
argument_list|(
name|preview
argument_list|)
argument_list|,
name|dstimage
operator|+
operator|(
name|i
operator|*
name|preview_width
operator|+
name|x0
operator|)
operator|*
name|preview_bpp
argument_list|,
name|x0
argument_list|,
name|i
argument_list|,
name|x1
operator|-
name|x0
argument_list|)
expr_stmt|;
name|gtk_widget_queue_draw_area
argument_list|(
name|preview
argument_list|,
name|x0
argument_list|,
name|y0
argument_list|,
name|x1
operator|-
name|x0
argument_list|,
name|y1
operator|-
name|y0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_preview_get_pixel (gint x,gint y,guchar ** color)
name|iwarp_preview_get_pixel
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guchar
modifier|*
modifier|*
name|color
parameter_list|)
block|{
specifier|static
name|guchar
name|black
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
operator|||
name|x
operator|>=
name|preview_width
operator|||
name|y
operator|<
literal|0
operator|||
name|y
operator|>=
name|preview_height
condition|)
block|{
operator|*
name|color
operator|=
name|black
expr_stmt|;
return|return;
block|}
operator|*
name|color
operator|=
name|srcimage
operator|+
operator|(
name|y
operator|*
name|preview_width
operator|+
name|x
operator|)
operator|*
name|image_bpp
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_preview_get_point (gdouble x,gdouble y,guchar * color)
name|iwarp_preview_get_point
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|guchar
modifier|*
name|color
parameter_list|)
block|{
name|gint
name|xi
decl_stmt|,
name|yi
decl_stmt|,
name|j
decl_stmt|;
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|m0
decl_stmt|,
name|m1
decl_stmt|;
name|guchar
modifier|*
name|p0
decl_stmt|,
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|,
modifier|*
name|p3
decl_stmt|;
name|xi
operator|=
operator|(
name|gint
operator|)
name|x
expr_stmt|;
name|yi
operator|=
operator|(
name|gint
operator|)
name|y
expr_stmt|;
if|if
condition|(
name|iwarp_vals
operator|.
name|do_bilinear
condition|)
block|{
name|dx
operator|=
name|x
operator|-
name|xi
expr_stmt|;
name|dy
operator|=
name|y
operator|-
name|yi
expr_stmt|;
name|iwarp_preview_get_pixel
argument_list|(
name|xi
argument_list|,
name|yi
argument_list|,
operator|&
name|p0
argument_list|)
expr_stmt|;
name|iwarp_preview_get_pixel
argument_list|(
name|xi
operator|+
literal|1
argument_list|,
name|yi
argument_list|,
operator|&
name|p1
argument_list|)
expr_stmt|;
name|iwarp_preview_get_pixel
argument_list|(
name|xi
argument_list|,
name|yi
operator|+
literal|1
argument_list|,
operator|&
name|p2
argument_list|)
expr_stmt|;
name|iwarp_preview_get_pixel
argument_list|(
name|xi
operator|+
literal|1
argument_list|,
name|yi
operator|+
literal|1
argument_list|,
operator|&
name|p3
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|image_bpp
condition|;
name|j
operator|++
control|)
block|{
name|m0
operator|=
name|p0
index|[
name|j
index|]
operator|+
name|dx
operator|*
operator|(
name|p1
index|[
name|j
index|]
operator|-
name|p0
index|[
name|j
index|]
operator|)
expr_stmt|;
name|m1
operator|=
name|p2
index|[
name|j
index|]
operator|+
name|dx
operator|*
operator|(
name|p3
index|[
name|j
index|]
operator|-
name|p2
index|[
name|j
index|]
operator|)
expr_stmt|;
name|color
index|[
name|j
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|m0
operator|+
name|dy
operator|*
operator|(
name|m1
operator|-
name|m0
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|iwarp_preview_get_pixel
argument_list|(
name|xi
argument_list|,
name|yi
argument_list|,
operator|&
name|p0
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|image_bpp
condition|;
name|j
operator|++
control|)
name|color
index|[
name|j
index|]
operator|=
name|p0
index|[
name|j
index|]
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_deform (gint x,int y,gdouble vx,gdouble vy)
name|iwarp_deform
parameter_list|(
name|gint
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|gdouble
name|vx
parameter_list|,
name|gdouble
name|vy
parameter_list|)
block|{
name|gint
name|xi
decl_stmt|,
name|yi
decl_stmt|,
name|ptr
decl_stmt|,
name|fptr
decl_stmt|,
name|x0
decl_stmt|,
name|x1
decl_stmt|,
name|y0
decl_stmt|,
name|y1
decl_stmt|,
name|radius2
decl_stmt|,
name|length2
decl_stmt|;
name|gdouble
name|deform_value
decl_stmt|,
name|xn
decl_stmt|,
name|yn
decl_stmt|,
name|nvx
init|=
literal|0
decl_stmt|,
name|nvy
init|=
literal|0
decl_stmt|,
name|emh
decl_stmt|,
name|em
decl_stmt|,
name|edge_width
decl_stmt|,
name|xv
decl_stmt|,
name|yv
decl_stmt|,
name|alpha
decl_stmt|;
name|guchar
name|color
index|[
literal|4
index|]
decl_stmt|;
name|x0
operator|=
operator|(
name|x
operator|<
name|iwarp_vals
operator|.
name|deform_area_radius
operator|)
condition|?
operator|-
name|x
else|:
operator|-
name|iwarp_vals
operator|.
name|deform_area_radius
expr_stmt|;
name|x1
operator|=
operator|(
name|x
operator|+
name|iwarp_vals
operator|.
name|deform_area_radius
operator|>=
name|preview_width
operator|)
condition|?
name|preview_width
operator|-
name|x
operator|-
literal|1
else|:
name|iwarp_vals
operator|.
name|deform_area_radius
expr_stmt|;
name|y0
operator|=
operator|(
name|y
operator|<
name|iwarp_vals
operator|.
name|deform_area_radius
operator|)
condition|?
operator|-
name|y
else|:
operator|-
name|iwarp_vals
operator|.
name|deform_area_radius
expr_stmt|;
name|y1
operator|=
operator|(
name|y
operator|+
name|iwarp_vals
operator|.
name|deform_area_radius
operator|>=
name|preview_height
operator|)
condition|?
name|preview_height
operator|-
name|y
operator|-
literal|1
else|:
name|iwarp_vals
operator|.
name|deform_area_radius
expr_stmt|;
name|radius2
operator|=
name|SQR
argument_list|(
name|iwarp_vals
operator|.
name|deform_area_radius
argument_list|)
expr_stmt|;
for|for
control|(
name|yi
operator|=
name|y0
init|;
name|yi
operator|<=
name|y1
condition|;
name|yi
operator|++
control|)
for|for
control|(
name|xi
operator|=
name|x0
init|;
name|xi
operator|<=
name|x1
condition|;
name|xi
operator|++
control|)
block|{
name|length2
operator|=
operator|(
name|xi
operator|*
name|xi
operator|+
name|yi
operator|*
name|yi
operator|)
operator|*
name|MAX_DEFORM_AREA_RADIUS
operator|/
name|radius2
expr_stmt|;
if|if
condition|(
name|length2
operator|<
name|MAX_DEFORM_AREA_RADIUS
condition|)
block|{
name|ptr
operator|=
operator|(
name|y
operator|+
name|yi
operator|)
operator|*
name|preview_width
operator|+
name|x
operator|+
name|xi
expr_stmt|;
name|fptr
operator|=
operator|(
name|yi
operator|+
name|iwarp_vals
operator|.
name|deform_area_radius
operator|)
operator|*
operator|(
name|iwarp_vals
operator|.
name|deform_area_radius
operator|*
literal|2
operator|+
literal|1
operator|)
operator|+
name|xi
operator|+
name|iwarp_vals
operator|.
name|deform_area_radius
expr_stmt|;
switch|switch
condition|(
name|iwarp_vals
operator|.
name|deform_mode
condition|)
block|{
case|case
name|GROW
case|:
name|deform_value
operator|=
name|filter
index|[
name|length2
index|]
operator|*
literal|0.1
operator|*
name|iwarp_vals
operator|.
name|deform_amount
expr_stmt|;
name|nvx
operator|=
operator|-
name|deform_value
operator|*
name|xi
expr_stmt|;
name|nvy
operator|=
operator|-
name|deform_value
operator|*
name|yi
expr_stmt|;
break|break;
case|case
name|SHRINK
case|:
name|deform_value
operator|=
name|filter
index|[
name|length2
index|]
operator|*
literal|0.1
operator|*
name|iwarp_vals
operator|.
name|deform_amount
expr_stmt|;
name|nvx
operator|=
name|deform_value
operator|*
name|xi
expr_stmt|;
name|nvy
operator|=
name|deform_value
operator|*
name|yi
expr_stmt|;
break|break;
case|case
name|SWIRL_CW
case|:
name|deform_value
operator|=
name|filter
index|[
name|length2
index|]
operator|*
name|iwarp_vals
operator|.
name|deform_amount
operator|*
literal|0.5
expr_stmt|;
name|nvx
operator|=
name|deform_value
operator|*
name|yi
expr_stmt|;
name|nvy
operator|=
operator|-
name|deform_value
operator|*
name|xi
expr_stmt|;
break|break;
case|case
name|SWIRL_CCW
case|:
name|deform_value
operator|=
name|filter
index|[
name|length2
index|]
operator|*
name|iwarp_vals
operator|.
name|deform_amount
operator|*
literal|0.5
expr_stmt|;
name|nvx
operator|=
operator|-
name|deform_value
operator|*
name|yi
expr_stmt|;
name|nvy
operator|=
name|deform_value
operator|*
name|xi
expr_stmt|;
break|break;
case|case
name|MOVE
case|:
name|deform_value
operator|=
name|filter
index|[
name|length2
index|]
operator|*
name|iwarp_vals
operator|.
name|deform_amount
expr_stmt|;
name|nvx
operator|=
name|deform_value
operator|*
name|vx
expr_stmt|;
name|nvy
operator|=
name|deform_value
operator|*
name|vy
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|iwarp_vals
operator|.
name|deform_mode
operator|==
name|REMOVE
condition|)
block|{
name|deform_value
operator|=
literal|1.0
operator|-
literal|0.5
operator|*
name|iwarp_vals
operator|.
name|deform_amount
operator|*
name|filter
index|[
name|length2
index|]
expr_stmt|;
name|deform_area_vectors
index|[
name|fptr
index|]
operator|.
name|x
operator|=
name|deform_value
operator|*
name|deform_vectors
index|[
name|ptr
index|]
operator|.
name|x
expr_stmt|;
name|deform_area_vectors
index|[
name|fptr
index|]
operator|.
name|y
operator|=
name|deform_value
operator|*
name|deform_vectors
index|[
name|ptr
index|]
operator|.
name|y
expr_stmt|;
block|}
else|else
block|{
name|edge_width
operator|=
literal|0.2
operator|*
name|iwarp_vals
operator|.
name|deform_area_radius
expr_stmt|;
name|emh
operator|=
name|em
operator|=
literal|1.0
expr_stmt|;
if|if
condition|(
name|x
operator|+
name|xi
operator|<
name|edge_width
condition|)
name|em
operator|=
call|(
name|gdouble
call|)
argument_list|(
name|x
operator|+
name|xi
argument_list|)
operator|/
name|edge_width
expr_stmt|;
if|if
condition|(
name|y
operator|+
name|yi
operator|<
name|edge_width
condition|)
name|emh
operator|=
call|(
name|gdouble
call|)
argument_list|(
name|y
operator|+
name|yi
argument_list|)
operator|/
name|edge_width
expr_stmt|;
if|if
condition|(
name|emh
operator|<
name|em
condition|)
name|em
operator|=
name|emh
expr_stmt|;
if|if
condition|(
name|preview_width
operator|-
name|x
operator|-
name|xi
operator|-
literal|1
operator|<
name|edge_width
condition|)
name|emh
operator|=
call|(
name|gdouble
call|)
argument_list|(
name|preview_width
operator|-
name|x
operator|-
name|xi
operator|-
literal|1
argument_list|)
operator|/
name|edge_width
expr_stmt|;
if|if
condition|(
name|emh
operator|<
name|em
condition|)
name|em
operator|=
name|emh
expr_stmt|;
if|if
condition|(
name|preview_height
operator|-
name|y
operator|-
name|yi
operator|-
literal|1
operator|<
name|edge_width
condition|)
name|emh
operator|=
call|(
name|gdouble
call|)
argument_list|(
name|preview_height
operator|-
name|y
operator|-
name|yi
operator|-
literal|1
argument_list|)
operator|/
name|edge_width
expr_stmt|;
if|if
condition|(
name|emh
operator|<
name|em
condition|)
name|em
operator|=
name|emh
expr_stmt|;
name|nvx
operator|=
name|nvx
operator|*
name|em
expr_stmt|;
name|nvy
operator|=
name|nvy
operator|*
name|em
expr_stmt|;
name|iwarp_get_deform_vector
argument_list|(
name|nvx
operator|+
name|x
operator|+
name|xi
argument_list|,
name|nvy
operator|+
name|y
operator|+
name|yi
argument_list|,
operator|&
name|xv
argument_list|,
operator|&
name|yv
argument_list|)
expr_stmt|;
name|xv
operator|=
name|nvx
operator|+
name|xv
expr_stmt|;
if|if
condition|(
name|xv
operator|+
name|x
operator|+
name|xi
operator|<
literal|0.0
condition|)
name|xv
operator|=
operator|-
name|x
operator|-
name|xi
expr_stmt|;
elseif|else
if|if
condition|(
name|xv
operator|+
name|x
operator|+
name|xi
operator|>
operator|(
name|preview_width
operator|-
literal|1
operator|)
condition|)
name|xv
operator|=
name|preview_width
operator|-
name|x
operator|-
name|xi
operator|-
literal|1
expr_stmt|;
name|yv
operator|=
name|nvy
operator|+
name|yv
expr_stmt|;
if|if
condition|(
name|yv
operator|+
name|y
operator|+
name|yi
operator|<
literal|0.0
condition|)
name|yv
operator|=
operator|-
name|y
operator|-
name|yi
expr_stmt|;
elseif|else
if|if
condition|(
name|yv
operator|+
name|y
operator|+
name|yi
operator|>
operator|(
name|preview_height
operator|-
literal|1
operator|)
condition|)
name|yv
operator|=
name|preview_height
operator|-
name|y
operator|-
name|yi
operator|-
literal|1
expr_stmt|;
name|deform_area_vectors
index|[
name|fptr
index|]
operator|.
name|x
operator|=
name|xv
expr_stmt|;
name|deform_area_vectors
index|[
name|fptr
index|]
operator|.
name|y
operator|=
name|yv
expr_stmt|;
block|}
name|xn
operator|=
name|deform_area_vectors
index|[
name|fptr
index|]
operator|.
name|x
operator|+
name|x
operator|+
name|xi
expr_stmt|;
name|yn
operator|=
name|deform_area_vectors
index|[
name|fptr
index|]
operator|.
name|y
operator|+
name|y
operator|+
name|yi
expr_stmt|;
comment|/* gcc - shut up! */
name|alpha
operator|=
literal|1
expr_stmt|;
comment|/* Yeah, it is ugly but since color is a pointer into image-data 	     * I must not change color[image_bpp - 1]  ... 	     */
if|if
condition|(
name|preserve_trans
operator|&&
operator|(
name|image_bpp
operator|==
literal|4
operator|||
name|image_bpp
operator|==
literal|2
operator|)
condition|)
block|{
name|iwarp_preview_get_point
argument_list|(
name|x
operator|+
name|xi
argument_list|,
name|y
operator|+
name|yi
argument_list|,
name|color
argument_list|)
expr_stmt|;
name|alpha
operator|=
operator|(
name|gdouble
operator|)
name|color
index|[
name|image_bpp
operator|-
literal|1
index|]
operator|/
literal|255
expr_stmt|;
block|}
name|iwarp_preview_get_point
argument_list|(
name|xn
argument_list|,
name|yn
argument_list|,
name|color
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|preserve_trans
operator|&&
operator|(
name|image_bpp
operator|==
literal|4
operator|||
name|image_bpp
operator|==
literal|2
operator|)
condition|)
block|{
name|alpha
operator|=
operator|(
name|gdouble
operator|)
name|color
index|[
name|image_bpp
operator|-
literal|1
index|]
operator|/
literal|255
expr_stmt|;
block|}
if|if
condition|(
name|preview_bpp
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|image_bpp
operator|==
literal|4
condition|)
block|{
name|dstimage
index|[
name|ptr
operator|*
literal|3
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|alpha
operator|*
name|color
index|[
literal|0
index|]
operator|+
operator|(
literal|1.0
operator|-
name|alpha
operator|)
operator|*
name|iwarp_transparent_color
argument_list|(
name|x
operator|+
name|xi
argument_list|,
name|y
operator|+
name|yi
argument_list|)
argument_list|)
expr_stmt|;
name|dstimage
index|[
name|ptr
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|alpha
operator|*
name|color
index|[
literal|1
index|]
operator|+
operator|(
literal|1.0
operator|-
name|alpha
operator|)
operator|*
name|iwarp_transparent_color
argument_list|(
name|x
operator|+
name|xi
argument_list|,
name|y
operator|+
name|yi
argument_list|)
argument_list|)
expr_stmt|;
name|dstimage
index|[
name|ptr
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|alpha
operator|*
name|color
index|[
literal|2
index|]
operator|+
operator|(
literal|1.0
operator|-
name|alpha
operator|)
operator|*
name|iwarp_transparent_color
argument_list|(
name|x
operator|+
name|xi
argument_list|,
name|y
operator|+
name|yi
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dstimage
index|[
name|ptr
operator|*
literal|3
index|]
operator|=
name|color
index|[
literal|0
index|]
expr_stmt|;
name|dstimage
index|[
name|ptr
operator|*
literal|3
operator|+
literal|1
index|]
operator|=
name|color
index|[
literal|1
index|]
expr_stmt|;
name|dstimage
index|[
name|ptr
operator|*
literal|3
operator|+
literal|2
index|]
operator|=
name|color
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|image_bpp
operator|==
literal|2
condition|)
block|{
name|dstimage
index|[
name|ptr
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|alpha
operator|*
name|color
index|[
literal|0
index|]
operator|+
operator|(
literal|1.0
operator|-
name|alpha
operator|)
operator|*
name|iwarp_transparent_color
argument_list|(
name|x
operator|+
name|xi
argument_list|,
name|y
operator|+
name|yi
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dstimage
index|[
name|ptr
index|]
operator|=
name|color
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
block|}
block|}
for|for
control|(
name|yi
operator|=
name|y0
init|;
name|yi
operator|<=
name|y1
condition|;
name|yi
operator|++
control|)
for|for
control|(
name|xi
operator|=
name|x0
init|;
name|xi
operator|<=
name|x1
condition|;
name|xi
operator|++
control|)
block|{
name|length2
operator|=
operator|(
name|xi
operator|*
name|xi
operator|+
name|yi
operator|*
name|yi
operator|)
operator|*
name|MAX_DEFORM_AREA_RADIUS
operator|/
name|radius2
expr_stmt|;
if|if
condition|(
name|length2
operator|<
name|MAX_DEFORM_AREA_RADIUS
condition|)
block|{
name|ptr
operator|=
operator|(
name|yi
operator|+
name|y
operator|)
operator|*
name|preview_width
operator|+
name|xi
operator|+
name|x
expr_stmt|;
name|fptr
operator|=
operator|(
name|yi
operator|+
name|iwarp_vals
operator|.
name|deform_area_radius
operator|)
operator|*
operator|(
name|iwarp_vals
operator|.
name|deform_area_radius
operator|*
literal|2
operator|+
literal|1
operator|)
operator|+
name|xi
operator|+
name|iwarp_vals
operator|.
name|deform_area_radius
expr_stmt|;
name|deform_vectors
index|[
name|ptr
index|]
operator|.
name|x
operator|=
name|deform_area_vectors
index|[
name|fptr
index|]
operator|.
name|x
expr_stmt|;
name|deform_vectors
index|[
name|ptr
index|]
operator|.
name|y
operator|=
name|deform_area_vectors
index|[
name|fptr
index|]
operator|.
name|y
expr_stmt|;
block|}
block|}
name|iwarp_update_preview
argument_list|(
name|x
operator|+
name|x0
argument_list|,
name|y
operator|+
name|y0
argument_list|,
name|x
operator|+
name|x1
operator|+
literal|1
argument_list|,
name|y
operator|+
name|y1
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_move (gint x,gint y,gint xx,gint yy)
name|iwarp_move
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|xx
parameter_list|,
name|gint
name|yy
parameter_list|)
block|{
name|gdouble
name|l
decl_stmt|,
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|xf
decl_stmt|,
name|yf
decl_stmt|;
name|gint
name|num
decl_stmt|,
name|i
decl_stmt|,
name|x0
decl_stmt|,
name|y0
decl_stmt|;
name|dx
operator|=
name|x
operator|-
name|xx
expr_stmt|;
name|dy
operator|=
name|y
operator|-
name|yy
expr_stmt|;
name|l
operator|=
name|sqrt
argument_list|(
name|dx
operator|*
name|dx
operator|+
name|dy
operator|*
name|dy
argument_list|)
expr_stmt|;
name|num
operator|=
call|(
name|gint
call|)
argument_list|(
name|l
operator|*
literal|2
operator|/
name|iwarp_vals
operator|.
name|deform_area_radius
argument_list|)
operator|+
literal|1
expr_stmt|;
name|dx
operator|/=
name|num
expr_stmt|;
name|dy
operator|/=
name|num
expr_stmt|;
name|xf
operator|=
name|xx
operator|+
name|dx
expr_stmt|;
name|yf
operator|=
name|yy
operator|+
name|dy
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|x0
operator|=
operator|(
name|gint
operator|)
name|xf
expr_stmt|;
name|y0
operator|=
operator|(
name|gint
operator|)
name|yf
expr_stmt|;
name|iwarp_deform
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
operator|-
name|dx
argument_list|,
operator|-
name|dy
argument_list|)
expr_stmt|;
name|xf
operator|+=
name|dx
expr_stmt|;
name|yf
operator|+=
name|dy
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_ok_callback (GtkWidget * widget,gpointer data)
name|iwarp_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|wint
operator|.
name|run
operator|=
name|TRUE
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|GTK_WIDGET
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|iwarp_motion_callback (GtkWidget * widget,GdkEvent * event)
name|iwarp_motion_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|GdkEventButton
modifier|*
name|mb
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|mb
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_BUTTON_PRESS
case|:
name|lastx
operator|=
name|mb
operator|->
name|x
expr_stmt|;
name|lasty
operator|=
name|mb
operator|->
name|y
expr_stmt|;
break|break;
case|case
name|GDK_BUTTON_RELEASE
case|:
if|if
condition|(
name|mb
operator|->
name|state
operator|&
name|GDK_BUTTON1_MASK
condition|)
block|{
name|x
operator|=
name|mb
operator|->
name|x
expr_stmt|;
name|y
operator|=
name|mb
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|iwarp_vals
operator|.
name|deform_mode
operator|==
name|MOVE
condition|)
name|iwarp_move
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|lastx
argument_list|,
name|lasty
argument_list|)
expr_stmt|;
else|else
name|iwarp_deform
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|GDK_MOTION_NOTIFY
case|:
if|if
condition|(
name|mb
operator|->
name|state
operator|&
name|GDK_BUTTON1_MASK
condition|)
block|{
name|x
operator|=
name|mb
operator|->
name|x
expr_stmt|;
name|y
operator|=
name|mb
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|iwarp_vals
operator|.
name|deform_mode
operator|==
name|MOVE
condition|)
name|iwarp_move
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|lastx
argument_list|,
name|lasty
argument_list|)
expr_stmt|;
else|else
name|iwarp_deform
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|lastx
operator|=
name|x
expr_stmt|;
name|lasty
operator|=
name|y
expr_stmt|;
name|gtk_widget_get_pointer
argument_list|(
name|widget
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|iwarp_reset_callback (GtkWidget * widget,gpointer data)
name|iwarp_reset_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|iwarp_cpy_images
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|preview_width
operator|*
name|preview_height
condition|;
name|i
operator|++
control|)
name|deform_vectors
index|[
name|i
index|]
operator|.
name|x
operator|=
name|deform_vectors
index|[
name|i
index|]
operator|.
name|y
operator|=
literal|0.0
expr_stmt|;
name|iwarp_update_preview
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|preview_width
argument_list|,
name|preview_height
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

