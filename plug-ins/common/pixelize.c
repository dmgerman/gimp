begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* The GIMP -- an image manipulation program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * Pixelize plug-in (ported to GIMP v1.0)  * Copyright (C) 1997 Eiichi Takamori<taka@ma1.seikyou.ne.jp>  * original pixelize.c for GIMP 0.54 by Tracy Scott  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/*  * version 1.04  * This version requires GIMP v0.99.10 or above.  *  * This plug-in "pixelizes" the image.  *  *	Eiichi Takamori<taka@ma1.seikyou.ne.jp>  *	http://ha1.seikyou.ne.jp/home/taka/gimp/  *  * Changes from version 1.03 to version 1.04:  * - Added gtk_rc_parse  * - Added entry with scale  * - Fixed bug that large pixelwidth>=64 sometimes caused core dump  *  * Changes from gimp-0.99.9/plug-ins/pixelize.c to version 1.03:  * - Fixed comments and help strings  * - Fixed `RGB, GRAY' to `RGB*, GRAY*'  * - Fixed procedure db name `pixelize' to `plug_in_pixelize'  *  * Differences from Tracy Scott's original `pixelize' plug-in:  *  * - Algorithm is modified to work around with the tile management.  *   The way of pixelizing is switched by the value of pixelwidth.  If  *   pixelwidth is greater than (or equal to) tile width, then this  *   plug-in makes GimpPixelRgn with that width and proceeds. Otherwise,  *   it makes the region named `PixelArea', whose size is smaller than  *   tile width and is multiply of pixel width, and acts onto it.  */
end_comment

begin_comment
comment|/* pixelize filter written for the GIMP  *  -Tracy Scott  *  * This filter acts as a low pass filter on the color components of  * the provided region  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_comment
comment|/* Some useful macros */
end_comment

begin_define
DECL|macro|PIXELIZE_PROC
define|#
directive|define
name|PIXELIZE_PROC
value|"plug-in-pixelize"
end_define

begin_define
DECL|macro|PIXELIZE2_PROC
define|#
directive|define
name|PIXELIZE2_PROC
value|"plug-in-pixelize2"
end_define

begin_define
DECL|macro|PLUG_IN_BINARY
define|#
directive|define
name|PLUG_IN_BINARY
value|"pixelize"
end_define

begin_define
DECL|macro|TILE_CACHE_SIZE
define|#
directive|define
name|TILE_CACHE_SIZE
value|16
end_define

begin_define
DECL|macro|SCALE_WIDTH
define|#
directive|define
name|SCALE_WIDTH
value|125
end_define

begin_define
DECL|macro|ENTRY_WIDTH
define|#
directive|define
name|ENTRY_WIDTH
value|6
end_define

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b4fc1ea0108
block|{
DECL|member|pixelwidth
name|gint
name|pixelwidth
decl_stmt|;
DECL|member|pixelheight
name|gint
name|pixelheight
decl_stmt|;
DECL|typedef|PixelizeValues
block|}
name|PixelizeValues
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b4fc1ea0208
block|{
DECL|member|x
DECL|member|y
DECL|member|w
DECL|member|h
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
DECL|member|width
name|gint
name|width
decl_stmt|;
DECL|member|height
name|gint
name|height
decl_stmt|;
DECL|member|data
name|guchar
modifier|*
name|data
decl_stmt|;
DECL|typedef|PixelArea
block|}
name|PixelArea
typedef|;
end_typedef

begin_comment
comment|/* Declare local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|pixelize_dialog
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|update_pixelsize
parameter_list|(
name|GimpSizeEntry
modifier|*
name|sizeentry
parameter_list|,
name|GimpPreview
modifier|*
name|preview
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pixelize
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|GimpPreview
modifier|*
name|preview
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pixelize_large
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gint
name|pixelwidth
parameter_list|,
name|gint
name|pixelheight
parameter_list|,
name|GimpPreview
modifier|*
name|preview
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pixelize_small
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gint
name|pixelwidth
parameter_list|,
name|gint
name|pixelheight
parameter_list|,
name|gint
name|tile_width
parameter_list|,
name|gint
name|tile_height
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pixelize_sub
parameter_list|(
name|gint
name|pixelwidth
parameter_list|,
name|gint
name|pixelheight
parameter_list|,
name|gint
name|bpp
parameter_list|,
name|gint
name|has_alpha
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/***** Local vars *****/
end_comment

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc  */
name|NULL
block|,
comment|/* quit_proc  */
name|query
block|,
comment|/* query_proc */
name|run
comment|/* run_proc   */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|pvals
specifier|static
name|PixelizeValues
name|pvals
init|=
block|{
literal|10
block|,
literal|10
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|area
specifier|static
name|PixelArea
name|area
decl_stmt|;
end_decl_stmt

begin_comment
comment|/***** Functions *****/
end_comment

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|GimpParamDef
name|pixelize_args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run-mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Input image (unused)"
block|}
block|,
block|{
name|GIMP_PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Input drawable"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"pixel-width"
block|,
literal|"Pixel width (the decrease in resolution)"
block|}
block|}
decl_stmt|;
specifier|static
name|GimpParamDef
name|pixelize2_args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run-mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Input image (unused)"
block|}
block|,
block|{
name|GIMP_PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Input drawable"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"pixel-width"
block|,
literal|"Pixel width (the decrease in horizontal resolution)"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"pixel-height"
block|,
literal|"Pixel height (the decrease in vertical resolution)"
block|}
block|}
decl_stmt|;
name|gimp_install_procedure
argument_list|(
name|PIXELIZE_PROC
argument_list|,
literal|"Pixelize the contents of the specified drawable"
argument_list|,
literal|"Pixelize the contents of the specified drawable "
literal|"with speficied pixelizing width."
argument_list|,
literal|"Spencer Kimball& Peter Mattis, Tracy Scott, "
literal|"(ported to 1.0 by) Eiichi Takamori"
argument_list|,
literal|"Spencer Kimball& Peter Mattis, Tracy Scott"
argument_list|,
literal|"1995"
argument_list|,
name|N_
argument_list|(
literal|"_Pixelize..."
argument_list|)
argument_list|,
literal|"RGB*, GRAY*"
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|pixelize_args
argument_list|)
argument_list|,
literal|0
argument_list|,
name|pixelize_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_plugin_menu_register
argument_list|(
name|PIXELIZE_PROC
argument_list|,
literal|"<Image>/Filters/Blur"
argument_list|)
expr_stmt|;
name|gimp_install_procedure
argument_list|(
name|PIXELIZE2_PROC
argument_list|,
literal|"Pixelize the contents of the specified drawable"
argument_list|,
literal|"Pixelize the contents of the specified drawable "
literal|"with speficied pixelizing width."
argument_list|,
literal|"Spencer Kimball& Peter Mattis, Tracy Scott, "
literal|"(ported to 1.0 by) Eiichi Takamori"
argument_list|,
literal|"Spencer Kimball& Peter Mattis, Tracy Scott"
argument_list|,
literal|"2001"
argument_list|,
name|NULL
argument_list|,
literal|"RGB*, GRAY*"
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|pixelize2_args
argument_list|)
argument_list|,
literal|0
argument_list|,
name|pixelize2_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GimpParam
name|values
index|[
literal|1
index|]
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|GimpRunMode
name|run_mode
decl_stmt|;
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
comment|/*  Get the specified drawable  */
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|GIMP_RUN_INTERACTIVE
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
name|PIXELIZE_PROC
argument_list|,
operator|&
name|pvals
argument_list|)
expr_stmt|;
comment|/*  First acquire information with a dialog  */
if|if
condition|(
operator|!
name|pixelize_dialog
argument_list|(
name|drawable
argument_list|)
condition|)
block|{
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|GIMP_RUN_NONINTERACTIVE
case|:
comment|/*  Make sure all the arguments are there!  */
if|if
condition|(
operator|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
name|PIXELIZE_PROC
argument_list|)
operator|&&
name|nparams
operator|!=
literal|4
operator|)
operator|||
operator|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
name|PIXELIZE2_PROC
argument_list|)
operator|&&
name|nparams
operator|!=
literal|5
operator|)
condition|)
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
block|{
name|pvals
operator|.
name|pixelwidth
operator|=
operator|(
name|gdouble
operator|)
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
if|if
condition|(
name|nparams
operator|==
literal|4
condition|)
name|pvals
operator|.
name|pixelheight
operator|=
name|pvals
operator|.
name|pixelwidth
expr_stmt|;
else|else
name|pvals
operator|.
name|pixelheight
operator|=
operator|(
name|gdouble
operator|)
name|param
index|[
literal|4
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
operator|)
operator|&&
operator|(
name|pvals
operator|.
name|pixelwidth
operator|<=
literal|0
operator|||
name|pvals
operator|.
name|pixelheight
operator|<=
literal|0
operator|)
condition|)
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
break|break;
case|case
name|GIMP_RUN_WITH_LAST_VALS
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
name|PIXELIZE_PROC
argument_list|,
operator|&
name|pvals
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
block|{
comment|/*  Make sure that the drawable is gray or RGB color  */
if|if
condition|(
name|gimp_drawable_is_rgb
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
operator|||
name|gimp_drawable_is_gray
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
condition|)
block|{
name|gimp_progress_init
argument_list|(
name|_
argument_list|(
literal|"Pixelizing..."
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  set the tile cache size  */
name|gimp_tile_cache_ntiles
argument_list|(
name|TILE_CACHE_SIZE
argument_list|)
expr_stmt|;
comment|/*  run the pixelize effect  */
name|pixelize
argument_list|(
name|drawable
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|run_mode
operator|!=
name|GIMP_RUN_NONINTERACTIVE
condition|)
name|gimp_displays_flush
argument_list|()
expr_stmt|;
comment|/*  Store data  */
if|if
condition|(
name|run_mode
operator|==
name|GIMP_RUN_INTERACTIVE
condition|)
name|gimp_set_data
argument_list|(
name|PIXELIZE_PROC
argument_list|,
operator|&
name|pvals
argument_list|,
sizeof|sizeof
argument_list|(
name|PixelizeValues
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* g_message ("pixelize: cannot operate on indexed color images"); */
name|status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
block|}
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|pixelize_dialog (GimpDrawable * drawable)
name|pixelize_dialog
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|GtkWidget
modifier|*
name|main_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|preview
decl_stmt|;
name|GtkWidget
modifier|*
name|sizeentry
decl_stmt|;
name|guint32
name|image_id
decl_stmt|;
name|GimpUnit
name|unit
decl_stmt|;
name|gdouble
name|xres
decl_stmt|,
name|yres
decl_stmt|;
name|gboolean
name|run
decl_stmt|;
name|gimp_ui_init
argument_list|(
name|PLUG_IN_BINARY
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|dialog
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Pixelize"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PIXELIZE_PROC
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|GTK_STOCK_OK
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gimp_window_set_transient
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dialog
argument_list|)
argument_list|)
expr_stmt|;
name|main_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|main_vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|main_vbox
argument_list|)
expr_stmt|;
name|preview
operator|=
name|gimp_drawable_preview_new
argument_list|(
name|drawable
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start_defaults
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|preview
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|preview
argument_list|,
literal|"invalidated"
argument_list|,
name|G_CALLBACK
argument_list|(
name|pixelize
argument_list|)
argument_list|,
name|drawable
argument_list|)
expr_stmt|;
name|image_id
operator|=
name|gimp_drawable_get_image
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
expr_stmt|;
name|unit
operator|=
name|gimp_image_get_unit
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|gimp_image_get_resolution
argument_list|(
name|image_id
argument_list|,
operator|&
name|xres
argument_list|,
operator|&
name|yres
argument_list|)
expr_stmt|;
name|sizeentry
operator|=
name|gimp_coordinates_new
argument_list|(
name|unit
argument_list|,
literal|"%a"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|ENTRY_WIDTH
argument_list|,
name|GIMP_SIZE_ENTRY_UPDATE_SIZE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"Pixel _width:"
argument_list|)
argument_list|,
name|pvals
operator|.
name|pixelwidth
argument_list|,
name|xres
argument_list|,
literal|1
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
literal|1
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|_
argument_list|(
literal|"Pixel _height:"
argument_list|)
argument_list|,
name|pvals
operator|.
name|pixelheight
argument_list|,
name|yres
argument_list|,
literal|1
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
literal|1
argument_list|,
name|drawable
operator|->
name|height
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|sizeentry
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|sizeentry
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|sizeentry
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|update_pixelsize
argument_list|)
argument_list|,
name|preview
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|sizeentry
argument_list|,
literal|"refval-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|update_pixelsize
argument_list|)
argument_list|,
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|run
operator|=
operator|(
name|gimp_dialog_run
argument_list|(
name|GIMP_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|)
operator|==
name|GTK_RESPONSE_OK
operator|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
return|return
name|run
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|update_pixelsize (GimpSizeEntry * sizeentry,GimpPreview * preview)
name|update_pixelsize
parameter_list|(
name|GimpSizeEntry
modifier|*
name|sizeentry
parameter_list|,
name|GimpPreview
modifier|*
name|preview
parameter_list|)
block|{
name|pvals
operator|.
name|pixelwidth
operator|=
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pvals
operator|.
name|pixelheight
operator|=
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gimp_preview_invalidate
argument_list|(
name|preview
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   Pixelize Effect  */
end_comment

begin_function
specifier|static
name|void
DECL|function|pixelize (GimpDrawable * drawable,GimpPreview * preview)
name|pixelize
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|GimpPreview
modifier|*
name|preview
parameter_list|)
block|{
name|gint
name|tile_width
decl_stmt|;
name|gint
name|tile_height
decl_stmt|;
name|gint
name|pixelwidth
decl_stmt|;
name|gint
name|pixelheight
decl_stmt|;
name|tile_width
operator|=
name|gimp_tile_width
argument_list|()
expr_stmt|;
name|tile_height
operator|=
name|gimp_tile_height
argument_list|()
expr_stmt|;
name|pixelwidth
operator|=
name|pvals
operator|.
name|pixelwidth
expr_stmt|;
name|pixelheight
operator|=
name|pvals
operator|.
name|pixelheight
expr_stmt|;
if|if
condition|(
name|pixelwidth
operator|<
literal|0
condition|)
name|pixelwidth
operator|=
operator|-
name|pixelwidth
expr_stmt|;
if|if
condition|(
name|pixelwidth
operator|<
literal|1
condition|)
name|pixelwidth
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pixelheight
operator|<
literal|0
condition|)
name|pixelheight
operator|=
operator|-
name|pixelheight
expr_stmt|;
if|if
condition|(
name|pixelheight
operator|<
literal|1
condition|)
name|pixelheight
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pixelwidth
operator|>=
name|tile_width
operator|||
name|pixelheight
operator|>=
name|tile_height
operator|||
name|preview
condition|)
name|pixelize_large
argument_list|(
name|drawable
argument_list|,
name|pixelwidth
argument_list|,
name|pixelheight
argument_list|,
name|preview
argument_list|)
expr_stmt|;
else|else
name|pixelize_small
argument_list|(
name|drawable
argument_list|,
name|pixelwidth
argument_list|,
name|pixelheight
argument_list|,
name|tile_width
argument_list|,
name|tile_height
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   This function operates on the image when pixelwidth>= tile_width.   It simply sets the size of GimpPixelRgn as pixelwidth and proceeds.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|pixelize_large (GimpDrawable * drawable,gint pixelwidth,gint pixelheight,GimpPreview * preview)
name|pixelize_large
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gint
name|pixelwidth
parameter_list|,
name|gint
name|pixelheight
parameter_list|,
name|GimpPreview
modifier|*
name|preview
parameter_list|)
block|{
name|GimpPixelRgn
name|src_rgn
decl_stmt|,
name|dest_rgn
decl_stmt|;
name|guchar
modifier|*
name|src_row
decl_stmt|,
modifier|*
name|dest_row
decl_stmt|;
name|guchar
modifier|*
name|src
decl_stmt|,
modifier|*
name|dest
init|=
name|NULL
decl_stmt|,
modifier|*
name|d
decl_stmt|;
name|gulong
name|average
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|row
decl_stmt|,
name|col
decl_stmt|,
name|b
decl_stmt|,
name|bpp
decl_stmt|,
name|has_alpha
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|x_step
decl_stmt|,
name|y_step
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|gulong
name|count
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gint
name|progress
init|=
literal|0
decl_stmt|,
name|max_progress
init|=
literal|1
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
name|bpp
operator|=
name|gimp_drawable_bpp
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
expr_stmt|;
name|has_alpha
operator|=
name|gimp_drawable_has_alpha
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|preview
condition|)
block|{
name|gimp_preview_get_position
argument_list|(
name|preview
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|)
expr_stmt|;
name|gimp_preview_get_size
argument_list|(
name|preview
argument_list|,
operator|&
name|width
argument_list|,
operator|&
name|height
argument_list|)
expr_stmt|;
name|x2
operator|=
name|x1
operator|+
name|width
expr_stmt|;
name|y2
operator|=
name|y1
operator|+
name|height
expr_stmt|;
name|dest
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|width
operator|*
name|height
operator|*
name|bpp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_drawable_mask_bounds
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|)
expr_stmt|;
name|width
operator|=
name|x2
operator|-
name|x1
expr_stmt|;
name|height
operator|=
name|y2
operator|-
name|y1
expr_stmt|;
comment|/* Initialize progress */
name|progress
operator|=
literal|0
expr_stmt|;
name|max_progress
operator|=
literal|2
operator|*
name|width
operator|*
name|height
expr_stmt|;
block|}
for|for
control|(
name|y
operator|=
name|y1
init|;
name|y
operator|<
name|y2
condition|;
name|y
operator|+=
name|pixelheight
operator|-
operator|(
name|y
operator|%
name|pixelheight
operator|)
control|)
block|{
for|for
control|(
name|x
operator|=
name|x1
init|;
name|x
operator|<
name|x2
condition|;
name|x
operator|+=
name|pixelwidth
operator|-
operator|(
name|x
operator|%
name|pixelwidth
operator|)
control|)
block|{
name|x_step
operator|=
name|pixelwidth
operator|-
operator|(
name|x
operator|%
name|pixelwidth
operator|)
expr_stmt|;
name|y_step
operator|=
name|pixelheight
operator|-
operator|(
name|y
operator|%
name|pixelheight
operator|)
expr_stmt|;
name|x_step
operator|=
name|MIN
argument_list|(
name|x_step
argument_list|,
name|x2
operator|-
name|x
argument_list|)
expr_stmt|;
name|y_step
operator|=
name|MIN
argument_list|(
name|y_step
argument_list|,
name|y2
operator|-
name|y
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|drawable
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x_step
argument_list|,
name|y_step
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bpp
condition|;
name|b
operator|++
control|)
name|average
index|[
name|b
index|]
operator|=
literal|0
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|gimp_pixel_rgns_register
argument_list|(
literal|1
argument_list|,
operator|&
name|src_rgn
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|gimp_pixel_rgns_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
name|src_row
operator|=
name|src_rgn
operator|.
name|data
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|src_rgn
operator|.
name|h
condition|;
name|row
operator|++
control|)
block|{
name|src
operator|=
name|src_row
expr_stmt|;
if|if
condition|(
name|has_alpha
condition|)
block|{
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|src_rgn
operator|.
name|w
condition|;
name|col
operator|++
control|)
block|{
name|gulong
name|alpha
init|=
name|src
index|[
name|bpp
operator|-
literal|1
index|]
decl_stmt|;
name|average
index|[
name|bpp
operator|-
literal|1
index|]
operator|+=
name|alpha
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bpp
operator|-
literal|1
condition|;
name|b
operator|++
control|)
name|average
index|[
name|b
index|]
operator|+=
name|src
index|[
name|b
index|]
operator|*
name|alpha
expr_stmt|;
name|src
operator|+=
name|src_rgn
operator|.
name|bpp
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|src_rgn
operator|.
name|w
condition|;
name|col
operator|++
control|)
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bpp
condition|;
name|b
operator|++
control|)
name|average
index|[
name|b
index|]
operator|+=
name|src
index|[
name|b
index|]
expr_stmt|;
name|src
operator|+=
name|src_rgn
operator|.
name|bpp
expr_stmt|;
block|}
block|}
name|src_row
operator|+=
name|src_rgn
operator|.
name|rowstride
expr_stmt|;
block|}
name|count
operator|+=
name|src_rgn
operator|.
name|w
operator|*
name|src_rgn
operator|.
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|preview
condition|)
block|{
comment|/* Update progress */
name|progress
operator|+=
name|src_rgn
operator|.
name|w
operator|*
name|src_rgn
operator|.
name|h
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|has_alpha
condition|)
block|{
name|gulong
name|alpha
init|=
name|average
index|[
name|bpp
operator|-
literal|1
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|average
index|[
name|bpp
operator|-
literal|1
index|]
operator|=
name|alpha
operator|/
name|count
operator|)
condition|)
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bpp
operator|-
literal|1
condition|;
name|b
operator|++
control|)
name|average
index|[
name|b
index|]
operator|/=
name|alpha
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bpp
condition|;
name|b
operator|++
control|)
name|average
index|[
name|b
index|]
operator|/=
name|count
expr_stmt|;
block|}
block|}
if|if
condition|(
name|preview
condition|)
block|{
name|dest_row
operator|=
name|dest
operator|+
operator|(
operator|(
name|y
operator|-
name|y1
operator|)
operator|*
name|width
operator|+
operator|(
name|x
operator|-
name|x1
operator|)
operator|)
operator|*
name|bpp
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|y_step
condition|;
name|j
operator|++
control|)
block|{
name|d
operator|=
name|dest_row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|x_step
condition|;
name|i
operator|++
control|)
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bpp
condition|;
name|b
operator|++
control|)
operator|*
name|d
operator|++
operator|=
name|average
index|[
name|b
index|]
expr_stmt|;
name|dest_row
operator|+=
name|width
operator|*
name|bpp
expr_stmt|;
block|}
block|}
else|else
block|{
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|dest_rgn
argument_list|,
name|drawable
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x_step
argument_list|,
name|y_step
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|gimp_pixel_rgns_register
argument_list|(
literal|1
argument_list|,
operator|&
name|dest_rgn
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|gimp_pixel_rgns_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
name|dest_row
operator|=
name|dest_rgn
operator|.
name|data
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|dest_rgn
operator|.
name|h
condition|;
name|row
operator|++
control|)
block|{
name|dest
operator|=
name|dest_row
expr_stmt|;
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|dest_rgn
operator|.
name|w
condition|;
name|col
operator|++
control|)
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|bpp
condition|;
name|b
operator|++
control|)
name|dest
index|[
name|b
index|]
operator|=
name|average
index|[
name|b
index|]
expr_stmt|;
name|dest
operator|+=
name|dest_rgn
operator|.
name|bpp
expr_stmt|;
block|}
name|dest_row
operator|+=
name|dest_rgn
operator|.
name|rowstride
expr_stmt|;
block|}
comment|/* Update progress */
name|progress
operator|+=
name|dest_rgn
operator|.
name|w
operator|*
name|dest_rgn
operator|.
name|h
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|preview
condition|)
block|{
name|gimp_preview_draw_buffer
argument_list|(
name|preview
argument_list|,
name|dest
argument_list|,
name|width
operator|*
name|bpp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dest
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*  update the blurred region	 */
name|gimp_drawable_flush
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_merge_shadow
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_update
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*    This function operates on PixelArea, whose width and height are    multiply of pixel width, and less than the tile size (to enhance    its speed).     If any coordinates of mask boundary is not multiply of pixel width    (e.g.  x1 % pixelwidth != 0), operates on the region whose width    or height is the remainder.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|pixelize_small (GimpDrawable * drawable,gint pixelwidth,gint pixelheight,gint tile_width,gint tile_height)
name|pixelize_small
parameter_list|(
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gint
name|pixelwidth
parameter_list|,
name|gint
name|pixelheight
parameter_list|,
name|gint
name|tile_width
parameter_list|,
name|gint
name|tile_height
parameter_list|)
block|{
name|GimpPixelRgn
name|src_rgn
decl_stmt|,
name|dest_rgn
decl_stmt|;
name|gint
name|bpp
decl_stmt|,
name|has_alpha
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gint
name|progress
decl_stmt|,
name|max_progress
decl_stmt|;
name|gimp_drawable_mask_bounds
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|drawable
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
operator|-
name|x1
argument_list|,
name|y2
operator|-
name|y1
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|dest_rgn
argument_list|,
name|drawable
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
operator|-
name|x1
argument_list|,
name|y2
operator|-
name|y1
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* Initialize progress */
name|progress
operator|=
literal|0
expr_stmt|;
name|max_progress
operator|=
operator|(
name|x2
operator|-
name|x1
operator|)
operator|*
operator|(
name|y2
operator|-
name|y1
operator|)
expr_stmt|;
name|bpp
operator|=
name|drawable
operator|->
name|bpp
expr_stmt|;
name|has_alpha
operator|=
name|gimp_drawable_has_alpha
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
expr_stmt|;
name|area
operator|.
name|width
operator|=
operator|(
name|tile_width
operator|/
name|pixelwidth
operator|)
operator|*
name|pixelwidth
expr_stmt|;
name|area
operator|.
name|height
operator|=
operator|(
name|tile_height
operator|/
name|pixelheight
operator|)
operator|*
name|pixelheight
expr_stmt|;
name|area
operator|.
name|data
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
operator|(
name|glong
operator|)
name|bpp
operator|*
name|area
operator|.
name|width
operator|*
name|area
operator|.
name|height
argument_list|)
expr_stmt|;
for|for
control|(
name|area
operator|.
name|y
operator|=
name|y1
init|;
name|area
operator|.
name|y
operator|<
name|y2
condition|;
name|area
operator|.
name|y
operator|+=
name|area
operator|.
name|height
operator|-
operator|(
name|area
operator|.
name|y
operator|%
name|area
operator|.
name|height
operator|)
control|)
block|{
name|area
operator|.
name|h
operator|=
name|area
operator|.
name|height
operator|-
operator|(
name|area
operator|.
name|y
operator|%
name|area
operator|.
name|height
operator|)
expr_stmt|;
name|area
operator|.
name|h
operator|=
name|MIN
argument_list|(
name|area
operator|.
name|h
argument_list|,
name|y2
operator|-
name|area
operator|.
name|y
argument_list|)
expr_stmt|;
for|for
control|(
name|area
operator|.
name|x
operator|=
name|x1
init|;
name|area
operator|.
name|x
operator|<
name|x2
condition|;
name|area
operator|.
name|x
operator|+=
name|area
operator|.
name|width
operator|-
operator|(
name|area
operator|.
name|x
operator|%
name|area
operator|.
name|width
operator|)
control|)
block|{
name|area
operator|.
name|w
operator|=
name|area
operator|.
name|width
operator|-
operator|(
name|area
operator|.
name|x
operator|%
name|area
operator|.
name|width
operator|)
expr_stmt|;
name|area
operator|.
name|w
operator|=
name|MIN
argument_list|(
name|area
operator|.
name|w
argument_list|,
name|x2
operator|-
name|area
operator|.
name|x
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_get_rect
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|area
operator|.
name|data
argument_list|,
name|area
operator|.
name|x
argument_list|,
name|area
operator|.
name|y
argument_list|,
name|area
operator|.
name|w
argument_list|,
name|area
operator|.
name|h
argument_list|)
expr_stmt|;
name|pixelize_sub
argument_list|(
name|pixelwidth
argument_list|,
name|pixelheight
argument_list|,
name|bpp
argument_list|,
name|has_alpha
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_set_rect
argument_list|(
operator|&
name|dest_rgn
argument_list|,
name|area
operator|.
name|data
argument_list|,
name|area
operator|.
name|x
argument_list|,
name|area
operator|.
name|y
argument_list|,
name|area
operator|.
name|w
argument_list|,
name|area
operator|.
name|h
argument_list|)
expr_stmt|;
comment|/* Update progress */
name|progress
operator|+=
name|area
operator|.
name|w
operator|*
name|area
operator|.
name|h
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
name|g_free
argument_list|(
name|area
operator|.
name|data
argument_list|)
expr_stmt|;
comment|/*  update the pixelized region  */
name|gimp_drawable_flush
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_merge_shadow
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_update
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   This function acts on one PixelArea.	Since there were so many   nested FORs in pixelize_small(), I put a few of them here...   */
end_comment

begin_function
specifier|static
name|void
DECL|function|pixelize_sub (gint pixelwidth,gint pixelheight,gint bpp,gint has_alpha)
name|pixelize_sub
parameter_list|(
name|gint
name|pixelwidth
parameter_list|,
name|gint
name|pixelheight
parameter_list|,
name|gint
name|bpp
parameter_list|,
name|gint
name|has_alpha
parameter_list|)
block|{
name|gulong
name|average
index|[
literal|4
index|]
decl_stmt|;
comment|/* bpp<= 4 */
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|guchar
modifier|*
name|buf_row
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|gint
name|row
decl_stmt|,
name|col
decl_stmt|;
name|gint
name|rowstride
decl_stmt|;
name|gint
name|count
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|rowstride
operator|=
name|area
operator|.
name|w
operator|*
name|bpp
expr_stmt|;
for|for
control|(
name|y
operator|=
name|area
operator|.
name|y
init|;
name|y
operator|<
name|area
operator|.
name|y
operator|+
name|area
operator|.
name|h
condition|;
name|y
operator|+=
name|pixelheight
operator|-
operator|(
name|y
operator|%
name|pixelheight
operator|)
control|)
block|{
name|h
operator|=
name|pixelheight
operator|-
operator|(
name|y
operator|%
name|pixelheight
operator|)
expr_stmt|;
name|h
operator|=
name|MIN
argument_list|(
name|h
argument_list|,
name|area
operator|.
name|y
operator|+
name|area
operator|.
name|h
operator|-
name|y
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
name|area
operator|.
name|x
init|;
name|x
operator|<
name|area
operator|.
name|x
operator|+
name|area
operator|.
name|w
condition|;
name|x
operator|+=
name|pixelwidth
operator|-
operator|(
name|x
operator|%
name|pixelwidth
operator|)
control|)
block|{
name|w
operator|=
name|pixelwidth
operator|-
operator|(
name|x
operator|%
name|pixelwidth
operator|)
expr_stmt|;
name|w
operator|=
name|MIN
argument_list|(
name|w
argument_list|,
name|area
operator|.
name|x
operator|+
name|area
operator|.
name|w
operator|-
name|x
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bpp
condition|;
name|i
operator|++
control|)
name|average
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
comment|/* Read */
name|buf_row
operator|=
name|area
operator|.
name|data
operator|+
operator|(
name|y
operator|-
name|area
operator|.
name|y
operator|)
operator|*
name|rowstride
operator|+
operator|(
name|x
operator|-
name|area
operator|.
name|x
operator|)
operator|*
name|bpp
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|h
condition|;
name|row
operator|++
control|)
block|{
name|buf
operator|=
name|buf_row
expr_stmt|;
if|if
condition|(
name|has_alpha
condition|)
block|{
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|w
condition|;
name|col
operator|++
control|)
block|{
name|gulong
name|alpha
init|=
name|buf
index|[
name|bpp
operator|-
literal|1
index|]
decl_stmt|;
name|average
index|[
name|bpp
operator|-
literal|1
index|]
operator|+=
name|alpha
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bpp
operator|-
literal|1
condition|;
name|i
operator|++
control|)
name|average
index|[
name|i
index|]
operator|+=
name|buf
index|[
name|i
index|]
operator|*
name|alpha
expr_stmt|;
name|buf
operator|+=
name|bpp
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|w
condition|;
name|col
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bpp
condition|;
name|i
operator|++
control|)
name|average
index|[
name|i
index|]
operator|+=
name|buf
index|[
name|i
index|]
expr_stmt|;
name|buf
operator|+=
name|bpp
expr_stmt|;
block|}
block|}
name|buf_row
operator|+=
name|rowstride
expr_stmt|;
block|}
name|count
operator|+=
name|w
operator|*
name|h
expr_stmt|;
comment|/* Average */
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|has_alpha
condition|)
block|{
name|gulong
name|alpha
init|=
name|average
index|[
name|bpp
operator|-
literal|1
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|average
index|[
name|bpp
operator|-
literal|1
index|]
operator|=
name|alpha
operator|/
name|count
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bpp
operator|-
literal|1
condition|;
name|i
operator|++
control|)
name|average
index|[
name|i
index|]
operator|/=
name|alpha
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bpp
condition|;
name|i
operator|++
control|)
name|average
index|[
name|i
index|]
operator|/=
name|count
expr_stmt|;
block|}
block|}
comment|/* Write */
name|buf_row
operator|=
name|area
operator|.
name|data
operator|+
operator|(
name|y
operator|-
name|area
operator|.
name|y
operator|)
operator|*
name|rowstride
operator|+
operator|(
name|x
operator|-
name|area
operator|.
name|x
operator|)
operator|*
name|bpp
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|h
condition|;
name|row
operator|++
control|)
block|{
name|buf
operator|=
name|buf_row
expr_stmt|;
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|w
condition|;
name|col
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bpp
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
name|average
index|[
name|i
index|]
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|buf
operator|+=
name|bpp
expr_stmt|;
block|}
name|buf_row
operator|+=
name|rowstride
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

end_unit

