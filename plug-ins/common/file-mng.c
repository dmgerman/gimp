begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * Multiple-image Network Graphics (MNG) plug-in  *  * Copyright (C) 2002 Mukund Sivaraman<muks@mukund.org>  * Portions are copyright of the authors of the file-gif-save, file-png-save  * and file-jpeg-save plug-ins' code. The exact ownership of these code  * fragments has not been determined.  *  * This work was sponsored by Xinit Systems Limited, UK.  * http://www.xinitsystems.com/  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  * --  *  * For now, this MNG plug-in can only save images. It cannot load images.  * Save your working copy as .xcf and use this for "exporting" your images  * to MNG. Supports animation the same way as animated GIFs. Supports alpha  * transparency. Uses the libmng library (http://www.libmng.com/).  * The MIME content-type for MNG images is video/x-mng for now. Make sure  * your web-server is configured appropriately if you want to serve MNG  * images.  *  * Since libmng cannot write PNG, JNG and delta PNG chunks at this time  * (when this text was written), this plug-in uses libpng and jpeglib to  * create the data for the chunks.  *  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* libpng and jpeglib are currently used in this plug-in. */
end_comment

begin_include
include|#
directive|include
file|<png.h>
end_include

begin_include
include|#
directive|include
file|<jpeglib.h>
end_include

begin_comment
comment|/* Grrr. The grrr is because the following have to be defined  * by the application as well for some reason, although they  * were enabled when libmng was compiled. The authors of libmng  * must look into this. */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_SUPPORT_FULL
argument_list|)
end_if

begin_define
DECL|macro|MNG_SUPPORT_FULL
define|#
directive|define
name|MNG_SUPPORT_FULL
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_SUPPORT_READ
argument_list|)
end_if

begin_define
DECL|macro|MNG_SUPPORT_READ
define|#
directive|define
name|MNG_SUPPORT_READ
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_SUPPORT_WRITE
argument_list|)
end_if

begin_define
DECL|macro|MNG_SUPPORT_WRITE
define|#
directive|define
name|MNG_SUPPORT_WRITE
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_SUPPORT_DISPLAY
argument_list|)
end_if

begin_define
DECL|macro|MNG_SUPPORT_DISPLAY
define|#
directive|define
name|MNG_SUPPORT_DISPLAY
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MNG_ACCESS_CHUNKS
argument_list|)
end_if

begin_define
DECL|macro|MNG_ACCESS_CHUNKS
define|#
directive|define
name|MNG_ACCESS_CHUNKS
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<libmng.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/gimp.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpui.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_define
DECL|macro|SAVE_PROC
define|#
directive|define
name|SAVE_PROC
value|"file-mng-save"
end_define

begin_define
DECL|macro|PLUG_IN_BINARY
define|#
directive|define
name|PLUG_IN_BINARY
value|"file-mng"
end_define

begin_define
DECL|macro|PLUG_IN_ROLE
define|#
directive|define
name|PLUG_IN_ROLE
value|"gimp-file-mng"
end_define

begin_define
DECL|macro|SCALE_WIDTH
define|#
directive|define
name|SCALE_WIDTH
value|125
end_define

begin_enum
enum|enum
DECL|enum|__anon28ecd98f0103
block|{
DECL|enumerator|CHUNKS_PNG_D
name|CHUNKS_PNG_D
block|,
DECL|enumerator|CHUNKS_JNG_D
name|CHUNKS_JNG_D
block|,
DECL|enumerator|CHUNKS_PNG
name|CHUNKS_PNG
block|,
DECL|enumerator|CHUNKS_JNG
name|CHUNKS_JNG
block|}
enum|;
end_enum

begin_enum
enum|enum
DECL|enum|__anon28ecd98f0203
block|{
DECL|enumerator|DISPOSE_COMBINE
name|DISPOSE_COMBINE
block|,
DECL|enumerator|DISPOSE_REPLACE
name|DISPOSE_REPLACE
block|}
enum|;
end_enum

begin_comment
comment|/* The contents of this struct remain static among multiple  * invocations of the plug-in. */
end_comment

begin_comment
comment|/* TODO: describe the members of the struct */
end_comment

begin_struct
DECL|struct|mng_data_t
struct|struct
name|mng_data_t
block|{
DECL|member|interlaced
name|gint32
name|interlaced
decl_stmt|;
DECL|member|bkgd
name|gint32
name|bkgd
decl_stmt|;
DECL|member|gama
name|gint32
name|gama
decl_stmt|;
DECL|member|phys
name|gint32
name|phys
decl_stmt|;
DECL|member|time
name|gint32
name|time
decl_stmt|;
DECL|member|default_chunks
name|gint32
name|default_chunks
decl_stmt|;
DECL|member|quality
name|gfloat
name|quality
decl_stmt|;
DECL|member|smoothing
name|gfloat
name|smoothing
decl_stmt|;
DECL|member|compression_level
name|gint32
name|compression_level
decl_stmt|;
DECL|member|loop
name|gint32
name|loop
decl_stmt|;
DECL|member|default_delay
name|gint32
name|default_delay
decl_stmt|;
DECL|member|default_dispose
name|gint32
name|default_dispose
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Values of the instance of the above struct when the plug-in is  * first invoked. */
end_comment

begin_decl_stmt
DECL|variable|mng_data
specifier|static
name|struct
name|mng_data_t
name|mng_data
init|=
block|{
name|FALSE
block|,
comment|/* interlaced */
name|FALSE
block|,
comment|/* bkgd */
name|FALSE
block|,
comment|/* gama */
name|TRUE
block|,
comment|/* phys */
name|TRUE
block|,
comment|/* time */
name|CHUNKS_PNG_D
block|,
comment|/* default_chunks */
literal|0.75
block|,
comment|/* quality */
literal|0.0
block|,
comment|/* smoothing */
literal|9
block|,
comment|/* compression_level */
name|TRUE
block|,
comment|/* loop */
literal|100
block|,
comment|/* default_delay */
name|DISPOSE_COMBINE
comment|/* default_dispose */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The output FILE pointer which is used by libmng;  * passed around as user data. */
end_comment

begin_struct
DECL|struct|mnglib_userdata_t
struct|struct
name|mnglib_userdata_t
block|{
DECL|member|fp
name|FILE
modifier|*
name|fp
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Function prototypes  */
end_comment

begin_function_decl
specifier|static
name|mng_ptr
name|myalloc
parameter_list|(
name|mng_size_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|myfree
parameter_list|(
name|mng_ptr
name|ptr
parameter_list|,
name|mng_size_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|mng_bool
name|myopenstream
parameter_list|(
name|mng_handle
name|handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|mng_bool
name|myclosestream
parameter_list|(
name|mng_handle
name|handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|mng_bool
name|mywritedata
parameter_list|(
name|mng_handle
name|handle
parameter_list|,
name|mng_ptr
name|buf
parameter_list|,
name|mng_uint32
name|size
parameter_list|,
name|mng_uint32
modifier|*
name|written_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|parse_chunks_type_from_layer_name
parameter_list|(
specifier|const
name|gchar
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|parse_disposal_type_from_layer_name
parameter_list|(
specifier|const
name|gchar
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint32
name|parse_ms_tag_from_layer_name
parameter_list|(
specifier|const
name|gchar
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|find_unused_ia_colour
parameter_list|(
name|guchar
modifier|*
name|pixels
parameter_list|,
name|gint
name|numpixels
parameter_list|,
name|gint
modifier|*
name|colors
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|ia_has_transparent_pixels
parameter_list|(
name|guchar
modifier|*
name|pixels
parameter_list|,
name|gint
name|numpixels
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|respin_cmap
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_infop
name|png_info_ptr
parameter_list|,
name|guchar
modifier|*
name|remap
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|mng_save_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|,
name|gint32
name|original_image_id
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|mng_save_dialog
parameter_list|(
name|gint32
name|image_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Callbacks for libmng  */
end_comment

begin_function
specifier|static
name|mng_ptr
DECL|function|myalloc (mng_size_t size)
name|myalloc
parameter_list|(
name|mng_size_t
name|size
parameter_list|)
block|{
name|gpointer
name|ptr
decl_stmt|;
name|ptr
operator|=
name|g_try_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|!=
name|NULL
condition|)
name|memset
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|mng_ptr
operator|)
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|myfree (mng_ptr ptr,mng_size_t size)
name|myfree
parameter_list|(
name|mng_ptr
name|ptr
parameter_list|,
name|mng_size_t
name|size
parameter_list|)
block|{
name|g_free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|mng_bool
DECL|function|myopenstream (mng_handle handle)
name|myopenstream
parameter_list|(
name|mng_handle
name|handle
parameter_list|)
block|{
return|return
name|MNG_TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|mng_bool
DECL|function|myclosestream (mng_handle handle)
name|myclosestream
parameter_list|(
name|mng_handle
name|handle
parameter_list|)
block|{
return|return
name|MNG_TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|mng_bool
DECL|function|mywritedata (mng_handle handle,mng_ptr buf,mng_uint32 size,mng_uint32 * written_size)
name|mywritedata
parameter_list|(
name|mng_handle
name|handle
parameter_list|,
name|mng_ptr
name|buf
parameter_list|,
name|mng_uint32
name|size
parameter_list|,
name|mng_uint32
modifier|*
name|written_size
parameter_list|)
block|{
name|struct
name|mnglib_userdata_t
modifier|*
name|userdata
init|=
operator|(
expr|struct
name|mnglib_userdata_t
operator|*
operator|)
name|mng_get_userdata
argument_list|(
name|handle
argument_list|)
decl_stmt|;
operator|*
name|written_size
operator|=
operator|(
name|mng_uint32
operator|)
name|fwrite
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
literal|1
argument_list|,
operator|(
name|size_t
operator|)
name|size
argument_list|,
name|userdata
operator|->
name|fp
argument_list|)
expr_stmt|;
return|return
name|MNG_TRUE
return|;
block|}
end_function

begin_comment
comment|/* Parses which output chunk type to use for this layer  * from the layer name. */
end_comment

begin_function
specifier|static
name|gint32
DECL|function|parse_chunks_type_from_layer_name (const gchar * str)
name|parse_chunks_type_from_layer_name
parameter_list|(
specifier|const
name|gchar
modifier|*
name|str
parameter_list|)
block|{
name|guint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|+
literal|5
operator|)
operator|<=
name|strlen
argument_list|(
name|str
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|g_ascii_strncasecmp
argument_list|(
name|str
operator|+
name|i
argument_list|,
literal|"(png)"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
return|return
name|CHUNKS_PNG
return|;
elseif|else
if|if
condition|(
name|g_ascii_strncasecmp
argument_list|(
name|str
operator|+
name|i
argument_list|,
literal|"(jng)"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
return|return
name|CHUNKS_JNG
return|;
block|}
return|return
name|mng_data
operator|.
name|default_chunks
return|;
block|}
end_function

begin_comment
comment|/* Parses which disposal type to use for this layer  * from the layer name. */
end_comment

begin_function
specifier|static
name|gint32
DECL|function|parse_disposal_type_from_layer_name (const gchar * str)
name|parse_disposal_type_from_layer_name
parameter_list|(
specifier|const
name|gchar
modifier|*
name|str
parameter_list|)
block|{
name|guint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|+
literal|9
operator|)
operator|<=
name|strlen
argument_list|(
name|str
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|g_ascii_strncasecmp
argument_list|(
name|str
operator|+
name|i
argument_list|,
literal|"(combine)"
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
return|return
name|DISPOSE_COMBINE
return|;
elseif|else
if|if
condition|(
name|g_ascii_strncasecmp
argument_list|(
name|str
operator|+
name|i
argument_list|,
literal|"(replace)"
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
return|return
name|DISPOSE_REPLACE
return|;
block|}
return|return
name|mng_data
operator|.
name|default_dispose
return|;
block|}
end_function

begin_comment
comment|/* Parses the millisecond delay to use for this layer  * from the layer name. */
end_comment

begin_function
specifier|static
name|gint32
DECL|function|parse_ms_tag_from_layer_name (const gchar * str)
name|parse_ms_tag_from_layer_name
parameter_list|(
specifier|const
name|gchar
modifier|*
name|str
parameter_list|)
block|{
name|guint
name|offset
init|=
literal|0
decl_stmt|;
name|gint32
name|sum
init|=
literal|0
decl_stmt|;
name|guint
name|length
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
while|while
condition|(
operator|(
name|offset
operator|<
name|length
operator|)
operator|&&
operator|(
name|str
index|[
name|offset
index|]
operator|!=
literal|'('
operator|)
condition|)
name|offset
operator|++
expr_stmt|;
if|if
condition|(
name|offset
operator|>=
name|length
condition|)
return|return
name|mng_data
operator|.
name|default_delay
return|;
name|offset
operator|++
expr_stmt|;
if|if
condition|(
name|g_ascii_isdigit
argument_list|(
name|str
index|[
name|offset
index|]
argument_list|)
condition|)
break|break;
block|}
do|do
block|{
name|sum
operator|*=
literal|10
expr_stmt|;
name|sum
operator|+=
name|str
index|[
name|offset
index|]
operator|-
literal|'0'
expr_stmt|;
name|offset
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|offset
operator|<
name|length
operator|)
operator|&&
operator|(
name|g_ascii_isdigit
argument_list|(
name|str
index|[
name|offset
index|]
argument_list|)
operator|)
condition|)
do|;
if|if
condition|(
operator|(
name|length
operator|-
name|offset
operator|)
operator|<=
literal|2
condition|)
return|return
name|mng_data
operator|.
name|default_delay
return|;
if|if
condition|(
operator|(
name|g_ascii_toupper
argument_list|(
name|str
index|[
name|offset
index|]
argument_list|)
operator|!=
literal|'M'
operator|)
operator|||
operator|(
name|g_ascii_toupper
argument_list|(
name|str
index|[
name|offset
operator|+
literal|1
index|]
argument_list|)
operator|!=
literal|'S'
operator|)
condition|)
return|return
name|mng_data
operator|.
name|default_delay
return|;
return|return
name|sum
return|;
block|}
end_function

begin_comment
comment|/* Try to find a colour in the palette which isn't actually  * used in the image, so that we can use it as the transparency  * index. Taken from png.c */
end_comment

begin_function
specifier|static
name|gint
DECL|function|find_unused_ia_colour (guchar * pixels,gint numpixels,gint * colors)
name|find_unused_ia_colour
parameter_list|(
name|guchar
modifier|*
name|pixels
parameter_list|,
name|gint
name|numpixels
parameter_list|,
name|gint
modifier|*
name|colors
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|gboolean
name|ix_used
index|[
literal|256
index|]
decl_stmt|;
name|gboolean
name|trans_used
init|=
name|FALSE
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|colors
condition|;
name|i
operator|++
control|)
block|{
name|ix_used
index|[
name|i
index|]
operator|=
name|FALSE
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numpixels
condition|;
name|i
operator|++
control|)
block|{
comment|/* If alpha is over a threshold, the colour index in the        * palette is taken. Otherwise, this pixel is transparent. */
if|if
condition|(
name|pixels
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|>
literal|127
condition|)
name|ix_used
index|[
name|pixels
index|[
name|i
operator|*
literal|2
index|]
index|]
operator|=
name|TRUE
expr_stmt|;
else|else
name|trans_used
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* If there is no transparency, ignore alpha. */
if|if
condition|(
name|trans_used
operator|==
name|FALSE
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|colors
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ix_used
index|[
name|i
index|]
operator|==
name|FALSE
condition|)
block|{
return|return
name|i
return|;
block|}
block|}
comment|/* Couldn't find an unused colour index within the number of      bits per pixel we wanted.  Will have to increment the number      of colours in the image and assign a transparent pixel there. */
if|if
condition|(
operator|(
operator|*
name|colors
operator|)
operator|<
literal|256
condition|)
block|{
operator|(
operator|*
name|colors
operator|)
operator|++
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|colors
operator|)
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|ia_has_transparent_pixels (guchar * pixels,gint numpixels)
name|ia_has_transparent_pixels
parameter_list|(
name|guchar
modifier|*
name|pixels
parameter_list|,
name|gint
name|numpixels
parameter_list|)
block|{
while|while
condition|(
name|numpixels
operator|--
condition|)
block|{
if|if
condition|(
name|pixels
index|[
literal|1
index|]
operator|<=
literal|127
condition|)
return|return
name|TRUE
return|;
name|pixels
operator|+=
literal|2
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/* Spins the color map (palette) putting the transparent color at  * index 0 if there is space. If there isn't any space, warn the user  * and forget about transparency. Returns TRUE if the colormap has  * been changed and FALSE otherwise.  */
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|respin_cmap (png_structp png_ptr,png_infop png_info_ptr,guchar * remap,gint32 image_id,GimpDrawable * drawable)
name|respin_cmap
parameter_list|(
name|png_structp
name|png_ptr
parameter_list|,
name|png_infop
name|png_info_ptr
parameter_list|,
name|guchar
modifier|*
name|remap
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
block|{
specifier|static
name|guchar
name|trans
index|[]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|guchar
modifier|*
name|before
decl_stmt|;
name|guchar
modifier|*
name|pixels
decl_stmt|;
name|gint
name|numpixels
decl_stmt|;
name|gint
name|colors
decl_stmt|;
name|gint
name|transparent
decl_stmt|;
name|gint
name|cols
decl_stmt|,
name|rows
decl_stmt|;
name|GimpPixelRgn
name|pixel_rgn
decl_stmt|;
name|before
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image_id
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
comment|/* Make sure there is something in the colormap */
if|if
condition|(
name|colors
operator|==
literal|0
condition|)
block|{
name|before
operator|=
name|g_new0
argument_list|(
name|guchar
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|colors
operator|=
literal|1
expr_stmt|;
block|}
name|cols
operator|=
name|drawable
operator|->
name|width
expr_stmt|;
name|rows
operator|=
name|drawable
operator|->
name|height
expr_stmt|;
name|numpixels
operator|=
name|cols
operator|*
name|rows
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pixels
operator|=
operator|(
name|guchar
operator|*
operator|)
name|g_malloc
argument_list|(
name|numpixels
operator|*
literal|2
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_get_rect
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|pixels
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|ia_has_transparent_pixels
argument_list|(
name|pixels
argument_list|,
name|numpixels
argument_list|)
condition|)
block|{
name|transparent
operator|=
name|find_unused_ia_colour
argument_list|(
name|pixels
argument_list|,
name|numpixels
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
if|if
condition|(
name|transparent
operator|!=
operator|-
literal|1
condition|)
block|{
name|png_color
name|palette
index|[
literal|256
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|png_set_tRNS
argument_list|(
name|png_ptr
argument_list|,
name|png_info_ptr
argument_list|,
operator|(
name|png_bytep
operator|)
name|trans
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Transform all pixels with a value = transparent to            * 0 and vice versa to compensate for re-ordering in palette            * due to png_set_tRNS().            */
name|remap
index|[
literal|0
index|]
operator|=
name|transparent
expr_stmt|;
name|remap
index|[
name|transparent
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Copy from index 0 to index transparent - 1 to index 1 to            * transparent of after, then from transparent+1 to colors-1            * unchanged, and finally from index transparent to index 0.            */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|colors
condition|;
name|i
operator|++
control|)
block|{
name|palette
index|[
name|i
index|]
operator|.
name|red
operator|=
name|before
index|[
literal|3
operator|*
name|remap
index|[
name|i
index|]
index|]
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|green
operator|=
name|before
index|[
literal|3
operator|*
name|remap
index|[
name|i
index|]
operator|+
literal|1
index|]
expr_stmt|;
name|palette
index|[
name|i
index|]
operator|.
name|blue
operator|=
name|before
index|[
literal|3
operator|*
name|remap
index|[
name|i
index|]
operator|+
literal|2
index|]
expr_stmt|;
block|}
name|png_set_PLTE
argument_list|(
name|png_ptr
argument_list|,
name|png_info_ptr
argument_list|,
operator|(
name|png_colorp
operator|)
name|palette
argument_list|,
name|colors
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
else|else
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Couldn't losslessly save transparency, "
literal|"saving opacity instead."
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|png_set_PLTE
argument_list|(
name|png_ptr
argument_list|,
name|png_info_ptr
argument_list|,
operator|(
name|png_colorp
operator|)
name|before
argument_list|,
name|colors
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|mng_retcode
DECL|function|mng_putchunk_plte_wrapper (mng_handle handle,gint numcolors,const guchar * colormap)
name|mng_putchunk_plte_wrapper
parameter_list|(
name|mng_handle
name|handle
parameter_list|,
name|gint
name|numcolors
parameter_list|,
specifier|const
name|guchar
modifier|*
name|colormap
parameter_list|)
block|{
name|mng_palette8
name|palette
decl_stmt|;
name|memset
argument_list|(
name|palette
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|palette
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|<
name|numcolors
condition|)
name|memcpy
argument_list|(
name|palette
argument_list|,
name|colormap
argument_list|,
name|numcolors
operator|*
sizeof|sizeof
name|palette
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|mng_putchunk_plte
argument_list|(
name|handle
argument_list|,
name|numcolors
argument_list|,
name|palette
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|mng_retcode
DECL|function|mng_putchunk_trns_wrapper (mng_handle handle,gint n_alphas,const guchar * buffer)
name|mng_putchunk_trns_wrapper
parameter_list|(
name|mng_handle
name|handle
parameter_list|,
name|gint
name|n_alphas
parameter_list|,
specifier|const
name|guchar
modifier|*
name|buffer
parameter_list|)
block|{
specifier|const
name|mng_bool
name|mng_global
init|=
name|TRUE
decl_stmt|;
specifier|const
name|mng_bool
name|mng_empty
init|=
name|TRUE
decl_stmt|;
name|mng_uint8arr
name|alphas
decl_stmt|;
name|memset
argument_list|(
name|alphas
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|alphas
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer
operator|&&
literal|0
operator|<
name|n_alphas
condition|)
name|memcpy
argument_list|(
name|alphas
argument_list|,
name|buffer
argument_list|,
name|n_alphas
operator|*
sizeof|sizeof
name|alphas
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|mng_putchunk_trns
argument_list|(
name|handle
argument_list|,
operator|!
name|mng_empty
argument_list|,
operator|!
name|mng_global
argument_list|,
name|MNG_COLORTYPE_INDEXED
argument_list|,
name|n_alphas
argument_list|,
name|alphas
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|alphas
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|mng_save_image (const gchar * filename,gint32 image_id,gint32 drawable_id,gint32 original_image_id,GError ** error)
name|mng_save_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|,
name|gint32
name|original_image_id
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|gboolean
name|ret
init|=
name|FALSE
decl_stmt|;
name|gint
name|rows
decl_stmt|,
name|cols
decl_stmt|;
specifier|volatile
name|gint
name|i
decl_stmt|;
name|time_t
name|t
decl_stmt|;
name|struct
name|tm
modifier|*
name|gmt
decl_stmt|;
name|gint
name|num_layers
decl_stmt|;
name|gint32
modifier|*
name|layers
decl_stmt|;
name|struct
name|mnglib_userdata_t
modifier|*
name|userdata
decl_stmt|;
name|mng_handle
name|handle
decl_stmt|;
name|guint32
name|mng_ticks_per_second
decl_stmt|;
name|guint32
name|mng_simplicity_profile
decl_stmt|;
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|<
literal|1
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|num_layers
operator|>
literal|1
condition|)
name|mng_ticks_per_second
operator|=
literal|1000
expr_stmt|;
else|else
name|mng_ticks_per_second
operator|=
literal|0
expr_stmt|;
name|rows
operator|=
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|cols
operator|=
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|mng_simplicity_profile
operator|=
operator|(
name|MNG_SIMPLICITY_VALID
operator||
name|MNG_SIMPLICITY_SIMPLEFEATURES
operator||
name|MNG_SIMPLICITY_COMPLEXFEATURES
operator|)
expr_stmt|;
comment|/* JNG and delta-PNG chunks exist */
name|mng_simplicity_profile
operator||=
operator|(
name|MNG_SIMPLICITY_JNG
operator||
name|MNG_SIMPLICITY_DELTAPNG
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_layers
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|gimp_drawable_has_alpha
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
condition|)
block|{
comment|/* internal transparency exists */
name|mng_simplicity_profile
operator||=
name|MNG_SIMPLICITY_TRANSPARENCY
expr_stmt|;
comment|/* validity of following flags */
name|mng_simplicity_profile
operator||=
literal|0x00000040
expr_stmt|;
comment|/* semi-transparency exists */
name|mng_simplicity_profile
operator||=
literal|0x00000100
expr_stmt|;
comment|/* background transparency should happen */
name|mng_simplicity_profile
operator||=
literal|0x00000080
expr_stmt|;
break|break;
block|}
name|userdata
operator|=
name|g_new0
argument_list|(
expr|struct
name|mnglib_userdata_t
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|userdata
operator|->
name|fp
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|userdata
operator|->
name|fp
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|g_file_error_from_errno
argument_list|(
name|errno
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Could not open '%s' for writing: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|handle
operator|=
name|mng_initialize
argument_list|(
operator|(
name|mng_ptr
operator|)
name|userdata
argument_list|,
name|myalloc
argument_list|,
name|myfree
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|handle
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_initialize() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
operator|(
name|mng_setcb_openstream
argument_list|(
name|handle
argument_list|,
name|myopenstream
argument_list|)
operator|!=
name|MNG_NOERROR
operator|)
operator|||
operator|(
name|mng_setcb_closestream
argument_list|(
name|handle
argument_list|,
name|myclosestream
argument_list|)
operator|!=
name|MNG_NOERROR
operator|)
operator|||
operator|(
name|mng_setcb_writedata
argument_list|(
name|handle
argument_list|,
name|mywritedata
argument_list|)
operator|!=
name|MNG_NOERROR
operator|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to setup callbacks in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
name|mng_create
argument_list|(
name|handle
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_create() image in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
name|mng_putchunk_mhdr
argument_list|(
name|handle
argument_list|,
name|cols
argument_list|,
name|rows
argument_list|,
name|mng_ticks_per_second
argument_list|,
literal|1
argument_list|,
name|num_layers
argument_list|,
name|mng_data
operator|.
name|default_delay
argument_list|,
name|mng_simplicity_profile
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_mhdr() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
operator|(
name|num_layers
operator|>
literal|1
operator|)
operator|&&
operator|(
name|mng_data
operator|.
name|loop
operator|)
condition|)
block|{
name|gint32
name|ms
init|=
name|parse_ms_tag_from_layer_name
argument_list|(
name|gimp_item_get_name
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|mng_putchunk_term
argument_list|(
name|handle
argument_list|,
name|MNG_TERMACTION_REPEAT
argument_list|,
name|MNG_ITERACTION_LASTFRAME
argument_list|,
name|ms
argument_list|,
literal|0x7fffffff
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_term() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
else|else
block|{
name|gint32
name|ms
init|=
name|parse_ms_tag_from_layer_name
argument_list|(
name|gimp_item_get_name
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|mng_putchunk_term
argument_list|(
name|handle
argument_list|,
name|MNG_TERMACTION_LASTFRAME
argument_list|,
name|MNG_ITERACTION_LASTFRAME
argument_list|,
name|ms
argument_list|,
literal|0x7fffffff
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_term() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
comment|/* For now, we hardwire a comment */
if|if
condition|(
name|mng_putchunk_text
argument_list|(
name|handle
argument_list|,
name|strlen
argument_list|(
name|MNG_TEXT_TITLE
argument_list|)
argument_list|,
name|MNG_TEXT_TITLE
argument_list|,
literal|18
argument_list|,
literal|"Created using GIMP"
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_text() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|#
directive|if
literal|0
comment|/* how do we get this to work? */
block|if (mng_data.bkgd)     {       GimpRGB bgcolor;       guchar red, green, blue;        gimp_context_get_background (&bgcolor);       gimp_rgb_get_uchar (&bgcolor,&red,&green,&blue);        if (mng_putchunk_back (handle, red, green, blue,                              MNG_BACKGROUNDCOLOR_MANDATORY,                              0, MNG_BACKGROUNDIMAGE_NOTILE) != MNG_NOERROR)         {           g_warning ("Unable to mng_putchunk_back() in mng_save_image()");           goto err3;         }        if (mng_putchunk_bkgd (handle, MNG_FALSE, 2, 0,                              gimp_rgb_luminance_uchar (&bgcolor),                              red, green, blue) != MNG_NOERROR)         {           g_warning ("Unable to mng_putchunk_bkgd() in mng_save_image()");           goto err3;         }     }
endif|#
directive|endif
if|if
condition|(
name|mng_data
operator|.
name|gama
condition|)
block|{
if|if
condition|(
name|mng_putchunk_gama
argument_list|(
name|handle
argument_list|,
name|MNG_FALSE
argument_list|,
operator|(
literal|1.0
operator|/
operator|(
name|gimp_gamma
argument_list|()
operator|)
operator|*
literal|100000
operator|)
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_gama() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
if|#
directive|if
literal|0
comment|/* how do we get this to work? */
block|if (mng_data.phys)     {       gimp_image_get_resolution(original_image_id,&xres,&yres);        if (mng_putchunk_phyg (handle, MNG_FALSE,                              (mng_uint32) (xres * 39.37),                              (mng_uint32) (yres * 39.37), 1) != MNG_NOERROR)         {           g_warning ("Unable to mng_putchunk_phyg() in mng_save_image()");           goto err3;         }        if (mng_putchunk_phys (handle, MNG_FALSE,                              (mng_uint32) (xres * 39.37),                              (mng_uint32) (yres * 39.37), 1) != MNG_NOERROR)         {           g_warning ("Unable to mng_putchunk_phys() in mng_save_image()");           goto err3;         }     }
endif|#
directive|endif
if|if
condition|(
name|mng_data
operator|.
name|time
condition|)
block|{
name|t
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gmt
operator|=
name|gmtime
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|mng_putchunk_time
argument_list|(
name|handle
argument_list|,
name|gmt
operator|->
name|tm_year
operator|+
literal|1900
argument_list|,
name|gmt
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
name|gmt
operator|->
name|tm_mday
argument_list|,
name|gmt
operator|->
name|tm_hour
argument_list|,
name|gmt
operator|->
name|tm_min
argument_list|,
name|gmt
operator|->
name|tm_sec
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_time() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
if|if
condition|(
name|gimp_image_base_type
argument_list|(
name|image_id
argument_list|)
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|guchar
modifier|*
name|palette
decl_stmt|;
name|gint
name|numcolors
decl_stmt|;
name|palette
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image_id
argument_list|,
operator|&
name|numcolors
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|numcolors
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|mng_putchunk_plte_wrapper
argument_list|(
name|handle
argument_list|,
name|numcolors
argument_list|,
name|palette
argument_list|)
operator|!=
name|MNG_NOERROR
operator|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_plte() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
for|for
control|(
name|i
operator|=
operator|(
name|num_layers
operator|-
literal|1
operator|)
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|gint
name|num_colors
decl_stmt|;
name|GimpImageType
name|layer_drawable_type
decl_stmt|;
name|GimpDrawable
modifier|*
name|layer_drawable
decl_stmt|;
name|gint
name|layer_offset_x
decl_stmt|,
name|layer_offset_y
decl_stmt|;
name|gint
name|layer_rows
decl_stmt|,
name|layer_cols
decl_stmt|;
name|gchar
modifier|*
name|layer_name
decl_stmt|;
name|gint
name|layer_chunks_type
decl_stmt|;
specifier|volatile
name|gint
name|layer_bpp
decl_stmt|;
name|GimpPixelRgn
name|layer_pixel_rgn
decl_stmt|;
name|guint8
name|layer_mng_colortype
decl_stmt|;
name|guint8
name|layer_mng_compression_type
decl_stmt|;
name|guint8
name|layer_mng_interlace_type
decl_stmt|;
name|gboolean
name|layer_has_unique_palette
decl_stmt|;
name|gchar
name|frame_mode
decl_stmt|;
name|int
name|frame_delay
decl_stmt|;
name|gchar
modifier|*
name|temp_file_name
decl_stmt|;
name|png_structp
name|png_ptr
decl_stmt|;
name|png_infop
name|png_info_ptr
decl_stmt|;
name|FILE
modifier|*
name|infile
decl_stmt|,
modifier|*
name|outfile
decl_stmt|;
name|int
name|num_passes
decl_stmt|;
name|int
name|tile_height
decl_stmt|;
name|guchar
modifier|*
modifier|*
name|layer_pixels
decl_stmt|,
modifier|*
name|layer_pixel
decl_stmt|;
name|int
name|pass
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|begin
decl_stmt|,
name|end
decl_stmt|,
name|num
decl_stmt|;
name|guchar
modifier|*
name|fixed
decl_stmt|;
name|guchar
name|layer_remap
index|[
literal|256
index|]
decl_stmt|;
name|layer_name
operator|=
name|gimp_item_get_name
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|layer_chunks_type
operator|=
name|parse_chunks_type_from_layer_name
argument_list|(
name|layer_name
argument_list|)
expr_stmt|;
name|layer_drawable_type
operator|=
name|gimp_drawable_type
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|layer_drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|layer_rows
operator|=
name|layer_drawable
operator|->
name|height
expr_stmt|;
name|layer_cols
operator|=
name|layer_drawable
operator|->
name|width
expr_stmt|;
name|gimp_drawable_offsets
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|,
operator|&
name|layer_offset_x
argument_list|,
operator|&
name|layer_offset_y
argument_list|)
expr_stmt|;
name|layer_has_unique_palette
operator|=
name|TRUE
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|256
condition|;
name|j
operator|++
control|)
name|layer_remap
index|[
name|j
index|]
operator|=
name|j
expr_stmt|;
switch|switch
condition|(
name|layer_drawable_type
condition|)
block|{
case|case
name|GIMP_RGB_IMAGE
case|:
name|layer_bpp
operator|=
literal|3
expr_stmt|;
name|layer_mng_colortype
operator|=
name|MNG_COLORTYPE_RGB
expr_stmt|;
break|break;
case|case
name|GIMP_RGBA_IMAGE
case|:
name|layer_bpp
operator|=
literal|4
expr_stmt|;
name|layer_mng_colortype
operator|=
name|MNG_COLORTYPE_RGBA
expr_stmt|;
break|break;
case|case
name|GIMP_GRAY_IMAGE
case|:
name|layer_bpp
operator|=
literal|1
expr_stmt|;
name|layer_mng_colortype
operator|=
name|MNG_COLORTYPE_GRAY
expr_stmt|;
break|break;
case|case
name|GIMP_GRAYA_IMAGE
case|:
name|layer_bpp
operator|=
literal|2
expr_stmt|;
name|layer_mng_colortype
operator|=
name|MNG_COLORTYPE_GRAYA
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXED_IMAGE
case|:
name|layer_bpp
operator|=
literal|1
expr_stmt|;
name|layer_mng_colortype
operator|=
name|MNG_COLORTYPE_INDEXED
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXEDA_IMAGE
case|:
name|layer_bpp
operator|=
literal|2
expr_stmt|;
name|layer_mng_colortype
operator|=
name|MNG_COLORTYPE_INDEXED
operator||
name|MNG_COLORTYPE_GRAYA
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"Unsupported GimpImageType in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
comment|/* Delta PNG chunks are not yet supported */
comment|/* if (i == (num_layers - 1)) */
block|{
if|if
condition|(
name|layer_chunks_type
operator|==
name|CHUNKS_JNG_D
condition|)
name|layer_chunks_type
operator|=
name|CHUNKS_JNG
expr_stmt|;
elseif|else
if|if
condition|(
name|layer_chunks_type
operator|==
name|CHUNKS_PNG_D
condition|)
name|layer_chunks_type
operator|=
name|CHUNKS_PNG
expr_stmt|;
block|}
switch|switch
condition|(
name|layer_chunks_type
condition|)
block|{
case|case
name|CHUNKS_PNG_D
case|:
name|layer_mng_compression_type
operator|=
name|MNG_COMPRESSION_DEFLATE
expr_stmt|;
if|if
condition|(
name|mng_data
operator|.
name|interlaced
operator|!=
literal|0
condition|)
name|layer_mng_interlace_type
operator|=
name|MNG_INTERLACE_ADAM7
expr_stmt|;
else|else
name|layer_mng_interlace_type
operator|=
name|MNG_INTERLACE_NONE
expr_stmt|;
break|break;
case|case
name|CHUNKS_JNG_D
case|:
name|layer_mng_compression_type
operator|=
name|MNG_COMPRESSION_DEFLATE
expr_stmt|;
if|if
condition|(
name|mng_data
operator|.
name|interlaced
operator|!=
literal|0
condition|)
name|layer_mng_interlace_type
operator|=
name|MNG_INTERLACE_ADAM7
expr_stmt|;
else|else
name|layer_mng_interlace_type
operator|=
name|MNG_INTERLACE_NONE
expr_stmt|;
break|break;
case|case
name|CHUNKS_PNG
case|:
name|layer_mng_compression_type
operator|=
name|MNG_COMPRESSION_DEFLATE
expr_stmt|;
if|if
condition|(
name|mng_data
operator|.
name|interlaced
operator|!=
literal|0
condition|)
name|layer_mng_interlace_type
operator|=
name|MNG_INTERLACE_ADAM7
expr_stmt|;
else|else
name|layer_mng_interlace_type
operator|=
name|MNG_INTERLACE_NONE
expr_stmt|;
break|break;
case|case
name|CHUNKS_JNG
case|:
name|layer_mng_compression_type
operator|=
name|MNG_COMPRESSION_BASELINEJPEG
expr_stmt|;
if|if
condition|(
name|mng_data
operator|.
name|interlaced
operator|!=
literal|0
condition|)
name|layer_mng_interlace_type
operator|=
name|MNG_INTERLACE_PROGRESSIVE
expr_stmt|;
else|else
name|layer_mng_interlace_type
operator|=
name|MNG_INTERLACE_SEQUENTIAL
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"Huh? Programmer stupidity error "
literal|"with 'layer_chunks_type'"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
operator|(
name|i
operator|==
operator|(
name|num_layers
operator|-
literal|1
operator|)
operator|)
operator|||
operator|(
name|parse_disposal_type_from_layer_name
argument_list|(
name|layer_name
argument_list|)
operator|!=
name|DISPOSE_COMBINE
operator|)
condition|)
name|frame_mode
operator|=
name|MNG_FRAMINGMODE_3
expr_stmt|;
else|else
name|frame_mode
operator|=
name|MNG_FRAMINGMODE_1
expr_stmt|;
name|frame_delay
operator|=
name|parse_ms_tag_from_layer_name
argument_list|(
name|layer_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|mng_putchunk_fram
argument_list|(
name|handle
argument_list|,
name|MNG_FALSE
argument_list|,
name|frame_mode
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|MNG_CHANGEDELAY_DEFAULT
argument_list|,
name|MNG_CHANGETIMOUT_NO
argument_list|,
name|MNG_CHANGECLIPPING_DEFAULT
argument_list|,
name|MNG_CHANGESYNCID_NO
argument_list|,
name|frame_delay
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|layer_offset_x
argument_list|,
name|layer_offset_x
operator|+
name|layer_cols
argument_list|,
name|layer_offset_y
argument_list|,
name|layer_offset_y
operator|+
name|layer_rows
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_fram() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
operator|(
name|layer_offset_x
operator|!=
literal|0
operator|)
operator|||
operator|(
name|layer_offset_y
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|mng_putchunk_defi
argument_list|(
name|handle
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|layer_offset_x
argument_list|,
name|layer_offset_y
argument_list|,
literal|1
argument_list|,
name|layer_offset_x
argument_list|,
name|layer_offset_x
operator|+
name|layer_cols
argument_list|,
name|layer_offset_y
argument_list|,
name|layer_offset_y
operator|+
name|layer_rows
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_defi() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|temp_file_name
operator|=
name|gimp_temp_name
argument_list|(
literal|"mng"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|g_warning
argument_list|(
literal|"gimp_temp_name() failed in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
operator|(
name|outfile
operator|=
name|g_fopen
argument_list|(
name|temp_file_name
argument_list|,
literal|"wb"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|g_file_error_from_errno
argument_list|(
name|errno
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Could not open '%s' for writing: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|temp_file_name
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|g_unlink
argument_list|(
name|temp_file_name
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|png_ptr
operator|=
name|png_create_write_struct
argument_list|(
name|PNG_LIBPNG_VER_STRING
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|png_ptr
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to png_create_write_struct() in mng_save_image()"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
name|g_unlink
argument_list|(
name|temp_file_name
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|png_info_ptr
operator|=
name|png_create_info_struct
argument_list|(
name|png_ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|png_info_ptr
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to png_create_info_struct() in mng_save_image()"
argument_list|)
expr_stmt|;
name|png_destroy_write_struct
argument_list|(
operator|&
name|png_ptr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
name|g_unlink
argument_list|(
name|temp_file_name
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
name|setjmp
argument_list|(
name|png_ptr
operator|->
name|jmpbuf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|g_warning
argument_list|(
literal|"HRM saving PNG in mng_save_image()"
argument_list|)
expr_stmt|;
name|png_destroy_write_struct
argument_list|(
operator|&
name|png_ptr
argument_list|,
operator|&
name|png_info_ptr
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
name|g_unlink
argument_list|(
name|temp_file_name
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|png_init_io
argument_list|(
name|png_ptr
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|png_set_compression_level
argument_list|(
name|png_ptr
argument_list|,
name|mng_data
operator|.
name|compression_level
argument_list|)
expr_stmt|;
name|png_info_ptr
operator|->
name|width
operator|=
name|layer_cols
expr_stmt|;
name|png_info_ptr
operator|->
name|height
operator|=
name|layer_rows
expr_stmt|;
name|png_info_ptr
operator|->
name|interlace_type
operator|=
operator|(
name|mng_data
operator|.
name|interlaced
operator|==
literal|0
condition|?
literal|0
else|:
literal|1
operator|)
expr_stmt|;
name|png_info_ptr
operator|->
name|bit_depth
operator|=
literal|8
expr_stmt|;
switch|switch
condition|(
name|layer_drawable_type
condition|)
block|{
case|case
name|GIMP_RGB_IMAGE
case|:
name|png_info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_RGB
expr_stmt|;
break|break;
case|case
name|GIMP_RGBA_IMAGE
case|:
name|png_info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_RGB_ALPHA
expr_stmt|;
break|break;
case|case
name|GIMP_GRAY_IMAGE
case|:
name|png_info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_GRAY
expr_stmt|;
break|break;
case|case
name|GIMP_GRAYA_IMAGE
case|:
name|png_info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_GRAY_ALPHA
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXED_IMAGE
case|:
name|png_info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_PALETTE
expr_stmt|;
name|png_info_ptr
operator|->
name|valid
operator||=
name|PNG_INFO_PLTE
expr_stmt|;
name|png_info_ptr
operator|->
name|palette
operator|=
operator|(
name|png_colorp
operator|)
name|gimp_image_get_colormap
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_colors
argument_list|)
expr_stmt|;
name|png_info_ptr
operator|->
name|num_palette
operator|=
name|num_colors
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXEDA_IMAGE
case|:
name|png_info_ptr
operator|->
name|color_type
operator|=
name|PNG_COLOR_TYPE_PALETTE
expr_stmt|;
name|layer_has_unique_palette
operator|=
name|respin_cmap
argument_list|(
name|png_ptr
argument_list|,
name|png_info_ptr
argument_list|,
name|layer_remap
argument_list|,
name|image_id
argument_list|,
name|layer_drawable
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"This can't be!\n"
argument_list|)
expr_stmt|;
name|png_destroy_write_struct
argument_list|(
operator|&
name|png_ptr
argument_list|,
operator|&
name|png_info_ptr
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
name|g_unlink
argument_list|(
name|temp_file_name
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
operator|(
name|png_info_ptr
operator|->
name|valid
operator|&
name|PNG_INFO_PLTE
operator|)
operator|==
name|PNG_INFO_PLTE
condition|)
block|{
if|if
condition|(
name|png_info_ptr
operator|->
name|num_palette
operator|<=
literal|2
condition|)
name|png_info_ptr
operator|->
name|bit_depth
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|png_info_ptr
operator|->
name|num_palette
operator|<=
literal|4
condition|)
name|png_info_ptr
operator|->
name|bit_depth
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|png_info_ptr
operator|->
name|num_palette
operator|<=
literal|16
condition|)
name|png_info_ptr
operator|->
name|bit_depth
operator|=
literal|4
expr_stmt|;
block|}
name|png_write_info
argument_list|(
name|png_ptr
argument_list|,
name|png_info_ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mng_data
operator|.
name|interlaced
operator|!=
literal|0
condition|)
name|num_passes
operator|=
name|png_set_interlace_handling
argument_list|(
name|png_ptr
argument_list|)
expr_stmt|;
else|else
name|num_passes
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|png_info_ptr
operator|->
name|color_type
operator|==
name|PNG_COLOR_TYPE_PALETTE
operator|)
operator|&&
operator|(
name|png_info_ptr
operator|->
name|bit_depth
operator|<
literal|8
operator|)
condition|)
name|png_set_packing
argument_list|(
name|png_ptr
argument_list|)
expr_stmt|;
name|tile_height
operator|=
name|gimp_tile_height
argument_list|()
expr_stmt|;
name|layer_pixel
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|tile_height
operator|*
name|layer_cols
operator|*
name|layer_bpp
argument_list|)
expr_stmt|;
name|layer_pixels
operator|=
name|g_new
argument_list|(
name|guchar
operator|*
argument_list|,
name|tile_height
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|tile_height
condition|;
name|j
operator|++
control|)
name|layer_pixels
index|[
name|j
index|]
operator|=
name|layer_pixel
operator|+
operator|(
name|layer_cols
operator|*
name|layer_bpp
operator|*
name|j
operator|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|layer_pixel_rgn
argument_list|,
name|layer_drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|layer_cols
argument_list|,
name|layer_rows
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
for|for
control|(
name|pass
operator|=
literal|0
init|;
name|pass
operator|<
name|num_passes
condition|;
name|pass
operator|++
control|)
block|{
for|for
control|(
name|begin
operator|=
literal|0
operator|,
name|end
operator|=
name|tile_height
init|;
name|begin
operator|<
name|layer_rows
condition|;
name|begin
operator|+=
name|tile_height
operator|,
name|end
operator|+=
name|tile_height
control|)
block|{
if|if
condition|(
name|end
operator|>
name|layer_rows
condition|)
name|end
operator|=
name|layer_rows
expr_stmt|;
name|num
operator|=
name|end
operator|-
name|begin
expr_stmt|;
name|gimp_pixel_rgn_get_rect
argument_list|(
operator|&
name|layer_pixel_rgn
argument_list|,
name|layer_pixel
argument_list|,
literal|0
argument_list|,
name|begin
argument_list|,
name|layer_cols
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|png_info_ptr
operator|->
name|valid
operator|&
name|PNG_INFO_tRNS
operator|)
operator|==
name|PNG_INFO_tRNS
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num
condition|;
name|j
operator|++
control|)
block|{
name|fixed
operator|=
name|layer_pixels
index|[
name|j
index|]
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|layer_cols
condition|;
name|k
operator|++
control|)
name|fixed
index|[
name|k
index|]
operator|=
operator|(
name|fixed
index|[
name|k
operator|*
literal|2
operator|+
literal|1
index|]
operator|>
literal|127
operator|)
condition|?
name|layer_remap
index|[
name|fixed
index|[
name|k
operator|*
literal|2
index|]
index|]
else|:
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|png_info_ptr
operator|->
name|valid
operator|&
name|PNG_INFO_PLTE
operator|)
operator|==
name|PNG_INFO_PLTE
operator|)
operator|&&
operator|(
name|layer_bpp
operator|==
literal|2
operator|)
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num
condition|;
name|j
operator|++
control|)
block|{
name|fixed
operator|=
name|layer_pixels
index|[
name|j
index|]
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|layer_cols
condition|;
name|k
operator|++
control|)
name|fixed
index|[
name|k
index|]
operator|=
name|fixed
index|[
name|k
operator|*
literal|2
index|]
expr_stmt|;
block|}
block|}
name|png_write_rows
argument_list|(
name|png_ptr
argument_list|,
name|layer_pixels
argument_list|,
name|num
argument_list|)
expr_stmt|;
block|}
block|}
name|png_write_end
argument_list|(
name|png_ptr
argument_list|,
name|png_info_ptr
argument_list|)
expr_stmt|;
name|png_destroy_write_struct
argument_list|(
operator|&
name|png_ptr
argument_list|,
operator|&
name|png_info_ptr
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|layer_pixels
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|layer_pixel
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
name|infile
operator|=
name|g_fopen
argument_list|(
name|temp_file_name
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|infile
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|g_file_error_from_errno
argument_list|(
name|errno
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Could not open '%s' for reading: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|temp_file_name
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|g_unlink
argument_list|(
name|temp_file_name
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|fseek
argument_list|(
name|infile
argument_list|,
literal|8L
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|feof
argument_list|(
name|infile
argument_list|)
condition|)
block|{
name|guchar
name|chunksize_chars
index|[
literal|4
index|]
decl_stmt|;
name|gulong
name|chunksize
decl_stmt|;
name|gchar
name|chunkname
index|[
literal|5
index|]
decl_stmt|;
name|guchar
modifier|*
name|chunkbuffer
decl_stmt|;
name|glong
name|chunkwidth
decl_stmt|;
name|glong
name|chunkheight
decl_stmt|;
name|gchar
name|chunkbitdepth
decl_stmt|;
name|gchar
name|chunkcolortype
decl_stmt|;
name|gchar
name|chunkcompression
decl_stmt|;
name|gchar
name|chunkfilter
decl_stmt|;
name|gchar
name|chunkinterlaced
decl_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|chunksize_chars
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
name|infile
argument_list|)
operator|!=
literal|4
condition|)
break|break;
if|if
condition|(
name|fread
argument_list|(
name|chunkname
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
name|infile
argument_list|)
operator|!=
literal|4
condition|)
break|break;
name|chunkname
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|chunksize
operator|=
operator|(
operator|(
name|chunksize_chars
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|chunksize_chars
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|chunksize_chars
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|chunksize_chars
index|[
literal|3
index|]
operator|)
operator|)
expr_stmt|;
name|chunkbuffer
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|chunksize
operator|>
literal|0
condition|)
block|{
name|chunkbuffer
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|chunksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|chunkbuffer
argument_list|,
literal|1
argument_list|,
name|chunksize
argument_list|,
name|infile
argument_list|)
operator|!=
name|chunksize
condition|)
break|break;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|chunkname
argument_list|,
literal|"IHDR"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|chunkwidth
operator|=
operator|(
operator|(
name|chunkbuffer
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|chunkbuffer
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|chunkbuffer
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|chunkbuffer
index|[
literal|3
index|]
operator|)
operator|)
expr_stmt|;
name|chunkheight
operator|=
operator|(
operator|(
name|chunkbuffer
index|[
literal|4
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|chunkbuffer
index|[
literal|5
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|chunkbuffer
index|[
literal|6
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|chunkbuffer
index|[
literal|7
index|]
operator|)
operator|)
expr_stmt|;
name|chunkbitdepth
operator|=
name|chunkbuffer
index|[
literal|8
index|]
expr_stmt|;
name|chunkcolortype
operator|=
name|chunkbuffer
index|[
literal|9
index|]
expr_stmt|;
name|chunkcompression
operator|=
name|chunkbuffer
index|[
literal|10
index|]
expr_stmt|;
name|chunkfilter
operator|=
name|chunkbuffer
index|[
literal|11
index|]
expr_stmt|;
name|chunkinterlaced
operator|=
name|chunkbuffer
index|[
literal|12
index|]
expr_stmt|;
if|if
condition|(
name|mng_putchunk_ihdr
argument_list|(
name|handle
argument_list|,
name|chunkwidth
argument_list|,
name|chunkheight
argument_list|,
name|chunkbitdepth
argument_list|,
name|chunkcolortype
argument_list|,
name|chunkcompression
argument_list|,
name|chunkfilter
argument_list|,
name|chunkinterlaced
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_ihdr() "
literal|"in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|chunkname
argument_list|,
literal|"IDAT"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mng_putchunk_idat
argument_list|(
name|handle
argument_list|,
name|chunksize
argument_list|,
name|chunkbuffer
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_idat() "
literal|"in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|chunkname
argument_list|,
literal|"IEND"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mng_putchunk_iend
argument_list|(
name|handle
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_iend() "
literal|"in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|chunkname
argument_list|,
literal|"PLTE"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* If this frame's palette is the same as the global palette,                * write a 0-color palette chunk.                */
if|if
condition|(
name|mng_putchunk_plte_wrapper
argument_list|(
name|handle
argument_list|,
operator|(
name|layer_has_unique_palette
condition|?
operator|(
name|chunksize
operator|/
literal|3
operator|)
else|:
literal|0
operator|)
argument_list|,
name|chunkbuffer
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_plte() "
literal|"in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|chunkname
argument_list|,
literal|"tRNS"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mng_putchunk_trns_wrapper
argument_list|(
name|handle
argument_list|,
name|chunksize
argument_list|,
name|chunkbuffer
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_trns() "
literal|"in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
if|if
condition|(
name|chunksize
operator|>
literal|0
condition|)
name|g_free
argument_list|(
name|chunkbuffer
argument_list|)
expr_stmt|;
comment|/* read 4 bytes after the chunk */
name|fread
argument_list|(
name|chunkname
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
name|infile
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|infile
argument_list|)
expr_stmt|;
name|g_unlink
argument_list|(
name|temp_file_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mng_putchunk_mend
argument_list|(
name|handle
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_putchunk_mend() in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
name|mng_write
argument_list|(
name|handle
argument_list|)
operator|!=
name|MNG_NOERROR
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unable to mng_write() the image in mng_save_image()"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|ret
operator|=
name|TRUE
expr_stmt|;
name|err3
label|:
name|mng_cleanup
argument_list|(
operator|&
name|handle
argument_list|)
expr_stmt|;
name|err2
label|:
name|fclose
argument_list|(
name|userdata
operator|->
name|fp
argument_list|)
expr_stmt|;
name|err
label|:
name|g_free
argument_list|(
name|userdata
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* The interactive dialog. */
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|mng_save_dialog (gint32 image_id)
name|mng_save_dialog
parameter_list|(
name|gint32
name|image_id
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|GtkWidget
modifier|*
name|main_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|combo
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|scale
decl_stmt|;
name|GtkObject
modifier|*
name|scale_adj
decl_stmt|;
name|GtkWidget
modifier|*
name|spinbutton
decl_stmt|;
name|GtkObject
modifier|*
name|spinbutton_adj
decl_stmt|;
name|gint
name|num_layers
decl_stmt|;
name|gboolean
name|run
decl_stmt|;
name|dialog
operator|=
name|gimp_export_dialog_new
argument_list|(
name|_
argument_list|(
literal|"MNG"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|SAVE_PROC
argument_list|)
expr_stmt|;
name|main_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gimp_export_dialog_get_content_area
argument_list|(
name|dialog
argument_list|)
argument_list|)
argument_list|,
name|main_vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"MNG Options"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Interlace"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|interlaced
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|mng_data
operator|.
name|interlaced
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Save background color"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|toggle
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|bkgd
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|mng_data
operator|.
name|bkgd
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Save gamma"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|gama
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|mng_data
operator|.
name|gama
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Save resolution"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|toggle
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|phys
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|mng_data
operator|.
name|phys
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Save creation time"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|time
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|mng_data
operator|.
name|time
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|4
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|==
literal|1
condition|)
name|combo
operator|=
name|gimp_int_combo_box_new
argument_list|(
name|_
argument_list|(
literal|"PNG"
argument_list|)
argument_list|,
name|CHUNKS_PNG_D
argument_list|,
name|_
argument_list|(
literal|"JNG"
argument_list|)
argument_list|,
name|CHUNKS_JNG_D
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|combo
operator|=
name|gimp_int_combo_box_new
argument_list|(
name|_
argument_list|(
literal|"PNG + delta PNG"
argument_list|)
argument_list|,
name|CHUNKS_PNG_D
argument_list|,
name|_
argument_list|(
literal|"JNG + delta PNG"
argument_list|)
argument_list|,
name|CHUNKS_JNG_D
argument_list|,
name|_
argument_list|(
literal|"All PNG"
argument_list|)
argument_list|,
name|CHUNKS_PNG
argument_list|,
name|_
argument_list|(
literal|"All JNG"
argument_list|)
argument_list|,
name|CHUNKS_JNG
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|combo
argument_list|)
argument_list|,
name|mng_data
operator|.
name|default_chunks
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|combo
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_combo_box_get_active
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|default_chunks
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|combo
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Default chunks type:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|combo
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|combo
operator|=
name|gimp_int_combo_box_new
argument_list|(
name|_
argument_list|(
literal|"Combine"
argument_list|)
argument_list|,
name|DISPOSE_COMBINE
argument_list|,
name|_
argument_list|(
literal|"Replace"
argument_list|)
argument_list|,
name|DISPOSE_REPLACE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|combo
argument_list|)
argument_list|,
name|mng_data
operator|.
name|default_dispose
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|combo
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_combo_box_get_active
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|default_dispose
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Default frame disposal:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|combo
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|scale_adj
operator|=
name|gtk_adjustment_new
argument_list|(
name|mng_data
operator|.
name|compression_level
argument_list|,
literal|0.0
argument_list|,
literal|9.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|scale
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scale_adj
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|scale
argument_list|,
name|SCALE_WIDTH
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|scale
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gtk_scale_set_digits
argument_list|(
name|GTK_SCALE
argument_list|(
name|scale
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|_
argument_list|(
literal|"PNG compression level:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.9
argument_list|,
name|scale
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scale_adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|compression_level
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|scale
argument_list|,
name|_
argument_list|(
literal|"Choose a high compression level "
literal|"for small file size"
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|scale_adj
operator|=
name|gtk_adjustment_new
argument_list|(
name|mng_data
operator|.
name|quality
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.01
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|scale
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scale_adj
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|scale
argument_list|,
name|SCALE_WIDTH
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|scale
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gtk_scale_set_digits
argument_list|(
name|GTK_SCALE
argument_list|(
name|scale
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|scale
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|_
argument_list|(
literal|"JPEG compression quality:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.9
argument_list|,
name|scale
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scale_adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|quality
argument_list|)
expr_stmt|;
name|scale_adj
operator|=
name|gtk_adjustment_new
argument_list|(
name|mng_data
operator|.
name|smoothing
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.01
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|scale
operator|=
name|gtk_hscale_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scale_adj
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|scale
argument_list|,
name|SCALE_WIDTH
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_scale_set_value_pos
argument_list|(
name|GTK_SCALE
argument_list|(
name|scale
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gtk_scale_set_digits
argument_list|(
name|GTK_SCALE
argument_list|(
name|scale
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|scale
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
name|_
argument_list|(
literal|"JPEG smoothing factor:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.9
argument_list|,
name|scale
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|scale_adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|smoothing
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Animated MNG Options"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Loop"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|loop
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|mng_data
operator|.
name|loop
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Default frame delay:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|spinbutton
operator|=
name|gimp_spin_button_new
argument_list|(
operator|&
name|spinbutton_adj
argument_list|,
name|mng_data
operator|.
name|default_delay
argument_list|,
literal|0
argument_list|,
literal|65000
argument_list|,
literal|10
argument_list|,
literal|100
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|spinbutton_adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|mng_data
operator|.
name|default_delay
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|spinbutton
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|spinbutton
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"milliseconds"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|<=
literal|1
condition|)
block|{
name|gtk_widget_set_sensitive
argument_list|(
name|frame
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|frame
argument_list|,
name|_
argument_list|(
literal|"These options are only available when "
literal|"the exported image has more than one "
literal|"layer. The image you are exporting only has "
literal|"one layer."
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_show
argument_list|(
name|main_vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|run
operator|=
operator|(
name|gimp_dialog_run
argument_list|(
name|GIMP_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|)
operator|==
name|GTK_RESPONSE_OK
operator|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
return|return
name|run
return|;
block|}
end_function

begin_comment
comment|/* GIMP calls these methods. */
end_comment

begin_function
specifier|static
name|void
DECL|function|query (void)
name|query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
specifier|const
name|GimpParamDef
name|save_args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run-mode"
block|,
literal|"The run mode { RUN-INTERACTIVE (0), RUN-NONINTERACTIVE (1) }"
block|}
block|,
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Input image"
block|}
block|,
block|{
name|GIMP_PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Drawable to save"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"filename"
block|,
literal|"The name of the file to save the image in"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"raw-filename"
block|,
literal|"The name of the file to save the image in"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"interlace"
block|,
literal|"Use interlacing"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"compression"
block|,
literal|"PNG deflate compression level (0 - 9)"
block|}
block|,
block|{
name|GIMP_PDB_FLOAT
block|,
literal|"quality"
block|,
literal|"JPEG quality factor (0.00 - 1.00)"
block|}
block|,
block|{
name|GIMP_PDB_FLOAT
block|,
literal|"smoothing"
block|,
literal|"JPEG smoothing factor (0.00 - 1.00)"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"loop"
block|,
literal|"(ANIMATED MNG) Loop infinitely"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"default-delay"
block|,
literal|"(ANIMATED MNG) Default delay between frames in milliseconds"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"default-chunks"
block|,
literal|"(ANIMATED MNG) Default chunks type (0 = PNG + Delta PNG; 1 = JNG + Delta PNG; 2 = All PNG; 3 = All JNG)"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"default-dispose"
block|,
literal|"(ANIMATED MNG) Default dispose type (0 = combine; 1 = replace)"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"bkgd"
block|,
literal|"Write bKGD (background color) chunk"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"gama"
block|,
literal|"Write gAMA (gamma) chunk"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"phys"
block|,
literal|"Write pHYs (image resolution) chunk"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"time"
block|,
literal|"Write tIME (creation time) chunk"
block|}
block|}
decl_stmt|;
name|gimp_install_procedure
argument_list|(
name|SAVE_PROC
argument_list|,
literal|"Saves images in the MNG file format"
argument_list|,
literal|"This plug-in saves images in the Multiple-image "
literal|"Network Graphics (MNG) format which can be used as "
literal|"a replacement for animated GIFs, and more."
argument_list|,
literal|"Mukund Sivaraman<muks@mukund.org>"
argument_list|,
literal|"Mukund Sivaraman<muks@mukund.org>"
argument_list|,
literal|"November 19, 2002"
argument_list|,
name|N_
argument_list|(
literal|"MNG animation"
argument_list|)
argument_list|,
literal|"RGB*,GRAY*,INDEXED*"
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|save_args
argument_list|)
argument_list|,
literal|0
argument_list|,
name|save_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_register_file_handler_mime
argument_list|(
name|SAVE_PROC
argument_list|,
literal|"image/x-mng"
argument_list|)
expr_stmt|;
name|gimp_register_save_handler
argument_list|(
name|SAVE_PROC
argument_list|,
literal|"mng"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GimpParam
name|values
index|[
literal|2
index|]
decl_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_SUCCESS
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|SAVE_PROC
argument_list|)
operator|==
literal|0
condition|)
block|{
name|GimpRunMode
name|run_mode
init|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
decl_stmt|;
name|gint32
name|image_id
init|=
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_int32
decl_stmt|;
name|gint32
name|original_image_id
init|=
name|image_id
decl_stmt|;
name|gint32
name|drawable_id
init|=
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_int32
decl_stmt|;
name|GimpExportReturn
name|export
init|=
name|GIMP_EXPORT_IGNORE
decl_stmt|;
if|if
condition|(
operator|(
name|run_mode
operator|==
name|GIMP_RUN_INTERACTIVE
operator|)
operator|||
operator|(
name|run_mode
operator|==
name|GIMP_RUN_WITH_LAST_VALS
operator|)
condition|)
block|{
name|gimp_procedural_db_get_data
argument_list|(
name|SAVE_PROC
argument_list|,
operator|&
name|mng_data
argument_list|)
expr_stmt|;
name|gimp_ui_init
argument_list|(
name|PLUG_IN_BINARY
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|export
operator|=
name|gimp_export_image
argument_list|(
operator|&
name|image_id
argument_list|,
operator|&
name|drawable_id
argument_list|,
name|NULL
argument_list|,
operator|(
name|GIMP_EXPORT_CAN_HANDLE_RGB
operator||
name|GIMP_EXPORT_CAN_HANDLE_GRAY
operator||
name|GIMP_EXPORT_CAN_HANDLE_INDEXED
operator||
name|GIMP_EXPORT_CAN_HANDLE_ALPHA
operator||
name|GIMP_EXPORT_CAN_HANDLE_LAYERS
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|export
operator|==
name|GIMP_EXPORT_CANCEL
condition|)
block|{
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_CANCEL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|export
operator|==
name|GIMP_EXPORT_IGNORE
operator|||
name|export
operator|==
name|GIMP_EXPORT_EXPORT
condition|)
block|{
if|if
condition|(
name|run_mode
operator|==
name|GIMP_RUN_INTERACTIVE
condition|)
block|{
if|if
condition|(
name|mng_save_dialog
argument_list|(
name|image_id
argument_list|)
operator|==
literal|0
condition|)
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_CANCEL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|run_mode
operator|==
name|GIMP_RUN_NONINTERACTIVE
condition|)
block|{
if|if
condition|(
name|nparams
operator|!=
literal|17
condition|)
block|{
name|g_message
argument_list|(
literal|"Incorrect number of parameters "
literal|"passed to file-mng-save()"
argument_list|)
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
else|else
block|{
name|mng_data
operator|.
name|interlaced
operator|=
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|compression_level
operator|=
name|param
index|[
literal|6
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|quality
operator|=
name|param
index|[
literal|7
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
name|mng_data
operator|.
name|smoothing
operator|=
name|param
index|[
literal|8
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
name|mng_data
operator|.
name|loop
operator|=
name|param
index|[
literal|9
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|default_delay
operator|=
name|param
index|[
literal|10
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|default_chunks
operator|=
name|param
index|[
literal|11
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|default_dispose
operator|=
name|param
index|[
literal|12
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|bkgd
operator|=
name|param
index|[
literal|13
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|gama
operator|=
name|param
index|[
literal|14
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|phys
operator|=
name|param
index|[
literal|15
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|mng_data
operator|.
name|time
operator|=
name|param
index|[
literal|16
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
if|if
condition|(
operator|(
name|mng_data
operator|.
name|compression_level
operator|<
literal|0
operator|)
operator|||
operator|(
name|mng_data
operator|.
name|compression_level
operator|>
literal|9
operator|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Parameter 'compression_level' passed to "
literal|"file-mng-save() must be in the range 0 - 9; "
literal|"Clamping it to the default value of 6."
argument_list|)
expr_stmt|;
name|mng_data
operator|.
name|compression_level
operator|=
literal|6
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mng_data
operator|.
name|quality
operator|<
operator|(
operator|(
name|float
operator|)
literal|0
operator|)
operator|)
operator|||
operator|(
name|mng_data
operator|.
name|quality
operator|>
operator|(
operator|(
name|float
operator|)
literal|1
operator|)
operator|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Parameter 'quality' passed to "
literal|"file-mng-save() must be in the range "
literal|"0.00 - 1.00; Clamping it to the "
literal|"default value of 0.75."
argument_list|)
expr_stmt|;
name|mng_data
operator|.
name|quality
operator|=
literal|0.75
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mng_data
operator|.
name|smoothing
operator|<
operator|(
operator|(
name|float
operator|)
literal|0
operator|)
operator|)
operator|||
operator|(
name|mng_data
operator|.
name|smoothing
operator|>
operator|(
operator|(
name|float
operator|)
literal|1
operator|)
operator|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Parameter 'smoothing' passed to "
literal|"file-mng-save() must be in the "
literal|"range 0.00 - 1.00; Clamping it to "
literal|"the default value of 0.00."
argument_list|)
expr_stmt|;
name|mng_data
operator|.
name|smoothing
operator|=
literal|0.0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mng_data
operator|.
name|default_chunks
operator|<
literal|0
operator|)
operator|||
operator|(
name|mng_data
operator|.
name|default_chunks
operator|>
literal|3
operator|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Parameter 'default_chunks' passed to "
literal|"file-mng-save() must be in the range 0 - 2."
argument_list|)
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mng_data
operator|.
name|default_dispose
operator|<
literal|0
operator|)
operator|||
operator|(
name|mng_data
operator|.
name|default_dispose
operator|>
literal|1
operator|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Parameter 'default_dispose' passed to "
literal|"file-mng-save() must be in the range 0 - 1."
argument_list|)
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
block|{
name|GError
modifier|*
name|error
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|mng_save_image
argument_list|(
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|,
name|image_id
argument_list|,
name|drawable_id
argument_list|,
name|original_image_id
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|gimp_set_data
argument_list|(
name|SAVE_PROC
argument_list|,
operator|&
name|mng_data
argument_list|,
sizeof|sizeof
argument_list|(
name|mng_data
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
operator|*
name|nreturn_vals
operator|=
literal|2
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
operator|=
name|error
operator|->
name|message
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|export
operator|==
name|GIMP_EXPORT_EXPORT
condition|)
name|gimp_image_delete
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Only query and run are implemented by this plug-in. */
end_comment

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
specifier|const
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|query
block|,
name|run
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|MAIN
argument_list|()
end_macro

end_unit

