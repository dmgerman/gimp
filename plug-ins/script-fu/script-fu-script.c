begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"tinyscheme/scheme-private.h"
end_include

begin_include
include|#
directive|include
file|"script-fu-types.h"
end_include

begin_include
include|#
directive|include
file|"script-fu-script.h"
end_include

begin_include
include|#
directive|include
file|"script-fu-scripts.h"
end_include

begin_include
include|#
directive|include
file|"script-fu-utils.h"
end_include

begin_include
include|#
directive|include
file|"script-fu-intl.h"
end_include

begin_comment
comment|/*  *  Local Functions  */
end_comment

begin_function_decl
specifier|static
name|gboolean
name|script_fu_script_param_init
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|params
parameter_list|,
name|SFArgType
name|type
parameter_list|,
name|gint
name|n
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  *  Function definitions  */
end_comment

begin_function
name|SFScript
modifier|*
DECL|function|script_fu_script_new (const gchar * name,const gchar * menu_label,const gchar * blurb,const gchar * author,const gchar * copyright,const gchar * date,const gchar * image_types,gint n_args)
name|script_fu_script_new
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
specifier|const
name|gchar
modifier|*
name|menu_label
parameter_list|,
specifier|const
name|gchar
modifier|*
name|blurb
parameter_list|,
specifier|const
name|gchar
modifier|*
name|author
parameter_list|,
specifier|const
name|gchar
modifier|*
name|copyright
parameter_list|,
specifier|const
name|gchar
modifier|*
name|date
parameter_list|,
specifier|const
name|gchar
modifier|*
name|image_types
parameter_list|,
name|gint
name|n_args
parameter_list|)
block|{
name|SFScript
modifier|*
name|script
decl_stmt|;
name|script
operator|=
name|g_slice_new0
argument_list|(
name|SFScript
argument_list|)
expr_stmt|;
name|script
operator|->
name|name
operator|=
name|g_strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|script
operator|->
name|menu_label
operator|=
name|g_strdup
argument_list|(
name|menu_label
argument_list|)
expr_stmt|;
name|script
operator|->
name|blurb
operator|=
name|g_strdup
argument_list|(
name|blurb
argument_list|)
expr_stmt|;
name|script
operator|->
name|author
operator|=
name|g_strdup
argument_list|(
name|author
argument_list|)
expr_stmt|;
name|script
operator|->
name|copyright
operator|=
name|g_strdup
argument_list|(
name|copyright
argument_list|)
expr_stmt|;
name|script
operator|->
name|date
operator|=
name|g_strdup
argument_list|(
name|date
argument_list|)
expr_stmt|;
name|script
operator|->
name|image_types
operator|=
name|g_strdup
argument_list|(
name|image_types
argument_list|)
expr_stmt|;
name|script
operator|->
name|n_args
operator|=
name|n_args
expr_stmt|;
name|script
operator|->
name|args
operator|=
name|g_new0
argument_list|(
name|SFArg
argument_list|,
name|script
operator|->
name|n_args
argument_list|)
expr_stmt|;
return|return
name|script
return|;
block|}
end_function

begin_function
name|void
DECL|function|script_fu_script_free (SFScript * script)
name|script_fu_script_free
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|script
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|script
operator|->
name|name
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|script
operator|->
name|blurb
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|script
operator|->
name|menu_label
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|script
operator|->
name|author
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|script
operator|->
name|copyright
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|script
operator|->
name|date
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|script
operator|->
name|image_types
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|script
operator|->
name|n_args
condition|;
name|i
operator|++
control|)
block|{
name|SFArg
modifier|*
name|arg
init|=
operator|&
name|script
operator|->
name|args
index|[
name|i
index|]
decl_stmt|;
name|g_free
argument_list|(
name|arg
operator|->
name|label
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|arg
operator|->
name|type
condition|)
block|{
case|case
name|SF_IMAGE
case|:
case|case
name|SF_DRAWABLE
case|:
case|case
name|SF_LAYER
case|:
case|case
name|SF_CHANNEL
case|:
case|case
name|SF_VECTORS
case|:
case|case
name|SF_DISPLAY
case|:
case|case
name|SF_COLOR
case|:
case|case
name|SF_TOGGLE
case|:
break|break;
case|case
name|SF_VALUE
case|:
case|case
name|SF_STRING
case|:
case|case
name|SF_TEXT
case|:
name|g_free
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_value
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|arg
operator|->
name|value
operator|.
name|sfa_value
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_ADJUSTMENT
case|:
break|break;
case|case
name|SF_FILENAME
case|:
case|case
name|SF_DIRNAME
case|:
name|g_free
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_file
operator|.
name|filename
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|arg
operator|->
name|value
operator|.
name|sfa_file
operator|.
name|filename
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_FONT
case|:
name|g_free
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_font
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|arg
operator|->
name|value
operator|.
name|sfa_font
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_PALETTE
case|:
name|g_free
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_palette
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|arg
operator|->
name|value
operator|.
name|sfa_palette
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_PATTERN
case|:
name|g_free
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_pattern
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|arg
operator|->
name|value
operator|.
name|sfa_pattern
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_GRADIENT
case|:
name|g_free
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_gradient
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|arg
operator|->
name|value
operator|.
name|sfa_gradient
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_BRUSH
case|:
name|g_free
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_brush
operator|.
name|name
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|arg
operator|->
name|value
operator|.
name|sfa_brush
operator|.
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_OPTION
case|:
name|g_slist_free_full
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_option
operator|.
name|list
argument_list|,
operator|(
name|GDestroyNotify
operator|)
name|g_free
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_ENUM
case|:
name|g_free
argument_list|(
name|arg
operator|->
name|default_value
operator|.
name|sfa_enum
operator|.
name|type_name
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|g_free
argument_list|(
name|script
operator|->
name|args
argument_list|)
expr_stmt|;
name|g_slice_free
argument_list|(
name|SFScript
argument_list|,
name|script
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|script_fu_script_install_proc (SFScript * script,GimpRunProc run_proc)
name|script_fu_script_install_proc
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|,
name|GimpRunProc
name|run_proc
parameter_list|)
block|{
specifier|const
name|gchar
modifier|*
name|menu_label
init|=
name|NULL
decl_stmt|;
name|GimpParamDef
modifier|*
name|args
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|script
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_return_if_fail
argument_list|(
name|run_proc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Allow scripts with no menus */
if|if
condition|(
name|strncmp
argument_list|(
name|script
operator|->
name|menu_label
argument_list|,
literal|"<None>"
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
name|menu_label
operator|=
name|script
operator|->
name|menu_label
expr_stmt|;
name|args
operator|=
name|g_new0
argument_list|(
name|GimpParamDef
argument_list|,
name|script
operator|->
name|n_args
operator|+
literal|1
argument_list|)
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_INT32
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|.
name|name
operator|=
literal|"run-mode"
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|.
name|description
operator|=
literal|"The run mode { RUN-INTERACTIVE (0), RUN-NONINTERACTIVE (1) }"
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|script
operator|->
name|n_args
condition|;
name|i
operator|++
control|)
block|{
name|GimpPDBArgType
name|type
init|=
literal|0
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|script
operator|->
name|args
index|[
name|i
index|]
operator|.
name|type
condition|)
block|{
case|case
name|SF_IMAGE
case|:
name|type
operator|=
name|GIMP_PDB_IMAGE
expr_stmt|;
name|name
operator|=
literal|"image"
expr_stmt|;
break|break;
case|case
name|SF_DRAWABLE
case|:
name|type
operator|=
name|GIMP_PDB_DRAWABLE
expr_stmt|;
name|name
operator|=
literal|"drawable"
expr_stmt|;
break|break;
case|case
name|SF_LAYER
case|:
name|type
operator|=
name|GIMP_PDB_LAYER
expr_stmt|;
name|name
operator|=
literal|"layer"
expr_stmt|;
break|break;
case|case
name|SF_CHANNEL
case|:
name|type
operator|=
name|GIMP_PDB_CHANNEL
expr_stmt|;
name|name
operator|=
literal|"channel"
expr_stmt|;
break|break;
case|case
name|SF_VECTORS
case|:
name|type
operator|=
name|GIMP_PDB_VECTORS
expr_stmt|;
name|name
operator|=
literal|"vectors"
expr_stmt|;
break|break;
case|case
name|SF_DISPLAY
case|:
name|type
operator|=
name|GIMP_PDB_DISPLAY
expr_stmt|;
name|name
operator|=
literal|"display"
expr_stmt|;
break|break;
case|case
name|SF_COLOR
case|:
name|type
operator|=
name|GIMP_PDB_COLOR
expr_stmt|;
name|name
operator|=
literal|"color"
expr_stmt|;
break|break;
case|case
name|SF_TOGGLE
case|:
name|type
operator|=
name|GIMP_PDB_INT32
expr_stmt|;
name|name
operator|=
literal|"toggle"
expr_stmt|;
break|break;
case|case
name|SF_VALUE
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"value"
expr_stmt|;
break|break;
case|case
name|SF_STRING
case|:
case|case
name|SF_TEXT
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"string"
expr_stmt|;
break|break;
case|case
name|SF_ADJUSTMENT
case|:
name|type
operator|=
name|GIMP_PDB_FLOAT
expr_stmt|;
name|name
operator|=
literal|"value"
expr_stmt|;
break|break;
case|case
name|SF_FILENAME
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"filename"
expr_stmt|;
break|break;
case|case
name|SF_DIRNAME
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"dirname"
expr_stmt|;
break|break;
case|case
name|SF_FONT
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"font"
expr_stmt|;
break|break;
case|case
name|SF_PALETTE
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"palette"
expr_stmt|;
break|break;
case|case
name|SF_PATTERN
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"pattern"
expr_stmt|;
break|break;
case|case
name|SF_BRUSH
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"brush"
expr_stmt|;
break|break;
case|case
name|SF_GRADIENT
case|:
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|name
operator|=
literal|"gradient"
expr_stmt|;
break|break;
case|case
name|SF_OPTION
case|:
name|type
operator|=
name|GIMP_PDB_INT32
expr_stmt|;
name|name
operator|=
literal|"option"
expr_stmt|;
break|break;
case|case
name|SF_ENUM
case|:
name|type
operator|=
name|GIMP_PDB_INT32
expr_stmt|;
name|name
operator|=
literal|"enum"
expr_stmt|;
break|break;
block|}
name|args
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|type
operator|=
name|type
expr_stmt|;
name|args
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|name
operator|=
operator|(
name|gchar
operator|*
operator|)
name|name
expr_stmt|;
name|args
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|description
operator|=
name|script
operator|->
name|args
index|[
name|i
index|]
operator|.
name|label
expr_stmt|;
block|}
name|gimp_install_temp_proc
argument_list|(
name|script
operator|->
name|name
argument_list|,
name|script
operator|->
name|blurb
argument_list|,
literal|""
argument_list|,
name|script
operator|->
name|author
argument_list|,
name|script
operator|->
name|copyright
argument_list|,
name|script
operator|->
name|date
argument_list|,
name|menu_label
argument_list|,
name|script
operator|->
name|image_types
argument_list|,
name|GIMP_TEMPORARY
argument_list|,
name|script
operator|->
name|n_args
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|args
argument_list|,
name|NULL
argument_list|,
name|run_proc
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|script_fu_script_uninstall_proc (SFScript * script)
name|script_fu_script_uninstall_proc
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|script
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|gimp_uninstall_temp_proc
argument_list|(
name|script
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|gchar
modifier|*
DECL|function|script_fu_script_get_title (SFScript * script)
name|script_fu_script_get_title
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|)
block|{
name|gchar
modifier|*
name|title
decl_stmt|;
name|gchar
modifier|*
name|tmp
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|script
operator|!=
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* strip mnemonics from the menupath */
name|title
operator|=
name|gimp_strip_uline
argument_list|(
name|gettext
argument_list|(
name|script
operator|->
name|menu_label
argument_list|)
argument_list|)
expr_stmt|;
comment|/* if this looks like a full menu path, use only the last part */
if|if
condition|(
name|title
index|[
literal|0
index|]
operator|==
literal|'<'
operator|&&
operator|(
name|tmp
operator|=
name|strrchr
argument_list|(
name|title
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|&&
name|tmp
index|[
literal|1
index|]
condition|)
block|{
name|tmp
operator|=
name|g_strdup
argument_list|(
name|tmp
operator|+
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|title
argument_list|)
expr_stmt|;
name|title
operator|=
name|tmp
expr_stmt|;
block|}
comment|/* cut off ellipsis */
name|tmp
operator|=
operator|(
name|strstr
argument_list|(
name|title
argument_list|,
literal|"..."
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
comment|/* U+2026 HORIZONTAL ELLIPSIS */
name|tmp
operator|=
name|strstr
argument_list|(
name|title
argument_list|,
literal|"\342\200\246"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&&
name|tmp
operator|==
operator|(
name|title
operator|+
name|strlen
argument_list|(
name|title
argument_list|)
operator|-
literal|3
operator|)
condition|)
operator|*
name|tmp
operator|=
literal|'\0'
expr_stmt|;
return|return
name|title
return|;
block|}
end_function

begin_function
name|void
DECL|function|script_fu_script_reset (SFScript * script,gboolean reset_ids)
name|script_fu_script_reset
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|,
name|gboolean
name|reset_ids
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|script
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|script
operator|->
name|n_args
condition|;
name|i
operator|++
control|)
block|{
name|SFArgValue
modifier|*
name|value
init|=
operator|&
name|script
operator|->
name|args
index|[
name|i
index|]
operator|.
name|value
decl_stmt|;
name|SFArgValue
modifier|*
name|default_value
init|=
operator|&
name|script
operator|->
name|args
index|[
name|i
index|]
operator|.
name|default_value
decl_stmt|;
switch|switch
condition|(
name|script
operator|->
name|args
index|[
name|i
index|]
operator|.
name|type
condition|)
block|{
case|case
name|SF_IMAGE
case|:
case|case
name|SF_DRAWABLE
case|:
case|case
name|SF_LAYER
case|:
case|case
name|SF_CHANNEL
case|:
case|case
name|SF_VECTORS
case|:
case|case
name|SF_DISPLAY
case|:
if|if
condition|(
name|reset_ids
condition|)
name|value
operator|->
name|sfa_image
operator|=
name|default_value
operator|->
name|sfa_image
expr_stmt|;
break|break;
case|case
name|SF_COLOR
case|:
name|value
operator|->
name|sfa_color
operator|=
name|default_value
operator|->
name|sfa_color
expr_stmt|;
break|break;
case|case
name|SF_TOGGLE
case|:
name|value
operator|->
name|sfa_toggle
operator|=
name|default_value
operator|->
name|sfa_toggle
expr_stmt|;
break|break;
case|case
name|SF_VALUE
case|:
case|case
name|SF_STRING
case|:
case|case
name|SF_TEXT
case|:
name|g_free
argument_list|(
name|value
operator|->
name|sfa_value
argument_list|)
expr_stmt|;
name|value
operator|->
name|sfa_value
operator|=
name|g_strdup
argument_list|(
name|default_value
operator|->
name|sfa_value
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_ADJUSTMENT
case|:
name|value
operator|->
name|sfa_adjustment
operator|.
name|value
operator|=
name|default_value
operator|->
name|sfa_adjustment
operator|.
name|value
expr_stmt|;
break|break;
case|case
name|SF_FILENAME
case|:
case|case
name|SF_DIRNAME
case|:
name|g_free
argument_list|(
name|value
operator|->
name|sfa_file
operator|.
name|filename
argument_list|)
expr_stmt|;
name|value
operator|->
name|sfa_file
operator|.
name|filename
operator|=
name|g_strdup
argument_list|(
name|default_value
operator|->
name|sfa_file
operator|.
name|filename
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_FONT
case|:
name|g_free
argument_list|(
name|value
operator|->
name|sfa_font
argument_list|)
expr_stmt|;
name|value
operator|->
name|sfa_font
operator|=
name|g_strdup
argument_list|(
name|default_value
operator|->
name|sfa_font
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_PALETTE
case|:
name|g_free
argument_list|(
name|value
operator|->
name|sfa_palette
argument_list|)
expr_stmt|;
name|value
operator|->
name|sfa_palette
operator|=
name|g_strdup
argument_list|(
name|default_value
operator|->
name|sfa_palette
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_PATTERN
case|:
name|g_free
argument_list|(
name|value
operator|->
name|sfa_pattern
argument_list|)
expr_stmt|;
name|value
operator|->
name|sfa_pattern
operator|=
name|g_strdup
argument_list|(
name|default_value
operator|->
name|sfa_pattern
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_GRADIENT
case|:
name|g_free
argument_list|(
name|value
operator|->
name|sfa_gradient
argument_list|)
expr_stmt|;
name|value
operator|->
name|sfa_gradient
operator|=
name|g_strdup
argument_list|(
name|default_value
operator|->
name|sfa_gradient
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_BRUSH
case|:
name|g_free
argument_list|(
name|value
operator|->
name|sfa_brush
operator|.
name|name
argument_list|)
expr_stmt|;
name|value
operator|->
name|sfa_brush
operator|.
name|name
operator|=
name|g_strdup
argument_list|(
name|default_value
operator|->
name|sfa_brush
operator|.
name|name
argument_list|)
expr_stmt|;
name|value
operator|->
name|sfa_brush
operator|.
name|opacity
operator|=
name|default_value
operator|->
name|sfa_brush
operator|.
name|opacity
expr_stmt|;
name|value
operator|->
name|sfa_brush
operator|.
name|spacing
operator|=
name|default_value
operator|->
name|sfa_brush
operator|.
name|spacing
expr_stmt|;
name|value
operator|->
name|sfa_brush
operator|.
name|paint_mode
operator|=
name|default_value
operator|->
name|sfa_brush
operator|.
name|paint_mode
expr_stmt|;
break|break;
case|case
name|SF_OPTION
case|:
name|value
operator|->
name|sfa_option
operator|.
name|history
operator|=
name|default_value
operator|->
name|sfa_option
operator|.
name|history
expr_stmt|;
break|break;
case|case
name|SF_ENUM
case|:
name|value
operator|->
name|sfa_enum
operator|.
name|history
operator|=
name|default_value
operator|->
name|sfa_enum
operator|.
name|history
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
name|gint
DECL|function|script_fu_script_collect_standard_args (SFScript * script,gint n_params,const GimpParam * params)
name|script_fu_script_collect_standard_args
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|,
name|gint
name|n_params
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|params
parameter_list|)
block|{
name|gint
name|params_consumed
init|=
literal|0
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|script
operator|!=
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*  the first parameter may be a DISPLAY id  */
if|if
condition|(
name|script_fu_script_param_init
argument_list|(
name|script
argument_list|,
name|n_params
argument_list|,
name|params
argument_list|,
name|SF_DISPLAY
argument_list|,
name|params_consumed
argument_list|)
condition|)
block|{
name|params_consumed
operator|++
expr_stmt|;
block|}
comment|/*  an IMAGE id may come first or after the DISPLAY id  */
if|if
condition|(
name|script_fu_script_param_init
argument_list|(
name|script
argument_list|,
name|n_params
argument_list|,
name|params
argument_list|,
name|SF_IMAGE
argument_list|,
name|params_consumed
argument_list|)
condition|)
block|{
name|params_consumed
operator|++
expr_stmt|;
comment|/*  and may be followed by a DRAWABLE, LAYER, CHANNEL or        *  VECTORS id        */
if|if
condition|(
name|script_fu_script_param_init
argument_list|(
name|script
argument_list|,
name|n_params
argument_list|,
name|params
argument_list|,
name|SF_DRAWABLE
argument_list|,
name|params_consumed
argument_list|)
operator|||
name|script_fu_script_param_init
argument_list|(
name|script
argument_list|,
name|n_params
argument_list|,
name|params
argument_list|,
name|SF_LAYER
argument_list|,
name|params_consumed
argument_list|)
operator|||
name|script_fu_script_param_init
argument_list|(
name|script
argument_list|,
name|n_params
argument_list|,
name|params
argument_list|,
name|SF_CHANNEL
argument_list|,
name|params_consumed
argument_list|)
operator|||
name|script_fu_script_param_init
argument_list|(
name|script
argument_list|,
name|n_params
argument_list|,
name|params
argument_list|,
name|SF_VECTORS
argument_list|,
name|params_consumed
argument_list|)
condition|)
block|{
name|params_consumed
operator|++
expr_stmt|;
block|}
block|}
return|return
name|params_consumed
return|;
block|}
end_function

begin_function
name|gchar
modifier|*
DECL|function|script_fu_script_get_command (SFScript * script)
name|script_fu_script_get_command
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|)
block|{
name|GString
modifier|*
name|s
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|script
operator|!=
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|s
operator|=
name|g_string_new
argument_list|(
literal|"("
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|s
argument_list|,
name|script
operator|->
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|script
operator|->
name|n_args
condition|;
name|i
operator|++
control|)
block|{
name|SFArgValue
modifier|*
name|arg_value
init|=
operator|&
name|script
operator|->
name|args
index|[
name|i
index|]
operator|.
name|value
decl_stmt|;
name|g_string_append_c
argument_list|(
name|s
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|script
operator|->
name|args
index|[
name|i
index|]
operator|.
name|type
condition|)
block|{
case|case
name|SF_IMAGE
case|:
case|case
name|SF_DRAWABLE
case|:
case|case
name|SF_LAYER
case|:
case|case
name|SF_CHANNEL
case|:
case|case
name|SF_VECTORS
case|:
case|case
name|SF_DISPLAY
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"%d"
argument_list|,
name|arg_value
operator|->
name|sfa_image
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_COLOR
case|:
block|{
name|guchar
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|gimp_rgb_get_uchar
argument_list|(
operator|&
name|arg_value
operator|->
name|sfa_color
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"'(%d %d %d)"
argument_list|,
operator|(
name|gint
operator|)
name|r
argument_list|,
operator|(
name|gint
operator|)
name|g
argument_list|,
operator|(
name|gint
operator|)
name|b
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SF_TOGGLE
case|:
name|g_string_append
argument_list|(
name|s
argument_list|,
name|arg_value
operator|->
name|sfa_toggle
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_VALUE
case|:
name|g_string_append
argument_list|(
name|s
argument_list|,
name|arg_value
operator|->
name|sfa_value
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_STRING
case|:
case|case
name|SF_TEXT
case|:
block|{
name|gchar
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|script_fu_strescape
argument_list|(
name|arg_value
operator|->
name|sfa_value
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"\"%s\""
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SF_ADJUSTMENT
case|:
block|{
name|gchar
name|buffer
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|g_ascii_dtostr
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|arg_value
operator|->
name|sfa_adjustment
operator|.
name|value
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|s
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SF_FILENAME
case|:
case|case
name|SF_DIRNAME
case|:
block|{
name|gchar
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|script_fu_strescape
argument_list|(
name|arg_value
operator|->
name|sfa_file
operator|.
name|filename
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"\"%s\""
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SF_FONT
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"\"%s\""
argument_list|,
name|arg_value
operator|->
name|sfa_font
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_PALETTE
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"\"%s\""
argument_list|,
name|arg_value
operator|->
name|sfa_palette
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_PATTERN
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"\"%s\""
argument_list|,
name|arg_value
operator|->
name|sfa_pattern
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_GRADIENT
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"\"%s\""
argument_list|,
name|arg_value
operator|->
name|sfa_gradient
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_BRUSH
case|:
block|{
name|gchar
name|buffer
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|g_ascii_dtostr
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|arg_value
operator|->
name|sfa_brush
operator|.
name|opacity
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"'(\"%s\" %s %d %d)"
argument_list|,
name|arg_value
operator|->
name|sfa_brush
operator|.
name|name
argument_list|,
name|buffer
argument_list|,
name|arg_value
operator|->
name|sfa_brush
operator|.
name|spacing
argument_list|,
name|arg_value
operator|->
name|sfa_brush
operator|.
name|paint_mode
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SF_OPTION
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"%d"
argument_list|,
name|arg_value
operator|->
name|sfa_option
operator|.
name|history
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_ENUM
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"%d"
argument_list|,
name|arg_value
operator|->
name|sfa_enum
operator|.
name|history
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|g_string_append_c
argument_list|(
name|s
argument_list|,
literal|')'
argument_list|)
expr_stmt|;
return|return
name|g_string_free
argument_list|(
name|s
argument_list|,
name|FALSE
argument_list|)
return|;
block|}
end_function

begin_function
name|gchar
modifier|*
DECL|function|script_fu_script_get_command_from_params (SFScript * script,const GimpParam * params)
name|script_fu_script_get_command_from_params
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|params
parameter_list|)
block|{
name|GString
modifier|*
name|s
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|script
operator|!=
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|s
operator|=
name|g_string_new
argument_list|(
literal|"("
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|s
argument_list|,
name|script
operator|->
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|script
operator|->
name|n_args
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|GimpParam
modifier|*
name|param
init|=
operator|&
name|params
index|[
name|i
operator|+
literal|1
index|]
decl_stmt|;
name|g_string_append_c
argument_list|(
name|s
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|script
operator|->
name|args
index|[
name|i
index|]
operator|.
name|type
condition|)
block|{
case|case
name|SF_IMAGE
case|:
case|case
name|SF_DRAWABLE
case|:
case|case
name|SF_LAYER
case|:
case|case
name|SF_CHANNEL
case|:
case|case
name|SF_VECTORS
case|:
case|case
name|SF_DISPLAY
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"%d"
argument_list|,
name|param
operator|->
name|data
operator|.
name|d_int32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_COLOR
case|:
block|{
name|guchar
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|gimp_rgb_get_uchar
argument_list|(
operator|&
name|param
operator|->
name|data
operator|.
name|d_color
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"'(%d %d %d)"
argument_list|,
operator|(
name|gint
operator|)
name|r
argument_list|,
operator|(
name|gint
operator|)
name|g
argument_list|,
operator|(
name|gint
operator|)
name|b
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SF_TOGGLE
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
operator|(
name|param
operator|->
name|data
operator|.
name|d_int32
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_VALUE
case|:
name|g_string_append
argument_list|(
name|s
argument_list|,
name|param
operator|->
name|data
operator|.
name|d_string
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_STRING
case|:
case|case
name|SF_TEXT
case|:
case|case
name|SF_FILENAME
case|:
case|case
name|SF_DIRNAME
case|:
block|{
name|gchar
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|script_fu_strescape
argument_list|(
name|param
operator|->
name|data
operator|.
name|d_string
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"\"%s\""
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SF_ADJUSTMENT
case|:
block|{
name|gchar
name|buffer
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|g_ascii_dtostr
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|param
operator|->
name|data
operator|.
name|d_float
argument_list|)
expr_stmt|;
name|g_string_append
argument_list|(
name|s
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SF_FONT
case|:
case|case
name|SF_PALETTE
case|:
case|case
name|SF_PATTERN
case|:
case|case
name|SF_GRADIENT
case|:
case|case
name|SF_BRUSH
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"\"%s\""
argument_list|,
name|param
operator|->
name|data
operator|.
name|d_string
argument_list|)
expr_stmt|;
break|break;
case|case
name|SF_OPTION
case|:
case|case
name|SF_ENUM
case|:
name|g_string_append_printf
argument_list|(
name|s
argument_list|,
literal|"%d"
argument_list|,
name|param
operator|->
name|data
operator|.
name|d_int32
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|g_string_append_c
argument_list|(
name|s
argument_list|,
literal|')'
argument_list|)
expr_stmt|;
return|return
name|g_string_free
argument_list|(
name|s
argument_list|,
name|FALSE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  *  Local Functions  */
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|script_fu_script_param_init (SFScript * script,gint nparams,const GimpParam * params,SFArgType type,gint n)
name|script_fu_script_param_init
parameter_list|(
name|SFScript
modifier|*
name|script
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|params
parameter_list|,
name|SFArgType
name|type
parameter_list|,
name|gint
name|n
parameter_list|)
block|{
name|SFArg
modifier|*
name|arg
init|=
operator|&
name|script
operator|->
name|args
index|[
name|n
index|]
decl_stmt|;
if|if
condition|(
name|script
operator|->
name|n_args
operator|>
name|n
operator|&&
name|arg
operator|->
name|type
operator|==
name|type
operator|&&
name|nparams
operator|>
name|n
operator|+
literal|1
condition|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SF_IMAGE
case|:
if|if
condition|(
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|type
operator|==
name|GIMP_PDB_IMAGE
condition|)
block|{
name|arg
operator|->
name|value
operator|.
name|sfa_image
operator|=
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|SF_DRAWABLE
case|:
if|if
condition|(
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|type
operator|==
name|GIMP_PDB_DRAWABLE
condition|)
block|{
name|arg
operator|->
name|value
operator|.
name|sfa_drawable
operator|=
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|data
operator|.
name|d_drawable
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|SF_LAYER
case|:
if|if
condition|(
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|type
operator|==
name|GIMP_PDB_LAYER
condition|)
block|{
name|arg
operator|->
name|value
operator|.
name|sfa_layer
operator|=
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|data
operator|.
name|d_layer
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|SF_CHANNEL
case|:
if|if
condition|(
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|type
operator|==
name|GIMP_PDB_CHANNEL
condition|)
block|{
name|arg
operator|->
name|value
operator|.
name|sfa_channel
operator|=
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|data
operator|.
name|d_channel
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|SF_VECTORS
case|:
if|if
condition|(
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|type
operator|==
name|GIMP_PDB_VECTORS
condition|)
block|{
name|arg
operator|->
name|value
operator|.
name|sfa_vectors
operator|=
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|data
operator|.
name|d_vectors
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|SF_DISPLAY
case|:
if|if
condition|(
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|type
operator|==
name|GIMP_PDB_DISPLAY
condition|)
block|{
name|arg
operator|->
name|value
operator|.
name|sfa_display
operator|=
name|params
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|data
operator|.
name|d_display
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
default|default:
break|break;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

end_unit

