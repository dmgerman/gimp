begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Compute a preview image and preview wireframe */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_include
include|#
directive|include
file|"mapobject_preview.h"
end_include

begin_decl_stmt
DECL|variable|linetab
name|line
name|linetab
index|[
name|WIRESIZE
operator|*
literal|2
operator|+
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mat
name|gdouble
name|mat
index|[
literal|3
index|]
index|[
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|lightx
DECL|variable|lighty
name|gint
name|lightx
decl_stmt|,
name|lighty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|backbuf
name|BackBuffer
name|backbuf
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Protos */
end_comment

begin_comment
comment|/* ====== */
end_comment

begin_function_decl
name|void
name|update_light
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|draw_light_marker
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|clear_light_marker
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|draw_wireframe_plane
parameter_list|(
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|draw_wireframe_sphere
parameter_list|(
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|clear_wireframe
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**************************************************************/
end_comment

begin_comment
comment|/* Computes a preview of the rectangle starting at (x,y) with */
end_comment

begin_comment
comment|/* dimensions (w,h), placing the result in preview_RGB_data.  */
end_comment

begin_comment
comment|/**************************************************************/
end_comment

begin_function
DECL|function|compute_preview (gint x,gint y,gint w,gint h,gint pw,gint ph)
name|void
name|compute_preview
parameter_list|(
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|gint
name|w
parameter_list|,
name|gint
name|h
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|gdouble
name|xpostab
index|[
name|PREVIEW_WIDTH
index|]
decl_stmt|,
name|ypostab
index|[
name|PREVIEW_HEIGHT
index|]
decl_stmt|,
name|realw
decl_stmt|,
name|realh
decl_stmt|;
name|GckVector3
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|GckRGB
name|color
decl_stmt|,
name|lightcheck
decl_stmt|,
name|darkcheck
decl_stmt|,
name|temp
decl_stmt|;
name|guchar
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|gint
name|xcnt
decl_stmt|,
name|ycnt
decl_stmt|,
name|f1
decl_stmt|,
name|f2
decl_stmt|;
name|glong
name|index
init|=
literal|0
decl_stmt|;
name|init_compute
argument_list|()
expr_stmt|;
name|p1
operator|=
name|int_to_pos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|p2
operator|=
name|int_to_pos
argument_list|(
name|x
operator|+
name|w
argument_list|,
name|y
operator|+
name|h
argument_list|)
expr_stmt|;
comment|/* First, compute the linear mapping (x,y,x+w,y+h) to (0,0,pw,ph) */
comment|/* ============================================================== */
name|realw
operator|=
operator|(
name|p2
operator|.
name|x
operator|-
name|p1
operator|.
name|x
operator|)
expr_stmt|;
name|realh
operator|=
operator|(
name|p2
operator|.
name|y
operator|-
name|p1
operator|.
name|y
operator|)
expr_stmt|;
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|pw
condition|;
name|xcnt
operator|++
control|)
name|xpostab
index|[
name|xcnt
index|]
operator|=
name|p1
operator|.
name|x
operator|+
name|realw
operator|*
operator|(
operator|(
name|double
operator|)
name|xcnt
operator|/
operator|(
name|double
operator|)
name|pw
operator|)
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|ph
condition|;
name|ycnt
operator|++
control|)
name|ypostab
index|[
name|ycnt
index|]
operator|=
name|p1
operator|.
name|y
operator|+
name|realh
operator|*
operator|(
operator|(
name|double
operator|)
name|ycnt
operator|/
operator|(
name|double
operator|)
name|ph
operator|)
expr_stmt|;
comment|/* Compute preview using the offset tables */
comment|/* ======================================= */
if|if
condition|(
name|mapvals
operator|.
name|transparent_background
operator|==
name|TRUE
condition|)
name|gck_rgba_set
argument_list|(
operator|&
name|background
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
else|else
block|{
name|gimp_palette_get_background
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|background
operator|.
name|r
operator|=
operator|(
name|gdouble
operator|)
name|r
operator|/
literal|255.0
expr_stmt|;
name|background
operator|.
name|g
operator|=
operator|(
name|gdouble
operator|)
name|g
operator|/
literal|255.0
expr_stmt|;
name|background
operator|.
name|b
operator|=
operator|(
name|gdouble
operator|)
name|b
operator|/
literal|255.0
expr_stmt|;
name|background
operator|.
name|a
operator|=
literal|1.0
expr_stmt|;
block|}
name|gck_rgb_set
argument_list|(
operator|&
name|lightcheck
argument_list|,
literal|0.75
argument_list|,
literal|0.75
argument_list|,
literal|0.75
argument_list|)
expr_stmt|;
name|gck_rgb_set
argument_list|(
operator|&
name|darkcheck
argument_list|,
literal|0.50
argument_list|,
literal|0.50
argument_list|,
literal|0.50
argument_list|)
expr_stmt|;
name|gck_vector3_set
argument_list|(
operator|&
name|p2
argument_list|,
operator|-
literal|1.0
argument_list|,
operator|-
literal|1.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
for|for
control|(
name|ycnt
operator|=
literal|0
init|;
name|ycnt
operator|<
name|ph
condition|;
name|ycnt
operator|++
control|)
block|{
for|for
control|(
name|xcnt
operator|=
literal|0
init|;
name|xcnt
operator|<
name|pw
condition|;
name|xcnt
operator|++
control|)
block|{
name|p1
operator|.
name|x
operator|=
name|xpostab
index|[
name|xcnt
index|]
expr_stmt|;
name|p1
operator|.
name|y
operator|=
name|ypostab
index|[
name|ycnt
index|]
expr_stmt|;
name|p2
operator|=
name|p1
expr_stmt|;
name|color
operator|=
call|(
modifier|*
name|get_ray_color
call|)
argument_list|(
operator|&
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|color
operator|.
name|a
operator|<
literal|1.0
condition|)
block|{
name|f1
operator|=
operator|(
operator|(
name|xcnt
operator|%
literal|32
operator|)
operator|<
literal|16
operator|)
expr_stmt|;
name|f2
operator|=
operator|(
operator|(
name|ycnt
operator|%
literal|32
operator|)
operator|<
literal|16
operator|)
expr_stmt|;
name|f1
operator|=
name|f1
operator|^
name|f2
expr_stmt|;
if|if
condition|(
name|f1
condition|)
block|{
if|if
condition|(
name|color
operator|.
name|a
operator|==
literal|0.0
condition|)
name|color
operator|=
name|lightcheck
expr_stmt|;
else|else
block|{
name|gck_rgb_mul
argument_list|(
operator|&
name|color
argument_list|,
name|color
operator|.
name|a
argument_list|)
expr_stmt|;
name|temp
operator|=
name|lightcheck
expr_stmt|;
name|gck_rgb_mul
argument_list|(
operator|&
name|temp
argument_list|,
literal|1.0
operator|-
name|color
operator|.
name|a
argument_list|)
expr_stmt|;
name|gck_rgb_add
argument_list|(
operator|&
name|color
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|color
operator|.
name|a
operator|==
literal|0.0
condition|)
name|color
operator|=
name|darkcheck
expr_stmt|;
else|else
block|{
name|gck_rgb_mul
argument_list|(
operator|&
name|color
argument_list|,
name|color
operator|.
name|a
argument_list|)
expr_stmt|;
name|temp
operator|=
name|darkcheck
expr_stmt|;
name|gck_rgb_mul
argument_list|(
operator|&
name|temp
argument_list|,
literal|1.0
operator|-
name|color
operator|.
name|a
argument_list|)
expr_stmt|;
name|gck_rgb_add
argument_list|(
operator|&
name|color
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|preview_rgb_data
index|[
name|index
operator|++
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|color
operator|.
name|r
operator|*
literal|255.0
argument_list|)
expr_stmt|;
name|preview_rgb_data
index|[
name|index
operator|++
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|color
operator|.
name|g
operator|*
literal|255.0
argument_list|)
expr_stmt|;
name|preview_rgb_data
index|[
name|index
operator|++
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|color
operator|.
name|b
operator|*
literal|255.0
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Convert to visual type */
comment|/* ====================== */
name|gck_rgb_to_gdkimage
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|preview_rgb_data
argument_list|,
name|image
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Check if the given position is within the     */
end_comment

begin_comment
comment|/* light marker. Return TRUE if so, FALSE if not */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
DECL|function|check_light_hit (gint xpos,gint ypos)
name|gint
name|check_light_hit
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|gdouble
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|r
decl_stmt|;
if|if
condition|(
name|mapvals
operator|.
name|lightsource
operator|.
name|type
operator|==
name|POINT_LIGHT
condition|)
block|{
name|dx
operator|=
operator|(
name|gdouble
operator|)
name|lightx
operator|-
name|xpos
expr_stmt|;
name|dy
operator|=
operator|(
name|gdouble
operator|)
name|lighty
operator|-
name|ypos
expr_stmt|;
name|r
operator|=
name|sqrt
argument_list|(
name|dx
operator|*
name|dx
operator|+
name|dy
operator|*
name|dy
argument_list|)
operator|+
literal|0.5
expr_stmt|;
if|if
condition|(
operator|(
name|gint
operator|)
name|r
operator|>
literal|7
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
else|else
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/* Draw a marker to show light position */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
DECL|function|draw_light_marker (gint xpos,gint ypos)
name|void
name|draw_light_marker
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|gck_gc_set_foreground
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|gc
argument_list|,
literal|0
argument_list|,
literal|50
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|gck_gc_set_background
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gdk_gc_set_function
argument_list|(
name|gc
argument_list|,
name|GDK_COPY
argument_list|)
expr_stmt|;
if|if
condition|(
name|mapvals
operator|.
name|lightsource
operator|.
name|type
operator|==
name|POINT_LIGHT
condition|)
block|{
name|lightx
operator|=
name|xpos
expr_stmt|;
name|lighty
operator|=
name|ypos
expr_stmt|;
comment|/* Save background */
comment|/* =============== */
name|backbuf
operator|.
name|x
operator|=
name|lightx
operator|-
literal|7
expr_stmt|;
name|backbuf
operator|.
name|y
operator|=
name|lighty
operator|-
literal|7
expr_stmt|;
name|backbuf
operator|.
name|w
operator|=
literal|14
expr_stmt|;
name|backbuf
operator|.
name|h
operator|=
literal|14
expr_stmt|;
comment|/* X doesn't like images that's outside a window, make sure */
comment|/* we get the backbuffer image from within the boundaries   */
comment|/* ======================================================== */
if|if
condition|(
name|backbuf
operator|.
name|x
operator|<
literal|0
condition|)
name|backbuf
operator|.
name|x
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|backbuf
operator|.
name|x
operator|+
name|backbuf
operator|.
name|w
operator|)
operator|>
name|PREVIEW_WIDTH
condition|)
name|backbuf
operator|.
name|w
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|backbuf
operator|.
name|x
operator|)
expr_stmt|;
if|if
condition|(
name|backbuf
operator|.
name|y
operator|<
literal|0
condition|)
name|backbuf
operator|.
name|y
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|backbuf
operator|.
name|y
operator|+
name|backbuf
operator|.
name|h
operator|)
operator|>
name|PREVIEW_HEIGHT
condition|)
name|backbuf
operator|.
name|h
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|backbuf
operator|.
name|y
operator|)
expr_stmt|;
name|backbuf
operator|.
name|image
operator|=
name|gdk_image_get
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|backbuf
operator|.
name|x
argument_list|,
name|backbuf
operator|.
name|y
argument_list|,
name|backbuf
operator|.
name|w
argument_list|,
name|backbuf
operator|.
name|h
argument_list|)
expr_stmt|;
name|gdk_draw_arc
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|gc
argument_list|,
name|TRUE
argument_list|,
name|lightx
operator|-
literal|7
argument_list|,
name|lighty
operator|-
literal|7
argument_list|,
literal|14
argument_list|,
literal|14
argument_list|,
literal|0
argument_list|,
literal|360
operator|*
literal|64
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|clear_light_marker ()
name|void
name|clear_light_marker
parameter_list|()
block|{
comment|/* Restore background if it has been saved */
comment|/* ======================================= */
if|if
condition|(
name|backbuf
operator|.
name|image
operator|!=
name|NULL
condition|)
block|{
name|gck_gc_set_foreground
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|gc
argument_list|,
literal|255
argument_list|,
literal|255
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|gck_gc_set_background
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gdk_gc_set_function
argument_list|(
name|gc
argument_list|,
name|GDK_COPY
argument_list|)
expr_stmt|;
name|gdk_draw_image
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|gc
argument_list|,
name|backbuf
operator|.
name|image
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|backbuf
operator|.
name|x
argument_list|,
name|backbuf
operator|.
name|y
argument_list|,
name|backbuf
operator|.
name|w
argument_list|,
name|backbuf
operator|.
name|h
argument_list|)
expr_stmt|;
name|gdk_image_destroy
argument_list|(
name|backbuf
operator|.
name|image
argument_list|)
expr_stmt|;
name|backbuf
operator|.
name|image
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|draw_lights (gint startx,gint starty,gint pw,gint ph)
name|void
name|draw_lights
parameter_list|(
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|gdouble
name|dxpos
decl_stmt|,
name|dypos
decl_stmt|;
name|gint
name|xpos
decl_stmt|,
name|ypos
decl_stmt|;
name|clear_light_marker
argument_list|()
expr_stmt|;
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|dxpos
argument_list|,
operator|&
name|dypos
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|mapvals
operator|.
name|lightsource
operator|.
name|position
argument_list|)
expr_stmt|;
name|xpos
operator|=
call|(
name|gint
call|)
argument_list|(
name|dxpos
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|ypos
operator|=
call|(
name|gint
call|)
argument_list|(
name|dypos
operator|+
literal|0.5
argument_list|)
expr_stmt|;
if|if
condition|(
name|xpos
operator|>=
literal|0
operator|&&
name|xpos
operator|<=
name|PREVIEW_WIDTH
operator|&&
name|ypos
operator|>=
literal|0
operator|&&
name|ypos
operator|<=
name|PREVIEW_HEIGHT
condition|)
name|draw_light_marker
argument_list|(
name|xpos
argument_list|,
name|ypos
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/* Update light position given new screen coords */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
DECL|function|update_light (gint xpos,gint ypos)
name|void
name|update_light
parameter_list|(
name|gint
name|xpos
parameter_list|,
name|gint
name|ypos
parameter_list|)
block|{
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|>>
name|mapvals
operator|.
name|preview_zoom_factor
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|>>
name|mapvals
operator|.
name|preview_zoom_factor
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|>>
literal|1
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|>>
literal|1
expr_stmt|;
name|gck_2d_to_3d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
name|xpos
argument_list|,
name|ypos
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|mapvals
operator|.
name|lightsource
operator|.
name|position
argument_list|)
expr_stmt|;
name|draw_lights
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************/
end_comment

begin_comment
comment|/* Draw preview image. if DoCompute is TRUE then recompute image. */
end_comment

begin_comment
comment|/******************************************************************/
end_comment

begin_function
DECL|function|draw_preview_image (gint docompute)
name|void
name|draw_preview_image
parameter_list|(
name|gint
name|docompute
parameter_list|)
block|{
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|gck_gc_set_foreground
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|gc
argument_list|,
literal|255
argument_list|,
literal|255
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|gck_gc_set_background
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gdk_gc_set_function
argument_list|(
name|gc
argument_list|,
name|GDK_COPY
argument_list|)
expr_stmt|;
name|linetab
index|[
literal|0
index|]
operator|.
name|x1
operator|=
operator|-
literal|1
expr_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|>>
name|mapvals
operator|.
name|preview_zoom_factor
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|>>
name|mapvals
operator|.
name|preview_zoom_factor
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|>>
literal|1
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|docompute
operator|==
name|TRUE
condition|)
block|{
name|gck_cursor_set
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|GDK_WATCH
argument_list|)
expr_stmt|;
name|compute_preview
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|width
operator|-
literal|1
argument_list|,
name|height
operator|-
literal|1
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|gck_cursor_set
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|GDK_HAND2
argument_list|)
expr_stmt|;
name|clear_light_marker
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|pw
operator|!=
name|PREVIEW_WIDTH
condition|)
name|gdk_window_clear
argument_list|(
name|previewarea
operator|->
name|window
argument_list|)
expr_stmt|;
name|gdk_draw_image
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|gc
argument_list|,
name|image
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
name|draw_lights
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************/
end_comment

begin_comment
comment|/* Draw preview wireframe */
end_comment

begin_comment
comment|/**************************/
end_comment

begin_function
DECL|function|draw_preview_wireframe (void)
name|void
name|draw_preview_wireframe
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|pw
decl_stmt|,
name|ph
decl_stmt|;
name|gck_gc_set_foreground
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|gc
argument_list|,
literal|255
argument_list|,
literal|255
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|gck_gc_set_background
argument_list|(
name|appwin
operator|->
name|visinfo
argument_list|,
name|gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gdk_gc_set_function
argument_list|(
name|gc
argument_list|,
name|GDK_INVERT
argument_list|)
expr_stmt|;
name|pw
operator|=
name|PREVIEW_WIDTH
operator|>>
name|mapvals
operator|.
name|preview_zoom_factor
expr_stmt|;
name|ph
operator|=
name|PREVIEW_HEIGHT
operator|>>
name|mapvals
operator|.
name|preview_zoom_factor
expr_stmt|;
name|startx
operator|=
operator|(
name|PREVIEW_WIDTH
operator|-
name|pw
operator|)
operator|>>
literal|1
expr_stmt|;
name|starty
operator|=
operator|(
name|PREVIEW_HEIGHT
operator|-
name|ph
operator|)
operator|>>
literal|1
expr_stmt|;
name|clear_wireframe
argument_list|()
expr_stmt|;
name|draw_wireframe
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************/
end_comment

begin_comment
comment|/* Draw a wireframe preview */
end_comment

begin_comment
comment|/****************************/
end_comment

begin_function
DECL|function|draw_wireframe (gint startx,gint starty,gint pw,gint ph)
name|void
name|draw_wireframe
parameter_list|(
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
switch|switch
condition|(
name|mapvals
operator|.
name|maptype
condition|)
block|{
case|case
name|MAP_PLANE
case|:
name|draw_wireframe_plane
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
break|break;
case|case
name|MAP_SPHERE
case|:
name|draw_wireframe_sphere
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
DECL|function|draw_wireframe_plane (gint startx,gint starty,gint pw,gint ph)
name|void
name|draw_wireframe_plane
parameter_list|(
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|GckVector3
name|v1
decl_stmt|,
name|v2
decl_stmt|,
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|dir1
decl_stmt|,
name|dir2
decl_stmt|;
name|gint
name|cnt
decl_stmt|,
name|n
init|=
literal|0
decl_stmt|;
name|gdouble
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|cx1
decl_stmt|,
name|cy1
decl_stmt|,
name|cx2
decl_stmt|,
name|cy2
decl_stmt|,
name|fac
decl_stmt|;
comment|/* Find rotated box corners */
comment|/* ======================== */
name|gck_vector3_set
argument_list|(
operator|&
name|v1
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gck_vector3_set
argument_list|(
operator|&
name|v2
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gck_vector3_rotate
argument_list|(
operator|&
name|v1
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|gck_vector3_rotate
argument_list|(
operator|&
name|v2
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|dir1
operator|=
name|v1
expr_stmt|;
name|gck_vector3_normalize
argument_list|(
operator|&
name|dir1
argument_list|)
expr_stmt|;
name|dir2
operator|=
name|v2
expr_stmt|;
name|gck_vector3_normalize
argument_list|(
operator|&
name|dir2
argument_list|)
expr_stmt|;
name|fac
operator|=
literal|1.0
operator|/
operator|(
name|gdouble
operator|)
name|WIRESIZE
expr_stmt|;
name|gck_vector3_mul
argument_list|(
operator|&
name|dir1
argument_list|,
name|fac
argument_list|)
expr_stmt|;
name|gck_vector3_mul
argument_list|(
operator|&
name|dir2
argument_list|,
name|fac
argument_list|)
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|,
operator|&
name|v1
argument_list|)
expr_stmt|;
name|gck_vector3_sub
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|v2
argument_list|)
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|v2
argument_list|)
expr_stmt|;
name|gck_vector3_sub
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|,
operator|&
name|v1
argument_list|)
expr_stmt|;
name|gck_vector3_sub
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|v2
argument_list|)
expr_stmt|;
name|c
operator|=
name|b
expr_stmt|;
name|cx1
operator|=
operator|(
name|gdouble
operator|)
name|startx
expr_stmt|;
name|cy1
operator|=
operator|(
name|gdouble
operator|)
name|starty
expr_stmt|;
name|cx2
operator|=
name|cx1
operator|+
operator|(
name|gdouble
operator|)
name|pw
expr_stmt|;
name|cy2
operator|=
name|cy1
operator|+
operator|(
name|gdouble
operator|)
name|ph
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<=
name|WIRESIZE
condition|;
name|cnt
operator|++
control|)
block|{
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|gck_clip_line
argument_list|(
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|linetab
index|[
name|n
index|]
operator|.
name|x1
operator|=
call|(
name|gint
call|)
argument_list|(
name|x1
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|y1
operator|=
call|(
name|gint
call|)
argument_list|(
name|y1
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|x2
operator|=
call|(
name|gint
call|)
argument_list|(
name|x2
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|y2
operator|=
call|(
name|gint
call|)
argument_list|(
name|y2
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
operator|=
literal|1
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
operator|=
name|GDK_LINE_SOLID
expr_stmt|;
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
argument_list|,
name|GDK_CAP_NOT_LAST
argument_list|,
name|GDK_JOIN_MITER
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x2
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y2
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|gck_clip_line
argument_list|(
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|linetab
index|[
name|n
index|]
operator|.
name|x1
operator|=
call|(
name|gint
call|)
argument_list|(
name|x1
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|y1
operator|=
call|(
name|gint
call|)
argument_list|(
name|y1
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|x2
operator|=
call|(
name|gint
call|)
argument_list|(
name|x2
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|y2
operator|=
call|(
name|gint
call|)
argument_list|(
name|y2
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
operator|=
literal|1
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
operator|=
name|GDK_LINE_SOLID
expr_stmt|;
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
argument_list|,
name|GDK_CAP_NOT_LAST
argument_list|,
name|GDK_JOIN_MITER
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x2
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y2
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
name|gck_vector3_sub
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|dir1
argument_list|)
expr_stmt|;
name|gck_vector3_sub
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|dir1
argument_list|)
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|dir2
argument_list|)
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|dir2
argument_list|)
expr_stmt|;
block|}
comment|/* Mark end of lines */
comment|/* ================= */
name|linetab
index|[
name|n
index|]
operator|.
name|x1
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
DECL|function|draw_wireframe_sphere (gint startx,gint starty,gint pw,gint ph)
name|void
name|draw_wireframe_sphere
parameter_list|(
name|gint
name|startx
parameter_list|,
name|gint
name|starty
parameter_list|,
name|gint
name|pw
parameter_list|,
name|gint
name|ph
parameter_list|)
block|{
name|GckVector3
name|p
index|[
literal|2
operator|*
operator|(
name|WIRESIZE
operator|+
literal|5
operator|)
index|]
decl_stmt|;
name|gint
name|cnt
decl_stmt|,
name|cnt2
decl_stmt|,
name|n
init|=
literal|0
decl_stmt|;
name|gdouble
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|twopifac
decl_stmt|,
name|cx1
decl_stmt|,
name|cy1
decl_stmt|,
name|cx2
decl_stmt|,
name|cy2
decl_stmt|;
comment|/* Compute wireframe points */
comment|/* ======================== */
name|twopifac
operator|=
operator|(
literal|2.0
operator|*
name|M_PI
operator|)
operator|/
name|WIRESIZE
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
name|WIRESIZE
condition|;
name|cnt
operator|++
control|)
block|{
name|p
index|[
name|cnt
index|]
operator|.
name|x
operator|=
name|mapvals
operator|.
name|radius
operator|*
name|cos
argument_list|(
operator|(
name|gdouble
operator|)
name|cnt
operator|*
name|twopifac
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
index|]
operator|.
name|y
operator|=
literal|0.0
expr_stmt|;
name|p
index|[
name|cnt
index|]
operator|.
name|z
operator|=
name|mapvals
operator|.
name|radius
operator|*
name|sin
argument_list|(
operator|(
name|gdouble
operator|)
name|cnt
operator|*
name|twopifac
argument_list|)
expr_stmt|;
name|gck_vector3_rotate
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
block|}
name|p
index|[
name|cnt
index|]
operator|=
name|p
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|cnt
operator|=
name|WIRESIZE
operator|+
literal|1
init|;
name|cnt
operator|<
literal|2
operator|*
name|WIRESIZE
operator|+
literal|1
condition|;
name|cnt
operator|++
control|)
block|{
name|p
index|[
name|cnt
index|]
operator|.
name|x
operator|=
name|mapvals
operator|.
name|radius
operator|*
name|cos
argument_list|(
call|(
name|gdouble
call|)
argument_list|(
name|cnt
operator|-
operator|(
name|WIRESIZE
operator|+
literal|1
operator|)
argument_list|)
operator|*
name|twopifac
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
index|]
operator|.
name|y
operator|=
name|mapvals
operator|.
name|radius
operator|*
name|sin
argument_list|(
call|(
name|gdouble
call|)
argument_list|(
name|cnt
operator|-
operator|(
name|WIRESIZE
operator|+
literal|1
operator|)
argument_list|)
operator|*
name|twopifac
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
index|]
operator|.
name|z
operator|=
literal|0.0
expr_stmt|;
name|gck_vector3_rotate
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
block|}
name|p
index|[
name|cnt
index|]
operator|=
name|p
index|[
name|WIRESIZE
operator|+
literal|1
index|]
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
name|cnt2
operator|=
name|cnt
expr_stmt|;
comment|/* Find rotated axis */
comment|/* ================= */
name|gck_vector3_set
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
literal|0.0
argument_list|,
operator|-
literal|0.35
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gck_vector3_rotate
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
operator|+
literal|1
index|]
operator|=
name|mapvals
operator|.
name|position
expr_stmt|;
name|gck_vector3_set
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|2
index|]
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|-
literal|0.35
argument_list|)
expr_stmt|;
name|gck_vector3_rotate
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|2
index|]
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|alpha
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|beta
argument_list|)
argument_list|,
name|gck_deg_to_rad
argument_list|(
name|mapvals
operator|.
name|gamma
argument_list|)
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
operator|+
literal|3
index|]
operator|=
name|mapvals
operator|.
name|position
expr_stmt|;
name|p
index|[
name|cnt
operator|+
literal|4
index|]
operator|=
name|p
index|[
name|cnt
index|]
expr_stmt|;
name|gck_vector3_mul
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|4
index|]
argument_list|,
operator|-
literal|1.0
argument_list|)
expr_stmt|;
name|p
index|[
name|cnt
operator|+
literal|5
index|]
operator|=
name|p
index|[
name|cnt
operator|+
literal|1
index|]
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|2
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
operator|+
literal|2
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
name|gck_vector3_add
argument_list|(
operator|&
name|p
index|[
name|cnt
operator|+
literal|4
index|]
argument_list|,
operator|&
name|p
index|[
name|cnt
operator|+
literal|4
index|]
argument_list|,
operator|&
name|mapvals
operator|.
name|position
argument_list|)
expr_stmt|;
comment|/* Draw the circles (equator and zero meridian) */
comment|/* ============================================ */
name|cx1
operator|=
operator|(
name|gdouble
operator|)
name|startx
expr_stmt|;
name|cy1
operator|=
operator|(
name|gdouble
operator|)
name|starty
expr_stmt|;
name|cx2
operator|=
name|cx1
operator|+
operator|(
name|gdouble
operator|)
name|pw
expr_stmt|;
name|cy2
operator|=
name|cy1
operator|+
operator|(
name|gdouble
operator|)
name|ph
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
name|cnt2
operator|-
literal|1
condition|;
name|cnt
operator|++
control|)
block|{
if|if
condition|(
name|p
index|[
name|cnt
index|]
operator|.
name|z
operator|>
name|mapvals
operator|.
name|position
operator|.
name|z
operator|&&
name|p
index|[
name|cnt
operator|+
literal|1
index|]
operator|.
name|z
operator|>
name|mapvals
operator|.
name|position
operator|.
name|z
condition|)
block|{
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|p
index|[
name|cnt
index|]
argument_list|)
expr_stmt|;
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|p
index|[
name|cnt
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|gck_clip_line
argument_list|(
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|linetab
index|[
name|n
index|]
operator|.
name|x1
operator|=
call|(
name|gint
call|)
argument_list|(
name|x1
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|y1
operator|=
call|(
name|gint
call|)
argument_list|(
name|y1
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|x2
operator|=
call|(
name|gint
call|)
argument_list|(
name|x2
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|y2
operator|=
call|(
name|gint
call|)
argument_list|(
name|y2
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
operator|=
literal|3
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
operator|=
name|GDK_LINE_SOLID
expr_stmt|;
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
argument_list|,
name|GDK_CAP_NOT_LAST
argument_list|,
name|GDK_JOIN_MITER
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x2
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y2
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
block|}
block|}
comment|/* Draw the axis (pole to pole and center to zero meridian) */
comment|/* ======================================================== */
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|3
condition|;
name|cnt
operator|++
control|)
block|{
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|p
index|[
name|cnt2
index|]
argument_list|)
expr_stmt|;
name|gck_3d_to_2d
argument_list|(
name|startx
argument_list|,
name|starty
argument_list|,
name|pw
argument_list|,
name|ph
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
operator|&
name|mapvals
operator|.
name|viewpoint
argument_list|,
operator|&
name|p
index|[
name|cnt2
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|gck_clip_line
argument_list|(
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|,
name|cx1
argument_list|,
name|cy1
argument_list|,
name|cx2
argument_list|,
name|cy2
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|linetab
index|[
name|n
index|]
operator|.
name|x1
operator|=
call|(
name|gint
call|)
argument_list|(
name|x1
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|y1
operator|=
call|(
name|gint
call|)
argument_list|(
name|y1
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|x2
operator|=
call|(
name|gint
call|)
argument_list|(
name|x2
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|y2
operator|=
call|(
name|gint
call|)
argument_list|(
name|y2
operator|+
literal|0.5
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
name|cnt2
index|]
operator|.
name|z
operator|<
name|mapvals
operator|.
name|position
operator|.
name|z
operator|||
name|p
index|[
name|cnt2
operator|+
literal|1
index|]
operator|.
name|z
operator|<
name|mapvals
operator|.
name|position
operator|.
name|z
condition|)
block|{
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
operator|=
literal|1
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
operator|=
name|GDK_LINE_DOUBLE_DASH
expr_stmt|;
block|}
else|else
block|{
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
operator|=
literal|3
expr_stmt|;
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
operator|=
name|GDK_LINE_SOLID
expr_stmt|;
block|}
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
argument_list|,
name|GDK_CAP_NOT_LAST
argument_list|,
name|GDK_JOIN_MITER
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x2
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y2
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
name|cnt2
operator|+=
literal|2
expr_stmt|;
block|}
comment|/* Mark end of lines */
comment|/* ================= */
name|linetab
index|[
name|n
index|]
operator|.
name|x1
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
DECL|function|clear_wireframe (void)
name|void
name|clear_wireframe
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|n
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|linetab
index|[
name|n
index|]
operator|.
name|x1
operator|!=
operator|-
literal|1
condition|)
block|{
name|gdk_gc_set_line_attributes
argument_list|(
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linewidth
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|linestyle
argument_list|,
name|GDK_CAP_NOT_LAST
argument_list|,
name|GDK_JOIN_MITER
argument_list|)
expr_stmt|;
name|gdk_draw_line
argument_list|(
name|previewarea
operator|->
name|window
argument_list|,
name|gc
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y1
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|x2
argument_list|,
name|linetab
index|[
name|n
index|]
operator|.
name|y2
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
block|}
end_function

end_unit

