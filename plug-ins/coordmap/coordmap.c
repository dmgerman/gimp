begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Coordinate Map plug-in for The Gimp  * Copyright (C) 1997 Michael Schubart (schubart@best.com)  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 2 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_comment
comment|/*  * This plug-in for The Gimp uses the algorithm described below to map  * a source image to a destination image. Two grayscale images X and Y  * are used to describe the mapping.   *  * For each position in the destination image, get the luminosity of the  * pixels at the same position in the X and Y images. Interpret this pair  * of values as a coordinate pair. Copy the pixel at these coordinates in  * the source image to the destination image.   *  * The latest version and some examples can be found at  * http://www.best.com/~schubart/cm/  *  * This is my first plug-in for The Gimp. You are very welcome to send  * me any comments you have.  */
end_comment

begin_comment
comment|/*  * Version 0.2 -- Sep 1 1997  *  * Cosmetic changes to the source code.  */
end_comment

begin_comment
comment|/*  * Version 0.1 -- Aug 28 1997  *  * The first version.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"gtk/gtk.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimp.h"
end_include

begin_include
include|#
directive|include
file|"libgimp/gimpui.h"
end_include

begin_comment
comment|/*  * definitions  */
end_comment

begin_undef
undef|#
directive|undef
name|GARRULOUS
end_undef

begin_comment
comment|/* lots of messages to stdout? */
end_comment

begin_define
DECL|macro|MODE_COPY
define|#
directive|define
name|MODE_COPY
value|0
end_define

begin_define
DECL|macro|MODE_GRAY_TO_COLOR
define|#
directive|define
name|MODE_GRAY_TO_COLOR
value|1
end_define

begin_define
DECL|macro|MODE_COLOR_TO_GRAY
define|#
directive|define
name|MODE_COLOR_TO_GRAY
value|2
end_define

begin_define
DECL|macro|ALPHA_NONE
define|#
directive|define
name|ALPHA_NONE
value|0
end_define

begin_define
DECL|macro|ALPHA_COPY
define|#
directive|define
name|ALPHA_COPY
value|1
end_define

begin_define
DECL|macro|ALPHA_CLEAR
define|#
directive|define
name|ALPHA_CLEAR
value|2
end_define

begin_define
DECL|macro|LUMINOSITY (X)
define|#
directive|define
name|LUMINOSITY
parameter_list|(
name|X
parameter_list|)
value|((X[0]*30 + X[1]*59 + X[2]*11)/100)
end_define

begin_define
DECL|macro|SRC_WIDTH
define|#
directive|define
name|SRC_WIDTH
value|256
end_define

begin_define
DECL|macro|SRC_HEIGHT
define|#
directive|define
name|SRC_HEIGHT
value|256
end_define

begin_comment
comment|/*  * declare types  */
end_comment

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2c4f8a520108
block|{
DECL|member|src_drawable_id
name|gint32
name|src_drawable_id
decl_stmt|;
comment|/* the source drawable */
DECL|member|x_drawable_id
name|gint32
name|x_drawable_id
decl_stmt|;
comment|/* the x drawable */
DECL|member|y_drawable_id
name|gint32
name|y_drawable_id
decl_stmt|;
comment|/* the y drawable */
DECL|typedef|coordmap_values_t
block|}
name|coordmap_values_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2c4f8a520208
block|{
DECL|member|run
name|gint
name|run
decl_stmt|;
comment|/* did the user press "ok"? */
DECL|typedef|coordmap_interface_t
block|}
name|coordmap_interface_t
typedef|;
end_typedef

begin_comment
comment|/*  * declare local functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|coordmap
parameter_list|(
name|gint32
name|dst_drawable_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|coordmap_dialog
parameter_list|(
name|gint32
name|dst_drawable_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|coordmap_src_drawable_constraint
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|coordmap_xy_drawable_constraint
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|message_box
parameter_list|(
name|char
modifier|*
name|message
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|coordmap_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|coordmap_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|dialog
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|coordmap_src_drawable_callback
parameter_list|(
name|gint32
name|id
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|coordmap_x_drawable_callback
parameter_list|(
name|gint32
name|id
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|coordmap_y_drawable_callback
parameter_list|(
name|gint32
name|id
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * local variables  */
end_comment

begin_decl_stmt
DECL|variable|cvals
specifier|static
name|coordmap_values_t
name|cvals
init|=
block|{
operator|-
literal|1
block|,
comment|/* src_drawable_id */
operator|-
literal|1
block|,
comment|/* x_drawable_id */
operator|-
literal|1
block|,
comment|/* y_drawable_id */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|cint
specifier|static
name|coordmap_interface_t
name|cint
init|=
block|{
name|FALSE
comment|/* run */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
name|GPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc */
name|NULL
block|,
comment|/* quit_proc */
name|query
block|,
comment|/* query_proc */
name|run
block|,
comment|/* run_proc */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * functions  */
end_comment

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
specifier|static
name|void
name|query
parameter_list|()
block|{
specifier|static
name|GParamDef
name|args
index|[]
init|=
block|{
block|{
name|PARAM_INT32
block|,
literal|"run_mode"
block|,
literal|"Interactive, non-interactive"
block|}
block|,
block|{
name|PARAM_IMAGE
block|,
literal|"image"
block|,
literal|"Input image"
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"dst_drawable"
block|,
literal|"Destination drawable"
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"src_drawable"
block|,
literal|"Source drawable, size must be 256x256"
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"x_drawable"
block|,
literal|"X drawable, size must be equal to dst_drawable."
block|}
block|,
block|{
name|PARAM_DRAWABLE
block|,
literal|"y_drawable"
block|,
literal|"Y drawable, size must be equal to dst_drawable."
block|}
block|,   }
decl_stmt|;
specifier|static
name|GParamDef
modifier|*
name|return_vals
init|=
name|NULL
decl_stmt|;
specifier|static
name|int
name|nargs
init|=
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
specifier|static
name|int
name|nreturn_vals
init|=
literal|0
decl_stmt|;
name|gimp_install_procedure
argument_list|(
literal|"plug_in_coordmap"
argument_list|,
literal|"Maps a source image to a destination image."
argument_list|,
literal|"Maps a source image to a destination image. For each position in "
literal|"the destination image, the luminosity of of the X map and the Y "
literal|"map at the same position are interpreted as coordinates. The pixel "
literal|"that is found at these coordinates in the source image is copied "
literal|"to the destination image."
argument_list|,
literal|"Michael Schubart"
argument_list|,
literal|"Michael Schubart"
argument_list|,
literal|"Sep 1 1997"
argument_list|,
literal|"<Image>/Filters/Map/Coordinate Map"
argument_list|,
literal|"RGB*, GRAY*"
argument_list|,
name|PROC_PLUG_IN
argument_list|,
name|nargs
argument_list|,
name|nreturn_vals
argument_list|,
name|args
argument_list|,
name|return_vals
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|run (char * name,int nparams,GParam * param,int * nreturn_vals,GParam ** return_vals)
specifier|static
name|void
name|run
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|nparams
parameter_list|,
name|GParam
modifier|*
name|param
parameter_list|,
name|int
modifier|*
name|nreturn_vals
parameter_list|,
name|GParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GParam
name|values
index|[
literal|1
index|]
decl_stmt|;
name|GRunModeType
name|run_mode
init|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|PARAM_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_SUCCESS
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|RUN_INTERACTIVE
case|:
comment|/* get the parameter values of the last incocation */
name|gimp_get_data
argument_list|(
literal|"plug_in_coordmap"
argument_list|,
operator|&
name|cvals
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|coordmap_dialog
argument_list|(
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
argument_list|)
condition|)
return|return;
break|break;
case|case
name|RUN_NONINTERACTIVE
case|:
comment|/* check number of parameters */
if|if
condition|(
name|nparams
operator|!=
literal|6
condition|)
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_CALLING_ERROR
expr_stmt|;
else|else
block|{
name|cvals
operator|.
name|src_drawable_id
operator|=
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_drawable
expr_stmt|;
name|cvals
operator|.
name|x_drawable_id
operator|=
name|param
index|[
literal|4
index|]
operator|.
name|data
operator|.
name|d_drawable
expr_stmt|;
name|cvals
operator|.
name|y_drawable_id
operator|=
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_drawable
expr_stmt|;
block|}
break|break;
case|case
name|RUN_WITH_LAST_VALS
case|:
comment|/* get the parameter values of the last incocation */
name|gimp_get_data
argument_list|(
literal|"plug_in_coordmap"
argument_list|,
operator|&
name|cvals
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|==
name|STATUS_SUCCESS
condition|)
block|{
comment|/*      * @@ Who can explain to me what this gimp_tile_cache_ntiles() is about,      * and what's a good value? Thanks!      */
name|gimp_tile_cache_ntiles
argument_list|(
literal|48
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|coordmap
argument_list|(
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
argument_list|)
condition|)
comment|/* bad parameter values */
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|STATUS_EXECUTION_ERROR
expr_stmt|;
else|else
block|{
if|if
condition|(
name|run_mode
operator|!=
name|RUN_NONINTERACTIVE
condition|)
name|gimp_displays_flush
argument_list|()
expr_stmt|;
if|if
condition|(
name|run_mode
operator|==
name|RUN_INTERACTIVE
condition|)
comment|/* store parameter values for next invocation */
name|gimp_set_data
argument_list|(
literal|"plug_in_coordmap"
argument_list|,
operator|&
name|cvals
argument_list|,
sizeof|sizeof
argument_list|(
name|coordmap_values_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
DECL|function|coordmap (gint32 dst_drawable_id)
specifier|static
name|gint
name|coordmap
parameter_list|(
name|gint32
name|dst_drawable_id
parameter_list|)
block|{
name|GDrawable
modifier|*
name|dst_drawable
decl_stmt|;
name|GDrawable
modifier|*
name|src_drawable
decl_stmt|;
name|GDrawable
modifier|*
name|x_drawable
decl_stmt|;
name|GDrawable
modifier|*
name|y_drawable
decl_stmt|;
name|gint
name|src_mode
init|=
name|MODE_COPY
decl_stmt|;
name|gint
name|x_mode
init|=
name|MODE_COPY
decl_stmt|;
name|gint
name|y_mode
init|=
name|MODE_COPY
decl_stmt|;
name|gint
name|src_bpp
decl_stmt|;
name|gint
name|dst_bpp
decl_stmt|;
name|gint
name|copy_bpp
decl_stmt|;
name|gint
name|src_alpha_index
decl_stmt|;
name|gint
name|dst_alpha_index
decl_stmt|;
name|gint
name|alpha_mode
init|=
name|ALPHA_NONE
decl_stmt|;
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
name|gint
name|progress
decl_stmt|,
name|max_progress
decl_stmt|;
name|GPixelRgn
name|dst_rgn
decl_stmt|;
name|GPixelRgn
name|src_rgn
decl_stmt|;
name|GPixelRgn
name|x_rgn
decl_stmt|;
name|GPixelRgn
name|y_rgn
decl_stmt|;
name|guchar
modifier|*
name|src
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
comment|/* initialize */
name|src_alpha_index
operator|=
literal|0
expr_stmt|;
name|dst_alpha_index
operator|=
literal|0
expr_stmt|;
comment|/*    * some tests to see whether we want to run at all    */
comment|/* crude way to test if the drawables still exist */
if|if
condition|(
name|gimp_drawable_bpp
argument_list|(
name|dst_drawable_id
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|gimp_drawable_bpp
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|gimp_drawable_bpp
argument_list|(
name|cvals
operator|.
name|x_drawable_id
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|gimp_drawable_bpp
argument_list|(
name|cvals
operator|.
name|y_drawable_id
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|GARRULOUS
name|g_print
argument_list|(
literal|"coordmap: drawable missing\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|FALSE
return|;
block|}
comment|/* reject indexed drawables */
if|if
condition|(
name|gimp_drawable_indexed
argument_list|(
name|dst_drawable_id
argument_list|)
operator|||
name|gimp_drawable_indexed
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
operator|||
name|gimp_drawable_indexed
argument_list|(
name|cvals
operator|.
name|x_drawable_id
argument_list|)
operator|||
name|gimp_drawable_indexed
argument_list|(
name|cvals
operator|.
name|y_drawable_id
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|GARRULOUS
name|g_print
argument_list|(
literal|"coordmap: won't work on indexed images\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|FALSE
return|;
block|}
comment|/* check source image size */
if|if
condition|(
name|gimp_drawable_width
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
operator|!=
name|SRC_WIDTH
operator|||
name|gimp_drawable_height
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
operator|!=
name|SRC_HEIGHT
condition|)
block|{
ifdef|#
directive|ifdef
name|GARRULOUS
name|g_print
argument_list|(
literal|"coordmap: source image size must be 256x256\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|FALSE
return|;
block|}
comment|/* check x and y map size */
if|if
condition|(
name|gimp_drawable_width
argument_list|(
name|cvals
operator|.
name|x_drawable_id
argument_list|)
operator|!=
name|gimp_drawable_width
argument_list|(
name|dst_drawable_id
argument_list|)
operator|||
name|gimp_drawable_height
argument_list|(
name|cvals
operator|.
name|x_drawable_id
argument_list|)
operator|!=
name|gimp_drawable_height
argument_list|(
name|dst_drawable_id
argument_list|)
operator|||
name|gimp_drawable_width
argument_list|(
name|cvals
operator|.
name|y_drawable_id
argument_list|)
operator|!=
name|gimp_drawable_width
argument_list|(
name|dst_drawable_id
argument_list|)
operator|||
name|gimp_drawable_height
argument_list|(
name|cvals
operator|.
name|y_drawable_id
argument_list|)
operator|!=
name|gimp_drawable_height
argument_list|(
name|dst_drawable_id
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|GARRULOUS
name|g_print
argument_list|(
literal|"coordmap: x and y map must be of the same size as "
literal|"the destination image\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|FALSE
return|;
block|}
comment|/*    * examine the drawables to see what kind of transformations we need    */
comment|/* convert gray source pixel to color destination pixel? */
if|if
condition|(
name|gimp_drawable_gray
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
operator|&&
name|gimp_drawable_color
argument_list|(
name|dst_drawable_id
argument_list|)
condition|)
name|src_mode
operator|=
name|MODE_GRAY_TO_COLOR
expr_stmt|;
comment|/* convert color source pixel to gray destination pixel? */
if|if
condition|(
name|gimp_drawable_color
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
operator|&&
name|gimp_drawable_gray
argument_list|(
name|dst_drawable_id
argument_list|)
condition|)
name|src_mode
operator|=
name|MODE_COLOR_TO_GRAY
expr_stmt|;
comment|/* is the x map gray, or do we have to computer its luminosity? */
if|if
condition|(
name|gimp_drawable_color
argument_list|(
name|cvals
operator|.
name|x_drawable_id
argument_list|)
condition|)
name|x_mode
operator|=
name|MODE_COLOR_TO_GRAY
expr_stmt|;
comment|/* is the y map gray, or do we have to computer its luminosity? */
if|if
condition|(
name|gimp_drawable_color
argument_list|(
name|cvals
operator|.
name|y_drawable_id
argument_list|)
condition|)
name|y_mode
operator|=
name|MODE_COLOR_TO_GRAY
expr_stmt|;
comment|/* how may bytes of color information in the destination image? */
name|dst_bpp
operator|=
name|gimp_drawable_bpp
argument_list|(
name|dst_drawable_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_drawable_has_alpha
argument_list|(
name|dst_drawable_id
argument_list|)
condition|)
block|{
name|dst_alpha_index
operator|=
operator|--
name|dst_bpp
expr_stmt|;
name|alpha_mode
operator|=
name|ALPHA_CLEAR
expr_stmt|;
block|}
comment|/* how may bytes of color information in the source image? */
name|src_bpp
operator|=
name|gimp_drawable_bpp
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_drawable_has_alpha
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
condition|)
name|src_alpha_index
operator|=
operator|--
name|src_bpp
expr_stmt|;
comment|/* how many bytes of of color information are we going to copy? */
name|copy_bpp
operator|=
name|MIN
argument_list|(
name|src_bpp
argument_list|,
name|dst_bpp
argument_list|)
expr_stmt|;
comment|/* copy alpha together with color if both drawables have alpha */
if|if
condition|(
name|gimp_drawable_has_alpha
argument_list|(
name|dst_drawable_id
argument_list|)
operator|&&
name|gimp_drawable_has_alpha
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
condition|)
block|{
if|if
condition|(
name|src_mode
operator|==
name|MODE_COPY
condition|)
name|copy_bpp
operator|++
expr_stmt|;
else|else
name|alpha_mode
operator|=
name|ALPHA_COPY
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|GARRULOUS
comment|/* some debug messages */
if|if
condition|(
name|src_mode
operator|==
name|MODE_COPY
condition|)
block|{
name|g_print
argument_list|(
literal|"src_mode: MODE_COPY\n"
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"copy_bpp: %d\n"
argument_list|,
name|copy_bpp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|src_mode
operator|==
name|MODE_GRAY_TO_COLOR
condition|)
name|g_print
argument_list|(
literal|"src_mode: MODE_GRAY_TO_COLOR\n"
argument_list|)
expr_stmt|;
else|else
name|g_print
argument_list|(
literal|"src_mode: MODE_COLOR_TO_GRAY\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|alpha_mode
operator|==
name|ALPHA_NONE
condition|)
name|g_print
argument_list|(
literal|"alpha_mode: ALPHA_NONE\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|alpha_mode
operator|==
name|ALPHA_COPY
condition|)
block|{
name|g_print
argument_list|(
literal|"alpha_mode: ALPHA_COPY\n"
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"src_alpha_index: %d\n"
argument_list|,
name|src_alpha_index
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"dst_alpha_index: %d\n"
argument_list|,
name|dst_alpha_index
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|alpha_mode
operator|==
name|ALPHA_CLEAR
condition|)
block|{
name|g_print
argument_list|(
literal|"alpha_mode: ALPHA_CLEAR\n"
argument_list|)
expr_stmt|;
name|g_print
argument_list|(
literal|"dst_alpha_index: %d\n"
argument_list|,
name|dst_alpha_index
argument_list|)
expr_stmt|;
block|}
name|g_print
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* get the drawables form the drawable ids */
name|dst_drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|dst_drawable_id
argument_list|)
expr_stmt|;
name|src_drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|cvals
operator|.
name|src_drawable_id
argument_list|)
expr_stmt|;
name|x_drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|cvals
operator|.
name|x_drawable_id
argument_list|)
expr_stmt|;
name|y_drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|cvals
operator|.
name|y_drawable_id
argument_list|)
expr_stmt|;
comment|/* copy the source drawable to one big array */
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|src_drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SRC_WIDTH
argument_list|,
name|SRC_HEIGHT
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|src
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|SRC_WIDTH
operator|*
name|SRC_HEIGHT
operator|*
name|src_drawable
operator|->
name|bpp
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_get_rect
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|src
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SRC_WIDTH
argument_list|,
name|SRC_HEIGHT
argument_list|)
expr_stmt|;
comment|/* get the area that is going to be processed */
name|gimp_drawable_mask_bounds
argument_list|(
name|dst_drawable
operator|->
name|id
argument_list|,
operator|&
name|x1
argument_list|,
operator|&
name|y1
argument_list|,
operator|&
name|x2
argument_list|,
operator|&
name|y2
argument_list|)
expr_stmt|;
name|progress
operator|=
literal|0
expr_stmt|;
name|max_progress
operator|=
operator|(
name|x2
operator|-
name|x1
operator|)
operator|*
operator|(
name|y2
operator|-
name|y1
operator|)
expr_stmt|;
name|gimp_progress_init
argument_list|(
literal|"Coordinate Map..."
argument_list|)
expr_stmt|;
comment|/* initialize the pixel regions */
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|dst_rgn
argument_list|,
name|dst_drawable
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
operator|-
name|x1
argument_list|,
name|y2
operator|-
name|y1
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|x_rgn
argument_list|,
name|x_drawable
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
operator|-
name|x1
argument_list|,
name|y2
operator|-
name|y1
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|y_rgn
argument_list|,
name|y_drawable
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|x2
operator|-
name|x1
argument_list|,
name|y2
operator|-
name|y1
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* iterate over the areas the Gimp chooses for us */
for|for
control|(
name|pr
operator|=
name|gimp_pixel_rgns_register
argument_list|(
literal|3
argument_list|,
operator|&
name|dst_rgn
argument_list|,
operator|&
name|x_rgn
argument_list|,
operator|&
name|y_rgn
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|gimp_pixel_rgns_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|guchar
modifier|*
name|dst_ptr
init|=
name|dst_rgn
operator|.
name|data
decl_stmt|;
name|guchar
modifier|*
name|x_ptr
init|=
name|x_rgn
operator|.
name|data
decl_stmt|;
name|guchar
modifier|*
name|y_ptr
init|=
name|y_rgn
operator|.
name|data
decl_stmt|;
name|guchar
modifier|*
name|src_ptr
decl_stmt|;
name|guchar
name|x_value
decl_stmt|;
name|guchar
name|y_value
decl_stmt|;
name|gint
name|byte
decl_stmt|;
comment|/* iterate over all pixels in the current area */
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|dst_rgn
operator|.
name|h
condition|;
name|y
operator|++
control|)
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|dst_rgn
operator|.
name|w
condition|;
name|x
operator|++
control|)
block|{
comment|/* get the source address */
name|x_value
operator|=
operator|(
name|x_mode
operator|==
name|MODE_COPY
operator|)
condition|?
name|x_ptr
index|[
literal|0
index|]
else|:
name|LUMINOSITY
argument_list|(
name|x_ptr
argument_list|)
expr_stmt|;
name|y_value
operator|=
operator|(
name|y_mode
operator|==
name|MODE_COPY
operator|)
condition|?
name|y_ptr
index|[
literal|0
index|]
else|:
name|LUMINOSITY
argument_list|(
name|y_ptr
argument_list|)
expr_stmt|;
name|src_ptr
operator|=
name|src
operator|+
operator|(
name|y_value
operator|*
name|SRC_WIDTH
operator|+
name|x_value
operator|)
operator|*
name|src_rgn
operator|.
name|bpp
expr_stmt|;
comment|/* simply copy the color information? */
if|if
condition|(
name|src_mode
operator|==
name|MODE_COPY
condition|)
for|for
control|(
name|byte
operator|=
literal|0
init|;
name|byte
operator|<
name|copy_bpp
condition|;
name|byte
operator|++
control|)
name|dst_ptr
index|[
name|byte
index|]
operator|=
name|src_ptr
index|[
name|byte
index|]
expr_stmt|;
comment|/* or copy a gray value to red, green and blue? */
elseif|else
if|if
condition|(
name|src_mode
operator|==
name|MODE_GRAY_TO_COLOR
condition|)
for|for
control|(
name|byte
operator|=
literal|0
init|;
name|byte
operator|<
name|dst_bpp
condition|;
name|byte
operator|++
control|)
name|dst_ptr
index|[
name|byte
index|]
operator|=
name|src_ptr
index|[
literal|0
index|]
expr_stmt|;
comment|/* or convert from color to gray? (MODE_COLOR_TO_GRAY) */
else|else
name|dst_ptr
index|[
literal|0
index|]
operator|=
name|LUMINOSITY
argument_list|(
name|src_ptr
argument_list|)
expr_stmt|;
comment|/* copy alpha information? */
if|if
condition|(
name|alpha_mode
operator|==
name|ALPHA_COPY
condition|)
name|dst_ptr
index|[
name|dst_alpha_index
index|]
operator|=
name|src_ptr
index|[
name|src_alpha_index
index|]
expr_stmt|;
comment|/* or clear the alpha chennel? */
elseif|else
if|if
condition|(
name|alpha_mode
operator|==
name|ALPHA_CLEAR
condition|)
name|dst_ptr
index|[
name|dst_alpha_index
index|]
operator|=
literal|0xff
expr_stmt|;
comment|/* next pixel */
name|dst_ptr
operator|+=
name|dst_rgn
operator|.
name|bpp
expr_stmt|;
name|x_ptr
operator|+=
name|x_rgn
operator|.
name|bpp
expr_stmt|;
name|y_ptr
operator|+=
name|y_rgn
operator|.
name|bpp
expr_stmt|;
block|}
comment|/* update progress indicator */
name|progress
operator|+=
name|dst_rgn
operator|.
name|w
operator|*
name|dst_rgn
operator|.
name|h
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
comment|/* update the destination drawable */
name|gimp_drawable_flush
argument_list|(
name|dst_drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_merge_shadow
argument_list|(
name|dst_drawable
operator|->
name|id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_update
argument_list|(
name|dst_drawable
operator|->
name|id
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
operator|(
name|x2
operator|-
name|x1
operator|)
argument_list|,
operator|(
name|y2
operator|-
name|y1
operator|)
argument_list|)
expr_stmt|;
comment|/* free the memory used for the contents of the source drawable */
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
comment|/* free the drawable structs */
name|gimp_drawable_detach
argument_list|(
name|dst_drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|src_drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|x_drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|y_drawable
argument_list|)
expr_stmt|;
comment|/* success! */
return|return
name|TRUE
return|;
block|}
end_function

begin_function
DECL|function|coordmap_dialog (gint32 dst_drawable_id)
specifier|static
name|gint
name|coordmap_dialog
parameter_list|(
name|gint32
name|dst_drawable_id
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|option_menu
decl_stmt|;
name|GtkWidget
modifier|*
name|menu
decl_stmt|;
name|gint
name|argc
init|=
literal|1
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|argv
init|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|gint
name|src_drawable_count
init|=
literal|0
decl_stmt|;
comment|/* initialize gtk */
name|argv
index|[
literal|0
index|]
operator|=
name|g_strdup
argument_list|(
literal|"Coordinate Map"
argument_list|)
expr_stmt|;
name|gtk_init
argument_list|(
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|gtk_rc_parse
argument_list|(
name|gimp_gtkrc
argument_list|()
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|argv
argument_list|)
expr_stmt|;
comment|/* the dialog box */
name|dlg
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"Coordinate Map"
argument_list|)
expr_stmt|;
name|gtk_window_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|coordmap_close_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* the "OK" button */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"OK"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|coordmap_ok_callback
argument_list|,
name|dlg
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
comment|/* the "Cancel" button */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"Cancel"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect_object
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|gtk_widget_destroy
argument_list|,
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
comment|/* a frame for that extra sexy look */
name|frame
operator|=
name|gtk_frame_new
argument_list|(
literal|"Coordinate Map Options"
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_ETCHED_IN
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* table to arrange the following labels and option menus*/
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
comment|/* the "Source Image" label */
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Source Image"
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/* option menu with a list of the possible source drawables */
name|option_menu
operator|=
name|gtk_option_menu_new
argument_list|()
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|option_menu
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|menu
operator|=
name|gimp_drawable_menu_new
argument_list|(
name|coordmap_src_drawable_constraint
argument_list|,
name|coordmap_src_drawable_callback
argument_list|,
operator|&
name|src_drawable_count
argument_list|,
name|cvals
operator|.
name|src_drawable_id
argument_list|)
expr_stmt|;
name|gtk_option_menu_set_menu
argument_list|(
name|GTK_OPTION_MENU
argument_list|(
name|option_menu
argument_list|)
argument_list|,
name|menu
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|option_menu
argument_list|)
expr_stmt|;
comment|/* the "X Map" label */
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"X Map"
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/* option menu with a list of the possible x drawables */
name|option_menu
operator|=
name|gtk_option_menu_new
argument_list|()
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|option_menu
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|menu
operator|=
name|gimp_drawable_menu_new
argument_list|(
name|coordmap_xy_drawable_constraint
argument_list|,
name|coordmap_x_drawable_callback
argument_list|,
operator|&
name|dst_drawable_id
argument_list|,
name|cvals
operator|.
name|x_drawable_id
argument_list|)
expr_stmt|;
name|gtk_option_menu_set_menu
argument_list|(
name|GTK_OPTION_MENU
argument_list|(
name|option_menu
argument_list|)
argument_list|,
name|menu
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|option_menu
argument_list|)
expr_stmt|;
comment|/* the "Y Map" label */
name|label
operator|=
name|gtk_label_new
argument_list|(
literal|"Y Map"
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
comment|/* option menu with a list of the possible y drawables */
name|option_menu
operator|=
name|gtk_option_menu_new
argument_list|()
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|option_menu
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_EXPAND
operator||
name|GTK_SHRINK
operator||
name|GTK_FILL
argument_list|,
name|GTK_SHRINK
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|menu
operator|=
name|gimp_drawable_menu_new
argument_list|(
name|coordmap_xy_drawable_constraint
argument_list|,
name|coordmap_y_drawable_callback
argument_list|,
operator|&
name|dst_drawable_id
argument_list|,
name|cvals
operator|.
name|y_drawable_id
argument_list|)
expr_stmt|;
name|gtk_option_menu_set_menu
argument_list|(
name|GTK_OPTION_MENU
argument_list|(
name|option_menu
argument_list|)
argument_list|,
name|menu
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|option_menu
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
comment|/* display error message if no appropriate source drawables were found */
if|if
condition|(
name|src_drawable_count
condition|)
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
else|else
block|{
name|gtk_widget_destroy
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|message_box
argument_list|(
literal|"No source image was found."
literal|"(The source image size must be 256x256)"
argument_list|)
expr_stmt|;
block|}
name|gtk_main
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
return|return
name|cint
operator|.
name|run
return|;
block|}
end_function

begin_function
DECL|function|coordmap_src_drawable_constraint (gint32 image_id,gint32 drawable_id,gpointer data)
specifier|static
name|gint
name|coordmap_src_drawable_constraint
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
comment|/*  * only appropriate drawables appear in the the "Source image" option menu:  * size must be SRC_WIDTH x SRC_HEIGHT.  * drawable must not be indexed.  */
block|{
name|gint
modifier|*
name|src_drawable_count
init|=
operator|(
name|gint
operator|*
operator|)
name|data
decl_stmt|;
if|if
condition|(
name|drawable_id
operator|==
operator|-
literal|1
condition|)
return|return
name|TRUE
return|;
if|if
condition|(
name|gimp_drawable_width
argument_list|(
name|drawable_id
argument_list|)
operator|==
name|SRC_WIDTH
operator|&&
name|gimp_drawable_height
argument_list|(
name|drawable_id
argument_list|)
operator|==
name|SRC_HEIGHT
operator|&&
operator|!
name|gimp_drawable_indexed
argument_list|(
name|drawable_id
argument_list|)
condition|)
block|{
comment|/* count how many valid drawables there are */
operator|(
operator|*
name|src_drawable_count
operator|)
operator|++
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
DECL|function|coordmap_xy_drawable_constraint (gint32 image_id,gint32 drawable_id,gpointer data)
specifier|static
name|gint
name|coordmap_xy_drawable_constraint
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
comment|/*  * only appropriate drawables appear in the the "X/Y MAP" option menus:  * size must be equal to destination drawable.  * drawable must not be indexed.  */
block|{
name|gint32
name|dst_drawable_id
init|=
operator|*
operator|(
name|gint32
operator|*
operator|)
name|data
decl_stmt|;
return|return
operator|(
name|drawable_id
operator|==
operator|-
literal|1
operator|||
operator|(
name|gimp_drawable_width
argument_list|(
name|drawable_id
argument_list|)
operator|==
name|gimp_drawable_width
argument_list|(
name|dst_drawable_id
argument_list|)
operator|&&
name|gimp_drawable_height
argument_list|(
name|drawable_id
argument_list|)
operator|==
name|gimp_drawable_height
argument_list|(
name|dst_drawable_id
argument_list|)
operator|&&
operator|!
name|gimp_drawable_indexed
argument_list|(
name|drawable_id
argument_list|)
operator|)
operator|)
return|;
block|}
end_function

begin_function
DECL|function|message_box (char * message)
specifier|static
name|void
name|message_box
parameter_list|(
name|char
modifier|*
name|message
parameter_list|)
comment|/*  * display a small dialog box for error messages  */
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
comment|/* the dialog box */
name|dlg
operator|=
name|gtk_dialog_new
argument_list|()
expr_stmt|;
name|gtk_window_set_title
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"Coordinate Map Error"
argument_list|)
expr_stmt|;
name|gtk_window_position
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|)
expr_stmt|;
name|gtk_signal_connect
argument_list|(
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|"destroy"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|coordmap_close_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* the "OK" button */
name|button
operator|=
name|gtk_button_new_with_label
argument_list|(
literal|"OK"
argument_list|)
expr_stmt|;
name|GTK_WIDGET_SET_FLAGS
argument_list|(
name|button
argument_list|,
name|GTK_CAN_DEFAULT
argument_list|)
expr_stmt|;
name|gtk_signal_connect_object
argument_list|(
name|GTK_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"clicked"
argument_list|,
operator|(
name|GtkSignalFunc
operator|)
name|coordmap_close_callback
argument_list|,
name|GTK_OBJECT
argument_list|(
name|dlg
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|action_area
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_grab_default
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
comment|/* the label showing the message */
name|label
operator|=
name|gtk_label_new
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|gtk_misc_set_padding
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
operator|->
name|vbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|coordmap_close_callback (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|coordmap_close_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
comment|/*  * gets called when the dialog window is closed via window manager  */
block|{
name|gtk_main_quit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
DECL|function|coordmap_ok_callback (GtkWidget * widget,gpointer dialog)
specifier|static
name|void
name|coordmap_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|dialog
parameter_list|)
comment|/*  * gets called when "OK" is pressed  */
block|{
comment|/* yes, we're going to run the plug-in */
name|cint
operator|.
name|run
operator|=
name|TRUE
expr_stmt|;
comment|/* close dialog window */
name|gtk_widget_destroy
argument_list|(
name|GTK_WIDGET
argument_list|(
name|dialog
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|coordmap_src_drawable_callback (gint32 id,gpointer data)
specifier|static
name|void
name|coordmap_src_drawable_callback
parameter_list|(
name|gint32
name|id
parameter_list|,
name|gpointer
name|data
parameter_list|)
comment|/*  * gets called when the user selects a different source drawable  */
block|{
name|cvals
operator|.
name|src_drawable_id
operator|=
name|id
expr_stmt|;
block|}
end_function

begin_function
DECL|function|coordmap_x_drawable_callback (gint32 id,gpointer data)
specifier|static
name|void
name|coordmap_x_drawable_callback
parameter_list|(
name|gint32
name|id
parameter_list|,
name|gpointer
name|data
parameter_list|)
comment|/*  * gets called when the user selects a different x drawable  */
block|{
name|cvals
operator|.
name|x_drawable_id
operator|=
name|id
expr_stmt|;
block|}
end_function

begin_function
DECL|function|coordmap_y_drawable_callback (gint32 id,gpointer data)
specifier|static
name|void
name|coordmap_y_drawable_callback
parameter_list|(
name|gint32
name|id
parameter_list|,
name|gpointer
name|data
parameter_list|)
comment|/*  * gets called when the user selects a different y drawable  */
block|{
name|cvals
operator|.
name|y_drawable_id
operator|=
name|id
expr_stmt|;
block|}
end_function

end_unit

