begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<jpeglib.h>
end_include

begin_include
include|#
directive|include
file|<jerror.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_EXIF
end_ifdef

begin_include
include|#
directive|include
file|<libexif/exif-data.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_EXIF */
end_comment

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_include
include|#
directive|include
file|"jpeg.h"
end_include

begin_include
include|#
directive|include
file|"jpeg-icc.h"
end_include

begin_include
include|#
directive|include
file|"jpeg-load.h"
end_include

begin_include
include|#
directive|include
file|"jpeg-save.h"
end_include

begin_include
include|#
directive|include
file|"jpeg-settings.h"
end_include

begin_define
DECL|macro|SCALE_WIDTH
define|#
directive|define
name|SCALE_WIDTH
value|125
end_define

begin_comment
comment|/* See bugs #63610 and #61088 for a discussion about the quality settings */
end_comment

begin_define
DECL|macro|DEFAULT_QUALITY
define|#
directive|define
name|DEFAULT_QUALITY
value|85.0
end_define

begin_define
DECL|macro|DEFAULT_SMOOTHING
define|#
directive|define
name|DEFAULT_SMOOTHING
value|0.0
end_define

begin_define
DECL|macro|DEFAULT_OPTIMIZE
define|#
directive|define
name|DEFAULT_OPTIMIZE
value|TRUE
end_define

begin_define
DECL|macro|DEFAULT_PROGRESSIVE
define|#
directive|define
name|DEFAULT_PROGRESSIVE
value|FALSE
end_define

begin_define
DECL|macro|DEFAULT_BASELINE
define|#
directive|define
name|DEFAULT_BASELINE
value|TRUE
end_define

begin_define
DECL|macro|DEFAULT_SUBSMP
define|#
directive|define
name|DEFAULT_SUBSMP
value|JPEG_SUPSAMPLING_1x1_1x1_1x1
end_define

begin_define
DECL|macro|DEFAULT_RESTART
define|#
directive|define
name|DEFAULT_RESTART
value|0
end_define

begin_define
DECL|macro|DEFAULT_DCT
define|#
directive|define
name|DEFAULT_DCT
value|0
end_define

begin_define
DECL|macro|DEFAULT_PREVIEW
define|#
directive|define
name|DEFAULT_PREVIEW
value|FALSE
end_define

begin_define
DECL|macro|DEFAULT_EXIF
define|#
directive|define
name|DEFAULT_EXIF
value|TRUE
end_define

begin_define
DECL|macro|DEFAULT_THUMBNAIL
define|#
directive|define
name|DEFAULT_THUMBNAIL
value|FALSE
end_define

begin_define
DECL|macro|DEFAULT_XMP
define|#
directive|define
name|DEFAULT_XMP
value|TRUE
end_define

begin_define
DECL|macro|DEFAULT_USE_ORIG_QUALITY
define|#
directive|define
name|DEFAULT_USE_ORIG_QUALITY
value|FALSE
end_define

begin_define
DECL|macro|JPEG_DEFAULTS_PARASITE
define|#
directive|define
name|JPEG_DEFAULTS_PARASITE
value|"jpeg-save-defaults"
end_define

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2afb39080108
block|{
DECL|member|cinfo
name|struct
name|jpeg_compress_struct
name|cinfo
decl_stmt|;
DECL|member|jerr
name|struct
name|jpeg_error_mgr
name|jerr
decl_stmt|;
DECL|member|tile_height
name|gint
name|tile_height
decl_stmt|;
DECL|member|outfile
name|FILE
modifier|*
name|outfile
decl_stmt|;
DECL|member|has_alpha
name|gboolean
name|has_alpha
decl_stmt|;
DECL|member|rowstride
name|gint
name|rowstride
decl_stmt|;
DECL|member|temp
name|guchar
modifier|*
name|temp
decl_stmt|;
DECL|member|data
name|guchar
modifier|*
name|data
decl_stmt|;
DECL|member|src
name|guchar
modifier|*
name|src
decl_stmt|;
DECL|member|drawable
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
DECL|member|pixel_rgn
name|GimpPixelRgn
name|pixel_rgn
decl_stmt|;
DECL|member|file_name
specifier|const
name|gchar
modifier|*
name|file_name
decl_stmt|;
DECL|member|abort_me
name|gboolean
name|abort_me
decl_stmt|;
DECL|member|source_id
name|guint
name|source_id
decl_stmt|;
DECL|typedef|PreviewPersistent
block|}
name|PreviewPersistent
typedef|;
end_typedef

begin_comment
comment|/*le added : struct containing pointers to save dialog*/
end_comment

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2afb39080208
block|{
DECL|member|run
name|gboolean
name|run
decl_stmt|;
DECL|member|use_restart_markers
name|GtkWidget
modifier|*
name|use_restart_markers
decl_stmt|;
comment|/*checkbox setting use restart markers*/
DECL|member|text_buffer
name|GtkTextBuffer
modifier|*
name|text_buffer
decl_stmt|;
DECL|member|scale_data
name|GtkObject
modifier|*
name|scale_data
decl_stmt|;
comment|/*for restart markers*/
DECL|member|handler_id_restart
name|gulong
name|handler_id_restart
decl_stmt|;
DECL|member|quality
name|GtkObject
modifier|*
name|quality
decl_stmt|;
comment|/*quality slidebar*/
DECL|member|smoothing
name|GtkObject
modifier|*
name|smoothing
decl_stmt|;
comment|/*smoothing slidebar*/
DECL|member|optimize
name|GtkWidget
modifier|*
name|optimize
decl_stmt|;
comment|/*optimize togle*/
DECL|member|progressive
name|GtkWidget
modifier|*
name|progressive
decl_stmt|;
comment|/*progressive toggle*/
DECL|member|subsmp
name|GtkWidget
modifier|*
name|subsmp
decl_stmt|;
comment|/*subsampling side select*/
DECL|member|restart
name|GtkWidget
modifier|*
name|restart
decl_stmt|;
comment|/*spinner for setting frequency restart markers*/
DECL|member|dct
name|GtkWidget
modifier|*
name|dct
decl_stmt|;
comment|/*DCT side select*/
DECL|member|preview
name|GtkWidget
modifier|*
name|preview
decl_stmt|;
comment|/*show preview toggle checkbox*/
DECL|member|save_exif
name|GtkWidget
modifier|*
name|save_exif
decl_stmt|;
DECL|member|save_thumbnail
name|GtkWidget
modifier|*
name|save_thumbnail
decl_stmt|;
DECL|member|save_xmp
name|GtkWidget
modifier|*
name|save_xmp
decl_stmt|;
DECL|member|use_orig_quality
name|GtkWidget
modifier|*
name|use_orig_quality
decl_stmt|;
comment|/*quant tables toggle*/
DECL|typedef|JpegSaveGui
block|}
name|JpegSaveGui
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|make_preview
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|save_restart_update
parameter_list|(
name|GtkAdjustment
modifier|*
name|adjustment
parameter_list|,
name|GtkWidget
modifier|*
name|toggle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|subsampling_changed
parameter_list|(
name|GtkWidget
modifier|*
name|combo
parameter_list|,
name|GtkObject
modifier|*
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|quality_changed
parameter_list|(
name|GtkObject
modifier|*
name|scale_entry
parameter_list|,
name|GtkWidget
modifier|*
name|toggle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|use_orig_qual_changed
parameter_list|(
name|GtkWidget
modifier|*
name|toggle
parameter_list|,
name|GtkObject
modifier|*
name|scale_entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|use_orig_qual_changed2
parameter_list|(
name|GtkWidget
modifier|*
name|toggle
parameter_list|,
name|GtkWidget
modifier|*
name|combo
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_EXIF
end_ifdef

begin_function_decl
specifier|static
name|gint
name|create_thumbnail
parameter_list|(
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|gdouble
name|quality
parameter_list|,
name|guchar
modifier|*
modifier|*
name|thumbnail_buffer
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_EXIF */
end_comment

begin_decl_stmt
DECL|variable|restart_markers_scale
specifier|static
name|GtkWidget
modifier|*
name|restart_markers_scale
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|restart_markers_label
specifier|static
name|GtkWidget
modifier|*
name|restart_markers_label
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|preview_size
specifier|static
name|GtkWidget
modifier|*
name|preview_size
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|prev_p
specifier|static
name|PreviewPersistent
modifier|*
name|prev_p
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|save_dialog_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|load_gui_defaults
parameter_list|(
name|JpegSaveGui
modifier|*
name|pg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|save_defaults
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * sg - This is the best I can do, I'm afraid... I think it will fail  * if something bad really happens (but it might not). If you have a  * better solution, send it ;-)  */
end_comment

begin_function
specifier|static
name|void
DECL|function|background_error_exit (j_common_ptr cinfo)
name|background_error_exit
parameter_list|(
name|j_common_ptr
name|cinfo
parameter_list|)
block|{
if|if
condition|(
name|prev_p
condition|)
name|prev_p
operator|->
name|abort_me
operator|=
name|TRUE
expr_stmt|;
call|(
modifier|*
name|cinfo
operator|->
name|err
operator|->
name|output_message
call|)
argument_list|(
name|cinfo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|background_jpeg_save (PreviewPersistent * pp)
name|background_jpeg_save
parameter_list|(
name|PreviewPersistent
modifier|*
name|pp
parameter_list|)
block|{
name|guchar
modifier|*
name|t
decl_stmt|;
name|guchar
modifier|*
name|s
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|gint
name|yend
decl_stmt|;
if|if
condition|(
name|pp
operator|->
name|abort_me
operator|||
operator|(
name|pp
operator|->
name|cinfo
operator|.
name|next_scanline
operator|>=
name|pp
operator|->
name|cinfo
operator|.
name|image_height
operator|)
condition|)
block|{
comment|/* clean up... */
if|if
condition|(
name|pp
operator|->
name|abort_me
condition|)
block|{
name|jpeg_abort_compress
argument_list|(
operator|&
operator|(
name|pp
operator|->
name|cinfo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|jpeg_finish_compress
argument_list|(
operator|&
operator|(
name|pp
operator|->
name|cinfo
operator|)
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|pp
operator|->
name|outfile
argument_list|)
expr_stmt|;
name|jpeg_destroy_compress
argument_list|(
operator|&
operator|(
name|pp
operator|->
name|cinfo
operator|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|pp
operator|->
name|temp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|pp
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|drawable
condition|)
name|gimp_drawable_detach
argument_list|(
name|pp
operator|->
name|drawable
argument_list|)
expr_stmt|;
comment|/* display the preview stuff */
if|if
condition|(
operator|!
name|pp
operator|->
name|abort_me
condition|)
block|{
name|struct
name|stat
name|buf
decl_stmt|;
name|gchar
modifier|*
name|text
decl_stmt|;
name|gchar
modifier|*
name|size_text
decl_stmt|;
name|g_stat
argument_list|(
name|pp
operator|->
name|file_name
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
name|size_text
operator|=
name|g_format_size_for_display
argument_list|(
name|buf
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|text
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"File size: %s"
argument_list|)
argument_list|,
name|size_text
argument_list|)
expr_stmt|;
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|preview_size
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|size_text
argument_list|)
expr_stmt|;
comment|/* and load the preview */
name|load_image
argument_list|(
name|pp
operator|->
name|file_name
argument_list|,
name|GIMP_RUN_NONINTERACTIVE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
comment|/* we cleanup here (load_image doesn't run in the background) */
name|g_unlink
argument_list|(
name|pp
operator|->
name|file_name
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|pp
argument_list|)
expr_stmt|;
name|prev_p
operator|=
name|NULL
expr_stmt|;
name|gimp_displays_flush
argument_list|()
expr_stmt|;
name|gdk_flush
argument_list|()
expr_stmt|;
return|return
name|FALSE
return|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|pp
operator|->
name|cinfo
operator|.
name|next_scanline
operator|%
name|pp
operator|->
name|tile_height
operator|)
operator|==
literal|0
condition|)
block|{
name|yend
operator|=
name|pp
operator|->
name|cinfo
operator|.
name|next_scanline
operator|+
name|pp
operator|->
name|tile_height
expr_stmt|;
name|yend
operator|=
name|MIN
argument_list|(
name|yend
argument_list|,
name|pp
operator|->
name|cinfo
operator|.
name|image_height
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_get_rect
argument_list|(
operator|&
name|pp
operator|->
name|pixel_rgn
argument_list|,
name|pp
operator|->
name|data
argument_list|,
literal|0
argument_list|,
name|pp
operator|->
name|cinfo
operator|.
name|next_scanline
argument_list|,
name|pp
operator|->
name|cinfo
operator|.
name|image_width
argument_list|,
operator|(
name|yend
operator|-
name|pp
operator|->
name|cinfo
operator|.
name|next_scanline
operator|)
argument_list|)
expr_stmt|;
name|pp
operator|->
name|src
operator|=
name|pp
operator|->
name|data
expr_stmt|;
block|}
name|t
operator|=
name|pp
operator|->
name|temp
expr_stmt|;
name|s
operator|=
name|pp
operator|->
name|src
expr_stmt|;
name|i
operator|=
name|pp
operator|->
name|cinfo
operator|.
name|image_width
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|pp
operator|->
name|cinfo
operator|.
name|input_components
condition|;
name|j
operator|++
control|)
operator|*
name|t
operator|++
operator|=
operator|*
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|has_alpha
condition|)
comment|/* ignore alpha channel */
name|s
operator|++
expr_stmt|;
block|}
name|pp
operator|->
name|src
operator|+=
name|pp
operator|->
name|rowstride
expr_stmt|;
name|jpeg_write_scanlines
argument_list|(
operator|&
operator|(
name|pp
operator|->
name|cinfo
operator|)
argument_list|,
operator|(
name|JSAMPARRAY
operator|)
operator|&
operator|(
name|pp
operator|->
name|temp
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
block|}
end_function

begin_function
name|gboolean
DECL|function|save_image (const gchar * filename,gint32 image_ID,gint32 drawable_ID,gint32 orig_image_ID,gboolean preview,GError ** error)
name|save_image
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|gint32
name|orig_image_ID
parameter_list|,
name|gboolean
name|preview
parameter_list|,
name|GError
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|GimpPixelRgn
name|pixel_rgn
decl_stmt|;
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|GimpImageType
name|drawable_type
decl_stmt|;
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
specifier|static
name|struct
name|jpeg_compress_struct
name|cinfo
decl_stmt|;
specifier|static
name|struct
name|my_error_mgr
name|jerr
decl_stmt|;
name|JpegSubsampling
name|subsampling
decl_stmt|;
name|FILE
modifier|*
specifier|volatile
name|outfile
decl_stmt|;
name|guchar
modifier|*
name|temp
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|guchar
modifier|*
name|data
decl_stmt|;
name|guchar
modifier|*
name|src
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|gboolean
name|has_alpha
decl_stmt|;
name|gint
name|rowstride
decl_stmt|,
name|yend
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|drawable_ID
argument_list|)
expr_stmt|;
name|drawable_type
operator|=
name|gimp_drawable_type
argument_list|(
name|drawable_ID
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|preview
condition|)
name|gimp_progress_init_printf
argument_list|(
name|_
argument_list|(
literal|"Saving '%s'"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Step 1: allocate and initialize JPEG compression object */
comment|/* We have to set up the error handler first, in case the initialization    * step fails.  (Unlikely, but it could happen if you are out of memory.)    * This routine fills in the contents of struct jerr, and returns jerr's    * address which we place into the link field in cinfo.    */
name|cinfo
operator|.
name|err
operator|=
name|jpeg_std_error
argument_list|(
operator|&
name|jerr
operator|.
name|pub
argument_list|)
expr_stmt|;
name|jerr
operator|.
name|pub
operator|.
name|error_exit
operator|=
name|my_error_exit
expr_stmt|;
name|outfile
operator|=
name|NULL
expr_stmt|;
comment|/* Establish the setjmp return context for my_error_exit to use. */
if|if
condition|(
name|setjmp
argument_list|(
name|jerr
operator|.
name|setjmp_buffer
argument_list|)
condition|)
block|{
comment|/* If we get here, the JPEG code has signaled an error.        * We need to clean up the JPEG object, close the input file, and return.        */
name|jpeg_destroy_compress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|outfile
condition|)
name|fclose
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|drawable
condition|)
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Now we can initialize the JPEG compression object. */
name|jpeg_create_compress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* Step 2: specify data destination (eg, a file) */
comment|/* Note: steps 2 and 3 can be done in either order. */
comment|/* Here we use the library-supplied code to send compressed data to a    * stdio stream.  You can also write your own code to do something else.    * VERY IMPORTANT: use "b" option to fopen() if you are on a machine that    * requires it in order to write binary files.    */
if|if
condition|(
operator|(
name|outfile
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"wb"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|g_set_error
argument_list|(
name|error
argument_list|,
name|G_FILE_ERROR
argument_list|,
name|g_file_error_from_errno
argument_list|(
name|errno
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Could not open '%s' for writing: %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|jpeg_stdio_dest
argument_list|(
operator|&
name|cinfo
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
comment|/* Get the input image and a pointer to its data.    */
switch|switch
condition|(
name|drawable_type
condition|)
block|{
case|case
name|GIMP_RGB_IMAGE
case|:
case|case
name|GIMP_GRAY_IMAGE
case|:
comment|/* # of color components per pixel */
name|cinfo
operator|.
name|input_components
operator|=
name|drawable
operator|->
name|bpp
expr_stmt|;
name|has_alpha
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
name|GIMP_RGBA_IMAGE
case|:
case|case
name|GIMP_GRAYA_IMAGE
case|:
comment|/* # of color components per pixel (minus the GIMP alpha channel) */
name|cinfo
operator|.
name|input_components
operator|=
name|drawable
operator|->
name|bpp
operator|-
literal|1
expr_stmt|;
name|has_alpha
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXED_IMAGE
case|:
return|return
name|FALSE
return|;
default|default:
return|return
name|FALSE
return|;
block|}
comment|/* Step 3: set parameters for compression */
comment|/* First we supply a description of the input image.    * Four fields of the cinfo struct must be filled in:    */
comment|/* image width and height, in pixels */
name|cinfo
operator|.
name|image_width
operator|=
name|drawable
operator|->
name|width
expr_stmt|;
name|cinfo
operator|.
name|image_height
operator|=
name|drawable
operator|->
name|height
expr_stmt|;
comment|/* colorspace of input image */
name|cinfo
operator|.
name|in_color_space
operator|=
operator|(
name|drawable_type
operator|==
name|GIMP_RGB_IMAGE
operator|||
name|drawable_type
operator|==
name|GIMP_RGBA_IMAGE
operator|)
condition|?
name|JCS_RGB
else|:
name|JCS_GRAYSCALE
expr_stmt|;
comment|/* Now use the library's routine to set default compression parameters.    * (You must set at least cinfo.in_color_space before calling this,    * since the defaults depend on the source color space.)    */
name|jpeg_set_defaults
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
name|jpeg_set_quality
argument_list|(
operator|&
name|cinfo
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|jsvals
operator|.
name|quality
operator|+
literal|0.5
argument_list|)
argument_list|,
name|jsvals
operator|.
name|baseline
argument_list|)
expr_stmt|;
if|if
condition|(
name|jsvals
operator|.
name|use_orig_quality
operator|&&
name|num_quant_tables
operator|>
literal|0
condition|)
block|{
name|guint
modifier|*
modifier|*
name|quant_tables
decl_stmt|;
name|gint
name|t
decl_stmt|;
comment|/* override tables generated by jpeg_set_quality() with custom tables */
name|quant_tables
operator|=
name|jpeg_restore_original_tables
argument_list|(
name|image_ID
argument_list|,
name|num_quant_tables
argument_list|)
expr_stmt|;
if|if
condition|(
name|quant_tables
condition|)
block|{
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|num_quant_tables
condition|;
name|t
operator|++
control|)
block|{
name|jpeg_add_quant_table
argument_list|(
operator|&
name|cinfo
argument_list|,
name|t
argument_list|,
name|quant_tables
index|[
name|t
index|]
argument_list|,
literal|100
argument_list|,
name|jsvals
operator|.
name|baseline
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|quant_tables
index|[
name|t
index|]
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|quant_tables
argument_list|)
expr_stmt|;
block|}
block|}
name|cinfo
operator|.
name|optimize_coding
operator|=
name|jsvals
operator|.
name|optimize
expr_stmt|;
name|subsampling
operator|=
operator|(
name|gimp_drawable_is_rgb
argument_list|(
name|drawable_ID
argument_list|)
condition|?
name|jsvals
operator|.
name|subsmp
else|:
name|JPEG_SUPSAMPLING_1x1_1x1_1x1
operator|)
expr_stmt|;
comment|/*  smoothing is not supported with nonstandard sampling ratios  */
if|if
condition|(
name|subsampling
operator|!=
name|JPEG_SUPSAMPLING_2x1_1x1_1x1
operator|&&
name|subsampling
operator|!=
name|JPEG_SUPSAMPLING_1x2_1x1_1x1
condition|)
block|{
name|cinfo
operator|.
name|smoothing_factor
operator|=
call|(
name|gint
call|)
argument_list|(
name|jsvals
operator|.
name|smoothing
operator|*
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|jsvals
operator|.
name|progressive
condition|)
block|{
name|jpeg_simple_progression
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|subsampling
condition|)
block|{
case|case
name|JPEG_SUPSAMPLING_2x2_1x1_1x1
case|:
default|default:
name|cinfo
operator|.
name|comp_info
index|[
literal|0
index|]
operator|.
name|h_samp_factor
operator|=
literal|2
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|0
index|]
operator|.
name|v_samp_factor
operator|=
literal|2
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|1
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|1
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|2
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|2
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|JPEG_SUPSAMPLING_2x1_1x1_1x1
case|:
name|cinfo
operator|.
name|comp_info
index|[
literal|0
index|]
operator|.
name|h_samp_factor
operator|=
literal|2
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|0
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|1
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|1
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|2
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|2
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|JPEG_SUPSAMPLING_1x1_1x1_1x1
case|:
name|cinfo
operator|.
name|comp_info
index|[
literal|0
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|0
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|1
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|1
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|2
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|2
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|JPEG_SUPSAMPLING_1x2_1x1_1x1
case|:
name|cinfo
operator|.
name|comp_info
index|[
literal|0
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|0
index|]
operator|.
name|v_samp_factor
operator|=
literal|2
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|1
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|1
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|2
index|]
operator|.
name|h_samp_factor
operator|=
literal|1
expr_stmt|;
name|cinfo
operator|.
name|comp_info
index|[
literal|2
index|]
operator|.
name|v_samp_factor
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|cinfo
operator|.
name|restart_interval
operator|=
literal|0
expr_stmt|;
name|cinfo
operator|.
name|restart_in_rows
operator|=
name|jsvals
operator|.
name|restart
expr_stmt|;
switch|switch
condition|(
name|jsvals
operator|.
name|dct
condition|)
block|{
case|case
literal|0
case|:
default|default:
name|cinfo
operator|.
name|dct_method
operator|=
name|JDCT_ISLOW
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|cinfo
operator|.
name|dct_method
operator|=
name|JDCT_IFAST
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|cinfo
operator|.
name|dct_method
operator|=
name|JDCT_FLOAT
expr_stmt|;
break|break;
block|}
block|{
name|gdouble
name|xresolution
decl_stmt|;
name|gdouble
name|yresolution
decl_stmt|;
name|gimp_image_get_resolution
argument_list|(
name|orig_image_ID
argument_list|,
operator|&
name|xresolution
argument_list|,
operator|&
name|yresolution
argument_list|)
expr_stmt|;
if|if
condition|(
name|xresolution
operator|>
literal|1e-5
operator|&&
name|yresolution
operator|>
literal|1e-5
condition|)
block|{
name|gdouble
name|factor
decl_stmt|;
name|factor
operator|=
name|gimp_unit_get_factor
argument_list|(
name|gimp_image_get_unit
argument_list|(
name|orig_image_ID
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|factor
operator|==
literal|2.54
comment|/* cm */
operator|||
name|factor
operator|==
literal|25.4
comment|/* mm */
condition|)
block|{
name|cinfo
operator|.
name|density_unit
operator|=
literal|2
expr_stmt|;
comment|/* dots per cm */
name|xresolution
operator|/=
literal|2.54
expr_stmt|;
name|yresolution
operator|/=
literal|2.54
expr_stmt|;
block|}
else|else
block|{
name|cinfo
operator|.
name|density_unit
operator|=
literal|1
expr_stmt|;
comment|/* dots per inch */
block|}
name|cinfo
operator|.
name|X_density
operator|=
name|xresolution
expr_stmt|;
name|cinfo
operator|.
name|Y_density
operator|=
name|yresolution
expr_stmt|;
block|}
block|}
comment|/* Step 4: Start compressor */
comment|/* TRUE ensures that we will write a complete interchange-JPEG file.    * Pass TRUE unless you are very sure of what you're doing.    */
name|jpeg_start_compress
argument_list|(
operator|&
name|cinfo
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_EXIF
comment|/* Create the thumbnail JPEG in a buffer */
if|if
condition|(
operator|(
name|jsvals
operator|.
name|save_exif
operator|&&
name|exif_data
operator|)
operator|||
name|jsvals
operator|.
name|save_thumbnail
condition|)
block|{
name|ExifData
modifier|*
name|exif_data_tmp
init|=
name|NULL
decl_stmt|;
name|guchar
modifier|*
name|exif_buf
init|=
name|NULL
decl_stmt|;
name|guchar
modifier|*
name|thumbnail_buffer
init|=
name|NULL
decl_stmt|;
name|gint
name|thumbnail_buffer_length
init|=
literal|0
decl_stmt|;
name|guint
name|exif_buf_len
decl_stmt|;
name|gdouble
name|quality
init|=
name|MIN
argument_list|(
literal|75.0
argument_list|,
name|jsvals
operator|.
name|quality
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|jsvals
operator|.
name|save_exif
operator|)
operator|||
operator|(
operator|!
name|exif_data
operator|)
condition|)
name|exif_data_tmp
operator|=
name|exif_data_new
argument_list|()
expr_stmt|;
else|else
name|exif_data_tmp
operator|=
name|exif_data
expr_stmt|;
comment|/* avoid saving markers longer than 65533, gradually decrease        * quality in steps of 5 until exif_buf_len is lower than that.        */
for|for
control|(
name|exif_buf_len
operator|=
literal|65535
init|;
name|exif_buf_len
operator|>
literal|65533
operator|&&
name|quality
operator|>
literal|0.0
condition|;
name|quality
operator|-=
literal|5.0
control|)
block|{
if|if
condition|(
name|jsvals
operator|.
name|save_thumbnail
condition|)
name|thumbnail_buffer_length
operator|=
name|create_thumbnail
argument_list|(
name|image_ID
argument_list|,
name|drawable_ID
argument_list|,
name|quality
argument_list|,
operator|&
name|thumbnail_buffer
argument_list|)
expr_stmt|;
name|exif_data_tmp
operator|->
name|data
operator|=
name|thumbnail_buffer
expr_stmt|;
name|exif_data_tmp
operator|->
name|size
operator|=
name|thumbnail_buffer_length
expr_stmt|;
if|if
condition|(
name|exif_buf
condition|)
name|free
argument_list|(
name|exif_buf
argument_list|)
expr_stmt|;
name|exif_data_save_data
argument_list|(
name|exif_data_tmp
argument_list|,
operator|&
name|exif_buf
argument_list|,
operator|&
name|exif_buf_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|exif_buf_len
operator|>
literal|65533
condition|)
block|{
comment|/* last attempt with quality 0.0 */
if|if
condition|(
name|jsvals
operator|.
name|save_thumbnail
condition|)
name|thumbnail_buffer_length
operator|=
name|create_thumbnail
argument_list|(
name|image_ID
argument_list|,
name|drawable_ID
argument_list|,
literal|0.0
argument_list|,
operator|&
name|thumbnail_buffer
argument_list|)
expr_stmt|;
name|exif_data_tmp
operator|->
name|data
operator|=
name|thumbnail_buffer
expr_stmt|;
name|exif_data_tmp
operator|->
name|size
operator|=
name|thumbnail_buffer_length
expr_stmt|;
if|if
condition|(
name|exif_buf
condition|)
name|free
argument_list|(
name|exif_buf
argument_list|)
expr_stmt|;
name|exif_data_save_data
argument_list|(
name|exif_data_tmp
argument_list|,
operator|&
name|exif_buf
argument_list|,
operator|&
name|exif_buf_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|exif_buf_len
operator|>
literal|65533
condition|)
block|{
comment|/* still no go? save without thumbnail */
name|exif_data_tmp
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
name|exif_data_tmp
operator|->
name|size
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|exif_buf
condition|)
name|free
argument_list|(
name|exif_buf
argument_list|)
expr_stmt|;
name|exif_data_save_data
argument_list|(
name|exif_data_tmp
argument_list|,
operator|&
name|exif_buf
argument_list|,
operator|&
name|exif_buf_len
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|GIMP_UNSTABLE
name|g_print
argument_list|(
literal|"jpeg-save: saving EXIF block (%d bytes)\n"
argument_list|,
name|exif_buf_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|jpeg_write_marker
argument_list|(
operator|&
name|cinfo
argument_list|,
name|JPEG_APP0
operator|+
literal|1
argument_list|,
name|exif_buf
argument_list|,
name|exif_buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|exif_buf
condition|)
name|free
argument_list|(
name|exif_buf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HAVE_EXIF */
comment|/* Step 4.1: Write the comment out - pw */
if|if
condition|(
name|image_comment
operator|&&
operator|*
name|image_comment
condition|)
block|{
ifdef|#
directive|ifdef
name|GIMP_UNSTABLE
name|g_print
argument_list|(
literal|"jpeg-save: saving image comment (%d bytes)\n"
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|image_comment
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|jpeg_write_marker
argument_list|(
operator|&
name|cinfo
argument_list|,
name|JPEG_COM
argument_list|,
operator|(
name|guchar
operator|*
operator|)
name|image_comment
argument_list|,
name|strlen
argument_list|(
name|image_comment
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Step 4.2: Write the XMP packet in an APP1 marker */
if|if
condition|(
name|jsvals
operator|.
name|save_xmp
condition|)
block|{
comment|/* FIXME: temporary hack until the right thing is done by a library */
name|parasite
operator|=
name|gimp_image_get_parasite
argument_list|(
name|orig_image_ID
argument_list|,
literal|"gimp-metadata"
argument_list|)
expr_stmt|;
if|if
condition|(
name|parasite
condition|)
block|{
specifier|const
name|gchar
modifier|*
name|xmp_data
decl_stmt|;
name|glong
name|xmp_data_size
decl_stmt|;
name|guchar
modifier|*
name|app_block
decl_stmt|;
name|xmp_data
operator|=
operator|(
operator|(
specifier|const
name|gchar
operator|*
operator|)
name|gimp_parasite_data
argument_list|(
name|parasite
argument_list|)
operator|)
operator|+
literal|10
expr_stmt|;
name|xmp_data_size
operator|=
name|gimp_parasite_data_size
argument_list|(
name|parasite
argument_list|)
operator|-
literal|10
expr_stmt|;
ifdef|#
directive|ifdef
name|GIMP_UNSTABLE
name|g_print
argument_list|(
literal|"jpeg-save: saving XMP packet (%d bytes)\n"
argument_list|,
operator|(
name|int
operator|)
name|xmp_data_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|app_block
operator|=
name|g_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|JPEG_APP_HEADER_XMP
argument_list|)
operator|+
name|xmp_data_size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|app_block
argument_list|,
name|JPEG_APP_HEADER_XMP
argument_list|,
sizeof|sizeof
argument_list|(
name|JPEG_APP_HEADER_XMP
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|app_block
operator|+
sizeof|sizeof
argument_list|(
name|JPEG_APP_HEADER_XMP
argument_list|)
argument_list|,
name|xmp_data
argument_list|,
name|xmp_data_size
argument_list|)
expr_stmt|;
name|jpeg_write_marker
argument_list|(
operator|&
name|cinfo
argument_list|,
name|JPEG_APP0
operator|+
literal|1
argument_list|,
name|app_block
argument_list|,
sizeof|sizeof
argument_list|(
name|JPEG_APP_HEADER_XMP
argument_list|)
operator|+
name|xmp_data_size
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|app_block
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Step 4.3: store the color profile if there is one */
name|parasite
operator|=
name|gimp_image_get_parasite
argument_list|(
name|orig_image_ID
argument_list|,
literal|"icc-profile"
argument_list|)
expr_stmt|;
if|if
condition|(
name|parasite
condition|)
block|{
name|jpeg_icc_write_profile
argument_list|(
operator|&
name|cinfo
argument_list|,
name|gimp_parasite_data
argument_list|(
name|parasite
argument_list|)
argument_list|,
name|gimp_parasite_data_size
argument_list|(
name|parasite
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
block|}
comment|/* Step 5: while (scan lines remain to be written) */
comment|/*           jpeg_write_scanlines(...); */
comment|/* Here we use the library's state variable cinfo.next_scanline as the    * loop counter, so that we don't have to keep track ourselves.    * To keep things simple, we pass one scanline per call; you can pass    * more if you wish, though.    */
comment|/* JSAMPLEs per row in image_buffer */
name|rowstride
operator|=
name|drawable
operator|->
name|bpp
operator|*
name|drawable
operator|->
name|width
expr_stmt|;
name|temp
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|cinfo
operator|.
name|image_width
operator|*
name|cinfo
operator|.
name|input_components
argument_list|)
expr_stmt|;
name|data
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|rowstride
operator|*
name|gimp_tile_height
argument_list|()
argument_list|)
expr_stmt|;
comment|/* fault if cinfo.next_scanline isn't initially a multiple of    * gimp_tile_height */
name|src
operator|=
name|NULL
expr_stmt|;
comment|/*    * sg - if we preview, we want this to happen in the background -- do    * not duplicate code in the future; for now, it's OK    */
if|if
condition|(
name|preview
condition|)
block|{
name|PreviewPersistent
modifier|*
name|pp
init|=
name|g_new
argument_list|(
name|PreviewPersistent
argument_list|,
literal|1
argument_list|)
decl_stmt|;
comment|/* pass all the information we need */
name|pp
operator|->
name|cinfo
operator|=
name|cinfo
expr_stmt|;
name|pp
operator|->
name|tile_height
operator|=
name|gimp_tile_height
argument_list|()
expr_stmt|;
name|pp
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|pp
operator|->
name|outfile
operator|=
name|outfile
expr_stmt|;
name|pp
operator|->
name|has_alpha
operator|=
name|has_alpha
expr_stmt|;
name|pp
operator|->
name|rowstride
operator|=
name|rowstride
expr_stmt|;
name|pp
operator|->
name|temp
operator|=
name|temp
expr_stmt|;
name|pp
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|pp
operator|->
name|drawable
operator|=
name|drawable
expr_stmt|;
name|pp
operator|->
name|pixel_rgn
operator|=
name|pixel_rgn
expr_stmt|;
name|pp
operator|->
name|src
operator|=
name|NULL
expr_stmt|;
name|pp
operator|->
name|file_name
operator|=
name|filename
expr_stmt|;
name|pp
operator|->
name|abort_me
operator|=
name|FALSE
expr_stmt|;
name|g_warn_if_fail
argument_list|(
name|prev_p
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|prev_p
operator|=
name|pp
expr_stmt|;
name|pp
operator|->
name|cinfo
operator|.
name|err
operator|=
name|jpeg_std_error
argument_list|(
operator|&
operator|(
name|pp
operator|->
name|jerr
operator|)
argument_list|)
expr_stmt|;
name|pp
operator|->
name|jerr
operator|.
name|error_exit
operator|=
name|background_error_exit
expr_stmt|;
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|preview_size
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Calculating file size..."
argument_list|)
argument_list|)
expr_stmt|;
name|pp
operator|->
name|source_id
operator|=
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|background_jpeg_save
argument_list|,
name|pp
argument_list|)
expr_stmt|;
comment|/* background_jpeg_save() will cleanup as needed */
return|return
name|TRUE
return|;
block|}
while|while
condition|(
name|cinfo
operator|.
name|next_scanline
operator|<
name|cinfo
operator|.
name|image_height
condition|)
block|{
if|if
condition|(
operator|(
name|cinfo
operator|.
name|next_scanline
operator|%
name|gimp_tile_height
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|yend
operator|=
name|cinfo
operator|.
name|next_scanline
operator|+
name|gimp_tile_height
argument_list|()
expr_stmt|;
name|yend
operator|=
name|MIN
argument_list|(
name|yend
argument_list|,
name|cinfo
operator|.
name|image_height
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_get_rect
argument_list|(
operator|&
name|pixel_rgn
argument_list|,
name|data
argument_list|,
literal|0
argument_list|,
name|cinfo
operator|.
name|next_scanline
argument_list|,
name|cinfo
operator|.
name|image_width
argument_list|,
operator|(
name|yend
operator|-
name|cinfo
operator|.
name|next_scanline
operator|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|data
expr_stmt|;
block|}
name|t
operator|=
name|temp
expr_stmt|;
name|s
operator|=
name|src
expr_stmt|;
name|i
operator|=
name|cinfo
operator|.
name|image_width
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|cinfo
operator|.
name|input_components
condition|;
name|j
operator|++
control|)
operator|*
name|t
operator|++
operator|=
operator|*
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|has_alpha
condition|)
comment|/* ignore alpha channel */
name|s
operator|++
expr_stmt|;
block|}
name|src
operator|+=
name|rowstride
expr_stmt|;
name|jpeg_write_scanlines
argument_list|(
operator|&
name|cinfo
argument_list|,
operator|(
name|JSAMPARRAY
operator|)
operator|&
name|temp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cinfo
operator|.
name|next_scanline
operator|%
literal|32
operator|)
operator|==
literal|0
condition|)
name|gimp_progress_update
argument_list|(
operator|(
name|gdouble
operator|)
name|cinfo
operator|.
name|next_scanline
operator|/
operator|(
name|gdouble
operator|)
name|cinfo
operator|.
name|image_height
argument_list|)
expr_stmt|;
block|}
comment|/* Step 6: Finish compression */
name|jpeg_finish_compress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* After finish_compress, we can close the output file. */
name|fclose
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
comment|/* Step 7: release JPEG compression object */
comment|/* This is an important step since it will release a good deal of memory. */
name|jpeg_destroy_compress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* free the temporary buffer */
name|g_free
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
comment|/* And we're done! */
name|gimp_progress_update
argument_list|(
literal|1.0
argument_list|)
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|make_preview (void)
name|make_preview
parameter_list|(
name|void
parameter_list|)
block|{
name|destroy_preview
argument_list|()
expr_stmt|;
if|if
condition|(
name|jsvals
operator|.
name|preview
condition|)
block|{
name|gchar
modifier|*
name|tn
init|=
name|gimp_temp_name
argument_list|(
literal|"jpeg"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|undo_touched
condition|)
block|{
comment|/* we freeze undo saving so that we can avoid sucking up            * tile cache with our unneeded preview steps. */
name|gimp_image_undo_freeze
argument_list|(
name|preview_image_ID
argument_list|)
expr_stmt|;
name|undo_touched
operator|=
name|TRUE
expr_stmt|;
block|}
name|save_image
argument_list|(
name|tn
argument_list|,
name|preview_image_ID
argument_list|,
name|drawable_ID_global
argument_list|,
name|orig_image_ID_global
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|display_ID
operator|==
operator|-
literal|1
condition|)
name|display_ID
operator|=
name|gimp_display_new
argument_list|(
name|preview_image_ID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gtk_label_set_text
argument_list|(
name|GTK_LABEL
argument_list|(
name|preview_size
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"File size: unknown"
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_displays_flush
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|destroy_preview (void)
name|destroy_preview
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|prev_p
operator|&&
operator|!
name|prev_p
operator|->
name|abort_me
condition|)
block|{
name|guint
name|id
init|=
name|prev_p
operator|->
name|source_id
decl_stmt|;
name|prev_p
operator|->
name|abort_me
operator|=
name|TRUE
expr_stmt|;
comment|/* signal the background save to stop */
name|background_jpeg_save
argument_list|(
name|prev_p
argument_list|)
expr_stmt|;
name|g_source_remove
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drawable_global
condition|)
block|{
name|gimp_drawable_detach
argument_list|(
name|drawable_global
argument_list|)
expr_stmt|;
name|drawable_global
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|gimp_image_is_valid
argument_list|(
name|preview_image_ID
argument_list|)
operator|&&
name|gimp_item_is_valid
argument_list|(
name|preview_layer_ID
argument_list|)
condition|)
block|{
comment|/*  assuming that reference counting is working correctly,           we do not need to delete the layer, removing it from           the image should be sufficient  */
name|gimp_image_remove_layer
argument_list|(
name|preview_image_ID
argument_list|,
name|preview_layer_ID
argument_list|)
expr_stmt|;
name|preview_layer_ID
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
name|gboolean
DECL|function|save_dialog (void)
name|save_dialog
parameter_list|(
name|void
parameter_list|)
block|{
name|JpegSaveGui
name|pg
decl_stmt|;
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkObject
modifier|*
name|entry
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|table2
decl_stmt|;
name|GtkWidget
modifier|*
name|tabledefaults
decl_stmt|;
name|GtkWidget
modifier|*
name|expander
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle
decl_stmt|;
name|GtkWidget
modifier|*
name|spinbutton
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|combo
decl_stmt|;
name|GtkWidget
modifier|*
name|text_view
decl_stmt|;
name|GtkTextBuffer
modifier|*
name|text_buffer
decl_stmt|;
name|GtkWidget
modifier|*
name|scrolled_window
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|gchar
modifier|*
name|text
decl_stmt|;
name|dialog
operator|=
name|gimp_export_dialog_new
argument_list|(
name|_
argument_list|(
literal|"JPEG"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|SAVE_PROC
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dialog
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|save_dialog_response
argument_list|)
argument_list|,
operator|&
name|pg
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dialog
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_main_quit
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_window_set_resizable
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gimp_export_dialog_get_content_area
argument_list|(
name|dialog
argument_list|)
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|pg
operator|.
name|quality
operator|=
name|entry
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"_Quality:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|0
argument_list|,
name|jsvals
operator|.
name|quality
argument_list|,
literal|0.0
argument_list|,
literal|100.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|_
argument_list|(
literal|"JPEG quality parameter"
argument_list|)
argument_list|,
literal|"file-jpeg-save-quality"
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|quality
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|make_preview
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|preview_size
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"File size: unknown"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|preview_size
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gimp_label_set_attributes
argument_list|(
name|GTK_LABEL
argument_list|(
name|preview_size
argument_list|)
argument_list|,
name|PANGO_ATTR_STYLE
argument_list|,
name|PANGO_STYLE_ITALIC
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|preview_size
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|preview_size
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|preview_size
argument_list|,
name|_
argument_list|(
literal|"Enable preview to obtain the file size."
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pg
operator|.
name|preview
operator|=
name|toggle
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"Sho_w preview in image window"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|jsvals
operator|.
name|preview
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|preview
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|make_preview
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|text
operator|=
name|g_strdup_printf
argument_list|(
literal|"<b>%s</b>"
argument_list|,
name|_
argument_list|(
literal|"_Advanced Options"
argument_list|)
argument_list|)
expr_stmt|;
name|expander
operator|=
name|gtk_expander_new_with_mnemonic
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|gtk_expander_set_use_markup
argument_list|(
name|GTK_EXPANDER
argument_list|(
name|expander
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|expander
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|expander
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|expander
argument_list|)
argument_list|,
name|vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
literal|"<expander>"
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|4
argument_list|,
literal|7
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacing
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|table2
operator|=
name|gtk_table_new
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table2
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|table2
argument_list|,
literal|2
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table2
argument_list|)
expr_stmt|;
name|pg
operator|.
name|smoothing
operator|=
name|entry
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table2
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"S_moothing:"
argument_list|)
argument_list|,
literal|100
argument_list|,
literal|0
argument_list|,
name|jsvals
operator|.
name|smoothing
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
literal|"file-jpeg-save-smoothing"
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|smoothing
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|make_preview
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|restart_markers_label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Frequency (rows):"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|restart_markers_label
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|restart_markers_label
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
operator||
name|GTK_EXPAND
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|restart_markers_label
argument_list|)
expr_stmt|;
comment|/*pg.scale_data = scale_data;*/
name|pg
operator|.
name|restart
operator|=
name|restart_markers_scale
operator|=
name|spinbutton
operator|=
name|gimp_spin_button_new
argument_list|(
operator|&
name|pg
operator|.
name|scale_data
argument_list|,
operator|(
name|jsvals
operator|.
name|restart
operator|==
literal|0
operator|)
condition|?
literal|1
else|:
name|jsvals
operator|.
name|restart
argument_list|,
literal|1.0
argument_list|,
literal|64.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|0
argument_list|,
literal|1.0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|spinbutton
argument_list|,
literal|5
argument_list|,
literal|6
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|spinbutton
argument_list|)
expr_stmt|;
name|pg
operator|.
name|use_restart_markers
operator|=
name|toggle
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"Use _restart markers"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|toggle
argument_list|,
literal|2
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|jsvals
operator|.
name|restart
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|restart_markers_label
argument_list|,
name|jsvals
operator|.
name|restart
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|restart_markers_scale
argument_list|,
name|jsvals
operator|.
name|restart
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|pg
operator|.
name|scale_data
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|save_restart_update
argument_list|)
argument_list|,
name|toggle
argument_list|)
expr_stmt|;
name|pg
operator|.
name|handler_id_restart
operator|=
name|g_signal_connect_swapped
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|save_restart_update
argument_list|)
argument_list|,
name|pg
operator|.
name|scale_data
argument_list|)
expr_stmt|;
name|pg
operator|.
name|optimize
operator|=
name|toggle
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Optimize"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|toggle
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|optimize
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|make_preview
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|jsvals
operator|.
name|optimize
argument_list|)
expr_stmt|;
name|pg
operator|.
name|progressive
operator|=
name|toggle
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Progressive"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|toggle
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|progressive
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|make_preview
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|jsvals
operator|.
name|progressive
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_EXIF
name|pg
operator|.
name|save_exif
operator|=
name|toggle
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"Save _EXIF data"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|toggle
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|save_exif
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|make_preview
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|jsvals
operator|.
name|save_exif
operator|&&
name|exif_data
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|toggle
argument_list|,
name|exif_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|pg
operator|.
name|save_thumbnail
operator|=
name|toggle
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"Save _thumbnail"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|toggle
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|save_thumbnail
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|make_preview
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|jsvals
operator|.
name|save_thumbnail
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_EXIF */
comment|/* XMP metadata */
name|pg
operator|.
name|save_xmp
operator|=
name|toggle
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"Save _XMP data"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|toggle
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|save_xmp
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|jsvals
operator|.
name|save_xmp
operator|&&
name|has_metadata
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|toggle
argument_list|,
name|has_metadata
argument_list|)
expr_stmt|;
comment|/* custom quantization tables - now used also for original quality */
name|pg
operator|.
name|use_orig_quality
operator|=
name|toggle
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Use quality settings from original "
literal|"image"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|toggle
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
literal|6
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|gimp_help_set_help_data
argument_list|(
name|toggle
argument_list|,
name|_
argument_list|(
literal|"If the original image was loaded from a JPEG "
literal|"file using non-standard quality settings "
literal|"(quantization tables), enable this option to "
literal|"get almost the same quality and file size."
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|use_orig_quality
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|jsvals
operator|.
name|use_orig_quality
operator|&&
operator|(
name|orig_quality
operator|>
literal|0
operator|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|toggle
argument_list|,
operator|(
name|orig_quality
operator|>
literal|0
operator|)
argument_list|)
expr_stmt|;
comment|/* changing quality disables custom quantization tables, and vice-versa */
name|g_signal_connect
argument_list|(
name|pg
operator|.
name|quality
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|quality_changed
argument_list|)
argument_list|,
name|pg
operator|.
name|use_orig_quality
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|pg
operator|.
name|use_orig_quality
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|use_orig_qual_changed
argument_list|)
argument_list|,
name|pg
operator|.
name|quality
argument_list|)
expr_stmt|;
comment|/* Subsampling */
name|label
operator|=
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"Su_bsampling:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|pg
operator|.
name|subsmp
operator|=
name|combo
operator|=
name|gimp_int_combo_box_new
argument_list|(
name|_
argument_list|(
literal|"1x1,1x1,1x1 (best quality)"
argument_list|)
argument_list|,
name|JPEG_SUPSAMPLING_1x1_1x1_1x1
argument_list|,
name|_
argument_list|(
literal|"2x1,1x1,1x1 (4:2:2)"
argument_list|)
argument_list|,
name|JPEG_SUPSAMPLING_2x1_1x1_1x1
argument_list|,
name|_
argument_list|(
literal|"1x2,1x1,1x1"
argument_list|)
argument_list|,
name|JPEG_SUPSAMPLING_1x2_1x1_1x1
argument_list|,
name|_
argument_list|(
literal|"2x2,1x1,1x1 (smallest file)"
argument_list|)
argument_list|,
name|JPEG_SUPSAMPLING_2x2_1x1_1x1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|combo
argument_list|,
literal|3
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
name|GTK_FILL
operator||
name|GTK_EXPAND
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|combo
argument_list|)
expr_stmt|;
name|gtk_label_set_mnemonic_widget
argument_list|(
name|GTK_LABEL
argument_list|(
name|label
argument_list|)
argument_list|,
name|combo
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_drawable_is_rgb
argument_list|(
name|drawable_ID_global
argument_list|)
condition|)
block|{
name|gimp_int_combo_box_connect
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|combo
argument_list|)
argument_list|,
name|jsvals
operator|.
name|subsmp
argument_list|,
name|G_CALLBACK
argument_list|(
name|subsampling_changed
argument_list|)
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|pg
operator|.
name|use_orig_quality
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|use_orig_qual_changed2
argument_list|)
argument_list|,
name|pg
operator|.
name|subsmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|combo
argument_list|)
argument_list|,
name|JPEG_SUPSAMPLING_1x1_1x1_1x1
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|combo
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
comment|/* DCT method */
name|label
operator|=
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_DCT method:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
name|GTK_FILL
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|pg
operator|.
name|dct
operator|=
name|combo
operator|=
name|gimp_int_combo_box_new
argument_list|(
name|_
argument_list|(
literal|"Fast Integer"
argument_list|)
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Integer"
argument_list|)
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Floating-Point"
argument_list|)
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|combo
argument_list|)
argument_list|,
name|jsvals
operator|.
name|dct
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|combo
argument_list|,
literal|3
argument_list|,
literal|6
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
name|GTK_FILL
operator||
name|GTK_EXPAND
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|combo
argument_list|)
expr_stmt|;
name|gtk_label_set_mnemonic_widget
argument_list|(
name|GTK_LABEL
argument_list|(
name|label
argument_list|)
argument_list|,
name|combo
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|combo
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_combo_box_get_active
argument_list|)
argument_list|,
operator|&
name|jsvals
operator|.
name|dct
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|combo
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|make_preview
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Comment"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|scrolled_window
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_shadow_type
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|scrolled_window
argument_list|,
literal|250
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|scrolled_window
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|scrolled_window
argument_list|)
expr_stmt|;
name|pg
operator|.
name|text_buffer
operator|=
name|text_buffer
operator|=
name|gtk_text_buffer_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|image_comment
condition|)
name|gtk_text_buffer_set_text
argument_list|(
name|text_buffer
argument_list|,
name|image_comment
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|text_view
operator|=
name|gtk_text_view_new_with_buffer
argument_list|(
name|text_buffer
argument_list|)
expr_stmt|;
name|gtk_text_view_set_wrap_mode
argument_list|(
name|GTK_TEXT_VIEW
argument_list|(
name|text_view
argument_list|)
argument_list|,
name|GTK_WRAP_WORD
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|scrolled_window
argument_list|)
argument_list|,
name|text_view
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|text_view
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|text_buffer
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gimp_export_dialog_get_content_area
argument_list|(
name|dialog
argument_list|)
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|tabledefaults
operator|=
name|gtk_table_new
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|tabledefaults
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|tabledefaults
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|tabledefaults
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Load Defaults"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|tabledefaults
argument_list|)
argument_list|,
name|button
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|load_gui_defaults
argument_list|)
argument_list|,
operator|&
name|pg
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"Sa_ve Defaults"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|tabledefaults
argument_list|)
argument_list|,
name|button
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect_swapped
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|save_defaults
argument_list|)
argument_list|,
operator|&
name|pg
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|make_preview
argument_list|()
expr_stmt|;
name|pg
operator|.
name|run
operator|=
name|FALSE
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
name|destroy_preview
argument_list|()
expr_stmt|;
return|return
name|pg
operator|.
name|run
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|save_dialog_response (GtkWidget * widget,gint response_id,gpointer data)
name|save_dialog_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|JpegSaveGui
modifier|*
name|pg
init|=
name|data
decl_stmt|;
name|GtkTextIter
name|start_iter
decl_stmt|;
name|GtkTextIter
name|end_iter
decl_stmt|;
switch|switch
condition|(
name|response_id
condition|)
block|{
case|case
name|GTK_RESPONSE_OK
case|:
name|gtk_text_buffer_get_bounds
argument_list|(
name|pg
operator|->
name|text_buffer
argument_list|,
operator|&
name|start_iter
argument_list|,
operator|&
name|end_iter
argument_list|)
expr_stmt|;
name|image_comment
operator|=
name|gtk_text_buffer_get_text
argument_list|(
name|pg
operator|->
name|text_buffer
argument_list|,
operator|&
name|start_iter
argument_list|,
operator|&
name|end_iter
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pg
operator|->
name|run
operator|=
name|TRUE
expr_stmt|;
comment|/* fallthrough */
default|default:
name|gtk_widget_destroy
argument_list|(
name|widget
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
DECL|function|load_save_defaults (void)
name|load_save_defaults
parameter_list|(
name|void
parameter_list|)
block|{
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|gchar
modifier|*
name|def_str
decl_stmt|;
name|JpegSaveVals
name|tmpvals
decl_stmt|;
name|gint
name|num_fields
decl_stmt|;
name|gint
name|subsampling
decl_stmt|;
name|jsvals
operator|.
name|quality
operator|=
name|DEFAULT_QUALITY
expr_stmt|;
name|jsvals
operator|.
name|smoothing
operator|=
name|DEFAULT_SMOOTHING
expr_stmt|;
name|jsvals
operator|.
name|optimize
operator|=
name|DEFAULT_OPTIMIZE
expr_stmt|;
name|jsvals
operator|.
name|progressive
operator|=
name|DEFAULT_PROGRESSIVE
expr_stmt|;
name|jsvals
operator|.
name|baseline
operator|=
name|DEFAULT_BASELINE
expr_stmt|;
name|jsvals
operator|.
name|subsmp
operator|=
name|DEFAULT_SUBSMP
expr_stmt|;
name|jsvals
operator|.
name|restart
operator|=
name|DEFAULT_RESTART
expr_stmt|;
name|jsvals
operator|.
name|dct
operator|=
name|DEFAULT_DCT
expr_stmt|;
name|jsvals
operator|.
name|preview
operator|=
name|DEFAULT_PREVIEW
expr_stmt|;
name|jsvals
operator|.
name|save_exif
operator|=
name|DEFAULT_EXIF
expr_stmt|;
name|jsvals
operator|.
name|save_thumbnail
operator|=
name|DEFAULT_THUMBNAIL
expr_stmt|;
name|jsvals
operator|.
name|save_xmp
operator|=
name|DEFAULT_XMP
expr_stmt|;
name|jsvals
operator|.
name|use_orig_quality
operator|=
name|DEFAULT_USE_ORIG_QUALITY
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_EXIF
if|if
condition|(
name|exif_data
operator|&&
operator|(
name|exif_data
operator|->
name|data
operator|)
condition|)
name|jsvals
operator|.
name|save_thumbnail
operator|=
name|TRUE
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_EXIF */
name|parasite
operator|=
name|gimp_get_parasite
argument_list|(
name|JPEG_DEFAULTS_PARASITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parasite
condition|)
return|return;
name|def_str
operator|=
name|g_strndup
argument_list|(
name|gimp_parasite_data
argument_list|(
name|parasite
argument_list|)
argument_list|,
name|gimp_parasite_data_size
argument_list|(
name|parasite
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|num_fields
operator|=
name|sscanf
argument_list|(
name|def_str
argument_list|,
literal|"%lf %lf %d %d %d %d %d %d %d %d %d %d"
argument_list|,
operator|&
name|tmpvals
operator|.
name|quality
argument_list|,
operator|&
name|tmpvals
operator|.
name|smoothing
argument_list|,
operator|&
name|tmpvals
operator|.
name|optimize
argument_list|,
operator|&
name|tmpvals
operator|.
name|progressive
argument_list|,
operator|&
name|subsampling
argument_list|,
operator|&
name|tmpvals
operator|.
name|baseline
argument_list|,
operator|&
name|tmpvals
operator|.
name|restart
argument_list|,
operator|&
name|tmpvals
operator|.
name|dct
argument_list|,
operator|&
name|tmpvals
operator|.
name|preview
argument_list|,
operator|&
name|tmpvals
operator|.
name|save_exif
argument_list|,
operator|&
name|tmpvals
operator|.
name|save_thumbnail
argument_list|,
operator|&
name|tmpvals
operator|.
name|save_xmp
argument_list|)
expr_stmt|;
name|tmpvals
operator|.
name|subsmp
operator|=
name|subsampling
expr_stmt|;
if|if
condition|(
name|num_fields
operator|==
literal|12
condition|)
name|memcpy
argument_list|(
operator|&
name|jsvals
argument_list|,
operator|&
name|tmpvals
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpvals
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|def_str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|save_defaults (void)
name|save_defaults
parameter_list|(
name|void
parameter_list|)
block|{
name|GimpParasite
modifier|*
name|parasite
decl_stmt|;
name|gchar
modifier|*
name|def_str
decl_stmt|;
name|def_str
operator|=
name|g_strdup_printf
argument_list|(
literal|"%lf %lf %d %d %d %d %d %d %d %d %d %d"
argument_list|,
name|jsvals
operator|.
name|quality
argument_list|,
name|jsvals
operator|.
name|smoothing
argument_list|,
name|jsvals
operator|.
name|optimize
argument_list|,
name|jsvals
operator|.
name|progressive
argument_list|,
operator|(
name|gint
operator|)
name|jsvals
operator|.
name|subsmp
argument_list|,
name|jsvals
operator|.
name|baseline
argument_list|,
name|jsvals
operator|.
name|restart
argument_list|,
name|jsvals
operator|.
name|dct
argument_list|,
name|jsvals
operator|.
name|preview
argument_list|,
name|jsvals
operator|.
name|save_exif
argument_list|,
name|jsvals
operator|.
name|save_thumbnail
argument_list|,
name|jsvals
operator|.
name|save_xmp
argument_list|)
expr_stmt|;
name|parasite
operator|=
name|gimp_parasite_new
argument_list|(
name|JPEG_DEFAULTS_PARASITE
argument_list|,
name|GIMP_PARASITE_PERSISTENT
argument_list|,
name|strlen
argument_list|(
name|def_str
argument_list|)
argument_list|,
name|def_str
argument_list|)
expr_stmt|;
name|gimp_attach_parasite
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|gimp_parasite_free
argument_list|(
name|parasite
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|def_str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|load_gui_defaults (JpegSaveGui * pg)
name|load_gui_defaults
parameter_list|(
name|JpegSaveGui
modifier|*
name|pg
parameter_list|)
block|{
name|GtkAdjustment
modifier|*
name|restart_markers
decl_stmt|;
name|load_save_defaults
argument_list|()
expr_stmt|;
DECL|macro|SET_ACTIVE_BTTN (field)
define|#
directive|define
name|SET_ACTIVE_BTTN
parameter_list|(
name|field
parameter_list|)
define|\
value|gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (pg->field), jsvals.field)
name|SET_ACTIVE_BTTN
argument_list|(
name|optimize
argument_list|)
expr_stmt|;
name|SET_ACTIVE_BTTN
argument_list|(
name|progressive
argument_list|)
expr_stmt|;
name|SET_ACTIVE_BTTN
argument_list|(
name|use_orig_quality
argument_list|)
expr_stmt|;
name|SET_ACTIVE_BTTN
argument_list|(
name|preview
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_EXIF
name|SET_ACTIVE_BTTN
argument_list|(
name|save_exif
argument_list|)
expr_stmt|;
name|SET_ACTIVE_BTTN
argument_list|(
name|save_thumbnail
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SET_ACTIVE_BTTN
argument_list|(
name|save_xmp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SET_ACTIVE_BTTN
comment|/*spin button stuff*/
name|g_signal_handler_block
argument_list|(
name|pg
operator|->
name|use_restart_markers
argument_list|,
name|pg
operator|->
name|handler_id_restart
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|pg
operator|->
name|use_restart_markers
argument_list|)
argument_list|,
name|jsvals
operator|.
name|restart
argument_list|)
expr_stmt|;
name|restart_markers
operator|=
name|GTK_ADJUSTMENT
argument_list|(
name|pg
operator|->
name|scale_data
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|restart_markers
argument_list|,
name|jsvals
operator|.
name|restart
argument_list|)
expr_stmt|;
name|g_signal_handler_unblock
argument_list|(
name|pg
operator|->
name|use_restart_markers
argument_list|,
name|pg
operator|->
name|handler_id_restart
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|pg
operator|->
name|quality
argument_list|)
argument_list|,
name|jsvals
operator|.
name|quality
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|pg
operator|->
name|smoothing
argument_list|)
argument_list|,
name|jsvals
operator|.
name|smoothing
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_drawable_is_rgb
argument_list|(
name|drawable_ID_global
argument_list|)
condition|)
block|{
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|pg
operator|->
name|subsmp
argument_list|)
argument_list|,
name|jsvals
operator|.
name|subsmp
argument_list|)
expr_stmt|;
block|}
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|pg
operator|->
name|dct
argument_list|)
argument_list|,
name|jsvals
operator|.
name|dct
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|save_restart_update (GtkAdjustment * adjustment,GtkWidget * toggle)
name|save_restart_update
parameter_list|(
name|GtkAdjustment
modifier|*
name|adjustment
parameter_list|,
name|GtkWidget
modifier|*
name|toggle
parameter_list|)
block|{
if|if
condition|(
name|gtk_toggle_button_get_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|)
condition|)
name|jsvals
operator|.
name|restart
operator|=
name|gtk_adjustment_get_value
argument_list|(
name|adjustment
argument_list|)
expr_stmt|;
else|else
name|jsvals
operator|.
name|restart
operator|=
literal|0
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|restart_markers_label
argument_list|,
name|jsvals
operator|.
name|restart
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|restart_markers_scale
argument_list|,
name|jsvals
operator|.
name|restart
argument_list|)
expr_stmt|;
name|make_preview
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|subsampling_changed (GtkWidget * combo,GtkObject * entry)
name|subsampling_changed
parameter_list|(
name|GtkWidget
modifier|*
name|combo
parameter_list|,
name|GtkObject
modifier|*
name|entry
parameter_list|)
block|{
name|gint
name|value
decl_stmt|;
name|gimp_int_combo_box_get_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|combo
argument_list|)
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
name|jsvals
operator|.
name|subsmp
operator|=
name|value
expr_stmt|;
comment|/*  smoothing is not supported with nonstandard sampling ratios  */
name|gimp_scale_entry_set_sensitive
argument_list|(
name|entry
argument_list|,
name|jsvals
operator|.
name|subsmp
operator|!=
name|JPEG_SUPSAMPLING_2x1_1x1_1x1
operator|&&
name|jsvals
operator|.
name|subsmp
operator|!=
name|JPEG_SUPSAMPLING_1x2_1x1_1x1
argument_list|)
expr_stmt|;
name|make_preview
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|quality_changed (GtkObject * scale_entry,GtkWidget * toggle)
name|quality_changed
parameter_list|(
name|GtkObject
modifier|*
name|scale_entry
parameter_list|,
name|GtkWidget
modifier|*
name|toggle
parameter_list|)
block|{
if|if
condition|(
name|jsvals
operator|.
name|use_orig_quality
condition|)
block|{
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|use_orig_qual_changed (GtkWidget * toggle,GtkObject * scale_entry)
name|use_orig_qual_changed
parameter_list|(
name|GtkWidget
modifier|*
name|toggle
parameter_list|,
name|GtkObject
modifier|*
name|scale_entry
parameter_list|)
block|{
if|if
condition|(
name|jsvals
operator|.
name|use_orig_quality
operator|&&
name|orig_quality
operator|>
literal|0
condition|)
block|{
name|g_signal_handlers_block_by_func
argument_list|(
name|scale_entry
argument_list|,
name|quality_changed
argument_list|,
name|toggle
argument_list|)
expr_stmt|;
name|gtk_adjustment_set_value
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|scale_entry
argument_list|)
argument_list|,
name|orig_quality
argument_list|)
expr_stmt|;
name|g_signal_handlers_unblock_by_func
argument_list|(
name|scale_entry
argument_list|,
name|quality_changed
argument_list|,
name|toggle
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|use_orig_qual_changed2 (GtkWidget * toggle,GtkWidget * combo)
name|use_orig_qual_changed2
parameter_list|(
name|GtkWidget
modifier|*
name|toggle
parameter_list|,
name|GtkWidget
modifier|*
name|combo
parameter_list|)
block|{
comment|/* the test is (orig_quality> 0), not (orig_subsmp> 0) - this is normal */
if|if
condition|(
name|jsvals
operator|.
name|use_orig_quality
operator|&&
name|orig_quality
operator|>
literal|0
condition|)
block|{
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|combo
argument_list|)
argument_list|,
name|orig_subsmp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_EXIF
end_ifdef

begin_decl_stmt
DECL|variable|tbuffer
specifier|static
name|guchar
modifier|*
name|tbuffer
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tbuffer2
specifier|static
name|guchar
modifier|*
name|tbuffer2
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tbuffer_count
specifier|static
name|gint
name|tbuffer_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2afb39080308
block|{
DECL|member|pub
name|struct
name|jpeg_destination_mgr
name|pub
decl_stmt|;
comment|/* public fields */
DECL|member|buffer
name|guchar
modifier|*
name|buffer
decl_stmt|;
DECL|member|size
name|gint
name|size
decl_stmt|;
DECL|typedef|my_destination_mgr
block|}
name|my_destination_mgr
typedef|;
end_typedef

begin_typedef
DECL|typedef|my_dest_ptr
typedef|typedef
name|my_destination_mgr
modifier|*
name|my_dest_ptr
typedef|;
end_typedef

begin_function
specifier|static
name|void
DECL|function|init_destination (j_compress_ptr cinfo)
name|init_destination
parameter_list|(
name|j_compress_ptr
name|cinfo
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|gboolean
DECL|function|empty_output_buffer (j_compress_ptr cinfo)
name|empty_output_buffer
parameter_list|(
name|j_compress_ptr
name|cinfo
parameter_list|)
block|{
name|my_dest_ptr
name|dest
init|=
operator|(
name|my_dest_ptr
operator|)
name|cinfo
operator|->
name|dest
decl_stmt|;
name|tbuffer_count
operator|=
name|tbuffer_count
operator|+
literal|16384
expr_stmt|;
name|tbuffer
operator|=
name|g_renew
argument_list|(
name|guchar
argument_list|,
name|tbuffer
argument_list|,
name|tbuffer_count
argument_list|)
expr_stmt|;
name|g_memmove
argument_list|(
name|tbuffer
operator|+
name|tbuffer_count
operator|-
literal|16384
argument_list|,
name|tbuffer2
argument_list|,
literal|16384
argument_list|)
expr_stmt|;
name|dest
operator|->
name|pub
operator|.
name|next_output_byte
operator|=
name|tbuffer2
expr_stmt|;
name|dest
operator|->
name|pub
operator|.
name|free_in_buffer
operator|=
literal|16384
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|term_destination (j_compress_ptr cinfo)
name|term_destination
parameter_list|(
name|j_compress_ptr
name|cinfo
parameter_list|)
block|{
name|my_dest_ptr
name|dest
init|=
operator|(
name|my_dest_ptr
operator|)
name|cinfo
operator|->
name|dest
decl_stmt|;
name|tbuffer_count
operator|=
operator|(
name|tbuffer_count
operator|+
literal|16384
operator|)
operator|-
operator|(
name|dest
operator|->
name|pub
operator|.
name|free_in_buffer
operator|)
expr_stmt|;
name|tbuffer
operator|=
name|g_renew
argument_list|(
name|guchar
argument_list|,
name|tbuffer
argument_list|,
name|tbuffer_count
argument_list|)
expr_stmt|;
name|g_memmove
argument_list|(
name|tbuffer
operator|+
name|tbuffer_count
operator|-
operator|(
literal|16384
operator|-
name|dest
operator|->
name|pub
operator|.
name|free_in_buffer
operator|)
argument_list|,
name|tbuffer2
argument_list|,
literal|16384
operator|-
name|dest
operator|->
name|pub
operator|.
name|free_in_buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|create_thumbnail (gint32 image_ID,gint32 drawable_ID,gdouble quality,guchar ** thumbnail_buffer)
name|create_thumbnail
parameter_list|(
name|gint32
name|image_ID
parameter_list|,
name|gint32
name|drawable_ID
parameter_list|,
name|gdouble
name|quality
parameter_list|,
name|guchar
modifier|*
modifier|*
name|thumbnail_buffer
parameter_list|)
block|{
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
name|gint
name|req_width
decl_stmt|,
name|req_height
decl_stmt|,
name|bpp
decl_stmt|,
name|rbpp
decl_stmt|;
name|guchar
modifier|*
name|thumbnail_data
init|=
name|NULL
decl_stmt|;
name|struct
name|jpeg_compress_struct
name|cinfo
decl_stmt|;
name|struct
name|my_error_mgr
name|jerr
decl_stmt|;
name|my_dest_ptr
name|dest
decl_stmt|;
name|JSAMPROW
name|scanline
index|[
literal|1
index|]
decl_stmt|;
name|guchar
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|drawable_ID
argument_list|)
expr_stmt|;
name|req_width
operator|=
literal|196
expr_stmt|;
name|req_height
operator|=
literal|196
expr_stmt|;
if|if
condition|(
name|MIN
argument_list|(
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|)
operator|<
literal|196
condition|)
name|req_width
operator|=
name|req_height
operator|=
name|MIN
argument_list|(
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|)
expr_stmt|;
name|thumbnail_data
operator|=
name|gimp_drawable_get_thumbnail_data
argument_list|(
name|drawable_ID
argument_list|,
operator|&
name|req_width
argument_list|,
operator|&
name|req_height
argument_list|,
operator|&
name|bpp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|thumbnail_data
condition|)
return|return
literal|0
return|;
name|rbpp
operator|=
name|bpp
expr_stmt|;
if|if
condition|(
operator|(
name|bpp
operator|==
literal|2
operator|)
operator|||
operator|(
name|bpp
operator|==
literal|4
operator|)
condition|)
block|{
name|rbpp
operator|=
name|bpp
operator|-
literal|1
expr_stmt|;
block|}
name|buf
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|req_width
operator|*
name|bpp
argument_list|)
expr_stmt|;
name|tbuffer2
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
literal|16384
argument_list|)
expr_stmt|;
name|tbuffer_count
operator|=
literal|0
expr_stmt|;
name|cinfo
operator|.
name|err
operator|=
name|jpeg_std_error
argument_list|(
operator|&
name|jerr
operator|.
name|pub
argument_list|)
expr_stmt|;
name|jerr
operator|.
name|pub
operator|.
name|error_exit
operator|=
name|my_error_exit
expr_stmt|;
comment|/* Establish the setjmp return context for my_error_exit to use. */
if|if
condition|(
name|setjmp
argument_list|(
name|jerr
operator|.
name|setjmp_buffer
argument_list|)
condition|)
block|{
comment|/* If we get here, the JPEG code has signaled an error.        * We need to clean up the JPEG object, free memory, and return.        */
name|jpeg_destroy_compress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|thumbnail_data
condition|)
block|{
name|g_free
argument_list|(
name|thumbnail_data
argument_list|)
expr_stmt|;
name|thumbnail_data
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|buf
condition|)
block|{
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|tbuffer2
condition|)
block|{
name|g_free
argument_list|(
name|tbuffer2
argument_list|)
expr_stmt|;
name|tbuffer2
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|drawable
condition|)
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Now we can initialize the JPEG compression object. */
name|jpeg_create_compress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|cinfo
operator|.
name|dest
operator|==
name|NULL
condition|)
name|cinfo
operator|.
name|dest
operator|=
operator|(
expr|struct
name|jpeg_destination_mgr
operator|*
operator|)
call|(
modifier|*
name|cinfo
operator|.
name|mem
operator|->
name|alloc_small
call|)
argument_list|(
operator|(
name|j_common_ptr
operator|)
operator|&
name|cinfo
argument_list|,
name|JPOOL_PERMANENT
argument_list|,
sizeof|sizeof
argument_list|(
name|my_destination_mgr
argument_list|)
argument_list|)
expr_stmt|;
name|dest
operator|=
operator|(
name|my_dest_ptr
operator|)
name|cinfo
operator|.
name|dest
expr_stmt|;
name|dest
operator|->
name|pub
operator|.
name|init_destination
operator|=
name|init_destination
expr_stmt|;
name|dest
operator|->
name|pub
operator|.
name|empty_output_buffer
operator|=
name|empty_output_buffer
expr_stmt|;
name|dest
operator|->
name|pub
operator|.
name|term_destination
operator|=
name|term_destination
expr_stmt|;
name|dest
operator|->
name|pub
operator|.
name|next_output_byte
operator|=
name|tbuffer2
expr_stmt|;
name|dest
operator|->
name|pub
operator|.
name|free_in_buffer
operator|=
literal|16384
expr_stmt|;
name|dest
operator|->
name|buffer
operator|=
name|tbuffer2
expr_stmt|;
name|dest
operator|->
name|size
operator|=
literal|16384
expr_stmt|;
name|cinfo
operator|.
name|input_components
operator|=
name|rbpp
expr_stmt|;
name|cinfo
operator|.
name|image_width
operator|=
name|req_width
expr_stmt|;
name|cinfo
operator|.
name|image_height
operator|=
name|req_height
expr_stmt|;
comment|/* colorspace of input image */
name|cinfo
operator|.
name|in_color_space
operator|=
operator|(
name|rbpp
operator|==
literal|3
operator|)
condition|?
name|JCS_RGB
else|:
name|JCS_GRAYSCALE
expr_stmt|;
comment|/* Now use the library's routine to set default compression parameters.    * (You must set at least cinfo.in_color_space before calling this,    * since the defaults depend on the source color space.)    */
name|jpeg_set_defaults
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
name|jpeg_set_quality
argument_list|(
operator|&
name|cinfo
argument_list|,
call|(
name|gint
call|)
argument_list|(
name|quality
operator|+
literal|0.5
argument_list|)
argument_list|,
name|jsvals
operator|.
name|baseline
argument_list|)
expr_stmt|;
comment|/* Step 4: Start compressor */
comment|/* TRUE ensures that we will write a complete interchange-JPEG file.    * Pass TRUE unless you are very sure of what you're doing.    */
name|jpeg_start_compress
argument_list|(
operator|&
name|cinfo
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
while|while
condition|(
name|cinfo
operator|.
name|next_scanline
operator|<
operator|(
name|unsigned
name|int
operator|)
name|req_height
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|req_width
condition|;
name|i
operator|++
control|)
block|{
name|buf
index|[
operator|(
name|i
operator|*
name|rbpp
operator|)
operator|+
literal|0
index|]
operator|=
name|thumbnail_data
index|[
operator|(
name|cinfo
operator|.
name|next_scanline
operator|*
name|req_width
operator|*
name|bpp
operator|)
operator|+
operator|(
name|i
operator|*
name|bpp
operator|)
operator|+
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|rbpp
operator|==
literal|3
condition|)
block|{
name|buf
index|[
operator|(
name|i
operator|*
name|rbpp
operator|)
operator|+
literal|1
index|]
operator|=
name|thumbnail_data
index|[
operator|(
name|cinfo
operator|.
name|next_scanline
operator|*
name|req_width
operator|*
name|bpp
operator|)
operator|+
operator|(
name|i
operator|*
name|bpp
operator|)
operator|+
literal|1
index|]
expr_stmt|;
name|buf
index|[
operator|(
name|i
operator|*
name|rbpp
operator|)
operator|+
literal|2
index|]
operator|=
name|thumbnail_data
index|[
operator|(
name|cinfo
operator|.
name|next_scanline
operator|*
name|req_width
operator|*
name|bpp
operator|)
operator|+
operator|(
name|i
operator|*
name|bpp
operator|)
operator|+
literal|2
index|]
expr_stmt|;
block|}
block|}
name|scanline
index|[
literal|0
index|]
operator|=
name|buf
expr_stmt|;
name|jpeg_write_scanlines
argument_list|(
operator|&
name|cinfo
argument_list|,
name|scanline
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Step 6: Finish compression */
name|jpeg_finish_compress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* Step 7: release JPEG compression object */
comment|/* This is an important step since it will release a good deal of memory. */
name|jpeg_destroy_compress
argument_list|(
operator|&
name|cinfo
argument_list|)
expr_stmt|;
comment|/* And we're done! */
if|if
condition|(
name|thumbnail_data
condition|)
block|{
name|g_free
argument_list|(
name|thumbnail_data
argument_list|)
expr_stmt|;
name|thumbnail_data
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|buf
condition|)
block|{
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|drawable
condition|)
block|{
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|drawable
operator|=
name|NULL
expr_stmt|;
block|}
operator|*
name|thumbnail_buffer
operator|=
name|tbuffer
expr_stmt|;
return|return
name|tbuffer_count
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_EXIF */
end_comment

end_unit

