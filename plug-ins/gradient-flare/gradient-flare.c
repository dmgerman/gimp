begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * GFlare plug-in -- lense flare effect by using custom gradients  * Copyright (C) 1997 Eiichi Takamori<taka@ma1.sekyou.ne.jp>  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  *  *  * A fair proportion of this code was taken from GIMP& Script-fu  * copyrighted by Spencer Kimball and Peter Mattis, and from Gradient  * Editor copyrighted by Federico Mena Quintero. (See copyright notice  * below) Thanks for senior GIMP hackers!!  *  * GIMP - The GNU Image Manipulation Program  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * Gradient editor module copyight (C) 1996-1997 Federico Mena Quintero  * federico@nuclecu.unam.mx  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<glib-object.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_comment
comment|/* #define DEBUG */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
DECL|macro|DEBUG_PRINT (X)
define|#
directive|define
name|DEBUG_PRINT
parameter_list|(
name|X
parameter_list|)
value|g_print X
end_define

begin_else
else|#
directive|else
end_else

begin_define
DECL|macro|DEBUG_PRINT (X)
define|#
directive|define
name|DEBUG_PRINT
parameter_list|(
name|X
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
DECL|macro|LUMINOSITY (PIX)
define|#
directive|define
name|LUMINOSITY
parameter_list|(
name|PIX
parameter_list|)
value|(GIMP_RGB_LUMINANCE (PIX[0], PIX[1], PIX[2]) + 0.5)
end_define

begin_define
DECL|macro|RESPONSE_RESCAN
define|#
directive|define
name|RESPONSE_RESCAN
value|1
end_define

begin_define
DECL|macro|PLUG_IN_PROC
define|#
directive|define
name|PLUG_IN_PROC
value|"plug-in-gflare"
end_define

begin_define
DECL|macro|PLUG_IN_BINARY
define|#
directive|define
name|PLUG_IN_BINARY
value|"gradient-flare"
end_define

begin_define
DECL|macro|GRADIENT_NAME_MAX
define|#
directive|define
name|GRADIENT_NAME_MAX
value|256
end_define

begin_define
DECL|macro|GRADIENT_RESOLUTION
define|#
directive|define
name|GRADIENT_RESOLUTION
value|360
end_define

begin_define
DECL|macro|GFLARE_NAME_MAX
define|#
directive|define
name|GFLARE_NAME_MAX
value|256
end_define

begin_define
DECL|macro|GFLARE_FILE_HEADER
define|#
directive|define
name|GFLARE_FILE_HEADER
value|"GIMP GFlare 0.25\n"
end_define

begin_define
DECL|macro|SFLARE_NUM
define|#
directive|define
name|SFLARE_NUM
value|30
end_define

begin_define
DECL|macro|DLG_PREVIEW_WIDTH
define|#
directive|define
name|DLG_PREVIEW_WIDTH
value|256
end_define

begin_define
DECL|macro|DLG_PREVIEW_HEIGHT
define|#
directive|define
name|DLG_PREVIEW_HEIGHT
value|256
end_define

begin_define
DECL|macro|DLG_PREVIEW_MASK
define|#
directive|define
name|DLG_PREVIEW_MASK
value|GDK_EXPOSURE_MASK | \                             GDK_BUTTON_PRESS_MASK
end_define

begin_define
DECL|macro|DLG_LISTBOX_WIDTH
define|#
directive|define
name|DLG_LISTBOX_WIDTH
value|80
end_define

begin_define
DECL|macro|DLG_LISTBOX_HEIGHT
define|#
directive|define
name|DLG_LISTBOX_HEIGHT
value|40
end_define

begin_define
DECL|macro|ED_PREVIEW_WIDTH
define|#
directive|define
name|ED_PREVIEW_WIDTH
value|256
end_define

begin_define
DECL|macro|ED_PREVIEW_HEIGHT
define|#
directive|define
name|ED_PREVIEW_HEIGHT
value|256
end_define

begin_define
DECL|macro|GM_PREVIEW_WIDTH
define|#
directive|define
name|GM_PREVIEW_WIDTH
value|80
end_define

begin_define
DECL|macro|GM_PREVIEW_HEIGHT
define|#
directive|define
name|GM_PREVIEW_HEIGHT
value|16
end_define

begin_define
DECL|macro|SCALE_WIDTH
define|#
directive|define
name|SCALE_WIDTH
value|80
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|OPAQUE
end_ifndef

begin_define
DECL|macro|OPAQUE
define|#
directive|define
name|OPAQUE
value|255
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
DECL|macro|GRAY50
define|#
directive|define
name|GRAY50
value|128
end_define

begin_define
DECL|macro|GRADIENT_CACHE_SIZE
define|#
directive|define
name|GRADIENT_CACHE_SIZE
value|32
end_define

begin_define
DECL|macro|CALC_GLOW
define|#
directive|define
name|CALC_GLOW
value|0x01
end_define

begin_define
DECL|macro|CALC_RAYS
define|#
directive|define
name|CALC_RAYS
value|0x02
end_define

begin_define
DECL|macro|CALC_SFLARE
define|#
directive|define
name|CALC_SFLARE
value|0x04
end_define

begin_typedef
DECL|typedef|Preview
typedef|typedef
name|struct
name|_Preview
name|Preview
typedef|;
end_typedef

begin_typedef
DECL|typedef|GradientName
typedef|typedef
name|gchar
name|GradientName
index|[
name|GRADIENT_NAME_MAX
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
DECL|enum|__anon2b9257990103
block|{
DECL|enumerator|GF_NORMAL
name|GF_NORMAL
init|=
literal|0
block|,
DECL|enumerator|GF_ADDITION
name|GF_ADDITION
block|,
DECL|enumerator|GF_OVERLAY
name|GF_OVERLAY
block|,
DECL|enumerator|GF_SCREEN
name|GF_SCREEN
block|,
DECL|enumerator|GF_NUM_MODES
name|GF_NUM_MODES
DECL|typedef|GFlareMode
block|}
name|GFlareMode
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
DECL|enum|__anon2b9257990203
block|{
DECL|enumerator|GF_CIRCLE
name|GF_CIRCLE
init|=
literal|0
block|,
DECL|enumerator|GF_POLYGON
name|GF_POLYGON
block|,
DECL|enumerator|GF_NUM_SHAPES
name|GF_NUM_SHAPES
DECL|typedef|GFlareShape
block|}
name|GFlareShape
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990308
block|{
DECL|member|name
name|gchar
modifier|*
name|name
decl_stmt|;
DECL|member|filename
name|gchar
modifier|*
name|filename
decl_stmt|;
DECL|member|glow_opacity
name|gdouble
name|glow_opacity
decl_stmt|;
DECL|member|glow_mode
name|GFlareMode
name|glow_mode
decl_stmt|;
DECL|member|rays_opacity
name|gdouble
name|rays_opacity
decl_stmt|;
DECL|member|rays_mode
name|GFlareMode
name|rays_mode
decl_stmt|;
DECL|member|sflare_opacity
name|gdouble
name|sflare_opacity
decl_stmt|;
DECL|member|sflare_mode
name|GFlareMode
name|sflare_mode
decl_stmt|;
DECL|member|glow_radial
name|GradientName
name|glow_radial
decl_stmt|;
DECL|member|glow_angular
name|GradientName
name|glow_angular
decl_stmt|;
DECL|member|glow_angular_size
name|GradientName
name|glow_angular_size
decl_stmt|;
DECL|member|glow_size
name|gdouble
name|glow_size
decl_stmt|;
DECL|member|glow_rotation
name|gdouble
name|glow_rotation
decl_stmt|;
DECL|member|glow_hue
name|gdouble
name|glow_hue
decl_stmt|;
DECL|member|rays_radial
name|GradientName
name|rays_radial
decl_stmt|;
DECL|member|rays_angular
name|GradientName
name|rays_angular
decl_stmt|;
DECL|member|rays_angular_size
name|GradientName
name|rays_angular_size
decl_stmt|;
DECL|member|rays_size
name|gdouble
name|rays_size
decl_stmt|;
DECL|member|rays_rotation
name|gdouble
name|rays_rotation
decl_stmt|;
DECL|member|rays_hue
name|gdouble
name|rays_hue
decl_stmt|;
DECL|member|rays_nspikes
name|gint
name|rays_nspikes
decl_stmt|;
DECL|member|rays_thickness
name|gdouble
name|rays_thickness
decl_stmt|;
DECL|member|sflare_radial
name|GradientName
name|sflare_radial
decl_stmt|;
DECL|member|sflare_sizefac
name|GradientName
name|sflare_sizefac
decl_stmt|;
DECL|member|sflare_probability
name|GradientName
name|sflare_probability
decl_stmt|;
DECL|member|sflare_size
name|gdouble
name|sflare_size
decl_stmt|;
DECL|member|sflare_rotation
name|gdouble
name|sflare_rotation
decl_stmt|;
DECL|member|sflare_hue
name|gdouble
name|sflare_hue
decl_stmt|;
DECL|member|sflare_shape
name|GFlareShape
name|sflare_shape
decl_stmt|;
DECL|member|sflare_nverts
name|gint
name|sflare_nverts
decl_stmt|;
DECL|member|sflare_seed
name|guint32
name|sflare_seed
decl_stmt|;
DECL|member|random_seed
name|gboolean
name|random_seed
decl_stmt|;
DECL|typedef|GFlare
block|}
name|GFlare
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990408
block|{
DECL|member|fp
name|FILE
modifier|*
name|fp
decl_stmt|;
DECL|member|error
name|gint
name|error
decl_stmt|;
DECL|typedef|GFlareFile
block|}
name|GFlareFile
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
DECL|enum|__anon2b9257990503
block|{
DECL|enumerator|PAGE_SETTINGS
name|PAGE_SETTINGS
block|,
DECL|enumerator|PAGE_SELECTOR
name|PAGE_SELECTOR
block|,
DECL|enumerator|PAGE_GENERAL
name|PAGE_GENERAL
block|,
DECL|enumerator|PAGE_GLOW
name|PAGE_GLOW
block|,
DECL|enumerator|PAGE_RAYS
name|PAGE_RAYS
block|,
DECL|enumerator|PAGE_SFLARE
name|PAGE_SFLARE
DECL|typedef|PageNum
block|}
name|PageNum
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990608
block|{
DECL|member|init
name|gint
name|init
decl_stmt|;
DECL|member|gflare
name|GFlare
modifier|*
name|gflare
decl_stmt|;
DECL|member|shell
name|GtkWidget
modifier|*
name|shell
decl_stmt|;
DECL|member|preview
name|Preview
modifier|*
name|preview
decl_stmt|;
struct|struct
DECL|struct|__anon2b9257990708
block|{
DECL|member|x0
DECL|member|y0
DECL|member|x1
DECL|member|y1
name|gdouble
name|x0
decl_stmt|,
name|y0
decl_stmt|,
name|x1
decl_stmt|,
name|y1
decl_stmt|;
DECL|member|pwin
block|}
name|pwin
struct|;
DECL|member|update_preview
name|gboolean
name|update_preview
decl_stmt|;
DECL|member|notebook
name|GtkWidget
modifier|*
name|notebook
decl_stmt|;
DECL|member|sizeentry
name|GtkWidget
modifier|*
name|sizeentry
decl_stmt|;
DECL|member|asupsample_frame
name|GtkWidget
modifier|*
name|asupsample_frame
decl_stmt|;
DECL|member|selector_list
name|GtkListStore
modifier|*
name|selector_list
decl_stmt|;
DECL|member|selection
name|GtkTreeSelection
modifier|*
name|selection
decl_stmt|;
DECL|member|init_params_done
name|gint
name|init_params_done
decl_stmt|;
DECL|typedef|GFlareDialog
block|}
name|GFlareDialog
typedef|;
end_typedef

begin_typedef
DECL|typedef|GFlareEditorCallback
typedef|typedef
name|void
function_decl|(
modifier|*
name|GFlareEditorCallback
function_decl|)
parameter_list|(
name|gint
name|updated
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990808
block|{
DECL|member|init
name|gint
name|init
decl_stmt|;
DECL|member|run
name|gint
name|run
decl_stmt|;
DECL|member|callback
name|GFlareEditorCallback
name|callback
decl_stmt|;
DECL|member|calldata
name|gpointer
name|calldata
decl_stmt|;
DECL|member|target_gflare
name|GFlare
modifier|*
name|target_gflare
decl_stmt|;
DECL|member|gflare
name|GFlare
modifier|*
name|gflare
decl_stmt|;
DECL|member|shell
name|GtkWidget
modifier|*
name|shell
decl_stmt|;
DECL|member|preview
name|Preview
modifier|*
name|preview
decl_stmt|;
DECL|member|notebook
name|GtkWidget
modifier|*
name|notebook
decl_stmt|;
DECL|member|cur_page
name|PageNum
name|cur_page
decl_stmt|;
DECL|member|polygon_entry
name|GtkWidget
modifier|*
name|polygon_entry
decl_stmt|;
DECL|member|polygon_toggle
name|GtkWidget
modifier|*
name|polygon_toggle
decl_stmt|;
DECL|member|init_params_done
name|gint
name|init_params_done
decl_stmt|;
DECL|typedef|GFlareEditor
block|}
name|GFlareEditor
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990908
block|{
DECL|member|x0
name|gdouble
name|x0
decl_stmt|;
DECL|member|y0
name|gdouble
name|y0
decl_stmt|;
DECL|member|x1
name|gdouble
name|x1
decl_stmt|;
DECL|member|y1
name|gdouble
name|y1
decl_stmt|;
DECL|typedef|CalcBounds
block|}
name|CalcBounds
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990a08
block|{
DECL|member|init
name|gint
name|init
decl_stmt|;
DECL|member|type
name|gint
name|type
decl_stmt|;
DECL|member|gflare
name|GFlare
modifier|*
name|gflare
decl_stmt|;
DECL|member|xcenter
name|gdouble
name|xcenter
decl_stmt|;
DECL|member|ycenter
name|gdouble
name|ycenter
decl_stmt|;
DECL|member|radius
name|gdouble
name|radius
decl_stmt|;
DECL|member|rotation
name|gdouble
name|rotation
decl_stmt|;
DECL|member|hue
name|gdouble
name|hue
decl_stmt|;
DECL|member|vangle
name|gdouble
name|vangle
decl_stmt|;
DECL|member|vlength
name|gdouble
name|vlength
decl_stmt|;
DECL|member|glow_opacity
name|gint
name|glow_opacity
decl_stmt|;
DECL|member|glow_bounds
name|CalcBounds
name|glow_bounds
decl_stmt|;
DECL|member|glow_radial
name|guchar
modifier|*
name|glow_radial
decl_stmt|;
DECL|member|glow_angular
name|guchar
modifier|*
name|glow_angular
decl_stmt|;
DECL|member|glow_angular_size
name|guchar
modifier|*
name|glow_angular_size
decl_stmt|;
DECL|member|glow_radius
name|gdouble
name|glow_radius
decl_stmt|;
DECL|member|glow_rotation
name|gdouble
name|glow_rotation
decl_stmt|;
DECL|member|rays_opacity
name|gint
name|rays_opacity
decl_stmt|;
DECL|member|rays_bounds
name|CalcBounds
name|rays_bounds
decl_stmt|;
DECL|member|rays_radial
name|guchar
modifier|*
name|rays_radial
decl_stmt|;
DECL|member|rays_angular
name|guchar
modifier|*
name|rays_angular
decl_stmt|;
DECL|member|rays_angular_size
name|guchar
modifier|*
name|rays_angular_size
decl_stmt|;
DECL|member|rays_radius
name|gdouble
name|rays_radius
decl_stmt|;
DECL|member|rays_rotation
name|gdouble
name|rays_rotation
decl_stmt|;
DECL|member|rays_spike_mod
name|gdouble
name|rays_spike_mod
decl_stmt|;
DECL|member|rays_thinness
name|gdouble
name|rays_thinness
decl_stmt|;
DECL|member|sflare_opacity
name|gint
name|sflare_opacity
decl_stmt|;
DECL|member|sflare_list
name|GList
modifier|*
name|sflare_list
decl_stmt|;
DECL|member|sflare_radial
name|guchar
modifier|*
name|sflare_radial
decl_stmt|;
DECL|member|sflare_sizefac
name|guchar
modifier|*
name|sflare_sizefac
decl_stmt|;
DECL|member|sflare_probability
name|guchar
modifier|*
name|sflare_probability
decl_stmt|;
DECL|member|sflare_radius
name|gdouble
name|sflare_radius
decl_stmt|;
DECL|member|sflare_rotation
name|gdouble
name|sflare_rotation
decl_stmt|;
DECL|member|sflare_shape
name|GFlareShape
name|sflare_shape
decl_stmt|;
DECL|member|sflare_angle
name|gdouble
name|sflare_angle
decl_stmt|;
DECL|member|sflare_factor
name|gdouble
name|sflare_factor
decl_stmt|;
DECL|typedef|CalcParams
block|}
name|CalcParams
typedef|;
end_typedef

begin_comment
comment|/*  * What's the difference between (structure) CalcParams and GFlare ?  * well, radius and lengths are actual length for CalcParams where  * they are typically 0 to 100 for GFlares, and angles are G_PI based  * (radian) for CalcParams where they are degree for GFlares. et cetra.  * This is because convienience for dialog processing and for calculating.  * these conversion is taken place in calc init routines. see below.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990b08
block|{
DECL|member|xcenter
name|gdouble
name|xcenter
decl_stmt|;
DECL|member|ycenter
name|gdouble
name|ycenter
decl_stmt|;
DECL|member|radius
name|gdouble
name|radius
decl_stmt|;
DECL|member|bounds
name|CalcBounds
name|bounds
decl_stmt|;
DECL|typedef|CalcSFlare
block|}
name|CalcSFlare
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990c08
block|{
DECL|member|is_color
name|gint
name|is_color
decl_stmt|;
DECL|member|has_alpha
name|gint
name|has_alpha
decl_stmt|;
DECL|member|x1
DECL|member|y1
DECL|member|x2
DECL|member|y2
name|gint
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|;
comment|/* mask bounds */
DECL|member|tile_width
DECL|member|tile_height
name|gint
name|tile_width
decl_stmt|,
name|tile_height
decl_stmt|;
comment|/* these values don't belong to drawable, though. */
DECL|typedef|DrawableInfo
block|}
name|DrawableInfo
typedef|;
end_typedef

begin_typedef
DECL|typedef|GradientMenu
typedef|typedef
name|struct
name|_GradientMenu
name|GradientMenu
typedef|;
end_typedef

begin_typedef
DECL|typedef|GradientMenuCallback
typedef|typedef
name|void
function_decl|(
modifier|*
name|GradientMenuCallback
function_decl|)
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_typedef

begin_struct
DECL|struct|_GradientMenu
struct|struct
name|_GradientMenu
block|{
DECL|member|preview
name|GtkWidget
modifier|*
name|preview
decl_stmt|;
DECL|member|combo
name|GtkWidget
modifier|*
name|combo
decl_stmt|;
DECL|member|callback
name|GradientMenuCallback
name|callback
decl_stmt|;
DECL|member|callback_data
name|gpointer
name|callback_data
decl_stmt|;
DECL|member|gradient_name
name|GradientName
name|gradient_name
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
DECL|typedef|PreviewInitFunc
typedef|typedef
name|gint
function_decl|(
modifier|*
name|PreviewInitFunc
function_decl|)
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_typedef

begin_typedef
DECL|typedef|PreviewRenderFunc
typedef|typedef
name|void
function_decl|(
modifier|*
name|PreviewRenderFunc
function_decl|)
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_typedef

begin_typedef
DECL|typedef|PreviewDeinitFunc
typedef|typedef
name|void
function_decl|(
modifier|*
name|PreviewDeinitFunc
function_decl|)
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_typedef

begin_struct
DECL|struct|_Preview
struct|struct
name|_Preview
block|{
DECL|member|widget
name|GtkWidget
modifier|*
name|widget
decl_stmt|;
DECL|member|width
name|gint
name|width
decl_stmt|;
DECL|member|height
name|gint
name|height
decl_stmt|;
DECL|member|init_func
name|PreviewInitFunc
name|init_func
decl_stmt|;
DECL|member|init_data
name|gpointer
name|init_data
decl_stmt|;
DECL|member|render_func
name|PreviewRenderFunc
name|render_func
decl_stmt|;
DECL|member|render_data
name|gpointer
name|render_data
decl_stmt|;
DECL|member|deinit_func
name|PreviewDeinitFunc
name|deinit_func
decl_stmt|;
DECL|member|deinit_data
name|gpointer
name|deinit_data
decl_stmt|;
DECL|member|timeout_tag
name|guint
name|timeout_tag
decl_stmt|;
DECL|member|idle_tag
name|guint
name|idle_tag
decl_stmt|;
DECL|member|init_done
name|gint
name|init_done
decl_stmt|;
DECL|member|current_y
name|gint
name|current_y
decl_stmt|;
DECL|member|drawn_y
name|gint
name|drawn_y
decl_stmt|;
DECL|member|buffer
name|guchar
modifier|*
name|buffer
decl_stmt|;
DECL|member|full_image_buffer
name|guchar
modifier|*
name|full_image_buffer
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990d08
block|{
DECL|member|tag
name|gint
name|tag
decl_stmt|;
DECL|member|got_gradients
name|gint
name|got_gradients
decl_stmt|;
DECL|member|current_y
name|gint
name|current_y
decl_stmt|;
DECL|member|drawn_y
name|gint
name|drawn_y
decl_stmt|;
DECL|member|render_func
name|PreviewRenderFunc
name|render_func
decl_stmt|;
DECL|member|buffer
name|guchar
modifier|*
name|buffer
decl_stmt|;
DECL|typedef|PreviewIdle
block|}
name|PreviewIdle
typedef|;
end_typedef

begin_typedef
DECL|typedef|GradientCacheItem
typedef|typedef
name|struct
name|_GradientCacheItem
name|GradientCacheItem
typedef|;
end_typedef

begin_struct
DECL|struct|_GradientCacheItem
struct|struct
name|_GradientCacheItem
block|{
DECL|member|next
name|GradientCacheItem
modifier|*
name|next
decl_stmt|;
DECL|member|prev
name|GradientCacheItem
modifier|*
name|prev
decl_stmt|;
DECL|member|name
name|GradientName
name|name
decl_stmt|;
DECL|member|values
name|guchar
name|values
index|[
literal|4
operator|*
name|GRADIENT_RESOLUTION
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon2b9257990e08
block|{
DECL|member|xcenter
name|gint
name|xcenter
decl_stmt|;
DECL|member|ycenter
name|gint
name|ycenter
decl_stmt|;
DECL|member|radius
name|gdouble
name|radius
decl_stmt|;
DECL|member|rotation
name|gdouble
name|rotation
decl_stmt|;
DECL|member|hue
name|gdouble
name|hue
decl_stmt|;
DECL|member|vangle
name|gdouble
name|vangle
decl_stmt|;
DECL|member|vlength
name|gdouble
name|vlength
decl_stmt|;
DECL|member|use_asupsample
name|gint
name|use_asupsample
decl_stmt|;
DECL|member|asupsample_max_depth
name|gint
name|asupsample_max_depth
decl_stmt|;
DECL|member|asupsample_threshold
name|gdouble
name|asupsample_threshold
decl_stmt|;
DECL|member|gflare_name
name|gchar
name|gflare_name
index|[
name|GFLARE_NAME_MAX
index|]
decl_stmt|;
DECL|typedef|PluginValues
block|}
name|PluginValues
typedef|;
end_typedef

begin_typedef
DECL|typedef|QueryFunc
typedef|typedef
name|void
function_decl|(
modifier|*
name|QueryFunc
function_decl|)
parameter_list|(
name|GtkWidget
modifier|*
parameter_list|,
name|gpointer
parameter_list|,
name|gpointer
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|/***  ***  Global Functions Prototypes  **/
end_comment

begin_function_decl
specifier|static
name|void
name|plugin_query
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|plugin_run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GFlare
modifier|*
name|gflare_new_with_default
parameter_list|(
specifier|const
name|gchar
modifier|*
name|new_name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GFlare
modifier|*
name|gflare_dup
parameter_list|(
specifier|const
name|GFlare
modifier|*
name|src
parameter_list|,
specifier|const
name|gchar
modifier|*
name|new_name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_copy
parameter_list|(
name|GFlare
modifier|*
name|dest
parameter_list|,
specifier|const
name|GFlare
modifier|*
name|src
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GFlare
modifier|*
name|gflare_load
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_save
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_name_copy
parameter_list|(
name|gchar
modifier|*
name|dest
parameter_list|,
specifier|const
name|gchar
modifier|*
name|src
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|gflares_list_insert
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GFlare
modifier|*
name|gflares_list_lookup
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|gflares_list_index
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|gflares_list_remove
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflares_list_load_all
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflares_list_free_all
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_init_params
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|,
name|gint
name|calc_type
parameter_list|,
name|gdouble
name|xcenter
parameter_list|,
name|gdouble
name|ycenter
parameter_list|,
name|gdouble
name|radius
parameter_list|,
name|gdouble
name|rotation
parameter_list|,
name|gdouble
name|hue
parameter_list|,
name|gdouble
name|vangle
parameter_list|,
name|gdouble
name|vlength
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|calc_init_progress
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_deinit
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_glow_pix
parameter_list|(
name|guchar
modifier|*
name|dest_pix
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_rays_pix
parameter_list|(
name|guchar
modifier|*
name|dest_pix
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_sflare_pix
parameter_list|(
name|guchar
modifier|*
name|dest_pix
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|guchar
modifier|*
name|src_pix
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_gflare_pix
parameter_list|(
name|guchar
modifier|*
name|dest_pix
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|guchar
modifier|*
name|src_pix
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|dlg_run
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_preview_calc_window
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_preview_calc_window
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GtkWidget
modifier|*
name|ed_mode_menu_new
parameter_list|(
name|GFlareMode
modifier|*
name|mode_var
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Preview
modifier|*
name|preview_new
parameter_list|(
name|gint
name|width
parameter_list|,
name|gint
name|height
parameter_list|,
name|PreviewInitFunc
name|init_func
parameter_list|,
name|gpointer
name|init_data
parameter_list|,
name|PreviewRenderFunc
name|render_func
parameter_list|,
name|gpointer
name|render_data
parameter_list|,
name|PreviewDeinitFunc
name|deinit_func
parameter_list|,
name|gpointer
name|deinit_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_free
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_render_start
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_render_end
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|preview_rgba_to_rgb
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guchar
modifier|*
name|src
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_menu_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_menu_rescan
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GradientMenu
modifier|*
name|gradient_menu_new
parameter_list|(
name|GradientMenuCallback
name|callback
parameter_list|,
name|gpointer
name|callback_data
parameter_list|,
specifier|const
name|gchar
modifier|*
name|default_gradient_name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_name_copy
parameter_list|(
name|gchar
modifier|*
name|dest
parameter_list|,
specifier|const
name|gchar
modifier|*
name|src
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_name_encode
parameter_list|(
name|gchar
modifier|*
name|dest
parameter_list|,
specifier|const
name|gchar
modifier|*
name|src
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_name_decode
parameter_list|(
name|gchar
modifier|*
name|dest
parameter_list|,
specifier|const
name|gchar
modifier|*
name|src
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_free
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gchar
modifier|*
modifier|*
name|gradient_get_list
parameter_list|(
name|gint
modifier|*
name|num_gradients
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_get_values
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_cache_flush
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* *** INSERT-FILE-END *** */
end_comment

begin_comment
comment|/** ***     Variables **/
end_comment

begin_decl_stmt
DECL|variable|PLUG_IN_INFO
specifier|const
name|GimpPlugInInfo
name|PLUG_IN_INFO
init|=
block|{
name|NULL
block|,
comment|/* init_proc  */
name|NULL
block|,
comment|/* quit_proc  */
name|plugin_query
block|,
comment|/* query_proc */
name|plugin_run
block|,
comment|/* run_proc   */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|pvals
name|PluginValues
name|pvals
init|=
block|{
literal|128
block|,
comment|/* xcenter */
literal|128
block|,
comment|/* ycenter */
literal|100.0
block|,
comment|/* radius */
literal|0.0
block|,
comment|/* rotation */
literal|0.0
block|,
comment|/* hue */
literal|60.0
block|,
comment|/* vangle */
literal|400.0
block|,
comment|/* vlength */
name|FALSE
block|,
comment|/* use_asupsample */
literal|3
block|,
comment|/* asupsample_max_depth */
literal|0.2
block|,
comment|/* asupsample_threshold */
literal|"Default"
comment|/* gflare_name */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|default_gflare
name|GFlare
name|default_gflare
init|=
block|{
name|NULL
block|,
comment|/* name */
name|NULL
block|,
comment|/* filename */
literal|100
block|,
comment|/* glow_opacity */
name|GF_NORMAL
block|,
comment|/* glow_mode */
literal|100
block|,
comment|/* rays_opacity */
name|GF_NORMAL
block|,
comment|/* rays_mode */
literal|100
block|,
comment|/* sflare_opacity */
name|GF_NORMAL
block|,
comment|/* sflare_mode */
literal|"%red_grad"
block|,
comment|/* glow_radial */
literal|"%white"
block|,
comment|/* glow_angular */
literal|"%white"
block|,
comment|/* glow_angular_size */
literal|100.0
block|,
comment|/* glow_size */
literal|0.0
block|,
comment|/* glow_rotation */
literal|0.0
block|,
comment|/* glow_hue */
literal|"%white_grad"
block|,
comment|/* rays_radial */
literal|"%random"
block|,
comment|/* rays_angular */
literal|"%random"
block|,
comment|/* rays_angular_size */
literal|100.0
block|,
comment|/* rays_size */
literal|0.0
block|,
comment|/* rays_rotation */
literal|0.0
block|,
comment|/* rays_hue */
literal|40
block|,
comment|/* rays_nspikes */
literal|20.0
block|,
comment|/* rays_thickness */
literal|"%white_grad"
block|,
comment|/* sflare_radial */
literal|"%random"
block|,
comment|/* sflare_sizefac */
literal|"%random"
block|,
comment|/* sflare_probability */
literal|40.0
block|,
comment|/* sflare_size */
literal|0.0
block|,
comment|/* sflare_rotation */
literal|0.0
block|,
comment|/* sflare_hue */
name|GF_CIRCLE
block|,
comment|/* sflare_shape */
literal|6
block|,
comment|/* sflare_nverts */
literal|0
block|,
comment|/* sflare_seed */
name|TRUE
block|,
comment|/* random_seed */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* These are keywords to be written to disk files specifying flares. */
end_comment

begin_comment
comment|/* They are not translated since we want gflare files to be compatible    across languages. */
end_comment

begin_decl_stmt
DECL|variable|gflare_modes
specifier|static
specifier|const
name|gchar
modifier|*
name|gflare_modes
index|[]
init|=
block|{
literal|"NORMAL"
block|,
literal|"ADDITION"
block|,
literal|"OVERLAY"
block|,
literal|"SCREEN"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gflare_shapes
specifier|static
specifier|const
name|gchar
modifier|*
name|gflare_shapes
index|[]
init|=
block|{
literal|"CIRCLE"
block|,
literal|"POLYGON"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* These are for menu entries, so they are translated. */
end_comment

begin_decl_stmt
DECL|variable|gflare_menu_modes
specifier|static
specifier|const
name|gchar
modifier|*
name|gflare_menu_modes
index|[]
init|=
block|{
name|N_
argument_list|(
literal|"Normal"
argument_list|)
block|,
name|N_
argument_list|(
literal|"Addition"
argument_list|)
block|,
name|N_
argument_list|(
literal|"Overlay"
argument_list|)
block|,
name|N_
argument_list|(
literal|"Screen"
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|image_ID
specifier|static
name|gint32
name|image_ID
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|drawable
specifier|static
name|GimpDrawable
modifier|*
name|drawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|dinfo
specifier|static
name|DrawableInfo
name|dinfo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tk_read
specifier|static
name|GimpPixelFetcher
modifier|*
name|tk_read
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|tk_write
specifier|static
name|GimpPixelFetcher
modifier|*
name|tk_write
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|dlg
specifier|static
name|GFlareDialog
modifier|*
name|dlg
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ed
specifier|static
name|GFlareEditor
modifier|*
name|ed
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gflares_list
specifier|static
name|GList
modifier|*
name|gflares_list
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|num_gflares
specifier|static
name|gint
name|num_gflares
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gflare_path
specifier|static
name|gchar
modifier|*
name|gflare_path
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|calc
specifier|static
name|CalcParams
name|calc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gradient_menus
specifier|static
name|GList
modifier|*
name|gradient_menus
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gradient_names
specifier|static
name|gchar
modifier|*
modifier|*
name|gradient_names
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|num_gradient_names
specifier|static
name|gint
name|num_gradient_names
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gradient_cache_head
specifier|static
name|GradientCacheItem
modifier|*
name|gradient_cache_head
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gradient_cache_count
specifier|static
name|gint
name|gradient_cache_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|internal_gradients
specifier|static
specifier|const
name|gchar
modifier|*
name|internal_gradients
index|[]
init|=
block|{
literal|"%white"
block|,
literal|"%white_grad"
block|,
literal|"%red_grad"
block|,
literal|"%blue_grad"
block|,
literal|"%yellow_grad"
block|,
literal|"%random"
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_decl_stmt
DECL|variable|get_values_external_count
specifier|static
name|gint
name|get_values_external_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|get_values_external_clock
specifier|static
name|clock_t
name|get_values_external_clock
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/** ***     +++ Static Functions Prototypes **/
end_comment

begin_function_decl
specifier|static
name|void
name|plugin_do
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|plugin_do_non_asupsample
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|plugin_do_asupsample
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|plugin_render_func
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|GimpRGB
modifier|*
name|color
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|plugin_put_pixel_func
parameter_list|(
name|gint
name|ix
parameter_list|,
name|gint
name|iy
parameter_list|,
name|GimpRGB
modifier|*
name|color
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|plugin_progress_func
parameter_list|(
name|gint
name|y1
parameter_list|,
name|gint
name|y2
parameter_list|,
name|gint
name|curr_y
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GFlare
modifier|*
name|gflare_new
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_free
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_read_int
parameter_list|(
name|gint
modifier|*
name|intvar
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_read_double
parameter_list|(
name|gdouble
modifier|*
name|dblvar
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_read_gradient_name
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_read_shape
parameter_list|(
name|GFlareShape
modifier|*
name|shape
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_read_mode
parameter_list|(
name|GFlareMode
modifier|*
name|mode
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gflare_write_gradient_name
parameter_list|(
name|gchar
modifier|*
name|name
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|calc_sample_one_gradient
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_place_sflare
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_get_gradient
parameter_list|(
name|guchar
modifier|*
name|pix
parameter_list|,
name|guchar
modifier|*
name|gradient
parameter_list|,
name|gdouble
name|pos
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gdouble
name|fmod_positive
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_paint_func
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|,
name|gint
name|opacity
parameter_list|,
name|GFlareMode
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_combine
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|,
name|gint
name|opacity
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_addition
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_screen
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|calc_overlay
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_setup_gflare
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_preview_realize
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|dlg_preview_handle_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_preview_update
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|dlg_preview_init_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_preview_render_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|guchar
modifier|*
name|dest
parameter_list|,
name|gint
name|y
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_preview_deinit_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_make_page_settings
parameter_list|(
name|GFlareDialog
modifier|*
name|dlg
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_position_entry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_update_preview_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_make_page_selector
parameter_list|(
name|GFlareDialog
modifier|*
name|dlg
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_setup_listbox
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_list_item_callback
parameter_list|(
name|GtkTreeSelection
modifier|*
name|selection
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_new_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_new_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
specifier|const
name|gchar
modifier|*
name|new_name
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_edit_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_edit_done_callback
parameter_list|(
name|gint
name|updated
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_copy_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_copy_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
specifier|const
name|gchar
modifier|*
name|copy_name
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dlg_selector_do_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gboolean
name|delete
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_run
parameter_list|(
name|GtkWindow
modifier|*
name|parent
parameter_list|,
name|GFlare
modifier|*
name|target_gflare
parameter_list|,
name|GFlareEditorCallback
name|callback
parameter_list|,
name|gpointer
name|calldata
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_destroy_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GFlareEditor
modifier|*
name|ed
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|GFlareEditor
modifier|*
name|ed
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_make_page_general
parameter_list|(
name|GFlareEditor
modifier|*
name|ed
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_make_page_glow
parameter_list|(
name|GFlareEditor
modifier|*
name|ed
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_make_page_rays
parameter_list|(
name|GFlareEditor
modifier|*
name|ed
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_make_page_sflare
parameter_list|(
name|GFlareEditor
modifier|*
name|ed
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_put_gradient_menu
parameter_list|(
name|GtkWidget
modifier|*
name|table
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
specifier|const
name|gchar
modifier|*
name|caption
parameter_list|,
name|GradientMenu
modifier|*
name|gm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_mode_menu_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_gradient_menu_callback
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_shape_radio_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_ientry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_page_map_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_preview_update
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|ed_preview_init_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_preview_deinit_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_preview_render_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_preview_render_general
parameter_list|(
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_preview_render_glow
parameter_list|(
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_preview_render_rays
parameter_list|(
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ed_preview_render_sflare
parameter_list|(
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|preview_render_start_2
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gint
name|preview_handle_idle
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gm_gradient_get_list
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gm_gradient_combo_fill
parameter_list|(
name|GradientMenu
modifier|*
name|gm
parameter_list|,
specifier|const
name|gchar
modifier|*
name|default_gradient
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gm_gradient_combo_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gm_preview_draw
parameter_list|(
name|GtkWidget
modifier|*
name|preview
parameter_list|,
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gm_combo_destroy_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_get_values_internal
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_get_blend
parameter_list|(
specifier|const
name|guchar
modifier|*
name|fg
parameter_list|,
specifier|const
name|guchar
modifier|*
name|bg
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_get_random
parameter_list|(
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_get_default
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_get_values_external
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_get_values_real_external
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|,
name|gboolean
name|reverse
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GradientCacheItem
modifier|*
name|gradient_cache_lookup
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gboolean
modifier|*
name|found
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gradient_cache_zorch
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* *** INSERT-FILE-END *** */
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**             +++ Plug-in Interfaces                                  **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_macro
DECL|function|MAIN ()
name|MAIN
argument_list|()
end_macro

begin_function
name|void
name|plugin_query
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
specifier|const
name|GimpParamDef
name|args
index|[]
init|=
block|{
block|{
name|GIMP_PDB_INT32
block|,
literal|"run-mode"
block|,
literal|"The run mode { RUN-INTERACTIVE (0), RUN-NONINTERACTIVE (1) }"
block|}
block|,
block|{
name|GIMP_PDB_IMAGE
block|,
literal|"image"
block|,
literal|"Input image (unused)"
block|}
block|,
block|{
name|GIMP_PDB_DRAWABLE
block|,
literal|"drawable"
block|,
literal|"Input drawable"
block|}
block|,
block|{
name|GIMP_PDB_STRING
block|,
literal|"gflare-name"
block|,
literal|"The name of GFlare"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"xcenter"
block|,
literal|"X coordinate of center of GFlare"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"ycenter"
block|,
literal|"Y coordinate of center of GFlare"
block|}
block|,
block|{
name|GIMP_PDB_FLOAT
block|,
literal|"radius"
block|,
literal|"Radius of GFlare (pixel)"
block|}
block|,
block|{
name|GIMP_PDB_FLOAT
block|,
literal|"rotation"
block|,
literal|"Rotation of GFlare (degree)"
block|}
block|,
block|{
name|GIMP_PDB_FLOAT
block|,
literal|"hue"
block|,
literal|"Hue rotation of GFlare (degree)"
block|}
block|,
block|{
name|GIMP_PDB_FLOAT
block|,
literal|"vangle"
block|,
literal|"Vector angle for second flares (degree)"
block|}
block|,
block|{
name|GIMP_PDB_FLOAT
block|,
literal|"vlength"
block|,
literal|"Vector length for second flares (percentage to Radius)"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"use-asupsample"
block|,
literal|"Whether it uses or not adaptive supersampling while rendering (boolean)"
block|}
block|,
block|{
name|GIMP_PDB_INT32
block|,
literal|"asupsample-max-depth"
block|,
literal|"Max depth for adaptive supersampling"
block|}
block|,
block|{
name|GIMP_PDB_FLOAT
block|,
literal|"asupsample-threshold"
block|,
literal|"Threshold for adaptive supersampling"
block|}
block|}
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|help_string
init|=
literal|"This plug-in produces a lense flare effect using custom gradients. "
literal|"In interactive call, the user can edit his/her own favorite lense flare "
literal|"(GFlare) and render it. Edited gflare is saved automatically to "
literal|"the folder in gflare-path, if it is defined in gimprc. "
literal|"In non-interactive call, the user can only render one of GFlare "
literal|"which has been stored in gflare-path already."
decl_stmt|;
name|gimp_install_procedure
argument_list|(
name|PLUG_IN_PROC
argument_list|,
name|N_
argument_list|(
literal|"Produce a lense flare effect using gradients"
argument_list|)
argument_list|,
name|help_string
argument_list|,
literal|"Eiichi Takamori"
argument_list|,
literal|"Eiichi Takamori, and a lot of GIMP people"
argument_list|,
literal|"1997"
argument_list|,
name|N_
argument_list|(
literal|"_Gradient Flare..."
argument_list|)
argument_list|,
literal|"RGB*, GRAY*"
argument_list|,
name|GIMP_PLUGIN
argument_list|,
name|G_N_ELEMENTS
argument_list|(
name|args
argument_list|)
argument_list|,
literal|0
argument_list|,
name|args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_plugin_menu_register
argument_list|(
name|PLUG_IN_PROC
argument_list|,
literal|"<Image>/Filters/Light and Shadow/Light"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|plugin_run (const gchar * name,gint nparams,const GimpParam * param,gint * nreturn_vals,GimpParam ** return_vals)
name|plugin_run
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
name|nparams
parameter_list|,
specifier|const
name|GimpParam
modifier|*
name|param
parameter_list|,
name|gint
modifier|*
name|nreturn_vals
parameter_list|,
name|GimpParam
modifier|*
modifier|*
name|return_vals
parameter_list|)
block|{
specifier|static
name|GimpParam
name|values
index|[
literal|2
index|]
decl_stmt|;
name|GimpRunMode
name|run_mode
decl_stmt|;
name|GimpPDBStatusType
name|status
init|=
name|GIMP_PDB_SUCCESS
decl_stmt|;
name|gchar
modifier|*
name|path
decl_stmt|;
comment|/* Initialize */
name|run_mode
operator|=
name|param
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|INIT_I18N
argument_list|()
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|1
expr_stmt|;
operator|*
name|return_vals
operator|=
name|values
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STATUS
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
comment|/*    *    Get the specified drawable and its info (global variable)    */
name|image_ID
operator|=
name|param
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_image
expr_stmt|;
name|drawable
operator|=
name|gimp_drawable_get
argument_list|(
name|param
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|d_drawable
argument_list|)
expr_stmt|;
name|dinfo
operator|.
name|is_color
operator|=
name|gimp_drawable_is_rgb
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
expr_stmt|;
name|dinfo
operator|.
name|has_alpha
operator|=
name|gimp_drawable_has_alpha
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
expr_stmt|;
name|gimp_drawable_mask_bounds
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
operator|&
name|dinfo
operator|.
name|x1
argument_list|,
operator|&
name|dinfo
operator|.
name|y1
argument_list|,
operator|&
name|dinfo
operator|.
name|x2
argument_list|,
operator|&
name|dinfo
operator|.
name|y2
argument_list|)
expr_stmt|;
name|dinfo
operator|.
name|tile_width
operator|=
name|gimp_tile_width
argument_list|()
expr_stmt|;
name|dinfo
operator|.
name|tile_height
operator|=
name|gimp_tile_height
argument_list|()
expr_stmt|;
comment|/*    *    Start gradient caching    */
name|gradient_init
argument_list|()
expr_stmt|;
comment|/*    *    Parse gflare path from gimprc and load gflares    */
name|path
operator|=
name|gimp_gimprc_query
argument_list|(
literal|"gflare-path"
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
condition|)
block|{
name|gflare_path
operator|=
name|g_filename_from_utf8
argument_list|(
name|path
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gchar
modifier|*
name|gimprc
init|=
name|gimp_personal_rc_file
argument_list|(
literal|"gimprc"
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|full_path
init|=
name|gimp_config_build_data_path
argument_list|(
literal|"gflare"
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|esc_path
init|=
name|g_strescape
argument_list|(
name|full_path
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|g_free
argument_list|(
name|full_path
argument_list|)
expr_stmt|;
name|g_message
argument_list|(
name|_
argument_list|(
literal|"No %s in gimprc:\n"
literal|"You need to add an entry like\n"
literal|"(%s \"%s\")\n"
literal|"to your %s file."
argument_list|)
argument_list|,
literal|"gflare-path"
argument_list|,
literal|"gflare-path"
argument_list|,
name|esc_path
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|gimprc
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gimprc
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|esc_path
argument_list|)
expr_stmt|;
block|}
name|gflares_list_load_all
argument_list|()
expr_stmt|;
name|gimp_tile_cache_ntiles
argument_list|(
name|drawable
operator|->
name|width
operator|/
name|gimp_tile_width
argument_list|()
operator|+
literal|2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|run_mode
condition|)
block|{
case|case
name|GIMP_RUN_INTERACTIVE
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|pvals
argument_list|)
expr_stmt|;
comment|/*  First acquire information with a dialog  */
if|if
condition|(
operator|!
name|dlg_run
argument_list|()
condition|)
block|{
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|GIMP_RUN_NONINTERACTIVE
case|:
if|if
condition|(
name|nparams
operator|!=
literal|14
condition|)
block|{
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
else|else
block|{
name|gflare_name_copy
argument_list|(
name|pvals
operator|.
name|gflare_name
argument_list|,
name|param
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|d_string
argument_list|)
expr_stmt|;
name|pvals
operator|.
name|xcenter
operator|=
name|param
index|[
literal|4
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|pvals
operator|.
name|ycenter
operator|=
name|param
index|[
literal|5
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|pvals
operator|.
name|radius
operator|=
name|param
index|[
literal|6
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
name|pvals
operator|.
name|rotation
operator|=
name|param
index|[
literal|7
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
name|pvals
operator|.
name|hue
operator|=
name|param
index|[
literal|8
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
name|pvals
operator|.
name|vangle
operator|=
name|param
index|[
literal|9
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
name|pvals
operator|.
name|vlength
operator|=
name|param
index|[
literal|10
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
name|pvals
operator|.
name|use_asupsample
operator|=
name|param
index|[
literal|11
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|pvals
operator|.
name|asupsample_max_depth
operator|=
name|param
index|[
literal|12
index|]
operator|.
name|data
operator|.
name|d_int32
expr_stmt|;
name|pvals
operator|.
name|asupsample_threshold
operator|=
name|param
index|[
literal|13
index|]
operator|.
name|data
operator|.
name|d_float
expr_stmt|;
if|if
condition|(
name|pvals
operator|.
name|radius
operator|<=
literal|0
condition|)
name|status
operator|=
name|GIMP_PDB_CALLING_ERROR
expr_stmt|;
block|}
break|break;
case|case
name|GIMP_RUN_WITH_LAST_VALS
case|:
comment|/*  Possibly retrieve data  */
name|gimp_get_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|pvals
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|GIMP_PDB_SUCCESS
condition|)
block|{
comment|/*  Make sure that the drawable is gray or RGB color  */
if|if
condition|(
name|gimp_drawable_is_rgb
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
operator|||
name|gimp_drawable_is_gray
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
condition|)
block|{
name|gimp_progress_init
argument_list|(
name|_
argument_list|(
literal|"Gradient Flare"
argument_list|)
argument_list|)
expr_stmt|;
name|plugin_do
argument_list|()
expr_stmt|;
if|if
condition|(
name|run_mode
operator|!=
name|GIMP_RUN_NONINTERACTIVE
condition|)
name|gimp_displays_flush
argument_list|()
expr_stmt|;
comment|/*  Store data  */
if|if
condition|(
name|run_mode
operator|==
name|GIMP_RUN_INTERACTIVE
condition|)
name|gimp_set_data
argument_list|(
name|PLUG_IN_PROC
argument_list|,
operator|&
name|pvals
argument_list|,
sizeof|sizeof
argument_list|(
name|PluginValues
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|GIMP_PDB_EXECUTION_ERROR
expr_stmt|;
operator|*
name|nreturn_vals
operator|=
literal|2
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|GIMP_PDB_STRING
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|d_string
operator|=
name|_
argument_list|(
literal|"Cannot operate on indexed color images."
argument_list|)
expr_stmt|;
block|}
block|}
name|values
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|d_status
operator|=
name|status
expr_stmt|;
comment|/*    *    Deinitialization    */
name|gradient_free
argument_list|()
expr_stmt|;
name|gimp_drawable_detach
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|plugin_do (void)
name|plugin_do
parameter_list|(
name|void
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
decl_stmt|;
name|gflare
operator|=
name|gflares_list_lookup
argument_list|(
name|pvals
operator|.
name|gflare_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|gflare
operator|==
name|NULL
condition|)
block|{
comment|/* FIXME */
name|g_warning
argument_list|(
literal|"Not found %s\n"
argument_list|,
name|pvals
operator|.
name|gflare_name
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Initialize calc params and gradients */
name|calc_init_params
argument_list|(
name|gflare
argument_list|,
name|CALC_GLOW
operator||
name|CALC_RAYS
operator||
name|CALC_SFLARE
argument_list|,
name|pvals
operator|.
name|xcenter
argument_list|,
name|pvals
operator|.
name|ycenter
argument_list|,
name|pvals
operator|.
name|radius
argument_list|,
name|pvals
operator|.
name|rotation
argument_list|,
name|pvals
operator|.
name|hue
argument_list|,
name|pvals
operator|.
name|vangle
argument_list|,
name|pvals
operator|.
name|vlength
argument_list|)
expr_stmt|;
while|while
condition|(
name|calc_init_progress
argument_list|()
condition|)
empty_stmt|;
comment|/* Render it ! */
if|if
condition|(
name|pvals
operator|.
name|use_asupsample
condition|)
name|plugin_do_asupsample
argument_list|()
expr_stmt|;
else|else
name|plugin_do_non_asupsample
argument_list|()
expr_stmt|;
comment|/* Clean up */
name|calc_deinit
argument_list|()
expr_stmt|;
name|gimp_drawable_flush
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|gimp_drawable_merge_shadow
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_drawable_update
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|,
name|dinfo
operator|.
name|x1
argument_list|,
name|dinfo
operator|.
name|y1
argument_list|,
operator|(
name|dinfo
operator|.
name|x2
operator|-
name|dinfo
operator|.
name|x1
operator|)
argument_list|,
operator|(
name|dinfo
operator|.
name|y2
operator|-
name|dinfo
operator|.
name|y1
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* these routines should be almost rewritten anyway */
end_comment

begin_function
specifier|static
name|void
DECL|function|plugin_do_non_asupsample (void)
name|plugin_do_non_asupsample
parameter_list|(
name|void
parameter_list|)
block|{
name|GimpPixelRgn
name|src_rgn
decl_stmt|,
name|dest_rgn
decl_stmt|;
name|gpointer
name|pr
decl_stmt|;
name|gint
name|width
decl_stmt|,
name|height
decl_stmt|;
name|gint
name|progress
decl_stmt|,
name|max_progress
decl_stmt|;
name|width
operator|=
name|dinfo
operator|.
name|x2
operator|-
name|dinfo
operator|.
name|x1
expr_stmt|;
name|height
operator|=
name|dinfo
operator|.
name|y2
operator|-
name|dinfo
operator|.
name|y1
expr_stmt|;
name|progress
operator|=
literal|0
expr_stmt|;
name|max_progress
operator|=
name|width
operator|*
name|height
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|src_rgn
argument_list|,
name|drawable
argument_list|,
name|dinfo
operator|.
name|x1
argument_list|,
name|dinfo
operator|.
name|y1
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|dest_rgn
argument_list|,
name|drawable
argument_list|,
name|dinfo
operator|.
name|x1
argument_list|,
name|dinfo
operator|.
name|y1
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|gimp_pixel_rgns_register
argument_list|(
literal|2
argument_list|,
operator|&
name|src_rgn
argument_list|,
operator|&
name|dest_rgn
argument_list|)
init|;
name|pr
operator|!=
name|NULL
condition|;
name|pr
operator|=
name|gimp_pixel_rgns_process
argument_list|(
name|pr
argument_list|)
control|)
block|{
specifier|const
name|guchar
modifier|*
name|src_row
init|=
name|src_rgn
operator|.
name|data
decl_stmt|;
name|guchar
modifier|*
name|dest_row
init|=
name|dest_rgn
operator|.
name|data
decl_stmt|;
name|gint
name|row
decl_stmt|,
name|y
decl_stmt|;
for|for
control|(
name|row
operator|=
literal|0
operator|,
name|y
operator|=
name|src_rgn
operator|.
name|y
init|;
name|row
operator|<
name|src_rgn
operator|.
name|h
condition|;
name|row
operator|++
operator|,
name|y
operator|++
control|)
block|{
specifier|const
name|guchar
modifier|*
name|src
init|=
name|src_row
decl_stmt|;
name|guchar
modifier|*
name|dest
init|=
name|dest_row
decl_stmt|;
name|gint
name|col
decl_stmt|,
name|x
decl_stmt|;
for|for
control|(
name|col
operator|=
literal|0
operator|,
name|x
operator|=
name|src_rgn
operator|.
name|x
init|;
name|col
operator|<
name|src_rgn
operator|.
name|w
condition|;
name|col
operator|++
operator|,
name|x
operator|++
control|)
block|{
name|guchar
name|src_pix
index|[
literal|4
index|]
decl_stmt|;
name|guchar
name|dest_pix
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|b
decl_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
name|src_pix
index|[
name|b
index|]
operator|=
name|dinfo
operator|.
name|is_color
condition|?
name|src
index|[
name|b
index|]
else|:
name|src
index|[
literal|0
index|]
expr_stmt|;
name|src_pix
index|[
literal|3
index|]
operator|=
name|dinfo
operator|.
name|has_alpha
condition|?
name|src
index|[
name|src_rgn
operator|.
name|bpp
operator|-
literal|1
index|]
else|:
name|OPAQUE
expr_stmt|;
name|calc_gflare_pix
argument_list|(
name|dest_pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|src_pix
argument_list|)
expr_stmt|;
if|if
condition|(
name|dinfo
operator|.
name|is_color
condition|)
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
name|dest
index|[
name|b
index|]
operator|=
name|dest_pix
index|[
name|b
index|]
expr_stmt|;
block|}
else|else
block|{
name|dest
index|[
literal|0
index|]
operator|=
name|LUMINOSITY
argument_list|(
name|dest_pix
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dinfo
operator|.
name|has_alpha
condition|)
name|dest
index|[
name|src_rgn
operator|.
name|bpp
operator|-
literal|1
index|]
operator|=
name|dest_pix
index|[
literal|3
index|]
expr_stmt|;
name|src
operator|+=
name|src_rgn
operator|.
name|bpp
expr_stmt|;
name|dest
operator|+=
name|dest_rgn
operator|.
name|bpp
expr_stmt|;
block|}
name|src_row
operator|+=
name|src_rgn
operator|.
name|rowstride
expr_stmt|;
name|dest_row
operator|+=
name|dest_rgn
operator|.
name|rowstride
expr_stmt|;
block|}
comment|/* Update progress */
name|progress
operator|+=
name|src_rgn
operator|.
name|w
operator|*
name|src_rgn
operator|.
name|h
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|progress
operator|/
operator|(
name|double
operator|)
name|max_progress
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|plugin_do_asupsample (void)
name|plugin_do_asupsample
parameter_list|(
name|void
parameter_list|)
block|{
name|tk_read
operator|=
name|gimp_pixel_fetcher_new
argument_list|(
name|drawable
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_fetcher_set_edge_mode
argument_list|(
name|tk_read
argument_list|,
name|GIMP_PIXEL_FETCHER_EDGE_BLACK
argument_list|)
expr_stmt|;
name|tk_write
operator|=
name|gimp_pixel_fetcher_new
argument_list|(
name|drawable
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|gimp_adaptive_supersample_area
argument_list|(
name|dinfo
operator|.
name|x1
argument_list|,
name|dinfo
operator|.
name|y1
argument_list|,
name|dinfo
operator|.
name|x2
operator|-
literal|1
argument_list|,
name|dinfo
operator|.
name|y2
operator|-
literal|1
argument_list|,
name|pvals
operator|.
name|asupsample_max_depth
argument_list|,
name|pvals
operator|.
name|asupsample_threshold
argument_list|,
name|plugin_render_func
argument_list|,
name|NULL
argument_list|,
name|plugin_put_pixel_func
argument_list|,
name|NULL
argument_list|,
name|plugin_progress_func
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gimp_pixel_fetcher_destroy
argument_list|(
name|tk_write
argument_list|)
expr_stmt|;
name|gimp_pixel_fetcher_destroy
argument_list|(
name|tk_read
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   Adaptive supersampling callback functions    These routines may look messy, since adaptive supersampling needs   pixel values in `double' (from 0.0 to 1.0) but calc_*_pix () returns   guchar values. */
end_comment

begin_function
specifier|static
name|void
DECL|function|plugin_render_func (gdouble x,gdouble y,GimpRGB * color,gpointer data)
name|plugin_render_func
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|GimpRGB
modifier|*
name|color
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|guchar
name|src_pix
index|[
literal|4
index|]
decl_stmt|;
name|guchar
name|flare_pix
index|[
literal|4
index|]
decl_stmt|;
name|guchar
name|src
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|b
decl_stmt|;
name|gint
name|ix
decl_stmt|,
name|iy
decl_stmt|;
comment|/* translate (0.5, 0.5) before convert to `int' so that it can surely      point the center of pixel */
name|ix
operator|=
name|floor
argument_list|(
name|x
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|iy
operator|=
name|floor
argument_list|(
name|y
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|gimp_pixel_fetcher_get_pixel
argument_list|(
name|tk_read
argument_list|,
name|ix
argument_list|,
name|iy
argument_list|,
name|src
argument_list|)
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
name|src_pix
index|[
name|b
index|]
operator|=
name|dinfo
operator|.
name|is_color
condition|?
name|src
index|[
name|b
index|]
else|:
name|src
index|[
literal|0
index|]
expr_stmt|;
name|src_pix
index|[
literal|3
index|]
operator|=
name|dinfo
operator|.
name|has_alpha
condition|?
name|src
index|[
name|drawable
operator|->
name|bpp
operator|-
literal|1
index|]
else|:
name|OPAQUE
expr_stmt|;
name|calc_gflare_pix
argument_list|(
name|flare_pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|src_pix
argument_list|)
expr_stmt|;
name|color
operator|->
name|r
operator|=
name|flare_pix
index|[
literal|0
index|]
operator|/
literal|255.0
expr_stmt|;
name|color
operator|->
name|g
operator|=
name|flare_pix
index|[
literal|1
index|]
operator|/
literal|255.0
expr_stmt|;
name|color
operator|->
name|b
operator|=
name|flare_pix
index|[
literal|2
index|]
operator|/
literal|255.0
expr_stmt|;
name|color
operator|->
name|a
operator|=
name|flare_pix
index|[
literal|3
index|]
operator|/
literal|255.0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|plugin_put_pixel_func (gint ix,gint iy,GimpRGB * color,gpointer data)
name|plugin_put_pixel_func
parameter_list|(
name|gint
name|ix
parameter_list|,
name|gint
name|iy
parameter_list|,
name|GimpRGB
modifier|*
name|color
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|guchar
name|dest
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|dinfo
operator|.
name|is_color
condition|)
block|{
name|dest
index|[
literal|0
index|]
operator|=
name|color
operator|->
name|r
operator|*
literal|255
expr_stmt|;
name|dest
index|[
literal|1
index|]
operator|=
name|color
operator|->
name|g
operator|*
literal|255
expr_stmt|;
name|dest
index|[
literal|2
index|]
operator|=
name|color
operator|->
name|b
operator|*
literal|255
expr_stmt|;
block|}
else|else
block|{
name|dest
index|[
literal|0
index|]
operator|=
name|gimp_rgb_luminance_uchar
argument_list|(
name|color
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dinfo
operator|.
name|has_alpha
condition|)
name|dest
index|[
name|drawable
operator|->
name|bpp
operator|-
literal|1
index|]
operator|=
name|color
operator|->
name|a
operator|*
literal|255
expr_stmt|;
name|gimp_pixel_fetcher_put_pixel
argument_list|(
name|tk_write
argument_list|,
name|ix
argument_list|,
name|iy
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|plugin_progress_func (gint y1,gint y2,gint curr_y,gpointer data)
name|plugin_progress_func
parameter_list|(
name|gint
name|y1
parameter_list|,
name|gint
name|y2
parameter_list|,
name|gint
name|curr_y
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|curr_y
operator|/
call|(
name|double
call|)
argument_list|(
name|y2
operator|-
name|y1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**             +++ GFlare Routines                                     **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/*  *      These code are more or less based on Quartic's gradient.c,  *      other gimp sources, and script-fu.  */
end_comment

begin_function
specifier|static
name|GFlare
modifier|*
DECL|function|gflare_new (void)
name|gflare_new
parameter_list|(
name|void
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
init|=
name|g_new0
argument_list|(
name|GFlare
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|gflare
operator|->
name|name
operator|=
name|NULL
expr_stmt|;
name|gflare
operator|->
name|filename
operator|=
name|NULL
expr_stmt|;
return|return
name|gflare
return|;
block|}
end_function

begin_function
specifier|static
name|GFlare
modifier|*
DECL|function|gflare_new_with_default (const gchar * new_name)
name|gflare_new_with_default
parameter_list|(
specifier|const
name|gchar
modifier|*
name|new_name
parameter_list|)
block|{
return|return
name|gflare_dup
argument_list|(
operator|&
name|default_gflare
argument_list|,
name|new_name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|GFlare
modifier|*
DECL|function|gflare_dup (const GFlare * src,const gchar * new_name)
name|gflare_dup
parameter_list|(
specifier|const
name|GFlare
modifier|*
name|src
parameter_list|,
specifier|const
name|gchar
modifier|*
name|new_name
parameter_list|)
block|{
name|GFlare
modifier|*
name|dest
init|=
name|g_new0
argument_list|(
name|GFlare
argument_list|,
literal|1
argument_list|)
decl_stmt|;
operator|*
name|dest
operator|=
operator|*
name|src
expr_stmt|;
name|dest
operator|->
name|name
operator|=
name|g_strdup
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
name|dest
operator|->
name|filename
operator|=
name|NULL
expr_stmt|;
return|return
name|dest
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_copy (GFlare * dest,const GFlare * src)
name|gflare_copy
parameter_list|(
name|GFlare
modifier|*
name|dest
parameter_list|,
specifier|const
name|GFlare
modifier|*
name|src
parameter_list|)
block|{
name|gchar
modifier|*
name|name
decl_stmt|,
modifier|*
name|filename
decl_stmt|;
name|name
operator|=
name|dest
operator|->
name|name
expr_stmt|;
name|filename
operator|=
name|dest
operator|->
name|filename
expr_stmt|;
operator|*
name|dest
operator|=
operator|*
name|src
expr_stmt|;
name|dest
operator|->
name|name
operator|=
name|name
expr_stmt|;
name|dest
operator|->
name|filename
operator|=
name|filename
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_free (GFlare * gflare)
name|gflare_free
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
block|{
name|g_return_if_fail
argument_list|(
name|gflare
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gflare
operator|->
name|name
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gflare
operator|->
name|filename
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gflare
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GFlare
modifier|*
DECL|function|gflare_load (const gchar * filename,const gchar * name)
name|gflare_load
parameter_list|(
specifier|const
name|gchar
modifier|*
name|filename
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|GFlareFile
modifier|*
name|gf
decl_stmt|;
name|GFlare
modifier|*
name|gflare
decl_stmt|;
name|gchar
name|header
index|[
literal|256
index|]
decl_stmt|;
name|g_return_val_if_fail
argument_list|(
name|filename
operator|!=
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fp
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Failed to open GFlare file '%s': %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|fgets
argument_list|(
name|header
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|,
name|fp
argument_list|)
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|header
argument_list|,
name|GFLARE_FILE_HEADER
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"'%s' is not a valid GFlare file."
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|filename
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|gf
operator|=
name|g_new
argument_list|(
name|GFlareFile
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gf
operator|->
name|fp
operator|=
name|fp
expr_stmt|;
name|gf
operator|->
name|error
operator|=
name|FALSE
expr_stmt|;
name|gflare
operator|=
name|gflare_new
argument_list|()
expr_stmt|;
name|gflare
operator|->
name|name
operator|=
name|g_strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|gflare
operator|->
name|filename
operator|=
name|g_strdup
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|glow_opacity
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_mode
argument_list|(
operator|&
name|gflare
operator|->
name|glow_mode
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|rays_opacity
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_mode
argument_list|(
operator|&
name|gflare
operator|->
name|rays_mode
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_opacity
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_mode
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_mode
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|glow_radial
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|glow_angular
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|glow_angular_size
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|glow_size
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|glow_rotation
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|glow_hue
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|rays_radial
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|rays_angular
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|rays_angular_size
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|rays_size
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|rays_rotation
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|rays_hue
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_int
argument_list|(
operator|&
name|gflare
operator|->
name|rays_nspikes
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|rays_thickness
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|sflare_radial
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|sflare_sizefac
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_gradient_name
argument_list|(
name|gflare
operator|->
name|sflare_probability
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_size
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_hue
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_double
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_rotation
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_shape
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_shape
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_int
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_nverts
argument_list|,
name|gf
argument_list|)
expr_stmt|;
name|gflare_read_int
argument_list|(
operator|(
name|gint
operator|*
operator|)
operator|&
name|gflare
operator|->
name|sflare_seed
argument_list|,
name|gf
argument_list|)
expr_stmt|;
if|if
condition|(
name|gflare
operator|->
name|sflare_seed
operator|==
literal|0
condition|)
name|gflare
operator|->
name|sflare_seed
operator|=
name|g_random_int
argument_list|()
expr_stmt|;
name|fclose
argument_list|(
name|gf
operator|->
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|gf
operator|->
name|error
condition|)
block|{
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"invalid formatted GFlare file: %s\n"
argument_list|)
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gflare
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|g_free
argument_list|(
name|gf
argument_list|)
expr_stmt|;
return|return
name|gflare
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_read_int (gint * intvar,GFlareFile * gf)
name|gflare_read_int
parameter_list|(
name|gint
modifier|*
name|intvar
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
block|{
if|if
condition|(
name|gf
operator|->
name|error
condition|)
return|return;
if|if
condition|(
name|fscanf
argument_list|(
name|gf
operator|->
name|fp
argument_list|,
literal|"%d"
argument_list|,
name|intvar
argument_list|)
operator|!=
literal|1
condition|)
name|gf
operator|->
name|error
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_read_double (gdouble * dblvar,GFlareFile * gf)
name|gflare_read_double
parameter_list|(
name|gdouble
modifier|*
name|dblvar
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
block|{
name|gchar
name|buf
index|[
literal|31
index|]
decl_stmt|;
if|if
condition|(
name|gf
operator|->
name|error
condition|)
return|return;
if|if
condition|(
name|fscanf
argument_list|(
name|gf
operator|->
name|fp
argument_list|,
literal|"%30s"
argument_list|,
name|buf
argument_list|)
operator|==
literal|1
condition|)
operator|*
name|dblvar
operator|=
name|g_ascii_strtod
argument_list|(
name|buf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|gf
operator|->
name|error
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_read_gradient_name (GradientName name,GFlareFile * gf)
name|gflare_read_gradient_name
parameter_list|(
name|GradientName
name|name
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
block|{
name|gchar
name|tmp
index|[
literal|1024
index|]
decl_stmt|,
name|dec
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
name|gf
operator|->
name|error
condition|)
return|return;
comment|/* FIXME: this is buggy */
if|if
condition|(
name|fscanf
argument_list|(
name|gf
operator|->
name|fp
argument_list|,
literal|"%1023s"
argument_list|,
name|tmp
argument_list|)
operator|==
literal|1
condition|)
block|{
comment|/* @GRADIENT_NAME */
name|gradient_name_decode
argument_list|(
name|dec
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|gradient_name_copy
argument_list|(
name|name
argument_list|,
name|dec
argument_list|)
expr_stmt|;
block|}
else|else
name|gf
operator|->
name|error
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_read_shape (GFlareShape * shape,GFlareFile * gf)
name|gflare_read_shape
parameter_list|(
name|GFlareShape
modifier|*
name|shape
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
block|{
name|gchar
name|tmp
index|[
literal|1024
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
if|if
condition|(
name|gf
operator|->
name|error
condition|)
return|return;
if|if
condition|(
name|fscanf
argument_list|(
name|gf
operator|->
name|fp
argument_list|,
literal|"%1023s"
argument_list|,
name|tmp
argument_list|)
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GF_NUM_SHAPES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|tmp
argument_list|,
name|gflare_shapes
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|shape
operator|=
name|i
expr_stmt|;
return|return;
block|}
block|}
name|gf
operator|->
name|error
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_read_mode (GFlareMode * mode,GFlareFile * gf)
name|gflare_read_mode
parameter_list|(
name|GFlareMode
modifier|*
name|mode
parameter_list|,
name|GFlareFile
modifier|*
name|gf
parameter_list|)
block|{
name|gchar
name|tmp
index|[
literal|1024
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
if|if
condition|(
name|gf
operator|->
name|error
condition|)
return|return;
if|if
condition|(
name|fscanf
argument_list|(
name|gf
operator|->
name|fp
argument_list|,
literal|"%1023s"
argument_list|,
name|tmp
argument_list|)
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GF_NUM_MODES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|tmp
argument_list|,
name|gflare_modes
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|mode
operator|=
name|i
expr_stmt|;
return|return;
block|}
block|}
name|gf
operator|->
name|error
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_save (GFlare * gflare)
name|gflare_save
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|gchar
modifier|*
name|path
decl_stmt|;
name|gchar
name|buf
index|[
literal|3
index|]
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
specifier|static
name|gboolean
name|message_ok
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|gflare
operator|->
name|filename
operator|==
name|NULL
condition|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
if|if
condition|(
name|gflare_path
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|message_ok
condition|)
block|{
name|gchar
modifier|*
name|gimprc
init|=
name|gimp_personal_rc_file
argument_list|(
literal|"gimprc"
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|dir
init|=
name|gimp_personal_rc_file
argument_list|(
literal|"gflare"
argument_list|)
decl_stmt|;
name|gchar
modifier|*
name|gflare_dir
decl_stmt|;
name|gflare_dir
operator|=
name|g_strescape
argument_list|(
literal|"${gimp_dir}"
name|G_DIR_SEPARATOR_S
literal|"gflare"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_message
argument_list|(
name|_
argument_list|(
literal|"GFlare '%s' is not saved. If you add a new entry "
literal|"in '%s', like:\n"
literal|"(gflare-path \"%s\")\n"
literal|"and make a folder '%s', then you can save "
literal|"your own GFlares into that folder."
argument_list|)
argument_list|,
name|gflare
operator|->
name|name
argument_list|,
name|gimprc
argument_list|,
name|gflare_dir
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|dir
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gimprc
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gflare_dir
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dir
argument_list|)
expr_stmt|;
name|message_ok
operator|=
name|TRUE
expr_stmt|;
block|}
return|return;
block|}
name|list
operator|=
name|gimp_path_parse
argument_list|(
name|gflare_path
argument_list|,
literal|16
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|path
operator|=
name|gimp_path_get_user_writable_dir
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|gimp_path_free
argument_list|(
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
name|path
operator|=
name|g_strdup
argument_list|(
name|gimp_directory
argument_list|()
argument_list|)
expr_stmt|;
name|gflare
operator|->
name|filename
operator|=
name|g_build_filename
argument_list|(
name|path
argument_list|,
name|gflare
operator|->
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
name|fp
operator|=
name|g_fopen
argument_list|(
name|gflare
operator|->
name|filename
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Failed to write GFlare file '%s': %s"
argument_list|)
argument_list|,
name|gimp_filename_to_utf8
argument_list|(
name|gflare
operator|->
name|filename
argument_list|)
argument_list|,
name|g_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s"
argument_list|,
name|GFLARE_FILE_HEADER
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|glow_opacity
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %s\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|gflare_modes
index|[
name|gflare
operator|->
name|glow_mode
index|]
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|rays_opacity
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %s\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|gflare_modes
index|[
name|gflare
operator|->
name|rays_mode
index|]
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|sflare_opacity
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %s\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|gflare_modes
index|[
name|gflare
operator|->
name|sflare_mode
index|]
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|glow_radial
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|glow_angular
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|glow_angular_size
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|glow_size
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|glow_rotation
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|glow_hue
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %s %s\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|rays_radial
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|rays_angular
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|rays_angular_size
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|rays_size
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|rays_rotation
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|rays_hue
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %s %s\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|rays_thickness
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%d %s\n"
argument_list|,
name|gflare
operator|->
name|rays_nspikes
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|sflare_radial
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|sflare_sizefac
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gflare_write_gradient_name
argument_list|(
name|gflare
operator|->
name|sflare_probability
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|sflare_size
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|sflare_rotation
argument_list|)
expr_stmt|;
name|g_ascii_formatd
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|G_ASCII_DTOSTR_BUF_SIZE
argument_list|,
literal|"%f"
argument_list|,
name|gflare
operator|->
name|sflare_hue
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %s %s\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %d %d\n"
argument_list|,
name|gflare_shapes
index|[
name|gflare
operator|->
name|sflare_shape
index|]
argument_list|,
name|gflare
operator|->
name|sflare_nverts
argument_list|,
name|gflare
operator|->
name|sflare_seed
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_write_gradient_name (GradientName name,FILE * fp)
name|gflare_write_gradient_name
parameter_list|(
name|GradientName
name|name
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|gchar
name|enc
index|[
literal|1024
index|]
decl_stmt|;
comment|/* @GRADIENT_NAME */
comment|/* encode white spaces and control characters (if any) */
name|gradient_name_encode
argument_list|(
name|enc
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s\n"
argument_list|,
name|enc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflare_name_copy (gchar * dest,const gchar * src)
name|gflare_name_copy
parameter_list|(
name|gchar
modifier|*
name|dest
parameter_list|,
specifier|const
name|gchar
modifier|*
name|src
parameter_list|)
block|{
name|strncpy
argument_list|(
name|dest
argument_list|,
name|src
argument_list|,
name|GFLARE_NAME_MAX
argument_list|)
expr_stmt|;
name|dest
index|[
name|GFLARE_NAME_MAX
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**             +++ GFlares List                                        **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_function
specifier|static
name|gint
DECL|function|gflare_compare (const GFlare * flare1,const GFlare * flare2)
name|gflare_compare
parameter_list|(
specifier|const
name|GFlare
modifier|*
name|flare1
parameter_list|,
specifier|const
name|GFlare
modifier|*
name|flare2
parameter_list|)
block|{
return|return
name|strcmp
argument_list|(
name|flare1
operator|->
name|name
argument_list|,
name|flare2
operator|->
name|name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|gflares_list_insert (GFlare * gflare)
name|gflares_list_insert
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
block|{
name|num_gflares
operator|++
expr_stmt|;
name|gflares_list
operator|=
name|g_list_insert_sorted
argument_list|(
name|gflares_list
argument_list|,
name|gflare
argument_list|,
operator|(
name|GCompareFunc
operator|)
name|gflare_compare
argument_list|)
expr_stmt|;
return|return
name|gflares_list_index
argument_list|(
name|gflare
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|gflare_compare_name (const GFlare * flare,const gchar * name)
name|gflare_compare_name
parameter_list|(
specifier|const
name|GFlare
modifier|*
name|flare
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|)
block|{
return|return
name|strcmp
argument_list|(
name|flare
operator|->
name|name
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|GFlare
modifier|*
DECL|function|gflares_list_lookup (const gchar * name)
name|gflares_list_lookup
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|)
block|{
name|GList
modifier|*
name|llink
decl_stmt|;
name|llink
operator|=
name|g_list_find_custom
argument_list|(
name|gflares_list
argument_list|,
name|name
argument_list|,
operator|(
name|GCompareFunc
operator|)
name|gflare_compare_name
argument_list|)
expr_stmt|;
return|return
operator|(
name|llink
operator|)
condition|?
name|llink
operator|->
name|data
else|:
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|gflares_list_index (GFlare * gflare)
name|gflares_list_index
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
block|{
return|return
name|g_list_index
argument_list|(
name|gflares_list
argument_list|,
name|gflare
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|gflares_list_remove (GFlare * gflare)
name|gflares_list_remove
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|)
block|{
name|GList
modifier|*
name|tmp
decl_stmt|;
name|gint
name|n
decl_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|tmp
operator|=
name|gflares_list
expr_stmt|;
while|while
condition|(
name|tmp
condition|)
block|{
if|if
condition|(
name|tmp
operator|->
name|data
operator|==
name|gflare
condition|)
block|{
comment|/* Found! */
if|if
condition|(
name|tmp
operator|->
name|next
operator|==
name|NULL
condition|)
name|num_gflares
operator|--
expr_stmt|;
name|gflares_list
operator|=
name|g_list_remove
argument_list|(
name|gflares_list
argument_list|,
name|gflare
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
name|tmp
operator|=
name|tmp
operator|->
name|next
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Load all gflares, which are founded in gflare-path-list, into gflares_list.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gflares_list_load_one (const GimpDatafileData * file_data,gpointer user_data)
name|gflares_list_load_one
parameter_list|(
specifier|const
name|GimpDatafileData
modifier|*
name|file_data
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
decl_stmt|;
name|gflare
operator|=
name|gflare_load
argument_list|(
name|file_data
operator|->
name|filename
argument_list|,
name|file_data
operator|->
name|basename
argument_list|)
expr_stmt|;
if|if
condition|(
name|gflare
condition|)
name|gflares_list_insert
argument_list|(
name|gflare
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflares_list_load_all (void)
name|gflares_list_load_all
parameter_list|(
name|void
parameter_list|)
block|{
comment|/*  Make sure to clear any existing gflares  */
name|gflares_list_free_all
argument_list|()
expr_stmt|;
name|gimp_datafiles_read_directories
argument_list|(
name|gflare_path
argument_list|,
name|G_FILE_TEST_EXISTS
argument_list|,
name|gflares_list_load_one
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gflares_list_free_all (void)
name|gflares_list_free_all
parameter_list|(
name|void
parameter_list|)
block|{
name|g_list_foreach
argument_list|(
name|gflares_list
argument_list|,
operator|(
name|GFunc
operator|)
name|gflare_free
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_list_free
argument_list|(
name|gflares_list
argument_list|)
expr_stmt|;
name|gflares_list
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**             +++ Calculator                                          **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/*  * These routines calculates pixel values of particular gflare, at  * specified point.  The client which wants to get benefit from these  * calculation routines must call calc_init_params() first, and  * iterate calling calc_init_progress() until it returns FALSE. and  * must call calc_deinit() when job is done.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|calc_init_params (GFlare * gflare,gint calc_type,gdouble xcenter,gdouble ycenter,gdouble radius,gdouble rotation,gdouble hue,gdouble vangle,gdouble vlength)
name|calc_init_params
parameter_list|(
name|GFlare
modifier|*
name|gflare
parameter_list|,
name|gint
name|calc_type
parameter_list|,
name|gdouble
name|xcenter
parameter_list|,
name|gdouble
name|ycenter
parameter_list|,
name|gdouble
name|radius
parameter_list|,
name|gdouble
name|rotation
parameter_list|,
name|gdouble
name|hue
parameter_list|,
name|gdouble
name|vangle
parameter_list|,
name|gdouble
name|vlength
parameter_list|)
block|{
name|calc
operator|.
name|type
operator|=
name|calc_type
expr_stmt|;
name|calc
operator|.
name|gflare
operator|=
name|gflare
expr_stmt|;
name|calc
operator|.
name|xcenter
operator|=
name|xcenter
expr_stmt|;
name|calc
operator|.
name|ycenter
operator|=
name|ycenter
expr_stmt|;
name|calc
operator|.
name|radius
operator|=
name|radius
expr_stmt|;
name|calc
operator|.
name|rotation
operator|=
name|rotation
operator|*
name|G_PI
operator|/
literal|180.0
expr_stmt|;
name|calc
operator|.
name|hue
operator|=
name|hue
expr_stmt|;
name|calc
operator|.
name|vangle
operator|=
name|vangle
operator|*
name|G_PI
operator|/
literal|180.0
expr_stmt|;
name|calc
operator|.
name|vlength
operator|=
name|radius
operator|*
name|vlength
operator|/
literal|100.0
expr_stmt|;
name|calc
operator|.
name|glow_radius
operator|=
name|radius
operator|*
name|gflare
operator|->
name|glow_size
operator|/
literal|100.0
expr_stmt|;
name|calc
operator|.
name|rays_radius
operator|=
name|radius
operator|*
name|gflare
operator|->
name|rays_size
operator|/
literal|100.0
expr_stmt|;
name|calc
operator|.
name|sflare_radius
operator|=
name|radius
operator|*
name|gflare
operator|->
name|sflare_size
operator|/
literal|100.0
expr_stmt|;
name|calc
operator|.
name|glow_rotation
operator|=
operator|(
name|rotation
operator|+
name|gflare
operator|->
name|glow_rotation
operator|)
operator|*
name|G_PI
operator|/
literal|180.0
expr_stmt|;
name|calc
operator|.
name|rays_rotation
operator|=
operator|(
name|rotation
operator|+
name|gflare
operator|->
name|rays_rotation
operator|)
operator|*
name|G_PI
operator|/
literal|180.0
expr_stmt|;
name|calc
operator|.
name|sflare_rotation
operator|=
operator|(
name|rotation
operator|+
name|gflare
operator|->
name|sflare_rotation
operator|)
operator|*
name|G_PI
operator|/
literal|180.0
expr_stmt|;
name|calc
operator|.
name|glow_opacity
operator|=
name|gflare
operator|->
name|glow_opacity
operator|*
literal|255
operator|/
literal|100.0
expr_stmt|;
name|calc
operator|.
name|rays_opacity
operator|=
name|gflare
operator|->
name|rays_opacity
operator|*
literal|255
operator|/
literal|100.0
expr_stmt|;
name|calc
operator|.
name|sflare_opacity
operator|=
name|gflare
operator|->
name|sflare_opacity
operator|*
literal|255
operator|/
literal|100.0
expr_stmt|;
name|calc
operator|.
name|glow_bounds
operator|.
name|x0
operator|=
name|calc
operator|.
name|xcenter
operator|-
name|calc
operator|.
name|glow_radius
operator|-
literal|0.1
expr_stmt|;
name|calc
operator|.
name|glow_bounds
operator|.
name|x1
operator|=
name|calc
operator|.
name|xcenter
operator|+
name|calc
operator|.
name|glow_radius
operator|+
literal|0.1
expr_stmt|;
name|calc
operator|.
name|glow_bounds
operator|.
name|y0
operator|=
name|calc
operator|.
name|ycenter
operator|-
name|calc
operator|.
name|glow_radius
operator|-
literal|0.1
expr_stmt|;
name|calc
operator|.
name|glow_bounds
operator|.
name|y1
operator|=
name|calc
operator|.
name|ycenter
operator|+
name|calc
operator|.
name|glow_radius
operator|+
literal|0.1
expr_stmt|;
name|calc
operator|.
name|rays_bounds
operator|.
name|x0
operator|=
name|calc
operator|.
name|xcenter
operator|-
name|calc
operator|.
name|rays_radius
operator|-
literal|0.1
expr_stmt|;
name|calc
operator|.
name|rays_bounds
operator|.
name|x1
operator|=
name|calc
operator|.
name|xcenter
operator|+
name|calc
operator|.
name|rays_radius
operator|+
literal|0.1
expr_stmt|;
name|calc
operator|.
name|rays_bounds
operator|.
name|y0
operator|=
name|calc
operator|.
name|ycenter
operator|-
name|calc
operator|.
name|rays_radius
operator|-
literal|0.1
expr_stmt|;
name|calc
operator|.
name|rays_bounds
operator|.
name|y1
operator|=
name|calc
operator|.
name|ycenter
operator|+
name|calc
operator|.
name|rays_radius
operator|+
literal|0.1
expr_stmt|;
comment|/* Thanks to Marcelo Malheiros for this algorithm */
name|calc
operator|.
name|rays_thinness
operator|=
name|log
argument_list|(
name|gflare
operator|->
name|rays_thickness
operator|/
literal|100.0
argument_list|)
operator|/
name|log
argument_list|(
literal|0.8
argument_list|)
expr_stmt|;
name|calc
operator|.
name|rays_spike_mod
operator|=
literal|1.0
operator|/
operator|(
literal|2
operator|*
name|gflare
operator|->
name|rays_nspikes
operator|)
expr_stmt|;
comment|/*     Initialize part of sflare     The rest will be initialized in calc_sflare()    */
name|calc
operator|.
name|sflare_list
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|sflare_shape
operator|=
name|gflare
operator|->
name|sflare_shape
expr_stmt|;
if|if
condition|(
name|calc
operator|.
name|sflare_shape
operator|==
name|GF_POLYGON
condition|)
block|{
name|calc
operator|.
name|sflare_angle
operator|=
literal|2
operator|*
name|G_PI
operator|/
operator|(
literal|2
operator|*
name|gflare
operator|->
name|sflare_nverts
operator|)
expr_stmt|;
name|calc
operator|.
name|sflare_factor
operator|=
literal|1.0
operator|/
name|cos
argument_list|(
name|calc
operator|.
name|sflare_angle
argument_list|)
expr_stmt|;
block|}
name|calc
operator|.
name|glow_radial
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|glow_angular
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|glow_angular_size
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|rays_radial
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|rays_angular
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|rays_angular_size
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|sflare_radial
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|sflare_sizefac
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|sflare_probability
operator|=
name|NULL
expr_stmt|;
name|calc
operator|.
name|init
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|calc_init_progress (void)
name|calc_init_progress
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|calc_sample_one_gradient
argument_list|()
condition|)
return|return
name|TRUE
return|;
name|calc_place_sflare
argument_list|()
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/*    Store samples of gradient into an array    this routine is called during Calc initialization    this code is very messy... :( */
end_comment

begin_function
specifier|static
name|int
DECL|function|calc_sample_one_gradient (void)
name|calc_sample_one_gradient
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
struct|struct
DECL|struct|__anon2b9257990f08
block|{
DECL|member|values
name|guchar
modifier|*
modifier|*
name|values
decl_stmt|;
DECL|member|name_offset
name|gint
name|name_offset
decl_stmt|;
DECL|member|hue_offset
name|gint
name|hue_offset
decl_stmt|;
DECL|member|gray
name|gint
name|gray
decl_stmt|;
block|}
name|table
index|[]
init|=
block|{
block|{
operator|&
name|calc
operator|.
name|glow_radial
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|glow_radial
argument_list|)
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|glow_hue
argument_list|)
block|,
name|FALSE
block|}
block|,
block|{
operator|&
name|calc
operator|.
name|glow_angular
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|glow_angular
argument_list|)
block|,
literal|0
block|,
name|FALSE
block|}
block|,
block|{
operator|&
name|calc
operator|.
name|glow_angular_size
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|glow_angular_size
argument_list|)
block|,
literal|0
block|,
name|TRUE
block|}
block|,
block|{
operator|&
name|calc
operator|.
name|rays_radial
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|rays_radial
argument_list|)
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|rays_hue
argument_list|)
block|,
name|FALSE
block|}
block|,
block|{
operator|&
name|calc
operator|.
name|rays_angular
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|rays_angular
argument_list|)
block|,
literal|0
block|,
name|FALSE
block|}
block|,
block|{
operator|&
name|calc
operator|.
name|rays_angular_size
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|rays_angular_size
argument_list|)
block|,
literal|0
block|,
name|TRUE
block|}
block|,
block|{
operator|&
name|calc
operator|.
name|sflare_radial
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|sflare_radial
argument_list|)
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|sflare_hue
argument_list|)
block|,
name|FALSE
block|}
block|,
block|{
operator|&
name|calc
operator|.
name|sflare_sizefac
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|sflare_sizefac
argument_list|)
block|,
literal|0
block|,
name|TRUE
block|}
block|,
block|{
operator|&
name|calc
operator|.
name|sflare_probability
block|,
name|G_STRUCT_OFFSET
argument_list|(
name|GFlare
argument_list|,
name|sflare_probability
argument_list|)
block|,
literal|0
block|,
name|TRUE
block|}
block|}
struct|;
name|GFlare
modifier|*
name|gflare
init|=
name|calc
operator|.
name|gflare
decl_stmt|;
name|GradientName
modifier|*
name|grad_name
decl_stmt|;
name|guchar
modifier|*
name|gradient
decl_stmt|;
name|gdouble
name|hue_deg
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|,
name|hue
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|G_N_ELEMENTS
argument_list|(
name|table
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|table
index|[
name|i
index|]
operator|.
name|values
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* @GRADIENT_NAME */
name|grad_name
operator|=
operator|(
name|GradientName
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|gflare
operator|+
name|table
index|[
name|i
index|]
operator|.
name|name_offset
operator|)
expr_stmt|;
name|gradient
operator|=
operator|*
operator|(
name|table
index|[
name|i
index|]
operator|.
name|values
operator|)
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
literal|4
operator|*
name|GRADIENT_RESOLUTION
argument_list|)
expr_stmt|;
name|gradient_get_values
argument_list|(
operator|*
name|grad_name
argument_list|,
name|gradient
argument_list|,
name|GRADIENT_RESOLUTION
argument_list|)
expr_stmt|;
comment|/*            * Do hue rotation, if needed            */
if|if
condition|(
name|table
index|[
name|i
index|]
operator|.
name|hue_offset
operator|!=
literal|0
condition|)
block|{
name|hue_deg
operator|=
name|calc
operator|.
name|hue
operator|+
operator|*
operator|(
name|gdouble
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|gflare
operator|+
name|table
index|[
name|i
index|]
operator|.
name|hue_offset
operator|)
expr_stmt|;
name|hue
operator|=
call|(
name|gint
call|)
argument_list|(
name|hue_deg
operator|/
literal|360.0
operator|*
literal|256.0
argument_list|)
operator|%
literal|256
expr_stmt|;
if|if
condition|(
name|hue
operator|<
literal|0
condition|)
name|hue
operator|+=
literal|256
expr_stmt|;
name|g_assert
argument_list|(
literal|0
operator|<=
name|hue
operator|&&
name|hue
operator|<
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|hue
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|GRADIENT_RESOLUTION
condition|;
name|j
operator|++
control|)
block|{
name|gint
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|r
operator|=
name|gradient
index|[
name|j
operator|*
literal|4
index|]
expr_stmt|;
name|g
operator|=
name|gradient
index|[
name|j
operator|*
literal|4
operator|+
literal|1
index|]
expr_stmt|;
name|b
operator|=
name|gradient
index|[
name|j
operator|*
literal|4
operator|+
literal|2
index|]
expr_stmt|;
name|gimp_rgb_to_hsv_int
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|r
operator|=
operator|(
name|r
operator|+
name|hue
operator|)
operator|%
literal|256
expr_stmt|;
name|gimp_hsv_to_rgb_int
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|gradient
index|[
name|j
operator|*
literal|4
index|]
operator|=
name|r
expr_stmt|;
name|gradient
index|[
name|j
operator|*
literal|4
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|gradient
index|[
name|j
operator|*
literal|4
operator|+
literal|2
index|]
operator|=
name|b
expr_stmt|;
block|}
block|}
block|}
comment|/*            *    Grayfy gradient, if needed            */
if|if
condition|(
name|table
index|[
name|i
index|]
operator|.
name|gray
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|GRADIENT_RESOLUTION
condition|;
name|j
operator|++
control|)
comment|/* the first byte is enough */
name|gradient
index|[
name|j
operator|*
literal|4
index|]
operator|=
name|LUMINOSITY
argument_list|(
operator|(
name|gradient
operator|+
name|j
operator|*
literal|4
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* sampling of one gradient is done */
return|return
name|TRUE
return|;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|calc_place_sflare (void)
name|calc_place_sflare
parameter_list|(
name|void
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
decl_stmt|;
name|CalcSFlare
modifier|*
name|sflare
decl_stmt|;
name|gdouble
name|prob
index|[
name|GRADIENT_RESOLUTION
index|]
decl_stmt|;
name|gdouble
name|sum
decl_stmt|,
name|sum2
decl_stmt|;
name|gdouble
name|pos
decl_stmt|;
name|gdouble
name|rnd
decl_stmt|,
name|sizefac
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int
name|i
decl_stmt|;
name|GRand
modifier|*
name|gr
decl_stmt|;
name|gr
operator|=
name|g_rand_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|calc
operator|.
name|type
operator|&
name|CALC_SFLARE
operator|)
operator|==
literal|0
condition|)
return|return;
name|gflare
operator|=
name|calc
operator|.
name|gflare
expr_stmt|;
comment|/*     Calc cumulative probability     */
name|sum
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GRADIENT_RESOLUTION
condition|;
name|i
operator|++
control|)
block|{
comment|/* probability gradient was grayfied already */
name|prob
index|[
name|i
index|]
operator|=
name|calc
operator|.
name|sflare_probability
index|[
name|i
operator|*
literal|4
index|]
expr_stmt|;
name|sum
operator|+=
name|prob
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|sum
operator|==
literal|0.0
condition|)
name|sum
operator|=
literal|1.0
expr_stmt|;
name|sum2
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GRADIENT_RESOLUTION
condition|;
name|i
operator|++
control|)
block|{
name|sum2
operator|+=
name|prob
index|[
name|i
index|]
expr_stmt|;
comment|/* cumulation */
name|prob
index|[
name|i
index|]
operator|=
name|sum2
operator|/
name|sum
expr_stmt|;
block|}
name|g_rand_set_seed
argument_list|(
name|gr
argument_list|,
name|gflare
operator|->
name|sflare_seed
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|SFLARE_NUM
condition|;
name|n
operator|++
control|)
block|{
name|sflare
operator|=
name|g_new
argument_list|(
name|CalcSFlare
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rnd
operator|=
name|g_rand_double
argument_list|(
name|gr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GRADIENT_RESOLUTION
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|prob
index|[
name|i
index|]
operator|>=
name|rnd
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|GRADIENT_RESOLUTION
condition|)
name|i
operator|=
name|GRADIENT_RESOLUTION
operator|-
literal|1
expr_stmt|;
comment|/* sizefac gradient was grayfied already */
name|sizefac
operator|=
name|calc
operator|.
name|sflare_sizefac
index|[
name|i
operator|*
literal|4
index|]
operator|/
literal|255.0
expr_stmt|;
name|sizefac
operator|=
name|pow
argument_list|(
name|sizefac
argument_list|,
literal|5.0
argument_list|)
expr_stmt|;
name|pos
operator|=
call|(
name|double
call|)
argument_list|(
name|i
operator|-
name|GRADIENT_RESOLUTION
operator|/
literal|2
argument_list|)
operator|/
name|GRADIENT_RESOLUTION
expr_stmt|;
name|sflare
operator|->
name|xcenter
operator|=
name|calc
operator|.
name|xcenter
operator|+
name|cos
argument_list|(
name|calc
operator|.
name|vangle
argument_list|)
operator|*
name|calc
operator|.
name|vlength
operator|*
name|pos
expr_stmt|;
name|sflare
operator|->
name|ycenter
operator|=
name|calc
operator|.
name|ycenter
operator|-
name|sin
argument_list|(
name|calc
operator|.
name|vangle
argument_list|)
operator|*
name|calc
operator|.
name|vlength
operator|*
name|pos
expr_stmt|;
name|sflare
operator|->
name|radius
operator|=
name|sizefac
operator|*
name|calc
operator|.
name|sflare_radius
expr_stmt|;
comment|/* FIXME */
name|sflare
operator|->
name|bounds
operator|.
name|x0
operator|=
name|sflare
operator|->
name|xcenter
operator|-
name|sflare
operator|->
name|radius
operator|-
literal|1
expr_stmt|;
name|sflare
operator|->
name|bounds
operator|.
name|x1
operator|=
name|sflare
operator|->
name|xcenter
operator|+
name|sflare
operator|->
name|radius
operator|+
literal|1
expr_stmt|;
name|sflare
operator|->
name|bounds
operator|.
name|y0
operator|=
name|sflare
operator|->
name|ycenter
operator|-
name|sflare
operator|->
name|radius
operator|-
literal|1
expr_stmt|;
name|sflare
operator|->
name|bounds
operator|.
name|y1
operator|=
name|sflare
operator|->
name|ycenter
operator|+
name|sflare
operator|->
name|radius
operator|+
literal|1
expr_stmt|;
name|calc
operator|.
name|sflare_list
operator|=
name|g_list_append
argument_list|(
name|calc
operator|.
name|sflare_list
argument_list|,
name|sflare
argument_list|)
expr_stmt|;
block|}
name|g_rand_free
argument_list|(
name|gr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|calc_deinit (void)
name|calc_deinit
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|calc
operator|.
name|init
condition|)
block|{
name|g_warning
argument_list|(
literal|"calc_deinit: not initialized"
argument_list|)
expr_stmt|;
return|return;
block|}
name|g_list_foreach
argument_list|(
name|calc
operator|.
name|sflare_list
argument_list|,
operator|(
name|GFunc
operator|)
name|g_free
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_list_free
argument_list|(
name|calc
operator|.
name|sflare_list
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|glow_radial
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|glow_angular
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|glow_angular_size
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|rays_radial
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|rays_angular
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|rays_angular_size
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|sflare_radial
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|sflare_sizefac
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|calc
operator|.
name|sflare_probability
argument_list|)
expr_stmt|;
name|calc
operator|.
name|init
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  Get sample value at specified position of a gradient  *  *  gradient samples are stored into array at the time of  *  calc_sample_one_gradients (), and it is now linear interpolated.  *  *  INPUT:  *      guchar  gradient[4*GRADIENT_RESOLUTION]         gradient array(RGBA)  *      gdouble pos                                     position (0<=pos<=1)  *  OUTPUT:  *      guchar  pix[4]  */
end_comment

begin_function
specifier|static
name|void
DECL|function|calc_get_gradient (guchar * pix,guchar * gradient,gdouble pos)
name|calc_get_gradient
parameter_list|(
name|guchar
modifier|*
name|pix
parameter_list|,
name|guchar
modifier|*
name|gradient
parameter_list|,
name|gdouble
name|pos
parameter_list|)
block|{
name|gint
name|ipos
decl_stmt|;
name|gdouble
name|frac
decl_stmt|;
name|gint
name|i
decl_stmt|;
if|if
condition|(
name|pos
operator|<
literal|0
operator|||
name|pos
operator|>
literal|1
condition|)
block|{
name|pix
index|[
literal|0
index|]
operator|=
name|pix
index|[
literal|1
index|]
operator|=
name|pix
index|[
literal|2
index|]
operator|=
name|pix
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|pos
operator|*=
name|GRADIENT_RESOLUTION
operator|-
literal|1.0001
expr_stmt|;
name|ipos
operator|=
operator|(
name|gint
operator|)
name|pos
expr_stmt|;
name|frac
operator|=
name|pos
operator|-
name|ipos
expr_stmt|;
name|gradient
operator|+=
name|ipos
operator|*
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|pix
index|[
name|i
index|]
operator|=
name|gradient
index|[
name|i
index|]
operator|*
operator|(
literal|1
operator|-
name|frac
operator|)
operator|+
name|gradient
index|[
name|i
operator|+
literal|4
index|]
operator|*
name|frac
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* I need fmod to return always positive value */
end_comment

begin_function
specifier|static
name|gdouble
DECL|function|fmod_positive (gdouble x,gdouble m)
name|fmod_positive
parameter_list|(
name|gdouble
name|x
parameter_list|,
name|gdouble
name|m
parameter_list|)
block|{
return|return
name|x
operator|-
name|floor
argument_list|(
name|x
operator|/
name|m
argument_list|)
operator|*
name|m
return|;
block|}
end_function

begin_comment
comment|/*  *  Calc glow's pixel (RGBA) value  *  INPUT:  *      gdouble x, y                    image coordinates  *  OUTPUT:  *      guchar  pix[4]  */
end_comment

begin_function
specifier|static
name|void
DECL|function|calc_glow_pix (guchar * dest_pix,gdouble x,gdouble y)
name|calc_glow_pix
parameter_list|(
name|guchar
modifier|*
name|dest_pix
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
block|{
name|gdouble
name|radius
decl_stmt|,
name|angle
decl_stmt|;
name|gdouble
name|angular_size
decl_stmt|;
name|guchar
name|radial_pix
index|[
literal|4
index|]
decl_stmt|,
name|angular_pix
index|[
literal|4
index|]
decl_stmt|,
name|size_pix
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|calc
operator|.
name|type
operator|&
name|CALC_GLOW
operator|)
operator|==
literal|0
operator|||
name|x
operator|<
name|calc
operator|.
name|glow_bounds
operator|.
name|x0
operator|||
name|x
operator|>
name|calc
operator|.
name|glow_bounds
operator|.
name|x1
operator|||
name|y
operator|<
name|calc
operator|.
name|glow_bounds
operator|.
name|y0
operator|||
name|y
operator|>
name|calc
operator|.
name|glow_bounds
operator|.
name|y1
condition|)
block|{
name|memset
argument_list|(
name|dest_pix
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return;
block|}
name|x
operator|-=
name|calc
operator|.
name|xcenter
expr_stmt|;
name|y
operator|-=
name|calc
operator|.
name|ycenter
expr_stmt|;
name|radius
operator|=
name|sqrt
argument_list|(
name|x
operator|*
name|x
operator|+
name|y
operator|*
name|y
argument_list|)
operator|/
name|calc
operator|.
name|glow_radius
expr_stmt|;
name|angle
operator|=
operator|(
name|atan2
argument_list|(
operator|-
name|y
argument_list|,
name|x
argument_list|)
operator|+
name|calc
operator|.
name|glow_rotation
operator|)
operator|/
operator|(
literal|2
operator|*
name|G_PI
operator|)
expr_stmt|;
name|angle
operator|=
name|fmod_positive
argument_list|(
name|angle
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|calc_get_gradient
argument_list|(
name|size_pix
argument_list|,
name|calc
operator|.
name|glow_angular_size
argument_list|,
name|angle
argument_list|)
expr_stmt|;
comment|/* angular_size gradient was grayfied already */
name|angular_size
operator|=
name|size_pix
index|[
literal|0
index|]
operator|/
literal|255.0
expr_stmt|;
name|radius
operator|/=
operator|(
name|angular_size
operator|+
literal|0.0001
operator|)
expr_stmt|;
comment|/* in case angular_size == 0.0 */
if|if
condition|(
name|radius
operator|<
literal|0
operator|||
name|radius
operator|>
literal|1
condition|)
block|{
name|memset
argument_list|(
name|dest_pix
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return;
block|}
name|calc_get_gradient
argument_list|(
name|radial_pix
argument_list|,
name|calc
operator|.
name|glow_radial
argument_list|,
name|radius
argument_list|)
expr_stmt|;
name|calc_get_gradient
argument_list|(
name|angular_pix
argument_list|,
name|calc
operator|.
name|glow_angular
argument_list|,
name|angle
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|dest_pix
index|[
name|i
index|]
operator|=
name|radial_pix
index|[
name|i
index|]
operator|*
name|angular_pix
index|[
name|i
index|]
operator|/
literal|255
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  Calc rays's pixel (RGBA) value  *  */
end_comment

begin_function
specifier|static
name|void
DECL|function|calc_rays_pix (guchar * dest_pix,gdouble x,gdouble y)
name|calc_rays_pix
parameter_list|(
name|guchar
modifier|*
name|dest_pix
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|)
block|{
name|gdouble
name|radius
decl_stmt|,
name|angle
decl_stmt|;
name|gdouble
name|angular_size
decl_stmt|;
name|gdouble
name|spike_frac
decl_stmt|,
name|spike_inten
decl_stmt|,
name|spike_angle
decl_stmt|;
name|guchar
name|radial_pix
index|[
literal|4
index|]
decl_stmt|,
name|angular_pix
index|[
literal|4
index|]
decl_stmt|,
name|size_pix
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|calc
operator|.
name|type
operator|&
name|CALC_RAYS
operator|)
operator|==
literal|0
operator|||
name|x
operator|<
name|calc
operator|.
name|rays_bounds
operator|.
name|x0
operator|||
name|x
operator|>
name|calc
operator|.
name|rays_bounds
operator|.
name|x1
operator|||
name|y
operator|<
name|calc
operator|.
name|rays_bounds
operator|.
name|y0
operator|||
name|y
operator|>
name|calc
operator|.
name|rays_bounds
operator|.
name|y1
condition|)
block|{
name|memset
argument_list|(
name|dest_pix
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return;
block|}
name|x
operator|-=
name|calc
operator|.
name|xcenter
expr_stmt|;
name|y
operator|-=
name|calc
operator|.
name|ycenter
expr_stmt|;
name|radius
operator|=
name|sqrt
argument_list|(
name|x
operator|*
name|x
operator|+
name|y
operator|*
name|y
argument_list|)
operator|/
name|calc
operator|.
name|rays_radius
expr_stmt|;
name|angle
operator|=
operator|(
name|atan2
argument_list|(
operator|-
name|y
argument_list|,
name|x
argument_list|)
operator|+
name|calc
operator|.
name|rays_rotation
operator|)
operator|/
operator|(
literal|2
operator|*
name|G_PI
operator|)
expr_stmt|;
name|angle
operator|=
name|fmod_positive
argument_list|(
name|angle
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
comment|/* make sure 0<= angle< 1.0 */
name|spike_frac
operator|=
name|fmod
argument_list|(
name|angle
argument_list|,
name|calc
operator|.
name|rays_spike_mod
operator|*
literal|2
argument_list|)
expr_stmt|;
name|spike_angle
operator|=
name|angle
operator|-
name|spike_frac
operator|+
name|calc
operator|.
name|rays_spike_mod
expr_stmt|;
name|spike_frac
operator|=
operator|(
name|angle
operator|-
name|spike_angle
operator|)
operator|/
name|calc
operator|.
name|rays_spike_mod
expr_stmt|;
comment|/* spike_frac is between -1.0 and 1.0 here (except round error...) */
name|spike_inten
operator|=
name|pow
argument_list|(
literal|1.0
operator|-
name|fabs
argument_list|(
name|spike_frac
argument_list|)
argument_list|,
name|calc
operator|.
name|rays_thinness
argument_list|)
expr_stmt|;
name|calc_get_gradient
argument_list|(
name|size_pix
argument_list|,
name|calc
operator|.
name|rays_angular_size
argument_list|,
name|spike_angle
argument_list|)
expr_stmt|;
comment|/* angular_size gradient was grayfied already */
name|angular_size
operator|=
name|size_pix
index|[
literal|0
index|]
operator|/
literal|255.0
expr_stmt|;
name|radius
operator|/=
operator|(
name|angular_size
operator|+
literal|0.0001
operator|)
expr_stmt|;
comment|/* in case angular_size == 0.0 */
if|if
condition|(
name|radius
operator|<
literal|0
operator|||
name|radius
operator|>
literal|1
condition|)
block|{
name|memset
argument_list|(
name|dest_pix
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return;
block|}
name|calc_get_gradient
argument_list|(
name|radial_pix
argument_list|,
name|calc
operator|.
name|rays_radial
argument_list|,
name|radius
argument_list|)
expr_stmt|;
name|calc_get_gradient
argument_list|(
name|angular_pix
argument_list|,
name|calc
operator|.
name|rays_angular
argument_list|,
name|spike_angle
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|dest_pix
index|[
name|i
index|]
operator|=
name|radial_pix
index|[
name|i
index|]
operator|*
name|angular_pix
index|[
name|i
index|]
operator|/
literal|255
expr_stmt|;
name|dest_pix
index|[
literal|3
index|]
operator|=
name|spike_inten
operator|*
name|radial_pix
index|[
literal|3
index|]
operator|*
name|angular_pix
index|[
literal|3
index|]
operator|/
literal|255
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  Calc sflare's pixel (RGBA) value  *  *  the sflare (second flares) are needed to be rendered one each  *  sequencially, onto the source image, such as like usual layer  *  operations. So the function takes src_pix as argment.  glow, rays  *  routines don't have src_pix as argment, because of convienience.  *  *  @JAPANESE  *  sflare
comment|$B$OJ#?t$N%U%l%"$r=g$K
comment|(B(
comment|$B%l%$%dE*$K
comment|(B)
comment|$B$+$V$;$J$,$iIA2h$9$kI,MW$,
comment|(B  *
comment|$B$"$k$N$G!"$3$l$@$1
comment|(B src_pix
comment|$B$r0z?t$K$H$C$F
comment|(B paint_func
comment|$B$rE,MQ$9$k!#
comment|(B  *  glow, rays
comment|$B$O4J0W2=$N$?$a$K$J$7!#
comment|(B  */
end_comment

begin_function
name|void
DECL|function|calc_sflare_pix (guchar * dest_pix,gdouble x,gdouble y,guchar * src_pix)
name|calc_sflare_pix
parameter_list|(
name|guchar
modifier|*
name|dest_pix
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|guchar
modifier|*
name|src_pix
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|CalcSFlare
modifier|*
name|sflare
decl_stmt|;
name|gdouble
name|sx
decl_stmt|,
name|sy
decl_stmt|,
name|th
decl_stmt|;
name|gdouble
name|radius
decl_stmt|,
name|angle
decl_stmt|;
name|guchar
name|radial_pix
index|[
literal|4
index|]
decl_stmt|,
name|tmp_pix
index|[
literal|4
index|]
decl_stmt|;
name|memcpy
argument_list|(
name|dest_pix
argument_list|,
name|src_pix
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|calc
operator|.
name|type
operator|&
name|CALC_SFLARE
operator|)
operator|==
literal|0
condition|)
return|return;
name|list
operator|=
name|calc
operator|.
name|sflare_list
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|sflare
operator|=
name|list
operator|->
name|data
expr_stmt|;
name|list
operator|=
name|list
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|x
operator|<
name|sflare
operator|->
name|bounds
operator|.
name|x0
operator|||
name|x
operator|>
name|sflare
operator|->
name|bounds
operator|.
name|x1
operator|||
name|y
operator|<
name|sflare
operator|->
name|bounds
operator|.
name|y0
operator|||
name|y
operator|>
name|sflare
operator|->
name|bounds
operator|.
name|y1
condition|)
continue|continue;
name|sx
operator|=
name|x
operator|-
name|sflare
operator|->
name|xcenter
expr_stmt|;
name|sy
operator|=
name|y
operator|-
name|sflare
operator|->
name|ycenter
expr_stmt|;
name|radius
operator|=
name|sqrt
argument_list|(
name|sx
operator|*
name|sx
operator|+
name|sy
operator|*
name|sy
argument_list|)
operator|/
name|sflare
operator|->
name|radius
expr_stmt|;
if|if
condition|(
name|calc
operator|.
name|sflare_shape
operator|==
name|GF_POLYGON
condition|)
block|{
name|angle
operator|=
name|atan2
argument_list|(
operator|-
name|sy
argument_list|,
name|sx
argument_list|)
operator|-
name|calc
operator|.
name|vangle
operator|+
name|calc
operator|.
name|sflare_rotation
expr_stmt|;
name|th
operator|=
name|fmod_positive
argument_list|(
name|angle
argument_list|,
name|calc
operator|.
name|sflare_angle
operator|*
literal|2
argument_list|)
operator|-
name|calc
operator|.
name|sflare_angle
expr_stmt|;
name|radius
operator|*=
name|cos
argument_list|(
name|th
argument_list|)
operator|*
name|calc
operator|.
name|sflare_factor
expr_stmt|;
block|}
if|if
condition|(
name|radius
operator|<
literal|0
operator|||
name|radius
operator|>
literal|1
condition|)
continue|continue;
name|calc_get_gradient
argument_list|(
name|radial_pix
argument_list|,
name|calc
operator|.
name|sflare_radial
argument_list|,
name|radius
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tmp_pix
argument_list|,
name|dest_pix
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|calc_paint_func
argument_list|(
name|dest_pix
argument_list|,
name|tmp_pix
argument_list|,
name|radial_pix
argument_list|,
name|calc
operator|.
name|sflare_opacity
argument_list|,
name|calc
operator|.
name|gflare
operator|->
name|sflare_mode
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|calc_gflare_pix (guchar * dest_pix,gdouble x,gdouble y,guchar * src_pix)
name|calc_gflare_pix
parameter_list|(
name|guchar
modifier|*
name|dest_pix
parameter_list|,
name|gdouble
name|x
parameter_list|,
name|gdouble
name|y
parameter_list|,
name|guchar
modifier|*
name|src_pix
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
init|=
name|calc
operator|.
name|gflare
decl_stmt|;
name|guchar
name|glow_pix
index|[
literal|4
index|]
decl_stmt|,
name|rays_pix
index|[
literal|4
index|]
decl_stmt|;
name|guchar
name|tmp_pix
index|[
literal|4
index|]
decl_stmt|;
name|memcpy
argument_list|(
name|dest_pix
argument_list|,
name|src_pix
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|calc
operator|.
name|type
operator|&
name|CALC_GLOW
condition|)
block|{
name|memcpy
argument_list|(
name|tmp_pix
argument_list|,
name|dest_pix
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|calc_glow_pix
argument_list|(
name|glow_pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|calc_paint_func
argument_list|(
name|dest_pix
argument_list|,
name|tmp_pix
argument_list|,
name|glow_pix
argument_list|,
name|calc
operator|.
name|glow_opacity
argument_list|,
name|gflare
operator|->
name|glow_mode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|calc
operator|.
name|type
operator|&
name|CALC_RAYS
condition|)
block|{
name|memcpy
argument_list|(
name|tmp_pix
argument_list|,
name|dest_pix
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|calc_rays_pix
argument_list|(
name|rays_pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|calc_paint_func
argument_list|(
name|dest_pix
argument_list|,
name|tmp_pix
argument_list|,
name|rays_pix
argument_list|,
name|calc
operator|.
name|rays_opacity
argument_list|,
name|gflare
operator|->
name|rays_mode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|calc
operator|.
name|type
operator|&
name|CALC_SFLARE
condition|)
block|{
name|memcpy
argument_list|(
name|tmp_pix
argument_list|,
name|dest_pix
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|calc_sflare_pix
argument_list|(
name|dest_pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|tmp_pix
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*         Paint func routines, such as Normal, Addition, ...  */
end_comment

begin_function
specifier|static
name|void
DECL|function|calc_paint_func (guchar * dest,guchar * src1,guchar * src2,gint opacity,GFlareMode mode)
name|calc_paint_func
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|,
name|gint
name|opacity
parameter_list|,
name|GFlareMode
name|mode
parameter_list|)
block|{
name|guchar
name|buf
index|[
literal|4
index|]
decl_stmt|,
modifier|*
name|s
init|=
name|buf
decl_stmt|;
if|if
condition|(
name|src2
index|[
literal|3
index|]
operator|==
literal|0
operator|||
name|opacity
operator|<=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|dest
argument_list|,
name|src1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|GF_NORMAL
case|:
name|s
operator|=
name|src2
expr_stmt|;
break|break;
case|case
name|GF_ADDITION
case|:
name|calc_addition
argument_list|(
name|s
argument_list|,
name|src1
argument_list|,
name|src2
argument_list|)
expr_stmt|;
break|break;
case|case
name|GF_OVERLAY
case|:
name|calc_overlay
argument_list|(
name|s
argument_list|,
name|src1
argument_list|,
name|src2
argument_list|)
expr_stmt|;
break|break;
case|case
name|GF_SCREEN
case|:
name|calc_screen
argument_list|(
name|s
argument_list|,
name|src1
argument_list|,
name|src2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|=
name|src2
expr_stmt|;
break|break;
block|}
name|calc_combine
argument_list|(
name|dest
argument_list|,
name|src1
argument_list|,
name|s
argument_list|,
name|opacity
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|calc_combine (guchar * dest,guchar * src1,guchar * src2,gint opacity)
name|calc_combine
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|,
name|gint
name|opacity
parameter_list|)
block|{
name|gdouble
name|s1_a
decl_stmt|,
name|s2_a
decl_stmt|,
name|new_a
decl_stmt|;
name|gdouble
name|ratio
decl_stmt|,
name|compl_ratio
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|s1_a
operator|=
name|src1
index|[
literal|3
index|]
operator|/
literal|255.0
expr_stmt|;
name|s2_a
operator|=
name|src2
index|[
literal|3
index|]
operator|*
name|opacity
operator|/
literal|65025.0
expr_stmt|;
name|new_a
operator|=
name|s1_a
operator|+
operator|(
literal|1.0
operator|-
name|s1_a
operator|)
operator|*
name|s2_a
expr_stmt|;
if|if
condition|(
name|new_a
operator|!=
literal|0.0
condition|)
name|ratio
operator|=
name|s2_a
operator|/
name|new_a
expr_stmt|;
else|else
name|ratio
operator|=
literal|0.0
expr_stmt|;
name|compl_ratio
operator|=
literal|1.0
operator|-
name|ratio
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|dest
index|[
name|i
index|]
operator|=
name|src1
index|[
name|i
index|]
operator|*
name|compl_ratio
operator|+
name|src2
index|[
name|i
index|]
operator|*
name|ratio
expr_stmt|;
name|dest
index|[
literal|3
index|]
operator|=
name|new_a
operator|*
literal|255.0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|calc_addition (guchar * dest,guchar * src1,guchar * src2)
name|calc_addition
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|)
block|{
name|gint
name|tmp
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|src1
index|[
name|i
index|]
operator|+
name|src2
index|[
name|i
index|]
expr_stmt|;
name|dest
index|[
name|i
index|]
operator|=
name|tmp
operator|<=
literal|255
condition|?
name|tmp
else|:
literal|255
expr_stmt|;
block|}
name|dest
index|[
literal|3
index|]
operator|=
name|MIN
argument_list|(
name|src1
index|[
literal|3
index|]
argument_list|,
name|src2
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|calc_screen (guchar * dest,guchar * src1,guchar * src2)
name|calc_screen
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|dest
index|[
name|i
index|]
operator|=
literal|255
operator|-
operator|(
operator|(
literal|255
operator|-
name|src1
index|[
name|i
index|]
operator|)
operator|*
operator|(
literal|255
operator|-
name|src2
index|[
name|i
index|]
operator|)
operator|)
operator|/
literal|255
expr_stmt|;
block|}
name|dest
index|[
literal|3
index|]
operator|=
name|MIN
argument_list|(
name|src1
index|[
literal|3
index|]
argument_list|,
name|src2
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|calc_overlay (guchar * dest,guchar * src1,guchar * src2)
name|calc_overlay
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|guchar
modifier|*
name|src1
parameter_list|,
name|guchar
modifier|*
name|src2
parameter_list|)
block|{
name|gint
name|screen
decl_stmt|,
name|mult
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|screen
operator|=
literal|255
operator|-
operator|(
operator|(
literal|255
operator|-
name|src1
index|[
name|i
index|]
operator|)
operator|*
operator|(
literal|255
operator|-
name|src2
index|[
name|i
index|]
operator|)
operator|)
operator|/
literal|255
expr_stmt|;
name|mult
operator|=
operator|(
name|src1
index|[
name|i
index|]
operator|*
name|src2
index|[
name|i
index|]
operator|)
operator|/
literal|255
expr_stmt|;
name|dest
index|[
name|i
index|]
operator|=
operator|(
name|screen
operator|*
name|src1
index|[
name|i
index|]
operator|+
name|mult
operator|*
operator|(
literal|255
operator|-
name|src1
index|[
name|i
index|]
operator|)
operator|)
operator|/
literal|255
expr_stmt|;
block|}
name|dest
index|[
literal|3
index|]
operator|=
name|MIN
argument_list|(
name|src1
index|[
literal|3
index|]
argument_list|,
name|src2
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**                     Main Dialog                                     **/
end_comment

begin_comment
comment|/**                     +++ dlg                                         **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/*         This is gflare main dialog, one which opens in first.  */
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|dlg_run (void)
name|dlg_run
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|shell
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|abox
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|notebook
decl_stmt|;
name|gboolean
name|run
init|=
name|FALSE
decl_stmt|;
name|gimp_ui_init
argument_list|(
name|PLUG_IN_BINARY
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/*    *    Init Main Dialog    */
name|dlg
operator|=
name|g_new0
argument_list|(
name|GFlareDialog
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dlg
operator|->
name|init
operator|=
name|TRUE
expr_stmt|;
name|dlg
operator|->
name|update_preview
operator|=
name|TRUE
expr_stmt|;
name|gradient_menu_init
argument_list|()
expr_stmt|;
comment|/* FIXME: this should go elsewhere  */
name|dlg_setup_gflare
argument_list|()
expr_stmt|;
name|g_assert
argument_list|(
name|gflares_list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|dlg
operator|->
name|gflare
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|g_assert
argument_list|(
name|dlg
operator|->
name|gflare
operator|->
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/*    *    Dialog Shell    */
name|shell
operator|=
name|dlg
operator|->
name|shell
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Gradient Flare"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PLUG_IN_PROC
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|GTK_STOCK_OK
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|shell
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*    *    main hbox    */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|hbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|shell
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*    *    Preview    */
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|abox
operator|=
name|gtk_alignment_new
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|abox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|abox
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|abox
argument_list|)
argument_list|,
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|dlg
operator|->
name|preview
operator|=
name|preview_new
argument_list|(
name|DLG_PREVIEW_WIDTH
argument_list|,
name|DLG_PREVIEW_HEIGHT
argument_list|,
name|dlg_preview_init_func
argument_list|,
name|NULL
argument_list|,
name|dlg_preview_render_func
argument_list|,
name|NULL
argument_list|,
name|dlg_preview_deinit_func
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|GTK_WIDGET
argument_list|(
name|dlg
operator|->
name|preview
operator|->
name|widget
argument_list|)
argument_list|,
name|DLG_PREVIEW_MASK
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|dlg
operator|->
name|preview
operator|->
name|widget
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
operator|->
name|preview
operator|->
name|widget
argument_list|,
literal|"realize"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_preview_realize
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
operator|->
name|preview
operator|->
name|widget
argument_list|,
literal|"event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_preview_handle_event
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dlg_preview_calc_window
argument_list|()
expr_stmt|;
name|button
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"A_uto update preview"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|dlg
operator|->
name|update_preview
argument_list|)
expr_stmt|;
name|gtk_box_pack_end
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_update_preview_callback
argument_list|)
argument_list|,
operator|&
name|dlg
operator|->
name|update_preview
argument_list|)
expr_stmt|;
comment|/*    *    Notebook    */
name|notebook
operator|=
name|dlg
operator|->
name|notebook
operator|=
name|gtk_notebook_new
argument_list|()
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|notebook
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|dlg_make_page_settings
argument_list|(
name|dlg
argument_list|,
name|notebook
argument_list|)
expr_stmt|;
name|dlg_make_page_selector
argument_list|(
name|dlg
argument_list|,
name|notebook
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
argument_list|)
expr_stmt|;
comment|/*    *    Initialization done    */
name|dlg
operator|->
name|init
operator|=
name|FALSE
expr_stmt|;
name|dlg_preview_update
argument_list|()
expr_stmt|;
if|if
condition|(
name|gimp_dialog_run
argument_list|(
name|GIMP_DIALOG
argument_list|(
name|shell
argument_list|)
argument_list|)
operator|==
name|GTK_RESPONSE_OK
condition|)
block|{
name|gflare_name_copy
argument_list|(
name|pvals
operator|.
name|gflare_name
argument_list|,
name|dlg
operator|->
name|gflare
operator|->
name|name
argument_list|)
expr_stmt|;
name|run
operator|=
name|TRUE
expr_stmt|;
block|}
name|gtk_widget_destroy
argument_list|(
name|shell
argument_list|)
expr_stmt|;
return|return
name|run
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_setup_gflare (void)
name|dlg_setup_gflare
parameter_list|(
name|void
parameter_list|)
block|{
name|dlg
operator|->
name|gflare
operator|=
name|gflares_list_lookup
argument_list|(
name|pvals
operator|.
name|gflare_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dlg
operator|->
name|gflare
condition|)
block|{
name|dlg
operator|->
name|gflare
operator|=
name|gflares_list_lookup
argument_list|(
literal|"Default"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dlg
operator|->
name|gflare
condition|)
block|{
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"`Default' is created."
argument_list|)
argument_list|)
expr_stmt|;
name|dlg
operator|->
name|gflare
operator|=
name|gflare_new_with_default
argument_list|(
name|_
argument_list|(
literal|"Default"
argument_list|)
argument_list|)
expr_stmt|;
name|gflares_list_insert
argument_list|(
name|dlg
operator|->
name|gflare
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/***********************************/
end_comment

begin_comment
comment|/**     Main Dialog / Preview     **/
end_comment

begin_comment
comment|/***********************************/
end_comment

begin_comment
comment|/*  *      Calculate preview's window, ie. translation of preview widget and  *      drawable.  *  *      x0, x1, y0, y1 are drawable coord, corresponding with top left  *      corner of preview widget, etc.  */
end_comment

begin_function
name|void
DECL|function|dlg_preview_calc_window (void)
name|dlg_preview_calc_window
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|is_wide
decl_stmt|;
name|gdouble
name|offx
decl_stmt|,
name|offy
decl_stmt|;
name|is_wide
operator|=
operator|(
operator|(
name|double
operator|)
name|DLG_PREVIEW_HEIGHT
operator|*
name|drawable
operator|->
name|width
operator|>=
operator|(
name|double
operator|)
name|DLG_PREVIEW_WIDTH
operator|*
name|drawable
operator|->
name|height
operator|)
expr_stmt|;
if|if
condition|(
name|is_wide
condition|)
block|{
name|offy
operator|=
operator|(
operator|(
name|double
operator|)
name|drawable
operator|->
name|width
operator|*
name|DLG_PREVIEW_HEIGHT
operator|/
name|DLG_PREVIEW_WIDTH
operator|)
operator|/
literal|2.0
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|x0
operator|=
literal|0
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|x1
operator|=
name|drawable
operator|->
name|width
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|y0
operator|=
name|drawable
operator|->
name|height
operator|/
literal|2.0
operator|-
name|offy
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|y1
operator|=
name|drawable
operator|->
name|height
operator|/
literal|2.0
operator|+
name|offy
expr_stmt|;
block|}
else|else
block|{
name|offx
operator|=
operator|(
operator|(
name|double
operator|)
name|drawable
operator|->
name|height
operator|*
name|DLG_PREVIEW_WIDTH
operator|/
name|DLG_PREVIEW_HEIGHT
operator|)
operator|/
literal|2.0
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|x0
operator|=
name|drawable
operator|->
name|width
operator|/
literal|2.0
operator|-
name|offx
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|x1
operator|=
name|drawable
operator|->
name|width
operator|/
literal|2.0
operator|+
name|offx
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|y0
operator|=
literal|0
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|y1
operator|=
name|drawable
operator|->
name|height
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
DECL|function|ed_preview_calc_window (void)
name|ed_preview_calc_window
parameter_list|(
name|void
parameter_list|)
block|{
name|gint
name|is_wide
decl_stmt|;
name|gdouble
name|offx
decl_stmt|,
name|offy
decl_stmt|;
name|is_wide
operator|=
operator|(
operator|(
name|double
operator|)
name|DLG_PREVIEW_HEIGHT
operator|*
name|drawable
operator|->
name|width
operator|>=
operator|(
name|double
operator|)
name|DLG_PREVIEW_WIDTH
operator|*
name|drawable
operator|->
name|height
operator|)
expr_stmt|;
if|if
condition|(
name|is_wide
condition|)
block|{
name|offy
operator|=
operator|(
operator|(
name|double
operator|)
name|drawable
operator|->
name|width
operator|*
name|DLG_PREVIEW_HEIGHT
operator|/
name|DLG_PREVIEW_WIDTH
operator|)
operator|/
literal|2.0
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|x0
operator|=
literal|0
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|x1
operator|=
name|drawable
operator|->
name|width
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|y0
operator|=
name|drawable
operator|->
name|height
operator|/
literal|2.0
operator|-
name|offy
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|y1
operator|=
name|drawable
operator|->
name|height
operator|/
literal|2.0
operator|+
name|offy
expr_stmt|;
block|}
else|else
block|{
name|offx
operator|=
operator|(
operator|(
name|double
operator|)
name|drawable
operator|->
name|height
operator|*
name|DLG_PREVIEW_WIDTH
operator|/
name|DLG_PREVIEW_HEIGHT
operator|)
operator|/
literal|2.0
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|x0
operator|=
name|drawable
operator|->
name|width
operator|/
literal|2.0
operator|-
name|offx
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|x1
operator|=
name|drawable
operator|->
name|width
operator|/
literal|2.0
operator|+
name|offx
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|y0
operator|=
literal|0
expr_stmt|;
name|dlg
operator|->
name|pwin
operator|.
name|y1
operator|=
name|drawable
operator|->
name|height
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_preview_realize (GtkWidget * widget)
name|dlg_preview_realize
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|)
block|{
name|GdkDisplay
modifier|*
name|display
init|=
name|gtk_widget_get_display
argument_list|(
name|widget
argument_list|)
decl_stmt|;
name|GdkCursor
modifier|*
name|cursor
init|=
name|gdk_cursor_new_for_display
argument_list|(
name|display
argument_list|,
name|GDK_CROSSHAIR
argument_list|)
decl_stmt|;
name|gdk_window_set_cursor
argument_list|(
name|gtk_widget_get_window
argument_list|(
name|widget
argument_list|)
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|gdk_cursor_unref
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|dlg_preview_handle_event (GtkWidget * widget,GdkEvent * event)
name|dlg_preview_handle_event
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GdkEvent
modifier|*
name|event
parameter_list|)
block|{
name|GdkEventButton
modifier|*
name|bevent
decl_stmt|;
name|gint
name|bx
decl_stmt|,
name|by
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|type
condition|)
block|{
case|case
name|GDK_BUTTON_PRESS
case|:
name|bevent
operator|=
operator|(
name|GdkEventButton
operator|*
operator|)
name|event
expr_stmt|;
name|bx
operator|=
name|bevent
operator|->
name|x
expr_stmt|;
name|by
operator|=
name|bevent
operator|->
name|y
expr_stmt|;
comment|/* convert widget coord to drawable coord */
name|x
operator|=
name|dlg
operator|->
name|pwin
operator|.
name|x0
operator|+
call|(
name|double
call|)
argument_list|(
name|dlg
operator|->
name|pwin
operator|.
name|x1
operator|-
name|dlg
operator|->
name|pwin
operator|.
name|x0
argument_list|)
operator|*
name|bx
operator|/
name|DLG_PREVIEW_WIDTH
expr_stmt|;
name|y
operator|=
name|dlg
operator|->
name|pwin
operator|.
name|y0
operator|+
call|(
name|double
call|)
argument_list|(
name|dlg
operator|->
name|pwin
operator|.
name|y1
operator|-
name|dlg
operator|->
name|pwin
operator|.
name|y0
argument_list|)
operator|*
name|by
operator|/
name|DLG_PREVIEW_HEIGHT
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|!=
name|pvals
operator|.
name|xcenter
operator|||
name|y
operator|!=
name|pvals
operator|.
name|ycenter
operator|)
condition|)
block|{
if|if
condition|(
name|x
operator|!=
name|pvals
operator|.
name|xcenter
condition|)
block|{
name|pvals
operator|.
name|xcenter
operator|=
name|x
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|dlg
operator|->
name|sizeentry
argument_list|)
argument_list|,
literal|0
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|y
operator|!=
name|pvals
operator|.
name|ycenter
condition|)
block|{
name|pvals
operator|.
name|ycenter
operator|=
name|y
expr_stmt|;
name|gimp_size_entry_set_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|dlg
operator|->
name|sizeentry
argument_list|)
argument_list|,
literal|1
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
name|dlg_preview_update
argument_list|()
expr_stmt|;
block|}
return|return
name|TRUE
return|;
default|default:
break|break;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_preview_update (void)
name|dlg_preview_update
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|dlg
operator|->
name|init
operator|&&
name|dlg
operator|->
name|update_preview
condition|)
block|{
name|dlg
operator|->
name|init_params_done
operator|=
name|FALSE
expr_stmt|;
name|preview_render_start
argument_list|(
name|dlg
operator|->
name|preview
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*      preview callbacks       */
end_comment

begin_function
specifier|static
name|gint
DECL|function|dlg_preview_init_func (Preview * preview,gpointer data)
name|dlg_preview_init_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
comment|/* call init_params first, and iterate init_progress while      it returns true */
if|if
condition|(
name|dlg
operator|->
name|init_params_done
operator|==
name|FALSE
condition|)
block|{
name|calc_init_params
argument_list|(
name|dlg
operator|->
name|gflare
argument_list|,
name|CALC_GLOW
operator||
name|CALC_RAYS
operator||
name|CALC_SFLARE
argument_list|,
name|pvals
operator|.
name|xcenter
argument_list|,
name|pvals
operator|.
name|ycenter
argument_list|,
name|pvals
operator|.
name|radius
argument_list|,
name|pvals
operator|.
name|rotation
argument_list|,
name|pvals
operator|.
name|hue
argument_list|,
name|pvals
operator|.
name|vangle
argument_list|,
name|pvals
operator|.
name|vlength
argument_list|)
expr_stmt|;
name|dlg
operator|->
name|init_params_done
operator|=
name|TRUE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|calc_init_progress
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/* render preview    do what "preview" means, ie. render lense flare effect onto drawable */
end_comment

begin_function
specifier|static
name|void
DECL|function|dlg_preview_render_func (Preview * preview,guchar * dest,gint y,gpointer data)
name|dlg_preview_render_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|guchar
modifier|*
name|dest
parameter_list|,
name|gint
name|y
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpPixelRgn
name|srcPR
decl_stmt|;
name|gint
name|x
decl_stmt|;
name|gint
name|dx
decl_stmt|,
name|dy
decl_stmt|;
comment|/* drawable x, y */
name|guchar
modifier|*
name|src_row
decl_stmt|,
modifier|*
name|src
decl_stmt|;
name|guchar
name|src_pix
index|[
literal|4
index|]
decl_stmt|,
name|dest_pix
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|b
decl_stmt|;
name|dy
operator|=
operator|(
name|dlg
operator|->
name|pwin
operator|.
name|y0
operator|+
call|(
name|gdouble
call|)
argument_list|(
name|dlg
operator|->
name|pwin
operator|.
name|y1
operator|-
name|dlg
operator|->
name|pwin
operator|.
name|y0
argument_list|)
operator|*
name|y
operator|/
name|DLG_PREVIEW_HEIGHT
operator|)
expr_stmt|;
if|if
condition|(
name|dy
operator|<
literal|0
operator|||
name|dy
operator|>=
name|drawable
operator|->
name|height
condition|)
block|{
name|memset
argument_list|(
name|dest
argument_list|,
name|GRAY50
argument_list|,
literal|3
operator|*
name|DLG_PREVIEW_WIDTH
argument_list|)
expr_stmt|;
return|return;
block|}
name|src_row
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|drawable
operator|->
name|bpp
operator|*
name|drawable
operator|->
name|width
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_init
argument_list|(
operator|&
name|srcPR
argument_list|,
name|drawable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drawable
operator|->
name|width
argument_list|,
name|drawable
operator|->
name|height
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gimp_pixel_rgn_get_row
argument_list|(
operator|&
name|srcPR
argument_list|,
name|src_row
argument_list|,
literal|0
argument_list|,
name|dy
argument_list|,
name|drawable
operator|->
name|width
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|DLG_PREVIEW_HEIGHT
condition|;
name|x
operator|++
control|)
block|{
name|dx
operator|=
operator|(
name|dlg
operator|->
name|pwin
operator|.
name|x0
operator|+
call|(
name|double
call|)
argument_list|(
name|dlg
operator|->
name|pwin
operator|.
name|x1
operator|-
name|dlg
operator|->
name|pwin
operator|.
name|x0
argument_list|)
operator|*
name|x
operator|/
name|DLG_PREVIEW_WIDTH
operator|)
expr_stmt|;
if|if
condition|(
name|dx
operator|<
literal|0
operator|||
name|dx
operator|>=
name|drawable
operator|->
name|width
condition|)
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
operator|*
name|dest
operator|++
operator|=
name|GRAY50
expr_stmt|;
continue|continue;
block|}
comment|/* Get drawable pix value */
name|src
operator|=
operator|&
name|src_row
index|[
name|dx
operator|*
name|drawable
operator|->
name|bpp
index|]
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
name|src_pix
index|[
name|b
index|]
operator|=
name|dinfo
operator|.
name|is_color
condition|?
name|src
index|[
name|b
index|]
else|:
name|src
index|[
literal|0
index|]
expr_stmt|;
name|src_pix
index|[
literal|3
index|]
operator|=
name|dinfo
operator|.
name|has_alpha
condition|?
name|src
index|[
name|drawable
operator|->
name|bpp
operator|-
literal|1
index|]
else|:
name|OPAQUE
expr_stmt|;
comment|/* Get GFlare pix value */
name|calc_gflare_pix
argument_list|(
name|dest_pix
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|src_pix
argument_list|)
expr_stmt|;
comment|/* Draw gray check if needed */
name|preview_rgba_to_rgb
argument_list|(
name|dest
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|dest_pix
argument_list|)
expr_stmt|;
name|dest
operator|+=
literal|3
expr_stmt|;
block|}
name|g_free
argument_list|(
name|src_row
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_preview_deinit_func (Preview * preview,gpointer data)
name|dlg_preview_deinit_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
name|dlg
operator|->
name|init_params_done
condition|)
block|{
name|calc_deinit
argument_list|()
expr_stmt|;
name|dlg
operator|->
name|init_params_done
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************/
end_comment

begin_comment
comment|/**     Main Dialog / Settings Page     **/
end_comment

begin_comment
comment|/*****************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|dlg_make_page_settings (GFlareDialog * dlg,GtkWidget * notebook)
name|dlg_make_page_settings
parameter_list|(
name|GFlareDialog
modifier|*
name|dlg
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|main_vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|center
decl_stmt|;
name|GtkWidget
modifier|*
name|chain
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|GtkWidget
modifier|*
name|asup_table
decl_stmt|;
name|GtkObject
modifier|*
name|adj
decl_stmt|;
name|gdouble
name|xres
decl_stmt|,
name|yres
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|main_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Center"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|gimp_image_get_resolution
argument_list|(
name|image_ID
argument_list|,
operator|&
name|xres
argument_list|,
operator|&
name|yres
argument_list|)
expr_stmt|;
name|center
operator|=
name|dlg
operator|->
name|sizeentry
operator|=
name|gimp_coordinates_new
argument_list|(
name|gimp_image_get_unit
argument_list|(
name|image_ID
argument_list|)
argument_list|,
literal|"%a"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|75
argument_list|,
name|GIMP_SIZE_ENTRY_UPDATE_SIZE
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|_
argument_list|(
literal|"_X:"
argument_list|)
argument_list|,
name|pvals
operator|.
name|xcenter
argument_list|,
name|xres
argument_list|,
operator|-
name|GIMP_MAX_IMAGE_SIZE
argument_list|,
name|GIMP_MAX_IMAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|gimp_drawable_width
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"_Y:"
argument_list|)
argument_list|,
name|pvals
operator|.
name|ycenter
argument_list|,
name|yres
argument_list|,
operator|-
name|GIMP_MAX_IMAGE_SIZE
argument_list|,
name|GIMP_MAX_IMAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|gimp_drawable_height
argument_list|(
name|drawable
operator|->
name|drawable_id
argument_list|)
argument_list|)
expr_stmt|;
name|chain
operator|=
name|GTK_WIDGET
argument_list|(
name|GIMP_COORDINATES_CHAINBUTTON
argument_list|(
name|center
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|center
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|center
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_position_entry_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|center
argument_list|,
literal|"refval-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_position_entry_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_hide
argument_list|(
name|chain
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|center
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Parameters"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|5
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"_Radius:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|pvals
operator|.
name|radius
argument_list|,
literal|0.0
argument_list|,
name|drawable
operator|->
name|width
operator|/
literal|2
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
literal|0.0
argument_list|,
name|GIMP_MAX_IMAGE_SIZE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|pvals
operator|.
name|radius
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Ro_tation:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|pvals
operator|.
name|rotation
argument_list|,
operator|-
literal|180.0
argument_list|,
literal|180.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|pvals
operator|.
name|rotation
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"_Hue rotation:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|pvals
operator|.
name|hue
argument_list|,
operator|-
literal|180.0
argument_list|,
literal|180.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|pvals
operator|.
name|hue
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Vector _angle:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|pvals
operator|.
name|vangle
argument_list|,
literal|0.0
argument_list|,
literal|359.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|pvals
operator|.
name|vangle
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Vector _length:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|pvals
operator|.
name|vlength
argument_list|,
literal|1
argument_list|,
literal|1000
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
literal|1
argument_list|,
name|GIMP_MAX_IMAGE_SIZE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|pvals
operator|.
name|vlength
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/**   ***   Asupsample settings   ***   This code is stolen from gimp-0.99.x/app/blend.c   **/
comment|/*  asupsample frame */
name|frame
operator|=
name|dlg
operator|->
name|asupsample_frame
operator|=
name|gimp_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|main_vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|button
operator|=
name|gtk_check_button_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"A_daptive supersampling"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|button
argument_list|)
argument_list|,
name|pvals
operator|.
name|use_asupsample
argument_list|)
expr_stmt|;
name|gtk_frame_set_label_widget
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|button
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|asup_table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|asup_table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|asup_table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|asup_table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|asup_table
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|asup_table
argument_list|,
name|pvals
operator|.
name|use_asupsample
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|button
argument_list|)
argument_list|,
literal|"set_sensitive"
argument_list|,
name|asup_table
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_toggle_button_update
argument_list|)
argument_list|,
operator|&
name|pvals
operator|.
name|use_asupsample
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|asup_table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"_Max depth:"
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
literal|4
argument_list|,
name|pvals
operator|.
name|asupsample_max_depth
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1.0
argument_list|,
literal|1.0
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|pvals
operator|.
name|asupsample_max_depth
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|asup_table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"_Threshold"
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
literal|4
argument_list|,
name|pvals
operator|.
name|asupsample_threshold
argument_list|,
literal|0.0
argument_list|,
literal|4.0
argument_list|,
literal|0.01
argument_list|,
literal|0.01
argument_list|,
literal|2
argument_list|,
name|TRUE
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|pvals
operator|.
name|asupsample_threshold
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|main_vbox
argument_list|,
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Settings"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|main_vbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_position_entry_callback (GtkWidget * widget,gpointer data)
name|dlg_position_entry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|x
operator|=
name|RINT
argument_list|(
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|y
operator|=
name|RINT
argument_list|(
name|gimp_size_entry_get_refval
argument_list|(
name|GIMP_SIZE_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUG_PRINT
argument_list|(
operator|(
literal|"dlg_position_entry_callback\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pvals
operator|.
name|xcenter
operator|!=
name|x
operator|||
name|pvals
operator|.
name|ycenter
operator|!=
name|y
condition|)
block|{
name|pvals
operator|.
name|xcenter
operator|=
name|x
expr_stmt|;
name|pvals
operator|.
name|ycenter
operator|=
name|y
expr_stmt|;
name|dlg_preview_update
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_update_preview_callback (GtkWidget * widget,gpointer data)
name|dlg_update_preview_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gimp_toggle_button_update
argument_list|(
name|widget
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|dlg_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************/
end_comment

begin_comment
comment|/**     Main Dialog / Selector Page     **/
end_comment

begin_comment
comment|/*****************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|dlg_make_page_selector (GFlareDialog * dlg,GtkWidget * notebook)
name|dlg_make_page_selector
parameter_list|(
name|GFlareDialog
modifier|*
name|dlg
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|listbox
decl_stmt|;
name|GtkListStore
modifier|*
name|list
decl_stmt|;
name|GtkWidget
modifier|*
name|listview
decl_stmt|;
name|GtkCellRenderer
modifier|*
name|renderer
decl_stmt|;
name|GtkTreeViewColumn
modifier|*
name|column
decl_stmt|;
name|GtkWidget
modifier|*
name|button
decl_stmt|;
name|gint
name|i
decl_stmt|;
specifier|static
struct|struct
DECL|struct|__anon2b9257991008
block|{
DECL|member|label
specifier|const
name|gchar
modifier|*
name|label
decl_stmt|;
DECL|member|callback
name|GCallback
name|callback
decl_stmt|;
block|}
name|buttons
index|[]
init|=
block|{
block|{
name|GTK_STOCK_NEW
block|,
name|G_CALLBACK
argument_list|(
argument|dlg_selector_new_callback
argument_list|)
block|}
block|,
block|{
name|GTK_STOCK_EDIT
block|,
name|G_CALLBACK
argument_list|(
argument|dlg_selector_edit_callback
argument_list|)
block|}
block|,
block|{
name|GTK_STOCK_COPY
block|,
name|G_CALLBACK
argument_list|(
argument|dlg_selector_copy_callback
argument_list|)
block|}
block|,
block|{
name|GTK_STOCK_DELETE
block|,
name|G_CALLBACK
argument_list|(
argument|dlg_selector_delete_callback
argument_list|)
block|}
block|}
struct|;
name|DEBUG_PRINT
argument_list|(
operator|(
literal|"dlg_make_page_selector\n"
operator|)
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
comment|/*    *    List Box    */
name|listbox
operator|=
name|gtk_scrolled_window_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_scrolled_window_set_policy
argument_list|(
name|GTK_SCROLLED_WINDOW
argument_list|(
name|listbox
argument_list|)
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|,
name|GTK_POLICY_AUTOMATIC
argument_list|)
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|listbox
argument_list|,
name|DLG_LISTBOX_WIDTH
argument_list|,
name|DLG_LISTBOX_HEIGHT
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|listbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|list
operator|=
name|dlg
operator|->
name|selector_list
operator|=
name|gtk_list_store_new
argument_list|(
literal|2
argument_list|,
name|G_TYPE_STRING
argument_list|,
name|G_TYPE_POINTER
argument_list|)
expr_stmt|;
name|listview
operator|=
name|gtk_tree_view_new_with_model
argument_list|(
name|GTK_TREE_MODEL
argument_list|(
name|list
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_tree_view_set_headers_visible
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|listview
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|listbox
argument_list|)
argument_list|,
name|listview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|listbox
argument_list|)
expr_stmt|;
name|dlg
operator|->
name|selection
operator|=
name|gtk_tree_view_get_selection
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|listview
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_tree_selection_set_mode
argument_list|(
name|dlg
operator|->
name|selection
argument_list|,
name|GTK_SELECTION_BROWSE
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|listview
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
operator|->
name|selection
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_selector_list_item_callback
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|renderer
operator|=
name|gtk_cell_renderer_text_new
argument_list|()
expr_stmt|;
comment|/* Note: the title isn't shown, so it doesn't need to be translated. */
name|column
operator|=
name|gtk_tree_view_column_new_with_attributes
argument_list|(
literal|"GFlare"
argument_list|,
name|renderer
argument_list|,
literal|"text"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_tree_view_append_column
argument_list|(
name|GTK_TREE_VIEW
argument_list|(
name|listview
argument_list|)
argument_list|,
name|column
argument_list|)
expr_stmt|;
name|dlg_selector_setup_listbox
argument_list|()
expr_stmt|;
comment|/*    *    The buttons for the possible listbox operations    */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|G_N_ELEMENTS
argument_list|(
name|buttons
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|button
operator|=
name|gtk_button_new_from_stock
argument_list|(
name|buttons
index|[
name|i
index|]
operator|.
name|label
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|button
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|button
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|button
argument_list|,
literal|"clicked"
argument_list|,
name|buttons
index|[
name|i
index|]
operator|.
name|callback
argument_list|,
name|button
argument_list|)
expr_stmt|;
block|}
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"S_elector"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *      Set up selector's listbox, according to gflares_list  */
end_comment

begin_function
specifier|static
name|void
DECL|function|dlg_selector_setup_listbox (void)
name|dlg_selector_setup_listbox
parameter_list|(
name|void
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|GFlare
modifier|*
name|gflare
decl_stmt|;
name|gint
name|n
decl_stmt|;
name|list
operator|=
name|gflares_list
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|list
condition|)
block|{
name|GtkTreeIter
name|iter
decl_stmt|;
name|gflare
operator|=
name|list
operator|->
name|data
expr_stmt|;
comment|/*         dlg->gflare should be valid (ie. not NULL) here.         */
name|gtk_list_store_append
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|,
operator|&
name|iter
argument_list|,
literal|0
argument_list|,
name|gflare
operator|->
name|name
argument_list|,
literal|1
argument_list|,
name|gflare
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|gflare
operator|==
name|dlg
operator|->
name|gflare
condition|)
name|gtk_tree_selection_select_iter
argument_list|(
name|dlg
operator|->
name|selection
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|list
operator|=
name|list
operator|->
name|next
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_selector_list_item_callback (GtkTreeSelection * selection)
name|dlg_selector_list_item_callback
parameter_list|(
name|GtkTreeSelection
modifier|*
name|selection
parameter_list|)
block|{
name|GtkTreeIter
name|iter
decl_stmt|;
if|if
condition|(
name|gtk_tree_selection_get_selected
argument_list|(
name|selection
argument_list|,
name|NULL
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
block|{
name|gtk_tree_model_get
argument_list|(
name|GTK_TREE_MODEL
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|,
literal|1
argument_list|,
operator|&
name|dlg
operator|->
name|gflare
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|dlg_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *      "New" button in Selector page  */
end_comment

begin_function
specifier|static
name|void
DECL|function|dlg_selector_new_callback (GtkWidget * widget,gpointer data)
name|dlg_selector_new_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|query_box
decl_stmt|;
name|query_box
operator|=
name|gimp_query_string_box
argument_list|(
name|_
argument_list|(
literal|"New Gradient Flare"
argument_list|)
argument_list|,
name|gtk_widget_get_toplevel
argument_list|(
name|widget
argument_list|)
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PLUG_IN_PROC
argument_list|,
name|_
argument_list|(
literal|"Enter a name for the new GFlare"
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Unnamed"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|dlg_selector_new_ok_callback
argument_list|,
name|dlg
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_selector_new_ok_callback (GtkWidget * widget,const gchar * new_name,gpointer data)
name|dlg_selector_new_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
specifier|const
name|gchar
modifier|*
name|new_name
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|gint
name|pos
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|new_name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|gflares_list_lookup
argument_list|(
name|new_name
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"The name '%s' is used already!"
argument_list|)
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
return|return;
block|}
name|gflare
operator|=
name|gflare_new_with_default
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
name|pos
operator|=
name|gflares_list_insert
argument_list|(
name|gflare
argument_list|)
expr_stmt|;
name|gtk_list_store_insert
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|,
operator|&
name|iter
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|,
operator|&
name|iter
argument_list|,
literal|0
argument_list|,
name|gflare
operator|->
name|name
argument_list|,
literal|1
argument_list|,
name|gflare
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_tree_selection_select_iter
argument_list|(
name|dlg
operator|->
name|selection
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dlg
operator|->
name|gflare
operator|=
name|gflare
expr_stmt|;
name|dlg_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  "Edit" button in Selector page  */
end_comment

begin_function
specifier|static
name|void
DECL|function|dlg_selector_edit_callback (GtkWidget * widget,gpointer data)
name|dlg_selector_edit_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|preview_render_end
argument_list|(
name|dlg
operator|->
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|dlg
operator|->
name|shell
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|ed_run
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
operator|->
name|shell
argument_list|)
argument_list|,
name|dlg
operator|->
name|gflare
argument_list|,
name|dlg_selector_edit_done_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_selector_edit_done_callback (gint updated,gpointer data)
name|dlg_selector_edit_done_callback
parameter_list|(
name|gint
name|updated
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gtk_widget_set_sensitive
argument_list|(
name|dlg
operator|->
name|shell
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|updated
condition|)
block|{
name|gflare_save
argument_list|(
name|dlg
operator|->
name|gflare
argument_list|)
expr_stmt|;
block|}
name|dlg_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  "Copy" button in Selector page  */
end_comment

begin_function
specifier|static
name|void
DECL|function|dlg_selector_copy_callback (GtkWidget * widget,gpointer data)
name|dlg_selector_copy_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|query_box
decl_stmt|;
name|gchar
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|g_strdup_printf
argument_list|(
literal|"%s copy"
argument_list|,
name|dlg
operator|->
name|gflare
operator|->
name|name
argument_list|)
expr_stmt|;
name|query_box
operator|=
name|gimp_query_string_box
argument_list|(
name|_
argument_list|(
literal|"Copy Gradient Flare"
argument_list|)
argument_list|,
name|gtk_widget_get_toplevel
argument_list|(
name|widget
argument_list|)
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PLUG_IN_PROC
argument_list|,
name|_
argument_list|(
literal|"Enter a name for the copied GFlare"
argument_list|)
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|dlg_selector_copy_ok_callback
argument_list|,
name|dlg
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|query_box
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_selector_copy_ok_callback (GtkWidget * widget,const gchar * copy_name,gpointer data)
name|dlg_selector_copy_ok_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
specifier|const
name|gchar
modifier|*
name|copy_name
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|gint
name|pos
decl_stmt|;
name|g_return_if_fail
argument_list|(
name|copy_name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|gflares_list_lookup
argument_list|(
name|copy_name
argument_list|)
condition|)
block|{
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"The name `%s' is used already!"
argument_list|)
argument_list|,
name|copy_name
argument_list|)
expr_stmt|;
return|return;
block|}
name|gflare
operator|=
name|gflare_dup
argument_list|(
name|dlg
operator|->
name|gflare
argument_list|,
name|copy_name
argument_list|)
expr_stmt|;
name|pos
operator|=
name|gflares_list_insert
argument_list|(
name|gflare
argument_list|)
expr_stmt|;
name|gtk_list_store_insert
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|,
operator|&
name|iter
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|,
operator|&
name|iter
argument_list|,
literal|0
argument_list|,
name|gflare
operator|->
name|name
argument_list|,
literal|1
argument_list|,
name|gflare
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_tree_selection_select_iter
argument_list|(
name|dlg
operator|->
name|selection
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dlg
operator|->
name|gflare
operator|=
name|gflare
expr_stmt|;
name|gflare_save
argument_list|(
name|dlg
operator|->
name|gflare
argument_list|)
expr_stmt|;
name|dlg_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *      "Delete" button in Selector page  */
end_comment

begin_function
specifier|static
name|void
DECL|function|dlg_selector_delete_callback (GtkWidget * widget,gpointer data)
name|dlg_selector_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|gchar
modifier|*
name|str
decl_stmt|;
if|if
condition|(
name|num_gflares
operator|<=
literal|1
condition|)
block|{
name|g_message
argument_list|(
name|_
argument_list|(
literal|"Cannot delete!! There must be at least one GFlare."
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|gtk_widget_set_sensitive
argument_list|(
name|dlg
operator|->
name|shell
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|str
operator|=
name|g_strdup_printf
argument_list|(
name|_
argument_list|(
literal|"Are you sure you want to delete "
literal|"\"%s\" from the list and from disk?"
argument_list|)
argument_list|,
name|dlg
operator|->
name|gflare
operator|->
name|name
argument_list|)
expr_stmt|;
name|dialog
operator|=
name|gimp_query_boolean_box
argument_list|(
name|_
argument_list|(
literal|"Delete Gradient Flare"
argument_list|)
argument_list|,
name|dlg
operator|->
name|shell
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PLUG_IN_PROC
argument_list|,
name|GTK_STOCK_DIALOG_QUESTION
argument_list|,
name|str
argument_list|,
name|GTK_STOCK_DELETE
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|dlg_selector_do_delete_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|dlg_selector_do_delete_callback (GtkWidget * widget,gboolean delete,gpointer data)
name|dlg_selector_do_delete_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gboolean
name|delete
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GFlare
modifier|*
name|old_gflare
decl_stmt|;
name|GList
modifier|*
name|tmp
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|new_i
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|dlg
operator|->
name|shell
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|delete
condition|)
return|return;
name|i
operator|=
name|gflares_list_index
argument_list|(
name|dlg
operator|->
name|gflare
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
block|{
comment|/* Remove current gflare from gflares_list and free it */
name|old_gflare
operator|=
name|dlg
operator|->
name|gflare
expr_stmt|;
name|gflares_list_remove
argument_list|(
name|dlg
operator|->
name|gflare
argument_list|)
expr_stmt|;
name|dlg
operator|->
name|gflare
operator|=
name|NULL
expr_stmt|;
comment|/* Remove from listbox */
if|if
condition|(
operator|!
name|gtk_tree_model_iter_nth_child
argument_list|(
name|GTK_TREE_MODEL
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|,
name|NULL
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unsynchronized lists. Bad things will happen!"
argument_list|)
expr_stmt|;
return|return;
block|}
name|gtk_list_store_remove
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
comment|/* Calculate new position of gflare and select it */
name|new_i
operator|=
operator|(
name|i
operator|<
name|num_gflares
operator|)
condition|?
name|i
else|:
name|num_gflares
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|=
name|g_list_nth
argument_list|(
name|gflares_list
argument_list|,
name|new_i
argument_list|)
operator|)
condition|)
name|dlg
operator|->
name|gflare
operator|=
name|tmp
operator|->
name|data
expr_stmt|;
if|if
condition|(
operator|!
name|gtk_tree_model_iter_nth_child
argument_list|(
name|GTK_TREE_MODEL
argument_list|(
name|dlg
operator|->
name|selector_list
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|,
name|NULL
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|g_warning
argument_list|(
literal|"Unsynchronized lists. Bad things will happen!"
argument_list|)
expr_stmt|;
return|return;
block|}
name|gtk_tree_selection_select_iter
argument_list|(
name|dlg
operator|->
name|selection
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
comment|/* Delete old one from disk and memory */
if|if
condition|(
name|old_gflare
operator|->
name|filename
condition|)
name|g_unlink
argument_list|(
name|old_gflare
operator|->
name|filename
argument_list|)
expr_stmt|;
name|gflare_free
argument_list|(
name|old_gflare
argument_list|)
expr_stmt|;
comment|/* Update */
name|dlg_preview_update
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|g_warning
argument_list|(
name|_
argument_list|(
literal|"not found %s in gflares_list"
argument_list|)
argument_list|,
name|dlg
operator|->
name|gflare
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**                     GFlare Editor                                   **/
end_comment

begin_comment
comment|/**                     +++ ed                                          **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/*         This is gflare editor dilaog, one which opens by clicking         "Edit" button on the selector page in the main dialog.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|ed_run (GtkWindow * parent,GFlare * target_gflare,GFlareEditorCallback callback,gpointer calldata)
name|ed_run
parameter_list|(
name|GtkWindow
modifier|*
name|parent
parameter_list|,
name|GFlare
modifier|*
name|target_gflare
parameter_list|,
name|GFlareEditorCallback
name|callback
parameter_list|,
name|gpointer
name|calldata
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|shell
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|abox
decl_stmt|;
name|GtkWidget
modifier|*
name|notebook
decl_stmt|;
if|if
condition|(
operator|!
name|ed
condition|)
name|ed
operator|=
name|g_new0
argument_list|(
name|GFlareEditor
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ed
operator|->
name|init
operator|=
name|TRUE
expr_stmt|;
name|ed
operator|->
name|run
operator|=
name|FALSE
expr_stmt|;
name|ed
operator|->
name|target_gflare
operator|=
name|target_gflare
expr_stmt|;
name|ed
operator|->
name|gflare
operator|=
name|gflare_dup
argument_list|(
name|target_gflare
argument_list|,
name|target_gflare
operator|->
name|name
argument_list|)
expr_stmt|;
name|ed
operator|->
name|callback
operator|=
name|callback
expr_stmt|;
name|ed
operator|->
name|calldata
operator|=
name|calldata
expr_stmt|;
comment|/*    *    Dialog Shell    */
name|ed
operator|->
name|shell
operator|=
name|shell
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Gradient Flare Editor"
argument_list|)
argument_list|,
name|PLUG_IN_BINARY
argument_list|,
name|GTK_WIDGET
argument_list|(
name|parent
argument_list|)
argument_list|,
literal|0
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|PLUG_IN_PROC
argument_list|,
name|_
argument_list|(
literal|"Rescan Gradients"
argument_list|)
argument_list|,
name|RESPONSE_RESCAN
argument_list|,
name|GTK_STOCK_CANCEL
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|GTK_STOCK_OK
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_dialog_set_alternative_button_order
argument_list|(
name|GTK_DIALOG
argument_list|(
name|shell
argument_list|)
argument_list|,
name|RESPONSE_RESCAN
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|shell
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_response
argument_list|)
argument_list|,
name|ed
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|shell
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_destroy_callback
argument_list|)
argument_list|,
name|ed
argument_list|)
expr_stmt|;
comment|/*    *    main hbox    */
name|hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|hbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|shell
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
comment|/*    *    Preview    */
name|abox
operator|=
name|gtk_alignment_new
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|abox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|abox
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|gtk_frame_set_shadow_type
argument_list|(
name|GTK_FRAME
argument_list|(
name|frame
argument_list|)
argument_list|,
name|GTK_SHADOW_IN
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|abox
argument_list|)
argument_list|,
name|frame
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|ed
operator|->
name|preview
operator|=
name|preview_new
argument_list|(
name|ED_PREVIEW_WIDTH
argument_list|,
name|ED_PREVIEW_HEIGHT
argument_list|,
name|ed_preview_init_func
argument_list|,
name|NULL
argument_list|,
name|ed_preview_render_func
argument_list|,
name|NULL
argument_list|,
name|ed_preview_deinit_func
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_set_events
argument_list|(
name|GTK_WIDGET
argument_list|(
name|ed
operator|->
name|preview
operator|->
name|widget
argument_list|)
argument_list|,
name|DLG_PREVIEW_MASK
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|ed
operator|->
name|preview
operator|->
name|widget
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|ed
operator|->
name|preview
operator|->
name|widget
argument_list|,
literal|"event"
argument_list|,
name|G_CALLBACK
argument_list|(
name|dlg_preview_handle_event
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ed_preview_calc_window
argument_list|()
expr_stmt|;
comment|/*    *    Notebook    */
name|notebook
operator|=
name|ed
operator|->
name|notebook
operator|=
name|gtk_notebook_new
argument_list|()
expr_stmt|;
name|gtk_notebook_set_tab_pos
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|GTK_POS_TOP
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|notebook
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|notebook
argument_list|)
expr_stmt|;
name|ed_make_page_general
argument_list|(
name|ed
argument_list|,
name|notebook
argument_list|)
expr_stmt|;
name|ed_make_page_glow
argument_list|(
name|ed
argument_list|,
name|notebook
argument_list|)
expr_stmt|;
name|ed_make_page_rays
argument_list|(
name|ed
argument_list|,
name|notebook
argument_list|)
expr_stmt|;
name|ed_make_page_sflare
argument_list|(
name|ed
argument_list|,
name|notebook
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shell
argument_list|)
expr_stmt|;
name|ed
operator|->
name|init
operator|=
name|FALSE
expr_stmt|;
name|ed_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_destroy_callback (GtkWidget * widget,GFlareEditor * ed)
name|ed_destroy_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|GFlareEditor
modifier|*
name|ed
parameter_list|)
block|{
name|preview_free
argument_list|(
name|ed
operator|->
name|preview
argument_list|)
expr_stmt|;
name|gflare_free
argument_list|(
name|ed
operator|->
name|gflare
argument_list|)
expr_stmt|;
if|if
condition|(
name|ed
operator|->
name|callback
condition|)
call|(
modifier|*
name|ed
operator|->
name|callback
call|)
argument_list|(
name|ed
operator|->
name|run
argument_list|,
name|ed
operator|->
name|calldata
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_response (GtkWidget * widget,gint response_id,GFlareEditor * ed)
name|ed_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|GFlareEditor
modifier|*
name|ed
parameter_list|)
block|{
switch|switch
condition|(
name|response_id
condition|)
block|{
case|case
name|RESPONSE_RESCAN
case|:
name|ed
operator|->
name|init
operator|=
name|TRUE
expr_stmt|;
name|gradient_menu_rescan
argument_list|()
expr_stmt|;
name|ed
operator|->
name|init
operator|=
name|FALSE
expr_stmt|;
name|ed_preview_update
argument_list|()
expr_stmt|;
name|gtk_widget_queue_draw
argument_list|(
name|ed
operator|->
name|notebook
argument_list|)
expr_stmt|;
break|break;
case|case
name|GTK_RESPONSE_OK
case|:
name|ed
operator|->
name|run
operator|=
name|TRUE
expr_stmt|;
name|gflare_copy
argument_list|(
name|ed
operator|->
name|target_gflare
argument_list|,
name|ed
operator|->
name|gflare
argument_list|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|ed
operator|->
name|shell
argument_list|)
expr_stmt|;
break|break;
default|default:
name|gtk_widget_destroy
argument_list|(
name|ed
operator|->
name|shell
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_make_page_general (GFlareEditor * ed,GtkWidget * notebook)
name|ed_make_page_general
parameter_list|(
name|GFlareEditor
modifier|*
name|ed
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
init|=
name|ed
operator|->
name|gflare
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|combo
decl_stmt|;
name|GtkObject
modifier|*
name|adj
decl_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
comment|/*  Glow  */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Glow Paint Options"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Opacity:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|glow_opacity
argument_list|,
literal|0.0
argument_list|,
literal|100.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|glow_opacity
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|combo
operator|=
name|ed_mode_menu_new
argument_list|(
operator|&
name|gflare
operator|->
name|glow_mode
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Paint mode:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|combo
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  Rays  */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Rays Paint Options"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Opacity:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|rays_opacity
argument_list|,
literal|0.0
argument_list|,
literal|100.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|rays_opacity
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|combo
operator|=
name|ed_mode_menu_new
argument_list|(
operator|&
name|gflare
operator|->
name|rays_mode
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Paint mode:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|combo
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/*  Rays  */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Second Flares Paint Options"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Opacity:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|sflare_opacity
argument_list|,
literal|0.0
argument_list|,
literal|100.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|sflare_opacity
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|combo
operator|=
name|ed_mode_menu_new
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_mode
argument_list|)
expr_stmt|;
name|gimp_table_attach_aligned
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Paint mode:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|combo
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_General"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|vbox
argument_list|,
literal|"map"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_page_map_callback
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|PAGE_GENERAL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_make_page_glow (GFlareEditor * ed,GtkWidget * notebook)
name|ed_make_page_glow
parameter_list|(
name|GFlareEditor
modifier|*
name|ed
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
init|=
name|ed
operator|->
name|gflare
decl_stmt|;
name|GradientMenu
modifier|*
name|gm
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkObject
modifier|*
name|adj
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
comment|/*    *  Gradient Menus    */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Gradients"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|glow_radial
argument_list|,
name|gflare
operator|->
name|glow_radial
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Radial gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|glow_angular
argument_list|,
name|gflare
operator|->
name|glow_angular
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Angular gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|glow_angular_size
argument_list|,
name|gflare
operator|->
name|glow_angular_size
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|_
argument_list|(
literal|"Angular size gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/*    *  Scales    */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Parameters"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Size (%):"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|glow_size
argument_list|,
literal|0.0
argument_list|,
literal|200.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
name|G_MAXINT
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|glow_size
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Rotation:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|glow_rotation
argument_list|,
operator|-
literal|180.0
argument_list|,
literal|180.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|glow_rotation
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Hue rotation:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|glow_hue
argument_list|,
operator|-
literal|180.0
argument_list|,
literal|180.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|glow_hue
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"G_low"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|vbox
argument_list|,
literal|"map"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_page_map_callback
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|PAGE_GLOW
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_make_page_rays (GFlareEditor * ed,GtkWidget * notebook)
name|ed_make_page_rays
parameter_list|(
name|GFlareEditor
modifier|*
name|ed
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
init|=
name|ed
operator|->
name|gflare
decl_stmt|;
name|GradientMenu
modifier|*
name|gm
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkObject
modifier|*
name|adj
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
comment|/*    *  Gradient Menus    */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Gradients"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|rays_radial
argument_list|,
name|gflare
operator|->
name|rays_radial
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Radial gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|rays_angular
argument_list|,
name|gflare
operator|->
name|rays_angular
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Angular gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|rays_angular_size
argument_list|,
name|gflare
operator|->
name|rays_angular_size
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Angular size gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/*    *    Scales    */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Parameters"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|5
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Size (%):"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|rays_size
argument_list|,
literal|0.0
argument_list|,
literal|200.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
name|G_MAXINT
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|rays_size
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Rotation:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|rays_rotation
argument_list|,
operator|-
literal|180.0
argument_list|,
literal|180.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|rays_rotation
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Hue rotation:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|rays_hue
argument_list|,
operator|-
literal|180.0
argument_list|,
literal|180.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|rays_hue
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"# of Spikes:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|rays_nspikes
argument_list|,
literal|1
argument_list|,
literal|300
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|0
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
name|G_MAXINT
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_int_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|rays_nspikes
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Spike thickness:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|rays_thickness
argument_list|,
literal|1.0
argument_list|,
literal|100.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
name|GIMP_MAX_IMAGE_SIZE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|rays_thickness
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Rays"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|vbox
argument_list|,
literal|"map"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_page_map_callback
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|PAGE_RAYS
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_make_page_sflare (GFlareEditor * ed,GtkWidget * notebook)
name|ed_make_page_sflare
parameter_list|(
name|GFlareEditor
modifier|*
name|ed
parameter_list|,
name|GtkWidget
modifier|*
name|notebook
parameter_list|)
block|{
name|GFlare
modifier|*
name|gflare
init|=
name|ed
operator|->
name|gflare
decl_stmt|;
name|GradientMenu
modifier|*
name|gm
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GtkWidget
modifier|*
name|shape_vbox
decl_stmt|;
name|GSList
modifier|*
name|shape_group
init|=
name|NULL
decl_stmt|;
name|GtkWidget
modifier|*
name|polygon_hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|seed_hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|toggle
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|seed
decl_stmt|;
name|GtkWidget
modifier|*
name|entry
decl_stmt|;
name|GtkObject
modifier|*
name|adj
decl_stmt|;
name|gchar
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|gint
name|row
decl_stmt|;
name|vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
comment|/*    *  Gradient Menus    */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Gradients"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|sflare_radial
argument_list|,
name|gflare
operator|->
name|sflare_radial
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Radial gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|sflare_sizefac
argument_list|,
name|gflare
operator|->
name|sflare_sizefac
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"Size factor gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gm
operator|=
name|gradient_menu_new
argument_list|(
operator|(
name|GradientMenuCallback
operator|)
operator|&
name|ed_gradient_menu_callback
argument_list|,
name|gflare
operator|->
name|sflare_probability
argument_list|,
name|gflare
operator|->
name|sflare_probability
argument_list|)
expr_stmt|;
name|ed_put_gradient_menu
argument_list|(
name|table
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|_
argument_list|(
literal|"Probability gradient:"
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/*    *    Scales    */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Parameters"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Size (%):"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|sflare_size
argument_list|,
literal|0.0
argument_list|,
literal|200.0
argument_list|,
literal|1.0
argument_list|,
literal|10.0
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
name|G_MAXINT
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|sflare_size
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Rotation:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|sflare_rotation
argument_list|,
operator|-
literal|180.0
argument_list|,
literal|180.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|sflare_rotation
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adj
operator|=
name|gimp_scale_entry_new
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|0
argument_list|,
name|row
operator|++
argument_list|,
name|_
argument_list|(
literal|"Hue rotation:"
argument_list|)
argument_list|,
name|SCALE_WIDTH
argument_list|,
literal|6
argument_list|,
name|gflare
operator|->
name|sflare_hue
argument_list|,
operator|-
literal|180.0
argument_list|,
literal|180.0
argument_list|,
literal|1.0
argument_list|,
literal|15.0
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gimp_double_adjustment_update
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|sflare_hue
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|adj
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|/*    *    Shape Radio Button Frame    */
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Shape of Second Flares"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|shape_vbox
operator|=
name|gtk_vbox_new
argument_list|(
name|FALSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|shape_vbox
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|shape_vbox
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|gtk_radio_button_new_with_label
argument_list|(
name|shape_group
argument_list|,
name|_
argument_list|(
literal|"Circle"
argument_list|)
argument_list|)
expr_stmt|;
name|shape_group
operator|=
name|gtk_radio_button_get_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"gimp-item-data"
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|GF_CIRCLE
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_shape_radio_callback
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|sflare_shape
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|gflare
operator|->
name|sflare_shape
operator|==
name|GF_CIRCLE
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|shape_vbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|polygon_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|shape_vbox
argument_list|)
argument_list|,
name|polygon_hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|polygon_hbox
argument_list|)
expr_stmt|;
name|toggle
operator|=
name|ed
operator|->
name|polygon_toggle
operator|=
name|gtk_radio_button_new_with_label
argument_list|(
name|shape_group
argument_list|,
name|_
argument_list|(
literal|"Polygon"
argument_list|)
argument_list|)
expr_stmt|;
name|shape_group
operator|=
name|gtk_radio_button_get_group
argument_list|(
name|GTK_RADIO_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"gimp-item-data"
argument_list|,
name|GINT_TO_POINTER
argument_list|(
name|GF_POLYGON
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|toggle
argument_list|,
literal|"toggled"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_shape_radio_callback
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|sflare_shape
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|toggle
argument_list|)
argument_list|,
name|gflare
operator|->
name|sflare_shape
operator|==
name|GF_POLYGON
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|polygon_hbox
argument_list|)
argument_list|,
name|toggle
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|entry
operator|=
name|ed
operator|->
name|polygon_entry
operator|=
name|gtk_entry_new
argument_list|()
expr_stmt|;
name|gtk_entry_set_width_chars
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|g_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|gflare
operator|->
name|sflare_nverts
argument_list|)
expr_stmt|;
name|gtk_entry_set_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|entry
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|entry
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_ientry_callback
argument_list|)
argument_list|,
operator|&
name|gflare
operator|->
name|sflare_nverts
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|polygon_hbox
argument_list|)
argument_list|,
name|entry
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|entry
argument_list|,
name|gflare
operator|->
name|sflare_shape
operator|==
name|GF_POLYGON
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|toggle
argument_list|)
argument_list|,
literal|"set_sensitive"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
comment|/*    *    Random Seed Entry    */
name|seed_hbox
operator|=
name|gtk_hbox_new
argument_list|(
name|FALSE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|seed_hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|seed_hbox
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Random seed:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|seed_hbox
argument_list|)
argument_list|,
name|label
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|seed
operator|=
name|gimp_random_seed_new
argument_list|(
operator|&
name|gflare
operator|->
name|sflare_seed
argument_list|,
operator|&
name|gflare
operator|->
name|random_seed
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|seed_hbox
argument_list|)
argument_list|,
name|seed
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|seed
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|GIMP_RANDOM_SEED_SPINBUTTON_ADJ
argument_list|(
name|seed
argument_list|)
argument_list|,
literal|"value-changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_preview_update
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_notebook_append_page
argument_list|(
name|GTK_NOTEBOOK
argument_list|(
name|notebook
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|gtk_label_new_with_mnemonic
argument_list|(
name|_
argument_list|(
literal|"_Second Flares"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|vbox
argument_list|,
literal|"map"
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_page_map_callback
argument_list|)
argument_list|,
operator|(
name|gpointer
operator|)
name|PAGE_SFLARE
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GtkWidget
modifier|*
DECL|function|ed_mode_menu_new (GFlareMode * mode_var)
name|ed_mode_menu_new
parameter_list|(
name|GFlareMode
modifier|*
name|mode_var
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|combo
init|=
name|gimp_int_combo_box_new_array
argument_list|(
name|GF_NUM_MODES
argument_list|,
name|gflare_menu_modes
argument_list|)
decl_stmt|;
name|gimp_int_combo_box_connect
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|combo
argument_list|)
argument_list|,
operator|*
name|mode_var
argument_list|,
name|G_CALLBACK
argument_list|(
name|ed_mode_menu_callback
argument_list|)
argument_list|,
name|mode_var
argument_list|)
expr_stmt|;
return|return
name|combo
return|;
block|}
end_function

begin_comment
comment|/*   puts gradient menu with caption into table   occupies 1 row and 3 cols in table  */
end_comment

begin_function
specifier|static
name|void
DECL|function|ed_put_gradient_menu (GtkWidget * table,gint x,gint y,const gchar * caption,GradientMenu * gm)
name|ed_put_gradient_menu
parameter_list|(
name|GtkWidget
modifier|*
name|table
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
specifier|const
name|gchar
modifier|*
name|caption
parameter_list|,
name|GradientMenu
modifier|*
name|gm
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|caption
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1.0
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
name|x
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
argument_list|,
name|y
operator|+
literal|1
argument_list|,
name|GTK_FILL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|gm
operator|->
name|preview
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|x
operator|+
literal|2
argument_list|,
name|y
argument_list|,
name|y
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|gm
operator|->
name|combo
argument_list|,
name|x
operator|+
literal|2
argument_list|,
name|x
operator|+
literal|3
argument_list|,
name|y
argument_list|,
name|y
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_mode_menu_callback (GtkWidget * widget,gpointer data)
name|ed_mode_menu_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gimp_int_combo_box_get_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|,
operator|(
name|gint
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
name|ed_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_gradient_menu_callback (const gchar * gradient_name,gpointer data)
name|ed_gradient_menu_callback
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gchar
modifier|*
name|dest_string
init|=
name|data
decl_stmt|;
comment|/* @GRADIENT_NAME */
name|gradient_name_copy
argument_list|(
name|dest_string
argument_list|,
name|gradient_name
argument_list|)
expr_stmt|;
name|ed_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_shape_radio_callback (GtkWidget * widget,gpointer data)
name|ed_shape_radio_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gimp_radio_button_update
argument_list|(
name|widget
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|ed_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_ientry_callback (GtkWidget * widget,gpointer data)
name|ed_ientry_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gint
name|new_val
decl_stmt|;
name|new_val
operator|=
name|atoi
argument_list|(
name|gtk_entry_get_text
argument_list|(
name|GTK_ENTRY
argument_list|(
name|widget
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|gint
operator|*
operator|)
name|data
operator|=
name|new_val
expr_stmt|;
name|ed_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   NOTE: This is hack, because this code depends on internal "map"   signal of changing pages of gtknotebook.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|ed_page_map_callback (GtkWidget * widget,gpointer data)
name|ed_page_map_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gint
name|page_num
init|=
name|GPOINTER_TO_INT
argument_list|(
name|data
argument_list|)
decl_stmt|;
name|DEBUG_PRINT
argument_list|(
operator|(
literal|"ed_page_map_callback\n"
operator|)
argument_list|)
expr_stmt|;
name|ed
operator|->
name|cur_page
operator|=
name|page_num
expr_stmt|;
name|ed_preview_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_preview_update (void)
name|ed_preview_update
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|ed
operator|->
name|init
condition|)
return|return;
name|ed
operator|->
name|init_params_done
operator|=
name|FALSE
expr_stmt|;
name|preview_render_start
argument_list|(
name|ed
operator|->
name|preview
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|ed_preview_init_func (Preview * preview,gpointer data)
name|ed_preview_init_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
name|type
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ed
operator|->
name|init_params_done
operator|==
name|FALSE
condition|)
block|{
switch|switch
condition|(
name|ed
operator|->
name|cur_page
condition|)
block|{
case|case
name|PAGE_GENERAL
case|:
name|type
operator|=
operator|(
name|CALC_GLOW
operator||
name|CALC_RAYS
operator||
name|CALC_SFLARE
operator|)
expr_stmt|;
break|break;
case|case
name|PAGE_GLOW
case|:
name|type
operator|=
name|CALC_GLOW
expr_stmt|;
break|break;
case|case
name|PAGE_RAYS
case|:
name|type
operator|=
name|CALC_RAYS
expr_stmt|;
break|break;
case|case
name|PAGE_SFLARE
case|:
name|type
operator|=
name|CALC_SFLARE
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"ed_preview_edit_func: bad page"
argument_list|)
expr_stmt|;
break|break;
block|}
name|calc_init_params
argument_list|(
name|ed
operator|->
name|gflare
argument_list|,
name|type
argument_list|,
name|ED_PREVIEW_WIDTH
operator|/
literal|2
argument_list|,
name|ED_PREVIEW_HEIGHT
operator|/
literal|2
argument_list|,
name|ED_PREVIEW_WIDTH
operator|/
literal|2
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|pvals
operator|.
name|vangle
argument_list|,
name|pvals
operator|.
name|vlength
argument_list|)
expr_stmt|;
name|ed
operator|->
name|init_params_done
operator|=
name|TRUE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|calc_init_progress
argument_list|()
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_preview_deinit_func (Preview * preview,gpointer data)
name|ed_preview_deinit_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
if|if
condition|(
name|ed
operator|->
name|init_params_done
condition|)
block|{
name|calc_deinit
argument_list|()
expr_stmt|;
name|ed
operator|->
name|init_params_done
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_preview_render_func (Preview * preview,guchar * buffer,gint y,gpointer data)
name|ed_preview_render_func
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|,
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
switch|switch
condition|(
name|ed
operator|->
name|cur_page
condition|)
block|{
case|case
name|PAGE_GENERAL
case|:
name|ed_preview_render_general
argument_list|(
name|buffer
argument_list|,
name|y
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAGE_GLOW
case|:
name|ed_preview_render_glow
argument_list|(
name|buffer
argument_list|,
name|y
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAGE_RAYS
case|:
name|ed_preview_render_rays
argument_list|(
name|buffer
argument_list|,
name|y
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAGE_SFLARE
case|:
name|ed_preview_render_sflare
argument_list|(
name|buffer
argument_list|,
name|y
argument_list|)
expr_stmt|;
break|break;
default|default:
name|g_warning
argument_list|(
literal|"hmm, bad page in ed_preview_render_func ()"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_preview_render_general (guchar * buffer,gint y)
name|ed_preview_render_general
parameter_list|(
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|i
decl_stmt|;
name|guchar
name|gflare_pix
index|[
literal|4
index|]
decl_stmt|;
specifier|static
name|guchar
name|src_pix
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|OPAQUE
block|}
decl_stmt|;
name|int
name|gflare_a
decl_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|ED_PREVIEW_WIDTH
condition|;
name|x
operator|++
control|)
block|{
name|calc_gflare_pix
argument_list|(
name|gflare_pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|src_pix
argument_list|)
expr_stmt|;
name|gflare_a
operator|=
name|gflare_pix
index|[
literal|3
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|buffer
operator|++
operator|=
name|gflare_pix
index|[
name|i
index|]
operator|*
name|gflare_a
operator|/
literal|255
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_preview_render_glow (guchar * buffer,gint y)
name|ed_preview_render_glow
parameter_list|(
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|i
decl_stmt|;
name|guchar
name|pix
index|[
literal|4
index|]
decl_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|ED_PREVIEW_WIDTH
condition|;
name|x
operator|++
control|)
block|{
name|calc_glow_pix
argument_list|(
name|pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
operator|*
name|buffer
operator|++
operator|=
name|pix
index|[
name|i
index|]
operator|*
name|pix
index|[
literal|3
index|]
operator|/
literal|255
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_preview_render_rays (guchar * buffer,gint y)
name|ed_preview_render_rays
parameter_list|(
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|i
decl_stmt|;
name|guchar
name|pix
index|[
literal|4
index|]
decl_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|ED_PREVIEW_WIDTH
condition|;
name|x
operator|++
control|)
block|{
name|calc_rays_pix
argument_list|(
name|pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
operator|*
name|buffer
operator|++
operator|=
name|pix
index|[
name|i
index|]
operator|*
name|pix
index|[
literal|3
index|]
operator|/
literal|255
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ed_preview_render_sflare (guchar * buffer,gint y)
name|ed_preview_render_sflare
parameter_list|(
name|guchar
modifier|*
name|buffer
parameter_list|,
name|gint
name|y
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|i
decl_stmt|;
name|guchar
name|pix
index|[
literal|4
index|]
decl_stmt|;
specifier|static
name|guchar
name|src_pix
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|OPAQUE
block|}
decl_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|ED_PREVIEW_WIDTH
condition|;
name|x
operator|++
control|)
block|{
name|calc_sflare_pix
argument_list|(
name|pix
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|src_pix
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
operator|*
name|buffer
operator|++
operator|=
name|pix
index|[
name|i
index|]
operator|*
name|pix
index|[
literal|3
index|]
operator|/
literal|255
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**                     +++ Preview                                     **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/*         this is generic preview routines.  */
end_comment

begin_comment
comment|/*     Routines to render the preview in background  */
end_comment

begin_function
specifier|static
name|Preview
modifier|*
DECL|function|preview_new (gint width,gint height,PreviewInitFunc init_func,gpointer init_data,PreviewRenderFunc render_func,gpointer render_data,PreviewDeinitFunc deinit_func,gpointer deinit_data)
name|preview_new
parameter_list|(
name|gint
name|width
parameter_list|,
name|gint
name|height
parameter_list|,
name|PreviewInitFunc
name|init_func
parameter_list|,
name|gpointer
name|init_data
parameter_list|,
name|PreviewRenderFunc
name|render_func
parameter_list|,
name|gpointer
name|render_data
parameter_list|,
name|PreviewDeinitFunc
name|deinit_func
parameter_list|,
name|gpointer
name|deinit_data
parameter_list|)
block|{
name|Preview
modifier|*
name|preview
decl_stmt|;
name|preview
operator|=
name|g_new0
argument_list|(
name|Preview
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|preview
operator|->
name|widget
operator|=
name|gimp_preview_area_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|preview
operator|->
name|widget
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|preview
operator|->
name|widget
argument_list|)
expr_stmt|;
name|preview
operator|->
name|width
operator|=
name|width
expr_stmt|;
name|preview
operator|->
name|height
operator|=
name|height
expr_stmt|;
name|preview
operator|->
name|init_func
operator|=
name|init_func
expr_stmt|;
name|preview
operator|->
name|init_data
operator|=
name|init_data
expr_stmt|;
name|preview
operator|->
name|render_func
operator|=
name|render_func
expr_stmt|;
name|preview
operator|->
name|render_data
operator|=
name|render_data
expr_stmt|;
name|preview
operator|->
name|deinit_func
operator|=
name|deinit_func
expr_stmt|;
name|preview
operator|->
name|deinit_data
operator|=
name|deinit_data
expr_stmt|;
name|preview
operator|->
name|idle_tag
operator|=
literal|0
expr_stmt|;
name|preview
operator|->
name|buffer
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|width
operator|*
literal|3
argument_list|)
expr_stmt|;
name|preview
operator|->
name|full_image_buffer
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|width
operator|*
name|height
operator|*
literal|3
argument_list|)
expr_stmt|;
return|return
name|preview
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|preview_free (Preview * preview)
name|preview_free
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
block|{
name|preview_render_end
argument_list|(
name|preview
argument_list|)
expr_stmt|;
comment|/* not destroy preview->widget */
name|g_free
argument_list|(
name|preview
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|preview
operator|->
name|full_image_buffer
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|preview
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   Start rendering of the preview in background using an idle event.   If already started and not yet finished, stop it first.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|preview_render_start (Preview * preview)
name|preview_render_start
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
block|{
name|preview_render_end
argument_list|(
name|preview
argument_list|)
expr_stmt|;
name|preview
operator|->
name|init_done
operator|=
name|FALSE
expr_stmt|;
name|preview
operator|->
name|current_y
operator|=
literal|0
expr_stmt|;
name|preview
operator|->
name|drawn_y
operator|=
literal|0
expr_stmt|;
name|preview
operator|->
name|timeout_tag
operator|=
name|g_timeout_add
argument_list|(
literal|100
argument_list|,
operator|(
name|GSourceFunc
operator|)
name|preview_render_start_2
argument_list|,
name|preview
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gint
DECL|function|preview_render_start_2 (Preview * preview)
name|preview_render_start_2
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
block|{
name|preview
operator|->
name|timeout_tag
operator|=
literal|0
expr_stmt|;
name|preview
operator|->
name|idle_tag
operator|=
name|g_idle_add
argument_list|(
operator|(
name|GSourceFunc
operator|)
name|preview_handle_idle
argument_list|,
name|preview
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|preview_render_end (Preview * preview)
name|preview_render_end
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
block|{
if|if
condition|(
name|preview
operator|->
name|timeout_tag
operator|>
literal|0
condition|)
block|{
name|g_source_remove
argument_list|(
name|preview
operator|->
name|timeout_tag
argument_list|)
expr_stmt|;
name|preview
operator|->
name|timeout_tag
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|preview
operator|->
name|idle_tag
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|preview
operator|->
name|deinit_func
condition|)
call|(
modifier|*
name|preview
operator|->
name|deinit_func
call|)
argument_list|(
name|preview
argument_list|,
name|preview
operator|->
name|deinit_data
argument_list|)
expr_stmt|;
name|g_source_remove
argument_list|(
name|preview
operator|->
name|idle_tag
argument_list|)
expr_stmt|;
name|preview
operator|->
name|idle_tag
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*   Handle an idle event.   Return FALSE if done, TRUE otherwise.  */
end_comment

begin_function
specifier|static
name|gboolean
DECL|function|preview_handle_idle (Preview * preview)
name|preview_handle_idle
parameter_list|(
name|Preview
modifier|*
name|preview
parameter_list|)
block|{
name|gboolean
name|done
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|preview
operator|->
name|init_done
operator|==
name|FALSE
condition|)
block|{
if|if
condition|(
name|preview
operator|->
name|init_func
operator|&&
call|(
modifier|*
name|preview
operator|->
name|init_func
call|)
argument_list|(
name|preview
argument_list|,
name|preview
operator|->
name|init_data
argument_list|)
condition|)
return|return
name|TRUE
return|;
name|preview
operator|->
name|init_done
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|preview
operator|->
name|render_func
condition|)
call|(
modifier|*
name|preview
operator|->
name|render_func
call|)
argument_list|(
name|preview
argument_list|,
name|preview
operator|->
name|buffer
argument_list|,
name|preview
operator|->
name|current_y
argument_list|,
name|preview
operator|->
name|render_data
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|preview
operator|->
name|buffer
argument_list|,
literal|0
argument_list|,
name|preview
operator|->
name|width
operator|*
literal|3
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|preview
operator|->
name|full_image_buffer
operator|+
name|preview
operator|->
name|width
operator|*
literal|3
operator|*
name|preview
operator|->
name|current_y
argument_list|,
name|preview
operator|->
name|buffer
argument_list|,
name|preview
operator|->
name|width
operator|*
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|preview
operator|->
name|current_y
operator|>=
name|preview
operator|->
name|height
condition|)
name|done
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|done
condition|)
block|{
name|gimp_preview_area_draw
argument_list|(
name|GIMP_PREVIEW_AREA
argument_list|(
name|preview
operator|->
name|widget
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|preview
operator|->
name|width
argument_list|,
name|preview
operator|->
name|height
argument_list|,
name|GIMP_RGB_IMAGE
argument_list|,
name|preview
operator|->
name|full_image_buffer
argument_list|,
name|preview
operator|->
name|width
operator|*
literal|3
argument_list|)
expr_stmt|;
name|preview
operator|->
name|drawn_y
operator|=
name|preview
operator|->
name|current_y
expr_stmt|;
name|preview_render_end
argument_list|(
name|preview
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/*   Convert RGBA to RGB with rendering gray check if needed.         (from nova.c)   input:  guchar src[4]         RGBA pixel   output: guchar dest[3]        RGB pixel  */
end_comment

begin_function
specifier|static
name|void
DECL|function|preview_rgba_to_rgb (guchar * dest,gint x,gint y,guchar * src)
name|preview_rgba_to_rgb
parameter_list|(
name|guchar
modifier|*
name|dest
parameter_list|,
name|gint
name|x
parameter_list|,
name|gint
name|y
parameter_list|,
name|guchar
modifier|*
name|src
parameter_list|)
block|{
name|gint
name|src_a
decl_stmt|;
name|gint
name|check
decl_stmt|;
name|gint
name|b
decl_stmt|;
name|src_a
operator|=
name|src
index|[
literal|3
index|]
expr_stmt|;
if|if
condition|(
name|src_a
operator|==
name|OPAQUE
condition|)
comment|/* full opaque */
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
name|dest
index|[
name|b
index|]
operator|=
name|src
index|[
name|b
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|x
operator|%
operator|(
name|GIMP_CHECK_SIZE
operator|)
operator|<
name|GIMP_CHECK_SIZE_SM
operator|)
operator|^
operator|(
name|y
operator|%
operator|(
name|GIMP_CHECK_SIZE
operator|)
operator|<
name|GIMP_CHECK_SIZE_SM
operator|)
condition|)
name|check
operator|=
name|GIMP_CHECK_LIGHT
operator|*
literal|255
expr_stmt|;
else|else
name|check
operator|=
name|GIMP_CHECK_DARK
operator|*
literal|255
expr_stmt|;
if|if
condition|(
name|src_a
operator|==
literal|0
condition|)
comment|/* full transparent */
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
name|dest
index|[
name|b
index|]
operator|=
name|check
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|3
condition|;
name|b
operator|++
control|)
name|dest
index|[
name|b
index|]
operator|=
operator|(
name|src
index|[
name|b
index|]
operator|*
name|src_a
operator|+
name|check
operator|*
operator|(
name|OPAQUE
operator|-
name|src_a
operator|)
operator|)
operator|/
name|OPAQUE
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**                     +++ Gradient Menu                               **/
end_comment

begin_comment
comment|/**                     +++ gm                                          **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_function
specifier|static
name|void
DECL|function|gradient_menu_init (void)
name|gradient_menu_init
parameter_list|(
name|void
parameter_list|)
block|{
name|gm_gradient_get_list
argument_list|()
expr_stmt|;
name|gradient_menus
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_menu_rescan (void)
name|gradient_menu_rescan
parameter_list|(
name|void
parameter_list|)
block|{
name|GList
modifier|*
name|tmp
decl_stmt|;
name|GradientMenu
modifier|*
name|gm
decl_stmt|;
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
comment|/* Detach and destroy menus first */
name|tmp
operator|=
name|gradient_menus
expr_stmt|;
while|while
condition|(
name|tmp
condition|)
block|{
name|gm
operator|=
name|tmp
operator|->
name|data
expr_stmt|;
name|tmp
operator|=
name|tmp
operator|->
name|next
expr_stmt|;
name|model
operator|=
name|gtk_combo_box_get_model
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|gm
operator|->
name|combo
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_list_store_clear
argument_list|(
name|GTK_LIST_STORE
argument_list|(
name|model
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|gm_gradient_get_list
argument_list|()
expr_stmt|;
name|tmp
operator|=
name|gradient_menus
expr_stmt|;
while|while
condition|(
name|tmp
condition|)
block|{
name|gm
operator|=
name|tmp
operator|->
name|data
expr_stmt|;
name|tmp
operator|=
name|tmp
operator|->
name|next
expr_stmt|;
name|gm_gradient_combo_fill
argument_list|(
name|gm
argument_list|,
name|gm
operator|->
name|gradient_name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|GradientMenu
modifier|*
DECL|function|gradient_menu_new (GradientMenuCallback callback,gpointer callback_data,const gchar * default_gradient_name)
name|gradient_menu_new
parameter_list|(
name|GradientMenuCallback
name|callback
parameter_list|,
name|gpointer
name|callback_data
parameter_list|,
specifier|const
name|gchar
modifier|*
name|default_gradient_name
parameter_list|)
block|{
name|GradientMenu
modifier|*
name|gm
init|=
name|g_new
argument_list|(
name|GradientMenu
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|gm
operator|->
name|callback
operator|=
name|callback
expr_stmt|;
name|gm
operator|->
name|callback_data
operator|=
name|callback_data
expr_stmt|;
name|gm
operator|->
name|preview
operator|=
name|gimp_preview_area_new
argument_list|()
expr_stmt|;
name|gtk_widget_set_size_request
argument_list|(
name|gm
operator|->
name|preview
argument_list|,
name|GM_PREVIEW_WIDTH
argument_list|,
name|GM_PREVIEW_HEIGHT
argument_list|)
expr_stmt|;
name|gm
operator|->
name|combo
operator|=
name|g_object_new
argument_list|(
name|GIMP_TYPE_INT_COMBO_BOX
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|gm
operator|->
name|combo
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gm_gradient_combo_callback
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gm_gradient_combo_fill
argument_list|(
name|gm
argument_list|,
name|default_gradient_name
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|gm
operator|->
name|preview
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|gm
operator|->
name|combo
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|gm
operator|->
name|combo
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gm_combo_destroy_callback
argument_list|)
argument_list|,
name|gm
argument_list|)
expr_stmt|;
name|gradient_menus
operator|=
name|g_list_append
argument_list|(
name|gradient_menus
argument_list|,
name|gm
argument_list|)
expr_stmt|;
return|return
name|gm
return|;
block|}
end_function

begin_comment
comment|/* Local Functions */
end_comment

begin_function
specifier|static
name|void
DECL|function|gm_gradient_get_list (void)
name|gm_gradient_get_list
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|gradient_names
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_gradient_names
condition|;
name|i
operator|++
control|)
name|g_free
argument_list|(
name|gradient_names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|gradient_names
argument_list|)
expr_stmt|;
block|}
name|gradient_cache_flush
argument_list|()
expr_stmt|;
comment|/* to make sure */
name|gradient_names
operator|=
name|gradient_get_list
argument_list|(
operator|&
name|num_gradient_names
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gm_gradient_combo_fill (GradientMenu * gm,const gchar * default_gradient)
name|gm_gradient_combo_fill
parameter_list|(
name|GradientMenu
modifier|*
name|gm
parameter_list|,
specifier|const
name|gchar
modifier|*
name|default_gradient
parameter_list|)
block|{
name|gint
name|active
init|=
literal|0
decl_stmt|;
name|gint
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_gradient_names
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|gchar
modifier|*
name|name
init|=
name|gradient_names
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|default_gradient
argument_list|)
operator|==
literal|0
condition|)
name|active
operator|=
name|i
expr_stmt|;
name|gimp_int_combo_box_append
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|gm
operator|->
name|combo
argument_list|)
argument_list|,
name|GIMP_INT_STORE_VALUE
argument_list|,
name|i
argument_list|,
name|GIMP_INT_STORE_LABEL
argument_list|,
name|name
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|gm
operator|->
name|combo
argument_list|)
argument_list|,
name|active
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gm_gradient_combo_callback (GtkWidget * widget,gpointer data)
name|gm_gradient_combo_callback
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GradientMenu
modifier|*
name|gm
init|=
name|data
decl_stmt|;
specifier|const
name|gchar
modifier|*
name|gradient_name
decl_stmt|;
name|gint
name|index
decl_stmt|;
if|if
condition|(
operator|!
name|gimp_int_combo_box_get_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|,
operator|&
name|index
argument_list|)
operator|||
name|index
operator|<
literal|0
operator|||
name|index
operator|>=
name|num_gradient_names
condition|)
return|return;
name|gradient_name
operator|=
name|gradient_names
index|[
name|index
index|]
expr_stmt|;
name|DEBUG_PRINT
argument_list|(
operator|(
literal|"gm_combo_callback\n"
operator|)
argument_list|)
expr_stmt|;
name|gradient_name_copy
argument_list|(
name|gm
operator|->
name|gradient_name
argument_list|,
name|gradient_name
argument_list|)
expr_stmt|;
name|gm_preview_draw
argument_list|(
name|gm
operator|->
name|preview
argument_list|,
name|gradient_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|gm
operator|->
name|callback
condition|)
call|(
modifier|*
name|gm
operator|->
name|callback
call|)
argument_list|(
name|gradient_name
argument_list|,
name|gm
operator|->
name|callback_data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gm_preview_draw (GtkWidget * preview,const gchar * gradient_name)
name|gm_preview_draw
parameter_list|(
name|GtkWidget
modifier|*
name|preview
parameter_list|,
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|)
block|{
name|guchar
name|values
index|[
name|GM_PREVIEW_WIDTH
index|]
index|[
literal|4
index|]
decl_stmt|;
name|gint
name|nvalues
init|=
name|GM_PREVIEW_WIDTH
decl_stmt|;
name|gint
name|row
decl_stmt|,
name|irow
decl_stmt|,
name|col
decl_stmt|;
name|guchar
name|dest_row
index|[
name|GM_PREVIEW_WIDTH
index|]
index|[
literal|3
index|]
decl_stmt|;
name|guchar
modifier|*
name|dest
decl_stmt|;
name|guchar
modifier|*
name|src
decl_stmt|;
name|gint
name|check
decl_stmt|,
name|b
decl_stmt|;
name|guchar
modifier|*
name|dest_total_preview_buffer
decl_stmt|;
specifier|const
name|gint
name|alpha
init|=
literal|3
decl_stmt|;
name|gradient_get_values
argument_list|(
name|gradient_name
argument_list|,
operator|(
name|guchar
operator|*
operator|)
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
name|dest_total_preview_buffer
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|GM_PREVIEW_HEIGHT
operator|*
name|GM_PREVIEW_WIDTH
operator|*
literal|3
argument_list|)
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|GM_PREVIEW_HEIGHT
condition|;
name|row
operator|+=
name|GIMP_CHECK_SIZE_SM
control|)
block|{
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|GM_PREVIEW_WIDTH
condition|;
name|col
operator|++
control|)
block|{
name|dest
operator|=
name|dest_row
index|[
name|col
index|]
expr_stmt|;
name|src
operator|=
name|values
index|[
name|col
index|]
expr_stmt|;
if|if
condition|(
name|src
index|[
name|alpha
index|]
operator|==
name|OPAQUE
condition|)
block|{
comment|/* no alpha channel or opaque -- simple way */
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|alpha
condition|;
name|b
operator|++
control|)
name|dest
index|[
name|b
index|]
operator|=
name|src
index|[
name|b
index|]
expr_stmt|;
block|}
else|else
block|{
comment|/* more or less transparent */
if|if
condition|(
operator|(
name|col
operator|%
operator|(
name|GIMP_CHECK_SIZE
operator|)
operator|<
name|GIMP_CHECK_SIZE_SM
operator|)
operator|^
operator|(
name|row
operator|%
operator|(
name|GIMP_CHECK_SIZE
operator|)
operator|<
name|GIMP_CHECK_SIZE_SM
operator|)
condition|)
block|{
name|check
operator|=
name|GIMP_CHECK_LIGHT
operator|*
literal|255
expr_stmt|;
block|}
else|else
block|{
name|check
operator|=
name|GIMP_CHECK_DARK
operator|*
literal|255
expr_stmt|;
block|}
if|if
condition|(
name|src
index|[
name|alpha
index|]
operator|==
literal|0
condition|)
block|{
comment|/* full transparent -- check */
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|alpha
condition|;
name|b
operator|++
control|)
name|dest
index|[
name|b
index|]
operator|=
name|check
expr_stmt|;
block|}
else|else
block|{
comment|/* middlemost transparent -- mix check and src */
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
name|alpha
condition|;
name|b
operator|++
control|)
name|dest
index|[
name|b
index|]
operator|=
operator|(
name|src
index|[
name|b
index|]
operator|*
name|src
index|[
name|alpha
index|]
operator|+
name|check
operator|*
operator|(
name|OPAQUE
operator|-
name|src
index|[
name|alpha
index|]
operator|)
operator|)
operator|/
name|OPAQUE
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
name|irow
operator|=
literal|0
init|;
name|irow
operator|<
name|GIMP_CHECK_SIZE_SM
operator|&&
name|row
operator|+
name|irow
operator|<
name|GM_PREVIEW_HEIGHT
condition|;
name|irow
operator|++
control|)
block|{
name|memcpy
argument_list|(
name|dest_total_preview_buffer
operator|+
operator|(
name|row
operator|+
name|irow
operator|)
operator|*
literal|3
operator|*
name|GM_PREVIEW_WIDTH
argument_list|,
name|dest_row
argument_list|,
name|GM_PREVIEW_WIDTH
operator|*
literal|3
argument_list|)
expr_stmt|;
block|}
block|}
name|gimp_preview_area_draw
argument_list|(
name|GIMP_PREVIEW_AREA
argument_list|(
name|preview
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|GM_PREVIEW_WIDTH
argument_list|,
name|GM_PREVIEW_HEIGHT
argument_list|,
name|GIMP_RGB_IMAGE
argument_list|,
operator|(
specifier|const
name|guchar
operator|*
operator|)
name|dest_total_preview_buffer
argument_list|,
name|GM_PREVIEW_WIDTH
operator|*
literal|3
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dest_total_preview_buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gm_combo_destroy_callback (GtkWidget * w,gpointer data)
name|gm_combo_destroy_callback
parameter_list|(
name|GtkWidget
modifier|*
name|w
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GradientMenu
modifier|*
name|gm
init|=
name|data
decl_stmt|;
name|gradient_menus
operator|=
name|g_list_remove
argument_list|(
name|gradient_menus
argument_list|,
name|gm
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/**                     +++ Gradients                                   **/
end_comment

begin_comment
comment|/**                                                                     **/
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/*     Manage both internal and external gradients: list up, cache,     sampling, etc.      External gradients are cached.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gradient_name_copy (gchar * dest,const gchar * src)
name|gradient_name_copy
parameter_list|(
name|gchar
modifier|*
name|dest
parameter_list|,
specifier|const
name|gchar
modifier|*
name|src
parameter_list|)
block|{
name|strncpy
argument_list|(
name|dest
argument_list|,
name|src
argument_list|,
name|GRADIENT_NAME_MAX
argument_list|)
expr_stmt|;
name|dest
index|[
name|GRADIENT_NAME_MAX
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   Translate SPACE to "\\040", etc.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gradient_name_encode (gchar * dest,const gchar * src)
name|gradient_name_encode
parameter_list|(
name|gchar
modifier|*
name|dest
parameter_list|,
specifier|const
name|gchar
modifier|*
name|src
parameter_list|)
block|{
name|gint
name|cnt
init|=
name|GRADIENT_NAME_MAX
operator|-
literal|1
decl_stmt|;
while|while
condition|(
operator|*
name|src
operator|&&
name|cnt
operator|--
condition|)
block|{
if|if
condition|(
name|g_ascii_iscntrl
argument_list|(
operator|*
name|src
argument_list|)
operator|||
name|g_ascii_isspace
argument_list|(
operator|*
name|src
argument_list|)
operator|||
operator|*
name|src
operator|==
literal|'\\'
condition|)
block|{
name|sprintf
argument_list|(
name|dest
argument_list|,
literal|"\\%03o"
argument_list|,
operator|*
name|src
operator|++
argument_list|)
expr_stmt|;
name|dest
operator|+=
literal|4
expr_stmt|;
block|}
else|else
operator|*
name|dest
operator|++
operator|=
operator|*
name|src
operator|++
expr_stmt|;
block|}
operator|*
name|dest
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   Translate "\\040" to SPACE, etc.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gradient_name_decode (gchar * dest,const gchar * src)
name|gradient_name_decode
parameter_list|(
name|gchar
modifier|*
name|dest
parameter_list|,
specifier|const
name|gchar
modifier|*
name|src
parameter_list|)
block|{
name|gint
name|cnt
init|=
name|GRADIENT_NAME_MAX
operator|-
literal|1
decl_stmt|;
name|guint
name|tmp
decl_stmt|;
while|while
condition|(
operator|*
name|src
operator|&&
name|cnt
operator|--
condition|)
block|{
if|if
condition|(
operator|*
name|src
operator|==
literal|'\\'
operator|&&
operator|*
operator|(
name|src
operator|+
literal|1
operator|)
operator|&&
operator|*
operator|(
name|src
operator|+
literal|2
operator|)
operator|&&
operator|*
operator|(
name|src
operator|+
literal|3
operator|)
condition|)
block|{
name|sscanf
argument_list|(
name|src
operator|+
literal|1
argument_list|,
literal|"%3o"
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
operator|*
name|dest
operator|++
operator|=
name|tmp
expr_stmt|;
name|src
operator|+=
literal|4
expr_stmt|;
block|}
else|else
operator|*
name|dest
operator|++
operator|=
operator|*
name|src
operator|++
expr_stmt|;
block|}
operator|*
name|dest
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_init (void)
name|gradient_init
parameter_list|(
name|void
parameter_list|)
block|{
name|gradient_cache_head
operator|=
name|NULL
expr_stmt|;
name|gradient_cache_count
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_free (void)
name|gradient_free
parameter_list|(
name|void
parameter_list|)
block|{
name|gradient_cache_flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gchar
modifier|*
modifier|*
DECL|function|gradient_get_list (gint * num_gradients)
name|gradient_get_list
parameter_list|(
name|gint
modifier|*
name|num_gradients
parameter_list|)
block|{
name|gchar
modifier|*
modifier|*
name|gradients
decl_stmt|;
name|gchar
modifier|*
modifier|*
name|external_gradients
init|=
name|NULL
decl_stmt|;
name|gint
name|external_ngradients
init|=
literal|0
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|n
decl_stmt|;
name|gradient_cache_flush
argument_list|()
expr_stmt|;
name|external_gradients
operator|=
name|gimp_gradients_get_list
argument_list|(
name|NULL
argument_list|,
operator|&
name|external_ngradients
argument_list|)
expr_stmt|;
operator|*
name|num_gradients
operator|=
name|G_N_ELEMENTS
argument_list|(
name|internal_gradients
argument_list|)
operator|+
name|external_ngradients
expr_stmt|;
name|gradients
operator|=
name|g_new
argument_list|(
name|gchar
operator|*
argument_list|,
operator|*
name|num_gradients
argument_list|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|G_N_ELEMENTS
argument_list|(
name|internal_gradients
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|gradients
index|[
name|n
operator|++
index|]
operator|=
name|g_strdup
argument_list|(
name|internal_gradients
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|external_ngradients
condition|;
name|i
operator|++
control|)
block|{
name|gradients
index|[
name|n
operator|++
index|]
operator|=
name|g_strdup
argument_list|(
name|external_gradients
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|gradients
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_get_values (const gchar * gradient_name,guchar * values,gint nvalues)
name|gradient_get_values
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
block|{
comment|/*     Criteria to distinguish internal and external is rather simple here.     It should be fixed later.    */
if|if
condition|(
name|gradient_name
index|[
literal|0
index|]
operator|==
literal|'%'
condition|)
name|gradient_get_values_internal
argument_list|(
name|gradient_name
argument_list|,
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
else|else
name|gradient_get_values_external
argument_list|(
name|gradient_name
argument_list|,
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_get_values_internal (const gchar * gradient_name,guchar * values,gint nvalues)
name|gradient_get_values_internal
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
block|{
specifier|const
name|guchar
name|white
index|[
literal|4
index|]
init|=
block|{
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|}
decl_stmt|;
specifier|const
name|guchar
name|white_trans
index|[
literal|4
index|]
init|=
block|{
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|0
block|}
decl_stmt|;
specifier|const
name|guchar
name|red_trans
index|[
literal|4
index|]
init|=
block|{
literal|255
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
specifier|const
name|guchar
name|blue_trans
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|255
block|,
literal|0
block|}
decl_stmt|;
specifier|const
name|guchar
name|yellow_trans
index|[
literal|4
index|]
init|=
block|{
literal|255
block|,
literal|255
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
comment|/*     The internal gradients here are example --     What kind of internals would be useful ?    */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|gradient_name
argument_list|,
literal|"%white"
argument_list|)
condition|)
block|{
name|gradient_get_blend
argument_list|(
name|white
argument_list|,
name|white
argument_list|,
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|gradient_name
argument_list|,
literal|"%white_grad"
argument_list|)
condition|)
block|{
name|gradient_get_blend
argument_list|(
name|white
argument_list|,
name|white_trans
argument_list|,
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|gradient_name
argument_list|,
literal|"%red_grad"
argument_list|)
condition|)
block|{
name|gradient_get_blend
argument_list|(
name|white
argument_list|,
name|red_trans
argument_list|,
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|gradient_name
argument_list|,
literal|"%blue_grad"
argument_list|)
condition|)
block|{
name|gradient_get_blend
argument_list|(
name|white
argument_list|,
name|blue_trans
argument_list|,
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|gradient_name
argument_list|,
literal|"%yellow_grad"
argument_list|)
condition|)
block|{
name|gradient_get_blend
argument_list|(
name|white
argument_list|,
name|yellow_trans
argument_list|,
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|gradient_name
argument_list|,
literal|"%random"
argument_list|)
condition|)
block|{
name|gradient_get_random
argument_list|(
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gradient_get_default
argument_list|(
name|gradient_name
argument_list|,
name|values
argument_list|,
name|nvalues
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_get_blend (const guchar * fg,const guchar * bg,guchar * values,gint nvalues)
name|gradient_get_blend
parameter_list|(
specifier|const
name|guchar
modifier|*
name|fg
parameter_list|,
specifier|const
name|guchar
modifier|*
name|bg
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
block|{
name|gdouble
name|x
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|j
decl_stmt|;
name|guchar
modifier|*
name|v
init|=
name|values
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nvalues
condition|;
name|i
operator|++
control|)
block|{
name|x
operator|=
operator|(
name|double
operator|)
name|i
operator|/
name|nvalues
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
operator|*
name|v
operator|++
operator|=
name|fg
index|[
name|j
index|]
operator|*
operator|(
literal|1
operator|-
name|x
operator|)
operator|+
name|bg
index|[
name|j
index|]
operator|*
name|x
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_get_random (guchar * values,gint nvalues)
name|gradient_get_random
parameter_list|(
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
block|{
name|gint
name|i
decl_stmt|;
name|gint
name|j
decl_stmt|;
name|gint
name|inten
decl_stmt|;
name|guchar
modifier|*
name|v
init|=
name|values
decl_stmt|;
comment|/*     This is really simple  -- gaussian noise might be better    */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nvalues
condition|;
name|i
operator|++
control|)
block|{
name|inten
operator|=
name|g_random_int_range
argument_list|(
literal|0
argument_list|,
literal|256
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|3
condition|;
name|j
operator|++
control|)
operator|*
name|v
operator|++
operator|=
name|inten
expr_stmt|;
operator|*
name|v
operator|++
operator|=
literal|255
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_get_default (const gchar * name,guchar * values,gint nvalues)
name|gradient_get_default
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
block|{
name|gdouble
name|e
index|[
literal|3
index|]
decl_stmt|;
name|gdouble
name|x
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|j
decl_stmt|;
name|guchar
modifier|*
name|v
init|=
name|values
decl_stmt|;
comment|/*     Create gradient by name    */
name|name
operator|++
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|3
condition|;
name|j
operator|++
control|)
name|e
index|[
name|j
index|]
operator|=
name|name
index|[
name|j
index|]
operator|/
literal|255.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nvalues
condition|;
name|i
operator|++
control|)
block|{
name|x
operator|=
operator|(
name|double
operator|)
name|i
operator|/
name|nvalues
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|3
condition|;
name|j
operator|++
control|)
operator|*
name|v
operator|++
operator|=
literal|255
operator|*
name|pow
argument_list|(
name|x
argument_list|,
name|e
index|[
name|j
index|]
argument_list|)
expr_stmt|;
operator|*
name|v
operator|++
operator|=
literal|255
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*   Caching gradients is really needed. It really takes 0.2 seconds each   time to resample an external gradient. (And this plug-in has   currently 6 gradient menus.)    However, this caching routine is not too good. It picks up just   GRADIENT_RESOLUTION samples everytime, and rescales it later.  And   cached values are stored in guchar array. No accuracy.  */
end_comment

begin_function
specifier|static
name|void
DECL|function|gradient_get_values_external (const gchar * gradient_name,guchar * values,gint nvalues)
name|gradient_get_values_external
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|)
block|{
name|GradientCacheItem
modifier|*
name|ci
decl_stmt|;
name|gboolean
name|found
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|clock_t
name|clk
init|=
name|clock
argument_list|()
decl_stmt|;
endif|#
directive|endif
name|g_return_if_fail
argument_list|(
name|nvalues
operator|>=
literal|2
argument_list|)
expr_stmt|;
name|ci
operator|=
name|gradient_cache_lookup
argument_list|(
name|gradient_name
argument_list|,
operator|&
name|found
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|found
condition|)
block|{
comment|/* FIXME: "reverse" hardcoded to FALSE. */
name|gradient_get_values_real_external
argument_list|(
name|gradient_name
argument_list|,
name|ci
operator|->
name|values
argument_list|,
name|GRADIENT_RESOLUTION
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nvalues
operator|==
name|GRADIENT_RESOLUTION
condition|)
block|{
name|memcpy
argument_list|(
name|values
argument_list|,
name|ci
operator|->
name|values
argument_list|,
literal|4
operator|*
name|GRADIENT_RESOLUTION
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|double
name|pos
decl_stmt|,
name|frac
decl_stmt|;
name|int
name|ipos
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nvalues
condition|;
name|i
operator|++
control|)
block|{
name|pos
operator|=
operator|(
operator|(
name|double
operator|)
name|i
operator|/
operator|(
name|nvalues
operator|-
literal|1
operator|)
operator|)
operator|*
operator|(
name|GRADIENT_RESOLUTION
operator|-
literal|1
operator|)
expr_stmt|;
name|g_assert
argument_list|(
literal|0
operator|<=
name|pos
operator|&&
name|pos
operator|<=
name|GRADIENT_RESOLUTION
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ipos
operator|=
operator|(
name|int
operator|)
name|pos
expr_stmt|;
name|frac
operator|=
name|pos
operator|-
name|ipos
expr_stmt|;
if|if
condition|(
name|frac
operator|==
literal|0.0
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|values
index|[
literal|4
operator|*
name|i
index|]
argument_list|,
operator|&
name|ci
operator|->
name|values
index|[
literal|4
operator|*
name|ipos
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
name|values
index|[
literal|4
operator|*
name|i
operator|+
name|j
index|]
operator|=
name|ci
operator|->
name|values
index|[
literal|4
operator|*
name|ipos
operator|+
name|j
index|]
operator|*
operator|(
literal|1
operator|-
name|frac
operator|)
operator|+
name|ci
operator|->
name|values
index|[
literal|4
operator|*
operator|(
name|ipos
operator|+
literal|1
operator|)
operator|+
name|j
index|]
operator|*
name|frac
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|get_values_external_clock
operator|+=
name|clock
argument_list|()
operator|-
name|clk
expr_stmt|;
name|get_values_external_count
operator|++
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_get_values_real_external (const gchar * gradient_name,guchar * values,gint nvalues,gboolean reverse)
name|gradient_get_values_real_external
parameter_list|(
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|guchar
modifier|*
name|values
parameter_list|,
name|gint
name|nvalues
parameter_list|,
name|gboolean
name|reverse
parameter_list|)
block|{
name|gint
name|n_tmp_values
decl_stmt|;
name|gdouble
modifier|*
name|tmp_values
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|j
decl_stmt|;
name|gimp_gradient_get_uniform_samples
argument_list|(
name|gradient_name
argument_list|,
name|nvalues
argument_list|,
name|reverse
argument_list|,
operator|&
name|n_tmp_values
argument_list|,
operator|&
name|tmp_values
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nvalues
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
name|values
index|[
literal|4
operator|*
name|i
operator|+
name|j
index|]
operator|=
call|(
name|guchar
call|)
argument_list|(
name|tmp_values
index|[
literal|4
operator|*
name|i
operator|+
name|j
index|]
operator|*
literal|255
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmp_values
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gradient_cache_flush (void)
name|gradient_cache_flush
parameter_list|(
name|void
parameter_list|)
block|{
name|GradientCacheItem
modifier|*
name|ci
decl_stmt|;
name|GradientCacheItem
modifier|*
name|tmp
decl_stmt|;
name|ci
operator|=
name|gradient_cache_head
expr_stmt|;
while|while
condition|(
name|ci
condition|)
block|{
name|tmp
operator|=
name|ci
operator|->
name|next
expr_stmt|;
name|g_free
argument_list|(
name|ci
argument_list|)
expr_stmt|;
name|ci
operator|=
name|tmp
expr_stmt|;
block|}
name|gradient_cache_head
operator|=
name|NULL
expr_stmt|;
name|gradient_cache_count
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|GradientCacheItem
modifier|*
DECL|function|gradient_cache_lookup (const gchar * name,gboolean * found)
name|gradient_cache_lookup
parameter_list|(
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gboolean
modifier|*
name|found
parameter_list|)
block|{
name|GradientCacheItem
modifier|*
name|ci
decl_stmt|;
name|ci
operator|=
name|gradient_cache_head
expr_stmt|;
while|while
condition|(
name|ci
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|ci
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
break|break;
name|ci
operator|=
name|ci
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|ci
condition|)
block|{
operator|*
name|found
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|ci
operator|->
name|prev
condition|)
block|{
name|g_assert
argument_list|(
name|ci
operator|==
name|gradient_cache_head
argument_list|)
expr_stmt|;
return|return
name|ci
return|;
block|}
name|ci
operator|->
name|prev
operator|->
name|next
operator|=
name|ci
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|ci
operator|->
name|next
condition|)
name|ci
operator|->
name|next
operator|->
name|prev
operator|=
name|ci
operator|->
name|prev
expr_stmt|;
name|ci
operator|->
name|next
operator|=
name|gradient_cache_head
expr_stmt|;
name|gradient_cache_head
operator|->
name|prev
operator|=
name|ci
expr_stmt|;
name|gradient_cache_head
operator|=
name|ci
expr_stmt|;
name|ci
operator|->
name|prev
operator|=
name|NULL
expr_stmt|;
return|return
name|ci
return|;
block|}
else|else
block|{
operator|*
name|found
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
name|gradient_cache_count
operator|>=
name|GRADIENT_CACHE_SIZE
condition|)
name|gradient_cache_zorch
argument_list|()
expr_stmt|;
name|ci
operator|=
name|g_new
argument_list|(
name|GradientCacheItem
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ci
operator|->
name|name
argument_list|,
name|name
argument_list|,
name|GRADIENT_NAME_MAX
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ci
operator|->
name|next
operator|=
name|gradient_cache_head
expr_stmt|;
name|ci
operator|->
name|prev
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|gradient_cache_head
condition|)
name|gradient_cache_head
operator|->
name|prev
operator|=
name|ci
expr_stmt|;
name|gradient_cache_head
operator|=
name|ci
expr_stmt|;
operator|++
name|gradient_cache_count
expr_stmt|;
return|return
name|ci
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gradient_cache_zorch (void)
name|gradient_cache_zorch
parameter_list|(
name|void
parameter_list|)
block|{
name|GradientCacheItem
modifier|*
name|ci
init|=
name|gradient_cache_head
decl_stmt|;
while|while
condition|(
name|ci
operator|&&
name|ci
operator|->
name|next
condition|)
block|{
name|ci
operator|=
name|ci
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|ci
condition|)
block|{
name|g_assert
argument_list|(
name|ci
operator|->
name|next
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ci
operator|->
name|prev
condition|)
name|ci
operator|->
name|prev
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
else|else
name|gradient_cache_head
operator|=
name|NULL
expr_stmt|;
name|g_free
argument_list|(
name|ci
argument_list|)
expr_stmt|;
operator|--
name|gradient_cache_count
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function
name|void
DECL|function|gradient_report (void)
name|gradient_report
parameter_list|(
name|void
parameter_list|)
block|{
name|double
name|total
init|=
operator|(
name|double
operator|)
name|get_values_external_clock
operator|/
name|CLOCKS_PER_SEC
decl_stmt|;
name|g_printerr
argument_list|(
literal|"gradient_get_values_external "
literal|"%.2f sec. / %d times (ave %.2f sec.)\n"
argument_list|,
name|total
argument_list|,
name|get_values_external_count
argument_list|,
name|total
operator|/
name|get_values_external_count
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit

