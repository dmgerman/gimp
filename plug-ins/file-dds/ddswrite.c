begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * DDS GIMP plugin  *  * Copyright (C) 2004-2012 Shawn Kirst<skirst@gmail.com>,  * with parts (C) 2003 Arne Reuter<homepage@arnereuter.de> where specified.  *  * This program is free software; you can redistribute it and/or  * modify it under the terms of the GNU General Public  * License as published by the Free Software Foundation; either  * version 2 of the License, or (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; see the file COPYING.  If not, write to  * the Free Software Foundation, 51 Franklin Street, Fifth Floor  * Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/stdplugins-intl.h>
end_include

begin_include
include|#
directive|include
file|"ddsplugin.h"
end_include

begin_include
include|#
directive|include
file|"dds.h"
end_include

begin_include
include|#
directive|include
file|"dxt.h"
end_include

begin_include
include|#
directive|include
file|"mipmap.h"
end_include

begin_include
include|#
directive|include
file|"endian_rw.h"
end_include

begin_include
include|#
directive|include
file|"imath.h"
end_include

begin_include
include|#
directive|include
file|"color.h"
end_include

begin_function_decl
specifier|static
name|gboolean
name|write_image
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|GObject
modifier|*
name|config
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|gboolean
name|save_dialog
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|GimpProcedure
modifier|*
name|procedure
parameter_list|,
name|GObject
modifier|*
name|config
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|cubemap_face_names
specifier|static
specifier|const
name|char
modifier|*
name|cubemap_face_names
index|[
literal|4
index|]
index|[
literal|6
index|]
init|=
block|{
block|{
literal|"positive x"
block|,
literal|"negative x"
block|,
literal|"positive y"
block|,
literal|"negative y"
block|,
literal|"positive z"
block|,
literal|"negative z"
block|}
block|,
block|{
literal|"pos x"
block|,
literal|"neg x"
block|,
literal|"pos y"
block|,
literal|"neg y"
block|,
literal|"pos z"
block|,
literal|"neg z"
block|,   }
block|,
block|{
literal|"+x"
block|,
literal|"-x"
block|,
literal|"+y"
block|,
literal|"-y"
block|,
literal|"+z"
block|,
literal|"-z"
block|}
block|,
block|{
literal|"right"
block|,
literal|"left"
block|,
literal|"top"
block|,
literal|"bottom"
block|,
literal|"back"
block|,
literal|"front"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|cubemap_faces
specifier|static
name|GimpLayer
modifier|*
name|cubemap_faces
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|is_cubemap
specifier|static
name|gboolean
name|is_cubemap
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|is_volume
specifier|static
name|gboolean
name|is_volume
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|is_array
specifier|static
name|gboolean
name|is_array
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|is_mipmap_chain_valid
specifier|static
name|gboolean
name|is_mipmap_chain_valid
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|compress_opt
specifier|static
name|GtkWidget
modifier|*
name|compress_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|format_opt
specifier|static
name|GtkWidget
modifier|*
name|format_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_opt
specifier|static
name|GtkWidget
modifier|*
name|mipmap_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_filter_opt
specifier|static
name|GtkWidget
modifier|*
name|mipmap_filter_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_wrap_opt
specifier|static
name|GtkWidget
modifier|*
name|mipmap_wrap_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|transparent_spin
specifier|static
name|GtkWidget
modifier|*
name|transparent_spin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|srgb_check
specifier|static
name|GtkWidget
modifier|*
name|srgb_check
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gamma_check
specifier|static
name|GtkWidget
modifier|*
name|gamma_check
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gamma_spin
specifier|static
name|GtkWidget
modifier|*
name|gamma_spin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|pm_check
specifier|static
name|GtkWidget
modifier|*
name|pm_check
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|alpha_coverage_check
specifier|static
name|GtkWidget
modifier|*
name|alpha_coverage_check
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|alpha_test_threshold_spin
specifier|static
name|GtkWidget
modifier|*
name|alpha_test_threshold_spin
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
DECL|struct|__anon29186c080108
block|{
DECL|member|format
name|gint
name|format
decl_stmt|;
DECL|member|dxgi_format
name|DXGI_FORMAT
name|dxgi_format
decl_stmt|;
DECL|member|bpp
name|gint
name|bpp
decl_stmt|;
DECL|member|alpha
name|gint
name|alpha
decl_stmt|;
DECL|member|rmask
name|guint
name|rmask
decl_stmt|;
DECL|member|gmask
name|guint
name|gmask
decl_stmt|;
DECL|member|bmask
name|guint
name|bmask
decl_stmt|;
DECL|member|amask
name|guint
name|amask
decl_stmt|;
DECL|variable|format_info
block|}
name|format_info
index|[]
init|=
block|{
block|{
name|DDS_FORMAT_RGB8
block|,
name|DXGI_FORMAT_UNKNOWN
block|,
literal|3
block|,
literal|0
block|,
literal|0x00ff0000
block|,
literal|0x0000ff00
block|,
literal|0x000000ff
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_RGBA8
block|,
name|DXGI_FORMAT_B8G8R8A8_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x00ff0000
block|,
literal|0x0000ff00
block|,
literal|0x000000ff
block|,
literal|0xff000000
block|}
block|,
block|{
name|DDS_FORMAT_BGR8
block|,
name|DXGI_FORMAT_UNKNOWN
block|,
literal|3
block|,
literal|0
block|,
literal|0x000000ff
block|,
literal|0x0000ff00
block|,
literal|0x00ff0000
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_ABGR8
block|,
name|DXGI_FORMAT_R8G8B8A8_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x000000ff
block|,
literal|0x0000ff00
block|,
literal|0x00ff0000
block|,
literal|0xff000000
block|}
block|,
block|{
name|DDS_FORMAT_R5G6B5
block|,
name|DXGI_FORMAT_B5G6R5_UNORM
block|,
literal|2
block|,
literal|0
block|,
literal|0x0000f800
block|,
literal|0x000007e0
block|,
literal|0x0000001f
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_RGBA4
block|,
name|DXGI_FORMAT_B4G4R4A4_UNORM
block|,
literal|2
block|,
literal|1
block|,
literal|0x00000f00
block|,
literal|0x000000f0
block|,
literal|0x0000000f
block|,
literal|0x0000f000
block|}
block|,
block|{
name|DDS_FORMAT_RGB5A1
block|,
name|DXGI_FORMAT_B5G5R5A1_UNORM
block|,
literal|2
block|,
literal|1
block|,
literal|0x00007c00
block|,
literal|0x000003e0
block|,
literal|0x0000001f
block|,
literal|0x00008000
block|}
block|,
block|{
name|DDS_FORMAT_RGB10A2
block|,
name|DXGI_FORMAT_R10G10B10A2_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x000003ff
block|,
literal|0x000ffc00
block|,
literal|0x3ff00000
block|,
literal|0xc0000000
block|}
block|,
block|{
name|DDS_FORMAT_R3G3B2
block|,
name|DXGI_FORMAT_UNKNOWN
block|,
literal|1
block|,
literal|0
block|,
literal|0x000000e0
block|,
literal|0x0000001c
block|,
literal|0x00000003
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_A8
block|,
name|DXGI_FORMAT_A8_UNORM
block|,
literal|1
block|,
literal|0
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x000000ff
block|}
block|,
block|{
name|DDS_FORMAT_L8
block|,
name|DXGI_FORMAT_R8_UNORM
block|,
literal|1
block|,
literal|0
block|,
literal|0x000000ff
block|,
literal|0x000000ff
block|,
literal|0x000000ff
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_L8A8
block|,
name|DXGI_FORMAT_UNKNOWN
block|,
literal|2
block|,
literal|1
block|,
literal|0x000000ff
block|,
literal|0x000000ff
block|,
literal|0x000000ff
block|,
literal|0x0000ff00
block|}
block|,
block|{
name|DDS_FORMAT_AEXP
block|,
name|DXGI_FORMAT_B8G8R8A8_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x00ff0000
block|,
literal|0x0000ff00
block|,
literal|0x000000ff
block|,
literal|0xff000000
block|}
block|,
block|{
name|DDS_FORMAT_YCOCG
block|,
name|DXGI_FORMAT_B8G8R8A8_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x00ff0000
block|,
literal|0x0000ff00
block|,
literal|0x000000ff
block|,
literal|0xff000000
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|gboolean
DECL|function|check_mipmaps (GimpImage * image,gint savetype)
name|check_mipmaps
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|,
name|gint
name|savetype
parameter_list|)
block|{
name|GList
modifier|*
name|layers
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|num_layers
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|;
name|gint
name|w
decl_stmt|,
name|h
decl_stmt|;
name|gint
name|mipw
decl_stmt|,
name|miph
decl_stmt|;
name|gint
name|num_mipmaps
decl_stmt|;
name|gint
name|num_surfaces
init|=
literal|0
decl_stmt|;
name|gint
name|min_surfaces
init|=
literal|1
decl_stmt|;
name|gint
name|max_surfaces
init|=
literal|1
decl_stmt|;
name|gboolean
name|valid
init|=
name|TRUE
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
comment|/* not handling volume maps for the moment... */
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_CUBEMAP
condition|)
block|{
name|min_surfaces
operator|=
literal|6
expr_stmt|;
name|max_surfaces
operator|=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_ARRAY
condition|)
block|{
name|min_surfaces
operator|=
literal|2
expr_stmt|;
name|max_surfaces
operator|=
name|INT_MAX
expr_stmt|;
block|}
name|layers
operator|=
name|gimp_image_list_layers
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|num_layers
operator|=
name|g_list_length
argument_list|(
name|layers
argument_list|)
expr_stmt|;
name|w
operator|=
name|gimp_image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|num_mipmaps
operator|=
name|get_num_mipmaps
argument_list|(
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|layers
operator|->
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|list
operator|=
name|layers
init|;
name|list
condition|;
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|type
operator|!=
name|gimp_drawable_type
argument_list|(
name|list
operator|->
name|data
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|==
name|w
operator|)
operator|&&
operator|(
name|gimp_drawable_height
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|==
name|h
operator|)
condition|)
operator|++
name|num_surfaces
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|num_surfaces
operator|<
name|min_surfaces
operator|)
operator|||
operator|(
name|num_surfaces
operator|>
name|max_surfaces
operator|)
operator|||
operator|(
name|num_layers
operator|!=
operator|(
name|num_surfaces
operator|*
name|num_mipmaps
operator|)
operator|)
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|valid
operator|&&
name|i
operator|<
name|num_layers
condition|;
name|i
operator|+=
name|num_mipmaps
control|)
block|{
name|GimpDrawable
modifier|*
name|drawable
init|=
name|g_list_nth_data
argument_list|(
name|layers
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|drawable
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|drawable
argument_list|)
operator|!=
name|h
operator|)
condition|)
block|{
name|valid
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|num_mipmaps
condition|;
operator|++
name|j
control|)
block|{
name|drawable
operator|=
name|g_list_nth_data
argument_list|(
name|layers
argument_list|,
name|i
operator|+
name|j
argument_list|)
expr_stmt|;
name|mipw
operator|=
name|w
operator|>>
name|j
expr_stmt|;
name|miph
operator|=
name|h
operator|>>
name|j
expr_stmt|;
if|if
condition|(
name|mipw
operator|<
literal|1
condition|)
name|mipw
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|miph
operator|<
literal|1
condition|)
name|miph
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|drawable
argument_list|)
operator|!=
name|mipw
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|drawable
argument_list|)
operator|!=
name|miph
operator|)
condition|)
block|{
name|valid
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|valid
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|check_cubemap (GimpImage * image)
name|check_cubemap
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|)
block|{
name|GList
modifier|*
name|layers
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|num_layers
decl_stmt|;
name|gboolean
name|cubemap
init|=
name|TRUE
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|gint
name|w
decl_stmt|,
name|h
decl_stmt|;
name|gchar
modifier|*
name|layer_name
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
name|layers
operator|=
name|gimp_image_list_layers
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|num_layers
operator|=
name|g_list_length
argument_list|(
name|layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|<
literal|6
condition|)
return|return
name|FALSE
return|;
comment|/* check for a valid cubemap with mipmap layers */
if|if
condition|(
name|num_layers
operator|>
literal|6
condition|)
block|{
comment|/* check that mipmap layers are in order for a cubemap */
if|if
condition|(
operator|!
name|check_mipmaps
argument_list|(
name|image
argument_list|,
name|DDS_SAVE_CUBEMAP
argument_list|)
condition|)
return|return
name|FALSE
return|;
comment|/* invalidate cubemap faces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
name|cubemap_faces
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* find the mipmap level 0 layers */
name|w
operator|=
name|gimp_image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|list
operator|=
name|layers
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|GimpDrawable
modifier|*
name|drawable
init|=
name|list
operator|->
name|data
decl_stmt|;
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|drawable
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|drawable
argument_list|)
operator|!=
name|h
operator|)
condition|)
continue|continue;
name|layer_name
operator|=
operator|(
name|char
operator|*
operator|)
name|gimp_item_get_name
argument_list|(
name|GIMP_ITEM
argument_list|(
name|drawable
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|6
condition|;
operator|++
name|j
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|4
condition|;
operator|++
name|k
control|)
block|{
if|if
condition|(
name|strstr
argument_list|(
name|layer_name
argument_list|,
name|cubemap_face_names
index|[
name|k
index|]
index|[
name|j
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|cubemap_faces
index|[
name|j
index|]
operator|==
name|NULL
condition|)
block|{
name|cubemap_faces
index|[
name|j
index|]
operator|=
name|GIMP_LAYER
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
comment|/* check for 6 valid faces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|cubemap_faces
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|cubemap
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
block|}
comment|/* make sure they are all the same type */
if|if
condition|(
name|cubemap
condition|)
block|{
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|6
operator|&&
name|cubemap
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
argument_list|)
operator|!=
name|type
condition|)
name|cubemap
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|num_layers
operator|==
literal|6
condition|)
block|{
comment|/* invalidate cubemap faces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
name|cubemap_faces
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|list
operator|=
name|layers
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|layers
argument_list|)
control|)
block|{
name|GimpLayer
modifier|*
name|layer
init|=
name|list
operator|->
name|data
decl_stmt|;
name|layer_name
operator|=
operator|(
name|gchar
operator|*
operator|)
name|gimp_item_get_name
argument_list|(
name|GIMP_ITEM
argument_list|(
name|layer
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|6
condition|;
operator|++
name|j
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|4
condition|;
operator|++
name|k
control|)
block|{
if|if
condition|(
name|strstr
argument_list|(
name|layer_name
argument_list|,
name|cubemap_face_names
index|[
name|k
index|]
index|[
name|j
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|cubemap_faces
index|[
name|j
index|]
operator|==
name|NULL
condition|)
block|{
name|cubemap_faces
index|[
name|j
index|]
operator|=
name|layer
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
comment|/* check for 6 valid faces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|cubemap_faces
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|cubemap
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
block|}
comment|/* make sure they are all the same size */
if|if
condition|(
name|cubemap
condition|)
block|{
name|w
operator|=
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|6
operator|&&
name|cubemap
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
argument_list|)
operator|!=
name|h
operator|)
condition|)
name|cubemap
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
comment|/* make sure they are all the same type */
if|if
condition|(
name|cubemap
condition|)
block|{
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|6
operator|&&
name|cubemap
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
argument_list|)
operator|!=
name|type
condition|)
name|cubemap
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|check_volume (GimpImage * image)
name|check_volume
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|)
block|{
name|GList
modifier|*
name|layers
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|num_layers
decl_stmt|;
name|gboolean
name|volume
init|=
name|FALSE
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|w
decl_stmt|,
name|h
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
name|layers
operator|=
name|gimp_image_list_layers
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|num_layers
operator|=
name|g_list_length
argument_list|(
name|layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|>
literal|1
condition|)
block|{
name|volume
operator|=
name|TRUE
expr_stmt|;
comment|/* make sure all layers are the same size */
name|w
operator|=
name|gimp_drawable_width
argument_list|(
name|layers
operator|->
name|data
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_drawable_height
argument_list|(
name|layers
operator|->
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
operator|,
name|list
operator|=
name|layers
operator|->
name|next
init|;
name|i
operator|<
name|num_layers
operator|&&
name|volume
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|!=
name|h
operator|)
condition|)
name|volume
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|volume
condition|)
block|{
comment|/* make sure all layers are the same type */
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|layers
operator|->
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
operator|,
name|list
operator|=
name|layers
operator|->
name|next
init|;
name|i
operator|<
name|num_layers
operator|&&
name|volume
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|!=
name|type
condition|)
name|volume
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
block|}
return|return
name|volume
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|check_array (GimpImage * image)
name|check_array
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|)
block|{
name|GList
modifier|*
name|layers
decl_stmt|;
name|gint
name|num_layers
decl_stmt|;
name|gboolean
name|array
init|=
name|FALSE
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|w
decl_stmt|,
name|h
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
if|if
condition|(
name|check_mipmaps
argument_list|(
name|image
argument_list|,
name|DDS_SAVE_ARRAY
argument_list|)
condition|)
return|return
literal|1
return|;
name|layers
operator|=
name|gimp_image_list_layers
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|num_layers
operator|=
name|g_list_length
argument_list|(
name|layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|>
literal|1
condition|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|array
operator|=
name|TRUE
expr_stmt|;
comment|/* make sure all layers are the same size */
name|w
operator|=
name|gimp_drawable_width
argument_list|(
name|layers
operator|->
name|data
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_drawable_height
argument_list|(
name|layers
operator|->
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|layers
argument_list|)
init|;
name|i
operator|<
name|num_layers
operator|&&
name|array
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|!=
name|h
operator|)
condition|)
name|array
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|array
condition|)
block|{
comment|/* make sure all layers are the same type */
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|layers
operator|->
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|layers
argument_list|)
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|!=
name|type
condition|)
block|{
name|array
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
name|g_list_free
argument_list|(
name|layers
argument_list|)
expr_stmt|;
return|return
name|array
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|get_array_size (GimpImage * image)
name|get_array_size
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|)
block|{
name|GList
modifier|*
name|layers
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|num_layers
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|w
decl_stmt|,
name|h
decl_stmt|;
name|gint
name|elements
init|=
literal|0
decl_stmt|;
name|layers
operator|=
name|gimp_image_list_layers
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|num_layers
operator|=
name|g_list_length
argument_list|(
name|layers
argument_list|)
expr_stmt|;
name|w
operator|=
name|gimp_image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|list
operator|=
name|layers
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|==
name|w
operator|)
operator|&&
operator|(
name|gimp_drawable_height
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|==
name|h
operator|)
condition|)
block|{
name|elements
operator|++
expr_stmt|;
block|}
block|}
name|g_list_free
argument_list|(
name|layers
argument_list|)
expr_stmt|;
return|return
name|elements
return|;
block|}
end_function

begin_function
name|GimpPDBStatusType
DECL|function|write_dds (GFile * file,GimpImage * image,GimpDrawable * drawable,gboolean interactive,GimpProcedure * procedure,GObject * config)
name|write_dds
parameter_list|(
name|GFile
modifier|*
name|file
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|gboolean
name|interactive
parameter_list|,
name|GimpProcedure
modifier|*
name|procedure
parameter_list|,
name|GObject
modifier|*
name|config
parameter_list|)
block|{
name|gchar
modifier|*
name|filename
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|gint
name|rc
init|=
literal|0
decl_stmt|;
name|gint
name|compression
decl_stmt|;
name|gint
name|mipmaps
decl_stmt|;
name|gint
name|savetype
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"compression-format"
argument_list|,
operator|&
name|compression
argument_list|,
literal|"mipmaps"
argument_list|,
operator|&
name|mipmaps
argument_list|,
literal|"save-type"
argument_list|,
operator|&
name|savetype
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|is_mipmap_chain_valid
operator|=
name|check_mipmaps
argument_list|(
name|image
argument_list|,
name|savetype
argument_list|)
expr_stmt|;
name|is_cubemap
operator|=
name|check_cubemap
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|is_volume
operator|=
name|check_volume
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|is_array
operator|=
name|check_array
argument_list|(
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
name|interactive
condition|)
block|{
if|if
condition|(
operator|!
name|is_mipmap_chain_valid
operator|&&
name|mipmaps
operator|==
name|DDS_MIPMAP_EXISTING
condition|)
name|mipmaps
operator|=
name|DDS_MIPMAP_NONE
expr_stmt|;
if|if
condition|(
operator|!
name|save_dialog
argument_list|(
name|image
argument_list|,
name|drawable
argument_list|,
name|procedure
argument_list|,
name|config
argument_list|)
condition|)
return|return
name|GIMP_PDB_CANCEL
return|;
block|}
else|else
block|{
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_CUBEMAP
operator|&&
operator|!
name|is_cubemap
condition|)
block|{
name|g_message
argument_list|(
literal|"DDS: Cannot save image as cube map"
argument_list|)
expr_stmt|;
return|return
name|GIMP_PDB_EXECUTION_ERROR
return|;
block|}
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
operator|&&
operator|!
name|is_volume
condition|)
block|{
name|g_message
argument_list|(
literal|"DDS: Cannot save image as volume map"
argument_list|)
expr_stmt|;
return|return
name|GIMP_PDB_EXECUTION_ERROR
return|;
block|}
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
operator|&&
name|compression
operator|!=
name|DDS_COMPRESS_NONE
condition|)
block|{
name|g_message
argument_list|(
literal|"DDS: Cannot save volume map with compression"
argument_list|)
expr_stmt|;
return|return
name|GIMP_PDB_EXECUTION_ERROR
return|;
block|}
if|if
condition|(
name|mipmaps
operator|==
name|DDS_MIPMAP_EXISTING
operator|&&
operator|!
name|is_mipmap_chain_valid
condition|)
block|{
name|g_message
argument_list|(
literal|"DDS: Cannot save with existing mipmaps as the mipmap chain is incomplete"
argument_list|)
expr_stmt|;
return|return
name|GIMP_PDB_EXECUTION_ERROR
return|;
block|}
block|}
name|filename
operator|=
name|g_file_get_path
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|fp
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|g_message
argument_list|(
literal|"Error opening %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
name|GIMP_PDB_EXECUTION_ERROR
return|;
block|}
name|gimp_progress_init_printf
argument_list|(
literal|"Saving %s:"
argument_list|,
name|gimp_file_get_utf8_name
argument_list|(
name|file
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_image
argument_list|(
name|fp
argument_list|,
name|image
argument_list|,
name|drawable
argument_list|,
name|config
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|rc
condition|?
name|GIMP_PDB_SUCCESS
else|:
name|GIMP_PDB_EXECUTION_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|swap_rb (unsigned char * pixels,unsigned int n,int bpp)
name|swap_rb
parameter_list|(
name|unsigned
name|char
modifier|*
name|pixels
parameter_list|,
name|unsigned
name|int
name|n
parameter_list|,
name|int
name|bpp
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|unsigned
name|char
name|t
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
name|t
operator|=
name|pixels
index|[
name|bpp
operator|*
name|i
operator|+
literal|0
index|]
expr_stmt|;
name|pixels
index|[
name|bpp
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|pixels
index|[
name|bpp
operator|*
name|i
operator|+
literal|2
index|]
expr_stmt|;
name|pixels
index|[
name|bpp
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|t
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|alpha_exp (unsigned char * dst,int r,int g,int b,int a)
name|alpha_exp
parameter_list|(
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|int
name|r
parameter_list|,
name|int
name|g
parameter_list|,
name|int
name|b
parameter_list|,
name|int
name|a
parameter_list|)
block|{
name|float
name|ar
decl_stmt|,
name|ag
decl_stmt|,
name|ab
decl_stmt|,
name|aa
decl_stmt|;
name|ar
operator|=
operator|(
name|float
operator|)
name|r
operator|/
literal|255.0f
expr_stmt|;
name|ag
operator|=
operator|(
name|float
operator|)
name|g
operator|/
literal|255.0f
expr_stmt|;
name|ab
operator|=
operator|(
name|float
operator|)
name|b
operator|/
literal|255.0f
expr_stmt|;
name|aa
operator|=
name|MAX
argument_list|(
name|ar
argument_list|,
name|MAX
argument_list|(
name|ag
argument_list|,
name|ab
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|aa
operator|<
literal|1e-04f
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
name|b
expr_stmt|;
name|dst
index|[
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|2
index|]
operator|=
name|r
expr_stmt|;
name|dst
index|[
literal|3
index|]
operator|=
literal|255
expr_stmt|;
return|return;
block|}
name|ar
operator|/=
name|aa
expr_stmt|;
name|ag
operator|/=
name|aa
expr_stmt|;
name|ab
operator|/=
name|aa
expr_stmt|;
name|r
operator|=
operator|(
name|int
operator|)
name|floorf
argument_list|(
literal|255.0f
operator|*
name|ar
operator|+
literal|0.5f
argument_list|)
expr_stmt|;
name|g
operator|=
operator|(
name|int
operator|)
name|floorf
argument_list|(
literal|255.0f
operator|*
name|ag
operator|+
literal|0.5f
argument_list|)
expr_stmt|;
name|b
operator|=
operator|(
name|int
operator|)
name|floorf
argument_list|(
literal|255.0f
operator|*
name|ab
operator|+
literal|0.5f
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|int
operator|)
name|floorf
argument_list|(
literal|255.0f
operator|*
name|aa
operator|+
literal|0.5f
argument_list|)
expr_stmt|;
name|dst
index|[
literal|0
index|]
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|255
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|dst
index|[
literal|1
index|]
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|255
argument_list|,
name|g
argument_list|)
argument_list|)
expr_stmt|;
name|dst
index|[
literal|2
index|]
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|255
argument_list|,
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|dst
index|[
literal|3
index|]
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|255
argument_list|,
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|convert_pixels (unsigned char * dst,unsigned char * src,int format,int w,int h,int d,int bpp,unsigned char * palette,int mipmaps)
name|convert_pixels
parameter_list|(
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|unsigned
name|char
modifier|*
name|src
parameter_list|,
name|int
name|format
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|bpp
parameter_list|,
name|unsigned
name|char
modifier|*
name|palette
parameter_list|,
name|int
name|mipmaps
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|num_pixels
decl_stmt|;
name|unsigned
name|char
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|,
name|a
decl_stmt|;
if|if
condition|(
name|d
operator|>
literal|0
condition|)
name|num_pixels
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
else|else
name|num_pixels
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_pixels
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|palette
condition|)
block|{
name|r
operator|=
name|palette
index|[
literal|3
operator|*
name|src
index|[
name|i
index|]
operator|+
literal|0
index|]
expr_stmt|;
name|g
operator|=
name|palette
index|[
literal|3
operator|*
name|src
index|[
name|i
index|]
operator|+
literal|1
index|]
expr_stmt|;
name|b
operator|=
name|palette
index|[
literal|3
operator|*
name|src
index|[
name|i
index|]
operator|+
literal|2
index|]
expr_stmt|;
block|}
else|else
name|r
operator|=
name|g
operator|=
name|b
operator|=
name|src
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|format
operator|==
name|DDS_FORMAT_A8
condition|)
name|a
operator|=
name|src
index|[
name|i
index|]
expr_stmt|;
else|else
name|a
operator|=
literal|255
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
block|{
name|r
operator|=
name|g
operator|=
name|b
operator|=
name|src
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|a
operator|=
name|src
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
block|{
name|b
operator|=
name|src
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
expr_stmt|;
name|g
operator|=
name|src
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|r
operator|=
name|src
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
expr_stmt|;
name|a
operator|=
literal|255
expr_stmt|;
block|}
else|else
block|{
name|b
operator|=
name|src
index|[
literal|4
operator|*
name|i
operator|+
literal|0
index|]
expr_stmt|;
name|g
operator|=
name|src
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|r
operator|=
name|src
index|[
literal|4
operator|*
name|i
operator|+
literal|2
index|]
expr_stmt|;
name|a
operator|=
name|src
index|[
literal|4
operator|*
name|i
operator|+
literal|3
index|]
expr_stmt|;
block|}
switch|switch
condition|(
name|format
condition|)
block|{
case|case
name|DDS_FORMAT_RGB8
case|:
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|b
expr_stmt|;
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|r
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_RGBA8
case|:
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|b
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|r
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|3
index|]
operator|=
name|a
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_BGR8
case|:
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|r
expr_stmt|;
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|b
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_ABGR8
case|:
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|r
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|b
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|3
index|]
operator|=
name|a
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_R5G6B5
case|:
name|PUTL16
argument_list|(
operator|&
name|dst
index|[
literal|2
operator|*
name|i
index|]
argument_list|,
name|pack_r5g6b5
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_RGBA4
case|:
name|PUTL16
argument_list|(
operator|&
name|dst
index|[
literal|2
operator|*
name|i
index|]
argument_list|,
name|pack_rgba4
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|a
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_RGB5A1
case|:
name|PUTL16
argument_list|(
operator|&
name|dst
index|[
literal|2
operator|*
name|i
index|]
argument_list|,
name|pack_rgb5a1
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|a
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_RGB10A2
case|:
name|PUTL32
argument_list|(
operator|&
name|dst
index|[
literal|4
operator|*
name|i
index|]
argument_list|,
name|pack_rgb10a2
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|a
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_R3G3B2
case|:
name|dst
index|[
name|i
index|]
operator|=
name|pack_r3g3b2
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_A8
case|:
name|dst
index|[
name|i
index|]
operator|=
name|a
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_L8
case|:
name|dst
index|[
name|i
index|]
operator|=
name|rgb_to_luminance
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_L8A8
case|:
name|dst
index|[
literal|2
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|rgb_to_luminance
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|dst
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|a
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_YCOCG
case|:
name|dst
index|[
literal|4
operator|*
name|i
index|]
operator|=
name|a
expr_stmt|;
name|RGB_to_YCoCg
argument_list|(
operator|&
name|dst
index|[
literal|4
operator|*
name|i
index|]
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_AEXP
case|:
name|alpha_exp
argument_list|(
operator|&
name|dst
index|[
literal|4
operator|*
name|i
index|]
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|get_mipmap_chain (unsigned char * dst,int w,int h,int bpp,GimpImage * image,GimpDrawable * drawable)
name|get_mipmap_chain
parameter_list|(
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|bpp
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|)
block|{
name|GList
modifier|*
name|layers
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|num_layers
decl_stmt|;
name|GeglBuffer
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|Babl
modifier|*
name|format
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|idx
init|=
literal|0
decl_stmt|;
name|gint
name|offset
decl_stmt|;
name|gint
name|mipw
decl_stmt|,
name|miph
decl_stmt|;
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y' u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y'A u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
else|else
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
expr_stmt|;
name|layers
operator|=
name|gimp_image_list_layers
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|num_layers
operator|=
name|g_list_length
argument_list|(
name|layers
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|list
operator|=
name|layers
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|list
operator|->
name|data
operator|==
name|drawable
condition|)
block|{
name|idx
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|num_layers
condition|)
return|return;
name|offset
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|get_next_mipmap_dimensions
argument_list|(
operator|&
name|mipw
argument_list|,
operator|&
name|miph
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
condition|)
block|{
name|buffer
operator|=
name|gimp_drawable_get_buffer
argument_list|(
name|g_list_nth_data
argument_list|(
name|layers
argument_list|,
operator|++
name|idx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|gegl_buffer_get_width
argument_list|(
name|buffer
argument_list|)
operator|!=
name|mipw
operator|)
operator|||
operator|(
name|gegl_buffer_get_height
argument_list|(
name|buffer
argument_list|)
operator|!=
name|miph
operator|)
condition|)
block|{
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return;
block|}
name|gegl_buffer_get
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|mipw
argument_list|,
name|miph
argument_list|)
argument_list|,
literal|1.0
argument_list|,
name|format
argument_list|,
name|dst
operator|+
name|offset
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|,
name|GEGL_ABYSS_NONE
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
comment|/* we need BGRX or BGRA */
if|if
condition|(
name|bpp
operator|>=
literal|3
condition|)
name|swap_rb
argument_list|(
name|dst
operator|+
name|offset
argument_list|,
name|mipw
operator|*
name|miph
argument_list|,
name|bpp
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
name|mipw
operator|*
name|miph
operator|*
name|bpp
operator|)
expr_stmt|;
name|w
operator|=
name|mipw
expr_stmt|;
name|h
operator|=
name|miph
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|write_layer (FILE * fp,GimpImage * image,GimpDrawable * drawable,GObject * config,int w,int h,int bpp,int fmtbpp,int num_mipmaps)
name|write_layer
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|GObject
modifier|*
name|config
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|bpp
parameter_list|,
name|int
name|fmtbpp
parameter_list|,
name|int
name|num_mipmaps
parameter_list|)
block|{
name|GeglBuffer
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|Babl
modifier|*
name|format
decl_stmt|;
name|GimpImageBaseType
name|basetype
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
name|guchar
modifier|*
name|src
decl_stmt|;
name|guchar
modifier|*
name|dst
decl_stmt|;
name|guchar
modifier|*
name|fmtdst
decl_stmt|;
name|guchar
modifier|*
name|tmp
decl_stmt|;
name|guchar
modifier|*
name|palette
init|=
name|NULL
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|c
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|;
name|gint
name|size
decl_stmt|;
name|gint
name|fmtsize
decl_stmt|;
name|gint
name|offset
decl_stmt|;
name|gint
name|colors
decl_stmt|;
name|gint
name|compression
decl_stmt|;
name|gint
name|mipmaps
decl_stmt|;
name|gint
name|pixel_format
decl_stmt|;
name|gboolean
name|perceptual_metric
decl_stmt|;
name|gint
name|flags
init|=
literal|0
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"compression-format"
argument_list|,
operator|&
name|compression
argument_list|,
literal|"mipmaps"
argument_list|,
operator|&
name|mipmaps
argument_list|,
literal|"format"
argument_list|,
operator|&
name|pixel_format
argument_list|,
literal|"perceptual-metric"
argument_list|,
operator|&
name|perceptual_metric
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|basetype
operator|=
name|gimp_image_base_type
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|gimp_drawable_get_buffer
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|src
operator|=
name|g_malloc
argument_list|(
name|w
operator|*
name|h
operator|*
name|bpp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y' u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y'A u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
else|else
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
expr_stmt|;
name|gegl_buffer_get
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
argument_list|,
literal|1.0
argument_list|,
name|format
argument_list|,
name|src
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|,
name|GEGL_ABYSS_NONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|palette
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|GIMP_INDEXEDA_IMAGE
condition|)
block|{
name|tmp
operator|=
name|g_malloc
argument_list|(
name|w
operator|*
name|h
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|w
operator|*
name|h
condition|;
operator|++
name|i
control|)
name|tmp
index|[
name|i
index|]
operator|=
name|src
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|tmp
expr_stmt|;
name|bpp
operator|=
literal|1
expr_stmt|;
block|}
block|}
comment|/* we want and assume BGRA ordered pixels for bpp>= 3 from here and      onwards */
if|if
condition|(
name|bpp
operator|>=
literal|3
condition|)
name|swap_rb
argument_list|(
name|src
argument_list|,
name|w
operator|*
name|h
argument_list|,
name|bpp
argument_list|)
expr_stmt|;
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_BC3N
condition|)
block|{
if|if
condition|(
name|bpp
operator|!=
literal|4
condition|)
block|{
name|fmtsize
operator|=
name|w
operator|*
name|h
operator|*
literal|4
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGBA8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|4
expr_stmt|;
block|}
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|h
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|w
condition|;
operator|++
name|x
control|)
block|{
comment|/* set alpha to red (x) */
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|3
index|]
operator|=
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|2
index|]
expr_stmt|;
comment|/* set red to 1 */
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|2
index|]
operator|=
literal|255
expr_stmt|;
block|}
block|}
block|}
comment|/* RXGB (Doom3) */
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_RXGB
condition|)
block|{
if|if
condition|(
name|bpp
operator|!=
literal|4
condition|)
block|{
name|fmtsize
operator|=
name|w
operator|*
name|h
operator|*
literal|4
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGBA8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|4
expr_stmt|;
block|}
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|h
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|w
condition|;
operator|++
name|x
control|)
block|{
comment|/* swap red and alpha */
name|c
operator|=
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|3
index|]
expr_stmt|;
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|3
index|]
operator|=
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|2
index|]
expr_stmt|;
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|2
index|]
operator|=
name|c
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_YCOCG
operator|||
name|compression
operator|==
name|DDS_COMPRESS_YCOCGS
condition|)
comment|/* convert to YCoCG */
block|{
name|fmtsize
operator|=
name|w
operator|*
name|h
operator|*
literal|4
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_YCOCG
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_AEXP
condition|)
block|{
name|fmtsize
operator|=
name|w
operator|*
name|h
operator|*
literal|4
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_AEXP
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_NONE
condition|)
block|{
if|if
condition|(
name|num_mipmaps
operator|>
literal|1
condition|)
block|{
comment|/* pre-convert indexed images to RGB for better quality mipmaps              if a pixel format conversion is requested */
if|if
condition|(
name|pixel_format
operator|>
name|DDS_FORMAT_DEFAULT
operator|&&
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|fmtsize
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGB8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|3
expr_stmt|;
name|palette
operator|=
name|NULL
expr_stmt|;
block|}
name|size
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|dst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
condition|)
block|{
name|gint
name|mipmap_filter
decl_stmt|;
name|gint
name|mipmap_wrap
decl_stmt|;
name|gboolean
name|gamma_correct
decl_stmt|;
name|gboolean
name|srgb
decl_stmt|;
name|gdouble
name|gamma
decl_stmt|;
name|gboolean
name|preserve_alpha_coverage
decl_stmt|;
name|gdouble
name|alpha_test_threshold
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"mipmap-filter"
argument_list|,
operator|&
name|mipmap_filter
argument_list|,
literal|"mipmap-wrap"
argument_list|,
operator|&
name|mipmap_wrap
argument_list|,
literal|"gamma-correct"
argument_list|,
operator|&
name|gamma_correct
argument_list|,
literal|"srgb"
argument_list|,
operator|&
name|srgb
argument_list|,
literal|"gamma"
argument_list|,
operator|&
name|gamma
argument_list|,
literal|"preserve-alpha-coverage"
argument_list|,
operator|&
name|preserve_alpha_coverage
argument_list|,
literal|"alpha-test-threshold"
argument_list|,
operator|&
name|alpha_test_threshold
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|generate_mipmaps
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|palette
operator|!=
name|NULL
argument_list|,
name|num_mipmaps
argument_list|,
name|mipmap_filter
argument_list|,
name|mipmap_wrap
argument_list|,
name|gamma_correct
operator|+
name|srgb
argument_list|,
name|gamma
argument_list|,
name|preserve_alpha_coverage
argument_list|,
name|alpha_test_threshold
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|w
operator|*
name|h
operator|*
name|bpp
argument_list|)
expr_stmt|;
name|get_mipmap_chain
argument_list|(
name|dst
operator|+
operator|(
name|w
operator|*
name|h
operator|*
name|bpp
operator|)
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|image
argument_list|,
name|drawable
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pixel_format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
name|fmtsize
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|fmtbpp
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|dst
argument_list|,
name|pixel_format
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
name|fmtbpp
expr_stmt|;
block|}
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_mipmaps
condition|;
operator|++
name|i
control|)
block|{
name|size
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|dst
operator|+
name|offset
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|size
expr_stmt|;
block|}
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pixel_format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|h
operator|*
name|w
operator|*
name|fmtbpp
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|pixel_format
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
name|fmtbpp
expr_stmt|;
block|}
name|fwrite
argument_list|(
name|src
argument_list|,
literal|1
argument_list|,
name|h
operator|*
name|w
operator|*
name|bpp
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|size
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|compression
argument_list|)
expr_stmt|;
name|dst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|fmtsize
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGB8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|3
expr_stmt|;
block|}
if|if
condition|(
name|num_mipmaps
operator|>
literal|1
condition|)
block|{
name|fmtsize
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
condition|)
block|{
name|gint
name|mipmap_filter
decl_stmt|;
name|gint
name|mipmap_wrap
decl_stmt|;
name|gboolean
name|gamma_correct
decl_stmt|;
name|gboolean
name|srgb
decl_stmt|;
name|gdouble
name|gamma
decl_stmt|;
name|gboolean
name|preserve_alpha_coverage
decl_stmt|;
name|gdouble
name|alpha_test_threshold
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"mipmap-filter"
argument_list|,
operator|&
name|mipmap_filter
argument_list|,
literal|"mipmap-wrap"
argument_list|,
operator|&
name|mipmap_wrap
argument_list|,
literal|"gamma-correct"
argument_list|,
operator|&
name|gamma_correct
argument_list|,
literal|"srgb"
argument_list|,
operator|&
name|srgb
argument_list|,
literal|"gamma"
argument_list|,
operator|&
name|gamma
argument_list|,
literal|"preserve-alpha-coverage"
argument_list|,
operator|&
name|preserve_alpha_coverage
argument_list|,
literal|"alpha-test-threshold"
argument_list|,
operator|&
name|alpha_test_threshold
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|generate_mipmaps
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|mipmap_filter
argument_list|,
name|mipmap_wrap
argument_list|,
name|gamma_correct
operator|+
name|srgb
argument_list|,
name|gamma
argument_list|,
name|preserve_alpha_coverage
argument_list|,
name|alpha_test_threshold
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|w
operator|*
name|h
operator|*
name|bpp
argument_list|)
expr_stmt|;
name|get_mipmap_chain
argument_list|(
name|fmtdst
operator|+
operator|(
name|w
operator|*
name|h
operator|*
name|bpp
operator|)
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|image
argument_list|,
name|drawable
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
block|}
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|perceptual_metric
condition|)
name|flags
operator||=
name|DXT_PERCEPTUAL
expr_stmt|;
name|dxt_compress
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|compression
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|num_mipmaps
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|dst
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|write_volume_mipmaps (FILE * fp,GimpImage * image,GObject * config,GList * layers,int w,int h,int d,int bpp,int fmtbpp,int num_mipmaps)
name|write_volume_mipmaps
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|GObject
modifier|*
name|config
parameter_list|,
name|GList
modifier|*
name|layers
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|bpp
parameter_list|,
name|int
name|fmtbpp
parameter_list|,
name|int
name|num_mipmaps
parameter_list|)
block|{
name|GList
modifier|*
name|list
decl_stmt|;
name|gint
name|i
decl_stmt|;
name|gint
name|size
decl_stmt|;
name|gint
name|offset
decl_stmt|;
name|gint
name|colors
decl_stmt|;
name|guchar
modifier|*
name|src
decl_stmt|;
name|guchar
modifier|*
name|dst
decl_stmt|;
name|guchar
modifier|*
name|tmp
decl_stmt|;
name|guchar
modifier|*
name|fmtdst
decl_stmt|;
name|guchar
modifier|*
name|palette
init|=
literal|0
decl_stmt|;
name|GeglBuffer
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|Babl
modifier|*
name|format
decl_stmt|;
name|GimpImageBaseType
name|type
decl_stmt|;
name|gint
name|compression
decl_stmt|;
name|gint
name|pixel_format
decl_stmt|;
name|gint
name|mipmap_filter
decl_stmt|;
name|gint
name|mipmap_wrap
decl_stmt|;
name|gboolean
name|gamma_correct
decl_stmt|;
name|gboolean
name|srgb
decl_stmt|;
name|gdouble
name|gamma
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"compression-format"
argument_list|,
operator|&
name|compression
argument_list|,
literal|"format"
argument_list|,
operator|&
name|pixel_format
argument_list|,
literal|"mipmap-filter"
argument_list|,
operator|&
name|mipmap_filter
argument_list|,
literal|"mipmap-wrap"
argument_list|,
operator|&
name|mipmap_wrap
argument_list|,
literal|"gamma-correct"
argument_list|,
operator|&
name|gamma_correct
argument_list|,
literal|"srgb"
argument_list|,
operator|&
name|srgb
argument_list|,
literal|"gamma"
argument_list|,
operator|&
name|gamma
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|type
operator|=
name|gimp_image_base_type
argument_list|(
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
name|compression
operator|!=
name|DDS_COMPRESS_NONE
condition|)
return|return;
name|src
operator|=
name|g_malloc
argument_list|(
name|w
operator|*
name|h
operator|*
name|bpp
operator|*
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y' u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y'A u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
else|else
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_image_base_type
argument_list|(
name|image
argument_list|)
operator|==
name|GIMP_INDEXED
condition|)
name|palette
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|list
operator|=
name|layers
init|;
name|i
operator|<
name|d
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|list
argument_list|)
control|)
block|{
name|buffer
operator|=
name|gimp_drawable_get_buffer
argument_list|(
name|list
operator|->
name|data
argument_list|)
expr_stmt|;
name|gegl_buffer_get
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
argument_list|,
literal|1.0
argument_list|,
name|format
argument_list|,
name|src
operator|+
name|offset
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|,
name|GEGL_ABYSS_NONE
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
name|w
operator|*
name|h
operator|*
name|bpp
operator|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|layers
operator|->
name|data
argument_list|)
operator|==
name|GIMP_INDEXEDA_IMAGE
condition|)
block|{
name|tmp
operator|=
name|g_malloc
argument_list|(
name|w
operator|*
name|h
operator|*
name|d
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|w
operator|*
name|h
operator|*
name|d
condition|;
operator|++
name|i
control|)
name|tmp
index|[
name|i
index|]
operator|=
name|src
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|tmp
expr_stmt|;
name|bpp
operator|=
literal|1
expr_stmt|;
block|}
comment|/* we want and assume BGRA ordered pixels for bpp>= 3 from here and      onwards */
if|if
condition|(
name|bpp
operator|>=
literal|3
condition|)
name|swap_rb
argument_list|(
name|src
argument_list|,
name|w
operator|*
name|h
operator|*
name|d
argument_list|,
name|bpp
argument_list|)
expr_stmt|;
comment|/* pre-convert indexed images to RGB for better mipmaps if a      pixel format conversion is requested */
if|if
condition|(
name|pixel_format
operator|>
name|DDS_FORMAT_DEFAULT
operator|&&
name|type
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|size
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|dst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGB8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|dst
expr_stmt|;
name|bpp
operator|=
literal|3
expr_stmt|;
name|palette
operator|=
name|NULL
expr_stmt|;
block|}
name|size
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|compression
argument_list|)
expr_stmt|;
name|dst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|offset
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|compression
argument_list|)
expr_stmt|;
name|generate_volume_mipmaps
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
name|palette
operator|!=
name|NULL
argument_list|,
name|num_mipmaps
argument_list|,
name|mipmap_filter
argument_list|,
name|mipmap_wrap
argument_list|,
name|gamma_correct
operator|+
name|srgb
argument_list|,
name|gamma
argument_list|)
expr_stmt|;
if|if
condition|(
name|pixel_format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
name|size
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|fmtbpp
argument_list|,
literal|0
argument_list|,
name|num_mipmaps
argument_list|,
name|compression
argument_list|)
expr_stmt|;
name|offset
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|fmtbpp
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|compression
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|dst
argument_list|,
name|pixel_format
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|=
name|fmtdst
expr_stmt|;
block|}
name|fwrite
argument_list|(
name|dst
operator|+
name|offset
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|write_image (FILE * fp,GimpImage * image,GimpDrawable * drawable,GObject * config)
name|write_image
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|GObject
modifier|*
name|config
parameter_list|)
block|{
name|GimpImageType
name|drawable_type
decl_stmt|;
name|GimpImageBaseType
name|basetype
decl_stmt|;
name|gint
name|i
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|gint
name|bpp
init|=
literal|0
decl_stmt|;
name|gint
name|fmtbpp
init|=
literal|0
decl_stmt|;
name|gint
name|has_alpha
init|=
literal|0
decl_stmt|;
name|gint
name|num_mipmaps
decl_stmt|;
name|guchar
name|hdr
index|[
name|DDS_HEADERSIZE
index|]
decl_stmt|;
name|guchar
name|hdr10
index|[
name|DDS_HEADERSIZE_DX10
index|]
decl_stmt|;
name|guint
name|flags
init|=
literal|0
decl_stmt|,
name|pflags
init|=
literal|0
decl_stmt|,
name|caps
init|=
literal|0
decl_stmt|,
name|caps2
init|=
literal|0
decl_stmt|,
name|size
init|=
literal|0
decl_stmt|;
name|guint
name|rmask
init|=
literal|0
decl_stmt|,
name|gmask
init|=
literal|0
decl_stmt|,
name|bmask
init|=
literal|0
decl_stmt|,
name|amask
init|=
literal|0
decl_stmt|;
name|guint
name|fourcc
init|=
literal|0
decl_stmt|;
name|DXGI_FORMAT
name|dxgi_format
init|=
name|DXGI_FORMAT_UNKNOWN
decl_stmt|;
name|gint32
name|num_layers
decl_stmt|;
name|GList
modifier|*
name|layers
decl_stmt|;
name|GList
modifier|*
name|list
decl_stmt|;
name|guchar
modifier|*
name|cmap
decl_stmt|;
name|gint
name|colors
decl_stmt|;
name|guchar
name|zero
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|gint
name|is_dx10
init|=
literal|0
decl_stmt|;
name|gint
name|array_size
init|=
literal|1
decl_stmt|;
name|gint
name|compression
decl_stmt|;
name|gint
name|mipmaps
decl_stmt|;
name|gint
name|savetype
decl_stmt|;
name|gint
name|pixel_format
decl_stmt|;
name|gint
name|transindex
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"compression-format"
argument_list|,
operator|&
name|compression
argument_list|,
literal|"mipmaps"
argument_list|,
operator|&
name|mipmaps
argument_list|,
literal|"save-type"
argument_list|,
operator|&
name|savetype
argument_list|,
literal|"format"
argument_list|,
operator|&
name|pixel_format
argument_list|,
literal|"transparent-index"
argument_list|,
operator|&
name|transindex
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|layers
operator|=
name|gimp_image_list_layers
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|num_layers
operator|=
name|g_list_length
argument_list|(
name|layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|mipmaps
operator|==
name|DDS_MIPMAP_EXISTING
condition|)
name|drawable
operator|=
name|layers
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_SELECTED_LAYER
condition|)
block|{
name|w
operator|=
name|gimp_drawable_width
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_drawable_height
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|w
operator|=
name|gimp_image_width
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_image_height
argument_list|(
name|image
argument_list|)
expr_stmt|;
block|}
name|basetype
operator|=
name|gimp_image_base_type
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|drawable_type
operator|=
name|gimp_drawable_type
argument_list|(
name|drawable
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|drawable_type
condition|)
block|{
case|case
name|GIMP_RGB_IMAGE
case|:
name|bpp
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|GIMP_RGBA_IMAGE
case|:
name|bpp
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|GIMP_GRAY_IMAGE
case|:
name|bpp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|GIMP_GRAYA_IMAGE
case|:
name|bpp
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXED_IMAGE
case|:
name|bpp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXEDA_IMAGE
case|:
name|bpp
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|pixel_format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|format_info
index|[
name|i
index|]
operator|.
name|format
operator|==
name|pixel_format
condition|)
block|{
name|fmtbpp
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|bpp
expr_stmt|;
name|has_alpha
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|alpha
expr_stmt|;
name|rmask
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|rmask
expr_stmt|;
name|gmask
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|gmask
expr_stmt|;
name|bmask
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|bmask
expr_stmt|;
name|amask
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|amask
expr_stmt|;
name|dxgi_format
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|dxgi_format
expr_stmt|;
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|fmtbpp
operator|=
literal|1
expr_stmt|;
name|has_alpha
operator|=
literal|0
expr_stmt|;
name|rmask
operator|=
name|bmask
operator|=
name|gmask
operator|=
name|amask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fmtbpp
operator|=
literal|1
expr_stmt|;
name|has_alpha
operator|=
literal|0
expr_stmt|;
name|rmask
operator|=
literal|0x000000ff
expr_stmt|;
name|gmask
operator|=
name|bmask
operator|=
name|amask
operator|=
literal|0
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_R8_UNORM
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|fmtbpp
operator|=
literal|1
expr_stmt|;
name|has_alpha
operator|=
literal|0
expr_stmt|;
name|rmask
operator|=
name|gmask
operator|=
name|bmask
operator|=
name|amask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fmtbpp
operator|=
literal|2
expr_stmt|;
name|has_alpha
operator|=
literal|1
expr_stmt|;
name|rmask
operator|=
literal|0x000000ff
expr_stmt|;
name|gmask
operator|=
literal|0x000000ff
expr_stmt|;
name|bmask
operator|=
literal|0x000000ff
expr_stmt|;
name|amask
operator|=
literal|0x0000ff00
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
block|{
name|fmtbpp
operator|=
literal|3
expr_stmt|;
name|rmask
operator|=
literal|0x00ff0000
expr_stmt|;
name|gmask
operator|=
literal|0x0000ff00
expr_stmt|;
name|bmask
operator|=
literal|0x000000ff
expr_stmt|;
name|amask
operator|=
literal|0x00000000
expr_stmt|;
block|}
else|else
block|{
name|fmtbpp
operator|=
literal|4
expr_stmt|;
name|has_alpha
operator|=
literal|1
expr_stmt|;
name|rmask
operator|=
literal|0x00ff0000
expr_stmt|;
name|gmask
operator|=
literal|0x0000ff00
expr_stmt|;
name|bmask
operator|=
literal|0x000000ff
expr_stmt|;
name|amask
operator|=
literal|0xff000000
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_B8G8R8A8_UNORM
expr_stmt|;
block|}
name|memset
argument_list|(
name|hdr
argument_list|,
literal|0
argument_list|,
name|DDS_HEADERSIZE
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
argument_list|,
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'D'
argument_list|,
literal|'S'
argument_list|,
literal|' '
argument_list|)
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|4
argument_list|,
literal|124
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|12
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|16
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|76
argument_list|,
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_NONE
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|88
argument_list|,
name|fmtbpp
operator|<<
literal|3
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|92
argument_list|,
name|rmask
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|96
argument_list|,
name|gmask
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|100
argument_list|,
name|bmask
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|104
argument_list|,
name|amask
argument_list|)
expr_stmt|;
block|}
comment|/*      put some information in the reserved area to identify the origin      of the image      */
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|32
argument_list|,
name|FOURCC
argument_list|(
literal|'G'
argument_list|,
literal|'I'
argument_list|,
literal|'M'
argument_list|,
literal|'P'
argument_list|)
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|36
argument_list|,
name|FOURCC
argument_list|(
literal|'-'
argument_list|,
literal|'D'
argument_list|,
literal|'D'
argument_list|,
literal|'S'
argument_list|)
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|40
argument_list|,
name|DDS_PLUGIN_VERSION
argument_list|)
expr_stmt|;
name|flags
operator|=
name|DDSD_CAPS
operator||
name|DDSD_PIXELFORMAT
operator||
name|DDSD_WIDTH
operator||
name|DDSD_HEIGHT
expr_stmt|;
name|caps
operator|=
name|DDSCAPS_TEXTURE
expr_stmt|;
if|if
condition|(
name|mipmaps
condition|)
block|{
name|flags
operator||=
name|DDSD_MIPMAPCOUNT
expr_stmt|;
name|caps
operator||=
operator|(
name|DDSCAPS_COMPLEX
operator||
name|DDSCAPS_MIPMAP
operator|)
expr_stmt|;
name|num_mipmaps
operator|=
name|get_num_mipmaps
argument_list|(
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|num_mipmaps
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|savetype
operator|==
name|DDS_SAVE_CUBEMAP
operator|)
operator|&&
name|is_cubemap
condition|)
block|{
name|caps
operator||=
name|DDSCAPS_COMPLEX
expr_stmt|;
name|caps2
operator||=
operator|(
name|DDSCAPS2_CUBEMAP
operator||
name|DDSCAPS2_CUBEMAP_ALL_FACES
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
operator|)
operator|&&
name|is_volume
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|24
argument_list|,
name|num_layers
argument_list|)
expr_stmt|;
comment|/* depth */
name|flags
operator||=
name|DDSD_DEPTH
expr_stmt|;
name|caps
operator||=
name|DDSCAPS_COMPLEX
expr_stmt|;
name|caps2
operator||=
name|DDSCAPS2_VOLUME
expr_stmt|;
block|}
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|28
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|108
argument_list|,
name|caps
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|112
argument_list|,
name|caps2
argument_list|)
expr_stmt|;
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_NONE
condition|)
block|{
name|flags
operator||=
name|DDSD_PITCH
expr_stmt|;
if|if
condition|(
name|pixel_format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
if|if
condition|(
name|pixel_format
operator|==
name|DDS_FORMAT_A8
condition|)
name|pflags
operator||=
name|DDPF_ALPHA
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|fmtbpp
operator|==
literal|1
operator|)
operator|||
operator|(
name|pixel_format
operator|==
name|DDS_FORMAT_L8A8
operator|)
operator|)
operator|&&
operator|(
name|pixel_format
operator|!=
name|DDS_FORMAT_R3G3B2
operator|)
condition|)
name|pflags
operator||=
name|DDPF_LUMINANCE
expr_stmt|;
else|else
name|pflags
operator||=
name|DDPF_RGB
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
name|pflags
operator||=
name|DDPF_PALETTEINDEXED8
expr_stmt|;
else|else
name|pflags
operator||=
name|DDPF_LUMINANCE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bpp
operator|==
literal|2
operator|)
operator|&&
operator|(
name|basetype
operator|==
name|GIMP_INDEXED
operator|)
condition|)
block|{
name|pflags
operator||=
name|DDPF_PALETTEINDEXED8
expr_stmt|;
block|}
else|else
block|{
name|pflags
operator||=
name|DDPF_RGB
expr_stmt|;
block|}
block|}
if|if
condition|(
name|has_alpha
condition|)
name|pflags
operator||=
name|DDPF_ALPHAPIXELS
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|8
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|20
argument_list|,
name|w
operator|*
name|fmtbpp
argument_list|)
expr_stmt|;
comment|/* pitch */
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|80
argument_list|,
name|pflags
argument_list|)
expr_stmt|;
comment|/*        * write extra fourcc info - this is special to GIMP DDS. When the image        * is read by the plugin, we can detect the added information to decode        * the pixels        */
if|if
condition|(
name|pixel_format
operator|==
name|DDS_FORMAT_AEXP
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'E'
argument_list|,
literal|'X'
argument_list|,
literal|'P'
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pixel_format
operator|==
name|DDS_FORMAT_YCOCG
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'Y'
argument_list|,
literal|'C'
argument_list|,
literal|'G'
argument_list|,
literal|'1'
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|flags
operator||=
name|DDSD_LINEARSIZE
expr_stmt|;
name|pflags
operator|=
name|DDPF_FOURCC
expr_stmt|;
switch|switch
condition|(
name|compression
condition|)
block|{
case|case
name|DDS_COMPRESS_BC1
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'1'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC1_UNORM
expr_stmt|;
break|break;
case|case
name|DDS_COMPRESS_BC2
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'3'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC2_UNORM
expr_stmt|;
break|break;
case|case
name|DDS_COMPRESS_BC3
case|:
case|case
name|DDS_COMPRESS_BC3N
case|:
case|case
name|DDS_COMPRESS_YCOCG
case|:
case|case
name|DDS_COMPRESS_YCOCGS
case|:
case|case
name|DDS_COMPRESS_AEXP
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'5'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC3_UNORM
expr_stmt|;
break|break;
case|case
name|DDS_COMPRESS_RXGB
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'R'
argument_list|,
literal|'X'
argument_list|,
literal|'G'
argument_list|,
literal|'B'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC3_UNORM
expr_stmt|;
break|break;
case|case
name|DDS_COMPRESS_BC4
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'1'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC4_UNORM
expr_stmt|;
comment|//is_dx10 = 1;
break|break;
case|case
name|DDS_COMPRESS_BC5
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'2'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC5_UNORM
expr_stmt|;
comment|//is_dx10 = 1;
break|break;
block|}
if|if
condition|(
operator|(
name|compression
operator|==
name|DDS_COMPRESS_BC3N
operator|)
operator|||
operator|(
name|compression
operator|==
name|DDS_COMPRESS_RXGB
operator|)
condition|)
block|{
name|pflags
operator||=
name|DDPF_NORMAL
expr_stmt|;
block|}
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|8
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|80
argument_list|,
name|pflags
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|84
argument_list|,
name|fourcc
argument_list|)
expr_stmt|;
name|size
operator|=
operator|(
operator|(
name|w
operator|+
literal|3
operator|)
operator|>>
literal|2
operator|)
operator|*
operator|(
operator|(
name|h
operator|+
literal|3
operator|)
operator|>>
literal|2
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|compression
operator|==
name|DDS_COMPRESS_BC1
operator|)
operator|||
operator|(
name|compression
operator|==
name|DDS_COMPRESS_BC4
operator|)
condition|)
name|size
operator|*=
literal|8
expr_stmt|;
else|else
name|size
operator|*=
literal|16
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|20
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* linear size */
comment|/*        * write extra fourcc info - this is special to GIMP DDS. When the image        * is read by the plugin, we can detect the added information to decode        * the pixels        */
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_AEXP
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'E'
argument_list|,
literal|'X'
argument_list|,
literal|'P'
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_YCOCG
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'Y'
argument_list|,
literal|'C'
argument_list|,
literal|'G'
argument_list|,
literal|'1'
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_YCOCGS
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'Y'
argument_list|,
literal|'C'
argument_list|,
literal|'G'
argument_list|,
literal|'2'
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* texture arrays require a DX10 header */
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_ARRAY
condition|)
name|is_dx10
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|is_dx10
condition|)
block|{
name|array_size
operator|=
operator|(
operator|(
name|savetype
operator|==
name|DDS_SAVE_SELECTED_LAYER
operator|)
condition|?
literal|1
else|:
name|get_array_size
argument_list|(
name|image
argument_list|)
operator|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|0
argument_list|,
name|dxgi_format
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|4
argument_list|,
name|D3D10_RESOURCE_DIMENSION_TEXTURE2D
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|12
argument_list|,
name|array_size
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|16
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* update main header accordingly */
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|80
argument_list|,
name|pflags
operator||
name|DDPF_FOURCC
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|84
argument_list|,
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'1'
argument_list|,
literal|'0'
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fwrite
argument_list|(
name|hdr
argument_list|,
name|DDS_HEADERSIZE
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_dx10
condition|)
name|fwrite
argument_list|(
name|hdr10
argument_list|,
name|DDS_HEADERSIZE_DX10
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
comment|/* write palette for indexed images */
if|if
condition|(
operator|(
name|basetype
operator|==
name|GIMP_INDEXED
operator|)
operator|&&
operator|(
name|pixel_format
operator|==
name|DDS_FORMAT_DEFAULT
operator|)
operator|&&
operator|(
name|compression
operator|==
name|DDS_COMPRESS_NONE
operator|)
condition|)
block|{
name|cmap
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|colors
condition|;
operator|++
name|i
control|)
block|{
name|fwrite
argument_list|(
operator|&
name|cmap
index|[
literal|3
operator|*
name|i
index|]
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|transindex
condition|)
name|fputc
argument_list|(
literal|0
argument_list|,
name|fp
argument_list|)
expr_stmt|;
else|else
name|fputc
argument_list|(
literal|255
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
literal|256
condition|;
operator|++
name|i
control|)
name|fwrite
argument_list|(
name|zero
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_CUBEMAP
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
block|{
name|write_layer
argument_list|(
name|fp
argument_list|,
name|image
argument_list|,
name|GIMP_DRAWABLE
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
argument_list|,
name|config
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
name|gimp_progress_update
argument_list|(
call|(
name|float
call|)
argument_list|(
name|i
operator|+
literal|1
argument_list|)
operator|/
literal|6.0
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|list
operator|=
name|layers
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|layers
argument_list|)
control|)
block|{
name|write_layer
argument_list|(
name|fp
argument_list|,
name|image
argument_list|,
name|list
operator|->
name|data
argument_list|,
name|config
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|float
operator|)
name|i
operator|/
operator|(
name|float
operator|)
name|num_layers
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|num_mipmaps
operator|>
literal|1
condition|)
name|write_volume_mipmaps
argument_list|(
name|fp
argument_list|,
name|image
argument_list|,
name|config
argument_list|,
name|layers
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|num_layers
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_ARRAY
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|list
operator|=
name|layers
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
operator|,
name|list
operator|=
name|g_list_next
argument_list|(
name|layers
argument_list|)
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|==
name|w
operator|)
operator|&&
operator|(
name|gimp_drawable_height
argument_list|(
name|list
operator|->
name|data
argument_list|)
operator|==
name|h
operator|)
condition|)
block|{
name|write_layer
argument_list|(
name|fp
argument_list|,
name|image
argument_list|,
name|list
operator|->
name|data
argument_list|,
name|config
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
block|}
name|gimp_progress_update
argument_list|(
operator|(
name|float
operator|)
name|i
operator|/
operator|(
name|float
operator|)
name|num_layers
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|write_layer
argument_list|(
name|fp
argument_list|,
name|image
argument_list|,
name|drawable
argument_list|,
name|config
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
block|}
name|gimp_progress_update
argument_list|(
literal|1.0
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|combo_sensitivity_func (gint value,gpointer data)
name|combo_sensitivity_func
parameter_list|(
name|gint
name|value
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|model
operator|=
name|gtk_combo_box_get_model
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_int_store_lookup_by_value
argument_list|(
name|model
argument_list|,
name|value
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
block|{
name|gpointer
name|insensitive
decl_stmt|;
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|GIMP_INT_STORE_USER_DATA
argument_list|,
operator|&
name|insensitive
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|!
name|GPOINTER_TO_INT
argument_list|(
name|insensitive
argument_list|)
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|combo_set_item_sensitive (GtkWidget * widget,gint value,gboolean sensitive)
name|combo_set_item_sensitive
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|value
parameter_list|,
name|gboolean
name|sensitive
parameter_list|)
block|{
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|model
operator|=
name|gtk_combo_box_get_model
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_int_store_lookup_by_value
argument_list|(
name|model
argument_list|,
name|value
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
block|{
name|gtk_list_store_set
argument_list|(
name|GTK_LIST_STORE
argument_list|(
name|model
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|,
name|GIMP_INT_STORE_USER_DATA
argument_list|,
operator|!
name|GINT_TO_POINTER
argument_list|(
name|sensitive
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|config_notify (GObject * config,const GParamSpec * pspec,GimpImage * image)
name|config_notify
parameter_list|(
name|GObject
modifier|*
name|config
parameter_list|,
specifier|const
name|GParamSpec
modifier|*
name|pspec
parameter_list|,
name|GimpImage
modifier|*
name|image
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pspec
operator|->
name|name
argument_list|,
literal|"compression-format"
argument_list|)
condition|)
block|{
name|gint
name|compression
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"compression-format"
argument_list|,
operator|&
name|compression
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|format_opt
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|format_opt
argument_list|,
name|compression
operator|==
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pm_check
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|pm_check
argument_list|,
name|compression
operator|!=
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pspec
operator|->
name|name
argument_list|,
literal|"save-type"
argument_list|)
condition|)
block|{
name|gint
name|savetype
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"save-type"
argument_list|,
operator|&
name|savetype
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|savetype
condition|)
block|{
case|case
name|DDS_SAVE_SELECTED_LAYER
case|:
case|case
name|DDS_SAVE_CUBEMAP
case|:
case|case
name|DDS_SAVE_ARRAY
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|compress_opt
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_SAVE_VOLUMEMAP
case|:
name|g_object_set
argument_list|(
name|config
argument_list|,
literal|"compression-format"
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|compress_opt
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|mipmap_opt
condition|)
name|combo_set_item_sensitive
argument_list|(
name|mipmap_opt
argument_list|,
name|DDS_MIPMAP_EXISTING
argument_list|,
name|check_mipmaps
argument_list|(
name|image
argument_list|,
name|savetype
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pspec
operator|->
name|name
argument_list|,
literal|"mipmaps"
argument_list|)
condition|)
block|{
name|gint
name|mipmaps
decl_stmt|;
name|gboolean
name|gamma_correct
decl_stmt|;
name|gboolean
name|srgb
decl_stmt|;
name|gboolean
name|preserve_alpha_coverage
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"mipmaps"
argument_list|,
operator|&
name|mipmaps
argument_list|,
literal|"gamma-correct"
argument_list|,
operator|&
name|gamma_correct
argument_list|,
literal|"srgb"
argument_list|,
operator|&
name|srgb
argument_list|,
literal|"preserve-alpha-coverage"
argument_list|,
operator|&
name|preserve_alpha_coverage
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mipmap_filter_opt
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|mipmap_filter_opt
argument_list|,
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|mipmap_wrap_opt
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|mipmap_wrap_opt
argument_list|,
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|gamma_check
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_check
argument_list|,
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|srgb_check
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|srgb_check
argument_list|,
operator|(
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|gamma_correct
argument_list|)
expr_stmt|;
if|if
condition|(
name|gamma_spin
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_spin
argument_list|,
operator|(
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|gamma_correct
operator|&&
operator|!
name|srgb
argument_list|)
expr_stmt|;
if|if
condition|(
name|alpha_coverage_check
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|alpha_coverage_check
argument_list|,
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|alpha_test_threshold_spin
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|alpha_test_threshold_spin
argument_list|,
operator|(
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|preserve_alpha_coverage
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pspec
operator|->
name|name
argument_list|,
literal|"transparent-color"
argument_list|)
condition|)
block|{
name|GimpImageBaseType
name|base_type
decl_stmt|;
name|gboolean
name|transparent_color
decl_stmt|;
name|base_type
operator|=
name|gimp_image_base_type
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"transparent-color"
argument_list|,
operator|&
name|transparent_color
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|transparent_spin
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|transparent_spin
argument_list|,
name|transparent_color
operator|&&
name|base_type
operator|==
name|GIMP_INDEXED
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pspec
operator|->
name|name
argument_list|,
literal|"gamma-correct"
argument_list|)
condition|)
block|{
name|gboolean
name|gamma_correct
decl_stmt|;
name|gboolean
name|srgb
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"gamma-correct"
argument_list|,
operator|&
name|gamma_correct
argument_list|,
literal|"srgb"
argument_list|,
operator|&
name|srgb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|srgb_check
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|srgb_check
argument_list|,
name|gamma_correct
argument_list|)
expr_stmt|;
if|if
condition|(
name|gamma_spin
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_spin
argument_list|,
name|gamma_correct
operator|&&
operator|!
name|srgb
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pspec
operator|->
name|name
argument_list|,
literal|"srgb"
argument_list|)
condition|)
block|{
name|gboolean
name|gamma_correct
decl_stmt|;
name|gboolean
name|srgb
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"gamma-correct"
argument_list|,
operator|&
name|gamma_correct
argument_list|,
literal|"srgb"
argument_list|,
operator|&
name|srgb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|gamma_spin
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_spin
argument_list|,
name|gamma_correct
operator|&&
operator|!
name|srgb
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pspec
operator|->
name|name
argument_list|,
literal|"preserve-alpha-coverage"
argument_list|)
condition|)
block|{
name|gboolean
name|preserve_alpha_coverage
decl_stmt|;
name|g_object_get
argument_list|(
name|config
argument_list|,
literal|"preserve-alpha-coverage"
argument_list|,
operator|&
name|preserve_alpha_coverage
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|alpha_test_threshold_spin
condition|)
name|gtk_widget_set_sensitive
argument_list|(
name|alpha_test_threshold_spin
argument_list|,
name|preserve_alpha_coverage
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|gboolean
DECL|function|save_dialog (GimpImage * image,GimpDrawable * drawable,GimpProcedure * procedure,GObject * config)
name|save_dialog
parameter_list|(
name|GimpImage
modifier|*
name|image
parameter_list|,
name|GimpDrawable
modifier|*
name|drawable
parameter_list|,
name|GimpProcedure
modifier|*
name|procedure
parameter_list|,
name|GObject
modifier|*
name|config
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dialog
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|grid
decl_stmt|;
name|GtkListStore
modifier|*
name|store
decl_stmt|;
name|GtkWidget
modifier|*
name|opt
decl_stmt|;
name|GtkWidget
modifier|*
name|check
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GimpImageBaseType
name|basetype
decl_stmt|;
name|gboolean
name|run
decl_stmt|;
if|if
condition|(
name|is_cubemap
operator|||
name|is_volume
operator|||
name|is_array
condition|)
name|g_object_set
argument_list|(
name|config
argument_list|,
literal|"save-type"
argument_list|,
name|DDS_SAVE_SELECTED_LAYER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|basetype
operator|=
name|gimp_image_base_type
argument_list|(
name|image
argument_list|)
expr_stmt|;
name|dialog
operator|=
name|gimp_procedure_dialog_new
argument_list|(
name|procedure
argument_list|,
name|GIMP_PROCEDURE_CONFIG
argument_list|(
name|config
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Export Image as DDS"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_window_set_resizable
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dialog
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_box_new
argument_list|(
name|GTK_ORIENTATION_VERTICAL
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|vbox
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|grid
operator|=
name|gtk_grid_new
argument_list|()
expr_stmt|;
name|gtk_grid_set_row_spacing
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_grid_set_column_spacing
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|grid
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|grid
argument_list|)
expr_stmt|;
name|store
operator|=
name|gimp_int_store_new
argument_list|(
literal|"None"
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|,
literal|"BC1 / DXT1"
argument_list|,
name|DDS_COMPRESS_BC1
argument_list|,
literal|"BC2 / DXT3"
argument_list|,
name|DDS_COMPRESS_BC2
argument_list|,
literal|"BC3 / DXT5"
argument_list|,
name|DDS_COMPRESS_BC3
argument_list|,
literal|"BC3nm / DXT5nm"
argument_list|,
name|DDS_COMPRESS_BC3N
argument_list|,
literal|"BC4 / ATI1 (3Dc+)"
argument_list|,
name|DDS_COMPRESS_BC4
argument_list|,
literal|"BC5 / ATI2 (3Dc)"
argument_list|,
name|DDS_COMPRESS_BC5
argument_list|,
literal|"RXGB (DXT5)"
argument_list|,
name|DDS_COMPRESS_RXGB
argument_list|,
literal|"Alpha Exponent (DXT5)"
argument_list|,
name|DDS_COMPRESS_AEXP
argument_list|,
literal|"YCoCg (DXT5)"
argument_list|,
name|DDS_COMPRESS_YCOCG
argument_list|,
literal|"YCoCg scaled (DXT5)"
argument_list|,
name|DDS_COMPRESS_YCOCGS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|compress_opt
operator|=
name|gimp_prop_int_combo_box_new
argument_list|(
name|config
argument_list|,
literal|"compression-format"
argument_list|,
name|GIMP_INT_STORE
argument_list|(
name|store
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_grid_attach_aligned
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"_Compression:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|compress_opt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pm_check
operator|=
name|gimp_prop_check_button_new
argument_list|(
name|config
argument_list|,
literal|"perceptual-metric"
argument_list|,
name|_
argument_list|(
literal|"Use _perceptual error metric"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_grid_attach
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
name|pm_check
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|store
operator|=
name|gimp_int_store_new
argument_list|(
literal|"Default"
argument_list|,
name|DDS_FORMAT_DEFAULT
argument_list|,
literal|"RGB8"
argument_list|,
name|DDS_FORMAT_RGB8
argument_list|,
literal|"RGBA8"
argument_list|,
name|DDS_FORMAT_RGBA8
argument_list|,
literal|"BGR8"
argument_list|,
name|DDS_FORMAT_BGR8
argument_list|,
literal|"ABGR8"
argument_list|,
name|DDS_FORMAT_ABGR8
argument_list|,
literal|"R5G6B5"
argument_list|,
name|DDS_FORMAT_R5G6B5
argument_list|,
literal|"RGBA4"
argument_list|,
name|DDS_FORMAT_RGBA4
argument_list|,
literal|"RGB5A1"
argument_list|,
name|DDS_FORMAT_RGB5A1
argument_list|,
literal|"RGB10A2"
argument_list|,
name|DDS_FORMAT_RGB10A2
argument_list|,
literal|"R3G3B2"
argument_list|,
name|DDS_FORMAT_R3G3B2
argument_list|,
literal|"A8"
argument_list|,
name|DDS_FORMAT_A8
argument_list|,
literal|"L8"
argument_list|,
name|DDS_FORMAT_L8
argument_list|,
literal|"L8A8"
argument_list|,
name|DDS_FORMAT_L8A8
argument_list|,
literal|"AExp"
argument_list|,
name|DDS_FORMAT_AEXP
argument_list|,
literal|"YCoCg"
argument_list|,
name|DDS_FORMAT_YCOCG
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|format_opt
operator|=
name|gimp_prop_int_combo_box_new
argument_list|(
name|config
argument_list|,
literal|"format"
argument_list|,
name|GIMP_INT_STORE
argument_list|(
name|store
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_grid_attach_aligned
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|_
argument_list|(
literal|"_Format:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|format_opt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|store
operator|=
name|gimp_int_store_new
argument_list|(
literal|"Image / Selected layer"
argument_list|,
name|DDS_SAVE_SELECTED_LAYER
argument_list|,
literal|"As cube map"
argument_list|,
name|DDS_SAVE_CUBEMAP
argument_list|,
literal|"As volume map"
argument_list|,
name|DDS_SAVE_VOLUMEMAP
argument_list|,
literal|"As texture array"
argument_list|,
name|DDS_SAVE_ARRAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|opt
operator|=
name|gimp_prop_int_combo_box_new
argument_list|(
name|config
argument_list|,
literal|"save-type"
argument_list|,
name|GIMP_INT_STORE
argument_list|(
name|store
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_grid_attach_aligned
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|_
argument_list|(
literal|"_Save:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|opt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gimp_int_combo_box_set_sensitivity
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|opt
argument_list|)
argument_list|,
name|combo_sensitivity_func
argument_list|,
name|opt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|combo_set_item_sensitive
argument_list|(
name|opt
argument_list|,
name|DDS_SAVE_CUBEMAP
argument_list|,
name|is_cubemap
argument_list|)
expr_stmt|;
name|combo_set_item_sensitive
argument_list|(
name|opt
argument_list|,
name|DDS_SAVE_VOLUMEMAP
argument_list|,
name|is_volume
argument_list|)
expr_stmt|;
name|combo_set_item_sensitive
argument_list|(
name|opt
argument_list|,
name|DDS_SAVE_ARRAY
argument_list|,
name|is_array
argument_list|)
expr_stmt|;
name|store
operator|=
name|gimp_int_store_new
argument_list|(
literal|"No mipmaps"
argument_list|,
name|DDS_MIPMAP_NONE
argument_list|,
literal|"Generate mipmaps"
argument_list|,
name|DDS_MIPMAP_GENERATE
argument_list|,
literal|"Use existing mipmaps"
argument_list|,
name|DDS_MIPMAP_EXISTING
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mipmap_opt
operator|=
name|gimp_prop_int_combo_box_new
argument_list|(
name|config
argument_list|,
literal|"mipmaps"
argument_list|,
name|GIMP_INT_STORE
argument_list|(
name|store
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_grid_attach_aligned
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
name|_
argument_list|(
literal|"_Mipmaps:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|mipmap_opt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gimp_int_combo_box_set_sensitivity
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|mipmap_opt
argument_list|)
argument_list|,
name|combo_sensitivity_func
argument_list|,
name|mipmap_opt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|combo_set_item_sensitive
argument_list|(
name|mipmap_opt
argument_list|,
name|DDS_MIPMAP_EXISTING
argument_list|,
operator|!
operator|(
name|is_volume
operator|||
name|is_cubemap
operator|)
operator|&&
name|is_mipmap_chain_valid
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_box_new
argument_list|(
name|GTK_ORIENTATION_HORIZONTAL
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|check
operator|=
name|gimp_prop_check_button_new
argument_list|(
name|config
argument_list|,
literal|"transparent-color"
argument_list|,
name|_
argument_list|(
literal|"Transparent index:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|check
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
name|transparent_spin
operator|=
name|gimp_prop_spin_button_new
argument_list|(
name|config
argument_list|,
literal|"transparent-index"
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|transparent_spin
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gimp_frame_new
argument_list|(
name|_
argument_list|(
literal|"Mipmap Options"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|frame
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|grid
operator|=
name|gtk_grid_new
argument_list|()
expr_stmt|;
name|gtk_grid_set_row_spacing
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|gtk_grid_set_column_spacing
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|grid
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|grid
argument_list|)
expr_stmt|;
name|store
operator|=
name|gimp_int_store_new
argument_list|(
literal|"Default"
argument_list|,
name|DDS_MIPMAP_FILTER_DEFAULT
argument_list|,
literal|"Nearest"
argument_list|,
name|DDS_MIPMAP_FILTER_NEAREST
argument_list|,
literal|"Box"
argument_list|,
name|DDS_MIPMAP_FILTER_BOX
argument_list|,
literal|"Triangle"
argument_list|,
name|DDS_MIPMAP_FILTER_TRIANGLE
argument_list|,
literal|"Quadratic"
argument_list|,
name|DDS_MIPMAP_FILTER_QUADRATIC
argument_list|,
literal|"B-Spline"
argument_list|,
name|DDS_MIPMAP_FILTER_BSPLINE
argument_list|,
literal|"Mitchell"
argument_list|,
name|DDS_MIPMAP_FILTER_MITCHELL
argument_list|,
literal|"Lanczos"
argument_list|,
name|DDS_MIPMAP_FILTER_LANCZOS
argument_list|,
literal|"Kaiser"
argument_list|,
name|DDS_MIPMAP_FILTER_KAISER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mipmap_filter_opt
operator|=
name|gimp_prop_int_combo_box_new
argument_list|(
name|config
argument_list|,
literal|"mipmap-filter"
argument_list|,
name|GIMP_INT_STORE
argument_list|(
name|store
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_grid_attach_aligned
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"F_ilter:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|mipmap_filter_opt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|store
operator|=
name|gimp_int_store_new
argument_list|(
literal|"Default"
argument_list|,
name|DDS_MIPMAP_WRAP_DEFAULT
argument_list|,
literal|"Mirror"
argument_list|,
name|DDS_MIPMAP_WRAP_MIRROR
argument_list|,
literal|"Repeat"
argument_list|,
name|DDS_MIPMAP_WRAP_REPEAT
argument_list|,
literal|"Clamp"
argument_list|,
name|DDS_MIPMAP_WRAP_CLAMP
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mipmap_wrap_opt
operator|=
name|gimp_prop_int_combo_box_new
argument_list|(
name|config
argument_list|,
literal|"mipmap-wrap"
argument_list|,
name|GIMP_INT_STORE
argument_list|(
name|store
argument_list|)
argument_list|)
expr_stmt|;
name|gimp_grid_attach_aligned
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|_
argument_list|(
literal|"_Wrap mode:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|mipmap_wrap_opt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gamma_check
operator|=
name|gimp_prop_check_button_new
argument_list|(
name|config
argument_list|,
literal|"gamma-correct"
argument_list|,
name|_
argument_list|(
literal|"Appl_y gamma correction"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_grid_attach
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
name|gamma_check
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srgb_check
operator|=
name|gimp_prop_check_button_new
argument_list|(
name|config
argument_list|,
literal|"srgb"
argument_list|,
name|_
argument_list|(
literal|"Use s_RGB colorspace"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_grid_attach
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
name|srgb_check
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gamma_spin
operator|=
name|gimp_prop_spin_button_new
argument_list|(
name|config
argument_list|,
literal|"gamma"
argument_list|,
literal|0.1
argument_list|,
literal|0.5
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gimp_grid_attach_aligned
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
name|_
argument_list|(
literal|"_Gamma:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|gamma_spin
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|alpha_coverage_check
operator|=
name|gimp_prop_check_button_new
argument_list|(
name|config
argument_list|,
literal|"preserve-alpha-coverage"
argument_list|,
name|_
argument_list|(
literal|"Preserve alpha _test coverage"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_grid_attach
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
name|alpha_coverage_check
argument_list|,
literal|1
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|alpha_test_threshold_spin
operator|=
name|gimp_prop_spin_button_new
argument_list|(
name|config
argument_list|,
literal|"alpha-test-threshold"
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gimp_grid_attach_aligned
argument_list|(
name|GTK_GRID
argument_list|(
name|grid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|,
name|_
argument_list|(
literal|"_Alpha test threshold:"
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.5
argument_list|,
name|alpha_test_threshold_spin
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|config_notify
argument_list|(
name|config
argument_list|,
name|g_object_class_find_property
argument_list|(
name|G_OBJECT_GET_CLASS
argument_list|(
name|config
argument_list|)
argument_list|,
literal|"compression-format"
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|config_notify
argument_list|(
name|config
argument_list|,
name|g_object_class_find_property
argument_list|(
name|G_OBJECT_GET_CLASS
argument_list|(
name|config
argument_list|)
argument_list|,
literal|"mipmaps"
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|config_notify
argument_list|(
name|config
argument_list|,
name|g_object_class_find_property
argument_list|(
name|G_OBJECT_GET_CLASS
argument_list|(
name|config
argument_list|)
argument_list|,
literal|"save-type"
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|config_notify
argument_list|(
name|config
argument_list|,
name|g_object_class_find_property
argument_list|(
name|G_OBJECT_GET_CLASS
argument_list|(
name|config
argument_list|)
argument_list|,
literal|"transparent-color"
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|config
argument_list|,
literal|"notify"
argument_list|,
name|G_CALLBACK
argument_list|(
name|config_notify
argument_list|)
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|run
operator|=
name|gimp_procedure_dialog_run
argument_list|(
name|GIMP_PROCEDURE_DIALOG
argument_list|(
name|dialog
argument_list|)
argument_list|)
expr_stmt|;
name|g_signal_handlers_disconnect_by_func
argument_list|(
name|config
argument_list|,
name|config_notify
argument_list|,
name|image
argument_list|)
expr_stmt|;
name|gtk_widget_destroy
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
return|return
name|run
return|;
block|}
end_function

end_unit

