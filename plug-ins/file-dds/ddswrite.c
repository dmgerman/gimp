begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 	DDS GIMP plugin  	Copyright (C) 2004-2012 Shawn Kirst<skirst@gmail.com>,    with parts (C) 2003 Arne Reuter<homepage@arnereuter.de> where specified.  	This program is free software; you can redistribute it and/or 	modify it under the terms of the GNU General Public 	License as published by the Free Software Foundation; either 	version 2 of the License, or (at your option) any later version.  	This program is distributed in the hope that it will be useful, 	but WITHOUT ANY WARRANTY; without even the implied warranty of 	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU 	General Public License for more details.  	You should have received a copy of the GNU General Public License 	along with this program; see the file COPYING.  If not, write to 	the Free Software Foundation, 51 Franklin Street, Fifth Floor 	Boston, MA 02110-1301, USA. */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/stdplugins-intl.h>
end_include

begin_include
include|#
directive|include
file|"ddsplugin.h"
end_include

begin_include
include|#
directive|include
file|"dds.h"
end_include

begin_include
include|#
directive|include
file|"dxt.h"
end_include

begin_include
include|#
directive|include
file|"mipmap.h"
end_include

begin_include
include|#
directive|include
file|"endian.h"
end_include

begin_include
include|#
directive|include
file|"imath.h"
end_include

begin_include
include|#
directive|include
file|"color.h"
end_include

begin_function_decl
specifier|static
name|gint
name|save_dialog
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|save_dialog_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|write_image
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|runme
specifier|static
name|int
name|runme
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
DECL|enum|__anon2a4679d70103
block|{
DECL|enumerator|COMBO_VALUE
DECL|enumerator|COMBO_STRING
DECL|enumerator|COMBO_SENSITIVE
name|COMBO_VALUE
block|,
name|COMBO_STRING
block|,
name|COMBO_SENSITIVE
block|}
enum|;
end_enum

begin_decl_stmt
DECL|variable|cubemap_face_names
specifier|static
specifier|const
name|char
modifier|*
name|cubemap_face_names
index|[
literal|4
index|]
index|[
literal|6
index|]
init|=
block|{
block|{
literal|"positive x"
block|,
literal|"negative x"
block|,
literal|"positive y"
block|,
literal|"negative y"
block|,
literal|"positive z"
block|,
literal|"negative z"
block|}
block|,
block|{
literal|"pos x"
block|,
literal|"neg x"
block|,
literal|"pos y"
block|,
literal|"neg y"
block|,
literal|"pos z"
block|,
literal|"neg z"
block|,    }
block|,
block|{
literal|"+x"
block|,
literal|"-x"
block|,
literal|"+y"
block|,
literal|"-y"
block|,
literal|"+z"
block|,
literal|"-z"
block|}
block|,
block|{
literal|"right"
block|,
literal|"left"
block|,
literal|"top"
block|,
literal|"bottom"
block|,
literal|"back"
block|,
literal|"front"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|cubemap_faces
specifier|static
name|gint
name|cubemap_faces
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|is_cubemap
specifier|static
name|gint
name|is_cubemap
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|is_volume
specifier|static
name|gint
name|is_volume
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|is_array
specifier|static
name|gint
name|is_array
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|is_mipmap_chain_valid
specifier|static
name|gint
name|is_mipmap_chain_valid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|compress_opt
specifier|static
name|GtkWidget
modifier|*
name|compress_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|format_opt
specifier|static
name|GtkWidget
modifier|*
name|format_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_opt
specifier|static
name|GtkWidget
modifier|*
name|mipmap_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_filter_opt
specifier|static
name|GtkWidget
modifier|*
name|mipmap_filter_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_wrap_opt
specifier|static
name|GtkWidget
modifier|*
name|mipmap_wrap_opt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|srgb_chk
specifier|static
name|GtkWidget
modifier|*
name|srgb_chk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gamma_chk
specifier|static
name|GtkWidget
modifier|*
name|gamma_chk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|gamma_spin
specifier|static
name|GtkWidget
modifier|*
name|gamma_spin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|pm_chk
specifier|static
name|GtkWidget
modifier|*
name|pm_chk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|alpha_coverage_chk
specifier|static
name|GtkWidget
modifier|*
name|alpha_coverage_chk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|alpha_test_threshold_spin
specifier|static
name|GtkWidget
modifier|*
name|alpha_test_threshold_spin
decl_stmt|;
end_decl_stmt

begin_typedef
DECL|struct|string_value_s
typedef|typedef
struct|struct
name|string_value_s
block|{
DECL|member|value
name|int
name|value
decl_stmt|;
DECL|member|string
name|char
modifier|*
name|string
decl_stmt|;
DECL|typedef|string_value_t
block|}
name|string_value_t
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|compression_strings
specifier|static
name|string_value_t
name|compression_strings
index|[]
init|=
block|{
block|{
name|DDS_COMPRESS_NONE
block|,
literal|"None"
block|}
block|,
block|{
name|DDS_COMPRESS_BC1
block|,
literal|"BC1 / DXT1"
block|}
block|,
block|{
name|DDS_COMPRESS_BC2
block|,
literal|"BC2 / DXT3"
block|}
block|,
block|{
name|DDS_COMPRESS_BC3
block|,
literal|"BC3 / DXT5"
block|}
block|,
block|{
name|DDS_COMPRESS_BC3N
block|,
literal|"BC3nm / DXT5nm"
block|}
block|,
block|{
name|DDS_COMPRESS_BC4
block|,
literal|"BC4 / ATI1 (3Dc+)"
block|}
block|,
block|{
name|DDS_COMPRESS_BC5
block|,
literal|"BC5 / ATI2 (3Dc)"
block|}
block|,
block|{
name|DDS_COMPRESS_RXGB
block|,
literal|"RXGB (DXT5)"
block|}
block|,
block|{
name|DDS_COMPRESS_AEXP
block|,
literal|"Alpha Exponent (DXT5)"
block|}
block|,
block|{
name|DDS_COMPRESS_YCOCG
block|,
literal|"YCoCg (DXT5)"
block|}
block|,
block|{
name|DDS_COMPRESS_YCOCGS
block|,
literal|"YCoCg scaled (DXT5)"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|format_strings
specifier|static
name|string_value_t
name|format_strings
index|[]
init|=
block|{
block|{
name|DDS_FORMAT_DEFAULT
block|,
literal|"Default"
block|}
block|,
block|{
name|DDS_FORMAT_RGB8
block|,
literal|"RGB8"
block|}
block|,
block|{
name|DDS_FORMAT_RGBA8
block|,
literal|"RGBA8"
block|}
block|,
block|{
name|DDS_FORMAT_BGR8
block|,
literal|"BGR8"
block|}
block|,
block|{
name|DDS_FORMAT_ABGR8
block|,
literal|"ABGR8"
block|}
block|,
block|{
name|DDS_FORMAT_R5G6B5
block|,
literal|"R5G6B5"
block|}
block|,
block|{
name|DDS_FORMAT_RGBA4
block|,
literal|"RGBA4"
block|}
block|,
block|{
name|DDS_FORMAT_RGB5A1
block|,
literal|"RGB5A1"
block|}
block|,
block|{
name|DDS_FORMAT_RGB10A2
block|,
literal|"RGB10A2"
block|}
block|,
block|{
name|DDS_FORMAT_R3G3B2
block|,
literal|"R3G3B2"
block|}
block|,
block|{
name|DDS_FORMAT_A8
block|,
literal|"A8"
block|}
block|,
block|{
name|DDS_FORMAT_L8
block|,
literal|"L8"
block|}
block|,
block|{
name|DDS_FORMAT_L8A8
block|,
literal|"L8A8"
block|}
block|,
block|{
name|DDS_FORMAT_AEXP
block|,
literal|"AExp"
block|}
block|,
block|{
name|DDS_FORMAT_YCOCG
block|,
literal|"YCoCg"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_strings
specifier|static
name|string_value_t
name|mipmap_strings
index|[]
init|=
block|{
block|{
name|DDS_MIPMAP_NONE
block|,
literal|"No mipmaps"
block|}
block|,
block|{
name|DDS_MIPMAP_GENERATE
block|,
literal|"Generate mipmaps"
block|}
block|,
block|{
name|DDS_MIPMAP_EXISTING
block|,
literal|"Use existing mipmaps"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_filter_strings
specifier|static
name|string_value_t
name|mipmap_filter_strings
index|[]
init|=
block|{
block|{
name|DDS_MIPMAP_FILTER_DEFAULT
block|,
literal|"Default"
block|}
block|,
block|{
name|DDS_MIPMAP_FILTER_NEAREST
block|,
literal|"Nearest"
block|}
block|,
block|{
name|DDS_MIPMAP_FILTER_BOX
block|,
literal|"Box"
block|}
block|,
block|{
name|DDS_MIPMAP_FILTER_TRIANGLE
block|,
literal|"Triangle"
block|}
block|,
block|{
name|DDS_MIPMAP_FILTER_QUADRATIC
block|,
literal|"Quadratic"
block|}
block|,
block|{
name|DDS_MIPMAP_FILTER_BSPLINE
block|,
literal|"B-Spline"
block|}
block|,
block|{
name|DDS_MIPMAP_FILTER_MITCHELL
block|,
literal|"Mitchell"
block|}
block|,
block|{
name|DDS_MIPMAP_FILTER_LANCZOS
block|,
literal|"Lanczos"
block|}
block|,
block|{
name|DDS_MIPMAP_FILTER_KAISER
block|,
literal|"Kaiser"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|mipmap_wrap_strings
specifier|static
name|string_value_t
name|mipmap_wrap_strings
index|[]
init|=
block|{
block|{
name|DDS_MIPMAP_WRAP_DEFAULT
block|,
literal|"Default"
block|}
block|,
block|{
name|DDS_MIPMAP_WRAP_MIRROR
block|,
literal|"Mirror"
block|}
block|,
block|{
name|DDS_MIPMAP_WRAP_REPEAT
block|,
literal|"Repeat"
block|}
block|,
block|{
name|DDS_MIPMAP_WRAP_CLAMP
block|,
literal|"Clamp"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|save_type_strings
specifier|static
name|string_value_t
name|save_type_strings
index|[]
init|=
block|{
block|{
name|DDS_SAVE_SELECTED_LAYER
block|,
literal|"Image / Selected layer"
block|}
block|,
block|{
name|DDS_SAVE_CUBEMAP
block|,
literal|"As cube map"
block|}
block|,
block|{
name|DDS_SAVE_VOLUMEMAP
block|,
literal|"As volume map"
block|}
block|,
block|{
name|DDS_SAVE_ARRAY
block|,
literal|"As texture array"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
DECL|struct|__anon2a4679d70208
block|{
DECL|member|format
name|int
name|format
decl_stmt|;
DECL|member|dxgi_format
name|DXGI_FORMAT
name|dxgi_format
decl_stmt|;
DECL|member|bpp
name|int
name|bpp
decl_stmt|;
DECL|member|alpha
name|int
name|alpha
decl_stmt|;
DECL|member|rmask
name|unsigned
name|int
name|rmask
decl_stmt|;
DECL|member|gmask
name|unsigned
name|int
name|gmask
decl_stmt|;
DECL|member|bmask
name|unsigned
name|int
name|bmask
decl_stmt|;
DECL|member|amask
name|unsigned
name|int
name|amask
decl_stmt|;
DECL|variable|format_info
block|}
name|format_info
index|[]
init|=
block|{
block|{
name|DDS_FORMAT_RGB8
block|,
name|DXGI_FORMAT_UNKNOWN
block|,
literal|3
block|,
literal|0
block|,
literal|0x00ff0000
block|,
literal|0x0000ff00
block|,
literal|0x000000ff
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_RGBA8
block|,
name|DXGI_FORMAT_B8G8R8A8_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x00ff0000
block|,
literal|0x0000ff00
block|,
literal|0x000000ff
block|,
literal|0xff000000
block|}
block|,
block|{
name|DDS_FORMAT_BGR8
block|,
name|DXGI_FORMAT_UNKNOWN
block|,
literal|3
block|,
literal|0
block|,
literal|0x000000ff
block|,
literal|0x0000ff00
block|,
literal|0x00ff0000
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_ABGR8
block|,
name|DXGI_FORMAT_R8G8B8A8_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x000000ff
block|,
literal|0x0000ff00
block|,
literal|0x00ff0000
block|,
literal|0xff000000
block|}
block|,
block|{
name|DDS_FORMAT_R5G6B5
block|,
name|DXGI_FORMAT_B5G6R5_UNORM
block|,
literal|2
block|,
literal|0
block|,
literal|0x0000f800
block|,
literal|0x000007e0
block|,
literal|0x0000001f
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_RGBA4
block|,
name|DXGI_FORMAT_B4G4R4A4_UNORM
block|,
literal|2
block|,
literal|1
block|,
literal|0x00000f00
block|,
literal|0x000000f0
block|,
literal|0x0000000f
block|,
literal|0x0000f000
block|}
block|,
block|{
name|DDS_FORMAT_RGB5A1
block|,
name|DXGI_FORMAT_B5G5R5A1_UNORM
block|,
literal|2
block|,
literal|1
block|,
literal|0x00007c00
block|,
literal|0x000003e0
block|,
literal|0x0000001f
block|,
literal|0x00008000
block|}
block|,
block|{
name|DDS_FORMAT_RGB10A2
block|,
name|DXGI_FORMAT_R10G10B10A2_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x000003ff
block|,
literal|0x000ffc00
block|,
literal|0x3ff00000
block|,
literal|0xc0000000
block|}
block|,
block|{
name|DDS_FORMAT_R3G3B2
block|,
name|DXGI_FORMAT_UNKNOWN
block|,
literal|1
block|,
literal|0
block|,
literal|0x000000e0
block|,
literal|0x0000001c
block|,
literal|0x00000003
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_A8
block|,
name|DXGI_FORMAT_A8_UNORM
block|,
literal|1
block|,
literal|0
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x000000ff
block|}
block|,
block|{
name|DDS_FORMAT_L8
block|,
name|DXGI_FORMAT_R8_UNORM
block|,
literal|1
block|,
literal|0
block|,
literal|0x000000ff
block|,
literal|0x000000ff
block|,
literal|0x000000ff
block|,
literal|0x00000000
block|}
block|,
block|{
name|DDS_FORMAT_L8A8
block|,
name|DXGI_FORMAT_UNKNOWN
block|,
literal|2
block|,
literal|1
block|,
literal|0x000000ff
block|,
literal|0x000000ff
block|,
literal|0x000000ff
block|,
literal|0x0000ff00
block|}
block|,
block|{
name|DDS_FORMAT_AEXP
block|,
name|DXGI_FORMAT_B8G8R8A8_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x00ff0000
block|,
literal|0x0000ff00
block|,
literal|0x000000ff
block|,
literal|0xff000000
block|}
block|,
block|{
name|DDS_FORMAT_YCOCG
block|,
name|DXGI_FORMAT_B8G8R8A8_UNORM
block|,
literal|4
block|,
literal|1
block|,
literal|0x00ff0000
block|,
literal|0x0000ff00
block|,
literal|0x000000ff
block|,
literal|0xff000000
block|}
block|}
struct|;
end_struct

begin_function
DECL|function|check_mipmaps (gint32 image_id,int savetype)
specifier|static
name|int
name|check_mipmaps
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|int
name|savetype
parameter_list|)
block|{
name|gint
modifier|*
name|layers
decl_stmt|,
name|num_layers
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|,
name|mipw
decl_stmt|,
name|miph
decl_stmt|,
name|num_mipmaps
decl_stmt|,
name|num_surfaces
init|=
literal|0
decl_stmt|;
name|int
name|min_surfaces
init|=
literal|1
decl_stmt|,
name|max_surfaces
init|=
literal|1
decl_stmt|;
name|int
name|valid
init|=
literal|1
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
comment|/* not handling volume maps for the moment... */
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_CUBEMAP
condition|)
block|{
name|min_surfaces
operator|=
literal|6
expr_stmt|;
name|max_surfaces
operator|=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|savetype
operator|==
name|DDS_SAVE_ARRAY
condition|)
block|{
name|min_surfaces
operator|=
literal|2
expr_stmt|;
name|max_surfaces
operator|=
name|INT_MAX
expr_stmt|;
block|}
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
name|w
operator|=
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|num_mipmaps
operator|=
name|get_num_mipmaps
argument_list|(
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|type
operator|!=
name|gimp_drawable_type
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|==
name|w
operator|)
operator|&&
operator|(
name|gimp_drawable_height
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|==
name|h
operator|)
condition|)
operator|++
name|num_surfaces
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|num_surfaces
operator|<
name|min_surfaces
operator|)
operator|||
operator|(
name|num_surfaces
operator|>
name|max_surfaces
operator|)
operator|||
operator|(
name|num_layers
operator|!=
operator|(
name|num_surfaces
operator|*
name|num_mipmaps
operator|)
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|valid
operator|&&
name|i
operator|<
name|num_layers
condition|;
name|i
operator|+=
name|num_mipmaps
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|h
operator|)
condition|)
block|{
name|valid
operator|=
literal|0
expr_stmt|;
break|break;
block|}
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|num_mipmaps
condition|;
operator|++
name|j
control|)
block|{
name|mipw
operator|=
name|w
operator|>>
name|j
expr_stmt|;
name|miph
operator|=
name|h
operator|>>
name|j
expr_stmt|;
if|if
condition|(
name|mipw
operator|<
literal|1
condition|)
name|mipw
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|miph
operator|<
literal|1
condition|)
name|miph
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|layers
index|[
name|i
operator|+
name|j
index|]
argument_list|)
operator|!=
name|mipw
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|layers
index|[
name|i
operator|+
name|j
index|]
argument_list|)
operator|!=
name|miph
operator|)
condition|)
block|{
name|valid
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
operator|(
name|valid
operator|)
return|;
block|}
end_function

begin_function
DECL|function|check_cubemap (gint32 image_id)
specifier|static
name|int
name|check_cubemap
parameter_list|(
name|gint32
name|image_id
parameter_list|)
block|{
name|gint
modifier|*
name|layers
decl_stmt|,
name|num_layers
decl_stmt|;
name|int
name|cubemap
init|=
literal|1
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|char
modifier|*
name|layer_name
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|<
literal|6
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* check for a valid cubemap with mipmap layers */
if|if
condition|(
name|num_layers
operator|>
literal|6
condition|)
block|{
comment|/* check that mipmap layers are in order for a cubemap */
if|if
condition|(
operator|!
name|check_mipmaps
argument_list|(
name|image_id
argument_list|,
name|DDS_SAVE_CUBEMAP
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* invalidate cubemap faces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
name|cubemap_faces
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* find the mipmap level 0 layers */
name|w
operator|=
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|h
operator|)
condition|)
continue|continue;
name|layer_name
operator|=
operator|(
name|char
operator|*
operator|)
name|gimp_item_get_name
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|6
condition|;
operator|++
name|j
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|4
condition|;
operator|++
name|k
control|)
block|{
if|if
condition|(
name|strstr
argument_list|(
name|layer_name
argument_list|,
name|cubemap_face_names
index|[
name|k
index|]
index|[
name|j
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|cubemap_faces
index|[
name|j
index|]
operator|==
operator|-
literal|1
condition|)
block|{
name|cubemap_faces
index|[
name|j
index|]
operator|=
name|layers
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
comment|/* check for 6 valid faces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|cubemap_faces
index|[
name|i
index|]
operator|==
operator|-
literal|1
condition|)
block|{
name|cubemap
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
comment|/* make sure they are all the same type */
if|if
condition|(
name|cubemap
condition|)
block|{
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|cubemap_faces
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|6
operator|&&
name|cubemap
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
operator|!=
name|type
condition|)
name|cubemap
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|num_layers
operator|==
literal|6
condition|)
block|{
comment|/* invalidate cubemap faces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
name|cubemap_faces
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
block|{
name|layer_name
operator|=
operator|(
name|char
operator|*
operator|)
name|gimp_item_get_name
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|6
condition|;
operator|++
name|j
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|4
condition|;
operator|++
name|k
control|)
block|{
if|if
condition|(
name|strstr
argument_list|(
name|layer_name
argument_list|,
name|cubemap_face_names
index|[
name|k
index|]
index|[
name|j
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|cubemap_faces
index|[
name|j
index|]
operator|==
operator|-
literal|1
condition|)
block|{
name|cubemap_faces
index|[
name|j
index|]
operator|=
name|layers
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
comment|/* check for 6 valid faces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|cubemap_faces
index|[
name|i
index|]
operator|==
operator|-
literal|1
condition|)
block|{
name|cubemap
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
comment|/* make sure they are all the same size */
if|if
condition|(
name|cubemap
condition|)
block|{
name|w
operator|=
name|gimp_drawable_width
argument_list|(
name|cubemap_faces
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_drawable_height
argument_list|(
name|cubemap_faces
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|6
operator|&&
name|cubemap
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
operator|!=
name|h
operator|)
condition|)
name|cubemap
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* make sure they are all the same type */
if|if
condition|(
name|cubemap
condition|)
block|{
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|cubemap_faces
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|6
operator|&&
name|cubemap
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|cubemap_faces
index|[
name|i
index|]
argument_list|)
operator|!=
name|type
condition|)
name|cubemap
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|cubemap
operator|)
return|;
block|}
end_function

begin_function
DECL|function|check_volume (gint32 image_id)
specifier|static
name|int
name|check_volume
parameter_list|(
name|gint32
name|image_id
parameter_list|)
block|{
name|gint
modifier|*
name|layers
decl_stmt|,
name|num_layers
decl_stmt|;
name|int
name|volume
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|>
literal|1
condition|)
block|{
name|volume
operator|=
literal|1
expr_stmt|;
comment|/* make sure all layers are the same size */
name|w
operator|=
name|gimp_drawable_width
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_drawable_height
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|num_layers
operator|&&
name|volume
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|h
operator|)
condition|)
name|volume
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|volume
condition|)
block|{
comment|/* make sure all layers are the same type */
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|num_layers
operator|&&
name|volume
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|type
condition|)
name|volume
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|volume
operator|)
return|;
block|}
end_function

begin_function
DECL|function|check_array (gint32 image_id)
specifier|static
name|int
name|check_array
parameter_list|(
name|gint32
name|image_id
parameter_list|)
block|{
name|gint
modifier|*
name|layers
decl_stmt|,
name|num_layers
decl_stmt|;
name|int
name|array
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
if|if
condition|(
name|check_mipmaps
argument_list|(
name|image_id
argument_list|,
name|DDS_SAVE_ARRAY
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_layers
operator|>
literal|1
condition|)
block|{
name|array
operator|=
literal|1
expr_stmt|;
comment|/* make sure all layers are the same size */
name|w
operator|=
name|gimp_drawable_width
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_drawable_height
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|num_layers
operator|&&
name|array
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|w
operator|)
operator|||
operator|(
name|gimp_drawable_height
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|h
operator|)
condition|)
name|array
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|array
condition|)
block|{
comment|/* make sure all layers are the same type */
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|!=
name|type
condition|)
block|{
name|array
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
return|return
operator|(
name|array
operator|)
return|;
block|}
end_function

begin_function
DECL|function|get_array_size (gint32 image_id)
specifier|static
name|int
name|get_array_size
parameter_list|(
name|gint32
name|image_id
parameter_list|)
block|{
name|gint
modifier|*
name|layers
decl_stmt|,
name|num_layers
decl_stmt|;
name|int
name|i
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|,
name|elements
init|=
literal|0
decl_stmt|;
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
name|w
operator|=
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|==
name|w
operator|)
operator|&&
operator|(
name|gimp_drawable_height
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|==
name|h
operator|)
condition|)
operator|++
name|elements
expr_stmt|;
block|}
return|return
operator|(
name|elements
operator|)
return|;
block|}
end_function

begin_function
DECL|function|write_dds (gchar * filename,gint32 image_id,gint32 drawable_id)
name|GimpPDBStatusType
name|write_dds
parameter_list|(
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|gchar
modifier|*
name|tmp
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|is_mipmap_chain_valid
operator|=
name|check_mipmaps
argument_list|(
name|image_id
argument_list|,
name|dds_write_vals
operator|.
name|savetype
argument_list|)
expr_stmt|;
name|is_cubemap
operator|=
name|check_cubemap
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|is_volume
operator|=
name|check_volume
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|is_array
operator|=
name|check_array
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|interactive_dds
condition|)
block|{
if|if
condition|(
operator|!
name|is_mipmap_chain_valid
operator|&&
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_EXISTING
condition|)
name|dds_write_vals
operator|.
name|mipmaps
operator|=
name|DDS_MIPMAP_NONE
expr_stmt|;
if|if
condition|(
operator|!
name|save_dialog
argument_list|(
name|image_id
argument_list|,
name|drawable_id
argument_list|)
condition|)
return|return
operator|(
name|GIMP_PDB_CANCEL
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_CUBEMAP
operator|&&
operator|!
name|is_cubemap
condition|)
block|{
name|g_message
argument_list|(
literal|"DDS: Cannot save image as cube map"
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
operator|&&
operator|!
name|is_volume
condition|)
block|{
name|g_message
argument_list|(
literal|"DDS: Cannot save image as volume map"
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
operator|&&
name|dds_write_vals
operator|.
name|compression
operator|!=
name|DDS_COMPRESS_NONE
condition|)
block|{
name|g_message
argument_list|(
literal|"DDS: Cannot save volume map with compression"
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_EXISTING
operator|&&
operator|!
name|is_mipmap_chain_valid
condition|)
block|{
name|g_message
argument_list|(
literal|"DDS: Cannot save with existing mipmaps as the mipmap chain is incomplete"
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
block|}
name|fp
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
literal|0
condition|)
block|{
name|g_message
argument_list|(
literal|"Error opening %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
condition|)
name|tmp
operator|=
name|g_strdup_printf
argument_list|(
literal|"Saving %s:"
argument_list|,
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|tmp
operator|=
name|g_strdup_printf
argument_list|(
literal|"Saving %s:"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gimp_progress_init
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_image
argument_list|(
name|fp
argument_list|,
name|image_id
argument_list|,
name|drawable_id
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
condition|?
name|GIMP_PDB_SUCCESS
else|:
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
end_function

begin_function
DECL|function|swap_rb (unsigned char * pixels,unsigned int n,int bpp)
specifier|static
name|void
name|swap_rb
parameter_list|(
name|unsigned
name|char
modifier|*
name|pixels
parameter_list|,
name|unsigned
name|int
name|n
parameter_list|,
name|int
name|bpp
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|unsigned
name|char
name|t
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
name|t
operator|=
name|pixels
index|[
name|bpp
operator|*
name|i
operator|+
literal|0
index|]
expr_stmt|;
name|pixels
index|[
name|bpp
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|pixels
index|[
name|bpp
operator|*
name|i
operator|+
literal|2
index|]
expr_stmt|;
name|pixels
index|[
name|bpp
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|t
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|alpha_exp (unsigned char * dst,int r,int g,int b,int a)
specifier|static
name|void
name|alpha_exp
parameter_list|(
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|int
name|r
parameter_list|,
name|int
name|g
parameter_list|,
name|int
name|b
parameter_list|,
name|int
name|a
parameter_list|)
block|{
name|float
name|ar
decl_stmt|,
name|ag
decl_stmt|,
name|ab
decl_stmt|,
name|aa
decl_stmt|;
name|ar
operator|=
operator|(
name|float
operator|)
name|r
operator|/
literal|255.0f
expr_stmt|;
name|ag
operator|=
operator|(
name|float
operator|)
name|g
operator|/
literal|255.0f
expr_stmt|;
name|ab
operator|=
operator|(
name|float
operator|)
name|b
operator|/
literal|255.0f
expr_stmt|;
name|aa
operator|=
name|MAX
argument_list|(
name|ar
argument_list|,
name|MAX
argument_list|(
name|ag
argument_list|,
name|ab
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|aa
operator|<
literal|1e-04f
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
name|b
expr_stmt|;
name|dst
index|[
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|2
index|]
operator|=
name|r
expr_stmt|;
name|dst
index|[
literal|3
index|]
operator|=
literal|255
expr_stmt|;
return|return;
block|}
name|ar
operator|/=
name|aa
expr_stmt|;
name|ag
operator|/=
name|aa
expr_stmt|;
name|ab
operator|/=
name|aa
expr_stmt|;
name|r
operator|=
operator|(
name|int
operator|)
name|floorf
argument_list|(
literal|255.0f
operator|*
name|ar
operator|+
literal|0.5f
argument_list|)
expr_stmt|;
name|g
operator|=
operator|(
name|int
operator|)
name|floorf
argument_list|(
literal|255.0f
operator|*
name|ag
operator|+
literal|0.5f
argument_list|)
expr_stmt|;
name|b
operator|=
operator|(
name|int
operator|)
name|floorf
argument_list|(
literal|255.0f
operator|*
name|ab
operator|+
literal|0.5f
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|int
operator|)
name|floorf
argument_list|(
literal|255.0f
operator|*
name|aa
operator|+
literal|0.5f
argument_list|)
expr_stmt|;
name|dst
index|[
literal|0
index|]
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|255
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|dst
index|[
literal|1
index|]
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|255
argument_list|,
name|g
argument_list|)
argument_list|)
expr_stmt|;
name|dst
index|[
literal|2
index|]
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|255
argument_list|,
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|dst
index|[
literal|3
index|]
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|255
argument_list|,
name|a
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|convert_pixels (unsigned char * dst,unsigned char * src,int format,int w,int h,int d,int bpp,unsigned char * palette,int mipmaps)
specifier|static
name|void
name|convert_pixels
parameter_list|(
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|unsigned
name|char
modifier|*
name|src
parameter_list|,
name|int
name|format
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|bpp
parameter_list|,
name|unsigned
name|char
modifier|*
name|palette
parameter_list|,
name|int
name|mipmaps
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|num_pixels
decl_stmt|;
name|unsigned
name|char
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|,
name|a
decl_stmt|;
if|if
condition|(
name|d
operator|>
literal|0
condition|)
name|num_pixels
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
else|else
name|num_pixels
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_pixels
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|palette
condition|)
block|{
name|r
operator|=
name|palette
index|[
literal|3
operator|*
name|src
index|[
name|i
index|]
operator|+
literal|0
index|]
expr_stmt|;
name|g
operator|=
name|palette
index|[
literal|3
operator|*
name|src
index|[
name|i
index|]
operator|+
literal|1
index|]
expr_stmt|;
name|b
operator|=
name|palette
index|[
literal|3
operator|*
name|src
index|[
name|i
index|]
operator|+
literal|2
index|]
expr_stmt|;
block|}
else|else
name|r
operator|=
name|g
operator|=
name|b
operator|=
name|src
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|format
operator|==
name|DDS_FORMAT_A8
condition|)
name|a
operator|=
name|src
index|[
name|i
index|]
expr_stmt|;
else|else
name|a
operator|=
literal|255
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
block|{
name|r
operator|=
name|g
operator|=
name|b
operator|=
name|src
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|a
operator|=
name|src
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
block|{
name|b
operator|=
name|src
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
expr_stmt|;
name|g
operator|=
name|src
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|r
operator|=
name|src
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
expr_stmt|;
name|a
operator|=
literal|255
expr_stmt|;
block|}
else|else
block|{
name|b
operator|=
name|src
index|[
literal|4
operator|*
name|i
operator|+
literal|0
index|]
expr_stmt|;
name|g
operator|=
name|src
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|r
operator|=
name|src
index|[
literal|4
operator|*
name|i
operator|+
literal|2
index|]
expr_stmt|;
name|a
operator|=
name|src
index|[
literal|4
operator|*
name|i
operator|+
literal|3
index|]
expr_stmt|;
block|}
switch|switch
condition|(
name|format
condition|)
block|{
case|case
name|DDS_FORMAT_RGB8
case|:
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|b
expr_stmt|;
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|r
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_RGBA8
case|:
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|b
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|r
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|3
index|]
operator|=
name|a
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_BGR8
case|:
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|r
expr_stmt|;
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|3
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|b
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_ABGR8
case|:
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|r
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|g
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|2
index|]
operator|=
name|b
expr_stmt|;
name|dst
index|[
literal|4
operator|*
name|i
operator|+
literal|3
index|]
operator|=
name|a
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_R5G6B5
case|:
name|PUTL16
argument_list|(
operator|&
name|dst
index|[
literal|2
operator|*
name|i
index|]
argument_list|,
name|pack_r5g6b5
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_RGBA4
case|:
name|PUTL16
argument_list|(
operator|&
name|dst
index|[
literal|2
operator|*
name|i
index|]
argument_list|,
name|pack_rgba4
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|a
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_RGB5A1
case|:
name|PUTL16
argument_list|(
operator|&
name|dst
index|[
literal|2
operator|*
name|i
index|]
argument_list|,
name|pack_rgb5a1
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|a
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_RGB10A2
case|:
name|PUTL32
argument_list|(
operator|&
name|dst
index|[
literal|4
operator|*
name|i
index|]
argument_list|,
name|pack_rgb10a2
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|a
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_R3G3B2
case|:
name|dst
index|[
name|i
index|]
operator|=
name|pack_r3g3b2
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_A8
case|:
name|dst
index|[
name|i
index|]
operator|=
name|a
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_L8
case|:
name|dst
index|[
name|i
index|]
operator|=
name|rgb_to_luminance
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_L8A8
case|:
name|dst
index|[
literal|2
operator|*
name|i
operator|+
literal|0
index|]
operator|=
name|rgb_to_luminance
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|dst
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|a
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_YCOCG
case|:
name|dst
index|[
literal|4
operator|*
name|i
index|]
operator|=
name|a
expr_stmt|;
name|RGB_to_YCoCg
argument_list|(
operator|&
name|dst
index|[
literal|4
operator|*
name|i
index|]
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_FORMAT_AEXP
case|:
name|alpha_exp
argument_list|(
operator|&
name|dst
index|[
literal|4
operator|*
name|i
index|]
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
block|}
end_function

begin_function
DECL|function|get_mipmap_chain (unsigned char * dst,int w,int h,int bpp,gint32 image_id,gint drawable_id)
specifier|static
name|void
name|get_mipmap_chain
parameter_list|(
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|bpp
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|gint
name|drawable_id
parameter_list|)
block|{
name|gint
modifier|*
name|layers
decl_stmt|,
name|num_layers
decl_stmt|;
name|GeglBuffer
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|Babl
modifier|*
name|format
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|idx
init|=
literal|0
decl_stmt|,
name|offset
decl_stmt|,
name|mipw
decl_stmt|,
name|miph
decl_stmt|;
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y' u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y'A u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
else|else
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
expr_stmt|;
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|layers
index|[
name|i
index|]
operator|==
name|drawable_id
condition|)
block|{
name|idx
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|num_layers
condition|)
return|return;
name|offset
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|get_next_mipmap_dimensions
argument_list|(
operator|&
name|mipw
argument_list|,
operator|&
name|miph
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
condition|)
block|{
name|buffer
operator|=
name|gimp_drawable_get_buffer
argument_list|(
name|layers
index|[
operator|++
name|idx
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|gegl_buffer_get_width
argument_list|(
name|buffer
argument_list|)
operator|!=
name|mipw
operator|)
operator|||
operator|(
name|gegl_buffer_get_height
argument_list|(
name|buffer
argument_list|)
operator|!=
name|miph
operator|)
condition|)
block|{
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return;
block|}
name|gegl_buffer_get
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|mipw
argument_list|,
name|miph
argument_list|)
argument_list|,
literal|1.0
argument_list|,
name|format
argument_list|,
name|dst
operator|+
name|offset
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|,
name|GEGL_ABYSS_NONE
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
comment|/* we need BGRX or BGRA */
if|if
condition|(
name|bpp
operator|>=
literal|3
condition|)
name|swap_rb
argument_list|(
name|dst
operator|+
name|offset
argument_list|,
name|mipw
operator|*
name|miph
argument_list|,
name|bpp
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
name|mipw
operator|*
name|miph
operator|*
name|bpp
operator|)
expr_stmt|;
name|w
operator|=
name|mipw
expr_stmt|;
name|h
operator|=
name|miph
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|write_layer (FILE * fp,gint32 image_id,gint32 drawable_id,int w,int h,int bpp,int fmtbpp,int mipmaps)
specifier|static
name|void
name|write_layer
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|bpp
parameter_list|,
name|int
name|fmtbpp
parameter_list|,
name|int
name|mipmaps
parameter_list|)
block|{
name|GeglBuffer
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|Babl
modifier|*
name|format
init|=
literal|0
decl_stmt|;
name|GimpImageBaseType
name|basetype
decl_stmt|;
name|GimpImageType
name|type
decl_stmt|;
name|unsigned
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|,
modifier|*
name|fmtdst
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|unsigned
name|char
modifier|*
name|palette
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|c
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|size
decl_stmt|,
name|fmtsize
decl_stmt|,
name|offset
decl_stmt|,
name|colors
decl_stmt|;
name|int
name|compression
init|=
name|dds_write_vals
operator|.
name|compression
decl_stmt|;
name|int
name|flags
init|=
literal|0
decl_stmt|;
name|basetype
operator|=
name|gimp_image_base_type
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|type
operator|=
name|gimp_drawable_type
argument_list|(
name|drawable_id
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|gimp_drawable_get_buffer
argument_list|(
name|drawable_id
argument_list|)
expr_stmt|;
name|src
operator|=
name|g_malloc
argument_list|(
name|w
operator|*
name|h
operator|*
name|bpp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y' u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y'A u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
else|else
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
expr_stmt|;
name|gegl_buffer_get
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
argument_list|,
literal|1.0
argument_list|,
name|format
argument_list|,
name|src
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|,
name|GEGL_ABYSS_NONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|palette
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image_id
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|GIMP_INDEXEDA_IMAGE
condition|)
block|{
name|tmp
operator|=
name|g_malloc
argument_list|(
name|w
operator|*
name|h
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|w
operator|*
name|h
condition|;
operator|++
name|i
control|)
name|tmp
index|[
name|i
index|]
operator|=
name|src
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|tmp
expr_stmt|;
name|bpp
operator|=
literal|1
expr_stmt|;
block|}
block|}
comment|/* we want and assume BGRA ordered pixels for bpp>= 3 from here and       onwards */
if|if
condition|(
name|bpp
operator|>=
literal|3
condition|)
name|swap_rb
argument_list|(
name|src
argument_list|,
name|w
operator|*
name|h
argument_list|,
name|bpp
argument_list|)
expr_stmt|;
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_BC3N
condition|)
block|{
if|if
condition|(
name|bpp
operator|!=
literal|4
condition|)
block|{
name|fmtsize
operator|=
name|w
operator|*
name|h
operator|*
literal|4
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGBA8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|4
expr_stmt|;
block|}
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|h
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|w
condition|;
operator|++
name|x
control|)
block|{
comment|/* set alpha to red (x) */
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|3
index|]
operator|=
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|2
index|]
expr_stmt|;
comment|/* set red to 1 */
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|2
index|]
operator|=
literal|255
expr_stmt|;
block|}
block|}
block|}
comment|/* RXGB (Doom3) */
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_RXGB
condition|)
block|{
if|if
condition|(
name|bpp
operator|!=
literal|4
condition|)
block|{
name|fmtsize
operator|=
name|w
operator|*
name|h
operator|*
literal|4
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGBA8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|4
expr_stmt|;
block|}
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|h
condition|;
operator|++
name|y
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|w
condition|;
operator|++
name|x
control|)
block|{
comment|/* swap red and alpha */
name|c
operator|=
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|3
index|]
expr_stmt|;
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|3
index|]
operator|=
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|2
index|]
expr_stmt|;
name|src
index|[
name|y
operator|*
operator|(
name|w
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|2
index|]
operator|=
name|c
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_YCOCG
operator|||
name|compression
operator|==
name|DDS_COMPRESS_YCOCGS
condition|)
comment|/* convert to YCoCG */
block|{
name|fmtsize
operator|=
name|w
operator|*
name|h
operator|*
literal|4
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_YCOCG
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_AEXP
condition|)
block|{
name|fmtsize
operator|=
name|w
operator|*
name|h
operator|*
literal|4
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_AEXP
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|compression
operator|==
name|DDS_COMPRESS_NONE
condition|)
block|{
if|if
condition|(
name|mipmaps
operator|>
literal|1
condition|)
block|{
comment|/* pre-convert indexed images to RGB for better quality mipmaps             if a pixel format conversion is requested */
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|>
name|DDS_FORMAT_DEFAULT
operator|&&
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|fmtsize
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGB8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|3
expr_stmt|;
name|palette
operator|=
name|NULL
expr_stmt|;
block|}
name|size
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|dst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
condition|)
block|{
name|generate_mipmaps
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|palette
operator|!=
name|NULL
argument_list|,
name|mipmaps
argument_list|,
name|dds_write_vals
operator|.
name|mipmap_filter
argument_list|,
name|dds_write_vals
operator|.
name|mipmap_wrap
argument_list|,
name|dds_write_vals
operator|.
name|gamma_correct
operator|+
name|dds_write_vals
operator|.
name|srgb
argument_list|,
name|dds_write_vals
operator|.
name|gamma
argument_list|,
name|dds_write_vals
operator|.
name|preserve_alpha_coverage
argument_list|,
name|dds_write_vals
operator|.
name|alpha_test_threshold
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|w
operator|*
name|h
operator|*
name|bpp
argument_list|)
expr_stmt|;
name|get_mipmap_chain
argument_list|(
name|dst
operator|+
operator|(
name|w
operator|*
name|h
operator|*
name|bpp
operator|)
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|image_id
argument_list|,
name|drawable_id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
name|fmtsize
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|fmtbpp
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|dst
argument_list|,
name|dds_write_vals
operator|.
name|format
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
name|mipmaps
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
name|fmtbpp
expr_stmt|;
block|}
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mipmaps
condition|;
operator|++
name|i
control|)
block|{
name|size
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|dst
operator|+
name|offset
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|size
expr_stmt|;
block|}
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|h
operator|*
name|w
operator|*
name|fmtbpp
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|dds_write_vals
operator|.
name|format
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
name|fmtbpp
expr_stmt|;
block|}
name|fwrite
argument_list|(
name|src
argument_list|,
literal|1
argument_list|,
name|h
operator|*
name|w
operator|*
name|bpp
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|size
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|compression
argument_list|)
expr_stmt|;
name|dst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|fmtsize
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGB8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
name|mipmaps
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
name|bpp
operator|=
literal|3
expr_stmt|;
block|}
if|if
condition|(
name|mipmaps
operator|>
literal|1
condition|)
block|{
name|fmtsize
operator|=
name|get_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|fmtsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
condition|)
block|{
name|generate_mipmaps
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|dds_write_vals
operator|.
name|mipmap_filter
argument_list|,
name|dds_write_vals
operator|.
name|mipmap_wrap
argument_list|,
name|dds_write_vals
operator|.
name|gamma_correct
operator|+
name|dds_write_vals
operator|.
name|srgb
argument_list|,
name|dds_write_vals
operator|.
name|gamma
argument_list|,
name|dds_write_vals
operator|.
name|preserve_alpha_coverage
argument_list|,
name|dds_write_vals
operator|.
name|alpha_test_threshold
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|fmtdst
argument_list|,
name|src
argument_list|,
name|w
operator|*
name|h
operator|*
name|bpp
argument_list|)
expr_stmt|;
name|get_mipmap_chain
argument_list|(
name|fmtdst
operator|+
operator|(
name|w
operator|*
name|h
operator|*
name|bpp
operator|)
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|image_id
argument_list|,
name|drawable_id
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|fmtdst
expr_stmt|;
block|}
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|perceptual_metric
condition|)
name|flags
operator||=
name|DXT_PERCEPTUAL
expr_stmt|;
name|dxt_compress
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|compression
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|mipmaps
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|dst
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|write_volume_mipmaps (FILE * fp,gint32 image_id,gint32 * layers,int w,int h,int d,int bpp,int fmtbpp,int mipmaps)
specifier|static
name|void
name|write_volume_mipmaps
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|gint32
modifier|*
name|layers
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|bpp
parameter_list|,
name|int
name|fmtbpp
parameter_list|,
name|int
name|mipmaps
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|size
decl_stmt|,
name|offset
decl_stmt|,
name|colors
decl_stmt|;
name|unsigned
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|,
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|fmtdst
decl_stmt|;
name|unsigned
name|char
modifier|*
name|palette
init|=
literal|0
decl_stmt|;
name|GeglBuffer
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|Babl
modifier|*
name|format
decl_stmt|;
name|GimpImageBaseType
name|type
decl_stmt|;
name|type
operator|=
name|gimp_image_base_type
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|compression
operator|!=
name|DDS_COMPRESS_NONE
condition|)
return|return;
name|src
operator|=
name|g_malloc
argument_list|(
name|w
operator|*
name|h
operator|*
name|bpp
operator|*
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y' u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"Y'A u8"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
else|else
name|format
operator|=
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
expr_stmt|;
if|if
condition|(
name|gimp_image_base_type
argument_list|(
name|image_id
argument_list|)
operator|==
name|GIMP_INDEXED
condition|)
name|palette
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image_id
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|d
condition|;
operator|++
name|i
control|)
block|{
name|buffer
operator|=
name|gimp_drawable_get_buffer
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|gegl_buffer_get
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
argument_list|,
literal|1.0
argument_list|,
name|format
argument_list|,
name|src
operator|+
name|offset
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|,
name|GEGL_ABYSS_NONE
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
name|w
operator|*
name|h
operator|*
name|bpp
operator|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gimp_drawable_type
argument_list|(
name|layers
index|[
literal|0
index|]
argument_list|)
operator|==
name|GIMP_INDEXEDA_IMAGE
condition|)
block|{
name|tmp
operator|=
name|g_malloc
argument_list|(
name|w
operator|*
name|h
operator|*
name|d
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|w
operator|*
name|h
operator|*
name|d
condition|;
operator|++
name|i
control|)
name|tmp
index|[
name|i
index|]
operator|=
name|src
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|tmp
expr_stmt|;
name|bpp
operator|=
literal|1
expr_stmt|;
block|}
comment|/* we want and assume BGRA ordered pixels for bpp>= 3 from here and       onwards */
if|if
condition|(
name|bpp
operator|>=
literal|3
condition|)
name|swap_rb
argument_list|(
name|src
argument_list|,
name|w
operator|*
name|h
operator|*
name|d
argument_list|,
name|bpp
argument_list|)
expr_stmt|;
comment|/* pre-convert indexed images to RGB for better mipmaps if a       pixel format conversion is requested */
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|>
name|DDS_FORMAT_DEFAULT
operator|&&
name|type
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|size
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|dst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|DDS_FORMAT_RGB8
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|src
operator|=
name|dst
expr_stmt|;
name|bpp
operator|=
literal|3
expr_stmt|;
name|palette
operator|=
name|NULL
expr_stmt|;
block|}
name|size
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|dds_write_vals
operator|.
name|compression
argument_list|)
expr_stmt|;
name|dst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|offset
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|dds_write_vals
operator|.
name|compression
argument_list|)
expr_stmt|;
name|generate_volume_mipmaps
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
name|palette
operator|!=
name|NULL
argument_list|,
name|mipmaps
argument_list|,
name|dds_write_vals
operator|.
name|mipmap_filter
argument_list|,
name|dds_write_vals
operator|.
name|mipmap_wrap
argument_list|,
name|dds_write_vals
operator|.
name|gamma_correct
operator|+
name|dds_write_vals
operator|.
name|srgb
argument_list|,
name|dds_write_vals
operator|.
name|gamma
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
name|size
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|fmtbpp
argument_list|,
literal|0
argument_list|,
name|mipmaps
argument_list|,
name|dds_write_vals
operator|.
name|compression
argument_list|)
expr_stmt|;
name|offset
operator|=
name|get_volume_mipmapped_size
argument_list|(
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|fmtbpp
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|dds_write_vals
operator|.
name|compression
argument_list|)
expr_stmt|;
name|fmtdst
operator|=
name|g_malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|convert_pixels
argument_list|(
name|fmtdst
argument_list|,
name|dst
argument_list|,
name|dds_write_vals
operator|.
name|format
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|d
argument_list|,
name|bpp
argument_list|,
name|palette
argument_list|,
name|mipmaps
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|=
name|fmtdst
expr_stmt|;
block|}
name|fwrite
argument_list|(
name|dst
operator|+
name|offset
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|src
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|write_image (FILE * fp,gint32 image_id,gint32 drawable_id)
specifier|static
name|int
name|write_image
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|)
block|{
name|GimpImageType
name|drawable_type
decl_stmt|;
name|GimpImageBaseType
name|basetype
decl_stmt|;
name|int
name|i
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|,
name|bpp
init|=
literal|0
decl_stmt|,
name|fmtbpp
init|=
literal|0
decl_stmt|,
name|has_alpha
init|=
literal|0
decl_stmt|;
name|int
name|num_mipmaps
decl_stmt|;
name|unsigned
name|char
name|hdr
index|[
name|DDS_HEADERSIZE
index|]
decl_stmt|,
name|hdr10
index|[
name|DDS_HEADERSIZE_DX10
index|]
decl_stmt|;
name|unsigned
name|int
name|flags
init|=
literal|0
decl_stmt|,
name|pflags
init|=
literal|0
decl_stmt|,
name|caps
init|=
literal|0
decl_stmt|,
name|caps2
init|=
literal|0
decl_stmt|,
name|size
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|rmask
init|=
literal|0
decl_stmt|,
name|gmask
init|=
literal|0
decl_stmt|,
name|bmask
init|=
literal|0
decl_stmt|,
name|amask
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|fourcc
init|=
literal|0
decl_stmt|;
name|DXGI_FORMAT
name|dxgi_format
init|=
name|DXGI_FORMAT_UNKNOWN
decl_stmt|;
name|gint32
name|num_layers
decl_stmt|,
modifier|*
name|layers
decl_stmt|;
name|guchar
modifier|*
name|cmap
decl_stmt|;
name|gint
name|colors
decl_stmt|;
name|unsigned
name|char
name|zero
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|int
name|is_dx10
init|=
literal|0
decl_stmt|,
name|array_size
init|=
literal|1
decl_stmt|;
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image_id
argument_list|,
operator|&
name|num_layers
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_EXISTING
condition|)
name|drawable_id
operator|=
name|layers
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_SELECTED_LAYER
condition|)
block|{
name|w
operator|=
name|gimp_drawable_width
argument_list|(
name|drawable_id
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_drawable_height
argument_list|(
name|drawable_id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|w
operator|=
name|gimp_image_width
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|h
operator|=
name|gimp_image_height
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
block|}
name|basetype
operator|=
name|gimp_image_base_type
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|drawable_type
operator|=
name|gimp_drawable_type
argument_list|(
name|drawable_id
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|drawable_type
condition|)
block|{
case|case
name|GIMP_RGB_IMAGE
case|:
name|bpp
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|GIMP_RGBA_IMAGE
case|:
name|bpp
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|GIMP_GRAY_IMAGE
case|:
name|bpp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|GIMP_GRAYA_IMAGE
case|:
name|bpp
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXED_IMAGE
case|:
name|bpp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|GIMP_INDEXEDA_IMAGE
case|:
name|bpp
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|format_info
index|[
name|i
index|]
operator|.
name|format
operator|==
name|dds_write_vals
operator|.
name|format
condition|)
block|{
name|fmtbpp
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|bpp
expr_stmt|;
name|has_alpha
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|alpha
expr_stmt|;
name|rmask
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|rmask
expr_stmt|;
name|gmask
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|gmask
expr_stmt|;
name|bmask
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|bmask
expr_stmt|;
name|amask
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|amask
expr_stmt|;
name|dxgi_format
operator|=
name|format_info
index|[
name|i
index|]
operator|.
name|dxgi_format
expr_stmt|;
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|fmtbpp
operator|=
literal|1
expr_stmt|;
name|has_alpha
operator|=
literal|0
expr_stmt|;
name|rmask
operator|=
name|bmask
operator|=
name|gmask
operator|=
name|amask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fmtbpp
operator|=
literal|1
expr_stmt|;
name|has_alpha
operator|=
literal|0
expr_stmt|;
name|rmask
operator|=
literal|0x000000ff
expr_stmt|;
name|gmask
operator|=
name|bmask
operator|=
name|amask
operator|=
literal|0
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_R8_UNORM
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
block|{
name|fmtbpp
operator|=
literal|1
expr_stmt|;
name|has_alpha
operator|=
literal|0
expr_stmt|;
name|rmask
operator|=
name|gmask
operator|=
name|bmask
operator|=
name|amask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fmtbpp
operator|=
literal|2
expr_stmt|;
name|has_alpha
operator|=
literal|1
expr_stmt|;
name|rmask
operator|=
literal|0x000000ff
expr_stmt|;
name|gmask
operator|=
literal|0x000000ff
expr_stmt|;
name|bmask
operator|=
literal|0x000000ff
expr_stmt|;
name|amask
operator|=
literal|0x0000ff00
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|bpp
operator|==
literal|3
condition|)
block|{
name|fmtbpp
operator|=
literal|3
expr_stmt|;
name|rmask
operator|=
literal|0x00ff0000
expr_stmt|;
name|gmask
operator|=
literal|0x0000ff00
expr_stmt|;
name|bmask
operator|=
literal|0x000000ff
expr_stmt|;
name|amask
operator|=
literal|0x00000000
expr_stmt|;
block|}
else|else
block|{
name|fmtbpp
operator|=
literal|4
expr_stmt|;
name|has_alpha
operator|=
literal|1
expr_stmt|;
name|rmask
operator|=
literal|0x00ff0000
expr_stmt|;
name|gmask
operator|=
literal|0x0000ff00
expr_stmt|;
name|bmask
operator|=
literal|0x000000ff
expr_stmt|;
name|amask
operator|=
literal|0xff000000
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_B8G8R8A8_UNORM
expr_stmt|;
block|}
name|memset
argument_list|(
name|hdr
argument_list|,
literal|0
argument_list|,
name|DDS_HEADERSIZE
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
argument_list|,
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'D'
argument_list|,
literal|'S'
argument_list|,
literal|' '
argument_list|)
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|4
argument_list|,
literal|124
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|12
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|16
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|76
argument_list|,
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_NONE
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|88
argument_list|,
name|fmtbpp
operator|<<
literal|3
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|92
argument_list|,
name|rmask
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|96
argument_list|,
name|gmask
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|100
argument_list|,
name|bmask
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|104
argument_list|,
name|amask
argument_list|)
expr_stmt|;
block|}
comment|/*     put some information in the reserved area to identify the origin     of the image    */
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|32
argument_list|,
name|FOURCC
argument_list|(
literal|'G'
argument_list|,
literal|'I'
argument_list|,
literal|'M'
argument_list|,
literal|'P'
argument_list|)
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|36
argument_list|,
name|FOURCC
argument_list|(
literal|'-'
argument_list|,
literal|'D'
argument_list|,
literal|'D'
argument_list|,
literal|'S'
argument_list|)
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|40
argument_list|,
name|DDS_PLUGIN_VERSION
argument_list|)
expr_stmt|;
name|flags
operator|=
name|DDSD_CAPS
operator||
name|DDSD_PIXELFORMAT
operator||
name|DDSD_WIDTH
operator||
name|DDSD_HEIGHT
expr_stmt|;
name|caps
operator|=
name|DDSCAPS_TEXTURE
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|mipmaps
condition|)
block|{
name|flags
operator||=
name|DDSD_MIPMAPCOUNT
expr_stmt|;
name|caps
operator||=
operator|(
name|DDSCAPS_COMPLEX
operator||
name|DDSCAPS_MIPMAP
operator|)
expr_stmt|;
name|num_mipmaps
operator|=
name|get_num_mipmaps
argument_list|(
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
else|else
name|num_mipmaps
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_CUBEMAP
operator|)
operator|&&
name|is_cubemap
condition|)
block|{
name|caps
operator||=
name|DDSCAPS_COMPLEX
expr_stmt|;
name|caps2
operator||=
operator|(
name|DDSCAPS2_CUBEMAP
operator||
name|DDSCAPS2_CUBEMAP_ALL_FACES
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
operator|)
operator|&&
name|is_volume
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|24
argument_list|,
name|num_layers
argument_list|)
expr_stmt|;
comment|/* depth */
name|flags
operator||=
name|DDSD_DEPTH
expr_stmt|;
name|caps
operator||=
name|DDSCAPS_COMPLEX
expr_stmt|;
name|caps2
operator||=
name|DDSCAPS2_VOLUME
expr_stmt|;
block|}
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|28
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|108
argument_list|,
name|caps
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|112
argument_list|,
name|caps2
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_NONE
condition|)
block|{
name|flags
operator||=
name|DDSD_PITCH
expr_stmt|;
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|>
name|DDS_FORMAT_DEFAULT
condition|)
block|{
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|==
name|DDS_FORMAT_A8
condition|)
name|pflags
operator||=
name|DDPF_ALPHA
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|fmtbpp
operator|==
literal|1
operator|)
operator|||
operator|(
name|dds_write_vals
operator|.
name|format
operator|==
name|DDS_FORMAT_L8A8
operator|)
operator|)
operator|&&
operator|(
name|dds_write_vals
operator|.
name|format
operator|!=
name|DDS_FORMAT_R3G3B2
operator|)
condition|)
name|pflags
operator||=
name|DDPF_LUMINANCE
expr_stmt|;
else|else
name|pflags
operator||=
name|DDPF_RGB
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|bpp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|basetype
operator|==
name|GIMP_INDEXED
condition|)
name|pflags
operator||=
name|DDPF_PALETTEINDEXED8
expr_stmt|;
else|else
name|pflags
operator||=
name|DDPF_LUMINANCE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bpp
operator|==
literal|2
operator|)
operator|&&
operator|(
name|basetype
operator|==
name|GIMP_INDEXED
operator|)
condition|)
name|pflags
operator||=
name|DDPF_PALETTEINDEXED8
expr_stmt|;
else|else
name|pflags
operator||=
name|DDPF_RGB
expr_stmt|;
block|}
if|if
condition|(
name|has_alpha
condition|)
name|pflags
operator||=
name|DDPF_ALPHAPIXELS
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|8
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|20
argument_list|,
name|w
operator|*
name|fmtbpp
argument_list|)
expr_stmt|;
comment|/* pitch */
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|80
argument_list|,
name|pflags
argument_list|)
expr_stmt|;
comment|/*        write extra fourcc info - this is special to GIMP DDS. When the image        is read by the plugin, we can detect the added information to decode        the pixels       */
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|==
name|DDS_FORMAT_AEXP
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'E'
argument_list|,
literal|'X'
argument_list|,
literal|'P'
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dds_write_vals
operator|.
name|format
operator|==
name|DDS_FORMAT_YCOCG
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'Y'
argument_list|,
literal|'C'
argument_list|,
literal|'G'
argument_list|,
literal|'1'
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|flags
operator||=
name|DDSD_LINEARSIZE
expr_stmt|;
name|pflags
operator|=
name|DDPF_FOURCC
expr_stmt|;
switch|switch
condition|(
name|dds_write_vals
operator|.
name|compression
condition|)
block|{
case|case
name|DDS_COMPRESS_BC1
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'1'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC1_UNORM
expr_stmt|;
break|break;
case|case
name|DDS_COMPRESS_BC2
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'3'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC2_UNORM
expr_stmt|;
break|break;
case|case
name|DDS_COMPRESS_BC3
case|:
case|case
name|DDS_COMPRESS_BC3N
case|:
case|case
name|DDS_COMPRESS_YCOCG
case|:
case|case
name|DDS_COMPRESS_YCOCGS
case|:
case|case
name|DDS_COMPRESS_AEXP
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'5'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC3_UNORM
expr_stmt|;
break|break;
case|case
name|DDS_COMPRESS_RXGB
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'R'
argument_list|,
literal|'X'
argument_list|,
literal|'G'
argument_list|,
literal|'B'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC3_UNORM
expr_stmt|;
break|break;
case|case
name|DDS_COMPRESS_BC4
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'1'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC4_UNORM
expr_stmt|;
comment|//is_dx10 = 1;
break|break;
case|case
name|DDS_COMPRESS_BC5
case|:
name|fourcc
operator|=
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'2'
argument_list|)
expr_stmt|;
name|dxgi_format
operator|=
name|DXGI_FORMAT_BC5_UNORM
expr_stmt|;
comment|//is_dx10 = 1;
break|break;
block|}
if|if
condition|(
operator|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_BC3N
operator|)
operator|||
operator|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_RXGB
operator|)
condition|)
name|pflags
operator||=
name|DDPF_NORMAL
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|8
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|80
argument_list|,
name|pflags
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|84
argument_list|,
name|fourcc
argument_list|)
expr_stmt|;
name|size
operator|=
operator|(
operator|(
name|w
operator|+
literal|3
operator|)
operator|>>
literal|2
operator|)
operator|*
operator|(
operator|(
name|h
operator|+
literal|3
operator|)
operator|>>
literal|2
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_BC1
operator|)
operator|||
operator|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_BC4
operator|)
condition|)
name|size
operator|*=
literal|8
expr_stmt|;
else|else
name|size
operator|*=
literal|16
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|20
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* linear size */
comment|/*        write extra fourcc info - this is special to GIMP DDS. When the image        is read by the plugin, we can detect the added information to decode        the pixels       */
if|if
condition|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_AEXP
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'E'
argument_list|,
literal|'X'
argument_list|,
literal|'P'
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_YCOCG
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'Y'
argument_list|,
literal|'C'
argument_list|,
literal|'G'
argument_list|,
literal|'1'
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_YCOCGS
condition|)
block|{
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|44
argument_list|,
name|FOURCC
argument_list|(
literal|'Y'
argument_list|,
literal|'C'
argument_list|,
literal|'G'
argument_list|,
literal|'2'
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* texture arrays require a DX10 header */
if|if
condition|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_ARRAY
condition|)
name|is_dx10
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|is_dx10
condition|)
block|{
name|array_size
operator|=
operator|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_SELECTED_LAYER
operator|)
condition|?
literal|1
else|:
name|get_array_size
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|0
argument_list|,
name|dxgi_format
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|4
argument_list|,
name|D3D10_RESOURCE_DIMENSION_TEXTURE2D
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|12
argument_list|,
name|array_size
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr10
operator|+
literal|16
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* update main header accordingly */
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|80
argument_list|,
name|pflags
operator||
name|DDPF_FOURCC
argument_list|)
expr_stmt|;
name|PUTL32
argument_list|(
name|hdr
operator|+
literal|84
argument_list|,
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'1'
argument_list|,
literal|'0'
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fwrite
argument_list|(
name|hdr
argument_list|,
name|DDS_HEADERSIZE
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_dx10
condition|)
name|fwrite
argument_list|(
name|hdr10
argument_list|,
name|DDS_HEADERSIZE_DX10
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
comment|/* write palette for indexed images */
if|if
condition|(
operator|(
name|basetype
operator|==
name|GIMP_INDEXED
operator|)
operator|&&
operator|(
name|dds_write_vals
operator|.
name|format
operator|==
name|DDS_FORMAT_DEFAULT
operator|)
operator|&&
operator|(
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_NONE
operator|)
condition|)
block|{
name|cmap
operator|=
name|gimp_image_get_colormap
argument_list|(
name|image_id
argument_list|,
operator|&
name|colors
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|colors
condition|;
operator|++
name|i
control|)
block|{
name|fwrite
argument_list|(
operator|&
name|cmap
index|[
literal|3
operator|*
name|i
index|]
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|dds_write_vals
operator|.
name|transindex
condition|)
name|fputc
argument_list|(
literal|0
argument_list|,
name|fp
argument_list|)
expr_stmt|;
else|else
name|fputc
argument_list|(
literal|255
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
literal|256
condition|;
operator|++
name|i
control|)
name|fwrite
argument_list|(
name|zero
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_CUBEMAP
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
operator|++
name|i
control|)
block|{
name|write_layer
argument_list|(
name|fp
argument_list|,
name|image_id
argument_list|,
name|cubemap_faces
index|[
name|i
index|]
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
name|gimp_progress_update
argument_list|(
call|(
name|float
call|)
argument_list|(
name|i
operator|+
literal|1
argument_list|)
operator|/
literal|6.0
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
control|)
block|{
name|write_layer
argument_list|(
name|fp
argument_list|,
name|image_id
argument_list|,
name|layers
index|[
name|i
index|]
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|float
operator|)
name|i
operator|/
operator|(
name|float
operator|)
name|num_layers
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|num_mipmaps
operator|>
literal|1
condition|)
name|write_volume_mipmaps
argument_list|(
name|fp
argument_list|,
name|image_id
argument_list|,
name|layers
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|num_layers
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_ARRAY
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_layers
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
name|gimp_drawable_width
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|==
name|w
operator|)
operator|&&
operator|(
name|gimp_drawable_height
argument_list|(
name|layers
index|[
name|i
index|]
argument_list|)
operator|==
name|h
operator|)
condition|)
name|write_layer
argument_list|(
name|fp
argument_list|,
name|image_id
argument_list|,
name|layers
index|[
name|i
index|]
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|float
operator|)
name|i
operator|/
operator|(
name|float
operator|)
name|num_layers
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|write_layer
argument_list|(
name|fp
argument_list|,
name|image_id
argument_list|,
name|drawable_id
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|bpp
argument_list|,
name|fmtbpp
argument_list|,
name|num_mipmaps
argument_list|)
expr_stmt|;
block|}
name|gimp_progress_update
argument_list|(
literal|1.0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
DECL|function|string_value_combo_new (string_value_t * strings,int active_value)
specifier|static
name|GtkWidget
modifier|*
name|string_value_combo_new
parameter_list|(
name|string_value_t
modifier|*
name|strings
parameter_list|,
name|int
name|active_value
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|opt
decl_stmt|;
name|GtkCellRenderer
modifier|*
name|renderer
decl_stmt|;
name|GtkListStore
modifier|*
name|store
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|int
name|i
decl_stmt|,
name|active
init|=
literal|0
decl_stmt|;
name|store
operator|=
name|gtk_list_store_new
argument_list|(
literal|3
argument_list|,
name|G_TYPE_INT
argument_list|,
name|G_TYPE_STRING
argument_list|,
name|G_TYPE_BOOLEAN
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|strings
index|[
name|i
index|]
operator|.
name|string
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|strings
index|[
name|i
index|]
operator|.
name|value
operator|==
name|active_value
condition|)
name|active
operator|=
name|i
expr_stmt|;
name|gtk_list_store_append
argument_list|(
name|store
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|gtk_list_store_set
argument_list|(
name|store
argument_list|,
operator|&
name|iter
argument_list|,
literal|0
argument_list|,
name|strings
index|[
name|i
index|]
operator|.
name|value
argument_list|,
literal|1
argument_list|,
name|strings
index|[
name|i
index|]
operator|.
name|string
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|renderer
operator|=
name|gtk_cell_renderer_text_new
argument_list|()
expr_stmt|;
name|opt
operator|=
name|gtk_combo_box_new_with_model
argument_list|(
name|GTK_TREE_MODEL
argument_list|(
name|store
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_cell_layout_pack_start
argument_list|(
name|GTK_CELL_LAYOUT
argument_list|(
name|opt
argument_list|)
argument_list|,
name|renderer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_cell_layout_set_attributes
argument_list|(
name|GTK_CELL_LAYOUT
argument_list|(
name|opt
argument_list|)
argument_list|,
name|renderer
argument_list|,
literal|"text"
argument_list|,
name|COMBO_STRING
argument_list|,
literal|"sensitive"
argument_list|,
name|COMBO_SENSITIVE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_combo_box_set_active
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|opt
argument_list|)
argument_list|,
name|active
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|store
argument_list|)
expr_stmt|;
return|return
operator|(
name|opt
operator|)
return|;
block|}
end_function

begin_function
DECL|function|string_value_combo_selected (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|string_value_combo_selected
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
name|value
decl_stmt|;
name|GtkTreeIter
name|iter
decl_stmt|;
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|model
operator|=
name|gtk_combo_box_get_model
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_combo_box_get_active_iter
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|COMBO_VALUE
argument_list|,
operator|&
name|value
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
operator|=
name|value
expr_stmt|;
block|}
end_function

begin_function
DECL|function|string_value_combo_set_item_sensitive (GtkWidget * widget,int value,int sensitive)
specifier|static
name|void
name|string_value_combo_set_item_sensitive
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|int
name|value
parameter_list|,
name|int
name|sensitive
parameter_list|)
block|{
name|GtkTreeIter
name|iter
decl_stmt|;
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|int
name|val
decl_stmt|;
name|model
operator|=
name|gtk_combo_box_get_model
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_tree_model_get_iter_first
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
do|do
block|{
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|COMBO_VALUE
argument_list|,
operator|&
name|val
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|value
condition|)
block|{
name|gtk_list_store_set
argument_list|(
name|GTK_LIST_STORE
argument_list|(
name|model
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|,
name|COMBO_SENSITIVE
argument_list|,
name|sensitive
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
name|gtk_tree_model_iter_next
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
do|;
block|}
end_function

begin_function
DECL|function|string_value_combo_set_active (GtkWidget * widget,int value)
specifier|static
name|void
name|string_value_combo_set_active
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|GtkTreeIter
name|iter
decl_stmt|;
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|int
name|val
decl_stmt|;
name|model
operator|=
name|gtk_combo_box_get_model
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_tree_model_get_iter_first
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
do|do
block|{
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|COMBO_VALUE
argument_list|,
operator|&
name|val
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|value
condition|)
block|{
name|gtk_combo_box_set_active_iter
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
name|gtk_tree_model_iter_next
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
do|;
block|}
end_function

begin_function
DECL|function|save_dialog_response (GtkWidget * widget,gint response_id,gpointer data)
specifier|static
name|void
name|save_dialog_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
switch|switch
condition|(
name|response_id
condition|)
block|{
case|case
name|GTK_RESPONSE_OK
case|:
name|runme
operator|=
literal|1
expr_stmt|;
default|default:
name|gtk_widget_destroy
argument_list|(
name|widget
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
DECL|function|compression_selected (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|compression_selected
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkTreeIter
name|iter
decl_stmt|;
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|model
operator|=
name|gtk_combo_box_get_model
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_combo_box_get_active_iter
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|COMBO_VALUE
argument_list|,
operator|&
name|dds_write_vals
operator|.
name|compression
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|format_opt
argument_list|,
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|pm_chk
argument_list|,
name|dds_write_vals
operator|.
name|compression
operator|!=
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|savetype_selected (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|savetype_selected
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gint32
name|image_id
init|=
operator|*
operator|(
operator|(
name|gint32
operator|*
operator|)
name|data
operator|)
decl_stmt|;
name|dds_write_vals
operator|.
name|savetype
operator|=
name|gtk_combo_box_get_active
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dds_write_vals
operator|.
name|savetype
condition|)
block|{
case|case
name|DDS_SAVE_SELECTED_LAYER
case|:
case|case
name|DDS_SAVE_CUBEMAP
case|:
case|case
name|DDS_SAVE_ARRAY
case|:
name|gtk_widget_set_sensitive
argument_list|(
name|compress_opt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDS_SAVE_VOLUMEMAP
case|:
name|dds_write_vals
operator|.
name|compression
operator|=
name|DDS_COMPRESS_NONE
expr_stmt|;
name|gtk_combo_box_set_active
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|compress_opt
argument_list|)
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|compress_opt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|string_value_combo_set_item_sensitive
argument_list|(
name|mipmap_opt
argument_list|,
name|DDS_MIPMAP_EXISTING
argument_list|,
name|check_mipmaps
argument_list|(
name|image_id
argument_list|,
name|dds_write_vals
operator|.
name|savetype
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|mipmaps_selected (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|mipmaps_selected
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkTreeIter
name|iter
decl_stmt|;
name|GtkTreeModel
modifier|*
name|model
decl_stmt|;
name|model
operator|=
name|gtk_combo_box_get_model
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_combo_box_get_active_iter
argument_list|(
name|GTK_COMBO_BOX
argument_list|(
name|widget
argument_list|)
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|gtk_tree_model_get
argument_list|(
name|model
argument_list|,
operator|&
name|iter
argument_list|,
name|COMBO_VALUE
argument_list|,
operator|&
name|dds_write_vals
operator|.
name|mipmaps
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|mipmap_filter_opt
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|mipmap_wrap_opt
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_chk
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|srgb_chk
argument_list|,
operator|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|dds_write_vals
operator|.
name|gamma_correct
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_spin
argument_list|,
operator|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|dds_write_vals
operator|.
name|gamma_correct
operator|&&
operator|!
name|dds_write_vals
operator|.
name|srgb
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|alpha_coverage_chk
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|alpha_test_threshold_spin
argument_list|,
operator|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|dds_write_vals
operator|.
name|preserve_alpha_coverage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|toggle_clicked (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|toggle_clicked
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
modifier|*
name|flag
init|=
operator|(
name|int
operator|*
operator|)
name|data
decl_stmt|;
operator|(
operator|*
name|flag
operator|)
operator|=
operator|!
operator|(
operator|*
name|flag
operator|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|transindex_clicked (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|transindex_clicked
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|spin
init|=
name|GTK_WIDGET
argument_list|(
name|g_object_get_data
argument_list|(
name|G_OBJECT
argument_list|(
name|widget
argument_list|)
argument_list|,
literal|"spin"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|gtk_toggle_button_get_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
argument_list|)
condition|)
block|{
name|dds_write_vals
operator|.
name|transindex
operator|=
literal|0
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|spin
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_value
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spin
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gtk_widget_set_sensitive
argument_list|(
name|spin
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dds_write_vals
operator|.
name|transindex
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
DECL|function|transindex_changed (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|transindex_changed
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|dds_write_vals
operator|.
name|transindex
operator|=
name|gtk_spin_button_get_value_as_int
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|adv_opt_expanded (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|adv_opt_expanded
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|dds_write_vals
operator|.
name|show_adv_opt
operator|=
operator|!
name|gtk_expander_get_expanded
argument_list|(
name|GTK_EXPANDER
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gamma_correct_clicked (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|gamma_correct_clicked
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|dds_write_vals
operator|.
name|gamma_correct
operator|=
name|gtk_toggle_button_get_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|srgb_chk
argument_list|,
name|dds_write_vals
operator|.
name|gamma_correct
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_spin
argument_list|,
name|dds_write_vals
operator|.
name|gamma_correct
operator|&&
operator|!
name|dds_write_vals
operator|.
name|srgb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|srgb_clicked (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|srgb_clicked
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|dds_write_vals
operator|.
name|srgb
operator|=
name|gtk_toggle_button_get_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_spin
argument_list|,
operator|!
name|dds_write_vals
operator|.
name|srgb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|gamma_changed (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|gamma_changed
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|dds_write_vals
operator|.
name|gamma
operator|=
name|gtk_spin_button_get_value
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|alpha_coverage_clicked (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|alpha_coverage_clicked
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|dds_write_vals
operator|.
name|preserve_alpha_coverage
operator|=
name|gtk_toggle_button_get_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|alpha_test_threshold_spin
argument_list|,
name|dds_write_vals
operator|.
name|preserve_alpha_coverage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|alpha_test_threshold_changed (GtkWidget * widget,gpointer data)
specifier|static
name|void
name|alpha_test_threshold_changed
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|dds_write_vals
operator|.
name|alpha_test_threshold
operator|=
name|gtk_spin_button_get_value
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|widget
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|save_dialog (gint32 image_id,gint32 drawable_id)
specifier|static
name|gint
name|save_dialog
parameter_list|(
name|gint32
name|image_id
parameter_list|,
name|gint32
name|drawable_id
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|,
modifier|*
name|vbox2
decl_stmt|,
modifier|*
name|hbox
decl_stmt|;
name|GtkWidget
modifier|*
name|table
decl_stmt|;
name|GtkWidget
modifier|*
name|label
decl_stmt|;
name|GtkWidget
modifier|*
name|opt
decl_stmt|;
name|GtkWidget
modifier|*
name|check
decl_stmt|;
name|GtkWidget
modifier|*
name|spin
decl_stmt|;
name|GtkWidget
modifier|*
name|expander
decl_stmt|;
name|GtkWidget
modifier|*
name|frame
decl_stmt|;
name|GimpImageBaseType
name|basetype
decl_stmt|;
if|if
condition|(
name|is_cubemap
operator|||
name|is_volume
operator|||
name|is_array
condition|)
name|dds_write_vals
operator|.
name|savetype
operator|=
name|DDS_SAVE_SELECTED_LAYER
expr_stmt|;
name|basetype
operator|=
name|gimp_image_base_type
argument_list|(
name|image_id
argument_list|)
expr_stmt|;
name|dlg
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Export as DDS"
argument_list|)
argument_list|,
literal|"dds"
argument_list|,
name|NULL
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|SAVE_PROC
argument_list|,
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|_
argument_list|(
literal|"OK"
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|save_dialog_response
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_main_quit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_window_set_resizable
argument_list|(
name|GTK_WINDOW
argument_list|(
name|dlg
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_box_new
argument_list|(
name|GTK_ORIENTATION_VERTICAL
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|vbox
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|4
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|table
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Compression:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|opt
operator|=
name|string_value_combo_new
argument_list|(
name|compression_strings
argument_list|,
name|dds_write_vals
operator|.
name|compression
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|opt
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
operator||
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|opt
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|compression_selected
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|compress_opt
operator|=
name|opt
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Format:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|opt
operator|=
name|string_value_combo_new
argument_list|(
name|format_strings
argument_list|,
name|dds_write_vals
operator|.
name|format
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|opt
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
operator||
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|opt
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|string_value_combo_selected
argument_list|)
argument_list|,
operator|&
name|dds_write_vals
operator|.
name|format
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|opt
argument_list|,
name|dds_write_vals
operator|.
name|compression
operator|==
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|format_opt
operator|=
name|opt
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Save:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|opt
operator|=
name|string_value_combo_new
argument_list|(
name|save_type_strings
argument_list|,
name|dds_write_vals
operator|.
name|savetype
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|opt
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
operator||
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|opt
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|savetype_selected
argument_list|)
argument_list|,
operator|&
name|image_id
argument_list|)
expr_stmt|;
name|string_value_combo_set_item_sensitive
argument_list|(
name|opt
argument_list|,
name|DDS_SAVE_CUBEMAP
argument_list|,
name|is_cubemap
argument_list|)
expr_stmt|;
name|string_value_combo_set_item_sensitive
argument_list|(
name|opt
argument_list|,
name|DDS_SAVE_VOLUMEMAP
argument_list|,
name|is_volume
argument_list|)
expr_stmt|;
name|string_value_combo_set_item_sensitive
argument_list|(
name|opt
argument_list|,
name|DDS_SAVE_ARRAY
argument_list|,
name|is_array
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Mipmaps:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|opt
operator|=
name|string_value_combo_new
argument_list|(
name|mipmap_strings
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|opt
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
operator||
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|opt
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|mipmaps_selected
argument_list|)
argument_list|,
operator|&
name|image_id
argument_list|)
expr_stmt|;
name|string_value_combo_set_item_sensitive
argument_list|(
name|opt
argument_list|,
name|DDS_MIPMAP_EXISTING
argument_list|,
name|check_mipmaps
argument_list|(
name|image_id
argument_list|,
name|dds_write_vals
operator|.
name|savetype
argument_list|)
argument_list|)
expr_stmt|;
name|mipmap_opt
operator|=
name|opt
expr_stmt|;
name|string_value_combo_set_item_sensitive
argument_list|(
name|opt
argument_list|,
name|DDS_MIPMAP_EXISTING
argument_list|,
operator|!
operator|(
name|is_volume
operator|||
name|is_cubemap
operator|)
operator|&&
name|is_mipmap_chain_valid
argument_list|)
expr_stmt|;
name|hbox
operator|=
name|gtk_box_new
argument_list|(
name|GTK_ORIENTATION_HORIZONTAL
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|hbox
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|hbox
argument_list|)
expr_stmt|;
name|check
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Transparent index:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|check
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|check
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|transindex_clicked
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
name|spin
operator|=
name|gtk_spin_button_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|gtk_adjustment_new
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|hbox
argument_list|)
argument_list|,
name|spin
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_update_policy
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spin
argument_list|)
argument_list|,
name|GTK_UPDATE_IF_VALID
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|spin
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|transindex_changed
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|spin
argument_list|)
expr_stmt|;
name|g_object_set_data
argument_list|(
name|G_OBJECT
argument_list|(
name|check
argument_list|)
argument_list|,
literal|"spin"
argument_list|,
name|spin
argument_list|)
expr_stmt|;
if|if
condition|(
name|basetype
operator|!=
name|GIMP_INDEXED
condition|)
block|{
name|gtk_widget_set_sensitive
argument_list|(
name|check
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|spin
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dds_write_vals
operator|.
name|transindex
operator|<
literal|0
condition|)
block|{
name|gtk_widget_set_sensitive
argument_list|(
name|spin
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dds_write_vals
operator|.
name|transindex
operator|>=
literal|0
condition|)
block|{
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|check
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_value
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spin
argument_list|)
argument_list|,
name|dds_write_vals
operator|.
name|transindex
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is_volume
operator|&&
name|dds_write_vals
operator|.
name|savetype
operator|==
name|DDS_SAVE_VOLUMEMAP
condition|)
block|{
name|dds_write_vals
operator|.
name|compression
operator|=
name|DDS_COMPRESS_NONE
expr_stmt|;
name|string_value_combo_set_active
argument_list|(
name|compress_opt
argument_list|,
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|compress_opt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|expander
operator|=
name|gtk_expander_new
argument_list|(
name|_
argument_list|(
literal|"<b>Advanced Options</b>"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_expander_set_use_markup
argument_list|(
name|GTK_EXPANDER
argument_list|(
name|expander
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_expander_set_expanded
argument_list|(
name|GTK_EXPANDER
argument_list|(
name|expander
argument_list|)
argument_list|,
name|dds_write_vals
operator|.
name|show_adv_opt
argument_list|)
expr_stmt|;
name|gtk_expander_set_spacing
argument_list|(
name|GTK_EXPANDER
argument_list|(
name|expander
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|expander
argument_list|,
literal|"activate"
argument_list|,
name|G_CALLBACK
argument_list|(
name|adv_opt_expanded
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|expander
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|expander
argument_list|)
expr_stmt|;
name|vbox2
operator|=
name|gtk_box_new
argument_list|(
name|GTK_ORIENTATION_VERTICAL
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|expander
argument_list|)
argument_list|,
name|vbox2
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox2
argument_list|)
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Compression"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|frame
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|check
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Use perceptual error metric"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|check
argument_list|)
argument_list|,
name|dds_write_vals
operator|.
name|perceptual_metric
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|check
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|check
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|toggle_clicked
argument_list|)
argument_list|,
operator|&
name|dds_write_vals
operator|.
name|perceptual_metric
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
name|pm_chk
operator|=
name|check
expr_stmt|;
name|frame
operator|=
name|gtk_frame_new
argument_list|(
name|_
argument_list|(
literal|"Mipmaps"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox2
argument_list|)
argument_list|,
name|frame
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|table
operator|=
name|gtk_table_new
argument_list|(
literal|7
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_table_set_row_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gtk_table_set_col_spacings
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|table
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_container_add
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|frame
argument_list|)
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Filter:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|opt
operator|=
name|string_value_combo_new
argument_list|(
name|mipmap_filter_strings
argument_list|,
name|dds_write_vals
operator|.
name|mipmap_filter
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|opt
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
operator||
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|opt
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|string_value_combo_selected
argument_list|)
argument_list|,
operator|&
name|dds_write_vals
operator|.
name|mipmap_filter
argument_list|)
expr_stmt|;
name|mipmap_filter_opt
operator|=
name|opt
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Wrap mode:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|opt
operator|=
name|string_value_combo_new
argument_list|(
name|mipmap_wrap_strings
argument_list|,
name|dds_write_vals
operator|.
name|mipmap_wrap
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|opt
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
operator||
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|opt
argument_list|,
literal|"changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|string_value_combo_selected
argument_list|)
argument_list|,
operator|&
name|dds_write_vals
operator|.
name|mipmap_wrap
argument_list|)
expr_stmt|;
name|mipmap_wrap_opt
operator|=
name|opt
expr_stmt|;
name|check
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Apply gamma correction"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|check
argument_list|)
argument_list|,
name|dds_write_vals
operator|.
name|gamma_correct
operator|&&
name|dds_write_vals
operator|.
name|mipmaps
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|check
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|check
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gamma_correct_clicked
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
name|gamma_chk
operator|=
name|check
expr_stmt|;
name|check
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Use sRGB colorspace"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|check
argument_list|)
argument_list|,
name|dds_write_vals
operator|.
name|gamma_correct
operator|&&
name|dds_write_vals
operator|.
name|srgb
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|check
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|check
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|srgb_clicked
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
name|srgb_chk
operator|=
name|check
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Gamma:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|spin
operator|=
name|gtk_spin_button_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|gtk_adjustment_new
argument_list|(
name|dds_write_vals
operator|.
name|gamma
argument_list|,
literal|1e-05
argument_list|,
literal|100
argument_list|,
literal|0.1
argument_list|,
literal|0.5
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|spin
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|4
argument_list|,
literal|5
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
operator||
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_update_policy
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spin
argument_list|)
argument_list|,
name|GTK_UPDATE_IF_VALID
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|spin
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gamma_changed
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|spin
argument_list|)
expr_stmt|;
name|gamma_spin
operator|=
name|spin
expr_stmt|;
name|check
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Preserve alpha test coverage"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|check
argument_list|)
argument_list|,
name|dds_write_vals
operator|.
name|preserve_alpha_coverage
operator|&&
name|dds_write_vals
operator|.
name|mipmaps
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|check
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|5
argument_list|,
literal|6
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|check
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|alpha_coverage_clicked
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
name|alpha_coverage_chk
operator|=
name|check
expr_stmt|;
name|label
operator|=
name|gtk_label_new
argument_list|(
name|_
argument_list|(
literal|"Alpha test threshold:"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|label
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|6
argument_list|,
literal|7
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_misc_set_alignment
argument_list|(
name|GTK_MISC
argument_list|(
name|label
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
name|spin
operator|=
name|gtk_spin_button_new
argument_list|(
name|GTK_ADJUSTMENT
argument_list|(
name|gtk_adjustment_new
argument_list|(
name|dds_write_vals
operator|.
name|alpha_test_threshold
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0.01
argument_list|,
literal|0.1
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gtk_table_attach
argument_list|(
name|GTK_TABLE
argument_list|(
name|table
argument_list|)
argument_list|,
name|spin
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|6
argument_list|,
literal|7
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
operator||
name|GTK_FILL
argument_list|)
argument_list|,
call|(
name|GtkAttachOptions
call|)
argument_list|(
name|GTK_EXPAND
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_spin_button_set_update_policy
argument_list|(
name|GTK_SPIN_BUTTON
argument_list|(
name|spin
argument_list|)
argument_list|,
name|GTK_UPDATE_IF_VALID
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|spin
argument_list|,
literal|"value_changed"
argument_list|,
name|G_CALLBACK
argument_list|(
name|alpha_test_threshold_changed
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|spin
argument_list|)
expr_stmt|;
name|alpha_test_threshold_spin
operator|=
name|spin
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|mipmap_filter_opt
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|mipmap_wrap_opt
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_chk
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|srgb_chk
argument_list|,
operator|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|dds_write_vals
operator|.
name|gamma_correct
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|gamma_spin
argument_list|,
operator|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|dds_write_vals
operator|.
name|gamma_correct
operator|&&
operator|!
name|dds_write_vals
operator|.
name|srgb
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|pm_chk
argument_list|,
name|dds_write_vals
operator|.
name|compression
operator|!=
name|DDS_COMPRESS_NONE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|alpha_coverage_chk
argument_list|,
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
argument_list|)
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|alpha_test_threshold_spin
argument_list|,
operator|(
name|dds_write_vals
operator|.
name|mipmaps
operator|==
name|DDS_MIPMAP_GENERATE
operator|)
operator|&&
name|dds_write_vals
operator|.
name|preserve_alpha_coverage
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|runme
operator|=
literal|0
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
return|return
operator|(
name|runme
operator|)
return|;
block|}
end_function

end_unit

