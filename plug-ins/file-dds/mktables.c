begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_function
DECL|function|mul8bit (int a,int b)
specifier|static
name|int
name|mul8bit
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|)
block|{
name|int
name|t
init|=
name|a
operator|*
name|b
operator|+
literal|128
decl_stmt|;
return|return
operator|(
operator|(
name|t
operator|+
operator|(
name|t
operator|>>
literal|8
operator|)
operator|)
operator|>>
literal|8
operator|)
return|;
block|}
end_function

begin_function
DECL|function|lerp13 (int a,int b)
specifier|static
name|int
name|lerp13
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|)
block|{
if|#
directive|if
literal|0
block|return(a + mul8bit(b - a, 0x55));
else|#
directive|else
return|return
operator|(
operator|(
literal|2
operator|*
name|a
operator|+
name|b
operator|)
operator|/
literal|3
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
DECL|function|prepare_opt_table (unsigned char * tab,const unsigned char * expand,int size)
specifier|static
name|void
name|prepare_opt_table
parameter_list|(
name|unsigned
name|char
modifier|*
name|tab
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|expand
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|mn
decl_stmt|,
name|mx
decl_stmt|,
name|bestE
decl_stmt|,
name|minE
decl_stmt|,
name|maxE
decl_stmt|,
name|e
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
operator|++
name|i
control|)
block|{
name|bestE
operator|=
literal|256
operator|*
literal|100
expr_stmt|;
for|for
control|(
name|mn
operator|=
literal|0
init|;
name|mn
operator|<
name|size
condition|;
operator|++
name|mn
control|)
block|{
for|for
control|(
name|mx
operator|=
literal|0
init|;
name|mx
operator|<
name|size
condition|;
operator|++
name|mx
control|)
block|{
name|minE
operator|=
name|expand
index|[
name|mn
index|]
expr_stmt|;
name|maxE
operator|=
name|expand
index|[
name|mx
index|]
expr_stmt|;
name|e
operator|=
name|abs
argument_list|(
name|lerp13
argument_list|(
name|maxE
argument_list|,
name|minE
argument_list|)
operator|-
name|i
argument_list|)
operator|*
literal|100
expr_stmt|;
name|e
operator|+=
name|abs
argument_list|(
name|mx
operator|-
name|mn
argument_list|)
operator|*
literal|3
expr_stmt|;
if|if
condition|(
name|e
operator|<
name|bestE
condition|)
block|{
name|tab
index|[
name|i
operator|*
literal|2
operator|+
literal|0
index|]
operator|=
name|mx
expr_stmt|;
name|tab
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|mn
expr_stmt|;
name|bestE
operator|=
name|e
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|int main(void) {    FILE *fp;    int i, v;    unsigned char expand5[32];    unsigned char expand6[64];    unsigned char quantRB[256 + 16];    unsigned char quantG[256 + 16];    unsigned char omatch5[256][2];    unsigned char omatch6[256][2];        fp = fopen("dxt_tables.h", "w");    fprintf(fp,            "#ifndef DXT_TABLES_H\n"            "#define DXT_TABLES_H\n\n");        for(i = 0; i< 32; ++i)       expand5[i] = (i<< 3) | (i>> 2);     for(i = 0; i< 64; ++i)       expand6[i] = (i<< 2) | (i>> 4);        for(i = 0; i< 256 + 16; ++i)    {       v = i - 8;       if(v< 0) v = 0;       if(v> 255) v = 255;       quantRB[i] = expand5[mul8bit(v, 31)];       quantG[i] = expand6[mul8bit(v, 63)];    }      fprintf(fp,            "static const unsigned char quantRB[256 + 16] =\n"            "{");    for(i = 0; i< 256 + 16; ++i)    {       if(i % 8 == 0) fprintf(fp, "\n   ");       fprintf(fp, "0x%02x, ", quantRB[i]);    }    fprintf(fp, "\n};\n\n");     fprintf(fp,            "static const unsigned char quantG[256 + 16] =\n"            "{");    for(i = 0; i< 256 + 16; ++i)    {       if(i % 8 == 0) fprintf(fp, "\n   ");       fprintf(fp, "0x%02x, ", quantG[i]);    }    fprintf(fp, "\n};\n\n");        prepare_opt_table(&omatch5[0][0], expand5, 32);    prepare_opt_table(&omatch6[0][0], expand6, 64);        fprintf(fp,            "static const unsigned char omatch5[256][2] =\n"            "{");    for(i = 0; i< 256; ++i)    {       if(i % 4 == 0) fprintf(fp, "\n   ");       fprintf(fp, "{0x%02x, 0x%02x}, ", omatch5[i][0], omatch5[i][1]);    }    fprintf(fp, "\n};\n\n");     fprintf(fp,            "static const unsigned char omatch6[256][2] =\n"            "{");    for(i = 0; i< 256; ++i)    {       if(i % 4 == 0) fprintf(fp, "\n   ");       fprintf(fp, "{0x%02x, 0x%02x}, ", omatch6[i][0], omatch6[i][1]);    }    fprintf(fp, "\n};\n\n");        fprintf(fp, "#endif\n");        fclose(fp);        return(0); }
endif|#
directive|endif
end_endif

end_unit

