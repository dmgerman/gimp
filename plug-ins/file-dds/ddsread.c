begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * DDS GIMP plugin  *  * Copyright (C) 2004-2012 Shawn Kirst<skirst@gmail.com>,  * with parts (C) 2003 Arne Reuter<homepage@arnereuter.de> where specified.  *  * This program is free software; you can redistribute it and/or  * modify it under the terms of the GNU General Public  * License as published by the Free Software Foundation; either  * version 2 of the License, or (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; see the file COPYING.  If not, write to  * the Free Software Foundation, 51 Franklin Street, Fifth Floor  * Boston, MA 02110-1301, USA.  */
end_comment

begin_comment
comment|/*  ** !!! COPYRIGHT NOTICE !!!  **  ** The following is based on code (C) 2003 Arne Reuter<homepage@arnereuter.de>  ** URL: http://www.dr-reuter.de/arne/dds.html  **  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<gtk/gtk.h>
end_include

begin_include
include|#
directive|include
file|<glib/gstdio.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/stdplugins-intl.h>
end_include

begin_include
include|#
directive|include
file|"ddsplugin.h"
end_include

begin_include
include|#
directive|include
file|"dds.h"
end_include

begin_include
include|#
directive|include
file|"dxt.h"
end_include

begin_include
include|#
directive|include
file|"endian.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_include
include|#
directive|include
file|"imath.h"
end_include

begin_typedef
typedef|typedef
struct|struct
DECL|struct|__anon29d301700108
block|{
DECL|member|rshift
DECL|member|gshift
DECL|member|bshift
DECL|member|ashift
name|unsigned
name|char
name|rshift
decl_stmt|,
name|gshift
decl_stmt|,
name|bshift
decl_stmt|,
name|ashift
decl_stmt|;
DECL|member|rbits
DECL|member|gbits
DECL|member|bbits
DECL|member|abits
name|unsigned
name|char
name|rbits
decl_stmt|,
name|gbits
decl_stmt|,
name|bbits
decl_stmt|,
name|abits
decl_stmt|;
DECL|member|rmask
DECL|member|gmask
DECL|member|bmask
DECL|member|amask
name|unsigned
name|int
name|rmask
decl_stmt|,
name|gmask
decl_stmt|,
name|bmask
decl_stmt|,
name|amask
decl_stmt|;
DECL|member|bpp
DECL|member|gimp_bpp
name|unsigned
name|int
name|bpp
decl_stmt|,
name|gimp_bpp
decl_stmt|;
DECL|member|tile_height
name|int
name|tile_height
decl_stmt|;
DECL|member|palette
name|unsigned
name|char
modifier|*
name|palette
decl_stmt|;
DECL|typedef|dds_load_info_t
block|}
name|dds_load_info_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|int
name|read_header
parameter_list|(
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|read_header_dx10
parameter_list|(
name|dds_header_dx10_t
modifier|*
name|hdr
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|validate_header
parameter_list|(
name|dds_header_t
modifier|*
name|hdr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|setup_dxgi_format
parameter_list|(
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|dds_header_dx10_t
modifier|*
name|dx10hdr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|load_layer
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|dds_load_info_t
modifier|*
name|d
parameter_list|,
name|gint32
name|image
parameter_list|,
name|unsigned
name|int
name|level
parameter_list|,
name|char
modifier|*
name|prefix
parameter_list|,
name|unsigned
name|int
modifier|*
name|l
parameter_list|,
name|guchar
modifier|*
name|pixels
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|load_mipmaps
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|dds_load_info_t
modifier|*
name|d
parameter_list|,
name|gint32
name|image
parameter_list|,
name|char
modifier|*
name|prefix
parameter_list|,
name|unsigned
name|int
modifier|*
name|l
parameter_list|,
name|guchar
modifier|*
name|pixels
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|load_face
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|dds_load_info_t
modifier|*
name|d
parameter_list|,
name|gint32
name|image
parameter_list|,
name|char
modifier|*
name|prefix
parameter_list|,
name|unsigned
name|int
modifier|*
name|l
parameter_list|,
name|guchar
modifier|*
name|pixels
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|unsigned
name|char
name|color_bits
parameter_list|(
name|unsigned
name|int
name|mask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|unsigned
name|char
name|color_shift
parameter_list|(
name|unsigned
name|int
name|mask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|load_dialog
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|runme
specifier|static
name|int
name|runme
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|GimpPDBStatusType
DECL|function|read_dds (gchar * filename,gint32 * imageID,gboolean interactive_dds)
name|read_dds
parameter_list|(
name|gchar
modifier|*
name|filename
parameter_list|,
name|gint32
modifier|*
name|imageID
parameter_list|,
name|gboolean
name|interactive_dds
parameter_list|)
block|{
name|gint32
name|image
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|unsigned
name|int
name|l
init|=
literal|0
decl_stmt|;
name|guchar
modifier|*
name|pixels
decl_stmt|;
name|gchar
modifier|*
name|tmp
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|dds_header_t
name|hdr
decl_stmt|;
name|dds_header_dx10_t
name|dx10hdr
decl_stmt|;
name|dds_load_info_t
name|d
decl_stmt|;
name|gint
modifier|*
name|layers
decl_stmt|,
name|layer_count
decl_stmt|;
name|GimpImageBaseType
name|type
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|interactive_dds
condition|)
block|{
if|if
condition|(
operator|!
name|load_dialog
argument_list|()
condition|)
return|return
operator|(
name|GIMP_PDB_CANCEL
operator|)
return|;
block|}
name|fp
operator|=
name|g_fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
literal|0
condition|)
block|{
name|g_message
argument_list|(
literal|"Error opening file.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
condition|)
name|tmp
operator|=
name|g_strdup_printf
argument_list|(
literal|"Loading %s:"
argument_list|,
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|tmp
operator|=
name|g_strdup_printf
argument_list|(
literal|"Loading %s:"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|gimp_progress_init
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
comment|/* read header */
name|read_header
argument_list|(
operator|&
name|hdr
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|dx10hdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dds_header_dx10_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* read DX10 header if necessary */
if|if
condition|(
name|GETL32
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|fourcc
argument_list|)
operator|==
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'1'
argument_list|,
literal|'0'
argument_list|)
condition|)
block|{
name|read_header_dx10
argument_list|(
operator|&
name|dx10hdr
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|setup_dxgi_format
argument_list|(
operator|&
name|hdr
argument_list|,
operator|&
name|dx10hdr
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
block|}
if|if
condition|(
operator|!
name|validate_header
argument_list|(
operator|&
name|hdr
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|g_message
argument_list|(
literal|"Invalid DDS header!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
comment|/* a lot of DDS images out there don't have this for some reason -_- */
if|if
condition|(
name|hdr
operator|.
name|pitch_or_linsize
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_FOURCC
condition|)
comment|/* assume linear size */
block|{
name|hdr
operator|.
name|pitch_or_linsize
operator|=
operator|(
operator|(
name|hdr
operator|.
name|width
operator|+
literal|3
operator|)
operator|>>
literal|2
operator|)
operator|*
operator|(
operator|(
name|hdr
operator|.
name|height
operator|+
literal|3
operator|)
operator|>>
literal|2
operator|)
expr_stmt|;
switch|switch
condition|(
name|GETL32
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|fourcc
argument_list|)
condition|)
block|{
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'1'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'1'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'U'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'S'
argument_list|)
case|:
name|hdr
operator|.
name|pitch_or_linsize
operator|*=
literal|8
expr_stmt|;
break|break;
default|default:
name|hdr
operator|.
name|pitch_or_linsize
operator|*=
literal|16
expr_stmt|;
break|break;
block|}
block|}
else|else
comment|/* assume pitch */
block|{
name|hdr
operator|.
name|pitch_or_linsize
operator|=
name|hdr
operator|.
name|height
operator|*
name|hdr
operator|.
name|width
operator|*
operator|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|bpp
operator|>>
literal|3
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_FOURCC
condition|)
block|{
comment|/* fourcc is dXt* or rXgb */
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|fourcc
index|[
literal|1
index|]
operator|==
literal|'X'
condition|)
name|hdr
operator|.
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_ALPHAPIXELS
expr_stmt|;
block|}
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_FOURCC
condition|)
block|{
switch|switch
condition|(
name|GETL32
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|fourcc
argument_list|)
condition|)
block|{
case|case
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'1'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'U'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'S'
argument_list|)
case|:
name|d
operator|.
name|bpp
operator|=
name|d
operator|.
name|gimp_bpp
operator|=
literal|1
expr_stmt|;
name|type
operator|=
name|GIMP_GRAY
expr_stmt|;
break|break;
case|case
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'2'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'U'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'S'
argument_list|)
case|:
name|d
operator|.
name|bpp
operator|=
name|d
operator|.
name|gimp_bpp
operator|=
literal|3
expr_stmt|;
name|type
operator|=
name|GIMP_RGB
expr_stmt|;
break|break;
default|default:
name|d
operator|.
name|bpp
operator|=
name|d
operator|.
name|gimp_bpp
operator|=
literal|4
expr_stmt|;
name|type
operator|=
name|GIMP_RGB
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|d
operator|.
name|bpp
operator|=
name|hdr
operator|.
name|pixelfmt
operator|.
name|bpp
operator|>>
literal|3
expr_stmt|;
if|if
condition|(
name|d
operator|.
name|bpp
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|amask
operator|==
literal|0xf000
condition|)
comment|// RGBA4
block|{
name|d
operator|.
name|gimp_bpp
operator|=
literal|4
expr_stmt|;
name|type
operator|=
name|GIMP_RGB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|amask
operator|==
literal|0xff00
condition|)
comment|//L8A8
block|{
name|d
operator|.
name|gimp_bpp
operator|=
literal|2
expr_stmt|;
name|type
operator|=
name|GIMP_GRAY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|bmask
operator|==
literal|0x1f
condition|)
comment|//R5G6B5 or RGB5A1
block|{
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|amask
operator|==
literal|0x8000
condition|)
comment|// RGB5A1
name|d
operator|.
name|gimp_bpp
operator|=
literal|4
expr_stmt|;
else|else
name|d
operator|.
name|gimp_bpp
operator|=
literal|3
expr_stmt|;
name|type
operator|=
name|GIMP_RGB
expr_stmt|;
block|}
else|else
comment|//L16
block|{
name|d
operator|.
name|gimp_bpp
operator|=
literal|1
expr_stmt|;
name|type
operator|=
name|GIMP_GRAY
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_PALETTEINDEXED8
condition|)
block|{
name|type
operator|=
name|GIMP_INDEXED
expr_stmt|;
name|d
operator|.
name|gimp_bpp
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|rmask
operator|==
literal|0xe0
condition|)
comment|// R3G3B2
block|{
name|type
operator|=
name|GIMP_RGB
expr_stmt|;
name|d
operator|.
name|gimp_bpp
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
comment|/* test alpha only image */
if|if
condition|(
name|d
operator|.
name|bpp
operator|==
literal|1
operator|&&
operator|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_ALPHA
operator|)
condition|)
block|{
name|d
operator|.
name|gimp_bpp
operator|=
literal|2
expr_stmt|;
name|type
operator|=
name|GIMP_GRAY
expr_stmt|;
block|}
else|else
block|{
name|d
operator|.
name|gimp_bpp
operator|=
name|d
operator|.
name|bpp
expr_stmt|;
name|type
operator|=
operator|(
name|d
operator|.
name|bpp
operator|==
literal|1
operator|)
condition|?
name|GIMP_GRAY
else|:
name|GIMP_RGB
expr_stmt|;
block|}
block|}
block|}
block|}
name|image
operator|=
name|gimp_image_new
argument_list|(
name|hdr
operator|.
name|width
argument_list|,
name|hdr
operator|.
name|height
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|image
operator|==
operator|-
literal|1
condition|)
block|{
name|g_message
argument_list|(
literal|"Can't allocate new image.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
name|gimp_image_set_filename
argument_list|(
name|image
argument_list|,
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_PALETTEINDEXED8
condition|)
block|{
name|d
operator|.
name|palette
operator|=
name|g_malloc
argument_list|(
literal|256
operator|*
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|d
operator|.
name|palette
argument_list|,
literal|1
argument_list|,
literal|1024
argument_list|,
name|fp
argument_list|)
operator|!=
literal|1024
condition|)
block|{
name|g_message
argument_list|(
literal|"Error reading palette.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|768
condition|;
name|i
operator|+=
literal|3
operator|,
name|j
operator|+=
literal|4
control|)
block|{
name|d
operator|.
name|palette
index|[
name|i
operator|+
literal|0
index|]
operator|=
name|d
operator|.
name|palette
index|[
name|j
operator|+
literal|0
index|]
expr_stmt|;
name|d
operator|.
name|palette
index|[
name|i
operator|+
literal|1
index|]
operator|=
name|d
operator|.
name|palette
index|[
name|j
operator|+
literal|1
index|]
expr_stmt|;
name|d
operator|.
name|palette
index|[
name|i
operator|+
literal|2
index|]
operator|=
name|d
operator|.
name|palette
index|[
name|j
operator|+
literal|2
index|]
expr_stmt|;
block|}
name|gimp_image_set_colormap
argument_list|(
name|image
argument_list|,
name|d
operator|.
name|palette
argument_list|,
literal|256
argument_list|)
expr_stmt|;
block|}
name|d
operator|.
name|tile_height
operator|=
name|gimp_tile_height
argument_list|()
expr_stmt|;
name|pixels
operator|=
name|g_new
argument_list|(
name|guchar
argument_list|,
name|d
operator|.
name|tile_height
operator|*
name|hdr
operator|.
name|width
operator|*
name|d
operator|.
name|gimp_bpp
argument_list|)
expr_stmt|;
name|buf
operator|=
name|g_malloc
argument_list|(
name|hdr
operator|.
name|pitch_or_linsize
argument_list|)
expr_stmt|;
name|d
operator|.
name|rshift
operator|=
name|color_shift
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|rmask
argument_list|)
expr_stmt|;
name|d
operator|.
name|gshift
operator|=
name|color_shift
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|gmask
argument_list|)
expr_stmt|;
name|d
operator|.
name|bshift
operator|=
name|color_shift
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|bmask
argument_list|)
expr_stmt|;
name|d
operator|.
name|ashift
operator|=
name|color_shift
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|amask
argument_list|)
expr_stmt|;
name|d
operator|.
name|rbits
operator|=
name|color_bits
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|rmask
argument_list|)
expr_stmt|;
name|d
operator|.
name|gbits
operator|=
name|color_bits
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|gmask
argument_list|)
expr_stmt|;
name|d
operator|.
name|bbits
operator|=
name|color_bits
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|bmask
argument_list|)
expr_stmt|;
name|d
operator|.
name|abits
operator|=
name|color_bits
argument_list|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|amask
argument_list|)
expr_stmt|;
name|d
operator|.
name|rmask
operator|=
operator|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|rmask
operator|>>
name|d
operator|.
name|rshift
operator|)
operator|<<
operator|(
literal|8
operator|-
name|d
operator|.
name|rbits
operator|)
expr_stmt|;
name|d
operator|.
name|gmask
operator|=
operator|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|gmask
operator|>>
name|d
operator|.
name|gshift
operator|)
operator|<<
operator|(
literal|8
operator|-
name|d
operator|.
name|gbits
operator|)
expr_stmt|;
name|d
operator|.
name|bmask
operator|=
operator|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|bmask
operator|>>
name|d
operator|.
name|bshift
operator|)
operator|<<
operator|(
literal|8
operator|-
name|d
operator|.
name|bbits
operator|)
expr_stmt|;
name|d
operator|.
name|amask
operator|=
operator|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|amask
operator|>>
name|d
operator|.
name|ashift
operator|)
operator|<<
operator|(
literal|8
operator|-
name|d
operator|.
name|abits
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_CUBEMAP
operator|)
operator|&&
operator|!
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_VOLUME
operator|)
operator|&&
name|dx10hdr
operator|.
name|arraySize
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|load_layer
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|load_mipmaps
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|""
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_CUBEMAP
condition|)
block|{
if|if
condition|(
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_CUBEMAP_POSITIVEX
operator|)
operator|&&
operator|!
name|load_face
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|"(positive x)"
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_CUBEMAP_NEGATIVEX
operator|)
operator|&&
operator|!
name|load_face
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|"(negative x)"
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_CUBEMAP_POSITIVEY
operator|)
operator|&&
operator|!
name|load_face
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|"(positive y)"
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_CUBEMAP_NEGATIVEY
operator|)
operator|&&
operator|!
name|load_face
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|"(negative y)"
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_CUBEMAP_POSITIVEZ
operator|)
operator|&&
operator|!
name|load_face
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|"(positive z)"
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_CUBEMAP_NEGATIVEZ
operator|)
operator|&&
operator|!
name|load_face
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|"(negative z)"
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps2
operator|&
name|DDSCAPS2_VOLUME
operator|)
operator|&&
operator|(
name|hdr
operator|.
name|flags
operator|&
name|DDSD_DEPTH
operator|)
condition|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|level
decl_stmt|;
name|char
modifier|*
name|plane
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hdr
operator|.
name|depth
condition|;
operator|++
name|i
control|)
block|{
name|plane
operator|=
name|g_strdup_printf
argument_list|(
literal|"(z = %d)"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|load_layer
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|0
argument_list|,
name|plane
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|g_free
argument_list|(
name|plane
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
name|g_free
argument_list|(
name|plane
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|.
name|flags
operator|&
name|DDSD_MIPMAPCOUNT
operator|)
operator|&&
operator|(
name|hdr
operator|.
name|caps
operator|.
name|caps1
operator|&
name|DDSCAPS_MIPMAP
operator|)
operator|&&
operator|(
name|dds_read_vals
operator|.
name|mipmaps
operator|!=
literal|0
operator|)
condition|)
block|{
for|for
control|(
name|level
operator|=
literal|1
init|;
name|level
operator|<
name|hdr
operator|.
name|num_mipmaps
condition|;
operator|++
name|level
control|)
block|{
name|int
name|n
init|=
name|hdr
operator|.
name|depth
operator|>>
name|level
decl_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
name|plane
operator|=
name|g_strdup_printf
argument_list|(
literal|"(z = %d)"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|load_layer
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
name|level
argument_list|,
name|plane
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|g_free
argument_list|(
name|plane
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
name|g_free
argument_list|(
name|plane
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|dx10hdr
operator|.
name|arraySize
operator|>
literal|0
condition|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|elem
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dx10hdr
operator|.
name|arraySize
condition|;
operator|++
name|i
control|)
block|{
name|elem
operator|=
name|g_strdup_printf
argument_list|(
literal|"(array element %d)"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|load_layer
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
literal|0
argument_list|,
name|elem
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|load_mipmaps
argument_list|(
name|fp
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|d
argument_list|,
name|image
argument_list|,
name|elem
argument_list|,
operator|&
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|gimp_image_delete
argument_list|(
name|image
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
name|g_free
argument_list|(
name|elem
argument_list|)
expr_stmt|;
block|}
block|}
name|gimp_progress_update
argument_list|(
literal|1.0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_PALETTEINDEXED8
condition|)
name|g_free
argument_list|(
name|d
operator|.
name|palette
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|pixels
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|layers
operator|=
name|gimp_image_get_layers
argument_list|(
name|image
argument_list|,
operator|&
name|layer_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|layers
operator|==
name|NULL
operator|||
name|layer_count
operator|==
literal|0
condition|)
block|{
name|g_message
argument_list|(
literal|"Oops!  NULL image read!  Please report this!"
argument_list|)
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_EXECUTION_ERROR
operator|)
return|;
block|}
name|gimp_image_set_active_layer
argument_list|(
name|image
argument_list|,
name|layers
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|layers
argument_list|)
expr_stmt|;
operator|*
name|imageID
operator|=
name|image
expr_stmt|;
return|return
operator|(
name|GIMP_PDB_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|read_header (dds_header_t * hdr,FILE * fp)
name|read_header
parameter_list|(
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
name|DDS_HEADERSIZE
index|]
decl_stmt|;
name|memset
argument_list|(
name|hdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dds_header_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|DDS_HEADERSIZE
argument_list|,
name|fp
argument_list|)
operator|!=
name|DDS_HEADERSIZE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|hdr
operator|->
name|magic
operator|=
name|GETL32
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|size
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|flags
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|height
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|width
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|16
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|pitch_or_linsize
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|20
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|depth
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|24
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|num_mipmaps
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|28
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|size
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|76
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|80
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
index|[
literal|0
index|]
operator|=
name|buf
index|[
literal|84
index|]
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
index|[
literal|1
index|]
operator|=
name|buf
index|[
literal|85
index|]
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
index|[
literal|2
index|]
operator|=
name|buf
index|[
literal|86
index|]
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
index|[
literal|3
index|]
operator|=
name|buf
index|[
literal|87
index|]
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|88
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|92
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|96
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|100
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|104
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|caps
operator|.
name|caps1
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|108
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|caps
operator|.
name|caps2
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|112
argument_list|)
expr_stmt|;
comment|/* GIMP-DDS special info */
if|if
condition|(
name|GETL32
argument_list|(
name|buf
operator|+
literal|32
argument_list|)
operator|==
name|FOURCC
argument_list|(
literal|'G'
argument_list|,
literal|'I'
argument_list|,
literal|'M'
argument_list|,
literal|'P'
argument_list|)
operator|&&
name|GETL32
argument_list|(
name|buf
operator|+
literal|36
argument_list|)
operator|==
name|FOURCC
argument_list|(
literal|'-'
argument_list|,
literal|'D'
argument_list|,
literal|'D'
argument_list|,
literal|'S'
argument_list|)
condition|)
block|{
name|hdr
operator|->
name|reserved
operator|.
name|gimp_dds_special
operator|.
name|magic1
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|32
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|reserved
operator|.
name|gimp_dds_special
operator|.
name|magic2
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|36
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|reserved
operator|.
name|gimp_dds_special
operator|.
name|version
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|40
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|reserved
operator|.
name|gimp_dds_special
operator|.
name|extra_fourcc
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|44
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|read_header_dx10 (dds_header_dx10_t * hdr,FILE * fp)
name|read_header_dx10
parameter_list|(
name|dds_header_dx10_t
modifier|*
name|hdr
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|char
name|buf
index|[
name|DDS_HEADERSIZE_DX10
index|]
decl_stmt|;
name|memset
argument_list|(
name|hdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dds_header_dx10_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|DDS_HEADERSIZE_DX10
argument_list|,
name|fp
argument_list|)
operator|!=
name|DDS_HEADERSIZE_DX10
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|hdr
operator|->
name|dxgiFormat
operator|=
name|GETL32
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|resourceDimension
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|miscFlag
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|arraySize
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|reserved
operator|=
name|GETL32
argument_list|(
name|buf
operator|+
literal|16
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|validate_header (dds_header_t * hdr)
name|validate_header
parameter_list|(
name|dds_header_t
modifier|*
name|hdr
parameter_list|)
block|{
name|unsigned
name|int
name|fourcc
decl_stmt|;
if|if
condition|(
name|hdr
operator|->
name|magic
operator|!=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'D'
argument_list|,
literal|'S'
argument_list|,
literal|' '
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Invalid DDS file.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|->
name|flags
operator|&
name|DDSD_PITCH
operator|)
operator|==
operator|(
name|hdr
operator|->
name|flags
operator|&
name|DDSD_LINEARSIZE
operator|)
condition|)
block|{
comment|//g_message ("Warning: DDSD_PITCH or DDSD_LINEARSIZE is not set.\n");
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_FOURCC
condition|)
name|hdr
operator|->
name|flags
operator||=
name|DDSD_LINEARSIZE
expr_stmt|;
else|else
name|hdr
operator|->
name|flags
operator||=
name|DDSD_PITCH
expr_stmt|;
block|}
comment|/*      if ((hdr->pixelfmt.flags& DDPF_FOURCC) ==      (hdr->pixelfmt.flags& DDPF_RGB))      {      g_message ("Invalid pixel format.\n");      return (0);      }      */
name|fourcc
operator|=
name|GETL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_FOURCC
operator|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'1'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'2'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'3'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'4'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'5'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'R'
argument_list|,
literal|'X'
argument_list|,
literal|'G'
argument_list|,
literal|'B'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'1'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'U'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'S'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'2'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'U'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'S'
argument_list|)
operator|&&
name|fourcc
operator|!=
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'1'
argument_list|,
literal|'0'
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Unsupported format (FOURCC: %c%c%c%c, hex: %08x).\n"
argument_list|,
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
index|[
literal|0
index|]
argument_list|,
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
index|[
literal|1
index|]
argument_list|,
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
index|[
literal|2
index|]
argument_list|,
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
index|[
literal|3
index|]
argument_list|,
name|GETL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_RGB
condition|)
block|{
if|if
condition|(
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|!=
literal|8
operator|)
operator|&&
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|!=
literal|16
operator|)
operator|&&
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|!=
literal|24
operator|)
operator|&&
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|!=
literal|32
operator|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Invalid BPP.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_LUMINANCE
condition|)
block|{
if|if
condition|(
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|!=
literal|8
operator|)
operator|&&
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|!=
literal|16
operator|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Invalid BPP.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_RGB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_PALETTEINDEXED8
condition|)
block|{
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_RGB
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_RGB
operator|)
operator|&&
operator|!
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_ALPHA
operator|)
operator|&&
operator|!
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_FOURCC
operator|)
operator|&&
operator|!
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_LUMINANCE
operator|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Unknown pixel format!  Taking a guess, expect trouble!"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fourcc
condition|)
block|{
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'1'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'2'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'3'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'4'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'5'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'R'
argument_list|,
literal|'X'
argument_list|,
literal|'G'
argument_list|,
literal|'B'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'1'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'U'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'S'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'2'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'U'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'S'
argument_list|)
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_FOURCC
expr_stmt|;
break|break;
default|default:
switch|switch
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
condition|)
block|{
case|case
literal|8
case|:
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_ALPHAPIXELS
condition|)
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_ALPHA
expr_stmt|;
else|else
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_LUMINANCE
expr_stmt|;
break|break;
case|case
literal|16
case|:
case|case
literal|24
case|:
case|case
literal|32
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_RGB
expr_stmt|;
break|break;
default|default:
name|g_message
argument_list|(
literal|"Invalid pixel format."
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
break|break;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This function will set the necessary flags and attributes in the standard  * dds header using the information found in the DX10 header.  */
end_comment

begin_function
specifier|static
name|int
DECL|function|setup_dxgi_format (dds_header_t * hdr,dds_header_dx10_t * dx10hdr)
name|setup_dxgi_format
parameter_list|(
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|dds_header_dx10_t
modifier|*
name|dx10hdr
parameter_list|)
block|{
if|if
condition|(
operator|(
name|dx10hdr
operator|->
name|resourceDimension
operator|==
name|D3D10_RESOURCE_DIMENSION_TEXTURE2D
operator|)
operator|&&
operator|(
name|dx10hdr
operator|->
name|miscFlag
operator|&
name|D3D10_RESOURCE_MISC_TEXTURECUBE
operator|)
condition|)
block|{
name|hdr
operator|->
name|caps
operator|.
name|caps2
operator||=
name|DDSCAPS2_CUBEMAP
operator||
name|DDSCAPS2_CUBEMAP_ALL_FACES
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dx10hdr
operator|->
name|resourceDimension
operator|==
name|D3D10_RESOURCE_DIMENSION_TEXTURE3D
condition|)
block|{
name|hdr
operator|->
name|flags
operator||=
name|DDSD_DEPTH
expr_stmt|;
name|hdr
operator|->
name|caps
operator|.
name|caps2
operator||=
name|DDSCAPS2_VOLUME
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dx10hdr
operator|->
name|resourceDimension
operator|!=
name|D3D10_RESOURCE_DIMENSION_TEXTURE1D
operator|)
operator|&&
operator|(
name|dx10hdr
operator|->
name|resourceDimension
operator|!=
name|D3D10_RESOURCE_DIMENSION_TEXTURE2D
operator|)
operator|&&
operator|(
name|dx10hdr
operator|->
name|resourceDimension
operator|!=
name|D3D10_RESOURCE_DIMENSION_TEXTURE3D
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|// check for a compressed DXGI format
if|if
condition|(
operator|(
name|dx10hdr
operator|->
name|dxgiFormat
operator|>=
name|DXGI_FORMAT_BC1_TYPELESS
operator|)
operator|&&
operator|(
name|dx10hdr
operator|->
name|dxgiFormat
operator|<=
name|DXGI_FORMAT_BC5_SNORM
operator|)
condition|)
block|{
comment|// set flag and replace FOURCC
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_FOURCC
expr_stmt|;
switch|switch
condition|(
name|dx10hdr
operator|->
name|dxgiFormat
condition|)
block|{
case|case
name|DXGI_FORMAT_BC1_TYPELESS
case|:
case|case
name|DXGI_FORMAT_BC1_UNORM
case|:
case|case
name|DXGI_FORMAT_BC1_UNORM_SRGB
case|:
name|PUTL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|,
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'1'
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_BC2_TYPELESS
case|:
case|case
name|DXGI_FORMAT_BC2_UNORM
case|:
case|case
name|DXGI_FORMAT_BC2_UNORM_SRGB
case|:
name|PUTL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|,
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'3'
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_BC3_TYPELESS
case|:
case|case
name|DXGI_FORMAT_BC3_UNORM
case|:
case|case
name|DXGI_FORMAT_BC3_UNORM_SRGB
case|:
name|PUTL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|,
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'5'
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_BC4_TYPELESS
case|:
case|case
name|DXGI_FORMAT_BC4_UNORM
case|:
name|PUTL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|,
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'1'
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_BC4_SNORM
case|:
name|PUTL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|,
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'S'
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_BC5_TYPELESS
case|:
case|case
name|DXGI_FORMAT_BC5_UNORM
case|:
name|PUTL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|,
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'2'
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_BC5_SNORM
case|:
name|PUTL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|,
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'S'
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
comment|/* unset the FOURCC flag */
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&=
operator|~
name|DDPF_FOURCC
expr_stmt|;
switch|switch
condition|(
name|dx10hdr
operator|->
name|dxgiFormat
condition|)
block|{
case|case
name|DXGI_FORMAT_B8G8R8A8_TYPELESS
case|:
case|case
name|DXGI_FORMAT_B8G8R8A8_UNORM
case|:
case|case
name|DXGI_FORMAT_B8G8R8A8_UNORM_SRGB
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|32
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_ALPHAPIXELS
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
literal|0x00ff0000
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
literal|0x0000ff00
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
literal|0x000000ff
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0xff000000
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_B8G8R8X8_TYPELESS
case|:
case|case
name|DXGI_FORMAT_B8G8R8X8_UNORM
case|:
case|case
name|DXGI_FORMAT_B8G8R8X8_UNORM_SRGB
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|32
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_ALPHAPIXELS
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
literal|0x00ff0000
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
literal|0x0000ff00
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
literal|0x000000ff
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0x00000000
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_R8G8B8A8_TYPELESS
case|:
case|case
name|DXGI_FORMAT_R8G8B8A8_UNORM
case|:
case|case
name|DXGI_FORMAT_R8G8B8A8_UNORM_SRGB
case|:
case|case
name|DXGI_FORMAT_R8G8B8A8_UINT
case|:
case|case
name|DXGI_FORMAT_R8G8B8A8_SNORM
case|:
case|case
name|DXGI_FORMAT_R8G8B8A8_SINT
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|32
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_ALPHAPIXELS
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
literal|0x000000ff
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
literal|0x0000ff00
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
literal|0x00ff0000
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0xff000000
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_B5G6R5_UNORM
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|16
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
literal|0x0000f800
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
literal|0x000007e0
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
literal|0x0000001f
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0x00000000
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_B5G5R5A1_UNORM
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|16
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
literal|0x00007c00
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
literal|0x000003e0
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
literal|0x0000001f
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0x00008000
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_R10G10B10A2_TYPELESS
case|:
case|case
name|DXGI_FORMAT_R10G10B10A2_UNORM
case|:
case|case
name|DXGI_FORMAT_R10G10B10A2_UINT
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|32
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_ALPHAPIXELS
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
literal|0x000003ff
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
literal|0x000ffc00
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
literal|0x3ff00000
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0xc0000000
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_A8_UNORM
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|8
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_ALPHA
operator||
name|DDPF_ALPHAPIXELS
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
literal|0
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0x000000ff
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_R8_TYPELESS
case|:
case|case
name|DXGI_FORMAT_R8_UNORM
case|:
case|case
name|DXGI_FORMAT_R8_UINT
case|:
case|case
name|DXGI_FORMAT_R8_SNORM
case|:
case|case
name|DXGI_FORMAT_R8_SINT
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|8
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
literal|0x000000ff
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_B4G4R4A4_UNORM
case|:
name|hdr
operator|->
name|pixelfmt
operator|.
name|bpp
operator|=
literal|16
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator||=
name|DDPF_ALPHAPIXELS
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|=
literal|0x00000f00
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|gmask
operator|=
literal|0x000000f0
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|=
literal|0x0000000f
expr_stmt|;
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|=
literal|0x0000f000
expr_stmt|;
break|break;
case|case
name|DXGI_FORMAT_UNKNOWN
case|:
name|g_message
argument_list|(
literal|"Unknown DXGI format.  Expect problems..."
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* unsupported DXGI format */
name|g_message
argument_list|(
literal|"Unsupported DXGI format (%d)"
argument_list|,
name|dx10hdr
operator|->
name|dxgiFormat
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|Babl
modifier|*
DECL|function|premultiplied_variant (const Babl * format)
name|premultiplied_variant
parameter_list|(
specifier|const
name|Babl
modifier|*
name|format
parameter_list|)
block|{
if|if
condition|(
name|format
operator|==
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
condition|)
return|return
name|babl_format
argument_list|(
literal|"R'aG'aB'aA u8"
argument_list|)
return|;
else|else
name|g_printerr
argument_list|(
literal|"Add format %s to premultiplied_variant () %s: %d\n"
argument_list|,
name|babl_get_name
argument_list|(
name|format
argument_list|)
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|format
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|load_layer (FILE * fp,dds_header_t * hdr,dds_load_info_t * d,gint32 image,unsigned int level,char * prefix,unsigned int * l,guchar * pixels,unsigned char * buf)
name|load_layer
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|dds_load_info_t
modifier|*
name|d
parameter_list|,
name|gint32
name|image
parameter_list|,
name|unsigned
name|int
name|level
parameter_list|,
name|char
modifier|*
name|prefix
parameter_list|,
name|unsigned
name|int
modifier|*
name|l
parameter_list|,
name|guchar
modifier|*
name|pixels
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|GeglBuffer
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|Babl
modifier|*
name|bablfmt
init|=
name|NULL
decl_stmt|;
name|GimpImageType
name|type
init|=
name|GIMP_RGBA_IMAGE
decl_stmt|;
name|gchar
modifier|*
name|layer_name
decl_stmt|;
name|gint
name|x
decl_stmt|,
name|y
decl_stmt|,
name|z
decl_stmt|,
name|n
decl_stmt|;
name|gint32
name|layer
decl_stmt|;
name|unsigned
name|int
name|width
init|=
name|hdr
operator|->
name|width
operator|>>
name|level
decl_stmt|;
name|unsigned
name|int
name|height
init|=
name|hdr
operator|->
name|height
operator|>>
name|level
decl_stmt|;
name|unsigned
name|int
name|size
init|=
name|hdr
operator|->
name|pitch_or_linsize
operator|>>
operator|(
literal|2
operator|*
name|level
operator|)
decl_stmt|;
name|unsigned
name|int
name|layerw
decl_stmt|;
name|int
name|format
init|=
name|DDS_COMPRESS_NONE
decl_stmt|;
if|if
condition|(
name|width
operator|<
literal|1
condition|)
name|width
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|height
operator|<
literal|1
condition|)
name|height
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|d
operator|->
name|bpp
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_PALETTEINDEXED8
condition|)
block|{
name|type
operator|=
name|GIMP_INDEXED_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|==
literal|0xe0
condition|)
block|{
name|type
operator|=
name|GIMP_RGB_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_ALPHA
condition|)
block|{
name|type
operator|=
name|GIMP_GRAYA_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"Y'A u8"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|type
operator|=
name|GIMP_GRAY_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"Y' u8"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|==
literal|0xf000
condition|)
comment|/* RGBA4 */
block|{
name|type
operator|=
name|GIMP_RGBA_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|==
literal|0xff00
condition|)
comment|/* L8A8 */
block|{
name|type
operator|=
name|GIMP_GRAYA_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"Y'A u8"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|==
literal|0x1f
condition|)
comment|/* R5G6B5 or RGB5A1 */
block|{
name|type
operator|=
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|==
literal|0x8000
operator|)
condition|?
name|GIMP_RGBA_IMAGE
else|:
name|GIMP_RGB_IMAGE
expr_stmt|;
name|bablfmt
operator|=
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|==
literal|0x8000
operator|)
condition|?
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
else|:
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* L16 */
block|{
name|type
operator|=
name|GIMP_GRAY_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"Y' u8"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
name|type
operator|=
name|GIMP_RGB_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"R'G'B' u8"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|type
operator|=
name|GIMP_RGBA_IMAGE
expr_stmt|;
name|bablfmt
operator|=
name|babl_format
argument_list|(
literal|"R'G'B'A u8"
argument_list|)
expr_stmt|;
break|break;
block|}
name|layer_name
operator|=
operator|(
name|level
operator|)
condition|?
name|g_strdup_printf
argument_list|(
literal|"mipmap %d %s"
argument_list|,
name|level
argument_list|,
name|prefix
argument_list|)
else|:
name|g_strdup_printf
argument_list|(
literal|"main surface %s"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|layer
operator|=
name|gimp_layer_new
argument_list|(
name|image
argument_list|,
name|layer_name
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|type
argument_list|,
literal|100
argument_list|,
name|GIMP_LAYER_MODE_NORMAL
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|layer_name
argument_list|)
expr_stmt|;
name|gimp_image_insert_layer
argument_list|(
name|image
argument_list|,
name|layer
argument_list|,
literal|0
argument_list|,
operator|*
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|l
operator|)
operator|++
condition|)
name|gimp_item_set_visible
argument_list|(
name|layer
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|gimp_drawable_get_buffer
argument_list|(
name|layer
argument_list|)
expr_stmt|;
name|layerw
operator|=
name|gegl_buffer_get_width
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_FOURCC
condition|)
block|{
name|unsigned
name|int
name|w
init|=
operator|(
name|width
operator|+
literal|3
operator|)
operator|>>
literal|2
decl_stmt|;
name|unsigned
name|int
name|h
init|=
operator|(
name|height
operator|+
literal|3
operator|)
operator|>>
literal|2
decl_stmt|;
switch|switch
condition|(
name|GETL32
argument_list|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|fourcc
argument_list|)
condition|)
block|{
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'1'
argument_list|)
case|:
name|format
operator|=
name|DDS_COMPRESS_BC1
expr_stmt|;
break|break;
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'2'
argument_list|)
case|:
name|bablfmt
operator|=
name|premultiplied_variant
argument_list|(
name|bablfmt
argument_list|)
expr_stmt|;
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'3'
argument_list|)
case|:
name|format
operator|=
name|DDS_COMPRESS_BC2
expr_stmt|;
break|break;
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'4'
argument_list|)
case|:
name|bablfmt
operator|=
name|premultiplied_variant
argument_list|(
name|bablfmt
argument_list|)
expr_stmt|;
case|case
name|FOURCC
argument_list|(
literal|'D'
argument_list|,
literal|'X'
argument_list|,
literal|'T'
argument_list|,
literal|'5'
argument_list|)
case|:
name|format
operator|=
name|DDS_COMPRESS_BC3
expr_stmt|;
break|break;
case|case
name|FOURCC
argument_list|(
literal|'R'
argument_list|,
literal|'X'
argument_list|,
literal|'G'
argument_list|,
literal|'B'
argument_list|)
case|:
name|format
operator|=
name|DDS_COMPRESS_BC3
expr_stmt|;
break|break;
case|case
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'1'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'U'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'4'
argument_list|,
literal|'S'
argument_list|)
case|:
name|format
operator|=
name|DDS_COMPRESS_BC4
expr_stmt|;
break|break;
case|case
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'2'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'U'
argument_list|)
case|:
case|case
name|FOURCC
argument_list|(
literal|'B'
argument_list|,
literal|'C'
argument_list|,
literal|'5'
argument_list|,
literal|'S'
argument_list|)
case|:
name|format
operator|=
name|DDS_COMPRESS_BC5
expr_stmt|;
break|break;
block|}
name|size
operator|=
name|w
operator|*
name|h
expr_stmt|;
if|if
condition|(
operator|(
name|format
operator|==
name|DDS_COMPRESS_BC1
operator|)
operator|||
operator|(
name|format
operator|==
name|DDS_COMPRESS_BC4
operator|)
condition|)
name|size
operator|*=
literal|8
expr_stmt|;
else|else
name|size
operator|*=
literal|16
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|->
name|flags
operator|&
name|DDSD_LINEARSIZE
operator|)
operator|&&
operator|!
name|fread
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Unexpected EOF.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_RGB
operator|)
operator|||
operator|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_ALPHA
operator|)
condition|)
block|{
name|z
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
operator|,
name|n
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
operator|++
name|y
operator|,
operator|++
name|n
control|)
block|{
if|if
condition|(
name|n
operator|>=
name|d
operator|->
name|tile_height
condition|)
block|{
name|gegl_buffer_set
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
name|y
operator|-
name|n
argument_list|,
name|layerw
argument_list|,
name|n
argument_list|)
argument_list|,
literal|0
argument_list|,
name|bablfmt
argument_list|,
name|pixels
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|y
operator|/
operator|(
name|double
operator|)
name|hdr
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|->
name|flags
operator|&
name|DDSD_PITCH
operator|)
operator|&&
operator|!
name|fread
argument_list|(
name|buf
argument_list|,
name|width
operator|*
name|d
operator|->
name|bpp
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Unexpected EOF.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|hdr
operator|->
name|flags
operator|&
name|DDSD_LINEARSIZE
operator|)
condition|)
name|z
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|layerw
condition|;
operator|++
name|x
control|)
block|{
name|unsigned
name|int
name|pixel
init|=
name|buf
index|[
name|z
index|]
decl_stmt|;
name|unsigned
name|int
name|pos
init|=
operator|(
name|n
operator|*
name|layerw
operator|+
name|x
operator|)
operator|*
name|d
operator|->
name|gimp_bpp
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|bpp
operator|>
literal|1
condition|)
name|pixel
operator|+=
operator|(
operator|(
name|unsigned
name|int
operator|)
name|buf
index|[
name|z
operator|+
literal|1
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bpp
operator|>
literal|2
condition|)
name|pixel
operator|+=
operator|(
operator|(
name|unsigned
name|int
operator|)
name|buf
index|[
name|z
operator|+
literal|2
index|]
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bpp
operator|>
literal|3
condition|)
name|pixel
operator|+=
operator|(
operator|(
name|unsigned
name|int
operator|)
name|buf
index|[
name|z
operator|+
literal|3
index|]
operator|<<
literal|24
operator|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bpp
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|==
literal|0xc0000000
condition|)
comment|// handle RGB10A2
block|{
name|pixels
index|[
name|pos
operator|+
literal|0
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|bshift
operator|)
operator|>>
literal|2
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|1
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|gshift
operator|)
operator|>>
literal|2
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|2
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|rshift
operator|)
operator|>>
literal|2
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_ALPHAPIXELS
condition|)
name|pixels
index|[
name|pos
operator|+
literal|3
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|ashift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|abits
operator|)
operator|&
name|d
operator|->
name|amask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|amask
expr_stmt|;
block|}
else|else
block|{
name|pixels
index|[
name|pos
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|rshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|rbits
operator|)
operator|&
name|d
operator|->
name|rmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|rmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|1
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|gshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|gbits
operator|)
operator|&
name|d
operator|->
name|gmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|gmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|2
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|bshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|bbits
operator|)
operator|&
name|d
operator|->
name|bmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|bmask
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_ALPHAPIXELS
condition|)
block|{
name|pixels
index|[
name|pos
operator|+
literal|3
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|ashift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|abits
operator|)
operator|&
name|d
operator|->
name|amask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|amask
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|d
operator|->
name|bpp
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|==
literal|0xf000
condition|)
comment|//RGBA4
block|{
name|pixels
index|[
name|pos
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|rshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|rbits
operator|)
operator|&
name|d
operator|->
name|rmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|rmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|1
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|gshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|gbits
operator|)
operator|&
name|d
operator|->
name|gmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|gmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|2
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|bshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|bbits
operator|)
operator|&
name|d
operator|->
name|bmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|bmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|3
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|ashift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|abits
operator|)
operator|&
name|d
operator|->
name|amask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|amask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|==
literal|0xff00
condition|)
comment|//L8A8
block|{
name|pixels
index|[
name|pos
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|rshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|rbits
operator|)
operator|&
name|d
operator|->
name|rmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|rmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|1
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|ashift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|abits
operator|)
operator|&
name|d
operator|->
name|amask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|amask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|bmask
operator|==
literal|0x1f
condition|)
comment|//R5G6B5 or RGB5A1
block|{
name|pixels
index|[
name|pos
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|rshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|rbits
operator|)
operator|&
name|d
operator|->
name|rmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|rmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|1
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|gshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|gbits
operator|)
operator|&
name|d
operator|->
name|gmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|gmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|2
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|bshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|bbits
operator|)
operator|&
name|d
operator|->
name|bmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|bmask
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|amask
operator|==
literal|0x8000
condition|)
block|{
name|pixels
index|[
name|pos
operator|+
literal|3
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|ashift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|abits
operator|)
operator|&
name|d
operator|->
name|amask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|amask
expr_stmt|;
block|}
block|}
else|else
comment|//L16
name|pixels
index|[
name|pos
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
literal|255
operator|*
operator|(
call|(
name|float
call|)
argument_list|(
name|pixel
operator|&
literal|0xffff
argument_list|)
operator|/
literal|65535.0f
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_PALETTEINDEXED8
condition|)
block|{
name|pixels
index|[
name|pos
index|]
operator|=
name|pixel
operator|&
literal|0xff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|rmask
operator|==
literal|0xe0
condition|)
comment|// R3G3B2
block|{
name|pixels
index|[
name|pos
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|rshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|rbits
operator|)
operator|&
name|d
operator|->
name|rmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|rmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|1
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|gshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|gbits
operator|)
operator|&
name|d
operator|->
name|gmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|gmask
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|2
index|]
operator|=
operator|(
name|pixel
operator|>>
name|d
operator|->
name|bshift
operator|<<
operator|(
literal|8
operator|-
name|d
operator|->
name|bbits
operator|)
operator|&
name|d
operator|->
name|bmask
operator|)
operator|*
literal|255
operator|/
name|d
operator|->
name|bmask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_ALPHA
condition|)
block|{
name|pixels
index|[
name|pos
operator|+
literal|0
index|]
operator|=
literal|255
expr_stmt|;
name|pixels
index|[
name|pos
operator|+
literal|1
index|]
operator|=
name|pixel
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
comment|// LUMINANCE
block|{
name|pixels
index|[
name|pos
index|]
operator|=
name|pixel
operator|&
literal|0xff
expr_stmt|;
block|}
block|}
name|z
operator|+=
name|d
operator|->
name|bpp
expr_stmt|;
block|}
block|}
name|gegl_buffer_set
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
name|y
operator|-
name|n
argument_list|,
name|layerw
argument_list|,
name|n
argument_list|)
argument_list|,
literal|0
argument_list|,
name|bablfmt
argument_list|,
name|pixels
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_FOURCC
condition|)
block|{
name|unsigned
name|char
modifier|*
name|dst
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|hdr
operator|->
name|flags
operator|&
name|DDSD_LINEARSIZE
operator|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Image marked as compressed, but DDSD_LINEARSIZE is not set.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|dst
operator|=
name|g_malloc
argument_list|(
name|width
operator|*
name|height
operator|*
name|d
operator|->
name|gimp_bpp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|dst
argument_list|,
literal|0
argument_list|,
name|width
operator|*
name|height
operator|*
name|d
operator|->
name|gimp_bpp
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|gimp_bpp
operator|==
literal|4
condition|)
block|{
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
operator|++
name|y
control|)
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
operator|++
name|x
control|)
name|dst
index|[
name|y
operator|*
operator|(
name|width
operator|*
literal|4
operator|)
operator|+
operator|(
name|x
operator|*
literal|4
operator|)
operator|+
literal|3
index|]
operator|=
literal|255
expr_stmt|;
block|}
name|dxt_decompress
argument_list|(
name|dst
argument_list|,
name|buf
argument_list|,
name|format
argument_list|,
name|size
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|d
operator|->
name|gimp_bpp
argument_list|,
name|hdr
operator|->
name|pixelfmt
operator|.
name|flags
operator|&
name|DDPF_NORMAL
argument_list|)
expr_stmt|;
name|z
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
operator|,
name|n
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
operator|++
name|y
operator|,
operator|++
name|n
control|)
block|{
if|if
condition|(
name|n
operator|>=
name|d
operator|->
name|tile_height
condition|)
block|{
name|gegl_buffer_set
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
name|y
operator|-
name|n
argument_list|,
name|layerw
argument_list|,
name|n
argument_list|)
argument_list|,
literal|0
argument_list|,
name|bablfmt
argument_list|,
name|pixels
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|gimp_progress_update
argument_list|(
operator|(
name|double
operator|)
name|y
operator|/
operator|(
name|double
operator|)
name|hdr
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|pixels
operator|+
name|n
operator|*
name|layerw
operator|*
name|d
operator|->
name|gimp_bpp
argument_list|,
name|dst
operator|+
name|y
operator|*
name|layerw
operator|*
name|d
operator|->
name|gimp_bpp
argument_list|,
name|width
operator|*
name|d
operator|->
name|gimp_bpp
argument_list|)
expr_stmt|;
block|}
name|gegl_buffer_set
argument_list|(
name|buffer
argument_list|,
name|GEGL_RECTANGLE
argument_list|(
literal|0
argument_list|,
name|y
operator|-
name|n
argument_list|,
name|layerw
argument_list|,
name|n
argument_list|)
argument_list|,
literal|0
argument_list|,
name|bablfmt
argument_list|,
name|pixels
argument_list|,
name|GEGL_AUTO_ROWSTRIDE
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
name|gegl_buffer_flush
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|g_object_unref
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
comment|/* gimp dds specific.  decode encoded images */
if|if
condition|(
name|dds_read_vals
operator|.
name|decode_images
operator|&&
name|hdr
operator|->
name|reserved
operator|.
name|gimp_dds_special
operator|.
name|magic1
operator|==
name|FOURCC
argument_list|(
literal|'G'
argument_list|,
literal|'I'
argument_list|,
literal|'M'
argument_list|,
literal|'P'
argument_list|)
operator|&&
name|hdr
operator|->
name|reserved
operator|.
name|gimp_dds_special
operator|.
name|magic2
operator|==
name|FOURCC
argument_list|(
literal|'-'
argument_list|,
literal|'D'
argument_list|,
literal|'D'
argument_list|,
literal|'S'
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|hdr
operator|->
name|reserved
operator|.
name|gimp_dds_special
operator|.
name|extra_fourcc
condition|)
block|{
case|case
name|FOURCC
argument_list|(
literal|'A'
argument_list|,
literal|'E'
argument_list|,
literal|'X'
argument_list|,
literal|'P'
argument_list|)
case|:
name|decode_alpha_exp_image
argument_list|(
name|layer
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FOURCC
argument_list|(
literal|'Y'
argument_list|,
literal|'C'
argument_list|,
literal|'G'
argument_list|,
literal|'1'
argument_list|)
case|:
name|decode_ycocg_image
argument_list|(
name|layer
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FOURCC
argument_list|(
literal|'Y'
argument_list|,
literal|'C'
argument_list|,
literal|'G'
argument_list|,
literal|'2'
argument_list|)
case|:
name|decode_ycocg_scaled_image
argument_list|(
name|layer
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|load_mipmaps (FILE * fp,dds_header_t * hdr,dds_load_info_t * d,gint32 image,char * prefix,unsigned int * l,guchar * pixels,unsigned char * buf)
name|load_mipmaps
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|dds_load_info_t
modifier|*
name|d
parameter_list|,
name|gint32
name|image
parameter_list|,
name|char
modifier|*
name|prefix
parameter_list|,
name|unsigned
name|int
modifier|*
name|l
parameter_list|,
name|guchar
modifier|*
name|pixels
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|unsigned
name|int
name|level
decl_stmt|;
if|if
condition|(
operator|(
name|hdr
operator|->
name|flags
operator|&
name|DDSD_MIPMAPCOUNT
operator|)
operator|&&
operator|(
name|hdr
operator|->
name|caps
operator|.
name|caps1
operator|&
name|DDSCAPS_MIPMAP
operator|)
operator|&&
operator|(
name|dds_read_vals
operator|.
name|mipmaps
operator|!=
literal|0
operator|)
condition|)
block|{
for|for
control|(
name|level
operator|=
literal|1
init|;
name|level
operator|<
name|hdr
operator|->
name|num_mipmaps
condition|;
operator|++
name|level
control|)
block|{
if|if
condition|(
operator|!
name|load_layer
argument_list|(
name|fp
argument_list|,
name|hdr
argument_list|,
name|d
argument_list|,
name|image
argument_list|,
name|level
argument_list|,
name|prefix
argument_list|,
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|load_face (FILE * fp,dds_header_t * hdr,dds_load_info_t * d,gint32 image,char * prefix,unsigned int * l,guchar * pixels,unsigned char * buf)
name|load_face
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|dds_header_t
modifier|*
name|hdr
parameter_list|,
name|dds_load_info_t
modifier|*
name|d
parameter_list|,
name|gint32
name|image
parameter_list|,
name|char
modifier|*
name|prefix
parameter_list|,
name|unsigned
name|int
modifier|*
name|l
parameter_list|,
name|guchar
modifier|*
name|pixels
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
operator|!
name|load_layer
argument_list|(
name|fp
argument_list|,
name|hdr
argument_list|,
name|d
argument_list|,
name|image
argument_list|,
literal|0
argument_list|,
name|prefix
argument_list|,
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|load_mipmaps
argument_list|(
name|fp
argument_list|,
name|hdr
argument_list|,
name|d
argument_list|,
name|image
argument_list|,
name|prefix
argument_list|,
name|l
argument_list|,
name|pixels
argument_list|,
name|buf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
DECL|function|color_bits (unsigned int mask)
name|color_bits
parameter_list|(
name|unsigned
name|int
name|mask
parameter_list|)
block|{
name|unsigned
name|char
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|mask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
literal|1
condition|)
operator|++
name|i
expr_stmt|;
name|mask
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
DECL|function|color_shift (unsigned int mask)
name|color_shift
parameter_list|(
name|unsigned
name|int
name|mask
parameter_list|)
block|{
name|unsigned
name|char
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|mask
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
operator|!
operator|(
operator|(
name|mask
operator|>>
name|i
operator|)
operator|&
literal|1
operator|)
condition|)
operator|++
name|i
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|load_dialog_response (GtkWidget * widget,gint response_id,gpointer data)
name|load_dialog_response
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gint
name|response_id
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
switch|switch
condition|(
name|response_id
condition|)
block|{
case|case
name|GTK_RESPONSE_OK
case|:
name|runme
operator|=
literal|1
expr_stmt|;
default|default:
name|gtk_widget_destroy
argument_list|(
name|widget
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|toggle_clicked (GtkWidget * widget,gpointer data)
name|toggle_clicked
parameter_list|(
name|GtkWidget
modifier|*
name|widget
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|int
modifier|*
name|flag
init|=
operator|(
name|int
operator|*
operator|)
name|data
decl_stmt|;
operator|(
operator|*
name|flag
operator|)
operator|=
operator|!
operator|(
operator|*
name|flag
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|load_dialog (void)
name|load_dialog
parameter_list|(
name|void
parameter_list|)
block|{
name|GtkWidget
modifier|*
name|dlg
decl_stmt|;
name|GtkWidget
modifier|*
name|vbox
decl_stmt|;
name|GtkWidget
modifier|*
name|check
decl_stmt|;
name|dlg
operator|=
name|gimp_dialog_new
argument_list|(
name|_
argument_list|(
literal|"Load DDS"
argument_list|)
argument_list|,
literal|"dds"
argument_list|,
name|NULL
argument_list|,
name|GTK_WIN_POS_MOUSE
argument_list|,
name|gimp_standard_help_func
argument_list|,
name|LOAD_PROC
argument_list|,
name|_
argument_list|(
literal|"Cancel"
argument_list|)
argument_list|,
name|GTK_RESPONSE_CANCEL
argument_list|,
name|_
argument_list|(
literal|"OK"
argument_list|)
argument_list|,
name|GTK_RESPONSE_OK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"response"
argument_list|,
name|G_CALLBACK
argument_list|(
name|load_dialog_response
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|dlg
argument_list|,
literal|"destroy"
argument_list|,
name|G_CALLBACK
argument_list|(
name|gtk_main_quit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vbox
operator|=
name|gtk_box_new
argument_list|(
name|GTK_ORIENTATION_VERTICAL
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_container_set_border_width
argument_list|(
name|GTK_CONTAINER
argument_list|(
name|vbox
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|gtk_dialog_get_content_area
argument_list|(
name|GTK_DIALOG
argument_list|(
name|dlg
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|vbox
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|vbox
argument_list|)
expr_stmt|;
name|check
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Load mipmaps"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|check
argument_list|)
argument_list|,
name|dds_read_vals
operator|.
name|mipmaps
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|check
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|toggle_clicked
argument_list|)
argument_list|,
operator|&
name|dds_read_vals
operator|.
name|mipmaps
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|check
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
name|check
operator|=
name|gtk_check_button_new_with_label
argument_list|(
name|_
argument_list|(
literal|"Automatically decode YCoCg/AExp images when detected"
argument_list|)
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|check
argument_list|)
argument_list|,
name|dds_read_vals
operator|.
name|decode_images
argument_list|)
expr_stmt|;
name|g_signal_connect
argument_list|(
name|check
argument_list|,
literal|"clicked"
argument_list|,
name|G_CALLBACK
argument_list|(
name|toggle_clicked
argument_list|)
argument_list|,
operator|&
name|dds_read_vals
operator|.
name|decode_images
argument_list|)
expr_stmt|;
name|gtk_box_pack_start
argument_list|(
name|GTK_BOX
argument_list|(
name|vbox
argument_list|)
argument_list|,
name|check
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|check
argument_list|)
expr_stmt|;
name|gtk_widget_show
argument_list|(
name|dlg
argument_list|)
expr_stmt|;
name|runme
operator|=
literal|0
expr_stmt|;
name|gtk_main
argument_list|()
expr_stmt|;
return|return
operator|(
name|runme
operator|)
return|;
block|}
end_function

end_unit

