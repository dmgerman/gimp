begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1995 Spencer Kimball and Peter Mattis  *  * This is a plug-in for GIMP.  *  * Generates images containing vector type drawings.  *  * Copyright (C) 1997 Andy Thomas  alt@picnic.demon.co.uk  *  * This program is free software: you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program.  If not, see<http://www.gnu.org/licenses/>.  *  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimp.h>
end_include

begin_include
include|#
directive|include
file|<libgimp/gimpui.h>
end_include

begin_include
include|#
directive|include
file|"libgimp/stdplugins-intl.h"
end_include

begin_include
include|#
directive|include
file|"gfig.h"
end_include

begin_include
include|#
directive|include
file|"gfig-dobject.h"
end_include

begin_include
include|#
directive|include
file|"gfig-style.h"
end_include

begin_function_decl
specifier|static
name|void
name|gfig_read_parameter_string
parameter_list|(
name|gchar
modifier|*
modifier|*
name|text
parameter_list|,
name|gint
name|nitems
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gchar
modifier|*
modifier|*
name|style_entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gfig_read_parameter_int
parameter_list|(
name|gchar
modifier|*
modifier|*
name|text
parameter_list|,
name|gint
name|nitems
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
modifier|*
name|style_entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gfig_read_parameter_double
parameter_list|(
name|gchar
modifier|*
modifier|*
name|text
parameter_list|,
name|gint
name|nitems
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gdouble
modifier|*
name|style_entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gfig_read_parameter_gimp_rgb
parameter_list|(
name|gchar
modifier|*
modifier|*
name|text
parameter_list|,
name|gint
name|nitems
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|GimpRGB
modifier|*
name|style_entry
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
DECL|function|gfig_read_parameter_string (gchar ** text,gint nitems,const gchar * name,gchar ** style_entry)
name|gfig_read_parameter_string
parameter_list|(
name|gchar
modifier|*
modifier|*
name|text
parameter_list|,
name|gint
name|nitems
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gchar
modifier|*
modifier|*
name|style_entry
parameter_list|)
block|{
name|gint
name|n
init|=
literal|0
decl_stmt|;
name|gchar
modifier|*
name|ptr
decl_stmt|;
name|gchar
modifier|*
name|tmpstr
decl_stmt|;
operator|*
name|style_entry
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|n
operator|<
name|nitems
condition|)
block|{
name|ptr
operator|=
name|strchr
argument_list|(
name|text
index|[
name|n
index|]
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
condition|)
block|{
name|tmpstr
operator|=
name|g_strndup
argument_list|(
name|text
index|[
name|n
index|]
argument_list|,
name|ptr
operator|-
name|text
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
name|name
argument_list|)
condition|)
block|{
operator|*
name|style_entry
operator|=
name|g_strdup
argument_list|(
name|g_strchug
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
return|return;
block|}
name|g_free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
block|}
operator|++
name|n
expr_stmt|;
block|}
name|g_message
argument_list|(
literal|"Parameter '%s' not found"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gfig_read_parameter_int (gchar ** text,gint nitems,const gchar * name,gint * style_entry)
name|gfig_read_parameter_int
parameter_list|(
name|gchar
modifier|*
modifier|*
name|text
parameter_list|,
name|gint
name|nitems
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gint
modifier|*
name|style_entry
parameter_list|)
block|{
name|gint
name|n
init|=
literal|0
decl_stmt|;
name|gchar
modifier|*
name|ptr
decl_stmt|;
name|gchar
modifier|*
name|tmpstr
decl_stmt|;
operator|*
name|style_entry
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|n
operator|<
name|nitems
condition|)
block|{
name|ptr
operator|=
name|strchr
argument_list|(
name|text
index|[
name|n
index|]
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
condition|)
block|{
name|tmpstr
operator|=
name|g_strndup
argument_list|(
name|text
index|[
name|n
index|]
argument_list|,
name|ptr
operator|-
name|text
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
name|name
argument_list|)
condition|)
block|{
operator|*
name|style_entry
operator|=
name|atoi
argument_list|(
name|g_strchug
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
return|return;
block|}
name|g_free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
block|}
operator|++
name|n
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gfig_read_parameter_double (gchar ** text,gint nitems,const gchar * name,gdouble * style_entry)
name|gfig_read_parameter_double
parameter_list|(
name|gchar
modifier|*
modifier|*
name|text
parameter_list|,
name|gint
name|nitems
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|gdouble
modifier|*
name|style_entry
parameter_list|)
block|{
name|gint
name|n
init|=
literal|0
decl_stmt|;
name|gchar
modifier|*
name|ptr
decl_stmt|;
name|gchar
modifier|*
name|endptr
decl_stmt|;
name|gchar
modifier|*
name|tmpstr
decl_stmt|;
operator|*
name|style_entry
operator|=
literal|0.
expr_stmt|;
while|while
condition|(
name|n
operator|<
name|nitems
condition|)
block|{
name|ptr
operator|=
name|strchr
argument_list|(
name|text
index|[
name|n
index|]
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
condition|)
block|{
name|tmpstr
operator|=
name|g_strndup
argument_list|(
name|text
index|[
name|n
index|]
argument_list|,
name|ptr
operator|-
name|text
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
name|name
argument_list|)
condition|)
block|{
operator|*
name|style_entry
operator|=
name|g_ascii_strtod
argument_list|(
name|g_strchug
argument_list|(
name|ptr
argument_list|)
argument_list|,
operator|&
name|endptr
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
return|return;
block|}
name|g_free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
block|}
operator|++
name|n
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|gfig_read_parameter_gimp_rgb (gchar ** text,gint nitems,const gchar * name,GimpRGB * style_entry)
name|gfig_read_parameter_gimp_rgb
parameter_list|(
name|gchar
modifier|*
modifier|*
name|text
parameter_list|,
name|gint
name|nitems
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|,
name|GimpRGB
modifier|*
name|style_entry
parameter_list|)
block|{
name|gint
name|n
init|=
literal|0
decl_stmt|;
name|gchar
modifier|*
name|ptr
decl_stmt|;
name|gchar
modifier|*
name|tmpstr
decl_stmt|;
name|gchar
modifier|*
name|endptr
decl_stmt|;
name|gchar
name|fmt_str
index|[
literal|32
index|]
decl_stmt|;
name|gchar
name|colorstr_r
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|colorstr_g
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|colorstr_b
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|colorstr_a
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|style_entry
operator|->
name|r
operator|=
name|style_entry
operator|->
name|g
operator|=
name|style_entry
operator|->
name|b
operator|=
name|style_entry
operator|->
name|a
operator|=
literal|0.
expr_stmt|;
name|snprintf
argument_list|(
name|fmt_str
argument_list|,
sizeof|sizeof
argument_list|(
name|fmt_str
argument_list|)
argument_list|,
literal|"%%%zus %%%zus %%%zus %%%zus"
argument_list|,
sizeof|sizeof
argument_list|(
name|colorstr_r
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|colorstr_g
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|colorstr_b
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|colorstr_a
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|<
name|nitems
condition|)
block|{
name|ptr
operator|=
name|strchr
argument_list|(
name|text
index|[
name|n
index|]
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
condition|)
block|{
name|tmpstr
operator|=
name|g_strndup
argument_list|(
name|text
index|[
name|n
index|]
argument_list|,
name|ptr
operator|-
name|text
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
name|name
argument_list|)
condition|)
block|{
name|sscanf
argument_list|(
name|ptr
argument_list|,
name|fmt_str
argument_list|,
name|colorstr_r
argument_list|,
name|colorstr_g
argument_list|,
name|colorstr_b
argument_list|,
name|colorstr_a
argument_list|)
expr_stmt|;
name|style_entry
operator|->
name|r
operator|=
name|g_ascii_strtod
argument_list|(
name|colorstr_r
argument_list|,
operator|&
name|endptr
argument_list|)
expr_stmt|;
name|style_entry
operator|->
name|g
operator|=
name|g_ascii_strtod
argument_list|(
name|colorstr_g
argument_list|,
operator|&
name|endptr
argument_list|)
expr_stmt|;
name|style_entry
operator|->
name|b
operator|=
name|g_ascii_strtod
argument_list|(
name|colorstr_b
argument_list|,
operator|&
name|endptr
argument_list|)
expr_stmt|;
name|style_entry
operator|->
name|a
operator|=
name|g_ascii_strtod
argument_list|(
name|colorstr_a
argument_list|,
operator|&
name|endptr
argument_list|)
expr_stmt|;
name|g_free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
return|return;
block|}
name|g_free
argument_list|(
name|tmpstr
argument_list|)
expr_stmt|;
block|}
operator|++
name|n
expr_stmt|;
block|}
block|}
end_function

begin_define
DECL|macro|MAX_STYLE_TEXT_ENTRIES
define|#
directive|define
name|MAX_STYLE_TEXT_ENTRIES
value|100
end_define

begin_function
name|gboolean
DECL|function|gfig_load_style (Style * style,FILE * fp)
name|gfig_load_style
parameter_list|(
name|Style
modifier|*
name|style
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|gulong
name|offset
decl_stmt|;
name|gchar
name|load_buf2
index|[
name|MAX_LOAD_LINE
index|]
decl_stmt|;
name|gchar
modifier|*
name|style_text
index|[
name|MAX_STYLE_TEXT_ENTRIES
index|]
decl_stmt|;
name|gint
name|nitems
init|=
literal|0
decl_stmt|;
name|gint
name|value
decl_stmt|;
name|gint
name|k
decl_stmt|;
name|gchar
name|name
index|[
literal|100
index|]
decl_stmt|;
name|offset
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|get_line
argument_list|(
name|load_buf2
argument_list|,
name|MAX_LOAD_LINE
argument_list|,
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
operator|!=
name|sscanf
argument_list|(
name|load_buf2
argument_list|,
literal|"<Style %99s>"
argument_list|,
name|name
argument_list|)
condition|)
block|{
comment|/* no style data, copy default style and fail silently */
name|gfig_style_copy
argument_list|(
name|style
argument_list|,
operator|&
name|gfig_context
operator|->
name|default_style
argument_list|,
literal|"default style"
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Loading style '%s' -- "
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/* nuke final> in name */
operator|*
name|strrchr
argument_list|(
name|name
argument_list|,
literal|'>'
argument_list|)
operator|=
literal|'\0'
expr_stmt|;
name|style
operator|->
name|name
operator|=
name|g_strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
name|get_line
argument_list|(
name|load_buf2
argument_list|,
name|MAX_LOAD_LINE
argument_list|,
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|load_buf2
argument_list|,
literal|"</Style>"
argument_list|)
operator|||
name|feof
argument_list|(
name|fp
argument_list|)
condition|)
break|break;
name|style_text
index|[
name|nitems
index|]
operator|=
name|g_strdup
argument_list|(
name|load_buf2
argument_list|)
expr_stmt|;
name|nitems
operator|++
expr_stmt|;
if|if
condition|(
name|nitems
operator|>=
name|MAX_STYLE_TEXT_ENTRIES
condition|)
break|break;
block|}
if|if
condition|(
name|feof
argument_list|(
name|fp
argument_list|)
operator|||
operator|(
name|nitems
operator|>=
name|MAX_STYLE_TEXT_ENTRIES
operator|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Error reading style data"
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
name|gfig_read_parameter_string
argument_list|(
name|style_text
argument_list|,
name|nitems
argument_list|,
literal|"BrushName"
argument_list|,
operator|&
name|style
operator|->
name|brush_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|style
operator|->
name|brush_name
operator|==
name|NULL
condition|)
name|g_message
argument_list|(
literal|"Error loading style: got NULL for brush name."
argument_list|)
expr_stmt|;
name|gfig_read_parameter_string
argument_list|(
name|style_text
argument_list|,
name|nitems
argument_list|,
literal|"Pattern"
argument_list|,
operator|&
name|style
operator|->
name|pattern
argument_list|)
expr_stmt|;
name|gfig_read_parameter_string
argument_list|(
name|style_text
argument_list|,
name|nitems
argument_list|,
literal|"Gradient"
argument_list|,
operator|&
name|style
operator|->
name|gradient
argument_list|)
expr_stmt|;
name|gfig_read_parameter_gimp_rgb
argument_list|(
name|style_text
argument_list|,
name|nitems
argument_list|,
literal|"Foreground"
argument_list|,
operator|&
name|style
operator|->
name|foreground
argument_list|)
expr_stmt|;
name|gfig_read_parameter_gimp_rgb
argument_list|(
name|style_text
argument_list|,
name|nitems
argument_list|,
literal|"Background"
argument_list|,
operator|&
name|style
operator|->
name|background
argument_list|)
expr_stmt|;
name|gfig_read_parameter_int
argument_list|(
name|style_text
argument_list|,
name|nitems
argument_list|,
literal|"FillType"
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
name|style
operator|->
name|fill_type
operator|=
name|value
expr_stmt|;
name|gfig_read_parameter_int
argument_list|(
name|style_text
argument_list|,
name|nitems
argument_list|,
literal|"PaintType"
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
name|style
operator|->
name|paint_type
operator|=
name|value
expr_stmt|;
name|gfig_read_parameter_double
argument_list|(
name|style_text
argument_list|,
name|nitems
argument_list|,
literal|"FillOpacity"
argument_list|,
operator|&
name|style
operator|->
name|fill_opacity
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|nitems
condition|;
name|k
operator|++
control|)
block|{
name|g_free
argument_list|(
name|style_text
index|[
name|k
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|gboolean
DECL|function|gfig_skip_style (Style * style,FILE * fp)
name|gfig_skip_style
parameter_list|(
name|Style
modifier|*
name|style
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|gulong
name|offset
decl_stmt|;
name|gchar
name|load_buf2
index|[
name|MAX_LOAD_LINE
index|]
decl_stmt|;
name|offset
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|get_line
argument_list|(
name|load_buf2
argument_list|,
name|MAX_LOAD_LINE
argument_list|,
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|load_buf2
argument_list|,
literal|"<Style "
argument_list|,
literal|7
argument_list|)
condition|)
block|{
comment|/* no style data */
name|fseek
argument_list|(
name|fp
argument_list|,
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
while|while
condition|(
name|TRUE
condition|)
block|{
name|get_line
argument_list|(
name|load_buf2
argument_list|,
name|MAX_LOAD_LINE
argument_list|,
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|load_buf2
argument_list|,
literal|"</Style>"
argument_list|)
operator|||
name|feof
argument_list|(
name|fp
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|feof
argument_list|(
name|fp
argument_list|)
condition|)
block|{
name|g_message
argument_list|(
literal|"Error trying to skip style data"
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/*  * FIXME: need to make this load a list of styles if there are more than one.  */
end_comment

begin_function
name|gboolean
DECL|function|gfig_load_styles (GFigObj * gfig,FILE * fp)
name|gfig_load_styles
parameter_list|(
name|GFigObj
modifier|*
name|gfig
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Loading global styles -- "
argument_list|)
expr_stmt|;
comment|/* currently we only have the default style */
name|gfig_load_style
argument_list|(
operator|&
name|gfig_context
operator|->
name|default_style
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|void
DECL|function|gfig_save_style (Style * style,GString * string)
name|gfig_save_style
parameter_list|(
name|Style
modifier|*
name|style
parameter_list|,
name|GString
modifier|*
name|string
parameter_list|)
block|{
name|gchar
name|buffer
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|buffer_r
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|buffer_g
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|buffer_b
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|buffer_a
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gint
name|blen
init|=
name|G_ASCII_DTOSTR_BUF_SIZE
decl_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Saving style %s, brush name '%s'\n"
argument_list|,
name|style
operator|->
name|name
argument_list|,
name|style
operator|->
name|brush_name
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"<Style %s>\n"
argument_list|,
name|style
operator|->
name|name
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"BrushName:      %s\n"
argument_list|,
name|style
operator|->
name|brush_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|style
operator|->
name|brush_name
condition|)
name|g_message
argument_list|(
literal|"Error saving style %s: saving NULL for brush name"
argument_list|,
name|style
operator|->
name|name
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"PaintType:       %d\n"
argument_list|,
name|style
operator|->
name|paint_type
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"FillType:       %d\n"
argument_list|,
name|style
operator|->
name|fill_type
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"FillOpacity:    %s\n"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|fill_opacity
argument_list|)
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"Pattern:        %s\n"
argument_list|,
name|style
operator|->
name|pattern
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"Gradient:       %s\n"
argument_list|,
name|style
operator|->
name|gradient
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"Foreground: %s %s %s %s\n"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_r
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|foreground
operator|.
name|r
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_g
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|foreground
operator|.
name|g
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_b
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|foreground
operator|.
name|b
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_a
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|foreground
operator|.
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"Background: %s %s %s %s\n"
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_r
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|background
operator|.
name|r
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_g
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|background
operator|.
name|g
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_b
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|background
operator|.
name|b
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_a
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|background
operator|.
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"</Style>\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gfig_style_save_as_attributes (Style * style,GString * string)
name|gfig_style_save_as_attributes
parameter_list|(
name|Style
modifier|*
name|style
parameter_list|,
name|GString
modifier|*
name|string
parameter_list|)
block|{
name|gchar
name|buffer
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|buffer_r
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|buffer_g
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|buffer_b
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gchar
name|buffer_a
index|[
name|G_ASCII_DTOSTR_BUF_SIZE
index|]
decl_stmt|;
name|gint
name|blen
init|=
name|G_ASCII_DTOSTR_BUF_SIZE
decl_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Saving style %s as attributes\n"
argument_list|,
name|style
operator|->
name|name
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"BrushName=\"%s\" "
argument_list|,
name|style
operator|->
name|brush_name
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"Foreground=\"%s %s %s %s\" "
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_r
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|foreground
operator|.
name|r
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_g
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|foreground
operator|.
name|g
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_b
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|foreground
operator|.
name|b
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_a
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|foreground
operator|.
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"Background=\"%s %s %s %s\" "
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_r
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|background
operator|.
name|r
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_g
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|background
operator|.
name|g
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_b
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|background
operator|.
name|b
argument_list|)
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer_a
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|background
operator|.
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"FillType=%d "
argument_list|,
name|style
operator|->
name|fill_type
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"PaintType=%d "
argument_list|,
name|style
operator|->
name|paint_type
argument_list|)
expr_stmt|;
name|g_string_append_printf
argument_list|(
name|string
argument_list|,
literal|"FillOpacity=%s "
argument_list|,
name|g_ascii_dtostr
argument_list|(
name|buffer
argument_list|,
name|blen
argument_list|,
name|style
operator|->
name|fill_opacity
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gfig_save_styles (GString * string)
name|gfig_save_styles
parameter_list|(
name|GString
modifier|*
name|string
parameter_list|)
block|{
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Saving global styles.\n"
argument_list|)
expr_stmt|;
name|gfig_save_style
argument_list|(
operator|&
name|gfig_context
operator|->
name|default_style
argument_list|,
name|string
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * set_foreground_callback() is the callback for the Foreground color select  * widget.  It reads the color from the widget, and applies this color to the  * current style.  It then produces a repaint (which will be suppressed if  * gfig_context->enable_repaint is FALSE).  */
end_comment

begin_function
name|void
DECL|function|set_foreground_callback (GimpColorButton * button,gpointer data)
name|set_foreground_callback
parameter_list|(
name|GimpColorButton
modifier|*
name|button
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpRGB
name|color2
decl_stmt|;
name|Style
modifier|*
name|current_style
decl_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Setting foreground color from color selector\n"
argument_list|)
expr_stmt|;
name|current_style
operator|=
name|gfig_context_get_current_style
argument_list|()
expr_stmt|;
name|gimp_color_button_get_color
argument_list|(
name|button
argument_list|,
operator|&
name|color2
argument_list|)
expr_stmt|;
name|gimp_rgba_set
argument_list|(
operator|&
name|current_style
operator|->
name|foreground
argument_list|,
name|color2
operator|.
name|r
argument_list|,
name|color2
operator|.
name|g
argument_list|,
name|color2
operator|.
name|b
argument_list|,
name|color2
operator|.
name|a
argument_list|)
expr_stmt|;
name|gfig_paint_callback
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|set_background_callback (GimpColorButton * button,gpointer data)
name|set_background_callback
parameter_list|(
name|GimpColorButton
modifier|*
name|button
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|GimpRGB
name|color2
decl_stmt|;
name|Style
modifier|*
name|current_style
decl_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Setting background color from color selector\n"
argument_list|)
expr_stmt|;
name|current_style
operator|=
name|gfig_context_get_current_style
argument_list|()
expr_stmt|;
name|gimp_color_button_get_color
argument_list|(
name|button
argument_list|,
operator|&
name|color2
argument_list|)
expr_stmt|;
name|gimp_rgba_set
argument_list|(
operator|&
name|current_style
operator|->
name|background
argument_list|,
name|color2
operator|.
name|r
argument_list|,
name|color2
operator|.
name|g
argument_list|,
name|color2
operator|.
name|b
argument_list|,
name|color2
operator|.
name|a
argument_list|)
expr_stmt|;
name|gfig_paint_callback
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|set_paint_type_callback (GtkToggleButton * toggle,gpointer data)
name|set_paint_type_callback
parameter_list|(
name|GtkToggleButton
modifier|*
name|toggle
parameter_list|,
name|gpointer
name|data
parameter_list|)
block|{
name|gboolean
name|paint_type
decl_stmt|;
name|Style
modifier|*
name|current_style
decl_stmt|;
name|current_style
operator|=
name|gfig_context_get_current_style
argument_list|()
expr_stmt|;
name|paint_type
operator|=
name|gtk_toggle_button_get_active
argument_list|(
name|toggle
argument_list|)
expr_stmt|;
name|current_style
operator|->
name|paint_type
operator|=
name|paint_type
expr_stmt|;
name|gfig_paint_callback
argument_list|()
expr_stmt|;
name|gtk_widget_set_sensitive
argument_list|(
name|GTK_WIDGET
argument_list|(
name|data
argument_list|)
argument_list|,
name|paint_type
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * gfig_brush_changed_callback() is the callback for the brush  * selector widget.  It reads the brush name from the widget, and  * applies this to the current style, as well as the gfig_context->bdesc  * values.  It then produces a repaint (which will be suppressed if  * gfig_context->enable_repaint is FALSE).  */
end_comment

begin_function
name|void
DECL|function|gfig_brush_changed_callback (GimpBrushSelectButton * button,const gchar * brush_name,gdouble opacity,gint spacing,GimpLayerModeEffects paint_mode,gint width,gint height,const guchar * mask_data,gboolean dialog_closing,gpointer user_data)
name|gfig_brush_changed_callback
parameter_list|(
name|GimpBrushSelectButton
modifier|*
name|button
parameter_list|,
specifier|const
name|gchar
modifier|*
name|brush_name
parameter_list|,
name|gdouble
name|opacity
parameter_list|,
name|gint
name|spacing
parameter_list|,
name|GimpLayerModeEffects
name|paint_mode
parameter_list|,
name|gint
name|width
parameter_list|,
name|gint
name|height
parameter_list|,
specifier|const
name|guchar
modifier|*
name|mask_data
parameter_list|,
name|gboolean
name|dialog_closing
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|Style
modifier|*
name|current_style
decl_stmt|;
name|current_style
operator|=
name|gfig_context_get_current_style
argument_list|()
expr_stmt|;
name|current_style
operator|->
name|brush_name
operator|=
name|g_strdup
argument_list|(
name|brush_name
argument_list|)
expr_stmt|;
comment|/* this will soon be unneeded. How soon? */
name|gfig_context
operator|->
name|bdesc
operator|.
name|name
operator|=
name|g_strdup
argument_list|(
name|brush_name
argument_list|)
expr_stmt|;
name|gfig_context
operator|->
name|bdesc
operator|.
name|width
operator|=
name|width
expr_stmt|;
name|gfig_context
operator|->
name|bdesc
operator|.
name|height
operator|=
name|height
expr_stmt|;
name|gimp_context_set_brush
argument_list|(
name|brush_name
argument_list|)
expr_stmt|;
name|gfig_paint_callback
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gfig_pattern_changed_callback (GimpPatternSelectButton * button,const gchar * pattern_name,gint width,gint height,gint bpp,const guchar * mask_data,gboolean dialog_closing,gpointer user_data)
name|gfig_pattern_changed_callback
parameter_list|(
name|GimpPatternSelectButton
modifier|*
name|button
parameter_list|,
specifier|const
name|gchar
modifier|*
name|pattern_name
parameter_list|,
name|gint
name|width
parameter_list|,
name|gint
name|height
parameter_list|,
name|gint
name|bpp
parameter_list|,
specifier|const
name|guchar
modifier|*
name|mask_data
parameter_list|,
name|gboolean
name|dialog_closing
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|Style
modifier|*
name|current_style
decl_stmt|;
name|current_style
operator|=
name|gfig_context_get_current_style
argument_list|()
expr_stmt|;
name|current_style
operator|->
name|pattern
operator|=
name|g_strdup
argument_list|(
name|pattern_name
argument_list|)
expr_stmt|;
name|gfig_paint_callback
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gfig_gradient_changed_callback (GimpGradientSelectButton * button,const gchar * gradient_name,gint width,const gdouble * grad_data,gboolean dialog_closing,gpointer user_data)
name|gfig_gradient_changed_callback
parameter_list|(
name|GimpGradientSelectButton
modifier|*
name|button
parameter_list|,
specifier|const
name|gchar
modifier|*
name|gradient_name
parameter_list|,
name|gint
name|width
parameter_list|,
specifier|const
name|gdouble
modifier|*
name|grad_data
parameter_list|,
name|gboolean
name|dialog_closing
parameter_list|,
name|gpointer
name|user_data
parameter_list|)
block|{
name|Style
modifier|*
name|current_style
decl_stmt|;
name|current_style
operator|=
name|gfig_context_get_current_style
argument_list|()
expr_stmt|;
name|current_style
operator|->
name|gradient
operator|=
name|g_strdup
argument_list|(
name|gradient_name
argument_list|)
expr_stmt|;
name|gfig_paint_callback
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gfig_rgba_copy (GimpRGB * color1,GimpRGB * color2)
name|gfig_rgba_copy
parameter_list|(
name|GimpRGB
modifier|*
name|color1
parameter_list|,
name|GimpRGB
modifier|*
name|color2
parameter_list|)
block|{
name|color1
operator|->
name|r
operator|=
name|color2
operator|->
name|r
expr_stmt|;
name|color1
operator|->
name|g
operator|=
name|color2
operator|->
name|g
expr_stmt|;
name|color1
operator|->
name|b
operator|=
name|color2
operator|->
name|b
expr_stmt|;
name|color1
operator|->
name|a
operator|=
name|color2
operator|->
name|a
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|gfig_style_copy (Style * style1,Style * style0,const gchar * name)
name|gfig_style_copy
parameter_list|(
name|Style
modifier|*
name|style1
parameter_list|,
name|Style
modifier|*
name|style0
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|name
condition|)
name|style1
operator|->
name|name
operator|=
name|g_strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
else|else
name|g_message
argument_list|(
literal|"Eror: name is NULL in gfig_style_copy."
argument_list|)
expr_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Copying style %s as style %s\n"
argument_list|,
name|style0
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|gfig_rgba_copy
argument_list|(
operator|&
name|style1
operator|->
name|foreground
argument_list|,
operator|&
name|style0
operator|->
name|foreground
argument_list|)
expr_stmt|;
name|gfig_rgba_copy
argument_list|(
operator|&
name|style1
operator|->
name|background
argument_list|,
operator|&
name|style0
operator|->
name|background
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|style0
operator|->
name|brush_name
condition|)
name|g_message
argument_list|(
literal|"Error copying style %s: brush name is NULL."
argument_list|,
name|style0
operator|->
name|name
argument_list|)
expr_stmt|;
name|style1
operator|->
name|brush_name
operator|=
name|g_strdup
argument_list|(
name|style0
operator|->
name|brush_name
argument_list|)
expr_stmt|;
name|style1
operator|->
name|gradient
operator|=
name|g_strdup
argument_list|(
name|style0
operator|->
name|gradient
argument_list|)
expr_stmt|;
name|style1
operator|->
name|pattern
operator|=
name|g_strdup
argument_list|(
name|style0
operator|->
name|pattern
argument_list|)
expr_stmt|;
name|style1
operator|->
name|fill_type
operator|=
name|style0
operator|->
name|fill_type
expr_stmt|;
name|style1
operator|->
name|fill_opacity
operator|=
name|style0
operator|->
name|fill_opacity
expr_stmt|;
name|style1
operator|->
name|paint_type
operator|=
name|style0
operator|->
name|paint_type
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * gfig_style_apply() applies the settings from the specified style to  * the GIMP core.  It does not change any widgets, and does not cause  * a repaint.  */
end_comment

begin_function
name|void
DECL|function|gfig_style_apply (Style * style)
name|gfig_style_apply
parameter_list|(
name|Style
modifier|*
name|style
parameter_list|)
block|{
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Applying style '%s' -- "
argument_list|,
name|style
operator|->
name|name
argument_list|)
expr_stmt|;
name|gimp_context_set_foreground
argument_list|(
operator|&
name|style
operator|->
name|foreground
argument_list|)
expr_stmt|;
name|gimp_context_set_background
argument_list|(
operator|&
name|style
operator|->
name|background
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gimp_context_set_brush
argument_list|(
name|style
operator|->
name|brush_name
argument_list|)
condition|)
name|g_message
argument_list|(
literal|"Style apply: Failed to set brush to '%s' in style '%s'"
argument_list|,
name|style
operator|->
name|brush_name
argument_list|,
name|style
operator|->
name|name
argument_list|)
expr_stmt|;
name|gimp_context_set_pattern
argument_list|(
name|style
operator|->
name|pattern
argument_list|)
expr_stmt|;
name|gimp_context_set_gradient
argument_list|(
name|style
operator|->
name|gradient
argument_list|)
expr_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"done.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * gfig_read_gimp_style() reads the style settings from the Gimp core,  * and applies them to the specified style, giving that style the  * specified name.  This is mainly useful as a way of initializing  * a style.  The function does not cause a repaint.  */
end_comment

begin_function
name|void
DECL|function|gfig_read_gimp_style (Style * style,const gchar * name)
name|gfig_read_gimp_style
parameter_list|(
name|Style
modifier|*
name|style
parameter_list|,
specifier|const
name|gchar
modifier|*
name|name
parameter_list|)
block|{
name|gint
name|dummy
decl_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
name|g_message
argument_list|(
literal|"Error: name is NULL in gfig_read_gimp_style."
argument_list|)
expr_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Reading Gimp settings as style %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|style
operator|->
name|name
operator|=
name|g_strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|gimp_context_get_foreground
argument_list|(
operator|&
name|style
operator|->
name|foreground
argument_list|)
expr_stmt|;
name|gimp_context_get_background
argument_list|(
operator|&
name|style
operator|->
name|background
argument_list|)
expr_stmt|;
name|style
operator|->
name|brush_name
operator|=
name|gimp_context_get_brush
argument_list|()
expr_stmt|;
name|gimp_brush_get_info
argument_list|(
name|style
operator|->
name|brush_name
argument_list|,
operator|&
name|style
operator|->
name|brush_width
argument_list|,
operator|&
name|style
operator|->
name|brush_height
argument_list|,
operator|&
name|dummy
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|gimp_brush_get_spacing
argument_list|(
name|style
operator|->
name|brush_name
argument_list|,
operator|&
name|style
operator|->
name|brush_spacing
argument_list|)
expr_stmt|;
name|style
operator|->
name|gradient
operator|=
name|gimp_context_get_gradient
argument_list|()
expr_stmt|;
name|style
operator|->
name|pattern
operator|=
name|gimp_context_get_pattern
argument_list|()
expr_stmt|;
name|style
operator|->
name|fill_opacity
operator|=
literal|100.
expr_stmt|;
name|gfig_context
operator|->
name|bdesc
operator|.
name|name
operator|=
name|style
operator|->
name|brush_name
expr_stmt|;
name|gfig_context
operator|->
name|bdesc
operator|.
name|width
operator|=
name|style
operator|->
name|brush_width
expr_stmt|;
name|gfig_context
operator|->
name|bdesc
operator|.
name|height
operator|=
name|style
operator|->
name|brush_height
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * gfig_style_set_content_from_style() sets all of the style control widgets  * to values from the specified style.  This in turn sets the Gimp core's  * values to the same things.  Repainting is suppressed while this happens,  * so calling this function will not produce a repaint.  *  */
end_comment

begin_function
name|void
DECL|function|gfig_style_set_context_from_style (Style * style)
name|gfig_style_set_context_from_style
parameter_list|(
name|Style
modifier|*
name|style
parameter_list|)
block|{
name|gboolean
name|enable_repaint
decl_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Setting context from style '%s' -- "
argument_list|,
name|style
operator|->
name|name
argument_list|)
expr_stmt|;
name|enable_repaint
operator|=
name|gfig_context
operator|->
name|enable_repaint
expr_stmt|;
name|gfig_context
operator|->
name|enable_repaint
operator|=
name|FALSE
expr_stmt|;
name|gimp_color_button_set_color
argument_list|(
name|GIMP_COLOR_BUTTON
argument_list|(
name|gfig_context
operator|->
name|fg_color_button
argument_list|)
argument_list|,
operator|&
name|style
operator|->
name|foreground
argument_list|)
expr_stmt|;
name|gimp_color_button_set_color
argument_list|(
name|GIMP_COLOR_BUTTON
argument_list|(
name|gfig_context
operator|->
name|bg_color_button
argument_list|)
argument_list|,
operator|&
name|style
operator|->
name|background
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gimp_context_set_brush
argument_list|(
name|style
operator|->
name|brush_name
argument_list|)
condition|)
name|g_message
argument_list|(
literal|"Style from context: Failed to set brush to '%s'"
argument_list|,
name|style
operator|->
name|brush_name
argument_list|)
expr_stmt|;
name|gimp_brush_select_button_set_brush
argument_list|(
name|GIMP_BRUSH_SELECT_BUTTON
argument_list|(
name|gfig_context
operator|->
name|brush_select
argument_list|)
argument_list|,
name|style
operator|->
name|brush_name
argument_list|,
operator|-
literal|1.0
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* FIXME */
name|gimp_pattern_select_button_set_pattern
argument_list|(
name|GIMP_PATTERN_SELECT_BUTTON
argument_list|(
name|gfig_context
operator|->
name|pattern_select
argument_list|)
argument_list|,
name|style
operator|->
name|pattern
argument_list|)
expr_stmt|;
name|gimp_gradient_select_button_set_gradient
argument_list|(
name|GIMP_GRADIENT_SELECT_BUTTON
argument_list|(
name|gfig_context
operator|->
name|gradient_select
argument_list|)
argument_list|,
name|style
operator|->
name|gradient
argument_list|)
expr_stmt|;
name|gfig_context
operator|->
name|bdesc
operator|.
name|name
operator|=
name|style
operator|->
name|brush_name
expr_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"done.\n"
argument_list|)
expr_stmt|;
name|gimp_int_combo_box_set_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|gfig_context
operator|->
name|fillstyle_combo
argument_list|)
argument_list|,
operator|(
name|gint
operator|)
name|style
operator|->
name|fill_type
argument_list|)
expr_stmt|;
name|gtk_toggle_button_set_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|gfig_context
operator|->
name|paint_type_toggle
argument_list|)
argument_list|,
name|style
operator|->
name|paint_type
argument_list|)
expr_stmt|;
name|gfig_context
operator|->
name|enable_repaint
operator|=
name|enable_repaint
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * gfig_style_set_style_from_context() sets the values in the specified  * style to those that appear in the style control widgets f  */
end_comment

begin_function
name|void
DECL|function|gfig_style_set_style_from_context (Style * style)
name|gfig_style_set_style_from_context
parameter_list|(
name|Style
modifier|*
name|style
parameter_list|)
block|{
name|Style
modifier|*
name|current_style
decl_stmt|;
name|GimpRGB
name|color
decl_stmt|;
name|gint
name|value
decl_stmt|;
name|style
operator|->
name|name
operator|=
literal|"object"
expr_stmt|;
name|current_style
operator|=
name|gfig_context_get_current_style
argument_list|()
expr_stmt|;
name|gimp_color_button_get_color
argument_list|(
name|GIMP_COLOR_BUTTON
argument_list|(
name|gfig_context
operator|->
name|fg_color_button
argument_list|)
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
if|if
condition|(
name|gfig_context
operator|->
name|debug_styles
condition|)
name|g_printerr
argument_list|(
literal|"Setting foreground color to %lg %lg %lg\n"
argument_list|,
name|color
operator|.
name|r
argument_list|,
name|color
operator|.
name|g
argument_list|,
name|color
operator|.
name|b
argument_list|)
expr_stmt|;
name|gfig_rgba_copy
argument_list|(
operator|&
name|style
operator|->
name|foreground
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|gimp_color_button_get_color
argument_list|(
name|GIMP_COLOR_BUTTON
argument_list|(
name|gfig_context
operator|->
name|bg_color_button
argument_list|)
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|gfig_rgba_copy
argument_list|(
operator|&
name|style
operator|->
name|background
argument_list|,
operator|&
name|color
argument_list|)
expr_stmt|;
name|style
operator|->
name|brush_name
operator|=
name|current_style
operator|->
name|brush_name
expr_stmt|;
if|if
condition|(
operator|!
name|style
operator|->
name|pattern
operator|||
name|strcmp
argument_list|(
name|style
operator|->
name|pattern
argument_list|,
name|current_style
operator|->
name|pattern
argument_list|)
condition|)
block|{
name|style
operator|->
name|pattern
operator|=
name|g_strdup
argument_list|(
name|current_style
operator|->
name|pattern
argument_list|)
expr_stmt|;
comment|/* why strduping? */
block|}
name|style
operator|->
name|gradient
operator|=
name|current_style
operator|->
name|gradient
expr_stmt|;
if|if
condition|(
name|gimp_int_combo_box_get_active
argument_list|(
name|GIMP_INT_COMBO_BOX
argument_list|(
name|gfig_context
operator|->
name|fillstyle_combo
argument_list|)
argument_list|,
operator|&
name|value
argument_list|)
condition|)
name|style
operator|->
name|fill_type
operator|=
name|value
expr_stmt|;
comment|/* FIXME when there is an opacity control widget to read */
name|style
operator|->
name|fill_opacity
operator|=
literal|100.
expr_stmt|;
name|style
operator|->
name|paint_type
operator|=
name|gtk_toggle_button_get_active
argument_list|(
name|GTK_TOGGLE_BUTTON
argument_list|(
name|gfig_context
operator|->
name|paint_type_toggle
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|mygimp_brush_info (gint * width,gint * height)
name|mygimp_brush_info
parameter_list|(
name|gint
modifier|*
name|width
parameter_list|,
name|gint
modifier|*
name|height
parameter_list|)
block|{
name|gchar
modifier|*
name|name
init|=
name|gimp_context_get_brush
argument_list|()
decl_stmt|;
name|gint
name|dummy
decl_stmt|;
if|if
condition|(
name|name
operator|&&
name|gimp_brush_get_info
argument_list|(
name|name
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
operator|&
name|dummy
argument_list|,
operator|&
name|dummy
argument_list|)
condition|)
block|{
operator|*
name|width
operator|=
name|MAX
argument_list|(
operator|*
name|width
argument_list|,
literal|32
argument_list|)
expr_stmt|;
operator|*
name|height
operator|=
name|MAX
argument_list|(
operator|*
name|height
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|g_message
argument_list|(
literal|"Failed to get brush info"
argument_list|)
expr_stmt|;
operator|*
name|width
operator|=
operator|*
name|height
operator|=
literal|48
expr_stmt|;
block|}
name|g_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Style
modifier|*
DECL|function|gfig_context_get_current_style (void)
name|gfig_context_get_current_style
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|gfig_context
operator|->
name|selected_obj
condition|)
return|return
operator|&
name|gfig_context
operator|->
name|selected_obj
operator|->
name|style
return|;
else|else
return|return
operator|&
name|gfig_context
operator|->
name|default_style
return|;
block|}
end_function

end_unit

